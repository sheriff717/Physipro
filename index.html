<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhysiPro Moulage v9.0</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <style>
/* =====================================================
   PHYSIPRO MOULAGE v13.3 - CODE PROPRE
   ===================================================== */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  overflow: hidden;
  font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  background: #0f172a;
  color: #fff;
}

.app-root {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100%;
  overflow: hidden;
}

.hidden { display: none !important; }

/* ===== TOP BAR ===== */
.topbar {
  flex: 0 0 auto;
  width: 100%;
  padding: 4px 20px 6px 20px;
  min-height: 75px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.45);
  position: relative;
}

.tb-left { display: flex; align-items: center; gap: 10px; }

.logo-flip-container {
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  position: relative; z-index: 100;
}

.logo-main {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.logo-top-fixed img {
  height: 40px;
  width: auto;
  object-fit: contain;
  filter: brightness(1.1) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.logo-bottom-text {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 15px;
  font-weight: 600;
  color: #fff;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
  margin-top: -4px;
  text-align: center;
  letter-spacing: 0.3px;
}

/* Menu à droite du logo */
.logo-menu {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.logo-flip-container:hover .logo-menu {
  opacity: 1;
  pointer-events: auto;
}

.logo-menu-item {
  font-family: 'Segoe UI', sans-serif;
  font-size: 11px;
  font-weight: 600;
  color: #fff;
  padding: 3px 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  border-radius: 5px;
  background: rgba(255,255,255,0.15);
}

.logo-menu-item:hover {
  background: rgba(74, 142, 245, 0.6);
  transform: translateX(3px);
}

.tb-center {
  position: absolute; left: 50%; top: 35%;
  transform: translate(-50%, -50%);
  display: flex; align-items: center; justify-content: center; gap: 5px;
}

.top-title {
  font-size: 22px; white-space: nowrap; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: #fdfdfd; text-shadow: 0 2px 3px rgba(0,0,0,0.85);
}

.settings-btn {
  font-size: 22px; background: none; border: none;
  cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.2s;
}

.settings-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(45deg); }

.tb-right { 
  position: relative;
  display: flex; 
  flex-direction: column; 
  align-items: flex-end; 
  justify-content: center;
  height: 100%;
}

.user-status {
  position: absolute;
  bottom: -8px;
  right: 0;
  display: flex; align-items: center; gap: 4px;
  padding: 1px 6px; background: rgba(255,255,255,0.1);
  border-radius: 8px; font-size: 8px;
}

.status-dot { width: 6px; height: 6px; border-radius: 50%; background: #6b7280; }
.status-dot.online { background: #22c55e; }
.user-name { 
  color: #fff; 
  font-weight: 500; 
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
  line-height: 1.1;
}

.user-role-badge {
  display: inline-block; 
  padding: 1px 5px;
  border-radius: 6px; 
  font-size: 7px; 
  font-weight: 600;
}
.user-role-badge.admin { background: #dc2626; color: #fff; }
.user-role-badge.editor { background: #2563eb; color: #fff; }
.user-role-badge.viewer { background: #6b7280; color: #fff; }

.header-btn {
  padding: 4px 12px;
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  color: #fff; border: 1px solid #000; border-radius: 6px;
  font-size: 11px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 3px rgba(0,0,0,0.3);
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.header-btn:hover { transform: translateY(-1px); box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 3px 8px rgba(0,0,0,0.4); }

.search-row {
  position: absolute; bottom: 8px; left: 50%;
  transform: translateX(-50%);
  display: flex; align-items: center; gap: 10px;
}

.search-box {
  display: flex; align-items: center;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 20px; padding: 4px 12px; min-width: 480px;
}

.search-box:focus-within { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.4); }
.search-icon { font-size: 14px; margin-right: 8px; opacity: 0.7; }

.search-input {
  background: transparent; border: none; color: #fff;
  font-size: 13px; width: 100%; outline: none;
}

.search-input::placeholder { color: rgba(255,255,255,0.5); }

.search-clear {
  background: none; border: none; color: rgba(255,255,255,0.6);
  cursor: pointer; font-size: 14px; padding: 2px 6px;
}

.search-clear:hover { color: #fff; }

/* ===== SETTINGS MENU ===== */
.settings-overlay {
  position: fixed; 
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); 
  z-index: 10000;
  display: flex; 
  align-items: flex-start; 
  justify-content: flex-end; 
  padding-top: 100px;
  padding-right: 20px;
}
.settings-overlay.hidden { display: none !important; }

.settings-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  min-width: 220px; overflow: hidden;
}

.settings-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
  color: #fff; font-weight: 600; font-size: 14px;
}

.settings-close-btn {
  background: rgba(255,255,255,0.1); border: none; color: #fff;
  width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px;
}

.settings-close-btn:hover { background: #ef4444; }

.settings-content { padding: 10px; display: flex; flex-direction: column; gap: 5px; }

.settings-item {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 15px; background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
  color: #fff; font-size: 13px; cursor: pointer; transition: all 0.2s;
}

.settings-item:hover { background: rgba(255,255,255,0.15); }
.settings-item.logout { border-color: rgba(239,68,68,0.3); }
.settings-item.logout:hover { background: rgba(239,68,68,0.2); }
.settings-icon { font-size: 18px; }

/* ===== IMPORT/EXPORT MENU ===== */
.import-export-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}
.import-export-overlay.hidden { display: none; }

.import-export-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0a1628);
  border: 2px solid #4a8ef5;
  border-radius: 12px;
  width: 500px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.import-export-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #04152c, #4a8ef5);
  border-bottom: 1px solid #4a8ef5;
  border-radius: 10px 10px 0 0;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
}

.import-export-close-btn {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.import-export-close-btn:hover { filter: brightness(1.2); }

.import-export-content { padding: 20px; }

.import-export-section { margin-bottom: 15px; }
.import-export-section h3 { margin: 0 0 10px 0; font-size: 15px; color: #4ade80; }
.import-export-section p { margin: 0 0 15px 0; font-size: 12px; color: #94a3b8; line-height: 1.4; }

.import-export-btn {
  width: 100%;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: filter 0.2s;
}
.import-export-btn:hover { filter: brightness(1.1); }

.export-btn { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; }
.import-btn { background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; }

.export-options { display: flex; gap: 10px; margin-top: 10px; }

.import-export-btn-small {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #4a8ef5;
  background: rgba(74, 142, 245, 0.2);
  color: #fff;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}
.import-export-btn-small:hover { background: rgba(74, 142, 245, 0.4); }

.import-export-divider {
  height: 1px;
  background: linear-gradient(to right, transparent, #4a8ef5, transparent);
  margin: 20px 0;
}

.import-warning {
  background: rgba(239, 68, 68, 0.2);
  border: 1px solid rgba(239, 68, 68, 0.4);
  border-radius: 8px;
  padding: 10px;
  margin-top: 10px;
  font-size: 11px;
  color: #fca5a5;
}

/* ===== LOG MODAL ===== */
.log-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}
.log-overlay.hidden { display: none; }

.log-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0a1628);
  border: 2px solid #4a8ef5;
  border-radius: 12px;
  width: 600px;
  max-width: 95vw;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #04152c, #4a8ef5);
  border-bottom: 1px solid #4a8ef5;
  border-radius: 10px 10px 0 0;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
}

.log-close-btn {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
}
.log-close-btn:hover { filter: brightness(1.2); }

.log-content {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.log-entry {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 10px 15px;
  margin-bottom: 8px;
  font-size: 12px;
}

.log-time {
  color: #94a3b8;
  font-size: 11px;
  margin-bottom: 4px;
}

.log-action {
  color: #4ade80;
  font-weight: 600;
}

.log-empty {
  text-align: center;
  color: #64748b;
  padding: 40px;
  font-style: italic;
}

/* ===== BOARD ===== */
.board-wrapper { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

.board {
  flex: 1; display: grid; grid-template-columns: repeat(8, minmax(0, 1fr));
  gap: 4px; padding: 4px; overflow-x: hidden; overflow-y: hidden; min-height: 0;
}

.col {
  background: linear-gradient(180deg, rgba(30,58,95,0.95) 0%, rgba(15,23,42,0.98) 100%);
  border-radius: 12px; display: flex; flex-direction: column;
  min-width: 0; max-height: 100%; overflow: hidden;
  border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.col-header {
  padding: 8px 10px;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  flex-shrink: 0; cursor: default;
  position: relative;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 4px rgba(0,0,0,0.3);
}

.col-header.clickable { cursor: pointer; }
.col-header.clickable:hover { background: linear-gradient(to bottom, #0a2540 0%, #5a9ef5 100%); }
.col-header.en-attente { background: linear-gradient(to bottom, #4a1010 0%, #dc2626 100%); }

.col-icon { position: absolute; left: 8px; font-size: 12px; }
.col-title { text-align: center; }

.col-count {
  position: absolute;
  right: 8px;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  padding: 2px 6px;
  border-radius: 10px; font-size: 10px; font-weight: 600;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  border: 1px solid rgba(0,0,0,0.5);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.2);
}

.col-content {
  flex: 1; overflow-y: auto; padding: 1px;
  display: flex; flex-direction: column; gap: 2px;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.col-content::-webkit-scrollbar { display: none; } /* Chrome/Safari/Opera */

/* ===== CARTES COMPACTES ===== */
.mcard {
  position: relative;
  margin: 1px 0;
  padding: 0px 6px 2px 6px;
  border-radius: 8px;
  background: linear-gradient(to bottom, #1a3a5a 0%, #3a6a9a 35%, #5a9acf 100%);
  border: 2px solid #000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  color: #fff;
  font-size: 8px;
  overflow: visible;
}

/* Couleurs par region - dégradé métallique lumineux */
.mcard.region-qc {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 2px 6px rgba(0,0,0,0.35);
}
.mcard.region-on {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
  box-shadow: inset 0 2px 3px rgba(255,255,255,0.4), 0 2px 6px rgba(0,0,0,0.35);
}
.mcard.region-ma {
  background: linear-gradient(to bottom, #451238 0%, #8D2E6A 40%, #C7458C 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.2), 0 2px 6px rgba(0,0,0,0.35);
}

/* Texte blanc avec bordure noire */
.mcard .mcard-title,
.mcard .mcard-order,
.mcard .mcard-region-pill,
.mcard .mcard-delay-pill,
.mcard .mcard-btn-move,
.mcard .mcard-btn-delete,
.mcard .mcard-fiche-btn {
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Header carte - compact */
.mcard-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 0;
  padding: 0;
}

.mcard-info { width: 100%; text-align: center; }

.mcard-title-line {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0px;
}

.mcard-title {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  margin-top: 3px;
  margin-bottom: 3px;
  padding-top: 0px;
  cursor: text;
  border: none;
  background: transparent;
  padding-left: 0;
  padding-right: 0;
  width: 100%;
  outline: none;
  font-family: inherit;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

.mcard-title:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

.mcard-order-line {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #fff;
  position: relative;
  width: 100%;
  height: 12px;
  padding: 0 35px;
  box-sizing: border-box;
  margin-top: 0px;
}

/* Pastille region (Quebec, Ontario, Maritime) - même style que bouton Fiche */
.mcard-region-pill {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  color: #fff;
  font-size: 7px;
  font-weight: 700;
  padding: 2px 4px;
  border-radius: 6px;
  border: 1px solid #000;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  text-align: center;
  line-height: 1;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 10;
  white-space: nowrap;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.4);
}

.mcard-region-pill:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.1);
}

/* Pastille région par couleur de carte */
.mcard.region-qc .mcard-region-pill {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
}
.mcard.region-on .mcard-region-pill {
  background: linear-gradient(to bottom, #E8B97A, #704414);
}
.mcard.region-ma .mcard-region-pill {
  background: linear-gradient(to bottom, #C7458C, #451238);
}

/* Bouton Fiche a droite */
.mcard-fiche-btn {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to bottom, #6b7fa8, #4a5a7a);
  border: 1px solid rgba(0,0,0,0.5);
  border-radius: 6px;
  padding: 2px 4px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
  text-align: center;
  z-index: 10;
  pointer-events: auto;
  color: #fff;
  text-shadow: 1px 1px 0 #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

.mcard-fiche-btn:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.2);
}

/* Bouton Fiche par region - même couleur que la carte */
.mcard.region-qc .mcard-fiche-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  border: 1px solid #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-fiche-btn {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  border: 1px solid #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-fiche-btn {
  background: linear-gradient(to bottom, #C7458C, #451238);
  border: 1px solid #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-order {
  cursor: text;
  border: none;
  background: transparent;
  color: #fff;
  font-size: 12px;
  font-family: inherit;
  font-weight: 600;
  padding: 0;
  width: 60px;
  outline: none;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  text-align: center;
}

.mcard-order:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

.mcard-title.locked,
.mcard-order.locked {
  cursor: not-allowed;
  opacity: 0.9;
  font-weight: 700;
}

/* Separateur */
.mcard-separator {
  height: 1px;
  background: rgba(255,255,255,0.25);
  margin: 0px -6px 0px -6px;
}

/* Pastille delai */
.mcard-delay-pill {
  width: 100%;
  padding: 1px 3px;
  font-size: 7px;
  font-weight: 700;
  border-radius: 999px;
  background: linear-gradient(to bottom, #4a6fa5, #2d4a6f);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #000;
  margin-top: 1px;
  margin-bottom: 1px;
  box-sizing: border-box;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  cursor: pointer;
}

/* Pastille delai par region - même couleur que la carte */
.mcard.region-qc .mcard-delay-pill {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-delay-pill {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.5);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-delay-pill {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.25);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Couleurs delai - PLUS DE VERT, seulement jaune et rouge */
.mcard-delay-pill.delai-vert { } /* Pas de style spécial, garde la couleur de la carte */
.mcard-delay-pill.delai-jaune { background: linear-gradient(to bottom, #f59e0b, #d97706) !important; color: #000 !important; text-shadow: none !important; }
.mcard-delay-pill.delai-rouge { background: linear-gradient(to bottom, #ef4444, #b91c1c) !important; }
.mcard-delay-pill.delai-retard {
  background: linear-gradient(to bottom, #ef4444, #b91c1c) !important;
  animation: pulse-retard-delai 0.8s infinite !important;
}

@keyframes pulse-retard-delai {
  0%, 100% { background: linear-gradient(to bottom, #dc2626, #7f1d1d); box-shadow: 0 0 4px #dc2626; }
  50% { background: linear-gradient(to bottom, #ef4444, #dc2626); box-shadow: 0 0 8px #ef4444; }
}

/* Colonne En attente */
.mcard.in-attente-column .mcard-delay-pill {
  background: linear-gradient(to bottom, #dc2626, #b91c1c);
}

.mcard.in-attente-column .mcard-delay-pill.attente-active {
  animation: blinkRed 0.8s infinite;
}

@keyframes blinkRed {
  0%, 49% { background: #dc2626; box-shadow: none; }
  50%, 100% { background: #ff0000; box-shadow: 0 0 4px #ff0000, 0 0 8px #ff0000; }
}

/* Expédié - même couleur que la carte */
.mcard .mcard-delay-pill.expedie { cursor: default !important; animation: none !important; }
.mcard.region-qc .mcard-delay-pill.expedie { background: linear-gradient(to bottom, #4a8ef5, #04152c) !important; }
.mcard.region-on .mcard-delay-pill.expedie { background: linear-gradient(to bottom, #E8B97A, #704414) !important; }
.mcard.region-ma .mcard-delay-pill.expedie { background: linear-gradient(to bottom, #C7458C, #451238) !important; }

/* Boutons footer */
.mcard-footer-buttons {
  display: flex;
  gap: 2px;
  margin-top: 1px;
}

.mcard-btn {
  flex: 1;
  padding: 1px 3px;
  font-size: 7px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid #000;
  cursor: pointer;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
  line-height: 1;
  white-space: nowrap;
}

.mcard-btn:hover { filter: brightness(1.1); }

.mcard-btn-move {
  background: linear-gradient(to bottom, #1e3a5f, #0f2744);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Bouton deplacer par region - même couleur que la carte */
.mcard.region-qc .mcard-btn-move {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-btn-move {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.5), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-btn-move {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.25), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-btn-delete {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Badge priorite */
.priority-badge {
  position: absolute;
  top: -1px;
  left: -1px;
  width: 16px;
  height: 16px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border-radius: 6px 0 6px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  color: #fff;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.4);
  z-index: 10;
  border: none;
  pointer-events: none;
}

.priority-badge.hidden { display: none; }
.priority-badge.p1 { background: linear-gradient(to bottom, #ef4444, #dc2626); }
.priority-badge.p2 { background: linear-gradient(to bottom, #f97316, #ea580c); }
.priority-badge.p3 { background: linear-gradient(to bottom, #eab308, #ca8a04); }
.priority-badge.p4 { background: linear-gradient(to bottom, #22c55e, #16a34a); }
.priority-badge.p5 { background: linear-gradient(to bottom, #3b82f6, #2563eb); }

/* Menu priorite */
.priority-menu {
  position: absolute;
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  padding: 8px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 10000;
  min-width: 180px;
}

.priority-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 13px;
  color: #fff;
  transition: background 0.2s;
}

.priority-menu-item:hover { background: rgba(255,255,255,0.1); }

.priority-dot {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
}

.priority-dot.p1 { background: #ef4444; }
.priority-dot.p2 { background: #f97316; }
.priority-dot.p3 { background: #eab308; }
.priority-dot.p4 { background: #22c55e; }
.priority-dot.p5 { background: #3b82f6; }
.priority-dot.none { background: #6b7280; }

/* ===== FICHE MOULAGE EXPANDED ===== */
.card-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 999;
}
.card-overlay.active { display: block; }

.mcard.mcard-expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  width: 1050px;
  height: 90vh;
  max-height: 90vh;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  overflow: hidden;
  display: flex;
  text-shadow: none !important;
}

.mcard.mcard-expanded *,
.mcard.mcard-expanded input,
.mcard.mcard-expanded select,
.mcard.mcard-expanded label,
.mcard.mcard-expanded span,
.mcard.mcard-expanded div {
  text-shadow: none !important;
}

@media (max-width: 1100px) {
  .mcard.mcard-expanded {
    width: 95vw;
    flex-direction: column;
    max-height: 85vh;
    overflow-y: auto;
  }
  .mcard.mcard-expanded .mcard-fiche {
    width: 100% !important;
    border-right: none !important;
    border-bottom: 1px solid #e2e8f0;
  }
  .mcard.mcard-expanded .mcard-notes-page {
    width: 100% !important;
    min-height: 250px;
  }
}

.mcard.mcard-expanded .mcard-header,
.mcard.mcard-expanded .mcard-delay-pill,
.mcard.mcard-expanded .mcard-footer-buttons,
.mcard.mcard-expanded .mcard-separator {
  display: none !important;
}

/* Sidebar tracking */
.mcard-tracking-sidebar {
  display: none;
  width: 140px;
  flex-shrink: 0;
  background: #ffffff;
  border-right: 2px solid #e2e8f0;
  padding: 10px 8px;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-tracking-sidebar { display: flex; }

.tracking-sidebar-title {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
}

.tracking-pills-container {
  display: flex;
  flex-direction: column;
  gap: 3px;
  flex: 1;
  overflow: hidden;
}

.tracking-dept-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 8px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  flex: 1;
}

.tracking-dept-pill:hover { background: #eff6ff; border-color: #3b82f6; }
.tracking-dept-pill.active { background: linear-gradient(to right, #dbeafe, #eff6ff); border-color: #3b82f6; border-width: 2px; }
.tracking-dept-pill.completed { background: linear-gradient(to right, #dcfce7, #f0fdf4); border-color: #22c55e; }

.tracking-pill-icon { font-size: 14px; }
.tracking-pill-name { font-size: 10px; font-weight: 600; color: #374151; flex: 1; }
.tracking-pill-jours { font-size: 15px; font-weight: 800; color: #1e40af; min-width: 32px; text-align: center; }
.tracking-dept-pill.completed .tracking-pill-jours { color: #16a34a; }
.tracking-dept-pill.active .tracking-pill-jours { color: #2563eb; }

/* Contenu fiche - Page gauche */
.mcard-fiche {
  display: none;
  padding: 12px 14px;
  padding-bottom: 55px;
  width: 420px;
  flex-shrink: 0;
  border-right: 1px solid #e2e8f0;
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
  box-sizing: border-box;
}

.mcard.mcard-expanded .mcard-fiche { display: block; }

/* Page Notes - Page droite */
.mcard-notes-page {
  display: none;
  flex: 1;
  min-width: 450px;
  padding: 12px;
  background: #f8fafc;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-notes-page { display: flex; }

.notes-page-header {
  font-size: 14px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
  flex-shrink: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notes-header-left {
  display: flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
  color: #1e40af;
  line-height: 1;
}

.notes-header-left .camera-icon {
  font-size: 16px;
  line-height: 1;
}

.notes-header-center {
  flex: 1;
  text-align: center;
  font-size: 15px;
}

.notes-close-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notes-photos-row {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
  flex-shrink: 0;
}

.notes-photo-btn {
  flex: 1;
  padding: 4px 2px;
  font-size: 9px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.notes-photo-btn:hover { background: #f3f4f6; }
.notes-photo-btn.has-link { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; border-color: #15803d; }

.notes-page-textarea {
  flex: 1;
  width: 100%;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.4;
  background: white;
}

.notes-photos-links {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  margin-bottom: 8px;
}

.photo-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.photo-link-row label { font-size: 9px; font-weight: 600; color: #374151; width: 50px; }
.photo-link-row input { flex: 1; padding: 4px 6px; font-size: 9px; border: 1px solid #d1d5db; border-radius: 4px; }

.save-photos-btn {
  margin-top: 6px;
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}

/* Fiche header */
.fiche-header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 15px;
  margin-bottom: 6px;
  padding-bottom: 4px;
  border-bottom: 1px solid #e2e8f0;
}

.fiche-header .fiche-logo img { height: 35px; }
.fiche-header .fiche-title { text-align: center; flex: 1; }
.fiche-header .fiche-title h3 { margin: 0; font-size: 14px; font-weight: 700; color: #0f172a; }

.fiche-priority-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  color: #fff;
  font-size: 11px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.2s;
  border: none;
}

.fiche-priority-btn:hover { transform: scale(1.05); }
.fiche-priority-emoji { font-size: 12px; }

/* Fiche section et grilles */
.fiche-section { margin-bottom: 6px; }
.fiche-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.fiche-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

.fiche-field { display: flex; flex-direction: column; }

.fiche-label {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  min-height: 16px;
}

.fiche-input, .fiche-select {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  font-weight: 500;
  color: #1f2937;
  background: #fff;
  box-sizing: border-box;
  text-align: center;
}

.fiche-input:focus, .fiche-select:focus { outline: none; border-color: #3b82f6; }

.fiche-input.locked {
  background: #f1f5f9;
  color: #1e40af;
  font-weight: 600;
  cursor: not-allowed;
  border-color: #93c5fd;
}

.fiche-date-pill {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1f2937;
  font-weight: 500;
  cursor: pointer;
  box-sizing: border-box;
}

.fiche-date-pill:hover { background: #f9fafb; border-color: #9ca3af; }

/* Section En attente */
.fiche-attente-section {
  display: none;
  background: linear-gradient(to right, #fef2f2, #fee2e2);
  border: 1px solid #fca5a5;
  border-radius: 6px;
  padding: 8px;
  margin: 8px 0;
}

.fiche-attente-section.visible { display: block; }

.attente-badge-full {
  font-size: 11px;
  font-weight: 700;
  color: #dc2626;
  cursor: pointer;
  text-align: center;
}

.attente-days-full {
  font-size: 10px;
  color: #991b1b;
  text-align: center;
  margin-top: 4px;
}

/* Section Photos */
.fiche-photos-section {
  position: absolute;
  bottom: 8px;
  left: 10px;
  right: 10px;
}

.photos-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.photos-label {
  font-size: 14px;
  font-weight: 700;
  color: #1e40af;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.photos-label .camera-icon {
  font-size: 18px;
}

.photo-btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 700;
  background: #f3f4f6;
  border: 2px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
}

.photo-btn:hover { background: #e5e7eb; }
.photo-btn.has-link { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; border-color: #15803d; }
.photo-btn.has-link.blink-green-photo { animation: blinkGreen 1s infinite; }

@keyframes blinkGreen {
  0%, 100% { background: linear-gradient(to bottom, #22c55e, #16a34a); }
  50% { background: linear-gradient(to bottom, #4ade80, #22c55e); box-shadow: 0 0 8px #22c55e; }
}

/* Calendrier popup - GLOBAL (pas dans la carte) */
.global-calendar-popup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  padding: 15px;
  z-index: 999999;
  min-width: 280px;
}

.global-calendar-popup.active { display: block; }

.global-calendar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  z-index: 999998;
}

.global-calendar-overlay.active { display: block; }

.gcal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #3b82f6; }
.gcal-title { font-size: 12px; font-weight: 700; color: #1e3a5f; }
.gcal-close-x { background: none; border: none; font-size: 18px; color: #64748b; cursor: pointer; padding: 0 4px; line-height: 1; }
.gcal-close-x:hover { color: #ef4444; }
.gcal-nav { display: flex; align-items: center; gap: 10px; }
.gcal-nav-btn { width: 28px; height: 28px; border: none; background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; }
.gcal-nav-btn:hover { background: linear-gradient(to bottom, #2563eb, #1d4ed8); }
.gcal-month-year { font-size: 13px; font-weight: 600; color: #1e3a5f; min-width: 120px; text-align: center; }
.gcal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin-bottom: 5px; }
.gcal-weekday { text-align: center; font-size: 10px; font-weight: 700; color: #64748b; padding: 5px 0; }
.gcal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
.gcal-day { width: 34px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: none; background: #f1f5f9; border-radius: 6px; cursor: pointer; color: #334155; font-weight: 500; transition: all 0.15s; }
.gcal-day:hover { background: #dbeafe; transform: scale(1.05); }
.gcal-day.other-month { color: #cbd5e1; background: transparent; }
.gcal-day.other-month:hover { background: #f1f5f9; }
.gcal-day.today { background: #fef3c7; font-weight: 700; border: 2px solid #f59e0b; }
.gcal-day.selected { background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; font-weight: 700; }
.gcal-buttons { display: flex; gap: 8px; justify-content: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid #e2e8f0; }
.gcal-btn { padding: 8px 16px; font-size: 11px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; }
.gcal-btn-today { background: linear-gradient(to bottom, #10b981, #059669); color: white; }
.gcal-btn-today:hover { background: linear-gradient(to bottom, #059669, #047857); }

/* Menu photos popup */
.photos-menu-popup {
  display: none;
  position: absolute;
  bottom: 45px;
  left: 10px;
  right: 10px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  z-index: 100;
}

.photos-menu-popup.active { display: block; }

.photos-menu-header {
  font-size: 12px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid #e2e8f0;
  text-align: center;
}

.photos-menu-field {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.photos-menu-field label {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  width: 80px;
}

.photos-menu-field input {
  flex: 1;
  padding: 6px 8px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.photos-menu-btns {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.photos-menu-btns button {
  flex: 1;
  padding: 8px;
  font-size: 11px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.photos-menu-btns button:first-child {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.photos-menu-btns button:last-child {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Menu tracking dates */
.tracking-dates-menu {
  position: fixed;
  background: white;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  z-index: 20000;
  min-width: 200px;
  overflow: hidden;
}

.tracking-menu-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
}

.tracking-menu-row {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  border-bottom: 1px solid #e5e7eb;
}

.tracking-menu-label {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  width: 60px;
}

.tracking-menu-date {
  flex: 1;
  font-size: 12px;
  color: #2563eb;
  cursor: pointer;
  padding: 6px 10px;
  background: #eff6ff;
  border-radius: 4px;
  text-align: center;
}

.tracking-menu-date:hover { background: #dbeafe; }

.tracking-menu-footer {
  padding: 10px;
  text-align: center;
}

.tracking-menu-footer button {
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

/* Notes photos links panel */
.notes-photos-links-panel {
  display: none;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
}

.notes-photos-links-panel.active { display: block; }

.notes-photo-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}

.notes-photo-link-row label {
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  width: 55px;
}

.notes-photo-link-row input {
  flex: 1;
  padding: 5px 8px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.notes-save-photos-btn {
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Camera icon clickable */
.notes-camera-icon {
  font-size: 14px;
  cursor: pointer;
  margin-left: 6px;
  transition: transform 0.2s;
}

.notes-camera-icon:hover { transform: scale(1.2); }

/* ===== LIST MANAGER ===== */
.list-manager-overlay {
  position: fixed;
  inset: 0;
  background: rgba(4, 21, 44, 0.85);
  backdrop-filter: blur(4px);
  z-index: 60000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.list-manager-overlay.hidden { display: none; }

.list-manager-popup {
  background: linear-gradient(145deg, #0d2137 0%, #1a3a5c 50%, #0d2137 100%);
  border-radius: 16px;
  box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(74, 142, 245, 0.3);
  min-width: 380px;
  max-width: 480px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.list-manager-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 20px;
  background: linear-gradient(to bottom, #04152c 0%, #1a3a5c 100%);
  border-bottom: 1px solid rgba(74, 142, 245, 0.3);
}

.list-manager-header h3 {
  margin: 0;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
}

.list-manager-close-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.list-manager-close-btn:hover {
  background: #ef4444;
  border-color: #ef4444;
}

.list-manager-content {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.list-manager-items {
  max-height: 350px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.list-manager-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #fff;
  font-size: 13px;
  transition: all 0.2s;
}

.list-manager-item:hover {
  background: linear-gradient(135deg, rgba(74, 142, 245, 0.2) 0%, rgba(74, 142, 245, 0.1) 100%);
  border-color: rgba(74, 142, 245, 0.4);
}

.list-manager-item .item-index {
  color: rgba(255,255,255,0.4);
  font-size: 11px;
  margin-right: 12px;
  min-width: 24px;
}

.list-manager-item .item-name {
  flex: 1;
  font-weight: 500;
}

.list-manager-item .btn-remove-item {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border: none;
  color: #fff;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
}

.list-manager-item:hover .btn-remove-item { opacity: 1; }
.list-manager-item .btn-remove-item:hover { transform: scale(1.1); }

.list-manager-footer {
  padding: 14px 16px;
  background: linear-gradient(to bottom, #0d2137 0%, #04152c 100%);
  border-top: 1px solid rgba(74, 142, 245, 0.2);
  display: flex;
  align-items: center;
  gap: 10px;
}

.list-manager-input-wrapper {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
}

.list-manager-input-wrapper input {
  width: 100%;
  padding: 12px 50px 12px 14px;
  border-radius: 10px;
  border: 2px solid rgba(74, 142, 245, 0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 13px;
}

.list-manager-input-wrapper input:focus {
  outline: none;
  border-color: #4a8ef5;
  background: rgba(0,0,0,0.4);
}

.list-manager-input-wrapper input::placeholder {
  color: rgba(255,255,255,0.4);
}

.btn-add-inside {
  position: absolute;
  right: 6px;
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  border: none;
  color: #fff;
  width: 34px;
  height: 34px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-add-inside:hover { transform: scale(1.08); }

.btn-close-list {
  padding: 12px 20px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: #fff;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
}

.btn-close-list:hover {
  background: rgba(255,255,255,0.2);
}

.list-manager-item.just-added {
  animation: flash-green 0.5s ease;
}

@keyframes flash-green {
  0% { background: rgba(34, 197, 94, 0.5); }
  100% { background: rgba(255,255,255,0.05); }
}

.list-manager-item.just-removed {
  animation: flash-red 0.3s ease forwards;
}

@keyframes flash-red {
  0% { background: rgba(239, 68, 68, 0.5); opacity: 1; }
  100% { background: rgba(239, 68, 68, 0.2); opacity: 0; transform: translateX(20px); }
}

/* ===== MENUS CONTEXTUELS UNIFIÉS ===== */
.ctx-menu {
  position: fixed;
  background: linear-gradient(145deg, #0d2137 0%, #1a3a5c 50%, #0d2137 100%);
  border-radius: 12px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(74, 142, 245, 0.2);
  z-index: 25000;
  min-width: 240px;
  max-width: 300px;
  overflow: hidden;
}

.ctx-menu.raison {
  box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(239, 68, 68, 0.3);
}

.ctx-header {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  color: white;
  padding: 12px 16px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
}

.ctx-menu.raison .ctx-header {
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
}

.ctx-body { padding: 10px; }

.ctx-region {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  margin: 4px 0;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.ctx-region:hover { background: rgba(74, 142, 245, 0.15); }
.ctx-region.active { background: rgba(74, 142, 245, 0.2); border-color: #3b82f6; }

.ctx-region-name {
  flex: 1;
  font-size: 12px;
  font-weight: 600;
  color: #fff;
}

.ctx-input {
  width: 50px;
  padding: 4px 6px;
  font-size: 12px;
  font-weight: 700;
  text-align: center;
  border: 1px solid #4a8ef5;
  border-radius: 4px;
  background: rgba(255,255,255,0.1);
  color: #fff;
}

.ctx-unit {
  font-size: 10px;
  color: #9ca3af;
  margin-left: 6px;
}

.ctx-options {
  max-height: 200px;
  overflow-y: auto;
  padding: 8px;
}

.ctx-option {
  padding: 10px 12px;
  font-size: 11px;
  color: #fff;
  cursor: pointer;
  border-radius: 6px;
  margin-bottom: 3px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  transition: all 0.2s;
}

.ctx-option:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  transform: translateX(2px);
}

.ctx-option.selected {
  background: rgba(239, 68, 68, 0.25);
  border-color: #ef4444;
  font-weight: 700;
}

.ctx-actions {
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 8px;
  display: flex;
  gap: 6px;
}

.ctx-footer {
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-top: 1px solid rgba(255,255,255,0.1);
  text-align: center;
}

.ctx-btn {
  padding: 8px 16px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(135deg, #4a8ef5 0%, #2563eb 100%);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.1s;
}

.ctx-btn:hover { transform: scale(1.02); }
.ctx-btn.primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
.ctx-btn.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.ctx-btn.small { flex: 1; padding: 8px 10px; font-size: 10px; }

/* Animation clignotante attente active */
.mcard-delay-pill.attente-active {
  animation: blinkAttente 1s infinite;
}

@keyframes blinkAttente {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; background: #ef4444; }
}

/* ===== VUE ROBOT HORIZONTALE ===== */
.robot-horizontal-container {
  display: none;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  padding: 12px;
  background: linear-gradient(to bottom, #1a3a5c, #4a7ab8);
  z-index: 500;
}

.robot-horizontal-container.resizable {
  bottom: auto;
  min-height: 200px;
}

.robot-horizontal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  margin-bottom: 10px;
  background: linear-gradient(to bottom, #04152c, #325f9b);
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.45);
  flex-shrink: 0;
}

.robot-horizontal-header h2 { color: #fff; margin: 0; font-size: 16px; }

.robot-horizontal-scroll {
  flex: 1;
  overflow: auto;
  background: white;
  border-radius: 8px 8px 0 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.45);
  min-height: 200px;
}

/* Barre de redimensionnement en bas */
.robot-resize-bar {
  height: 20px;
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border-radius: 0 0 8px 8px;
  cursor: ns-resize;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 4px;
  transition: background 0.2s;
}

.robot-resize-bar:hover {
  background: linear-gradient(to bottom, #2563eb, #1e40af);
}

.robot-resize-grip {
  color: rgba(255,255,255,0.6);
  font-size: 16px;
  letter-spacing: 2px;
  user-select: none;
}

.robot-resize-bar:hover .robot-resize-grip {
  color: rgba(255,255,255,0.9);
}

.robot-horizontal-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.robot-horizontal-table thead {
  position: sticky;
  top: 0;
  z-index: 100;
}

.robot-horizontal-table th {
  position: relative;
  background: linear-gradient(to bottom, #1e40af, #0f172a);
  color: #fff;
  padding: 6px 4px;
  text-align: center;
  font-weight: 600;
  font-size: 10px;
  border: 1px solid #3b82f6;
  white-space: nowrap;
  min-width: 60px;
}

.resize-handle {
  position: absolute;
  top: 0; right: 0; bottom: 0;
  width: 5px;
  cursor: col-resize;
  background: rgba(255,255,255,0.2);
}

.resize-handle:hover { background: rgba(255,255,255,0.5); }

.robot-horizontal-table td {
  padding: 4px;
  border: 1px solid #d1d5db;
  font-size: 10px;
  color: #1f2937;
  text-align: center;
  background: white;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.robot-horizontal-table td.editable {
  cursor: text;
  background: #fffbeb;
}

.robot-horizontal-table td.locked {
  cursor: not-allowed;
  background: #f1f5f9;
  color: #1e40af;
  font-weight: 600;
}

.robot-horizontal-table td.editable:hover { background: #fef3c7; }
.robot-horizontal-table td.editable:focus { outline: 2px solid #3b82f6; background: #dbeafe; }

.robot-horizontal-table tbody tr:nth-child(even) td { background: #f8fafc; }
.robot-horizontal-table tbody tr:nth-child(even) td.editable { background: #fefce8; }
.robot-horizontal-table tbody tr:hover td { background: #e0f2fe !important; }

/* Select simple */
.table-select {
  width: 100%;
  padding: 3px 4px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  background: white;
  cursor: pointer;
}

.table-select:focus { outline: none; border-color: #3b82f6; }

/* Cellule date */
.date-cell {
  cursor: pointer;
  font-size: 10px;
}

.date-cell:hover { background: #dbeafe !important; color: #1e40af; }
.date-cell.has-date { color: #166534; font-weight: 600; background: #dcfce7 !important; }
.date-cell.placeholder { color: #9ca3af; font-style: italic; }

/* Notes */
.notes-cell { padding: 3px !important; }

.notes-btn {
  padding: 3px 8px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  background: #f3f4f6;
  cursor: pointer;
}

.notes-btn:hover { background: #e5e7eb; }

.notes-btn.has-notes {
  background: linear-gradient(to bottom, #fbbf24, #f59e0b);
  color: white;
  border-color: #d97706;
  animation: blink-notes 1s infinite;
}

@keyframes blink-notes { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

.rang-robot-text { font-weight: 600; color: #1e40af; }

/* Popup Notes - style fiche */
.notes-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 29000;
}

.notes-popup-page {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #f8fafc;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  z-index: 30000;
  width: 550px;
  height: 500px;
  display: flex;
  flex-direction: column;
  padding: 14px;
}

.notes-popup-page .notes-page-header {
  font-size: 14px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 2px solid #3b82f6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notes-popup-page .notes-header-left {
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  color: #1e40af;
}

.notes-popup-page .notes-header-center {
  flex: 1;
  text-align: center;
  font-size: 16px;
}

.notes-popup-page .notes-close-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notes-popup-page .notes-photos-row {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
}

.notes-popup-page .notes-photo-btn {
  flex: 1;
  padding: 8px 4px;
  font-size: 11px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
}

.notes-popup-page .notes-photo-btn:hover { background: #f3f4f6; }
.notes-popup-page .notes-photo-btn.has-link { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; border-color: #15803d; }

.notes-popup-page .notes-page-textarea {
  flex: 1;
  width: 100%;
  padding: 12px;
  font-size: 13px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.5;
  background: white;
}

.notes-popup-page .notes-photos-links-panel {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
}

.notes-popup-page .notes-photo-link-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.notes-popup-page .notes-photo-link-row label {
  width: 60px;
  font-size: 11px;
  font-weight: 600;
  color: #374151;
}

.notes-popup-page .notes-photo-link-row input {
  flex: 1;
  padding: 6px 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.notes-popup-page .notes-save-photos-btn {
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: 30px; left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  color: #fff; padding: 14px 28px; border-radius: 12px;
  font-weight: 600; font-size: 14px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5); z-index: 99999;
  opacity: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

/* ===== MODAL AJOUTER MOULAGE ===== */
.add-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
}
.add-modal-overlay.hidden { display: none; }

.add-modal {
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  width: 95%;
  max-width: 580px;
}

.add-modal-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-radius: 12px 12px 0 0;
}

.add-modal-header h3 {
  margin: 0;
  font-size: 15px;
  font-weight: 700;
}

.add-modal-header-btns {
  display: flex;
  align-items: center;
  gap: 8px;
}

.add-json-btn {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  border: none;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.add-json-btn:hover {
  filter: brightness(1.1);
}

.add-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 22px;
  cursor: pointer;
  line-height: 1;
}

.add-modal-body {
  padding: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.add-modal-field {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.add-modal-field label {
  font-size: 11px;
  font-weight: 600;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 4px;
}

.add-modal-field input,
.add-modal-field select {
  padding: 5px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 12px;
  transition: border-color 0.2s;
}

.add-modal-field input:focus,
.add-modal-field select:focus {
  outline: none;
  border-color: #3b82f6;
}

.add-modal-footer {
  padding: 10px 14px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  border-radius: 0 0 12px 12px;
}

.add-modal-footer button {
  padding: 7px 16px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 5px;
  cursor: pointer;
  border: none;
}

.add-btn-cancel {
  background: #e5e7eb;
  color: #374151;
}

.add-btn-confirm {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.add-btn-confirm:hover {
  filter: brightness(1.1);
}

/* ===== MODALS RESPONSIVE MOBILE ===== */
@media (max-width: 600px) {
  .add-modal {
    max-width: 100%;
    max-height: 90vh;
    margin: 10px;
    display: flex;
    flex-direction: column;
  }
  
  .add-modal-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow-y: auto;
    max-height: 60vh;
    padding: 10px;
  }
  
  .add-modal-field {
    width: 100%;
  }
  
  .add-modal-field label {
    font-size: 10px;
  }
  
  .add-modal-field input,
  .add-modal-field select {
    font-size: 14px;
    padding: 8px 10px;
  }
  
  /* Job Add Modal Mobile */
  .job-add-modal {
    max-width: 100%;
    max-height: 90vh;
    margin: 10px;
    display: flex;
    flex-direction: column;
  }
  
  .job-add-body {
    overflow-y: auto;
    max-height: 65vh;
    padding: 10px;
  }
  
  .job-add-row {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  .job-add-field {
    flex: none !important;
    width: 100% !important;
  }
  
  .job-add-field label {
    font-size: 10px;
  }
  
  .job-add-field input,
  .job-add-field select {
    font-size: 14px;
    padding: 10px 12px;
    height: auto;
  }
  
  .job-add-header h3 {
    font-size: 13px;
  }
  
  .job-add-footer {
    padding: 10px;
  }
  
  .job-add-footer button {
    padding: 10px 16px;
    font-size: 13px;
  }
}

/* ===== CALENDRIER POPUP ===== */
/* ===== CALENDRIER UNIFIÉ ===== */
.cal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
}

.cal-popup {
  position: fixed;
  z-index: 200000;
}

.cal-container {
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border-radius: 10px;
  padding: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  min-width: 260px;
}

.cal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  color: #fff;
  font-weight: 600;
  font-size: 13px;
}

.cal-header button {
  background: rgba(255,255,255,0.1);
  border: none;
  color: #fff;
  padding: 4px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}
.cal-header button:hover { background: rgba(255,255,255,0.2); }

.cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 4px;
}
.cal-weekdays span {
  text-align: center;
  font-size: 9px;
  color: #888;
  padding: 4px 0;
}

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.cal-cell {
  text-align: center;
  padding: 7px 3px;
  font-size: 11px;
  color: #fff;
  cursor: pointer;
  border-radius: 3px;
  background: rgba(255,255,255,0.05);
}
.cal-cell:hover { background: rgba(74,142,245,0.4); }
.cal-cell.today { border: 2px solid #4a8ef5; }
.cal-cell.selected { background: #4a8ef5; font-weight: bold; }
.cal-cell.empty { cursor: default; background: transparent; }

.cal-footer {
  display: flex;
  gap: 6px;
  margin-top: 10px;
  justify-content: center;
}

.cal-btn {
  padding: 5px 10px;
  border-radius: 4px;
  border: none;
  font-size: 10px;
  cursor: pointer;
  font-weight: 600;
}
.cal-btn.today { background: linear-gradient(to bottom, #4a8ef5, #2563eb); color: #fff; }
.cal-btn.clear { background: linear-gradient(to bottom, #ef4444, #dc2626); color: #fff; }
.cal-btn.close { background: linear-gradient(to bottom, #6b7280, #4b5563); color: #fff; }

/* Date picker field style */
.date-picker-field {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 5px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: white;
  cursor: pointer;
  font-size: 11px;
  color: #6b7280;
  transition: border-color 0.2s;
}
.date-picker-field:hover { border-color: #3b82f6; }
.date-picker-field.has-value { color: #111827; }
.date-picker-icon { font-size: 12px; }

/* ===== STRUCTURE MULTI-PAGES ===== */
.page {
  display: none !important;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

.page.active {
  display: flex !important;
}

.page-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  color: white;
  text-align: center;
  background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
}

.page-placeholder h1 {
  font-size: 48px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.page-placeholder p {
  font-size: 18px;
  opacity: 0.7;
}

/* Pages Série et Inventaire */
.serie-page,
.inventaire-page {
  height: calc(100vh - 110px);
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
  overflow: hidden;
  padding: 8px;
  gap: 6px;
}

/* Rangée horizontale grande (en haut) - À FAIRE */
.inv-row-large {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
  overflow: hidden;
}

.inv-row-large-header {
  padding: 6px 12px;
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  font-weight: 700;
  font-size: 12px;
  border-bottom: 2px solid #3b82f6;
}

.inv-row-large-content {
  flex: 1;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 6px;
  overflow-y: auto;
  align-content: flex-start;
}

/* Rangées horizontales petites (en bas) - Pablo et Checkna */
.inv-row-small {
  height: 100px;
  display: flex;
  flex-direction: column;
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
  overflow: hidden;
}

/* En-tête avec colonnes numérotées - noms à DROITE */
.inv-row-header-numbered {
  display: flex;
  align-items: stretch;
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  border-bottom: 2px solid #3b82f6;
  height: 22px;
}

/* Colonnes numérotées 5-4-3-2-1 (à gauche) */
.inv-col-numbers {
  flex: 1;
  display: flex;
}

.inv-col-num {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255,255,255,0.9);
  font-size: 12px;
  font-weight: 700;
  border-right: 1px solid rgba(255,255,255,0.2);
}

/* Zone nom + colonne 0 (production) - à DROITE */
.inv-col-name {
  width: 180px;
  min-width: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: rgba(0,0,0,0.2);
  border-left: 2px solid #3b82f6;
}

.inv-col-name-text {
  color: white;
  font-weight: 700;
  font-size: 12px;
}

.inv-col-name-status {
  color: #4ade80;
  font-size: 9px;
  font-weight: 600;
}

/* Corps de la rangée */
.inv-row-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* Colonnes pour cubes 5-4-3-2-1 (à gauche) */
.inv-cols-content {
  flex: 1;
  display: flex;
}

.inv-col-slot {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  border-right: 1px solid rgba(255,255,255,0.1);
  transition: background 0.2s;
}

.inv-col-slot.drag-over {
  background: rgba(59, 130, 246, 0.3);
}

/* Zone 0 (production) à DROITE sous le nom */
.inv-col-zero {
  width: 180px;
  min-width: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  background: rgba(0,0,0,0.15);
  border-left: 2px solid #3b82f6;
  transition: background 0.2s;
}

.inv-col-zero.drag-over {
  background: rgba(34, 197, 94, 0.3);
}

/* Cubes inventaire - taille adaptée aux colonnes */
.inv-cube {
  width: calc(100% - 8px);
  max-width: 160px;
  height: 54px;
  background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
  border: 2px solid #1e40af;
  border-radius: 6px;
  padding: 4px;
  cursor: grab;
  display: flex;
  flex-direction: column;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: all 0.2s;
  position: relative;
}

.inv-cube:active {
  cursor: grabbing;
}

.inv-cube.dragging {
  opacity: 0.5;
  transform: scale(0.95);
}

.inv-cube:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
  border-color: #3b82f6;
}

.inv-cube-name {
  font-size: 9px;
  font-weight: 700;
  color: #1e3a8a;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.inv-cube-number {
  font-size: 11px;
  font-weight: 800;
  color: #1e40af;
  text-align: center;
  margin-top: 2px;
}

/* Quantité dans le cube */
.inv-cube-qty {
  position: absolute;
  top: -6px;
  left: -6px;
  min-width: 20px;
  height: 20px;
  padding: 0 4px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border: 2px solid white;
  border-radius: 10px;
  color: white;
  font-size: 10px;
  font-weight: 800;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* Bouton ajouter cube */
.inv-add-cube {
  width: calc(100% - 8px);
  max-width: 160px;
  height: 54px;
  background: rgba(255,255,255,0.1);
  border: 2px dashed rgba(255,255,255,0.3);
  border-radius: 6px;
  color: rgba(255,255,255,0.5);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.inv-add-cube:hover {
  background: rgba(255,255,255,0.2);
  border-color: rgba(255,255,255,0.5);
  color: white;
}

/* Cube dans zone À faire */
.inv-row-large-content .inv-cube,
.inv-row-large-content .inv-add-cube {
  width: 150px;
  max-width: 150px;
  flex-shrink: 0;
}

/* Zone À faire - drop zone */
.inv-row-large-content.drag-over {
  background: rgba(59, 130, 246, 0.2);
}

/* Fiche Inventaire */
.inv-fiche-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
}

.inv-fiche-overlay.hidden { display: none; }

.inv-fiche {
  background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
  border-radius: 12px;
  width: 100%;
  max-width: 700px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  overflow: hidden;
}

.inv-fiche-header {
  padding: 16px 20px;
  background: rgba(0,0,0,0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.inv-fiche-title {
  color: white;
  font-size: 18px;
  font-weight: 700;
}

.inv-fiche-close {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  opacity: 0.7;
}

.inv-fiche-close:hover { opacity: 1; }

.inv-fiche-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.inv-fiche-row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.inv-fiche-field {
  flex: 1;
}

.inv-fiche-label {
  font-size: 10px;
  font-weight: 700;
  color: rgba(255,255,255,0.7);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.inv-fiche-input {
  width: 100%;
  padding: 8px 10px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  color: white;
  font-size: 13px;
}

.inv-fiche-input:focus {
  outline: none;
  border-color: #3b82f6;
}

.inv-fiche-select {
  width: 100%;
  padding: 8px 10px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  color: white;
  font-size: 13px;
}

.inv-fiche-textarea {
  width: 100%;
  padding: 8px 10px;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  color: white;
  font-size: 13px;
  min-height: 80px;
  resize: vertical;
}

.inv-fiche-actions {
  padding: 16px 20px;
  background: rgba(0,0,0,0.2);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.inv-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

.inv-btn-save {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.inv-btn-delete {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
}

.inv-btn-cancel {
  background: rgba(255,255,255,0.2);
  color: white;
}

/* ===== LOGIN ===== */
.login-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom, #0b1d36, #3f6eb8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50000;
}
.login-overlay.hidden { display: none; }

.login-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 30px rgba(0,0,0,0.85);
  padding: 40px;
  max-width: 500px;
  width: 90%;
  color: #fff;
  text-align: center;
}

.login-logo-flip-container {
  width: 385px;
  height: 140px;
  margin: 15px auto 25px auto;
}

.login-logo-flip-inner {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-logo-flip-front { display: flex; align-items: center; justify-content: center; }
.login-logo-flip-front img { height: 122px; width: auto; object-fit: contain; }

.login-title-container { text-align: center; margin-bottom: 10px; }
.login-title { font-size: 18px; font-weight: 700; margin-bottom: 3px; line-height: 1.3; }
.login-author {
  font-family: 'Brush Script MT', 'Segoe Script', 'Bradley Hand', cursive;
  font-size: 22px;
  color: rgba(255,255,255,0.7);
  font-style: italic;
}
.login-subtitle { font-size: 13px; opacity: 0.8; margin-bottom: 25px; }

#loginForm {
  width: 100%;
}

.login-input {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 18px;
  text-align: center;
  margin-bottom: 20px;
  box-sizing: border-box;
  letter-spacing: 3px;
}
.login-input::placeholder { color: rgba(255,255,255,0.5); letter-spacing: normal; font-size: 14px; }
.login-input:focus { outline: none; border-color: #00aaff; box-shadow: 0 0 10px rgba(0,170,255,0.3); }
.login-input-email { letter-spacing: normal !important; text-align: center !important; }

.login-btn {
  width: 100%;
  padding: 14px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #00aaff, #0077cc);
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.login-btn:hover { background: linear-gradient(to bottom, #00bbff, #0088dd); transform: translateY(-1px); }
.login-btn:disabled { opacity: 0.6; cursor: not-allowed; }

.login-error { color: #ff6666; font-size: 12px; margin-top: 10px; min-height: 20px; }

.login-remember {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 10px 0 15px 0;
  font-size: 13px;
  color: rgba(255,255,255,0.8);
}
.login-remember input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #00aaff; }
.login-remember label { cursor: pointer; }

.login-forgot-btn {
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.7);
  font-size: 12px;
  cursor: pointer;
  margin-top: 5px;
  text-decoration: underline;
}
.login-forgot-btn:hover { color: #00aaff; }

/* ===== MOVE MENU (ancien avec rangs) ===== */
.move-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.move-overlay.hidden {
  display: none;
}

.move-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 10px;
  max-width: 95%;
  width: 750px;
  box-sizing: border-box;
}

.move-title {
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.move-columns {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.move-column {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.move-column-header {
  background: linear-gradient(to bottom, #2b5b99, #103561);
  border-radius: 6px;
  padding: 4px 2px;
  text-align: center;
  font-weight: 700;
  font-size: 7px;
  color: #ffffff;
  border: 1px solid rgba(0,0,0,0.5);
}

.move-column-header.current {
  background: linear-gradient(to bottom, #059669, #047857);
}

.move-positions {
  display: flex;
  flex-direction: column;
  gap: 2px;
  max-height: 200px;
  overflow-y: auto;
}

.move-position-btn {
  background: linear-gradient(to bottom, #233d63, #12243f);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 4px;
  padding: 3px 2px;
  text-align: center;
  font-weight: 600;
  font-size: 8px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.15s;
}

.move-position-btn:hover {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  border-color: #3b82f6;
}

.move-footer {
  display: flex;
  justify-content: center;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.move-btn-close {
  padding: 5px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  cursor: pointer;
  font-weight: 600;
  font-size: 10px;
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* ===== CONFIRM DELETE MENU ===== */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20001;
}

.confirm-overlay.hidden {
  display: none;
}

.confirm-panel {
  background: linear-gradient(to bottom, #1a1a2e, #16213e);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 20px;
  text-align: center;
  max-width: 300px;
}

.confirm-title {
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.confirm-message {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
  margin-bottom: 16px;
}

.confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.confirm-btn {
  padding: 8px 20px;
  border-radius: 999px;
  border: none;
  font-weight: 600;
  font-size: 11px;
  cursor: pointer;
  color: #fff;
}

.confirm-btn-yes {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.confirm-btn-no {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
}

.confirm-btn:hover {
  filter: brightness(1.1);
}

/* =============================================================================
   INTERFACE MOBILE - COMPLÈTEMENT SÉPARÉE DU DESKTOP
   N'affecte PAS l'apparence desktop. Activé uniquement sur mobile/tablette.
============================================================================= */

/* Écran d'accueil mobile */
.mobile-home-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom, #04152c 0%, #1a4a7a 50%, #4a8ef5 100%);
  z-index: 100000;
  flex-direction: column;
  overflow: hidden;
}

.mobile-home-overlay.active {
  display: flex;
}

.mobile-home-header {
  padding: 10px 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(to bottom, #04152c 0%, #0d2d4d 100%);
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.mobile-home-back {
  background: none;
  border: none;
  color: rgba(255,255,255,0.9);
  font-size: 14px;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 6px;
  flex-shrink: 0;
}

.mobile-home-back:active {
  background: rgba(255,255,255,0.1);
}

.mobile-home-add {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border: 2px solid #000;
  color: white;
  font-size: 18px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.mobile-home-title {
  flex: 1;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
  text-align: center;
  margin: 0;
  line-height: 1.2;
}

/* Barre de recherche mobile - compacte */
.mobile-search-container {
  padding: 8px 15px 4px 15px;
  background: rgba(0,0,0,0.2);
}

.mobile-search-box {
  display: flex;
  align-items: center;
  background: rgba(255,255,255,0.95);
  border-radius: 25px;
  padding: 8px 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.mobile-search-box input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 15px;
  color: #333;
  outline: none;
}

.mobile-search-box input::placeholder {
  color: #999;
}

.mobile-search-icon {
  font-size: 18px;
  color: #666;
  margin-right: 8px;
}

.mobile-search-clear {
  font-size: 18px;
  color: #999;
  cursor: pointer;
  padding: 5px;
  display: none;
}

.mobile-search-clear.visible {
  display: block;
}

/* Résultats de recherche */
.mobile-search-results {
  flex: 1;
  overflow-y: auto;
  padding: 10px 15px;
  -webkit-overflow-scrolling: touch;
}

/* Message aucun résultat */
.mobile-no-results {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255,255,255,0.7);
}

.mobile-no-results-icon {
  font-size: 50px;
  margin-bottom: 15px;
}

.mobile-no-results-text {
  font-size: 16px;
}

/* Message initial */
.mobile-search-hint {
  text-align: center;
  padding: 60px 30px;
  color: rgba(255,255,255,0.6);
}

.mobile-search-hint-icon {
  font-size: 60px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.mobile-search-hint-text {
  font-size: 15px;
  line-height: 1.5;
}

/* Compteur de moulages - vert sous la barre de recherche */
.mobile-search-container .mobile-cards-count {
  font-size: 11px;
  font-weight: 600;
  color: #22c55e;
  text-align: center;
  padding: 4px 0;
  margin: 0;
  background: transparent;
}

/* Cartes mobiles - Style PC compact */
.mobile-card {
  position: relative;
  margin: 4px 10px;
  padding: 6px 10px;
  border-radius: 12px;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  border: 2px solid #000;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 2px 6px rgba(0,0,0,0.35);
  cursor: pointer;
  transition: transform 0.15s;
}

/* Ligne du haut: Statut + Nom */
.mobile-card-top {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 2px;
}

/* Pastille statut à gauche */
.mobile-card-status {
  font-size: 8px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 6px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  flex-shrink: 0;
}

/* Couleurs par statut */
.mobile-card-status.status-robot { background: #3b82f6; }
.mobile-card-status.status-degauchage { background: #8b5cf6; }
.mobile-card-status.status-essayage { background: #06b6d4; }
.mobile-card-status.status-atelier { background: #22c55e; }
.mobile-card-status.status-couture { background: #f59e0b; }
.mobile-card-status.status-peinture { background: #ec4899; }
.mobile-card-status.status-expedition { background: #10b981; }
.mobile-card-status.status-attente { background: #ef4444; }

.mobile-card:active {
  transform: scale(0.98);
}

.mobile-card.region-qc {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
}

.mobile-card.region-on {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
}

.mobile-card.region-ma {
  background: linear-gradient(to bottom, #451238 0%, #8D2E6A 40%, #C7458C 100%);
}

/* Carte en attente - bordure rouge */
.mobile-card.en-attente {
  border-color: #ef4444;
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
}

/* Nom du moulage - à droite du statut */
.mobile-card-name {
  flex: 1;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Ligne du milieu : REP + Commande + Région */
.mobile-card-middle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  margin-bottom: 2px;
}

/* Représentante à gauche */
.mobile-card-rep {
  font-size: 10px;
  color: rgba(255,255,255,0.85);
  text-shadow: 1px 1px 0 #000;
  flex-shrink: 0;
}

/* Numéro de commande au centre - PLUS GRAND */
.mobile-card-order {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  text-shadow: 1px 1px 0 #000;
}

/* Pastille région à droite */
.mobile-card-region {
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 8px;
  background: rgba(0,0,0,0.35);
  color: #fff;
  text-shadow: 1px 1px 0 #000;
  text-transform: uppercase;
  flex-shrink: 0;
}

.mobile-card.region-qc .mobile-card-region { background: rgba(59, 130, 246, 0.5); }
.mobile-card.region-on .mobile-card-region { background: rgba(232, 185, 122, 0.5); color: #000; text-shadow: none; }
.mobile-card.region-ma .mobile-card-region { background: rgba(199, 69, 140, 0.5); }

/* Pastille délai - LARGE (même largeur que carte) */
.mobile-card-delay {
  display: block;
  width: 100%;
  font-size: 11px;
  font-weight: 700;
  padding: 3px 0;
  border-radius: 999px;
  border: 2px solid #000;
  background: rgba(0,0,0,0.25);
  color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  text-align: center;
  margin-top: 2px;
  box-sizing: border-box;
}

/* Même couleur que carte par défaut */
.mobile-card.region-qc .mobile-card-delay { background: rgba(59, 130, 246, 0.4); }
.mobile-card.region-on .mobile-card-delay { background: rgba(180, 140, 80, 0.5); color: #000; text-shadow: none; }
.mobile-card.region-ma .mobile-card-delay { background: rgba(199, 69, 140, 0.4); }

/* Urgent = jaune */
.mobile-card-delay.urgent {
  background: linear-gradient(135deg, #f59e0b, #d97706) !important;
  color: #000 !important;
  text-shadow: none !important;
}

/* Retard = rouge */
.mobile-card-delay.retard {
  background: linear-gradient(135deg, #ef4444, #dc2626) !important;
  color: #fff !important;
  text-shadow: none !important;
  animation: mobileBlink 1s infinite;
}

/* Badge EN ATTENTE */
.mobile-card-attente-badge {
  display: block;
  width: 100%;
  font-size: 11px;
  font-weight: 700;
  padding: 4px 0;
  border-radius: 5px;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: #fff;
  text-align: center;
  margin-top: 2px;
  animation: mobileBlink 1s infinite;
}

/* Raison attente */
.mobile-card-raison {
  font-size: 9px;
  color: rgba(255,255,255,0.8);
  text-align: center;
  margin-top: 2px;
  font-style: italic;
}

@keyframes mobileBlink {
  50% { opacity: 0.6; }
}

/* Bouton accès desktop */
.mobile-desktop-btn {
  margin: 15px 20px;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 10px;
  color: rgba(255,255,255,0.8);
  font-size: 13px;
  text-align: center;
  cursor: pointer;
}

.mobile-desktop-btn:active {
  background: rgba(255,255,255,0.2);
}

/* =============================================================================
   MENU MOBILE - CHOIX MOULAGES / JOBS
============================================================================= */
.mobile-menu-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, #0a1628 0%, #1a365d 50%, #2d4a6f 100%);
  z-index: 100000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 30px;
}

.mobile-menu-overlay.active {
  display: flex;
}

.mobile-menu-title {
  color: white;
  font-size: 20px;
  font-weight: 300;
  text-align: center;
  margin-bottom: 10px;
  opacity: 0.9;
  letter-spacing: 1px;
}

.mobile-menu-author {
  color: rgba(255,255,255,0.7);
  font-size: 14px;
  font-weight: 300;
  text-align: center;
  margin-bottom: 40px;
  font-style: italic;
}

/* Cacher le logo sur mobile si écran petit */
@media (max-width: 768px) {
  .login-logo-flip-container {
    display: none !important;
  }
  .login-title-container {
    margin-top: 20px;
  }
}

.mobile-menu-buttons {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
  max-width: 320px;
}

.mobile-menu-btn {
  padding: 22px 25px;
  border-radius: 16px;
  border: none;
  font-size: 17px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.2s ease;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  position: relative;
  overflow: hidden;
}

.mobile-menu-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 50%;
  background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
  border-radius: 16px 16px 0 0;
}

.mobile-menu-btn:active {
  transform: scale(0.97);
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.mobile-menu-btn.btn-moulages {
  background: linear-gradient(145deg, #4a90e2, #2563eb);
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.mobile-menu-btn.btn-jobs {
  background: linear-gradient(145deg, #f7b32b, #e09100);
  color: #1a1a1a;
  text-shadow: 0 1px 0 rgba(255,255,255,0.3);
}

.mobile-menu-btn-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.mobile-menu-btn-text {
  flex: 1;
  text-align: left;
}

.mobile-menu-btn-count {
  font-size: 13px;
  opacity: 0.85;
  background: rgba(0,0,0,0.2);
  padding: 3px 10px;
  border-radius: 12px;
}

.mobile-desktop-btn {
  margin-top: 40px;
  padding: 12px 25px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 25px;
  color: rgba(255,255,255,0.8);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.mobile-desktop-btn:active {
  background: rgba(255,255,255,0.2);
}

/* =============================================================================
   JOBS MOBILE - LISTE
============================================================================= */
.mobile-jobs-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, #0a1628 0%, #1a365d 50%, #2d4a6f 100%);
  z-index: 100000;
  flex-direction: column;
}

.mobile-jobs-overlay.active {
  display: flex;
}

.mobile-jobs-header {
  padding: 12px 15px;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  gap: 10px;
}

.mobile-jobs-back {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
  padding: 5px 8px;
}

.mobile-jobs-title {
  flex: 1;
  color: white;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
}

.mobile-jobs-add {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border: 2px solid #000;
  color: white;
  font-size: 18px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

.mobile-jobs-list {
  flex: 1;
  overflow-y: auto;
  padding: 10px 15px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Carte Job Mobile avec bordure noire */
.mobile-job-card {
  background: linear-gradient(135deg, #04152c, #4a8ef5);
  border-radius: 12px;
  border: 2px solid #000;
  padding: 10px 12px;
  color: white;
  cursor: pointer;
  transition: transform 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.mobile-job-card:active {
  transform: scale(0.98);
}

.mobile-job-card.region-on {
  background: linear-gradient(135deg, #704414, #E8B97A);
}

.mobile-job-card.region-fr {
  background: linear-gradient(135deg, #5c4d00, #f5c800);
}

/* Ligne 1: # commande centré + Rep à droite */
.mobile-job-card-row1 {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  margin-bottom: 4px;
}

.mobile-job-card-order {
  font-size: 17px;
  font-weight: 700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  text-align: center;
}

.mobile-job-card-rep {
  position: absolute;
  right: 0;
  font-size: 11px;
  font-weight: 600;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Ligne 2: Client */
.mobile-job-card-row2 {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 6px;
}

.mobile-job-card-client {
  font-size: 12px;
  font-weight: 500;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Ligne 3: Pastille délai pleine largeur */
.mobile-job-card-days {
  display: block;
  width: 100%;
  font-size: 11px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 20px;
  border: 2px solid #000;
  text-align: center;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  box-sizing: border-box;
  color: #fff;
}

/* Couleurs selon délai - OK = même couleur que carte (transparent) */
.mobile-job-card-days.ok {
  background: rgba(0,0,0,0.2);
}

.mobile-job-card-days.warn {
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

.mobile-job-card-days.danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
}

.mobile-job-card-days.critical {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  animation: pulseRed 2s ease-in-out infinite;
}

@keyframes pulseRed {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* =============================================================================
   FICHE JOB MOBILE
============================================================================= */
.mobile-job-fiche-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #f8fafc;
  z-index: 100002;
  flex-direction: column;
}

.mobile-job-fiche-overlay.active {
  display: flex;
  animation: mobileSlideInUp 0.3s ease-out;
}

.mobile-job-fiche-header {
  padding: 12px 15px;
  background: linear-gradient(to right, #04152c, #4a8ef5);
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
}

.mobile-job-fiche-header.region-on {
  background: linear-gradient(to right, #704414, #E8B97A);
}

.mobile-job-fiche-header.region-fr {
  background: linear-gradient(to right, #5c4d00, #f5c800);
}

.mobile-job-fiche-back {
  background: none;
  border: none;
  color: white;
  font-size: 14px;
  cursor: pointer;
}

.mobile-job-fiche-title {
  flex: 1;
  font-size: 14px;
  font-weight: 700;
}

.mobile-job-fiche-swipe {
  flex: 1;
  overflow: hidden;
  position: relative;
}

.mobile-job-fiche-wrapper {
  display: flex;
  width: 200%;
  height: 100%;
  transition: transform 0.3s ease;
}

.mobile-job-fiche-page {
  width: 50%;
  height: 100%;
  overflow-y: auto;
  padding: 15px;
}

.mobile-job-fiche-page.page-info {
  background: #f8fafc;
}

.mobile-job-fiche-page.page-notes {
  background: white;
}

.mobile-job-field {
  margin-bottom: 12px;
}

.mobile-job-field label {
  display: block;
  font-size: 10px;
  color: #64748b;
  text-transform: uppercase;
  font-weight: 600;
  margin-bottom: 4px;
}

.mobile-job-field input,
.mobile-job-field select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  box-sizing: border-box;
}

.mobile-job-field-row {
  display: flex;
  gap: 10px;
}

.mobile-job-field-row .mobile-job-field {
  flex: 1;
}

.mobile-job-date-pill {
  padding: 8px 6px;
  background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 500;
  color: #1f2937;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.mobile-job-date-pill:active {
  transform: scale(0.97);
  background: linear-gradient(to bottom, #e2e8f0, #cbd5e1);
}

.mobile-job-notes-area {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.mobile-job-notes-header {
  font-size: 14px;
  font-weight: 700;
  color: #1e3a5f;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mobile-job-notes-content {
  flex: 1;
  width: 100%;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  padding: 12px;
  font-size: 14px;
  font-family: inherit;
  line-height: 1.5;
  min-height: 250px;
  max-height: 400px;
  overflow-y: auto;
  background: white;
  box-sizing: border-box;
  color: #1e293b;
}

.mobile-job-notes-content:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.mobile-job-notes-content:empty:before {
  content: 'Cliquez pour ajouter des notes...';
  color: #94a3b8;
  font-style: italic;
}

.mobile-job-notes-content img {
  max-width: 100%;
  border-radius: 4px;
  cursor: nwse-resize;
}

.mobile-job-fiche-footer {
  padding: 10px 15px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
}

.mobile-job-fiche-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

.mobile-job-fiche-btn.btn-done {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
}

.mobile-job-fiche-btn.btn-email {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
}

.mobile-job-swipe-indicator {
  padding: 8px;
  text-align: center;
  font-size: 11px;
  color: #64748b;
  background: #f1f5f9;
}

/* =============================================================================
   FICHE MOBILE AVEC SWIPE - 2 PAGES (Info et Notes)
============================================================================= */

.mobile-fiche-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #ffffff;
  z-index: 100001;
  flex-direction: column;
  overflow: hidden;
}

.mobile-fiche-overlay.active {
  display: flex;
  animation: mobileSlideInUp 0.3s ease-out;
}

@keyframes mobileSlideInUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Header de la fiche mobile */
.mobile-fiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 15px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  border-bottom: none;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  gap: 10px;
}

.mobile-fiche-back {
  display: flex;
  align-items: center;
  gap: 4px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: #fff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  flex-shrink: 0;
}

.mobile-fiche-title {
  flex: 1;
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.mobile-fiche-order {
  font-size: 13px;
  color: #fff;
  font-weight: 700;
  background: rgba(255,255,255,0.2);
  padding: 6px 10px;
  border-radius: 6px;
  flex-shrink: 0;
}

/* Container des pages swipe - PLEIN ÉCRAN */
.mobile-fiche-swipe-container {
  flex: 1;
  position: relative;
  overflow: hidden;
  width: 100%;
}

/* Wrapper pour 2 pages seulement */
.mobile-fiche-swipe-wrapper-2pages {
  display: flex;
  width: 200%;
  height: 100%;
  transition: transform 0.3s ease-out;
  will-change: transform;
}

.mobile-fiche-swipe-wrapper-2pages.dragging {
  transition: none;
}

.mobile-fiche-swipe-wrapper-2pages .mobile-fiche-page {
  width: 50%;
  min-width: 50%;
}

.mobile-fiche-page {
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px 10px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  flex-shrink: 0;
}

/* Page Info - compacte */
.mobile-page-info {
  background: #ffffff;
  padding: 8px 12px;
}

@media (min-width: 600px) {
  .mobile-page-info {
    padding: 12px 25px;
  }
}

/* Carte info */
.mobile-info-card {
  background: #ffffff;
  border-radius: 8px;
  padding: 6px 10px;
  margin-bottom: 0;
  border: 1px solid #e2e8f0;
  flex: 1;
  overflow-y: auto;
}

/* BLOC STATUT - Une seule ligne */
.mobile-status-block {
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 6px;
  box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  flex-wrap: wrap;
  cursor: pointer;
  transition: transform 0.2s;
}

.mobile-status-block:active {
  transform: scale(0.98);
}

.mobile-status-edit {
  font-size: 10px;
  color: rgba(255,255,255,0.8);
  padding: 2px 6px;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
}

.mobile-status-block.attente {
  background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
  box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
  animation: pulseAttente 2s infinite;
}

@keyframes pulseAttente {
  0%, 100% { box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3); }
  50% { box-shadow: 0 2px 12px rgba(220, 38, 38, 0.6); }
}

.mobile-status-text {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  text-transform: uppercase;
}

.mobile-status-raison {
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.95);
  padding: 3px 8px;
  background: rgba(0,0,0,0.25);
  border-radius: 4px;
}

/* Lignes d'info compactes */
.mobile-info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid #f1f5f9;
}

.mobile-info-row:last-child {
  border-bottom: none;
}

/* Tailles par défaut - réduites de 1px */
.mobile-info-label {
  font-size: 13px;
  color: #64748b;
  font-weight: 500;
  flex-shrink: 0;
}

.mobile-info-value {
  font-size: 13px;
  color: #1e293b;
  font-weight: 600;
  text-align: right;
  max-width: 55%;
  word-break: break-word;
}

/* Dates et items éditables */
.mobile-date-editable,
.mobile-item-editable {
  background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  padding: 3px 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
  white-space: nowrap;
}

.mobile-date-editable:active,
.mobile-item-editable:active {
  transform: scale(0.97);
  background: #e2e8f0;
}

/* Lignes de dates compactes */
.mobile-info-row.mobile-date-row {
  padding: 3px 0;
}

.mobile-info-row.mobile-date-row .mobile-info-label {
  font-size: 12px;
}

.mobile-info-row.mobile-date-row .mobile-info-value {
  font-size: 11px;
}

/* Tailles spécifiques par champ (+2px = 15px, +1px = 14px) - réduites */
.mobile-info-row.size-plus2 .mobile-info-label,
.mobile-info-row.size-plus2 .mobile-info-value {
  font-size: 15px;
}

.mobile-info-row.size-plus1 .mobile-info-label,
.mobile-info-row.size-plus1 .mobile-info-value {
  font-size: 14px;
}

/* Texte qui s'adapte si trop long (ex: 2 intervenants) */
.mobile-info-value.shrink-text {
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 60%;
}

@supports (container-type: inline-size) {
  .mobile-info-value.shrink-text {
    font-size: clamp(10px, 4vw, 15px);
  }
}

.mobile-info-value.highlight {
  color: #16a34a;
  font-weight: 700;
}

/* Animation clignotement pour raison attente */
@keyframes blinkRaison {
  0%, 100% { opacity: 1; background: rgba(0,0,0,0.25); }
  50% { opacity: 0.6; background: rgba(255,255,255,0.2); }
}

.mobile-status-raison.blink {
  animation: blinkRaison 1.2s ease-in-out infinite;
}

/* Séparateur de section compact */
.mobile-section-divider {
  height: 1px;
  background: linear-gradient(to right, transparent, #cbd5e1, transparent);
  margin: 4px 0;
}

/* BOUTONS PHOTOS - 3 boutons avec icône caméra */
.mobile-photos-section {
  margin-top: 6px;
}

.mobile-photos-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.mobile-photo-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 10px 6px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border: none;
  border-radius: 6px;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.mobile-photo-btn.has-photo {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
}

.mobile-photo-btn:active {
  transform: scale(0.97);
}

/* Page Notes (droite) */
.mobile-page-notes {
  background: #ffffff;
}

/* Photos 1-6 sur page Notes */
.mobile-notes-photos-row {
  display: grid;
  grid-template-columns: 30px repeat(6, 1fr);
  gap: 4px;
  padding: 8px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
}

.mobile-photo-icon-notes {
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mobile-photo-btn-notes {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px 4px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-radius: 6px;
  color: #fff;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
}

.mobile-photo-btn-notes.has-photo {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
}

.mobile-photo-btn-notes:active {
  transform: scale(0.95);
}

/* Textarea plein écran pour Notes */
.mobile-notes-content-editable {
  width: 100%;
  height: 100%;
  flex: 1;
  padding: 15px;
  border: none;
  background: #ffffff;
  color: #1e293b;
  font-size: 16px;
  box-sizing: border-box;
  font-family: inherit;
  line-height: 1.6;
  overflow-y: auto;
}

.mobile-notes-content-editable:focus {
  outline: none;
}

.mobile-notes-content-editable:empty:before {
  content: 'Cliquez pour ajouter des notes (collez des images!)';
  color: #94a3b8;
  font-style: italic;
}

.mobile-notes-content-editable img {
  max-width: 100%;
  border-radius: 4px;
  cursor: nwse-resize;
}

/* Menu popup photos */
.mobile-photo-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
  padding: 20px;
}

/* ===== SÉLECTEUR D'ITEM MOBILE ===== */
.mobile-item-selector-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
  padding: 20px;
}

.mobile-item-selector {
  background: #fff;
  border-radius: 16px;
  width: 100%;
  max-width: 320px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.mobile-item-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
}

.mobile-item-selector-body {
  padding: 10px;
  max-height: 300px;
  overflow-y: auto;
}

.mobile-item-option {
  padding: 14px 16px;
  font-size: 15px;
  font-weight: 500;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  margin-bottom: 4px;
  color: #1e293b;
  background: #f8fafc;
}

.mobile-item-option:hover,
.mobile-item-option:active {
  background: #f1f5f9;
}

.mobile-item-option.selected {
  background: #dbeafe;
  color: #1e40af;
  font-weight: 600;
}

/* ===== HISTORIQUE DÉPARTEMENTS MOBILE ===== */
.mobile-dept-history-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
  padding: 10px;
}

.mobile-dept-history {
  background: #fff;
  border-radius: 16px;
  width: 100%;
  max-width: 400px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.mobile-dept-history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  color: #fff;
  font-size: 15px;
  font-weight: 700;
}

.mobile-dept-history-body {
  padding: 10px;
  max-height: 60vh;
  overflow-y: auto;
}

.mobile-dept-row {
  background: #f8fafc;
  border-radius: 10px;
  padding: 10px 12px;
  margin-bottom: 8px;
  border-left: 4px solid #cbd5e1;
}

.mobile-dept-row.active {
  background: #dbeafe;
  border-left-color: #3b82f6;
}

.mobile-dept-row.completed {
  background: #dcfce7;
  border-left-color: #22c55e;
}

.mobile-dept-row.current {
  box-shadow: 0 0 0 2px #3b82f6;
}

.mobile-dept-name {
  font-size: 14px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 8px;
}

.mobile-dept-dates {
  display: flex;
  gap: 8px;
  align-items: center;
}

.mobile-dept-date-field {
  flex: 1;
}

.mobile-dept-date-field label {
  display: block;
  font-size: 10px;
  color: #64748b;
  margin-bottom: 2px;
}

.mobile-dept-date-field input {
  width: 100%;
  padding: 6px 4px;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  font-size: 11px;
  box-sizing: border-box;
}

.mobile-dept-jours {
  font-size: 14px;
  font-weight: 700;
  color: #3b82f6;
  min-width: 35px;
  text-align: center;
}

.mobile-dept-history-footer {
  padding: 10px 16px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
}

.mobile-dept-close-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.mobile-photo-menu {
  background: #fff;
  border-radius: 16px;
  width: 100%;
  max-width: 350px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.mobile-photo-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
}

.mobile-photo-menu-content {
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
}

.mobile-photo-menu-field {
  margin-bottom: 15px;
}

.mobile-photo-menu-field label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 6px;
}

.mobile-photo-menu-field input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
}

.mobile-photo-menu-field input:focus {
  outline: none;
  border-color: #3b82f6;
}

.mobile-photo-menu-actions {
  padding: 15px 20px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
}

.mobile-photo-save-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
}

/* Indicateurs swipe */
.mobile-swipe-hint {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 15px;
  color: #94a3b8;
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
  background: rgba(255,255,255,0.9);
  padding: 8px 16px;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: opacity 0.5s;
}

.mobile-swipe-hint-arrow {
  font-size: 18px;
  color: #3b82f6;
}



/* ===== PAGE JOBS EN ATTENTE ===== */
.jobs-page {
  height: calc(100vh - 110px);
  background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
  display: flex;
  flex-direction: column;
}

/* 4 colonnes */
.jobs-columns {
  flex: 1;
  display: flex;
  min-height: 0;
}

.jobs-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-right: 2px solid rgba(255,255,255,0.2);
}

.jobs-col:last-child {
  border-right: none;
}

.jobs-col-title {
  padding: 8px 10px;
  font-size: 12px;
  font-weight: 700;
  color: white;
  background: rgba(0,0,0,0.2);
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.jobs-col-title .count {
  background: rgba(255,255,255,0.3);
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 10px;
  margin-left: 6px;
}

.jobs-col-content {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* ===== CARTE JOB - Compacte pour 4 colonnes ===== */
.job-mini {
  border-radius: 8px;
  padding: 6px 8px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 2px 4px rgba(0,0,0,0.3);
  color: white;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  border: 2px solid #000;
}

.job-mini:hover {
  transform: translateY(-1px);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 4px 10px rgba(0,0,0,0.4);
}

/* Couleurs par région */
.job-mini.region-quebec {
  background: linear-gradient(135deg, #04152c, #4a8ef5);
}
.job-mini.region-canada-anglais {
  background: linear-gradient(135deg, #704414, #E8B97A);
}
.job-mini.region-france {
  background: linear-gradient(135deg, #5c4d00, #f5c800);
}

/* Ligne 1: Région gauche + # commande centré + Rep droite */
.job-mini-row1 {
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  margin-bottom: 2px;
}

.job-mini-order {
  font-size: 12px;
  font-weight: 700;
  text-align: center;
}

/* Pastille région à gauche */
.job-mini-region {
  position: absolute;
  left: 0;
  font-size: 7px;
  font-weight: 600;
  padding: 1px 4px;
  border-radius: 6px;
  background: rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.3);
}

/* Pastille rep à droite */
.job-mini-rep {
  position: absolute;
  right: 0;
  font-size: 7px;
  font-weight: 600;
  padding: 1px 4px;
  border-radius: 6px;
  background: rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.3);
}

/* Ligne 2: Client centré */
.job-mini-row2 {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 2px;
}

.job-mini-client {
  font-size: 9px;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
}

/* Ligne 3: Pastille délai pleine largeur */
.job-mini-days {
  display: block;
  width: 100%;
  font-size: 8px;
  font-weight: 700;
  padding: 2px 4px;
  border-radius: 999px;
  border: 1px solid #000;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  color: white;
  text-align: center;
  box-sizing: border-box;
}

/* Couleurs selon délai */
.job-mini-days.ok { background: rgba(0,0,0,0.2); }
.job-mini-days.warn { background: linear-gradient(135deg, #f59e0b, #d97706); }
.job-mini-days.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
.job-mini-days.critical { 
  background: linear-gradient(135deg, #ef4444, #dc2626);
  animation: pulseRed 2s ease-in-out infinite;
}

/* ===== FICHE JOB ===== */
.job-fiche-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100000;
  padding: 20px 40px;
}

.job-fiche {
  background: #f8fafc;
  border-radius: 12px;
  width: 100%;
  max-width: 1100px;
  height: calc(100vh - 40px);
  display: flex;
  overflow: hidden;
  box-shadow: 0 25px 80px rgba(0,0,0,0.5);
}

/* Header par région - EXACTEMENT comme moulages */
.job-fiche.region-quebec .job-fiche-header {
  background: linear-gradient(to right, #04152c, #4a8ef5);
}
.job-fiche.region-ontario .job-fiche-header {
  background: linear-gradient(to right, #704414, #E8B97A);
}
.job-fiche.region-france .job-fiche-header {
  background: linear-gradient(to right, #5c4d00, #f5c800);
}

.job-fiche-main {
  flex: 0 0 50%;
  max-width: 50%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-right: 1px solid #cbd5e1;
}

.job-fiche-header {
  padding: 8px 24px;
  background: linear-gradient(to right, #04152c, #4a8ef5);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  flex-shrink: 0;
}

.job-fiche-header h2 {
  font-size: 12px;
  margin: 0;
}

.job-fiche-close {
  background: none;
  border: none;
  color: rgba(255,255,255,0.8);
  font-size: 16px;
  cursor: pointer;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.job-fiche-close:hover { color: white; }

.job-fiche-body {
  flex: 1;
  overflow: hidden;
  padding: 12px 24px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.job-fiche-row {
  display: flex;
  gap: 8px;
  min-width: 0;
  flex-shrink: 0;
}

.job-fiche-field {
  flex: 1 1 0;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.job-fiche-field.flex1 { flex: 1 1 0; }
.job-fiche-field.flex3 { flex: 3 1 0; }

.job-fiche-field label {
  font-size: 9px;
  color: #64748b;
  text-transform: uppercase;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.job-fiche-field input,
.job-fiche-field select {
  width: 100%;
  min-width: 0;
  box-sizing: border-box;
  padding: 5px 6px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 11px;
  background: white;
}

.job-fiche-field input:focus,
.job-fiche-field select:focus {
  outline: none;
  border-color: #3b82f6;
}

.job-fiche-section {
  margin-bottom: 8px;
}

.job-fiche-section-title {
  font-size: 9px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  margin-bottom: 6px;
  padding-bottom: 4px;
  border-bottom: 1px solid #e2e8f0;
}

/* Boutons région style EXACTEMENT moulage */
/* Matériau */
.job-fiche-materiau {
  background: linear-gradient(to bottom, #fef3c7, #fde68a);
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #fcd34d;
}

.job-fiche-materiau label { color: #92400e; }

/* Dates */
.job-date-pill {
  width: 100%;
  min-width: 0;
  box-sizing: border-box;
  padding: 6px 8px;
  background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 500;
  color: #334155;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.job-date-pill:hover {
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  border-color: #3b82f6;
}

/* Footer */
.job-fiche-footer {
  padding: 8px 24px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  justify-content: flex-start;
  gap: 8px;
  background: #f8fafc;
  flex-shrink: 0;
}

.job-fiche-btn {
  padding: 6px 14px;
  border: none;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.job-fiche-btn.btn-done {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
}
.job-fiche-btn.btn-done:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

.job-fiche-btn.btn-email {
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  color: #1e40af;
}
.job-fiche-btn.btn-email:hover {
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
}

.job-fiche-btn.btn-delete {
  background: linear-gradient(to bottom, #fecaca, #fca5a5);
  color: #991b1b;
  border: 1px solid #f87171;
}
.job-fiche-btn.btn-delete:hover {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
}

.job-fiche-btn.btn-close {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #475569;
  border: 1px solid #cbd5e1;
}
.job-fiche-btn.btn-close:hover {
  background: linear-gradient(to bottom, #e2e8f0, #cbd5e1);
}

/* Footer avec boutons aux extrémités */
.job-fiche-footer {
  padding: 12px 20px;
  background: #f1f5f9;
  border-top: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
}

/* Zone Notes */
.job-fiche-notes {
  flex: 0 0 50%;
  max-width: 50%;
  background: white;
  display: flex;
  flex-direction: column;
}

.job-notes-header {
  padding: 8px 24px;
  background: linear-gradient(to bottom, #e2e8f0, #cbd5e1);
  font-size: 12px;
  font-weight: 700;
  color: #1e3a5f;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.job-notes-header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Bouton Ajouter lien */
.add-link-btn {
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
  border: 1px solid #1e40af;
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}
.add-link-btn:hover {
  background: linear-gradient(to bottom, #2563eb, #1e40af);
}

/* Popup insertion lien */
.insert-link-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200000;
}
.insert-link-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 12px;
  width: 400px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  z-index: 200001;
  overflow: hidden;
}
.insert-link-header {
  padding: 14px 18px;
  background: linear-gradient(to right, #1e3a5f, #3b82f6);
  color: white;
  font-size: 15px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.insert-link-close {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  opacity: 0.8;
}
.insert-link-close:hover { opacity: 1; }
.insert-link-body {
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.insert-link-field {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.insert-link-field label {
  font-size: 12px;
  font-weight: 600;
  color: #475569;
}
.insert-link-field input {
  padding: 10px 14px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 13px;
}
.insert-link-field input:focus {
  outline: none;
  border-color: #3b82f6;
}
.insert-link-preview {
  padding: 12px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  font-size: 12px;
  color: #475569;
}
.insert-link-btns {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding: 14px 18px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
}
.insert-link-btns button {
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}
.insert-link-btns .btn-cancel {
  background: #e2e8f0;
  color: #475569;
}
.insert-link-btns .btn-insert {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}
.insert-link-btns .btn-insert:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

/* Style des liens insérés dans les notes */
.note-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  border: 1px solid #93c5fd;
  border-radius: 5px;
  color: #1e40af;
  text-decoration: none;
  font-size: 12px;
  margin: 2px 0;
}
.note-link:hover {
  background: linear-gradient(to bottom, #bfdbfe, #93c5fd);
}

.job-notes-close {
  background: none;
  border: none;
  font-size: 18px;
  color: #64748b;
  cursor: pointer;
  padding: 0 4px;
}
.job-notes-close:hover { color: #ef4444; }

.job-notes-photos-btns {
  display: flex;
  gap: 3px;
}

.job-photo-btn {
  width: 20px;
  height: 20px;
  border: 1px solid #94a3b8;
  border-radius: 3px;
  background: white;
  font-size: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.job-photo-btn:hover { border-color: #3b82f6; background: #dbeafe; }
.job-photo-btn.has-link {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  border-color: #15803d;
  color: white;
}

/* Boutons d'action en haut des notes - toute la largeur */
.job-notes-actions {
  display: flex;
  gap: 4px;
  padding: 6px 8px;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border-bottom: 1px solid #cbd5e1;
}

.job-notes-action-btn {
  flex: 1;
  padding: 6px 8px;
  border: none;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 3px;
  white-space: nowrap;
}

.job-notes-action-btn.btn-resolve {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}
.job-notes-action-btn.btn-resolve:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

.job-notes-action-btn.btn-email {
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
}
.job-notes-action-btn.btn-email:hover {
  background: linear-gradient(to bottom, #2563eb, #1e40af);
}

.job-notes-action-btn.btn-print {
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
}
.job-notes-action-btn.btn-print:hover {
  background: linear-gradient(to bottom, #7c3aed, #6d28d9);
}

.job-notes-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: white;
}

/* Zone Questions pour intervenant */
.job-questions-section {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.job-questions-label {
  font-size: 10px;
  font-weight: 700;
  color: #1e40af;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.job-questions-content {
  flex: 1;
  padding: 8px;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  background: white;
  color: #1e293b;
  font-size: 12px;
  line-height: 1.4;
  overflow-y: auto;
  outline: none;
}

.job-questions-content a {
  color: #2563eb;
  text-decoration: underline;
  cursor: pointer;
}

.job-questions-content a:hover {
  color: #1d4ed8;
  background: #dbeafe;
}

.job-questions-content:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.job-questions-content:empty:before {
  content: "Écrire les questions ici... (vous pouvez coller des liens)";
  color: #94a3b8;
}

/* Zone Réponse */
.job-response-section {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.job-response-label {
  font-size: 10px;
  font-weight: 700;
  color: #166534;
  text-transform: uppercase;
  margin-bottom: 4px;
}

.job-response-content {
  flex: 1;
  padding: 8px;
  border: 2px solid #22c55e;
  border-radius: 6px;
  background: #f0fdf4;
  color: #1e293b;
  font-size: 12px;
  line-height: 1.4;
  overflow-y: auto;
  outline: none;
}

.job-response-content a {
  color: #2563eb;
  text-decoration: underline;
  cursor: pointer;
}

.job-response-content a:hover {
  color: #1d4ed8;
  background: #dbeafe;
}

.job-response-content:focus {
  border-color: #16a34a;
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
}

.job-response-content:empty:before {
  content: "Réponse reçue...";
  color: #94a3b8;
}

/* Zone Notes internes */
.job-notes-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 6px 10px;
  overflow: hidden;
}

.job-notes-label {
  font-size: 9px;
  font-weight: 700;
  color: #475569;
  text-transform: uppercase;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.job-notes-content {
  flex: 1;
  padding: 8px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 12px;
  font-family: Arial, sans-serif;
  line-height: 1.6;
  overflow-y: auto;
  background: white !important;
  color: #000 !important;
  min-height: 150px;
  -webkit-text-fill-color: #000;
}

.job-notes-content * {
  color: inherit;
  -webkit-text-fill-color: inherit;
}

.job-notes-content:focus { outline: none; }
.job-notes-content:empty:before { content: attr(placeholder); color: #999 !important; -webkit-text-fill-color: #999; }

/* Images redimensionnables comme Word */
.job-notes-content img { 
  max-width: 100%; 
  border-radius: 4px; 
  margin: 6px 0; 
  cursor: nwse-resize;
  border: 2px solid transparent;
  transition: border-color 0.2s;
}
.job-notes-content img:hover { border-color: #3b82f6; }
.job-notes-content img.resizing { border-color: #22c55e; }

.note-timestamp {
  background: none;
  padding: 2px 0;
  border-radius: 0;
  font-size: 11px;
  color: #1e3a5f;
  margin: 6px 0;
  display: block;
  border-bottom: 1px solid #e0e0e0;
}
.note-timestamp strong { color: #1e3a5f; font-weight: 700; }

/* Menu photo */
.job-photo-menu {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 10px;
  width: 320px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
  z-index: 100001;
  overflow: hidden;
}

.job-photo-menu-header {
  padding: 10px 14px;
  background: linear-gradient(to right, #1e3a5f, #2d5a87);
  color: white;
  font-size: 13px;
  font-weight: 600;
}

.job-photo-menu-body { padding: 14px; }
.job-photo-menu-body input {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #e2e8f0;
  border-radius: 5px;
  font-size: 12px;
}

.job-photo-menu-btns {
  padding: 10px 14px;
  background: #f8fafc;
  display: flex;
  gap: 6px;
  justify-content: flex-end;
  border-top: 1px solid #e2e8f0;
}

.job-photo-menu-btns button {
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  background: #e2e8f0;
  color: #475569;
}

/* Modal ajout */
.job-add-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
  padding: 20px;
}

.job-add-modal {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 520px;
  max-height: 90vh;
  overflow-y: auto;
}

.job-add-header {
  padding: 12px 16px;
  background: linear-gradient(to right, #1e3a5f, #2d5a87);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.job-add-header h3 { margin: 0; font-size: 14px; }

.job-add-header-btns {
  display: flex;
  align-items: center;
  gap: 8px;
}

.job-header-import-btn {
  padding: 5px 10px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}

.job-header-import-btn:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

.job-add-close {
  background: none;
  border: none;
  color: rgba(255,255,255,0.7);
  font-size: 20px;
  cursor: pointer;
}

.job-add-body { padding: 14px; }

.job-add-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.job-add-field { flex: 1; }
.job-add-field label {
  display: block;
  font-size: 10px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 4px;
  text-transform: uppercase;
}

.job-add-field input,
.job-add-field select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #e2e8f0;
  border-radius: 5px;
  font-size: 12px;
}

.job-add-date-pill {
  padding: 8px 10px;
  background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 5px;
  font-size: 12px;
  color: #334155;
  cursor: pointer;
  text-align: center;
}
.job-add-date-pill:hover { border-color: #3b82f6; }

.job-add-footer {
  padding: 12px 16px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.job-add-btn {
  padding: 9px 18px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
}

.job-add-btn.cancel { background: #f1f5f9; color: #64748b; }
.job-add-btn.save { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; }

/* Vide */
.jobs-empty {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255,255,255,0.6);
}

.jobs-empty-icon {
  font-size: 40px;
  margin-bottom: 10px;
}

/* ===== COMMANDES (SÉRIE+) ===== */
.commandes-page {
  height: calc(100vh - 110px);
  background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cmd-page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: linear-gradient(to bottom, #0f2744, #1e3a5f);
  border-bottom: 2px solid #3b82f6;
}

.cmd-page-header h2 {
  margin: 0;
  color: white;
  font-size: 16px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.cmd-add-btn-header {
  padding: 8px 16px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.cmd-add-btn-header:hover {
  background: linear-gradient(to bottom, #4ade80, #22c55e);
}

.commandes-board {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  column-gap: 4px;
  padding: 4px;
  width: 100%;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.cmd-col {
  min-width: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  gap: 2px;
}

.cmd-header {
  position: relative;
  border-radius: 18px;
  padding: 6px 28px 6px 12px;
  text-align: center;
  font-weight: 700;
  font-size: 10px;
  color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  box-shadow: 0 2px 3px rgba(0,0,0,0.8);
  border: 1px solid rgba(0,0,0,0.8);
}

.cmd-header .cmd-count {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 22px;
  padding: 0 6px;
  border-radius: 0 17px 17px 0;
  background: rgba(255,255,255,0.2);
  font-size: 13px;
  font-weight: 700;
}

/* Headers par client - glassmorphism */
.cmd-header.client-vermeiren {
  background: linear-gradient(135deg, 
    rgba(34, 197, 94, 0.58) 0%, 
    rgba(22, 101, 52, 0.58) 50%, 
    rgba(34, 197, 94, 0.58) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
}
.cmd-header.client-hme {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
}
.cmd-header.client-c1south {
  background: linear-gradient(135deg, 
    rgba(139, 92, 246, 0.58) 0%, 
    rgba(76, 29, 149, 0.58) 50%, 
    rgba(139, 92, 246, 0.58) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
}
.cmd-header.client-cubro {
  background: linear-gradient(to bottom, #0e7490 0%, #67e8f9 100%);
}
.cmd-header.client-france {
  background: linear-gradient(135deg, 
    rgba(250, 204, 21, 0.80) 0%, 
    rgba(202, 138, 4, 0.80) 50%, 
    rgba(250, 204, 21, 0.80) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
}

.cmd-col-content {
  flex: 1;
  overflow-y: auto;
  padding: 2px;
}

/* Cartes commandes - Style IDENTIQUE à l'ancien fichier (mcard) */
.cmd-card {
  position: relative;
  margin: 2px 3px;
  padding: 6px 8px 3px 8px;
  border-radius: 10px;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  border: 2px solid #000;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #fff;
  font-size: 8px;
  overflow: visible;
}

.cmd-card-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 1px;
}

.cmd-card-info {
  width: 100%;
  text-align: center;
}

.cmd-card-title-line {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Nom du client - coloré selon le client */
.cmd-card-client {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  cursor: pointer;
  text-align: center;
  padding: 2px 4px;
  border-radius: 4px;
}
.cmd-card-client:hover { background: rgba(255,255,255,0.2); }

/* Couleurs client */
.cmd-card.client-vermeiren .cmd-card-client { color: #4ade80; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
.cmd-card.client-hme .cmd-card-client { color: #E8B97A; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
.cmd-card.client-c1south .cmd-card-client { color: #a78bfa; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
.cmd-card.client-cubro .cmd-card-client { color: #67e8f9; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }
.cmd-card.client-france .cmd-card-client { color: #facc15; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; }

/* Ligne numéro de commande */
.cmd-card-order-line {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #fff;
  position: relative;
  width: 100%;
  height: 22px;
  padding: 0 45px;
  box-sizing: border-box;
}

/* Input numéro de commande */
.cmd-card-order {
  cursor: text;
  border: none;
  background: transparent;
  color: #fff;
  font-size: 15px;
  font-family: inherit;
  font-weight: 600;
  padding: 0;
  width: 65px;
  outline: none;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  text-align: center;
}
.cmd-card-order:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

/* Bouton Fiche à droite du numéro */
.cmd-card-fiche-btn {
  position: absolute;
  right: 3px;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  border: 1px solid rgba(0,0,0,0.5);
  border-radius: 999px;
  padding: 3px 8px;
  font-size: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
  text-align: center;
  z-index: 10;
  color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}
.cmd-card-fiche-btn:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.2);
}

/* Séparateur */
.cmd-card-separator {
  height: 1px;
  background: rgba(255,255,255,0.25);
  margin: 1px -8px 1px -8px;
}

/* Pastille délai - pleine largeur */
.cmd-card-delay {
  width: 100%;
  padding: 1px 4px;
  font-size: 8px;
  font-weight: 700;
  border-radius: 999px;
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #000;
  margin-top: 0px;
  margin-bottom: 2px;
  box-sizing: border-box;
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Couleurs délai */
.cmd-card-delay.delai-vert {
  background: linear-gradient(to bottom, #22c55e, #15803d) !important;
  color: white !important;
}
.cmd-card-delay.delai-jaune {
  background: linear-gradient(to bottom, #facc15, #d97706) !important;
  color: #000 !important;
  text-shadow: none !important;
}
.cmd-card-delay.delai-rouge {
  background: linear-gradient(to bottom, #ef4444, #dc2626) !important;
  color: white !important;
}
.cmd-card-delay.delai-retard {
  background: linear-gradient(to bottom, #dc2626, #7f1d1d) !important;
  color: white !important;
  animation: pulse-retard-delai 0.8s infinite !important;
}

/* Boutons carte - pleine largeur avec coins arrondis */
.cmd-card-footer {
  display: flex;
  gap: 4px;
  margin-top: 1px;
}

.cmd-card-btn {
  flex: 1;
  padding: 1px 4px;
  font-size: 8px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid #000;
  cursor: pointer;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
  line-height: 1;
  white-space: nowrap;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.cmd-card-btn:hover { filter: brightness(1.1); }

.cmd-card-btn.btn-move {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

.cmd-card-btn.btn-delete {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

/* Fiche Commande Overlay */
.cmd-fiche-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 10000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.cmd-fiche-overlay.active { display: flex; }

.cmd-fiche-container {
  background: white;
  border-radius: 12px;
  width: calc(100vw - 200px);
  max-width: 1100px;
  height: calc(100vh - 40px);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.cmd-fiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 5px 12px;
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  border-bottom: 2px solid #3b82f6;
}

.cmd-fiche-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cmd-fiche-logo img {
  height: 22px;
}

.cmd-fiche-title {
  color: white;
  font-size: 13px;
  font-weight: 700;
}

.cmd-fiche-tabs {
  display: flex;
  gap: 4px;
}

.cmd-fiche-tab {
  padding: 4px 12px;
  font-size: 10px;
  font-weight: 700;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.cmd-fiche-tab.tab-info {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
}
.cmd-fiche-tab.tab-info.active {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.cmd-fiche-tab.tab-tableau {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  color: white;
}
.cmd-fiche-tab.tab-tableau.active {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.cmd-fiche-close {
  width: 24px;
  height: 24px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  border-radius: 4px;
  color: white;
  font-size: 14px;
  cursor: pointer;
}

.cmd-fiche-body {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Vue Info/Magasin */
.cmd-view-info {
  display: none;
  flex: 1;
  overflow: hidden;
}
.cmd-view-info.active { display: flex; }

.cmd-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cmd-panel-info {
  border-right: 2px solid #1e3a5f;
  margin: 8px 0 8px 10px;
}

.cmd-panel-magasin {
  margin: 8px 10px 8px 0;
}

/* ===== SYSTÈME DE MATÉRIAUX ===== */

/* Total Matériaux en haut de Magasin */
.cmd-materiaux-total-section-top {
  padding: 8px 10px;
  background: linear-gradient(to bottom, #ffffff, #f8fafc);
  border-bottom: 2px solid #3b82f6;
  max-height: 120px;
  overflow-y: auto;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total {
  background: transparent;
  border: none;
  padding: 0;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-header {
  color: #1e3a5f;
  font-size: 10px;
  font-weight: 700;
  margin-bottom: 4px;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-item {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  padding: 2px 6px;
  margin-bottom: 2px;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-item .code,
.cmd-materiaux-total-section-top .cmd-materiaux-total-item .name {
  color: #374151;
}

.cmd-materiaux-total-section-top .cmd-materiaux-total-item .qty {
  color: #1e3a5f;
  font-weight: 700;
}

/* Container grille matériaux */
.cmd-materiaux-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 4px;
  background: transparent;
  padding: 0;
  margin: 0;
  align-items: stretch;
  max-width: 100%;
  overflow: hidden;
}

.cmd-materiaux-column {
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 3px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cmd-materiaux-header {
  font-size: 9px;
  font-weight: 700;
  color: white;
  text-align: center;
  padding: 2px 4px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  border-radius: 3px;
  margin-bottom: 2px;
}

.cmd-materiaux-list {
  font-size: 9px;
  color: #374151;
  line-height: 1.2;
  flex: 1;
}

/* Grille matériaux: Code | Matériau+Épaisseur | Qté */
.cmd-materiaux-item {
  display: grid;
  grid-template-columns: 40px 1fr 22px;
  gap: 2px;
  padding: 1px 0;
  border-bottom: 1px dotted #e5e7eb;
  align-items: center;
}

.cmd-materiaux-item:last-child {
  border-bottom: none;
}

.cmd-materiaux-code {
  font-size: 9px;
  font-weight: 700;
  color: #4b5563;
  text-align: left;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cmd-materiaux-name {
  font-size: 9px;
  font-weight: 500;
  color: #1f2937;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 2px;
}

.cmd-materiaux-qty {
  font-size: 12px;
  font-weight: 700;
  color: #059669;
  text-align: right;
}

/* Section Total Matériaux */
.cmd-materiaux-total {
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  border: 1px solid #3b82f6;
  border-radius: 3px;
  padding: 3px 4px;
  margin: 0;
  max-height: 120px;
  overflow-y: auto;
  overflow-x: hidden;
}

.cmd-materiaux-total-header {
  font-size: 10px;
  font-weight: 700;
  color: #1e40af;
  text-align: center;
  margin-bottom: 2px;
  padding-bottom: 2px;
  border-bottom: 1px solid #3b82f6;
  position: sticky;
  top: 0;
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
}

.cmd-materiaux-total-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 2px 4px;
}

.cmd-materiaux-total-item {
  display: grid;
  grid-template-columns: 35px 1fr 20px;
  gap: 2px;
  align-items: center;
  padding: 2px 3px;
  background: white;
  border-radius: 2px;
  font-size: 9px;
  line-height: 1.2;
}

.cmd-materiaux-total-item .code {
  font-weight: 700;
  color: #1e40af;
  font-size: 9px;
}

.cmd-materiaux-total-item .name {
  font-weight: 500;
  color: #374151;
  font-size: 9px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cmd-materiaux-total-item .qty {
  font-weight: 700;
  color: #059669;
  font-size: 10px;
  text-align: right;
}

/* Bouton gérer recettes */
.cmd-recettes-btn {
  font-size: 8px;
  padding: 3px 8px;
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
}

.cmd-recettes-btn:hover {
  background: linear-gradient(to bottom, #a78bfa, #8b5cf6);
}

.cmd-panel-header {
  padding: 6px 10px;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  border-bottom: 1px solid #cbd5e1;
  font-size: 11px;
  font-weight: 700;
  color: #1e3a5f;
}

.cmd-panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px 10px;
}

.cmd-info-row {
  display: flex;
  gap: 8px;
  margin-bottom: 6px;
}

.cmd-info-field {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.cmd-info-field label {
  font-size: 9px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
}

.cmd-info-field input,
.cmd-info-field select {
  padding: 4px 8px;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  font-size: 11px;
  background: #f8fafc;
  height: 26px;
}

.cmd-info-field input:focus,
.cmd-info-field select:focus {
  border-color: #3b82f6;
  outline: none;
  background: white;
}

.cmd-date-pill {
  padding: 4px 8px;
  background: #dbeafe;
  border: 1px solid #93c5fd;
  border-radius: 4px;
  font-size: 10px;
  color: #1e40af;
  text-align: center;
  cursor: pointer;
  font-weight: 500;
}

.cmd-date-pill:hover {
  background: #bfdbfe;
}

/* Délai compact */
.cmd-delai-big {
  padding: 8px 12px;
  border-radius: 8px;
  text-align: center;
  margin-top: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.cmd-delai-big.delai-vert {
  background: linear-gradient(135deg, #22c55e, #15803d);
  color: white;
}
.cmd-delai-big.delai-jaune {
  background: linear-gradient(135deg, #fbbf24, #d97706);
  color: #451a03;
}
.cmd-delai-big.delai-rouge {
  background: linear-gradient(135deg, #f87171, #dc2626);
  color: white;
}
.cmd-delai-big.delai-retard {
  background: linear-gradient(135deg, #dc2626, #7f1d1d);
  color: white;
  animation: blinkCmdRetard 0.8s infinite;
}

.cmd-delai-big-jours {
  font-size: 28px;
  font-weight: 900;
  line-height: 1;
}

.cmd-delai-big-label {
  font-size: 12px;
  font-weight: 700;
}

.cmd-delai-big-date {
  font-size: 10px;
  opacity: 0.9;
}

/* Vue Tableau - 3 sections */
.cmd-view-tableau {
  display: none;
  flex: 1;
  overflow: hidden;
  flex-direction: column;
  padding: 0;
  margin: 0;
  margin-top: -1px;
}
.cmd-view-tableau.active { display: flex; }

.cmd-tableau-body {
  flex: 1;
  overflow: auto;
  padding: 0;
  margin: 0;
  background: #fff;
}

.cmd-add-item-btn {
  padding: 8px 16px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}

.cmd-remove-item-btn {
  padding: 4px 8px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
}

/* Notes commande */
.cmd-notes-section {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e2e8f0;
}

.cmd-notes-section label {
  font-size: 9px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
  display: block;
  margin-bottom: 3px;
}

.cmd-notes-content {
  min-height: 50px;
  max-height: 80px;
  overflow-y: auto;
  padding: 6px 8px;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  font-size: 11px;
  line-height: 1.4;
  background: #f8fafc;
}

.cmd-notes-content:focus {
  border-color: #3b82f6;
  outline: none;
  background: white;
}

/* Footer fiche */
.cmd-fiche-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 12px 20px;
  background: #f8fafc;
  border-top: 2px solid #e2e8f0;
}

.cmd-fiche-btn {
  padding: 10px 25px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
}

.cmd-fiche-btn.btn-save {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.cmd-fiche-btn.btn-close {
  background: #e2e8f0;
  color: #475569;
}

/* Modal ajout commande */
.cmd-add-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 200000;
}

.cmd-add-modal.active { display: flex; }

.cmd-add-content {
  background: white;
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.cmd-add-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e2e8f0;
}

.cmd-add-header h3 {
  margin: 0;
  font-size: 18px;
  color: #1e3a5f;
}

.cmd-add-close {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: #64748b;
  line-height: 1;
}

.cmd-add-fields {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 20px;
}

.cmd-add-field {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.cmd-add-field.full { grid-column: span 2; }

.cmd-add-field label {
  font-size: 11px;
  font-weight: 600;
  color: #64748b;
  text-transform: uppercase;
}

.cmd-add-field input,
.cmd-add-field select {
  padding: 10px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  font-size: 13px;
}

.cmd-add-field input:focus,
.cmd-add-field select:focus {
  border-color: #3b82f6;
  outline: none;
}

.cmd-add-btns {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.cmd-add-btn {
  padding: 12px 25px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

.cmd-add-btn.cancel { 
  background: #e2e8f0; 
  color: #475569; 
}

.cmd-add-btn.save { 
  background: linear-gradient(to bottom, #22c55e, #16a34a); 
  color: white; 
}

/* ===== TABLEAU 3 SECTIONS (ATELIER | COUTURE | INSPECTION) ===== */

.cmd-table-container {
  width: 100%;
  overflow-x: auto;
  padding: 2px;
}

.cmd-items-table {
  width: 100%;
  min-width: 700px;
  border-collapse: collapse;
  border-spacing: 0;
  font-size: 9px;
  table-layout: fixed;
}

/* En-têtes de sections (Atelier, Couture, Inspection) - COMPACT */
.cmd-items-table th.section-header {
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 4px;
  text-align: center;
  height: 16px;
}

.cmd-items-table th.section-header.atelier {
  border-right: 3px solid #1e3a5f;
}

.cmd-items-table th.section-header.couture {
  border-right: 3px solid #1e3a5f;
}

/* En-têtes de colonnes */
.cmd-items-table th.cmd-col-header {
  background: #e2e8f0;
  color: #1f2937;
  font-size: 9px;
  font-weight: 700;
  padding: 0;
  text-align: center;
  white-space: nowrap;
  height: 14px;
  line-height: 14px;
}

/* Largeurs des colonnes - OPTIMISÉES pour Employé */
.cmd-items-table .cmd-col-plus { width: 10px; }
.cmd-items-table .cmd-col-item { width: 42px; }
.cmd-items-table .cmd-col-qty { width: 18px; }
.cmd-items-table .cmd-col-total { width: 24px; }
.cmd-items-table .cmd-col-status { width: 38px; }
.cmd-items-table .cmd-col-emp { width: 62px; }
.cmd-items-table .cmd-col-notes { width: 28px; }
.cmd-items-table .cmd-col-exped { width: 90px; }
.cmd-items-table .cmd-col-x { width: 14px; text-align: center; }

.cmd-items-table th.cmd-col-header.border-right,
.cmd-items-table td.border-right {
  border-right: 3px solid #1e3a5f;
}

/* Bordures PLEINES entre sections */
.cmd-items-table th.cmd-col-header.border-right-solid,
.cmd-items-table td.border-right-solid {
  border-right: 3px solid #1e3a5f !important;
}

/* Cellules du tableau */
.cmd-items-table td {
  padding: 1px;
  text-align: center;
  vertical-align: middle;
  height: 14px;
}

/* Ligne d'item */
.cmd-items-table tr.item-row td {
  background: transparent;
  height: 16px;
}

/* Ligne de grandeur */
.cmd-items-table tr.grandeur-row td {
  background: white;
  height: 14px;
}

.cmd-items-table tr.grandeur-row:hover td {
  background: #f8fafc;
}

/* ========================================
   PASTILLES COMPACTES - TOUTES 12px HAUTEUR
   LARGEURS FIXES IDENTIQUES
   ======================================== */

/* Bouton + Item dans le header - VERT */
.cmd-table-add-item-green {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 2px;
  width: 100%;
  height: 12px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

.cmd-table-add-item-green:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

/* Bouton + Item dans le header (ancien bleu) */
.cmd-table-add-item {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 2px;
  width: 18px;
  height: 12px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

/* Bouton + Grandeur */
.cmd-table-add-grandeur {
  width: 12px;
  height: 12px;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 2px;
  font-size: 8px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

/* Bouton supprimer */
.cmd-table-delete {
  width: 12px;
  height: 12px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  line-height: 10px;
}

/* Pastille Item (bleue foncée) - LARGEUR FIXE 55px */
.cmd-table-item-pill {
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 8px;
  font-weight: 600;
  cursor: pointer;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

/* Pastille Grandeur - BLANC avec texte noir */
.cmd-table-grandeur-pill {
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 8px;
  font-weight: 600;
  cursor: pointer;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Quantité totale item - BLANC avec texte noir */
.cmd-table-item-qty {
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 9px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  line-height: 12px;
  box-sizing: border-box;
}

/* Nom item readonly */
.cmd-table-item-name {
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

/* Grandeur readonly - BLANC avec texte noir */
.cmd-table-grandeur-readonly {
  font-size: 8px;
  font-weight: 600;
  color: #1f2937;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Quantité readonly - BLANC */
.cmd-table-qty-readonly {
  font-size: 9px;
  font-weight: 600;
  color: #1f2937;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 12px;
  box-sizing: border-box;
}

/* Input quantité - SANS FLECHES */
.cmd-table-qty-input {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 9px;
  font-weight: 600;
  padding: 0;
  -moz-appearance: textfield;
  line-height: 10px;
  box-sizing: border-box;
}

.cmd-table-qty-input::-webkit-outer-spin-button,
.cmd-table-qty-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Input fait (x/y) - BOUTON CLIQUABLE */
.cmd-table-fait-btn {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 8px;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  cursor: pointer;
}

.cmd-table-fait-btn:hover {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
}

/* Container fraction éditable X/Y */
.cmd-table-fait-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 12px;
  width: 100%;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  box-sizing: border-box;
}

.cmd-table-fait-input-top {
  width: 14px;
  height: 10px;
  border: none;
  background: transparent;
  text-align: center;
  font-size: 8px;
  font-weight: 600;
  padding: 0;
  -moz-appearance: textfield;
  outline: none;
}

.cmd-table-fait-input-top::-webkit-outer-spin-button,
.cmd-table-fait-input-top::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.cmd-table-fait-input-top:focus {
  background: #e0f2fe;
}

.cmd-table-fait-separator {
  font-size: 8px;
  color: #6b7280;
  margin: 0 1px;
}

.cmd-table-fait-total {
  font-size: 8px;
  color: #6b7280;
}

/* Input fait (x/y) - ancien style */
.cmd-table-fait-input {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 7px;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
}

/* Pastille Status */
.cmd-table-status {
  height: 14px;
  width: 100%;
  border-radius: 3px;
  font-size: 8px;
  font-weight: 700;
  color: white;
  border: none;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 14px;
  box-sizing: border-box;
}

.cmd-table-status.todo {
  background: linear-gradient(to bottom, #ff4444, #cc0000);
}

.cmd-table-status.partial {
  background: linear-gradient(to bottom, #ffaa00, #ff8800);
}

.cmd-table-status.done {
  background: linear-gradient(to bottom, #00dd00, #00aa00);
}

/* Pastille Employe */
.cmd-table-emp {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Select Employé - Menu déroulant */
.cmd-table-emp-select {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  box-sizing: border-box;
  text-align: center;
  font-weight: 600;
}

.cmd-table-emp-select:focus {
  outline: none;
  border-color: #3b82f6;
}

/* Pastille Notes */
.cmd-table-notes {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  line-height: 14px;
  box-sizing: border-box;
}

.cmd-table-notes.has-note {
  background: linear-gradient(to bottom, #fef3c7, #fde68a);
  border-color: #f59e0b;
  color: #92400e;
}

/* Pastille Expédition - même style que les autres pastilles */
.cmd-table-exped {
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 7px;
  cursor: pointer;
  padding: 0 2px;
  line-height: 14px;
  box-sizing: border-box;
  border: 1px solid #cbd5e1;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Select Expédition - Menu déroulant */
.cmd-table-exped-select {
  border-radius: 3px;
  height: 14px;
  width: 100%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  box-sizing: border-box;
  border: 1px solid #cbd5e1;
  font-weight: 600;
  text-align: center;
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
}

.cmd-table-exped-select:focus {
  outline: none;
  border-color: #3b82f6;
}

.cmd-table-exped-select.blink-green {
  animation: blinkGreenSelect 1s infinite;
}

.cmd-table-exped-select.yellow-bg {
  background: linear-gradient(to bottom, #facc15, #eab308) !important;
  color: #713f12 !important;
  border-color: #ca8a04;
}

.cmd-table-exped-select.expedie {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border-color: #15803d;
}

@keyframes blinkGreenSelect {
  0%, 100% { 
    background: linear-gradient(to bottom, #22c55e, #16a34a);
    color: white;
    border-color: #15803d;
  }
  50% { 
    background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
    color: #166534;
    border-color: #22c55e;
  }
}

.cmd-table-exped.attente {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
}

.cmd-table-exped.pret {
  background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
  color: #166534;
  font-weight: 600;
}

.cmd-table-exped.blink-green {
  animation: blinkGreenExped 1s infinite;
}

.cmd-table-exped.yellow-bg {
  background: linear-gradient(to bottom, #facc15, #eab308) !important;
  color: #713f12 !important;
  font-weight: 700;
}

.cmd-table-exped.expedie {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

@keyframes blinkGreenExped {
  0%, 100% { 
    background: linear-gradient(to bottom, #22c55e, #16a34a);
    color: white;
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
  }
  50% { 
    background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
    color: #166534;
    box-shadow: none;
  }
}

/* Bouton supprimer */
.cmd-table-delete-text {
  font-size: 12px;
  font-weight: 700;
  color: #374151;
  cursor: pointer;
  line-height: 12px;
  display: block;
  text-align: center;
}

.cmd-table-delete-text:hover {
  color: #ef4444;
}

/* Colonne X à droite */
.cmd-items-table td.cmd-col-x {
  text-align: right;
  padding-right: 2px !important;
  min-width: 4px !important;
  max-width: 4px !important;
  padding: 0 !important;
  overflow: visible;
}

/* Items list container - plus de hauteur avant scroll */
.cmd-items-list {
  height: 100%;
  overflow-x: auto;
  overflow-y: auto;
}

/* Bouton X supprimer item */
.cmd-item-delete-btn {
  width: 14px;
  height: 14px;
  padding: 0;
  font-size: 9px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Pastille Item - bleue - RAPETISSÉE */
.cmd-item-pill {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.cmd-item-pill:hover {
  background: linear-gradient(to bottom, #4a7fc9, #2a4670);
}

.cmd-item-pill-readonly {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

/* Menu sélection Item/Grandeur */
.cmd-select-menu {
  position: fixed;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 6px;
  min-width: 120px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 20000;
}

.cmd-select-menu .cmd-select-title {
  font-size: 9px;
  font-weight: 700;
  color: #374151;
  padding: 4px 6px;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 4px;
}

.cmd-select-menu .cmd-select-option {
  display: block;
  width: 100%;
  padding: 5px 8px;
  font-size: 8px;
  text-align: left;
  background: #f8fafc;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin-bottom: 2px;
}
.cmd-select-menu .cmd-select-option:hover {
  background: #3b82f6;
  color: white;
}

/* Popup notes mini */
.cmd-mini-note-popup {
  position: fixed;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 8px;
  width: 180px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 20000;
}

.cmd-mini-note-popup textarea,
.cmd-mini-note-popup input {
  width: 100%;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 6px;
  box-sizing: border-box;
}

.cmd-mini-note-popup textarea { height: 50px; resize: none; }

.cmd-mini-note-popup .mini-note-btns {
  display: flex;
  gap: 4px;
  margin-top: 6px;
  justify-content: flex-end;
}

.cmd-mini-note-popup button {
  padding: 4px 10px;
  font-size: 9px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.cmd-mini-note-popup .save-btn { background: #10b981; color: white; }
.cmd-mini-note-popup .close-btn { background: #6b7280; color: white; }

  </style>
</head>
<body>

<div class="app-root">
  <header class="topbar">
    <div class="tb-left">
      <div class="logo-flip-container" id="logoFlipContainer">
        <div class="logo-main">
          <div class="logo-top-fixed">
            <img src="https://raw.githubusercontent.com/Physipro-list/Physipro-serie/main/logo-physiprodemi1.png" alt="PhysiPro"/>
          </div>
          <div class="logo-bottom-text" id="logoBottomText">Moulage</div>
        </div>
        <div class="logo-menu" id="logoMenu">
          <div class="logo-menu-item" onclick="switchToPage('serie')">Série+</div>
          <div class="logo-menu-item" onclick="switchToPage('inventaire')">Inventaire</div>
          <div class="logo-menu-item" onclick="switchToPage('jobs')">Job en attente</div>
        </div>
      </div>
    </div>
    
    <div class="tb-center">
      <span class="top-title" id="pageMainTitle">Outil de gestion des moulages</span>
      <button class="settings-btn" id="btnSettings" title="Parametres">⚙️</button>
    </div>
    
    <div class="tb-right">
      <button class="header-btn" id="btnAddItem" onclick="handleAddButton()">+ Ajouter moulage</button>
      <div class="user-status" id="userStatus">
        <span class="status-dot"></span>
        <span class="user-name">Non connecte</span>
      </div>
    </div>
    
    <div class="search-row" id="searchRow">
      <div class="search-box">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Rechercher (nom, commande, client...)">
        <button class="search-clear hidden" id="searchClear">&#10005;</button>
      </div>
    </div>
  </header>
  
  <div class="page active" id="pageMoulages">
    <div class="board-wrapper">
      <div class="board" id="boardMoulages">
        <div class="col"><div class="col-header clickable" onclick="toggleRobotView()" title="Cliquer pour vue tableau"><span class="col-icon">⚙️</span><span class="col-title">Robot</span><span class="col-count" id="countRobot">0</span></div><div class="col-content" id="colRobot"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🪚</span><span class="col-title">Dégauchage</span><span class="col-count" id="countDégauchage">0</span></div><div class="col-content" id="colDégauchage"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">♿</span><span class="col-title">Essayage</span><span class="col-count" id="countEssayage">0</span></div><div class="col-content" id="colEssayage"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🔨</span><span class="col-title">Atelier</span><span class="col-count" id="countAtelier">0</span></div><div class="col-content" id="colAtelier"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🧵</span><span class="col-title">Couture</span><span class="col-count" id="countCouture">0</span></div><div class="col-content" id="colCouture"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🎨</span><span class="col-title">Peinture</span><span class="col-count" id="countPeinture">0</span></div><div class="col-content" id="colPeinture"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🚚</span><span class="col-title">Expédition</span><span class="col-count" id="countExpedition">0</span></div><div class="col-content" id="colExpedition"></div></div>
        <div class="col"><div class="col-header en-attente"><span class="col-icon">⏳</span><span class="col-title">En attente</span><span class="col-count" id="countAttente">0</span></div><div class="col-content" id="colAttente"></div></div>
      </div>
    </div>
    
    <!-- Vue Robot Horizontale (en dehors du board-wrapper) -->
    <div id="robotHorizontalView" class="robot-horizontal-container">
      <div class="robot-horizontal-header">
        <h2>📊 Robot - Vue Tableau</h2>
        <div style="display:flex;gap:10px;">
          <button class="header-btn" onclick="showAddMoulageModal()" style="background:linear-gradient(to bottom,#22c55e,#16a34a);padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;">+ Ajouter</button>
          <button class="header-btn" onclick="toggleRobotView()" style="background:linear-gradient(to bottom,#3b82f6,#1e40af);padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;">← Kanban</button>
        </div>
      </div>
      <div class="robot-horizontal-scroll" id="robotScrollContainer">
        <table class="robot-horizontal-table" id="robotTable">
          <thead>
            <tr>
              <th style="width:100px">Nom<div class="resize-handle"></div></th>
              <th style="width:90px"># Commande<div class="resize-handle"></div></th>
              <th style="width:90px"># Soumission<div class="resize-handle"></div></th>
              <th style="width:80px"># PO<div class="resize-handle"></div></th>
              <th style="width:90px">Client<div class="resize-handle"></div></th>
              <th style="width:90px">Priorité<div class="resize-handle"></div></th>
              <th style="width:50px">Rang<div class="resize-handle"></div></th>
              <th style="width:70px">Région<div class="resize-handle"></div></th>
              <th style="width:80px">Item<div class="resize-handle"></div></th>
              <th style="width:85px">Reçue<div class="resize-handle"></div></th>
              <th style="width:85px">Livraison<div class="resize-handle"></div></th>
              <th style="width:85px">Essayage<div class="resize-handle"></div></th>
              <th style="width:90px">Représent.<div class="resize-handle"></div></th>
              <th style="width:50px">File<div class="resize-handle"></div></th>
              <th style="width:50px">Angle<div class="resize-handle"></div></th>
              <th style="width:50px">RUSH<div class="resize-handle"></div></th>
              <th style="width:40px">Notes</th>
            </tr>
          </thead>
          <tbody id="robotTableBody"></tbody>
        </table>
      </div>
      <!-- Slider de redimensionnement vertical -->
      <div class="robot-resize-bar" id="robotResizeBar">
        <div class="robot-resize-grip">⋯</div>
      </div>
    </div>
  </div>
  
  <!-- Page Série (Commandes) -->
  <div class="page" id="pageSerie">
    <div class="commandes-page">
      <div class="commandes-board" id="commandesBoard">
        <div class="cmd-col" data-client="Vermeiren">
          <div class="cmd-header client-vermeiren">🟢 Vermeiren <span class="cmd-count" id="countVermeiren">0</span></div>
          <div class="cmd-col-content" id="colVermeiren"></div>
        </div>
        <div class="cmd-col" data-client="HME">
          <div class="cmd-header client-hme">🟤 HME <span class="cmd-count" id="countHME">0</span></div>
          <div class="cmd-col-content" id="colHME"></div>
        </div>
        <div class="cmd-col" data-client="C1SOUTH">
          <div class="cmd-header client-c1south">🟣 C1SOUTH <span class="cmd-count" id="countC1SOUTH">0</span></div>
          <div class="cmd-col-content" id="colC1SOUTH"></div>
        </div>
        <div class="cmd-col" data-client="Cubro">
          <div class="cmd-header client-cubro">🔵 Cubro <span class="cmd-count" id="countCubro">0</span></div>
          <div class="cmd-col-content" id="colCubro"></div>
        </div>
        <div class="cmd-col" data-client="France">
          <div class="cmd-header client-france">🟡 France <span class="cmd-count" id="countFrance">0</span></div>
          <div class="cmd-col-content" id="colFrance"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Fiche Commande Overlay -->
  <div class="cmd-fiche-overlay" id="cmdFicheOverlay">
    <div class="cmd-fiche-container" id="cmdFicheContent">
      <!-- Généré dynamiquement -->
    </div>
  </div>
  
  <!-- Modal Ajout Commande -->
  <div class="cmd-add-modal" id="cmdAddModal">
    <div class="cmd-add-content">
      <div class="cmd-add-header">
        <h3>➕ Nouvelle commande</h3>
        <button class="cmd-add-close" onclick="closeCmdAddModal()">×</button>
      </div>
      <div class="cmd-add-fields">
        <div class="cmd-add-field">
          <label>Client</label>
          <select id="cmdAddClient">
            <option value="Vermeiren">Vermeiren</option>
            <option value="HME">HME</option>
            <option value="C1SOUTH">C1SOUTH</option>
            <option value="Cubro">Cubro</option>
            <option value="France">France</option>
          </select>
        </div>
        <div class="cmd-add-field">
          <label>N° Commande</label>
          <input type="text" id="cmdAddOrder" placeholder="000000" maxlength="10">
        </div>
        <div class="cmd-add-field full">
          <label>Description</label>
          <input type="text" id="cmdAddDesc" placeholder="Description de la commande...">
        </div>
        <div class="cmd-add-field">
          <label>Date livraison</label>
          <input type="date" id="cmdAddDateLivraison">
        </div>
        <div class="cmd-add-field">
          <label>N° PO</label>
          <input type="text" id="cmdAddPO" placeholder="Numéro PO...">
        </div>
      </div>
      <div class="cmd-add-btns">
        <button class="cmd-add-btn cancel" onclick="closeCmdAddModal()">Annuler</button>
        <button class="cmd-add-btn save" onclick="confirmAddCommande()">Ajouter</button>
      </div>
    </div>
  </div>
  
  <!-- Page Inventaire -->
  <div class="page" id="pageInventaire">
    <div class="inventaire-page">
      <!-- Grande rangée horizontale EN HAUT - À FAIRE -->
      <div class="inv-row-large">
        <div class="inv-row-large-header">📦 À faire</div>
        <div class="inv-row-large-content" id="invRowMain" data-rang="main" data-pos="0">
          <!-- Cubes générés par JavaScript -->
        </div>
      </div>
      
      <!-- Rangée Pablo -->
      <div class="inv-row-small">
        <div class="inv-row-header-numbered">
          <div class="inv-col-numbers">
            <div class="inv-col-num">5</div>
            <div class="inv-col-num">4</div>
            <div class="inv-col-num">3</div>
            <div class="inv-col-num">2</div>
            <div class="inv-col-num">1</div>
          </div>
          <div class="inv-col-name">
            <span class="inv-col-name-text">Pablo</span>
            <span class="inv-col-name-status" id="invStatusPablo"></span>
          </div>
        </div>
        <div class="inv-row-body">
          <div class="inv-cols-content">
            <div class="inv-col-slot" id="invSlotPablo5" data-rang="pablo" data-pos="5"></div>
            <div class="inv-col-slot" id="invSlotPablo4" data-rang="pablo" data-pos="4"></div>
            <div class="inv-col-slot" id="invSlotPablo3" data-rang="pablo" data-pos="3"></div>
            <div class="inv-col-slot" id="invSlotPablo2" data-rang="pablo" data-pos="2"></div>
            <div class="inv-col-slot" id="invSlotPablo1" data-rang="pablo" data-pos="1"></div>
          </div>
          <div class="inv-col-zero" id="invSlotPablo0" data-rang="pablo" data-pos="0">
            <!-- Cube position 0 (en production) -->
          </div>
        </div>
      </div>
      
      <!-- Rangée Checkna -->
      <div class="inv-row-small">
        <div class="inv-row-header-numbered">
          <div class="inv-col-numbers">
            <div class="inv-col-num">5</div>
            <div class="inv-col-num">4</div>
            <div class="inv-col-num">3</div>
            <div class="inv-col-num">2</div>
            <div class="inv-col-num">1</div>
          </div>
          <div class="inv-col-name">
            <span class="inv-col-name-text">Checkna</span>
            <span class="inv-col-name-status" id="invStatusCheckna"></span>
          </div>
        </div>
        <div class="inv-row-body">
          <div class="inv-cols-content">
            <div class="inv-col-slot" id="invSlotCheckna5" data-rang="checkna" data-pos="5"></div>
            <div class="inv-col-slot" id="invSlotCheckna4" data-rang="checkna" data-pos="4"></div>
            <div class="inv-col-slot" id="invSlotCheckna3" data-rang="checkna" data-pos="3"></div>
            <div class="inv-col-slot" id="invSlotCheckna2" data-rang="checkna" data-pos="2"></div>
            <div class="inv-col-slot" id="invSlotCheckna1" data-rang="checkna" data-pos="1"></div>
          </div>
          <div class="inv-col-zero" id="invSlotCheckna0" data-rang="checkna" data-pos="0">
            <!-- Cube position 0 (en production) -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Fiche Inventaire simplifiée -->
  <div class="inv-fiche-overlay hidden" id="invFicheOverlay">
    <div class="inv-fiche">
      <div class="inv-fiche-header">
        <span class="inv-fiche-title" id="invFicheTitle">Nouvel article</span>
        <button class="inv-fiche-close" onclick="closeInvFiche()">×</button>
      </div>
      <div class="inv-fiche-body">
        <div class="inv-fiche-row">
          <div class="inv-fiche-field">
            <div class="inv-fiche-label">Nom de l'item</div>
            <input type="text" class="inv-fiche-input" id="invNom" placeholder="Ex: Coussin Premium">
          </div>
        </div>
        <div class="inv-fiche-row">
          <div class="inv-fiche-field">
            <div class="inv-fiche-label">Numéro de produit</div>
            <input type="text" class="inv-fiche-input" id="invCode" placeholder="Ex: PRD-001">
          </div>
          <div class="inv-fiche-field">
            <div class="inv-fiche-label">Quantité</div>
            <input type="number" class="inv-fiche-input" id="invQuantite" placeholder="0" min="0">
          </div>
        </div>
        <div class="inv-fiche-row">
          <div class="inv-fiche-field">
            <div class="inv-fiche-label">Assigné à</div>
            <select class="inv-fiche-select" id="invRang" onchange="updateInvPositionVisibility()">
              <option value="main">📦 À faire</option>
              <option value="pablo">👤 Pablo</option>
              <option value="checkna">👤 Checkna</option>
            </select>
          </div>
          <div class="inv-fiche-field" id="invPositionField">
            <div class="inv-fiche-label">Position</div>
            <select class="inv-fiche-select" id="invPosition">
              <option value="0">0 - En production</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>
      </div>
      <div class="inv-fiche-actions">
        <button class="inv-btn inv-btn-delete" id="invBtnDelete" onclick="deleteInvItem()" style="display:none;">🗑️ Supprimer</button>
        <button class="inv-btn inv-btn-cancel" onclick="closeInvFiche()">Annuler</button>
        <button class="inv-btn inv-btn-save" onclick="saveInvItem()">💾 Enregistrer</button>
      </div>
    </div>
  </div>
  
  <!-- Page Jobs en Attente -->
  <div class="page" id="pageJobs">
    <div class="jobs-page">
      <div class="jobs-columns">
        <div class="jobs-col">
          <div class="jobs-col-title">
            <span>👤 Sonia <span class="count" id="countSonia">0</span></span>
          </div>
          <div class="jobs-col-content" id="listSonia"></div>
        </div>
        <div class="jobs-col">
          <div class="jobs-col-title">
            <span>👤 Jacinthe <span class="count" id="countJacinthe">0</span></span>
          </div>
          <div class="jobs-col-content" id="listJacinthe"></div>
        </div>
        <div class="jobs-col">
          <div class="jobs-col-title">
            <span>👤 Nadia <span class="count" id="countNadia">0</span></span>
          </div>
          <div class="jobs-col-content" id="listNadia"></div>
        </div>
        <div class="jobs-col">
          <div class="jobs-col-title">
            <span>🆕 Nouveau <span class="count" id="countNouveau">0</span></span>
          </div>
          <div class="jobs-col-content" id="listNouveau"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Settings Overlay (position fixe, hors flux) -->
  <div class="settings-overlay hidden" id="settingsOverlay">
    <div class="settings-popup">
      <div class="settings-header">
        <span>⚙ Parametres</span>
        <button class="settings-close-btn" id="settingsCloseBtn">&#10005;</button>
      </div>
      <div class="settings-content">
        <button class="settings-item" id="btnImportExport"><span class="settings-icon">&#128230;</span><span>Importer / Exporter</span></button>
        <button class="settings-item" id="btnArchives"><span class="settings-icon">&#128203;</span><span>Log / Archives</span></button>
        <button class="settings-item logout" id="btnLogout"><span class="settings-icon">&#128682;</span><span>Deconnexion</span></button>
      </div>
    </div>
  </div>
  
  <!-- Menu Import/Export -->
  <div class="import-export-overlay hidden" id="importExportOverlay">
    <div class="import-export-popup">
      <div class="import-export-header">
        <span>📦 Importer / Exporter les données</span>
        <button class="import-export-close-btn" onclick="closeImportExportMenu()">✕</button>
      </div>
      <div class="import-export-content">
        <div class="import-export-section">
          <h3>📤 Exporter les données</h3>
          <p>Télécharger toutes vos données (moulages, paramètres) dans un fichier JSON.</p>
          <button class="import-export-btn export-btn" onclick="exportAllData()">
            <span>📥</span> Exporter toutes les données
          </button>
          <div class="export-options">
            <button class="import-export-btn-small" onclick="exportMoulagesOnly()">Moulages seulement</button>
          </div>
        </div>
        <div class="import-export-divider"></div>
        <div class="import-export-section">
          <h3>📥 Importer les données</h3>
          <p>Charger des données depuis un fichier JSON exporté précédemment.</p>
          <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
          <button class="import-export-btn import-btn" onclick="document.getElementById('importFileInput').click()">
            <span>📤</span> Importer un fichier
          </button>
          <div class="import-warning">
            ⚠️ L'importation ajoutera les données au système. Exportez d'abord vos données actuelles!
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Menu Log/Archives -->
  <div class="log-overlay hidden" id="logOverlay">
    <div class="log-popup">
      <div class="log-header">
        <span>📋 Journal des activités</span>
        <button class="log-close-btn" onclick="closeLogMenu()">✕</button>
      </div>
      <div class="log-content" id="logContent">
        <div class="log-empty">Aucune activité enregistrée</div>
      </div>
    </div>
  </div>
  
  <!-- Menu de déplacement avec rangs -->
  <div class="move-overlay hidden" id="moveOverlay">
    <div class="move-panel">
      <div class="move-title">Déplacer vers quelle colonne?</div>
      <div class="move-columns" id="moveColumns">
        <!-- Généré dynamiquement -->
      </div>
      <div class="move-footer">
        <button class="move-btn-close" id="moveClose">Annuler</button>
      </div>
    </div>
  </div>
  
  <!-- Confirmation suppression -->
  <div class="confirm-overlay hidden" id="confirmOverlay">
    <div class="confirm-panel">
      <div class="confirm-title">⚠️ Confirmer la suppression</div>
      <div class="confirm-message" id="confirmMessage">Voulez-vous vraiment supprimer ce moulage?</div>
      <div class="confirm-buttons">
        <button class="confirm-btn confirm-btn-yes" id="confirmYes">Oui, supprimer</button>
        <button class="confirm-btn confirm-btn-no" id="confirmNo">Non, annuler</button>
      </div>
    </div>
  </div>
  
  <!-- Overlay pour la fiche moulage -->
  <div class="card-overlay" id="cardOverlay" onclick="closeFiche()"></div>
  
  <!-- CALENDRIER GLOBAL -->
  <div class="global-calendar-overlay" id="globalCalendarOverlay"></div>
  <div class="global-calendar-popup" id="globalCalendarPopup">
    <div class="gcal-header">
      <div class="gcal-title">📅 Sélectionner une date</div>
      <button class="gcal-close-x" id="gcalCloseX">✕</button>
    </div>
    <div class="gcal-nav">
      <button class="gcal-nav-btn" id="gcalPrev">◀</button>
      <span class="gcal-month-year" id="gcalMonthYear"></span>
      <button class="gcal-nav-btn" id="gcalNext">▶</button>
    </div>
    <div class="gcal-weekdays">
      <div class="gcal-weekday">Dim</div>
      <div class="gcal-weekday">Lun</div>
      <div class="gcal-weekday">Mar</div>
      <div class="gcal-weekday">Mer</div>
      <div class="gcal-weekday">Jeu</div>
      <div class="gcal-weekday">Ven</div>
      <div class="gcal-weekday">Sam</div>
    </div>
    <div class="gcal-days" id="gcalDays"></div>
    <div class="gcal-buttons">
      <button class="gcal-btn gcal-btn-today" id="gcalToday">Aujourd'hui</button>
    </div>
  </div>
  
  <!-- List Manager Overlay -->
  <div class="list-manager-overlay hidden" id="listManagerOverlay">
    <div class="list-manager-popup">
      <div class="list-manager-header">
        <h3 id="listManagerTitle">⚙ Gérer les valeurs</h3>
        <button class="list-manager-close-btn" onclick="closeListManager()">&#10005;</button>
      </div>
      <div class="list-manager-content">
        <div class="list-manager-items" id="listManagerItems"></div>
      </div>
      <div class="list-manager-footer">
        <div class="list-manager-input-wrapper">
          <input type="text" id="listManagerNewItem" placeholder="Nouvelle valeur..." onkeypress="if(event.key==='Enter'){addListItem();}">
          <button class="btn-add-inside" onclick="addListItem()" title="Ajouter">+</button>
        </div>
        <button class="btn-close-list" onclick="closeListManager()">Fermer</button>
      </div>
    </div>
  </div>
  
  <div id="loginOverlay" class="login-overlay">
    <div class="login-panel">
      <div class="login-logo-flip-container">
        <div class="login-logo-flip-inner">
          <div class="login-logo-flip-front">
            <img src="https://raw.githubusercontent.com/Physipro-list/Physipro-serie/main/logo-physiprodemi1.png" alt="PhysiPro">
          </div>
        </div>
      </div>
      <div class="login-title-container">
        <div class="login-title">Outil de gestion simplifiée</div>
        <div class="login-author">par Daniel Charest</div>
      </div>
      <div class="login-subtitle">Connectez-vous avec votre email d'entreprise</div>
      <form id="loginForm" autocomplete="on">
        <input type="email" id="loginEmail" name="email" class="login-input login-input-email" placeholder="Email d'entreprise" autocomplete="username">
        <input type="password" id="loginPassword" name="password" class="login-input" placeholder="Mot de passe" maxlength="50" autocomplete="current-password">
        <div class="login-remember">
          <input type="checkbox" id="rememberMe" name="remember">
          <label for="rememberMe">Se souvenir de moi sur cet ordinateur</label>
        </div>
        <button type="submit" class="login-btn" id="loginBtn">Se connecter</button>
      </form>
      <button class="login-forgot-btn" id="forgotPasswordBtn">Mot de passe oublie?</button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>
</div>

<script>
// =====================================================
// PHYSIPRO MOULAGE v13.3 - JAVASCRIPT PROPRE
// =====================================================

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCk7bqVnx08Kz1fVq1W24AuW854KY9jPno",
  authDomain: "liste-des-moulages-physipro.firebaseapp.com",
  databaseURL: "https://liste-des-moulages-physipro-default-rtdb.firebaseio.com",
  projectId: "liste-des-moulages-physipro",
  storageBucket: "liste-des-moulages-physipro.firebasestorage.app",
  messagingSenderId: "24566847562",
  appId: "1:24566847562:web:db492bdd33116373e0eeb3"
};

// Utilisateurs autorises (identique au fichier original)
const USERS = {
  "atelieratp@physipro.com": { name: "Daniel Charest", role: "admin", tempHash: "997a5fb50ce12b5619bdb2ecc2dc05f216af0ab61bb3f2609017c3fcb62da2ae" },
  "simdut@physipro.com": { name: "Cassie Valois", role: "editor", tempHash: "b36e5a61cadecc891b457429048e44133cf8dae501a9cfc4c423bcf00715da30" },
  "mplanguedoc@physipro.com": { name: "Marie-Pier Languedoc", role: "editor", tempHash: "ff5cfebfb49c5213aa2304f15e19c3147f48d55aa26ea299f7457c0209f804e0" },
  "marie-soleil.riverin@physipro.com": { name: "Marie-Soleil Riverin", role: "editor", tempHash: "722d36562183c87fa53ce5c44d424c63c6c3b2b27c72c7a233663d9f568fecc2" },
  "michelle.bouchard@physipro.com": { name: "Michelle Bouchard", role: "editor", tempHash: "a899253b54dd6c800f9513919186a55948f9ff0d6162b9fdb200bdaf60a500f3" },
  "ngagne@physipro.com": { name: "Nadia Gagne", role: "editor", tempHash: "cb2a7765e640d51841f9aa8dfc335e19bcbd894b0c8cc096d97a073c9a4b548d" },
  "cncatp@physipro.com": { name: "Sina Lotfollah", role: "editor", tempHash: "1d537709c14a89facf0704bd2c091d9da8b48fe69b0c65de5741db0b9ad7919d" },
  "magasinatp3@physipro.com": { name: "Stephane Delorme", role: "editor", tempHash: "5042c15596f4aad0f612d50e0c013476f84a1d709527eca42821cf423f6092c0" },
  "sroy@physipro.com": { name: "Stephanie Roy", role: "editor", tempHash: "eeff8c3b9ae24e6a2d8b3c8766c0a7bf927bf479da0aa94e21061ded39c6ce6d" },
  "magasinatp2@physipro.com": { name: "Sylvain Carrier", role: "editor", tempHash: "ffdebc076a622154180f479624c9a9e1c4ff4c832f62aca8f15341d16cfda6ef" },
  "mario.jacques@physipro.com": { name: "Mario Jacques", role: "editor", tempHash: "15d700ad21280a8c2fa03075c55c70a766ea8c9db5b5d8f7a850835e67514357" },
  "valerie18@videotron.ca": { name: "Valerie Frechette", role: "editor", tempHash: "3277ff046b6d07eb1ff818f1a54ef1a7d40d72cb151fd29058efc54bfbe84d1a" },
  "fabrys.frechette@physipro.com": { name: "Fabrys Frechette", role: "viewer", tempHash: "2815e7664309c9785471fe9dba0c2ed4f97dd52a89f5e2b17fa695187d07c34e" },
  "rh@physipro.com": { name: "Roxanne Valois", role: "viewer", tempHash: "47fb2d990d95be18c1e0206e1f3640bcaf5ed0345bbb220757556d0fd3424f07" },
  "sonia.boulanger@physipro.com": { name: "Sonia Boulanger", role: "viewer", tempHash: "847267f5801f9d09b17995593d69db5a4b6a425c3d8594d8cdf81227c80e1fec" },
  "magasinatp1@physipro.com": { name: "Stephane Duchesneau", role: "viewer", tempHash: "bbca07c4246a26a6c438c325d29329b90693a5d26ccc166dd30ae755c9cfc540" },
  "marioouellette@physipro.com": { name: "Mario Ouellette", role: "viewer", tempHash: "71b5601cad7b61f8a9bbf42546303b4676990f07d8ecee70a89c464b36553c4a" },
  "service3@physipro.com": { name: "Jacynthe Gaumond", role: "viewer", tempHash: "fd9f31c199a09b28b4d0eafe0dd63713f219141c2723a62ec68106079c3b10b5" }
};

const COLUMNS = [
  { id: 0, name: 'Robot', contentId: 'colRobot', countId: 'countRobot' },
  { id: 1, name: 'Dégauchage', contentId: 'colDégauchage', countId: 'countDégauchage' },
  { id: 2, name: 'Essayage', contentId: 'colEssayage', countId: 'countEssayage' },
  { id: 3, name: 'Atelier', contentId: 'colAtelier', countId: 'countAtelier' },
  { id: 4, name: 'Couture', contentId: 'colCouture', countId: 'countCouture' },
  { id: 5, name: 'Peinture', contentId: 'colPeinture', countId: 'countPeinture' },
  { id: 6, name: 'Expédition', contentId: 'colExpedition', countId: 'countExpedition' },
  { id: 7, name: 'En attente', contentId: 'colAttente', countId: 'countAttente' }
];

let firebaseAuth, firebaseDb, currentUser = null, cardsData = {};

// Listes personnalisables (triees alphabetiquement)
let customLists = {
  moulageClients: [
    'IWK Nouvelle Ecosse',
    'MED +',
    'Metro Health Nouveau Brunswick',
    'SAT Baie Comeau',
    'SAT CRE Sherbrooke',
    'SAT CRDPCA',
    'SAT Gaspesie Saint Anne des Monts',
    'SAT IRDPQ Hamel',
    'SAT Joliette',
    'SAT Jonquiere Saguenay Lac Saint Jean',
    'SAT Mont Joli',
    'SAT Sept Iles',
    'SAT Trois Rivieres',
    'Stan Cassidy Nouveau Brunswick',
    'TLC Medical'
  ],
  regions: ['Maritime', 'Canada anglais', 'Quebec'],
  intervenants: [
    'Anna Caulfield',
    'Annie Bourgeois',
    'Anne Sophie Montminy',
    'Camille Morel',
    'Cindy Audet',
    'Eric Gagnon',
    'Godefroy Neault',
    'Isabelle Neault',
    'Jenny Jackson',
    'Joelle Bourdages',
    'Josee Bedard',
    'Josianne Labrecque',
    'Judith Lagimoniere',
    'Julie Lefebvre',
    'Lisa Houde',
    'Louis Matton',
    'Maggie MCCann',
    'Marie Michelle Hamel',
    'Marie Smith',
    'Mario Lebouthiller',
    'Martine Comeau',
    'Mireille Lefebvre',
    'Nadyne Gobeil',
    'Pam McKaskill',
    'Stephanie DAstou',
    'Tabitha Knowles',
    'Ysabelle Fugere'
  ],
  representantes: ['Marie-Pier', 'Marie-Soleil'],
  items: [
    'Appui-tête',
    'Coussin',
    'Dossier',
    'Siège',
    'Siège + Dossier'
  ],
  raisonsAttente: [
    "En attente de pièces",
    "En attente d'approbation client",
    "En attente de réponse couture",
    "En attente de réponse atelier",
    "En attente de réponse robot",
    "En attente de posit",
    "En attente ROHO",
    "En attente de plaques d'aluminium",
    "En attente de fichiers de scans"
  ]
};

let currentListKey = null;
let currentListTitle = null;

// Elements DOM
const loginOverlay = document.getElementById('loginOverlay');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const userStatusEl = document.getElementById('userStatus');

// ===== SYSTÈME DE CONNEXION SIMPLE =====

// Init Firebase - VERSION SIMPLE
function initFirebase() {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.database();
    return true;
  } catch (e) {
    console.error("Erreur Firebase:", e);
    return false;
  }
}

// Connexion - VERSION SIMPLE avec fallback
async function attemptLogin() {
  const email = loginEmail.value.trim().toLowerCase();
  const password = loginPassword.value;
  
  if (!email) { loginError.textContent = "Veuillez entrer votre email"; return; }
  if (!password) { loginError.textContent = "Veuillez entrer votre mot de passe"; return; }
  
  const userInfo = USERS[email];
  if (!userInfo) { loginError.textContent = "Cet email n'est pas autorise"; return; }
  
  loginBtn.textContent = "Connexion...";
  loginBtn.disabled = true;
  loginError.textContent = "";
  
  try {
    await firebaseAuth.signInWithEmailAndPassword(email, password);
    // Sauvegarder si checkbox cochee
    if (document.getElementById('rememberMe').checked) {
      localStorage.setItem('physipro_email', email);
      localStorage.setItem('physipro_password', password);
    } else {
      localStorage.removeItem('physipro_email');
      localStorage.removeItem('physipro_password');
    }
    loginSuccess(userInfo, email);
  } catch (error) {
    console.error('Erreur Firebase Auth:', error.code, error.message);
    
    // Mode de contournement - si Firebase échoue mais l'email est autorisé
    // Vérifier le mot de passe local (mot de passe = "physipro123" pour tous)
    if (password === 'physipro123' || password === 'admin123' || password === 'Physipro2024!') {
      console.log('⚠️ Mode hors-ligne activé');
      if (document.getElementById('rememberMe').checked) {
        localStorage.setItem('physipro_email', email);
        localStorage.setItem('physipro_password', password);
      }
      loginSuccess(userInfo, email);
      showToast('⚠️ Mode hors-ligne - données locales uniquement');
    } else {
      loginError.textContent = "Email ou mot de passe incorrect";
    }
  }
  
  loginBtn.textContent = "Se connecter";
  loginBtn.disabled = false;
}

function loginSuccess(userInfo, email) {
  currentUser = { ...userInfo, email };
  loginOverlay.classList.add('hidden');
  
  const statusDot = userStatusEl.querySelector('.status-dot');
  const userName = userStatusEl.querySelector('.user-name');
  if (statusDot) statusDot.classList.add('online');
  if (userName) userName.innerHTML = '<span class="user-name-text">' + userInfo.name + '</span><span class="user-role-badge ' + userInfo.role + '">' + 
    ({ admin: 'Admin', editor: 'Editeur', viewer: 'Lecteur' }[userInfo.role] || userInfo.role) + '</span>';
  
  loadCardsFromFirebase();
  loadCustomLists();
  initJobsPage();
  initInventaire();
  initCommandes();
  showToast("Connexion reussie!");
  
  if (typeof initMobileAfterLogin === 'function') {
    initMobileAfterLogin();
  }
}

// Charger email/password sauvegardés
function loadSavedCredentials() {
  const savedEmail = localStorage.getItem('physipro_email');
  const savedPassword = localStorage.getItem('physipro_password');
  if (savedEmail) {
    loginEmail.value = savedEmail;
    document.getElementById('rememberMe').checked = true;
  }
  if (savedPassword) {
    loginPassword.value = savedPassword;
  }
}

// Logout simple
async function logout() {
  try {
    await firebaseAuth.signOut();
  } catch(e) {}
  localStorage.removeItem('physipro_email');
  localStorage.removeItem('physipro_password');
  location.reload();
}

// ===== DONNEES =====
let MENU_DATA = {
  regions: ["Quebec", "Canada anglais", "Maritime"],
  delays: { "Quebec": 90, "Canada anglais": 30, "Maritime": 45 },
  clients: [],
  intervenants: [],
  representantes: ["Marie-Soleil", "Marie-Pier"],
  items: ["Siege", "Dossier", "Siege + Dossier"]
};

// Jours feries Quebec
const QUEBEC_HOLIDAYS = [
  '2024-01-01', '2024-04-29', '2024-05-20', '2024-06-24', '2024-07-01',
  '2024-09-02', '2024-10-14', '2024-12-25', '2024-12-26',
  '2025-01-01', '2025-04-21', '2025-05-19', '2025-06-24', '2025-07-01',
  '2025-09-01', '2025-10-13', '2025-12-25', '2025-12-26'
];

// Charger cartes depuis Firebase
function loadCardsFromFirebase() {
  firebaseDb.ref('cards').on('value', snapshot => {
    const data = snapshot.val();
    
    // Supprimer cartes qui n'existent plus
    document.querySelectorAll('.mcard[data-card-id]').forEach(card => {
      const cardId = card.dataset.cardId;
      if (!data || !data[cardId]) {
        card.remove();
        delete cardsData[cardId];
      }
    });
    
    if (data) {
      Object.keys(data).forEach(cardId => {
        const cardData = data[cardId];
        cardsData[cardId] = cardData;
        
        let card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        const isAttente = (cardData.columnIndex === 7);
        const isExpedition = (cardData.columnIndex === 6);
        
        if (card) {
          // Mettre a jour carte existante
          updateExistingCard(card, cardId, cardData);
        } else {
          // Creer nouvelle carte
          card = createCardElement(cardId, cardData);
          const columns = document.querySelectorAll('.col');
          const targetCol = columns[cardData.columnIndex || 0];
          if (targetCol) {
            const content = targetCol.querySelector('.col-content');
            if (content) content.appendChild(card);
          }
          attachCardEvents(card);
        }
      });
      
      // Nettoyer les notes corrompues
      cleanCorruptedNotes(cardsData, 'cards');
      
      updateColumnCounts();
      refreshAllPriorities();
      console.log(`${Object.keys(data).length} cartes synchronisees`);
    } else {
      updateColumnCounts();
    }
  });
}

// Nettoyer les notes corrompues (base64, HTML cassé, etc.)
function cleanCorruptedNotes(dataObj, dbPath) {
  let cleaned = 0;
  
  Object.keys(dataObj).forEach(id => {
    const item = dataObj[id];
    if (!item) return;
    
    // Vérifier le champ notes
    if (item.notes && typeof item.notes === 'string') {
      const originalNotes = item.notes;
      let cleanedNotes = item.notes;
      
      // Supprimer les données base64 d'images
      if (cleanedNotes.includes('data:image/') || cleanedNotes.includes('base64,')) {
        // Supprimer les balises img avec base64
        cleanedNotes = cleanedNotes.replace(/<img[^>]*src=["']data:image[^"']*["'][^>]*>/gi, '');
        // Supprimer les data:image standalone
        cleanedNotes = cleanedNotes.replace(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g, '[Image supprimée]');
      }
      
      // Supprimer les balises HTML cassées ou vides
      cleanedNotes = cleanedNotes.replace(/<div[^>]*><\/div>/gi, '');
      cleanedNotes = cleanedNotes.replace(/<br\s*\/?>\s*<br\s*\/?>/gi, '<br>');
      cleanedNotes = cleanedNotes.replace(/^\s*<br\s*\/?>\s*/gi, '');
      cleanedNotes = cleanedNotes.replace(/\s*<br\s*\/?>\s*$/gi, '');
      
      // Supprimer les séquences de -- répétées
      cleanedNotes = cleanedNotes.replace(/--\s*--/g, '--');
      
      // Nettoyer les espaces multiples
      cleanedNotes = cleanedNotes.replace(/\s{3,}/g, ' ');
      
      // Si nettoyé, mettre à jour
      if (cleanedNotes !== originalNotes) {
        item.notes = cleanedNotes;
        cleaned++;
        
        // Sauvegarder si Firebase disponible
        if (firebaseDb && dbPath) {
          firebaseDb.ref(dbPath + '/' + id + '/notes').set(cleanedNotes);
        }
      }
    }
    
    // Pour les jobs, vérifier aussi questions et response
    if (item.questions && typeof item.questions === 'string') {
      if (item.questions.includes('data:image/') || item.questions.includes('base64,')) {
        item.questions = item.questions.replace(/<img[^>]*src=["']data:image[^"']*["'][^>]*>/gi, '');
        item.questions = item.questions.replace(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g, '[Image supprimée]');
        if (firebaseDb && dbPath) {
          firebaseDb.ref(dbPath + '/' + id + '/questions').set(item.questions);
        }
        cleaned++;
      }
    }
    
    if (item.response && typeof item.response === 'string') {
      if (item.response.includes('data:image/') || item.response.includes('base64,')) {
        item.response = item.response.replace(/<img[^>]*src=["']data:image[^"']*["'][^>]*>/gi, '');
        item.response = item.response.replace(/data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g, '[Image supprimée]');
        if (firebaseDb && dbPath) {
          firebaseDb.ref(dbPath + '/' + id + '/response').set(item.response);
        }
        cleaned++;
      }
    }
  });
  
  if (cleaned > 0) {
    console.log(`🧹 ${cleaned} notes nettoyées dans ${dbPath}`);
  }
}

// Creer element carte
function createCardElement(cardId, cardData) {
  const card = document.createElement('div');
  card.className = 'mcard';
  card.dataset.cardId = cardId;
  
  // Classe region
  if (cardData.region === 'Quebec' || cardData.region === 'Québec') card.classList.add('region-qc');
  else if (cardData.region === 'Canada anglais' || cardData.region === 'Ontario') card.classList.add('region-on');
  else if (cardData.region === 'Maritime') card.classList.add('region-ma');
  
  if (cardData.columnIndex === 7) card.classList.add('in-attente-column');
  if (cardData.columnIndex === 6) card.classList.add('in-expedition-column');
  
  // Calculer delai
  const delayInfo = getDelayInfo(cardData);
  const regionText = cardData.region || '--';
  
  // Nom et commande: verrouillés si déjà remplis
  // Champs nom et commande - modification libre
  
  card.innerHTML = `
    <div class="priority-badge hidden" data-priority="0"></div>
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <input type="text" class="mcard-title" value="${cardData.name || 'Nom du moulage'}" data-field="name">
        </div>
        <div class="mcard-order-line">
          <span class="mcard-region-pill" onclick="openPriorityMenu('${cardId}', event)" title="Cliquer pour priorite">${regionText}</span>
          <input type="text" class="mcard-order" value="${cardData.order || '000000'}" data-field="order" maxlength="6">
          <button class="mcard-fiche-btn" data-action="open-fiche" data-card-id="${cardId}" title="Ouvrir la fiche">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="${delayInfo.classes}" onclick="openDelaiMenu('${cardId}', event)"><span>${delayInfo.text}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move">Deplacer</button>
      <button class="mcard-btn mcard-btn-delete">Supprimer</button>
    </div>
  `;
  
  return card;
}

// Mettre a jour carte existante
function updateExistingCard(card, cardId, cardData) {
  const titleInput = card.querySelector('.mcard-title');
  const orderInput = card.querySelector('.mcard-order');
  if (titleInput) titleInput.value = cardData.name || 'Nom du moulage';
  if (orderInput) orderInput.value = cardData.order || '000000';
  
  // Mettre a jour region
  card.classList.remove('region-qc', 'region-on', 'region-ma', 'in-attente-column', 'in-expedition-column');
  if (cardData.region === 'Quebec' || cardData.region === 'Québec') card.classList.add('region-qc');
  else if (cardData.region === 'Canada anglais' || cardData.region === 'Ontario') card.classList.add('region-on');
  else if (cardData.region === 'Maritime') card.classList.add('region-ma');
  if (cardData.columnIndex === 7) card.classList.add('in-attente-column');
  if (cardData.columnIndex === 6) card.classList.add('in-expedition-column');
  
  // Mettre a jour pastille delai
  const delayPill = card.querySelector('.mcard-delay-pill');
  const delaySpan = delayPill?.querySelector('span');
  if (delayPill && delaySpan) {
    delayPill.className = 'mcard-delay-pill';
    const delayInfo = getDelayInfo(cardData);
    delaySpan.textContent = delayInfo.text;
    delayInfo.classes.split(' ').forEach(c => { if (c) delayPill.classList.add(c); });
  }
  
  // Deplacer si necessaire
  const columns = document.querySelectorAll('.col');
  const currentCol = card.closest('.col');
  const targetCol = columns[cardData.columnIndex || 0];
  if (currentCol !== targetCol && targetCol) {
    const content = targetCol.querySelector('.col-content');
    if (content) content.appendChild(card);
  }
}

// Calculer info delai
function getDelayInfo(cardData) {
  const isAttente = cardData.columnIndex === 7;
  const isExpedition = cardData.columnIndex === 6;
  
  if (cardData.expedie && cardData.dateExpedition) {
    return { text: `Expédié ${cardData.dateExpedition}`, classes: 'mcard-delay-pill expedie' };
  }
  
  if (isAttente) {
    let classes = 'mcard-delay-pill';
    if (cardData.raisonAttente && cardData.attenteActive) classes += ' attente-active';
    return { text: cardData.raisonAttente || '? Raison', classes };
  }
  
  if (isExpedition) {
    return { text: 'Prêt à expédier', classes: 'mcard-delay-pill' };
  }
  
  // Calculer jours restants
  const hasValidDateRobot = cardData.dateRobot && cardData.dateRobot !== '' && cardData.dateRobot !== 'AAAA-MM-JJ';
  
  if (hasValidDateRobot) {
    const joursRestants = calculateRemainingDelay(cardData);
    
    if (joursRestants < 0) {
      const joursRetard = Math.abs(joursRestants);
      return { text: `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`, classes: 'mcard-delay-pill delai-retard' };
    } else if (joursRestants === 0) {
      return { text: "Aujourd'hui!", classes: 'mcard-delay-pill delai-retard' };
    } else {
      let colorClass = 'delai-vert';
      if (joursRestants <= 3) colorClass = 'delai-rouge';
      else if (joursRestants <= 10) colorClass = 'delai-jaune';
      return { text: `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`, classes: `mcard-delay-pill ${colorClass}` };
    }
  } else {
    const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
    return { text: `${delaiTotal} jours ouvrables`, classes: 'mcard-delay-pill delai-vert' };
  }
}

// Calculer jours restants
function calculateRemainingDelay(cardData) {
  if (cardData.expedie) return 0;
  
  const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
  const dateRobotStr = cardData.dateRobot;
  
  if (!dateRobotStr || dateRobotStr === '' || dateRobotStr === 'AAAA-MM-JJ') {
    return delaiTotal;
  }
  
  const dateRobot = new Date(dateRobotStr + 'T00:00:00');
  if (isNaN(dateRobot.getTime())) return delaiTotal;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let joursOuvrablesEcoules = compterJoursOuvrables(dateRobot, today);
  
  // Soustraire temps en essayage
  if (cardData.tracking && cardData.tracking.essayage) {
    const essayage = cardData.tracking.essayage;
    if (essayage.entree && essayage.sortie) {
      const dateEntree = new Date(essayage.entree + 'T00:00:00');
      const dateSortie = new Date(essayage.sortie + 'T00:00:00');
      if (!isNaN(dateEntree.getTime()) && !isNaN(dateSortie.getTime())) {
        const joursEssayage = compterJoursOuvrables(dateEntree, dateSortie);
        joursOuvrablesEcoules -= joursEssayage;
        if (joursOuvrablesEcoules < 0) joursOuvrablesEcoules = 0;
      }
    }
  }
  
  return delaiTotal - joursOuvrablesEcoules;
}

// Compter jours ouvrables
function compterJoursOuvrables(dateDebut, dateFin) {
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  debut.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  if (fin <= debut) return 0;
  
  let count = 0;
  const current = new Date(debut);
  current.setDate(current.getDate() + 1);
  
  while (current <= fin) {
    const dayOfWeek = current.getDay();
    const dateStr = current.toISOString().split('T')[0];
    
    if (dayOfWeek !== 0 && dayOfWeek !== 6 && !QUEBEC_HOLIDAYS.includes(dateStr)) {
      count++;
    }
    current.setDate(current.getDate() + 1);
  }
  
  return count;
}

// Attacher evenements carte
function attachCardEvents(card) {
  const cardId = card.dataset.cardId;
  
  // Input titre - modification directe sans confirmation
  const titleInput = card.querySelector('.mcard-title');
  titleInput?.addEventListener('focus', () => titleInput.select());
  titleInput?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); titleInput.blur(); } });
  titleInput?.addEventListener('blur', () => {
    if (cardsData[cardId]) {
      cardsData[cardId].name = titleInput.value || 'Nom du moulage';
      saveCardToFirebase(cardId);
    }
  });
  
  // Input commande - modification directe sans confirmation
  const orderInput = card.querySelector('.mcard-order');
  orderInput?.addEventListener('focus', () => orderInput.select());
  orderInput?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); orderInput.blur(); } });
  orderInput?.addEventListener('input', () => { orderInput.value = orderInput.value.replace(/[^0-9]/g, '').slice(0, 6); });
  orderInput?.addEventListener('blur', () => {
    if (cardsData[cardId]) {
      cardsData[cardId].order = orderInput.value || '000000';
      saveCardToFirebase(cardId);
    }
  });
  
  // Bouton Fiche
  const ficheBtn = card.querySelector('.mcard-fiche-btn');
  ficheBtn?.addEventListener('click', e => {
    e.stopPropagation();
    openFiche(card);
  });
  
  // Bouton Deplacer
  const moveBtn = card.querySelector('.mcard-btn-move');
  moveBtn?.addEventListener('click', e => {
    e.stopPropagation();
    openMoveMenu(cardId);
  });
  
  // Bouton Supprimer
  const deleteBtn = card.querySelector('.mcard-btn-delete');
  deleteBtn?.addEventListener('click', e => {
    e.stopPropagation();
    showDeleteConfirm(card, cardId);
  });
}

// Variables pour la suppression
let cardToDelete = null;
let cardIdToDelete = null;

function showDeleteConfirm(card, cardId) {
  cardToDelete = card;
  cardIdToDelete = cardId;
  const name = cardsData[cardId]?.name || 'ce moulage';
  document.getElementById('confirmMessage').textContent = `Voulez-vous vraiment supprimer "${name}"?`;
  document.getElementById('confirmOverlay').classList.remove('hidden');
}

function closeDeleteConfirm() {
  document.getElementById('confirmOverlay').classList.add('hidden');
  cardToDelete = null;
  cardIdToDelete = null;
}

function confirmDelete() {
  if (cardToDelete && cardIdToDelete) {
    const name = cardsData[cardIdToDelete]?.name || 'Inconnu';
    
    cardToDelete.remove();
    delete cardsData[cardIdToDelete];
    updateColumnCounts();
    firebaseDb.ref('cards/' + cardIdToDelete).remove();
    showToast('Moulage "' + name + '" supprimé');
  }
  closeDeleteConfirm();
}

// Sauvegarder carte
function saveCardToFirebase(cardId) {
  if (cardsData[cardId]) {
    firebaseDb.ref('cards/' + cardId).set(cardsData[cardId]);
  }
}

// Générer ID unique pour carte
function generateCardId() {
  return 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Créer une nouvelle carte
function createCard(name, order, region, columnIndex) {
  const cardId = generateCardId();
  const delay = MENU_DATA.delays[region] || 90;
  
  // Créer l'élément carte
  const card = document.createElement('div');
  card.className = 'mcard';
  card.dataset.cardId = cardId;
  
  // Classe région
  if (region === 'Québec' || region === 'Quebec') card.classList.add('region-qc');
  else if (region === 'Canada anglais' || region === 'Ontario') card.classList.add('region-on');
  else if (region === 'Maritime') card.classList.add('region-ma');
  
  // Marquer si colonne spéciale
  if (columnIndex === 7) card.classList.add('in-attente-column');
  if (columnIndex === 6) card.classList.add('in-expedition-column');
  
  const item = 'Siège';
  const isAttente = columnIndex === 7;
  const isExpedition = columnIndex === 6;
  
  // Déterminer le texte et la classe de couleur de la pastille délai
  let delayText = delay + ' jours ouvrables';
  let delayClass = 'mcard-delay-pill delai-vert';
  
  if (isAttente) {
    delayText = '? Raison';
    delayClass = 'mcard-delay-pill';
  } else if (isExpedition) {
    delayText = 'Expédier';
    delayClass = 'mcard-delay-pill';
  }
  
  card.innerHTML = `
    <div class="priority-badge hidden" data-priority="0"></div>
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <input type="text" class="mcard-title" value="${name}" data-field="name">
        </div>
        <div class="mcard-order-line">
          <span class="mcard-region-pill" onclick="openPriorityMenu('${cardId}', event)" title="Cliquer pour définir priorité">${region}</span>
          <input type="text" class="mcard-order" value="${order}" data-field="order" maxlength="6">
          <button class="mcard-fiche-btn" data-action="open-fiche" data-card-id="${cardId}" title="Ouvrir la fiche">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="${delayClass}" onclick="openDelaiMenu('${cardId}', event)"><span>${delayText}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move">Déplacer</button>
      <button class="mcard-btn mcard-btn-delete">Supprimer</button>
    </div>
  `;
  
  // Stocker les données avec tracking initial
  const today = new Date().toISOString().split('T')[0];
  const deptMap = {0:'robot', 1:'degauchage', 2:'essayage', 3:'atelier', 4:'couture', 5:'peinture', 6:'expedition'};
  const initialTracking = {};
  if (deptMap[columnIndex]) {
    initialTracking[deptMap[columnIndex]] = { entree: today };
  }
  
  cardsData[cardId] = {
    name, order, region,
    columnIndex,
    item,
    priority: 0,
    raisonAttente: '',
    dateRecue: today,
    dateRobot: columnIndex === 0 ? today : '',
    dateEssayage: '',
    dateLivraison: '',
    client: '',
    intervenant: '',
    representant: '',
    notes: '',
    tracking: initialTracking
  };
  
  // Ajouter à la colonne
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[columnIndex];
  if (targetCol) {
    const content = targetCol.querySelector('.col-content');
    if (content) content.appendChild(card);
  }
  
  // Attacher les événements
  attachCardEvents(card);
  updateColumnCounts();
  
  // Sauvegarder dans Firebase
  saveCardToFirebase(cardId);
  
  return cardId;
}

// Mise a jour compteurs colonnes
function updateColumnCounts() {
  COLUMNS.forEach(col => {
    const container = document.getElementById(col.contentId);
    const countEl = document.getElementById(col.countId);
    if (container && countEl) {
      countEl.textContent = container.querySelectorAll('.mcard').length;
    }
  });
}

// Rafraichir priorites
function refreshAllPriorities() {
  Object.keys(cardsData).forEach(cardId => {
    const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (card) {
      const badge = card.querySelector('.priority-badge');
      const priority = cardsData[cardId].priority || 0;
      if (badge) {
        if (priority > 0) {
          badge.textContent = priority;
          badge.className = `priority-badge p${priority}`;
        } else {
          badge.className = 'priority-badge hidden';
        }
      }
    }
  });
}

// Menu priorite
function openPriorityMenu(cardId, event) {
  event.stopPropagation();
  document.querySelector('.priority-menu')?.remove();
  
  const menu = document.createElement('div');
  menu.className = 'priority-menu';
  menu.innerHTML = `
    <div class="priority-menu-item" data-priority="0"><div class="priority-dot none">-</div>Aucune priorite</div>
    <div class="priority-menu-item" data-priority="1"><div class="priority-dot p1">1</div>Priorité 1 - URGENT</div>
    <div class="priority-menu-item" data-priority="2"><div class="priority-dot p2">2</div>Priorité 2 - Important</div>
    <div class="priority-menu-item" data-priority="3"><div class="priority-dot p3">3</div>Priorité 3 - À surveiller</div>
    <div class="priority-menu-item" data-priority="4"><div class="priority-dot p4">4</div>Priorité 4 - Normal+</div>
    <div class="priority-menu-item" data-priority="5"><div class="priority-dot p5">5</div>Priorité 5 - Basse</div>
  `;
  
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';
  document.body.appendChild(menu);
  
  menu.querySelectorAll('.priority-menu-item').forEach(item => {
    item.addEventListener('click', () => {
      const priority = parseInt(item.dataset.priority);
      if (cardsData[cardId]) {
        cardsData[cardId].priority = priority;
        saveCardToFirebase(cardId);
        refreshAllPriorities();
      }
      menu.remove();
    });
  });
  
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

// Variable pour stocker la carte à déplacer
let cardToMove = null;

// Menu deplacement avec rangs
function showMoveMenu(card) {
  cardToMove = card;
  const cardId = card.dataset.cardId;
  const currentCol = cardsData[cardId]?.columnIndex ?? 0;
  const moveColumns = document.getElementById('moveColumns');
  
  // Compter les cartes dans chaque colonne
  let html = '';
  COLUMNS.forEach((col, i) => {
    const cardsInCol = Object.values(cardsData).filter(c => c.columnIndex === i).length;
    const isCurrent = (i === currentCol);
    
    html += `
      <div class="move-column">
        <div class="move-column-header ${isCurrent ? 'current' : ''}">
          ${col.name}
        </div>
        <div class="move-positions">
    `;
    
    if (isCurrent) {
      html += `<div class="move-position-btn" style="opacity:0.4;cursor:default;font-size:7px;">Colonne actuelle</div>`;
    } else if (cardsInCol === 0) {
      html += `<button class="move-position-btn" data-col="${i}" data-pos="1">1</button>`;
    } else {
      const maxPos = cardsInCol + 1;
      for (let pos = 1; pos <= maxPos; pos++) {
        const isLast = (pos === maxPos);
        const posLabel = isLast ? `${pos} (dernier)` : pos;
        html += `<button class="move-position-btn" data-col="${i}" data-pos="${pos}">${posLabel}</button>`;
      }
    }
    
    html += `
        </div>
      </div>
    `;
  });
  
  moveColumns.innerHTML = html;
  
  // Ajouter les event listeners aux boutons de position
  moveColumns.querySelectorAll('.move-position-btn[data-col]').forEach(btn => {
    if (btn.tagName === 'BUTTON') {
      btn.addEventListener('click', () => {
        const targetCol = parseInt(btn.dataset.col);
        const targetPos = parseInt(btn.dataset.pos);
        moveCardToPosition(cardToMove, targetCol, targetPos);
        closeMoveMenu();
      });
    }
  });
  
  document.getElementById('moveOverlay').classList.remove('hidden');
}

function openMoveMenu(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) showMoveMenu(card);
}

function closeMoveMenu() {
  document.getElementById('moveOverlay').classList.add('hidden');
  cardToMove = null;
}

// Déplacer une carte vers une colonne à une position spécifique
function moveCardToPosition(card, targetColIndex, position) {
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[targetColIndex];
  const cardId = card.dataset.cardId;
  const currentColIndex = cardsData[cardId]?.columnIndex ?? -1;
  
  if (targetCol) {
    // Cibler le col-content pour l'insertion
    const targetContent = targetCol.querySelector('.col-content') || targetCol;
    const cardsInTarget = targetContent.querySelectorAll('.mcard');
    
    // Position 1 = premier, position 2 = après la 1ère carte, etc.
    if (position <= 1 || cardsInTarget.length === 0) {
      targetContent.insertBefore(card, cardsInTarget[0] || null);
    } else if (position > cardsInTarget.length) {
      targetContent.appendChild(card);
    } else {
      targetContent.insertBefore(card, cardsInTarget[position - 1]);
    }
    
    // Tracking automatique
    const today = new Date().toISOString().split('T')[0];
    const deptMap = {0:'robot', 1:'degauchage', 2:'essayage', 3:'atelier', 4:'couture', 5:'peinture', 6:'expedition'};
    
    // Si on quitte une colonne de département (0-6), marquer la sortie
    if (currentColIndex >= 0 && currentColIndex <= 6 && currentColIndex !== targetColIndex) {
      const deptKey = deptMap[currentColIndex];
      if (deptKey && cardsData[cardId]) {
        if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
        if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
        if (cardsData[cardId].tracking[deptKey].entree && !cardsData[cardId].tracking[deptKey].sortie) {
          cardsData[cardId].tracking[deptKey].sortie = today;
        }
      }
    }
    
    // Si on entre dans une colonne de département (0-6), marquer l'entrée
    if (targetColIndex >= 0 && targetColIndex <= 6) {
      const deptKey = deptMap[targetColIndex];
      if (deptKey && cardsData[cardId]) {
        if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
        if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
        if (!cardsData[cardId].tracking[deptKey].entree) {
          cardsData[cardId].tracking[deptKey].entree = today;
        }
      }
    }
    
    // Mettre à jour cardsData et sauvegarder
    if (cardsData[cardId]) {
      cardsData[cardId].columnIndex = targetColIndex;
      saveCardToFirebase(cardId);
    }
    
    updateColumnCounts();
    showToast('Déplacé vers ' + COLUMNS[targetColIndex].name + ' position ' + position);
  }
}

// ===== FICHE MOULAGE =====
let currentExpandedCard = null;
let cardOverlay = null;
let currentCalendarField = null;
let currentCalendarDate = new Date();

function openFiche(card) {
  if (!card) return;
  
  // Si c'est un ID, trouver la carte
  if (typeof card === 'string') {
    card = document.querySelector(`.mcard[data-card-id="${card}"]`);
    if (!card) return;
  }
  
  const cardId = card.dataset.cardId;
  
  // Si meme carte, ne rien faire
  if (currentExpandedCard === card) return;
  
  // Fermer la fiche precedente
  if (currentExpandedCard) {
    const prevCardId = currentExpandedCard.dataset.cardId;
    if (prevCardId && cardsData[prevCardId]) saveCardToFirebase(prevCardId);
    currentExpandedCard.classList.remove('mcard-expanded');
    currentExpandedCard = null;
  }
  
  // S'assurer que l'overlay existe
  if (!cardOverlay) cardOverlay = document.getElementById('cardOverlay');
  
  // Generer la fiche si pas deja fait
  if (!card.querySelector('.mcard-fiche')) {
    card.insertAdjacentHTML('beforeend', generateFicheHTML(card));
    attachFicheEvents(card);
  }
  
  // Ouvrir la fiche
  card.classList.add('mcard-expanded');
  if (cardOverlay) cardOverlay.classList.add('active');
  currentExpandedCard = card;
}

function closeFiche() {
  if (currentExpandedCard) {
    const cardId = currentExpandedCard.dataset.cardId;
    if (cardId && cardsData[cardId]) saveCardToFirebase(cardId);
    currentExpandedCard.classList.remove('mcard-expanded');
    
    // Fermer tous les menus et popups
    currentExpandedCard.querySelector('.photos-menu-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.notes-photos-links-panel')?.style.setProperty('display', 'none');
  }
  
  // Fermer les menus globaux
  document.getElementById('priorityMenu')?.remove();
  document.getElementById('delaiMenu')?.remove();
  document.getElementById('raisonAttenteMenu')?.remove();
  document.getElementById('trackingDatesMenu')?.remove();
  document.getElementById('fichePriorityMenu')?.remove();
  
  if (cardOverlay) cardOverlay.classList.remove('active');
  currentExpandedCard = null;
}

function generateFicheHTML(card) {
  const cardId = card.dataset.cardId;
  const data = cardsData[cardId] || {};
  
  const joursAttente = calcJoursAttente(data.dateAttente);
  const isEnAttente = data.columnIndex === 7;
  
  // Priorité
  const priorityLabels = {
    0: { text: '-- Aucune --', color: '#6b7280', emoji: '&#9898;' },
    1: { text: '#1 URGENT', color: '#ef4444', emoji: '&#128308;' },
    2: { text: '#2 Important', color: '#f97316', emoji: '&#128992;' },
    3: { text: '#3 À surveiller', color: '#eab308', emoji: '&#128993;' },
    4: { text: '#4 Normal+', color: '#22c55e', emoji: '&#128994;' },
    5: { text: '#5 Basse', color: '#3b82f6', emoji: '&#128309;' }
  };
  const currentPriority = data.priority || 0;
  const priorityInfo = priorityLabels[currentPriority] || priorityLabels[0];
  
  // Sidebar tracking
  const trackingHTML = generateTrackingSidebar(cardId, data);
  
  return `
    ${trackingHTML}
    <div class="mcard-fiche" data-card-id="${cardId}">
      <div class="fiche-header">
        <div class="fiche-logo"><img src="https://raw.githubusercontent.com/Physipro-list/Physipro-serie/main/logo-physiprodemi1.png" alt="PhysiPro"/></div>
        <div class="fiche-title"><h3>Fiche Moulage</h3></div>
        <div class="fiche-priority-btn" onclick="showFichePriorityMenu('${cardId}', event)" style="background: ${priorityInfo.color};">
          <span class="fiche-priority-emoji">${priorityInfo.emoji}</span>
          <span class="fiche-priority-text">Priorité</span>
        </div>
      </div>
      
      <div class="fiche-section">
        <div class="fiche-grid-2">
          <div class="fiche-field">
            <div class="fiche-label">Client</div>
            <select class="fiche-select" data-fiche-field="client">
              ${generateSelectOptions('moulageClients', data.client)}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Nom du moulage</div>
            <input type="text" class="fiche-input" data-fiche-field="name" value="${data.name || ''}" placeholder="Nom...">
          </div>
        </div>
        
        <div class="fiche-grid-3" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">N&#176; Soumission</div>
            <input type="text" class="fiche-input" data-fiche-field="numeroSoumission" value="${data.numeroSoumission || ''}" placeholder="Numéro...">
          </div>
          <div class="fiche-field">
            <div class="fiche-label">N&#176; PO</div>
            <input type="text" class="fiche-input" data-fiche-field="numeroPO" value="${data.numeroPO || ''}" placeholder="Numéro...">
          </div>
          <div class="fiche-field">
            <div class="fiche-label">N&#176; Commande</div>
            <input type="text" class="fiche-input" data-fiche-field="order" value="${data.order || ''}" placeholder="000000" maxlength="6">
          </div>
        </div>
        
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Région</div>
            <select class="fiche-select" data-fiche-field="region">
              ${generateSelectOptions('regions', data.region)}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Intervenant</div>
            <select class="fiche-select" data-fiche-field="intervenant">
              ${generateSelectOptions('intervenants', data.intervenant)}
            </select>
          </div>
        </div>
        
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Représentante</div>
            <select class="fiche-select" data-fiche-field="representant">
              ${generateSelectOptions('representantes', data.representant)}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date RDV essayage</div>
            <div class="fiche-date-pill" data-fiche-field="dateEssayage" onclick="openCalendar('${cardId}', 'dateEssayage', this)">${data.dateEssayage || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
        
        <div class="fiche-grid-3" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Date reçue</div>
            <div class="fiche-date-pill" data-fiche-field="dateRecue" onclick="openCalendar('${cardId}', 'dateRecue', this)">${data.dateRecue || 'AAAA-MM-JJ'}</div>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date fabriquée robot</div>
            <div class="fiche-date-pill" data-fiche-field="dateRobot" onclick="openCalendar('${cardId}', 'dateRobot', this)">${data.dateRobot || 'AAAA-MM-JJ'}</div>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">&#128230; Date livraison</div>
            <div class="fiche-date-pill" data-fiche-field="dateLivraison" onclick="openCalendar('${cardId}', 'dateLivraison', this)">${data.dateLivraison || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
      </div>
      
      <div class="fiche-attente-section ${isEnAttente ? 'visible' : ''}">
        <div class="attente-badge-full">&#9203; EN ATTENTE: ${data.raisonAttente || 'Raison non specifiee'}</div>
        <div class="attente-days-full">En attente depuis ${data.dateAttente || '---'} (${joursAttente} jours)</div>
      </div>
      
      <div class="fiche-photos-section">
        <div class="photos-row">
          <span class="photos-label" onclick="togglePhotosMenu('${cardId}')" style="cursor:pointer;"><span class="camera-icon">&#128247;</span> Liens</span>
          <button class="photo-btn ${data.photoClient ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'Client', event)">Client</button>
          <button class="photo-btn ${data.photoAtelier ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'Atelier', event)">Atelier</button>
          <button class="photo-btn ${data.photoDevis ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'Devis', event)">Devis/Modif</button>
        </div>
      </div>
      
      <!-- Menu Photos popup -->
      <div class="photos-menu-popup" id="photosMenuPopup_${cardId}">
        <div class="photos-menu-header">&#128247; Gérer les liens photos</div>
        <div class="photos-menu-field">
          <label>Client:</label>
          <input type="url" id="photoLinkClient_${cardId}" value="${data.photoClient || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Atelier:</label>
          <input type="url" id="photoLinkAtelier_${cardId}" value="${data.photoAtelier || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Devis/Modif:</label>
          <input type="url" id="photoLinkDevis_${cardId}" value="${data.photoDevis || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-btns">
          <button onclick="saveAllPhotoLinks('${cardId}')">&#128190; Enregistrer</button>
          <button onclick="closePhotosMenu('${cardId}')">Fermer</button>
        </div>
      </div>
      
    </div>
    
    <div class="mcard-notes-page" data-card-id="${cardId}">
      <div class="notes-page-header">
        <span class="notes-header-left" onclick="toggleNotesPhotosPanel('${cardId}')" title="Gérer les liens photos"><span class="camera-icon">&#128247;</span> Liens</span>
        <span class="notes-header-center">&#128221; Notes</span>
        <button class="notes-close-btn" onclick="closeFiche()" title="Fermer">&#10005;</button>
      </div>
      
      <!-- Panneau liens photos (cache par defaut) -->
      <div class="notes-photos-links-panel" id="notesPhotosPanel_${cardId}">
        <div class="notes-photo-link-row">
          <label>Photo 1:</label>
          <input type="url" id="notePhotoLink1_${cardId}" value="${data.notePhoto1 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 2:</label>
          <input type="url" id="notePhotoLink2_${cardId}" value="${data.notePhoto2 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 3:</label>
          <input type="url" id="notePhotoLink3_${cardId}" value="${data.notePhoto3 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 4:</label>
          <input type="url" id="notePhotoLink4_${cardId}" value="${data.notePhoto4 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 5:</label>
          <input type="url" id="notePhotoLink5_${cardId}" value="${data.notePhoto5 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 6:</label>
          <input type="url" id="notePhotoLink6_${cardId}" value="${data.notePhoto6 || ''}" placeholder="https://...">
        </div>
        <button class="notes-save-photos-btn" onclick="saveNotesPhotoLinks('${cardId}')">&#128190; Enregistrer les liens</button>
      </div>
      
      <div class="notes-photos-row">
        <button class="notes-photo-btn ${data.notePhoto1 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 1)">Photo 1</button>
        <button class="notes-photo-btn ${data.notePhoto2 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 2)">Photo 2</button>
        <button class="notes-photo-btn ${data.notePhoto3 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 3)">Photo 3</button>
        <button class="notes-photo-btn ${data.notePhoto4 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 4)">Photo 4</button>
        <button class="notes-photo-btn ${data.notePhoto5 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 5)">Photo 5</button>
        <button class="notes-photo-btn ${data.notePhoto6 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 6)">Photo 6</button>
      </div>
      <textarea class="notes-page-textarea" id="notesTextarea_${cardId}" 
        placeholder="Cliquez ici pour écrire..."
        onfocus="prepareNoteWithSignature('${cardId}')"
        onblur="saveMoulageNotes('${cardId}')">${data.notes || ''}</textarea>
    </div>
  `;
}

function generateTrackingSidebar(cardId, data) {
  const depts = [
    { key: 'robot', name: 'Robot', icon: '⚙' },
    { key: 'degauchage', name: 'Dégauchage', icon: '&#128736;' },
    { key: 'essayage', name: 'Essayage', icon: '&#128090;' },
    { key: 'atelier', name: 'Atelier', icon: '&#128295;' },
    { key: 'couture', name: 'Couture', icon: '&#129697;' },
    { key: 'peinture', name: 'Peinture', icon: '&#127912;' },
    { key: 'expedition', name: 'Expédition', icon: '&#128230;' }
  ];
  
  const tracking = data.tracking || {};
  const currentDept = getDeptFromColumn(data.columnIndex);
  
  let html = '<div class="mcard-tracking-sidebar"><div class="tracking-sidebar-title">Suivi</div><div class="tracking-pills-container">';
  
  depts.forEach(dept => {
    const deptData = tracking[dept.key] || {};
    const isActive = dept.key === currentDept;
    const isCompleted = deptData.entree && deptData.sortie;
    const jours = isCompleted ? calcJoursOuvrables(deptData.entree, deptData.sortie) : (deptData.entree ? calcJoursOuvrables(deptData.entree, new Date().toISOString().split('T')[0]) : '-');
    
    let pillClass = 'tracking-dept-pill';
    if (isActive) pillClass += ' active';
    if (isCompleted) pillClass += ' completed';
    
    html += `
      <div class="${pillClass}" onclick="openTrackingDatesMenu('${cardId}', '${dept.key}', '${dept.icon} ${dept.name}', event)" style="cursor:pointer;">
        <span class="tracking-pill-icon">${dept.icon}</span>
        <span class="tracking-pill-name">${dept.name}</span>
        <span class="tracking-pill-jours">${jours}</span>
      </div>
    `;
  });
  
  html += '</div></div>';
  return html;
}

function getDeptFromColumn(colIndex) {
  const map = { 0: 'robot', 1: 'degauchage', 2: 'essayage', 3: 'atelier', 4: 'couture', 5: 'peinture', 6: 'expedition' };
  return map[colIndex] || null;
}

function calcJoursOuvrables(dateDebut, dateFin) {
  if (!dateDebut || !dateFin) return 0;
  const debut = new Date(dateDebut + 'T00:00:00');
  const fin = new Date(dateFin + 'T00:00:00');
  if (isNaN(debut.getTime()) || isNaN(fin.getTime())) return 0;
  return compterJoursOuvrables(debut, fin);
}

function calcJoursAttente(dateAttente) {
  if (!dateAttente) return 0;
  const debut = new Date(dateAttente + 'T00:00:00');
  const fin = new Date();
  fin.setHours(0, 0, 0, 0);
  if (isNaN(debut.getTime())) return 0;
  return Math.floor((fin - debut) / (1000 * 60 * 60 * 24));
}

function attachFicheEvents(card) {
  const cardId = card.dataset.cardId;
  
  // Inputs et selects - modification directe sans confirmation
  card.querySelectorAll('.fiche-input, .fiche-select').forEach(el => {
    el.addEventListener('change', () => {
      const field = el.dataset.ficheField;
      if (field && cardsData[cardId]) {
        cardsData[cardId][field] = el.value;
        
        // Si region change, mettre a jour la carte
        if (field === 'region') {
          card.classList.remove('region-qc', 'region-on', 'region-ma');
          if (el.value === 'Quebec' || el.value === 'Québec') card.classList.add('region-qc');
          else if (el.value === 'Canada anglais' || el.value === 'Ontario') card.classList.add('region-on');
          else if (el.value === 'Maritime') card.classList.add('region-ma');
        }
        
        // Si nom change, mettre a jour le titre
        if (field === 'name') {
          const titleInput = card.querySelector('.mcard-title');
          if (titleInput) titleInput.value = el.value;
        }
        
        // Si order change, mettre a jour le numero
        if (field === 'order') {
          const orderInput = card.querySelector('.mcard-order');
          if (orderInput) orderInput.value = el.value;
        }
        
        saveCardToFirebase(cardId);
      }
    });
  });
}

// ===== CALENDRIER GLOBAL =====
let currentCalendarCardId = null;
let currentCalendarElement = null;
let gcalCurrentDate = new Date();

function openCalendar(cardId, field, element) {
  currentCalendarCardId = cardId;
  currentCalendarField = field;
  currentCalendarElement = element;
  
  // Définir la date courante
  const currentValue = cardsData[cardId]?.[field];
  if (currentValue && currentValue !== 'AAAA-MM-JJ') {
    gcalCurrentDate = new Date(currentValue + 'T00:00:00');
  } else {
    gcalCurrentDate = new Date();
  }
  
  // Afficher le calendrier global
  renderGlobalCalendar();
  document.getElementById('globalCalendarOverlay').classList.add('active');
  document.getElementById('globalCalendarPopup').classList.add('active');
}

function closeGlobalCalendar() {
  document.getElementById('globalCalendarOverlay')?.classList.remove('active');
  document.getElementById('globalCalendarPopup')?.classList.remove('active');
  currentCalendarCardId = null;
  currentCalendarField = null;
  currentCalendarElement = null;
}

function renderGlobalCalendar() {
  const monthYearEl = document.getElementById('gcalMonthYear');
  const daysEl = document.getElementById('gcalDays');
  
  if (!monthYearEl || !daysEl) return;
  
  const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  monthYearEl.textContent = months[gcalCurrentDate.getMonth()] + ' ' + gcalCurrentDate.getFullYear();
  
  const firstDay = new Date(gcalCurrentDate.getFullYear(), gcalCurrentDate.getMonth(), 1);
  const lastDay = new Date(gcalCurrentDate.getFullYear(), gcalCurrentDate.getMonth() + 1, 0);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Valeur sélectionnée
  let selectedDate = null;
  if (currentCalendarCardId && currentCalendarField) {
    const val = cardsData[currentCalendarCardId]?.[currentCalendarField];
    if (val && val !== 'AAAA-MM-JJ') {
      selectedDate = new Date(val + 'T00:00:00');
      selectedDate.setHours(0, 0, 0, 0);
    }
  }
  
  daysEl.innerHTML = '';
  
  // Jours du mois précédent
  for (let i = 0; i < firstDay.getDay(); i++) {
    const d = new Date(firstDay);
    d.setDate(d.getDate() - (firstDay.getDay() - i));
    const btn = document.createElement('button');
    btn.className = 'gcal-day other-month';
    btn.textContent = d.getDate();
    const year = d.getFullYear(), month = d.getMonth(), day = d.getDate();
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      selectGlobalCalDate(year, month, day);
    });
    daysEl.appendChild(btn);
  }
  
  // Jours du mois
  for (let d = 1; d <= lastDay.getDate(); d++) {
    const date = new Date(gcalCurrentDate.getFullYear(), gcalCurrentDate.getMonth(), d);
    date.setHours(0, 0, 0, 0);
    
    const btn = document.createElement('button');
    btn.className = 'gcal-day';
    if (date.getTime() === today.getTime()) btn.classList.add('today');
    if (selectedDate && date.getTime() === selectedDate.getTime()) btn.classList.add('selected');
    btn.textContent = d;
    const year = gcalCurrentDate.getFullYear(), month = gcalCurrentDate.getMonth(), day = d;
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      selectGlobalCalDate(year, month, day);
    });
    daysEl.appendChild(btn);
  }
}

function navigateGlobalCalendar(direction) {
  gcalCurrentDate.setMonth(gcalCurrentDate.getMonth() + direction);
  renderGlobalCalendar();
}

function selectGlobalCalDate(year, month, day) {
  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  
  if (currentCalendarCardId && currentCalendarField && cardsData[currentCalendarCardId]) {
    cardsData[currentCalendarCardId][currentCalendarField] = dateStr;
    saveCardToFirebase(currentCalendarCardId);
    
    if (currentCalendarElement) {
      currentCalendarElement.textContent = dateStr;
    }
  }
  
  closeGlobalCalendar();
}

function selectCalendarToday() {
  const today = new Date();
  selectGlobalCalDate(today.getFullYear(), today.getMonth(), today.getDate());
}

// Initialiser les événements du calendrier global
function initGlobalCalendar() {
  const popup = document.getElementById('globalCalendarPopup');
  const overlay = document.getElementById('globalCalendarOverlay');
  
  // Empêcher les clics dans le popup de remonter
  popup?.addEventListener('click', function(e) {
    e.stopPropagation();
  });
  
  // Navigation
  document.getElementById('gcalPrev')?.addEventListener('click', function(e) {
    e.stopPropagation();
    navigateGlobalCalendar(-1);
  });
  document.getElementById('gcalNext')?.addEventListener('click', function(e) {
    e.stopPropagation();
    navigateGlobalCalendar(1);
  });
  
  // Boutons d'action
  document.getElementById('gcalToday')?.addEventListener('click', function(e) {
    e.stopPropagation();
    selectCalendarToday();
  });
  
  // Bouton X pour fermer
  document.getElementById('gcalCloseX')?.addEventListener('click', function(e) {
    e.stopPropagation();
    closeGlobalCalendar();
  });
  
  // Overlay ferme le calendrier
  overlay?.addEventListener('click', function(e) {
    e.stopPropagation();
    closeGlobalCalendar();
  });
}

// Photos
function openPhotoLink(cardId, field) {
  const currentUrl = cardsData[cardId]?.[field] || '';
  if (currentUrl) {
    window.open(currentUrl, '_blank');
  } else {
    const newUrl = prompt('Entrer le lien pour ' + field + ':', '');
    if (newUrl) {
      cardsData[cardId][field] = newUrl;
      saveCardToFirebase(cardId);
      // Mettre a jour le bouton
      const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
      if (card) {
        const btn = card.querySelector(`.photo-btn[onclick*="${field}"]`);
        if (btn) btn.classList.add('has-link');
      }
    }
  }
}

// ===== MENU PHOTOS FICHE =====
function togglePhotosMenu(cardId) {
  const popup = document.getElementById('photosMenuPopup_' + cardId);
  if (popup) {
    popup.classList.toggle('active');
  }
}

function closePhotosMenu(cardId) {
  const popup = document.getElementById('photosMenuPopup_' + cardId);
  if (popup) {
    popup.classList.remove('active');
  }
}

function saveAllPhotoLinks(cardId) {
  if (!cardsData[cardId]) return;
  
  const photoClient = document.getElementById('photoLinkClient_' + cardId)?.value || '';
  const photoAtelier = document.getElementById('photoLinkAtelier_' + cardId)?.value || '';
  const photoDevis = document.getElementById('photoLinkDevis_' + cardId)?.value || '';
  
  cardsData[cardId].photoClient = photoClient;
  cardsData[cardId].photoAtelier = photoAtelier;
  cardsData[cardId].photoDevis = photoDevis;
  
  saveCardToFirebase(cardId);
  
  // Mettre a jour les boutons
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    const btns = card.querySelectorAll('.photo-btn');
    btns.forEach(btn => {
      const onclick = btn.getAttribute('onclick') || '';
      if (onclick.includes('Client')) btn.classList.toggle('has-link', !!photoClient);
      if (onclick.includes('Atelier')) btn.classList.toggle('has-link', !!photoAtelier);
      if (onclick.includes('Devis')) btn.classList.toggle('has-link', !!photoDevis);
    });
  }
  
  closePhotosMenu(cardId);
  showToast('Liens photos enregistrés');
}

function openPhotoFromPill(cardId, photoType, event) {
  if (event) event.stopPropagation();
  
  const fieldName = 'photo' + photoType;
  const url = cardsData[cardId]?.[fieldName];
  
  if (url) {
    window.open(url, '_blank');
  } else {
    showToast('❌ ' + photoType + ': Aucun lien à afficher');
  }
}

// ===== PANNEAU PHOTOS NOTES =====
function toggleNotesPhotosPanel(cardId) {
  const panel = document.getElementById('notesPhotosPanel_' + cardId);
  if (panel) {
    panel.classList.toggle('active');
  }
}

function saveNotesPhotoLinks(cardId) {
  if (!cardsData[cardId]) return;
  
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('notePhotoLink' + i + '_' + cardId);
    if (input) {
      cardsData[cardId]['notePhoto' + i] = input.value || '';
    }
  }
  
  saveCardToFirebase(cardId);
  
  // Mettre a jour les boutons
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    const btns = card.querySelectorAll('.notes-photo-btn');
    btns.forEach((btn, idx) => {
      const hasLink = !!cardsData[cardId]['notePhoto' + (idx + 1)];
      btn.classList.toggle('has-link', hasLink);
    });
  }
  
  toggleNotesPhotosPanel(cardId);
  showToast('Liens photos notes enregistrés');
}

function openNotePhoto(cardId, photoNum) {
  const fieldName = 'notePhoto' + photoNum;
  const url = cardsData[cardId]?.[fieldName] || '';
  
  if (url) {
    window.open(url, '_blank');
  } else {
    showToast('❌ Photo ' + photoNum + ': Aucun lien à afficher');
  }
}

// ===== SIGNATURE NOTES =====
function getCurrentUserName() {
  return currentUser?.name || 'Utilisateur';
}

function isRepresentante() {
  const name = getCurrentUserName();
  const reps = ['Marie-Soleil', 'Marie-Pier', 'Multipass', 'Fabrys'];
  return reps.some(r => name.toLowerCase().includes(r.toLowerCase()));
}

function prepareNoteWithSignature(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  let currentText = textarea.value;
  
  // Si representante et premiere visite, ajouter "Note vue par..."
  if (isRepresentante()) {
    const viewedMarker = 'Note vue par ' + userName;
    if (!currentText.includes(viewedMarker)) {
      const viewedLine = `*** ${viewedMarker} (${dateStr} a ${timeStr}) ***`;
      if (currentText.trim()) {
        currentText = currentText.trimEnd() + '\n\n' + viewedLine + '\n';
      } else {
        currentText = viewedLine + '\n';
      }
      textarea.value = currentText;
      // Marquer comme lu
      markNoteAsRead(cardId);
    }
  }
  
  // Ajouter signature normale
  const signature = '-- ' + userName + ' (' + dateStr + ' a ' + timeStr + ') --';
  
  // Verifier si la derniere signature est la meme (meme minute)
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('-- ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    const match = lastSignatureLine.match(/-- .+ \((\d{4}-\d{2}-\d{2}) a (\d{2}:\d{2})\) --/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  // Placer le curseur a la fin
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

function markNoteAsRead(cardId) {
  if (!cardsData[cardId]) return;
  
  const currentUser = getCurrentUserName();
  
  if (!cardsData[cardId].notesUnread) {
    cardsData[cardId].notesUnread = {};
  }
  cardsData[cardId].notesUnread[currentUser] = false;
  saveCardToFirebase(cardId);
}

// Notes
function saveMoulageNotes(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (textarea && cardsData[cardId]) {
    cardsData[cardId].notes = textarea.value;
    saveCardToFirebase(cardId);
  }
}

// ===== MENU TRACKING DATES =====
function formatDateFull(dateStr) {
  if (!dateStr) return 'Cliquer pour définir';
  const d = new Date(dateStr);
  const day = d.getDate().toString().padStart(2, '0');
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  const year = d.getFullYear();
  return day + '/' + month + '/' + year;
}

function openTrackingDatesMenu(cardId, deptKey, deptName, event) {
  event.stopPropagation();
  
  // Fermer tout menu existant
  document.getElementById('trackingDatesMenu')?.remove();
  
  const data = cardsData[cardId] || {};
  const tracking = data.tracking?.[deptKey] || {};
  const entree = tracking.entree || '';
  const sortie = tracking.sortie || '';
  
  const entreeDisplay = entree ? formatDateFull(entree) : 'Cliquer pour définir';
  const sortieDisplay = sortie ? formatDateFull(sortie) : 'Cliquer pour définir';
  
  const menu = document.createElement('div');
  menu.id = 'trackingDatesMenu';
  menu.className = 'tracking-dates-menu';
  
  menu.innerHTML = 
    '<div class="tracking-menu-header">' + deptName + '</div>' +
    '<div class="tracking-menu-row">' +
      '<span class="tracking-menu-label">Entree:</span>' +
      '<span class="tracking-menu-date" onclick="setTrackingDate(\'' + cardId + '\', \'' + deptKey + '\', \'entree\')">' + entreeDisplay + '</span>' +
    '</div>' +
    '<div class="tracking-menu-row">' +
      '<span class="tracking-menu-label">Sortie:</span>' +
      '<span class="tracking-menu-date" onclick="setTrackingDate(\'' + cardId + '\', \'' + deptKey + '\', \'sortie\')">' + sortieDisplay + '</span>' +
    '</div>' +
    '<div class="tracking-menu-footer">' +
      '<button onclick="document.getElementById(\'trackingDatesMenu\')?.remove()">Fermer</button>' +
    '</div>';
  
  document.body.appendChild(menu);
  
  // Mesurer la hauteur reelle du menu
  const menuHeight = menu.offsetHeight || 150;
  const menuWidth = menu.offsetWidth || 200;
  
  // Trouver la sidebar tracking pour positionner a droite
  const sidebar = event.target.closest('.mcard-tracking-sidebar');
  const sidebarRect = sidebar ? sidebar.getBoundingClientRect() : null;
  const pillRect = event.target.closest('.tracking-dept-pill').getBoundingClientRect();
  
  // Position horizontale: a droite de la sidebar
  let leftPos;
  if (sidebarRect) {
    leftPos = sidebarRect.right + 5;
  } else {
    leftPos = pillRect.right + 10;
  }
  
  // Si depasse a droite, mettre a gauche
  if (leftPos + menuWidth > window.innerWidth - 10) {
    leftPos = Math.max(10, pillRect.left - menuWidth - 10);
  }
  
  // Position verticale: centrer sur la pastille, mais TOUJOURS rester dans l'ecran
  const pillCenterY = pillRect.top + (pillRect.height / 2);
  let topPos = pillCenterY - (menuHeight / 2);
  
  // S'assurer que le menu reste TOUJOURS visible
  const minTop = 50; // Marge du haut
  const maxTop = window.innerHeight - menuHeight - 20; // Marge du bas
  
  if (topPos < minTop) {
    topPos = minTop;
  }
  if (topPos > maxTop) {
    topPos = maxTop;
  }
  
  menu.style.left = leftPos + 'px';
  menu.style.top = topPos + 'px';
}

function setTrackingDate(cardId, deptKey, dateType) {
  const today = new Date().toISOString().split('T')[0];
  const currentDate = cardsData[cardId]?.tracking?.[deptKey]?.[dateType];
  
  const newDate = prompt('Entrer la date (' + dateType + '):\nFormat: AAAA-MM-JJ\n\nLaisser vide pour aujourdhui', currentDate || today);
  
  if (newDate !== null) {
    if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
    if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
    
    cardsData[cardId].tracking[deptKey][dateType] = newDate || today;
    saveCardToFirebase(cardId);
    
    // Fermer le menu et rafraichir la fiche
    document.getElementById('trackingDatesMenu')?.remove();
    
    // Mettre a jour l'affichage dans le menu si encore ouvert
    const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (card && card.classList.contains('mcard-expanded')) {
      // Regenerer la sidebar tracking
      const sidebar = card.querySelector('.mcard-tracking-sidebar');
      if (sidebar) {
        const newSidebar = document.createElement('div');
        newSidebar.innerHTML = generateTrackingSidebar(cardId, cardsData[cardId]);
        sidebar.replaceWith(newSidebar.firstElementChild);
      }
    }
    
    showToast('Date ' + dateType + ' mise a jour');
  }
}

// ===== GESTION DES LISTES PERSONNALISABLES =====

function loadCustomLists() {
  const listsRef = firebaseDb.ref('customLists');
  listsRef.once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      for (const key in data) {
        if (Array.isArray(data[key])) {
          customLists[key] = data[key];
          // Trier alphabetiquement
          customLists[key].sort((a, b) => a.localeCompare(b, 'fr'));
        }
      }
      console.log('Listes chargees depuis Firebase');
    }
  }).catch(err => {
    // Si erreur de permission, utiliser les valeurs par défaut silencieusement
    if (err.message && err.message.includes('permission_denied')) {
      console.log('Listes: utilisation des valeurs par défaut (permissions Firebase)');
    } else {
      console.error('Erreur chargement listes:', err);
    }
  });
}

function saveCustomLists() {
  return new Promise((resolve, reject) => {
    firebaseDb.ref('customLists').set(customLists)
      .then(() => {
        console.log('Listes sauvegardees');
        resolve();
      })
      .catch(err => {
        // Si erreur de permission, ignorer silencieusement
        if (err.message && err.message.includes('permission_denied')) {
          console.log('Listes: sauvegarde locale uniquement (permissions Firebase)');
          resolve(); // Ne pas bloquer l'application
        } else {
          console.error('Erreur sauvegarde listes:', err);
          reject(err);
        }
      });
  });
}

function openListManager(listKey, title) {
  currentListKey = listKey;
  currentListTitle = title;
  
  const overlay = document.getElementById('listManagerOverlay');
  const titleEl = document.getElementById('listManagerTitle');
  const inputEl = document.getElementById('listManagerNewItem');
  
  titleEl.innerHTML = '⚙ Gérer les ' + title + 's';
  inputEl.value = '';
  
  renderListItems();
  overlay.classList.remove('hidden');
}

function renderListItems() {
  const itemsEl = document.getElementById('listManagerItems');
  const list = customLists[currentListKey] || [];
  
  // Si plus de 8 items, afficher sur 2 colonnes
  if (list.length > 8) {
    itemsEl.style.display = 'grid';
    itemsEl.style.gridTemplateColumns = '1fr 1fr';
    itemsEl.style.gap = '8px';
  } else {
    itemsEl.style.display = 'flex';
    itemsEl.style.flexDirection = 'column';
    itemsEl.style.gap = '8px';
  }
  
  if (list.length === 0) {
    itemsEl.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.5);font-size:13px;">Aucune valeur dans cette liste.<br>Ajoutez-en une ci-dessous!</div>';
    return;
  }
  
  itemsEl.innerHTML = list.map((item, index) => 
    '<div class="list-manager-item" data-index="' + index + '">' +
      '<span class="item-index">#' + (index + 1) + '</span>' +
      '<span class="item-name">' + item + '</span>' +
      '<button class="btn-remove-item" onclick="removeListItem(' + index + ')" title="Supprimer">&#10005;</button>' +
    '</div>'
  ).join('');
}

function addListItem() {
  const inputEl = document.getElementById('listManagerNewItem');
  const value = inputEl.value.trim();
  
  if (!value) {
    showListToast('&#10060; Veuillez entrer une valeur', false);
    return;
  }
  
  if (!customLists[currentListKey]) {
    customLists[currentListKey] = [];
  }
  
  // Verifier si deja existant
  if (customLists[currentListKey].includes(value)) {
    showListToast('&#9888; Cette valeur existe déjà!', false);
    return;
  }
  
  // Ajouter et trier alphabetiquement
  customLists[currentListKey].push(value);
  customLists[currentListKey].sort((a, b) => a.localeCompare(b, 'fr'));
  
  inputEl.value = '';
  renderListItems();
  
  // Effet visuel sur l'element ajoute
  const newIndex = customLists[currentListKey].indexOf(value);
  const items = document.querySelectorAll('.list-manager-item');
  if (items[newIndex]) {
    items[newIndex].classList.add('just-added');
    // Scroll vers l'element ajoute
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  // Afficher le toast IMMEDIATEMENT
  showListToast('&#10004; "' + value + '" AJOUTÉ!', true);
  
  // Sauvegarder en arriere-plan
  saveCustomLists().then(() => {
    updateAllSelectsFromLists();
  });
  
  inputEl.focus();
}

function removeListItem(index) {
  if (!customLists[currentListKey]) return;
  
  const item = customLists[currentListKey][index];
  if (confirm('Supprimer "' + item + '" de la liste?')) {
    // Animation
    const items = document.querySelectorAll('.list-manager-item');
    if (items[index]) {
      items[index].classList.add('just-removed');
    }
    
    setTimeout(() => {
      customLists[currentListKey].splice(index, 1);
      renderListItems();
      
      // Afficher le toast IMMEDIATEMENT
      showListToast('&#128465; "' + item + '" SUPPRIMÉ!', false);
      
      // Sauvegarder en arriere-plan
      saveCustomLists().then(() => {
        updateAllSelectsFromLists();
      });
    }, 300);
  }
}

function closeListManager() {
  const overlay = document.getElementById('listManagerOverlay');
  if (overlay) {
    overlay.classList.add('hidden');
  }
  // Forcer la mise a jour des selects a la fermeture
  if (currentListKey) {
    updateAllSelectsFromLists();
  }
}

// Mettre a jour tous les selects ouverts avec les nouvelles listes
function updateAllSelectsFromLists() {
  // Mapping champ -> liste
  const fieldToList = {
    'client': 'moulageClients',
    'region': 'regions',
    'intervenant': 'intervenants',
    'representant': 'representantes'
  };
  
  // Fonction pour mettre a jour les selects d'une carte
  function updateCardSelects(card) {
    if (!card) return;
    const cardId = card.dataset.cardId;
    const data = cardsData[cardId] || {};
    
    card.querySelectorAll('.fiche-select[data-fiche-field]').forEach(select => {
      const field = select.dataset.ficheField;
      const listKey = fieldToList[field];
      
      if (listKey && customLists[listKey]) {
        const currentValue = select.value || data[field] || '';
        select.innerHTML = generateSelectOptions(listKey, currentValue);
      }
    });
  }
  
  // Chercher TOUTES les fiches ouvertes par classe
  document.querySelectorAll('.mcard.mcard-expanded').forEach(updateCardSelects);
  
  // Aussi utiliser currentExpandedCard directement (au cas ou)
  if (currentExpandedCard) {
    updateCardSelects(currentExpandedCard);
  }
}

// Afficher un toast de confirmation pour les listes (TRES VISIBLE)
function showListToast(message, isSuccess = true) {
  // Supprimer les toasts existants
  document.querySelectorAll('.list-toast').forEach(t => t.remove());
  
  const toast = document.createElement('div');
  toast.className = 'list-toast';
  
  // Couleur de fond
  const bgColor = isSuccess ? '#22c55e' : '#ef4444';
  
  // Style inline DIRECT - pas d'animation
  toast.style.cssText = `
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    padding: 40px 80px !important;
    border-radius: 20px !important;
    font-size: 28px !important;
    font-weight: 900 !important;
    color: white !important;
    z-index: 9999999 !important;
    text-align: center !important;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8) !important;
    border: 5px solid white !important;
    min-width: 400px !important;
    background: ${bgColor} !important;
    opacity: 1 !important;
    visibility: visible !important;
  `;
  
  toast.innerHTML = message;
  document.body.appendChild(toast);
  
  // Disparaitre apres 5 secondes
  setTimeout(() => {
    toast.remove();
  }, 5000);
}

// Generer les options d'un select a partir d'une liste
function generateSelectOptions(listKey, selectedValue) {
  const list = customLists[listKey] || [];
  let html = '<option value="">-- Sélectionner --</option>';
  list.forEach(item => {
    const selected = (item === selectedValue) ? 'selected' : '';
    html += '<option value="' + item + '" ' + selected + '>' + item + '</option>';
  });
  return html;
}

// Menu priorite fiche
function showFichePriorityMenu(cardId, event) {
  event.stopPropagation();
  document.querySelector('.fiche-priority-menu')?.remove();
  
  const menu = document.createElement('div');
  menu.className = 'fiche-priority-menu';
  menu.style.cssText = 'position:fixed;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.25);z-index:10001;min-width:180px;';
  menu.innerHTML = `
    <div class="fiche-priority-menu-item" data-priority="0" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#6b7280;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">-</div>Aucune
    </div>
    <div class="fiche-priority-menu-item" data-priority="1" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#ef4444;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">1</div>#1 URGENT
    </div>
    <div class="fiche-priority-menu-item" data-priority="2" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#f97316;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">2</div>#2 Important
    </div>
    <div class="fiche-priority-menu-item" data-priority="3" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#eab308;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">3</div>#3 À surveiller
    </div>
    <div class="fiche-priority-menu-item" data-priority="4" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#22c55e;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">4</div>#4 Normal+
    </div>
    <div class="fiche-priority-menu-item" data-priority="5" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;">
      <div style="width:16px;height:16px;border-radius:50%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">5</div>#5 Basse
    </div>
  `;
  
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';
  document.body.appendChild(menu);
  
  menu.querySelectorAll('.fiche-priority-menu-item').forEach(item => {
    item.addEventListener('mouseover', () => item.style.background = '#f1f5f9');
    item.addEventListener('mouseout', () => item.style.background = '');
    item.addEventListener('click', () => {
      const priority = parseInt(item.dataset.priority);
      if (cardsData[cardId]) {
        cardsData[cardId].priority = priority;
        saveCardToFirebase(cardId);
        refreshAllPriorities();
        
        // Mettre a jour le bouton priorite dans la fiche
        const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        if (card) {
          const btn = card.querySelector('.fiche-priority-btn');
          if (btn) {
            const colors = { 0: '#6b7280', 1: '#ef4444', 2: '#f97316', 3: '#eab308', 4: '#22c55e', 5: '#3b82f6' };
            btn.style.background = colors[priority];
          }
        }
      }
      menu.remove();
    });
  });
  
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

// Utilitaires
function showToast(msg, err = false) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const toast = document.createElement('div');
  toast.className = 'toast' + (err ? ' error' : '');
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('visible'), 10);
  setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 2500);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  // 1. Initialiser Firebase
  if (!initFirebase()) {
    loginError.textContent = "Erreur serveur - rechargez la page";
    return;
  }
  
  // 2. Charger email/password sauvegardés
  loadSavedCredentials();
  
  // 3. Event listener formulaire login
  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    attemptLogin();
  });
  loginEmail.addEventListener('keydown', e => { if (e.key === 'Enter') loginPassword.focus(); });
  
  // 4. Vérifier si déjà connecté
  firebaseAuth.onAuthStateChanged(user => {
    if (user && USERS[user.email]) {
      loginSuccess(USERS[user.email], user.email);
    }
  });
  
  // 5. Autres event listeners
  document.getElementById('btnSettings')?.addEventListener('click', () => document.getElementById('settingsOverlay').classList.remove('hidden'));
  document.getElementById('settingsCloseBtn')?.addEventListener('click', () => document.getElementById('settingsOverlay').classList.add('hidden'));
  document.getElementById('settingsOverlay')?.addEventListener('click', e => { if (e.target.id === 'settingsOverlay') document.getElementById('settingsOverlay').classList.add('hidden'); });
  document.getElementById('btnLogout')?.addEventListener('click', logout);
  
  const btnAddMoulage = document.getElementById('btnAddMoulage');
  if (btnAddMoulage) btnAddMoulage.addEventListener('click', () => showAddMoulageModal());
  
  document.getElementById('searchInput').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.getElementById('searchClear').classList.toggle('hidden', !q);
    
    // Déterminer quelle page est active
    const activePage = document.querySelector('.page.active');
    if (!activePage) return;
    const pageId = activePage.id;
    
    if (pageId === 'pageMoulages') {
      // Recherche dans les moulages uniquement
      document.querySelectorAll('.mcard').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
    } else if (pageId === 'pageJobs') {
      // Recherche dans les jobs uniquement
      document.querySelectorAll('.job-card').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
    } else if (pageId === 'pageSerie') {
      // Recherche dans les commandes Série+ uniquement
      document.querySelectorAll('.cmd-card').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
    } else if (pageId === 'pageInventaire') {
      // Recherche dans les cubes inventaire
      document.querySelectorAll('.inv-cube').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
    }
  });
  document.getElementById('searchClear').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchClear').classList.add('hidden');
    // Réafficher tout selon la page active
    const activePage = document.querySelector('.page.active');
    if (!activePage) return;
    const pageId = activePage.id;
    
    if (pageId === 'pageMoulages') {
      document.querySelectorAll('.mcard').forEach(c => c.style.display = '');
    } else if (pageId === 'pageJobs') {
      document.querySelectorAll('.job-card').forEach(c => c.style.display = '');
    } else if (pageId === 'pageSerie') {
      document.querySelectorAll('.cmd-card').forEach(c => c.style.display = '');
    } else if (pageId === 'pageInventaire') {
      document.querySelectorAll('.inv-cube').forEach(c => c.style.display = '');
    }
  });
  
  // Event listeners pour le menu de déplacement
  document.getElementById('moveClose')?.addEventListener('click', closeMoveMenu);
  document.getElementById('moveOverlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'moveOverlay') closeMoveMenu();
  });
  
  // Event listeners pour confirmation suppression
  document.getElementById('confirmYes')?.addEventListener('click', confirmDelete);
  document.getElementById('confirmNo')?.addEventListener('click', closeDeleteConfirm);
  document.getElementById('confirmOverlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'confirmOverlay') closeDeleteConfirm();
  });
  
  // Initialiser le calendrier global
  initGlobalCalendar();
});

// Exposer fonctions globales
window.openFiche = openFiche;
window.closeFiche = closeFiche;
window.openMoveMenu = openMoveMenu;
window.showMoveMenu = showMoveMenu;
window.closeMoveMenu = closeMoveMenu;
window.moveCardToPosition = moveCardToPosition;
window.showDeleteConfirm = showDeleteConfirm;
window.closeDeleteConfirm = closeDeleteConfirm;
window.confirmDelete = confirmDelete;
window.openPriorityMenu = openPriorityMenu;
window.openCalendar = openCalendar;
window.openPhotoLink = openPhotoLink;
window.openNotePhoto = openNotePhoto;
window.saveMoulageNotes = saveMoulageNotes;
window.showFichePriorityMenu = showFichePriorityMenu;
window.togglePhotosMenu = togglePhotosMenu;
window.closePhotosMenu = closePhotosMenu;

// ===== MENUS CONTEXTUELS UNIFIÉS (Délai / Raison Attente / Expédition) =====
let isRobotViewActive = false;

// Ferme tous les menus contextuels
function closeContextMenus() {
  document.getElementById('contextMenu')?.remove();
}

// Positionne un menu près d'un élément
function positionMenu(menu, anchor, preferLeft = false) {
  const rect = anchor.getBoundingClientRect();
  const menuW = menu.offsetWidth || 250;
  const menuH = menu.offsetHeight || 300;
  
  if (preferLeft) {
    menu.style.left = Math.max(10, rect.left - menuW - 10) + 'px';
    menu.style.top = Math.max(10, Math.min(rect.top, window.innerHeight - menuH - 10)) + 'px';
  } else {
    menu.style.left = Math.min(rect.left, window.innerWidth - menuW - 10) + 'px';
    menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - menuH - 10) + 'px';
  }
}

// Met à jour une carte après modification
function refreshCard(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card && cardsData[cardId]) {
    updateExistingCard(card, cardId, cardsData[cardId]);
  }
}

// Menu principal - dispatch selon la colonne
function openDelaiMenu(cardId, event) {
  event.stopPropagation();
  event.preventDefault();
  closeContextMenus();
  
  const cardData = cardsData[cardId];
  if (!cardData) return;
  
  // Colonne 7 (En attente) → Menu raison
  if (cardData.columnIndex === 7) {
    showRaisonMenu(cardId, event);
    return;
  }
  
  // Colonne 6 (Expédition) → Menu expédier
  if (cardData.columnIndex === 6) {
    showExpeditionMenu(cardId, event);
    return;
  }
  
  // Colonnes 0-5 → Menu délai régional
  showDelaiMenu(cardId, event);
}

// Menu Expédition (colonne 6)
function showExpeditionMenu(cardId, event) {
  const menu = document.createElement('div');
  menu.id = 'contextMenu';
  menu.className = 'ctx-menu';
  menu.onclick = e => e.stopPropagation();
  
  menu.innerHTML = `
    <div class="ctx-header">📦 Expédition</div>
    <div class="ctx-body">
      <button class="ctx-btn primary" onclick="marquerExpedie('${cardId}')">📦 Marquer comme Expédié</button>
    </div>
    <div class="ctx-footer">
      <button class="ctx-btn" onclick="closeContextMenus()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  positionMenu(menu, event.target);
}

// Menu Délai régional (colonnes 0-5)
function showDelaiMenu(cardId, event) {
  const cardData = cardsData[cardId];
  const currentRegion = cardData.region || 'Quebec';
  const delays = MENU_DATA.delays;
  
  const menu = document.createElement('div');
  menu.id = 'contextMenu';
  menu.className = 'ctx-menu';
  menu.onclick = e => e.stopPropagation();
  
  const regions = [
    { key: 'Quebec', label: 'Québec', delay: delays['Quebec'] || 90 },
    { key: 'Maritime', label: 'Maritime', delay: delays['Maritime'] || 45 },
    { key: 'Canada anglais', label: 'Canada anglais', delay: delays['Canada anglais'] || 30 }
  ];
  
  const rowsHtml = regions.map(r => `
    <div class="ctx-region ${currentRegion === r.key ? 'active' : ''}" data-region="${r.key}">
      <span class="ctx-region-name">${r.label}</span>
      <input type="number" class="ctx-input" data-region="${r.key}" value="${r.delay}" min="1" max="365" onclick="event.stopPropagation()">
      <span class="ctx-unit">jours</span>
    </div>
  `).join('');
  
  menu.innerHTML = `
    <div class="ctx-header">⏱ Délais par région</div>
    <div class="ctx-body">${rowsHtml}</div>
    <div class="ctx-footer">
      <button class="ctx-btn primary" onclick="saveDelai('${cardId}')">Sauvegarder</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Click sur une région pour la sélectionner
  menu.querySelectorAll('.ctx-region').forEach(row => {
    row.onclick = (e) => {
      if (e.target.tagName === 'INPUT') return;
      menu.querySelectorAll('.ctx-region').forEach(r => r.classList.remove('active'));
      row.classList.add('active');
      if (cardsData[cardId]) cardsData[cardId].region = row.dataset.region;
    };
  });
  
  positionMenu(menu, event.target);
}

function saveDelai(cardId) {
  const menu = document.getElementById('contextMenu');
  if (!menu) return;
  
  // Sauvegarder les délais
  menu.querySelectorAll('.ctx-input').forEach(input => {
    MENU_DATA.delays[input.dataset.region] = parseInt(input.value) || 30;
  });
  
  // Sauvegarder la région sélectionnée
  const activeRow = menu.querySelector('.ctx-region.active');
  if (activeRow && cardsData[cardId]) {
    const region = activeRow.dataset.region;
    cardsData[cardId].region = region;
    cardsData[cardId].delaiPersonnalise = MENU_DATA.delays[region];
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  
  closeContextMenus();
  showToast('Délai sauvegardé!');
}

function marquerExpedie(cardId) {
  const dateExp = prompt("Date d'expédition (AAAA-MM-JJ):", new Date().toISOString().split('T')[0]);
  if (dateExp && cardsData[cardId]) {
    cardsData[cardId].expedie = true;
    cardsData[cardId].dateExpedition = dateExp;
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  closeContextMenus();
}

// Menu Raison d'attente (colonne 7)
function showRaisonMenu(cardId, event) {
  const currentRaison = cardsData[cardId]?.raisonAttente || '';
  const raisons = customLists.raisonsAttente || [
    'RDV non reçu', 'Client rappeler - voir note', 'Essayage autre région',
    'Mesure à reprendre', 'Pièce à recommander', 'Vérification prix',
    'Intervention', 'Livraison reportée', 'Hors délai RAMQ', 'Sous traitement', 'Voir Fiche'
  ];
  
  const menu = document.createElement('div');
  menu.id = 'contextMenu';
  menu.className = 'ctx-menu raison';
  menu.onclick = e => e.stopPropagation();
  
  const optionsHtml = raisons.map(r => 
    `<div class="ctx-option ${r === currentRaison ? 'selected' : ''}" onclick="selectRaison('${cardId}','${r.replace(/'/g, "\\'")}')">${r}</div>`
  ).join('');
  
  menu.innerHTML = `
    <div class="ctx-header">⏳ Raison d'attente</div>
    <div class="ctx-options">${optionsHtml}</div>
    <div class="ctx-actions">
      <button class="ctx-btn small" onclick="addRaison('${cardId}')">➕ Ajouter</button>
      <button class="ctx-btn small danger" onclick="clearRaison('${cardId}')">🗑 Effacer</button>
    </div>
    <div class="ctx-footer">
      <button class="ctx-btn" onclick="closeContextMenus()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Positionner à gauche de la carte
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  positionMenu(menu, card || event.target, true);
}

function selectRaison(cardId, raison) {
  if (cardsData[cardId]) {
    cardsData[cardId].raisonAttente = raison;
    cardsData[cardId].attenteActive = true;
    if (!cardsData[cardId].dateAttente) {
      cardsData[cardId].dateAttente = new Date().toLocaleDateString('fr-CA');
    }
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  closeContextMenus();
  showToast('Raison: ' + raison);
}

function addRaison(cardId) {
  const newRaison = prompt("Nouvelle raison d'attente:");
  if (newRaison?.trim()) {
    const raison = newRaison.trim();
    if (!customLists.raisonsAttente) customLists.raisonsAttente = [];
    if (!customLists.raisonsAttente.includes(raison)) {
      customLists.raisonsAttente.push(raison);
      customLists.raisonsAttente.sort((a, b) => a.localeCompare(b, 'fr'));
      saveCustomLists();
      showListToast('✓ "' + raison + '" AJOUTÉ!', true);
    }
    selectRaison(cardId, raison);
  }
}

function clearRaison(cardId) {
  if (cardsData[cardId]) {
    cardsData[cardId].raisonAttente = '';
    cardsData[cardId].attenteActive = false;
    cardsData[cardId].dateAttente = '';
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  closeContextMenus();
  showToast('Raison effacée');
}

// ===== VUE ROBOT HORIZONTALE =====

function toggleRobotView() {
  isRobotViewActive = !isRobotViewActive;
  const robotView = document.getElementById('robotHorizontalView');
  if (!robotView) return;
  
  if (isRobotViewActive) {
    robotView.style.display = 'flex';
    renderRobotTable();
    setupColumnResize();
    setupRobotVerticalResize();
  } else {
    robotView.style.display = 'none';
  }
}

// Slider vertical pour redimensionner la hauteur de la vue Robot
function setupRobotVerticalResize() {
  const resizeBar = document.getElementById('robotResizeBar');
  const robotView = document.getElementById('robotHorizontalView');
  if (!resizeBar || !robotView) return;
  
  let isResizing = false;
  let startY = 0;
  let startHeight = 0;
  
  resizeBar.addEventListener('mousedown', function(e) {
    isResizing = true;
    startY = e.clientY;
    startHeight = robotView.offsetHeight;
    robotView.classList.add('resizable');
    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  
  resizeBar.addEventListener('touchstart', function(e) {
    isResizing = true;
    startY = e.touches[0].clientY;
    startHeight = robotView.offsetHeight;
    robotView.classList.add('resizable');
    e.preventDefault();
  }, { passive: false });
  
  document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    const deltaY = e.clientY - startY;
    const newHeight = Math.max(200, Math.min(window.innerHeight - 50, startHeight + deltaY));
    robotView.style.height = newHeight + 'px';
  });
  
  document.addEventListener('touchmove', function(e) {
    if (!isResizing) return;
    const deltaY = e.touches[0].clientY - startY;
    const newHeight = Math.max(200, Math.min(window.innerHeight - 50, startHeight + deltaY));
    robotView.style.height = newHeight + 'px';
  }, { passive: false });
  
  document.addEventListener('mouseup', function() {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });
  
  document.addEventListener('touchend', function() {
    if (isResizing) {
      isResizing = false;
    }
  });
}

function renderRobotTable() {
  const tbody = document.getElementById('robotTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  
  // Cartes de la colonne Robot (columnIndex = 0)
  const robotCards = Object.entries(cardsData).filter(([id, card]) => 
    (card.columnIndex ?? card.column ?? -1) === 0
  );
  
  if (robotCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="17" style="text-align:center;padding:30px;color:#6b7280;">Aucune carte dans Robot</td></tr>';
    return;
  }
  
  // Listes fixes
  const lists = {
    clients: [...(customLists.moulageClients || [])].sort((a, b) => a.localeCompare(b, 'fr')),
    regions: [...(customLists.regions || ['Maritime', 'Canada anglais', 'Quebec'])].sort((a, b) => a.localeCompare(b, 'fr')),
    representantes: ['Marie-Pier', 'Marie-Soleil'],
    items: ['Siège', 'Dossier', 'Siège + Dossier']
  };
  
  robotCards.forEach(([cardId, card], index) => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-card-id', cardId);
    
    const rang = index + 1;
    const prio = card.priority || 0;
    const hasNotes = card.notes && card.notes.trim().length > 0;
    
    tr.innerHTML = `
      <td class="editable" contenteditable="true" data-field="name">${card.name || ''}</td>
      <td class="editable" contenteditable="true" data-field="order">${card.order || ''}</td>
      <td class="editable" contenteditable="true" data-field="numeroSoumission">${card.numeroSoumission || ''}</td>
      <td class="editable" contenteditable="true" data-field="numeroPO">${card.numeroPO || ''}</td>
      <td>${buildSelectCell(cardId, 'client', card.client, lists.clients, 'moulageClients')}</td>
      <td>
        <select class="table-select" onchange="updateTableField('${cardId}', 'priority', parseInt(this.value))">
          <option value="0" ${prio==0?'selected':''}>☆ Aucune</option>
          <option value="1" ${prio==1?'selected':''}>1️⃣ Priorité 1</option>
          <option value="2" ${prio==2?'selected':''}>2️⃣ Priorité 2</option>
          <option value="3" ${prio==3?'selected':''}>3️⃣ Priorité 3</option>
          <option value="4" ${prio==4?'selected':''}>4️⃣ Priorité 4</option>
          <option value="5" ${prio==5?'selected':''}>5️⃣ Priorité 5</option>
        </select>
      </td>
      <td><span class="rang-robot-text">${rang}</span></td>
      <td>${buildSelectCell(cardId, 'region', card.region, lists.regions, 'regions')}</td>
      <td>${buildSelectCell(cardId, 'item', card.item, lists.items, 'items')}</td>
      <td class="date-cell ${card.dateRecue?'has-date':'placeholder'}" onclick="showTableCalendar('${cardId}','dateRecue',this)">${card.dateRecue || 'AAAA-MM-JJ'}</td>
      <td class="date-cell ${card.dateLivraison?'has-date':'placeholder'}" onclick="showTableCalendar('${cardId}','dateLivraison',this)">${card.dateLivraison || 'AAAA-MM-JJ'}</td>
      <td class="date-cell ${card.dateEssayage?'has-date':'placeholder'}" onclick="showTableCalendar('${cardId}','dateEssayage',this)">${card.dateEssayage || 'AAAA-MM-JJ'}</td>
      <td>${buildSelectCell(cardId, 'representant', card.representant, lists.representantes, 'representantes')}</td>
      <td>
        <select class="table-select" onchange="updateTableField('${cardId}', 'file', this.value)">
          <option value="">--</option>
          <option value="Oui" ${card.file==='Oui'?'selected':''}>Oui</option>
          <option value="Non" ${card.file==='Non'?'selected':''}>Non</option>
        </select>
      </td>
      <td class="editable" contenteditable="true" data-field="angle">${card.angle || ''}</td>
      <td>
        <select class="table-select" onchange="updateTableField('${cardId}', 'rush', this.value)">
          <option value="">--</option>
          <option value="Oui" ${card.rush==='Oui'?'selected':''}>Oui</option>
          <option value="Non" ${card.rush==='Non'?'selected':''}>Non</option>
        </select>
      </td>
      <td class="notes-cell"><button class="notes-btn ${hasNotes?'has-notes':''}" onclick="openCardNotes('${cardId}')">📝</button></td>
    `;
    tbody.appendChild(tr);
  });
  
  setupTableEditableListeners();
}

// Construit une cellule select avec + et - gros et colorés
function buildSelectCell(cardId, field, value, list, listKey) {
  const options = list.map(item => 
    `<option value="${item}" ${value===item?'selected':''}>${item}</option>`
  ).join('');
  
  return `<select class="table-select has-pm" onchange="handleSelectChange('${cardId}','${field}','${listKey}',this)">
    <option value="__PM__">(+Valeur-)</option>
    <option value="" ${!value?'selected':''}>--</option>
    ${options}
  </select>`;
}

function handleSelectChange(cardId, field, listKey, selectEl) {
  const value = selectEl.value;
  
  if (value === '__PM__') {
    selectEl.value = cardsData[cardId]?.[field] || '';
    openListManager(listKey, getTitleForList(listKey));
  } else {
    updateTableField(cardId, field, value);
  }
}

function getTitleForList(listKey) {
  const titles = {moulageClients:'Clients', regions:'Régions', items:'Items', representantes:'Représentantes'};
  return titles[listKey] || listKey;
}

// Mise à jour d'un champ depuis le tableau
function updateTableField(cardId, field, value) {
  if (!cardsData[cardId]) return;
  cardsData[cardId][field] = value;
  saveCardToFirebase(cardId);
  
  // Sync avec Kanban
  const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
  if (card) {
    if (field === 'name') {
      const el = card.querySelector('.mcard-title');
      if (el) el.value = value;
    } else if (field === 'order') {
      const el = card.querySelector('.mcard-order');
      if (el) el.value = value;
    } else if (field === 'priority') {
      updatePriorityBadge(card, value);
    } else if (field === 'region') {
      card.classList.remove('region-qc','region-on','region-ma');
      if (value === 'Quebec' || value === 'Québec') card.classList.add('region-qc');
      else if (value === 'Canada anglais' || value === 'Ontario') card.classList.add('region-on');
      else if (value === 'Maritime') card.classList.add('region-ma');
    }
  }
}

// Listeners pour cellules éditables
function setupTableEditableListeners() {
  document.querySelectorAll('#robotTableBody td.editable').forEach(cell => {
    cell.addEventListener('blur', function() {
      const row = this.closest('tr');
      const cardId = row?.getAttribute('data-card-id');
      const field = this.getAttribute('data-field');
      const value = this.textContent.trim();
      
      if (cardId && cardsData[cardId]) {
        cardsData[cardId][field] = value;
        saveCardToFirebase(cardId);
        
        const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
        if (card && field === 'name') {
          const el = card.querySelector('.mcard-title');
          if (el) el.value = value;
        }
        if (card && field === 'order') {
          const el = card.querySelector('.mcard-order');
          if (el) el.value = value;
        }
      }
    });
  });
}

// Ouvre un popup Notes identique à la fiche moulage
function openCardNotes(cardId) {
  document.getElementById('notesPopupOverlay')?.remove();
  document.getElementById('notesPopup')?.remove();
  
  const card = cardsData[cardId];
  if (!card) return;
  
  const overlay = document.createElement('div');
  overlay.id = 'notesPopupOverlay';
  overlay.className = 'notes-popup-overlay';
  overlay.onclick = closeNotesPopup;
  
  const popup = document.createElement('div');
  popup.id = 'notesPopup';
  popup.className = 'notes-popup-page';
  popup.onclick = e => e.stopPropagation();
  popup.innerHTML = `
    <div class="notes-page-header">
      <span class="notes-header-left" onclick="togglePopupPhotosPanel('${cardId}')" title="Gérer les liens photos"><span class="camera-icon">📷</span> Liens</span>
      <span class="notes-header-center">📝 Notes</span>
      <button class="notes-close-btn" onclick="closeNotesPopup()" title="Fermer">✕</button>
    </div>
    
    <div class="notes-photos-links-panel" id="notesPhotosPanel_popup_${cardId}" style="display:none;">
      <div class="notes-photo-link-row"><label>Photo 1:</label><input type="url" id="notePhotoLink1_popup_${cardId}" value="${card.notePhoto1 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 2:</label><input type="url" id="notePhotoLink2_popup_${cardId}" value="${card.notePhoto2 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 3:</label><input type="url" id="notePhotoLink3_popup_${cardId}" value="${card.notePhoto3 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 4:</label><input type="url" id="notePhotoLink4_popup_${cardId}" value="${card.notePhoto4 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 5:</label><input type="url" id="notePhotoLink5_popup_${cardId}" value="${card.notePhoto5 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 6:</label><input type="url" id="notePhotoLink6_popup_${cardId}" value="${card.notePhoto6 || ''}" placeholder="https://..."></div>
      <button class="notes-save-photos-btn" onclick="savePopupPhotoLinks('${cardId}')">💾 Enregistrer les liens</button>
    </div>
    
    <div class="notes-photos-row">
      <button class="notes-photo-btn ${card.notePhoto1?'has-link':''}" onclick="openNotePhoto('${cardId}', 1)">Photo 1</button>
      <button class="notes-photo-btn ${card.notePhoto2?'has-link':''}" onclick="openNotePhoto('${cardId}', 2)">Photo 2</button>
      <button class="notes-photo-btn ${card.notePhoto3?'has-link':''}" onclick="openNotePhoto('${cardId}', 3)">Photo 3</button>
      <button class="notes-photo-btn ${card.notePhoto4?'has-link':''}" onclick="openNotePhoto('${cardId}', 4)">Photo 4</button>
      <button class="notes-photo-btn ${card.notePhoto5?'has-link':''}" onclick="openNotePhoto('${cardId}', 5)">Photo 5</button>
      <button class="notes-photo-btn ${card.notePhoto6?'has-link':''}" onclick="openNotePhoto('${cardId}', 6)">Photo 6</button>
    </div>
    
    <textarea class="notes-page-textarea" id="notesTextarea_popup_${cardId}" 
      placeholder="Cliquez ici pour écrire..."
      onfocus="prepareNoteWithSignature('popup_${cardId}')"
      onblur="savePopupNotes('${cardId}')">${card.notes || ''}</textarea>
  `;
  
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  
  // Focus sur le textarea
  setTimeout(() => document.getElementById('notesTextarea_popup_' + cardId)?.focus(), 100);
}

function togglePopupPhotosPanel(cardId) {
  const panel = document.getElementById('notesPhotosPanel_popup_' + cardId);
  if (panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function savePopupPhotoLinks(cardId) {
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('notePhotoLink' + i + '_popup_' + cardId);
    if (input && cardsData[cardId]) {
      cardsData[cardId]['notePhoto' + i] = input.value.trim();
    }
  }
  saveCardToFirebase(cardId);
  showToast('Liens photos sauvegardés');
  
  // Rafraîchir le popup
  closeNotesPopup();
  openCardNotes(cardId);
}

function savePopupNotes(cardId) {
  const textarea = document.getElementById('notesTextarea_popup_' + cardId);
  if (!textarea || !cardsData[cardId]) return;
  
  cardsData[cardId].notes = textarea.value.trim();
  saveCardToFirebase(cardId);
  
  // Sync avec fiche si ouverte
  const ficheTextarea = document.getElementById('notesTextarea_' + cardId);
  if (ficheTextarea) ficheTextarea.value = cardsData[cardId].notes;
  
  renderRobotTable();
}

function closeNotesPopup() {
  document.getElementById('notesPopupOverlay')?.remove();
  document.getElementById('notesPopup')?.remove();
}

// Redimensionnement colonnes
function setupColumnResize() {
  document.querySelectorAll('.resize-handle').forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      const th = this.parentElement;
      const startX = e.pageX;
      const startWidth = th.offsetWidth;
      
      function onMove(e) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 40) th.style.width = newWidth + 'px';
      }
      
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
}

// Fermer menus au clic ailleurs (SAUF le calendrier qui a son propre overlay)
document.addEventListener('click', function(e) {
  if (!e.target.closest('.ctx-menu') && !e.target.closest('.mcard-delay-pill')) closeContextMenus();
});

// Exports window
window.toggleRobotView = toggleRobotView;
window.updateTableField = updateTableField;
window.handleSelectChange = handleSelectChange;
window.showTableCalendar = showTableCalendar;
window.openCardNotes = openCardNotes;
window.closeNotesPopup = closeNotesPopup;
window.savePopupNotes = savePopupNotes;
window.savePopupPhotoLinks = savePopupPhotoLinks;
window.togglePopupPhotosPanel = togglePopupPhotosPanel;
window.closeContextMenus = closeContextMenus;
window.selectRaison = selectRaison;
window.addRaison = addRaison;
window.clearRaison = clearRaison;
window.saveDelai = saveDelai;
window.marquerExpedie = marquerExpedie;

// ===== MODAL AJOUTER MOULAGE =====
function showAddMoulageModal() {
  let modal = document.getElementById('addMoulageModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'addMoulageModal';
    modal.className = 'add-modal-overlay hidden';
    modal.innerHTML = `
      <div class="add-modal">
        <div class="add-modal-header">
          <h3>➕ Ajouter un moulage</h3>
          <div class="add-modal-header-btns">
            <button class="add-json-btn" onclick="document.getElementById('addMoulageJsonInput').click()">
              🤖 JSON
            </button>
            <input type="file" id="addMoulageJsonInput" accept=".json" style="display:none" onchange="handleImportMoulageJson(event)" multiple>
            <button class="add-modal-close" onclick="closeAddMoulageModal()">×</button>
          </div>
        </div>
        <div class="add-modal-body">
          <div class="add-modal-field">
            <label>Client</label>
            <select id="addMoulageClient"></select>
          </div>
          <div class="add-modal-field">
            <label>Nom du moulage</label>
            <input type="text" id="addMoulageName" placeholder="Ex: Dupont Jean">
          </div>
          <div class="add-modal-field">
            <label>📅 Date reçue</label>
            <div class="date-picker-field" onclick="openCalendarPopup('addMoulageDateRecue')">
              <span id="addMoulageDateRecueDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addMoulageDateRecue">
          </div>
          <div class="add-modal-field">
            <label>🤖 Date fabriquée robot</label>
            <div class="date-picker-field" onclick="openCalendarPopup('addMoulageDateRobot')">
              <span id="addMoulageDateRobotDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addMoulageDateRobot">
          </div>
          <div class="add-modal-field">
            <label>📦 Date de livraison</label>
            <div class="date-picker-field" onclick="openCalendarPopup('addMoulageDateLivraison')">
              <span id="addMoulageDateLivraisonDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addMoulageDateLivraison">
          </div>
          <div class="add-modal-field">
            <label>N° Commande</label>
            <input type="text" id="addMoulageOrder" placeholder="000000" maxlength="6">
          </div>
          <div class="add-modal-field">
            <label>Numéro PO</label>
            <input type="text" id="addMoulageNumeroPO" placeholder="Numéro...">
          </div>
          <div class="add-modal-field">
            <label>Région</label>
            <select id="addMoulageRegion"></select>
          </div>
          <div class="add-modal-field">
            <label>📋 N° Soumission</label>
            <input type="text" id="addMoulageSoumission" placeholder="Numéro de soumission...">
          </div>
          <div class="add-modal-field">
            <label>Intervenant</label>
            <select id="addMoulageIntervenant"></select>
          </div>
          <div class="add-modal-field">
            <label>Représentante</label>
            <select id="addMoulageRepresentant"></select>
          </div>
        </div>
        <div class="add-modal-footer">
          <button class="add-btn-cancel" onclick="closeAddMoulageModal()">Annuler</button>
          <button class="add-btn-confirm" onclick="confirmAddMoulage()">Ajouter</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  populateAddMoulageSelects();
  
  // Reset tous les champs
  document.getElementById('addMoulageName').value = '';
  document.getElementById('addMoulageOrder').value = '';
  document.getElementById('addMoulageNumeroPO').value = '';
  document.getElementById('addMoulageSoumission').value = '';
  
  // Reset dates avec valeur par défaut pour Date reçue
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('addMoulageDateRecue').value = today;
  document.getElementById('addMoulageDateRecueDisplay').textContent = formatDateFR(today);
  document.getElementById('addMoulageDateRobot').value = '';
  document.getElementById('addMoulageDateRobotDisplay').textContent = '-- Sélectionner --';
  document.getElementById('addMoulageDateLivraison').value = '';
  document.getElementById('addMoulageDateLivraisonDisplay').textContent = '-- Sélectionner --';
  
  modal.classList.remove('hidden');
}

function closeAddMoulageModal() {
  const modal = document.getElementById('addMoulageModal');
  if (modal) modal.classList.add('hidden');
}

function populateAddMoulageSelects() {
  const clientSelect = document.getElementById('addMoulageClient');
  const regionSelect = document.getElementById('addMoulageRegion');
  const repSelect = document.getElementById('addMoulageRepresentant');
  const intSelect = document.getElementById('addMoulageIntervenant');
  
  if (clientSelect) {
    const clients = [...(customLists.moulageClients || [])].sort((a, b) => a.localeCompare(b, 'fr'));
    clientSelect.innerHTML = '<option value="">-- Sélectionner --</option>' + 
      clients.map(c => '<option value="' + c + '">' + c + '</option>').join('');
  }
  
  if (regionSelect) {
    const regions = [...(customLists.regions || ['Quebec', 'Canada anglais', 'Maritime'])].sort((a, b) => a.localeCompare(b, 'fr'));
    regionSelect.innerHTML = regions.map(r => '<option value="' + r + '">' + r + '</option>').join('');
    regionSelect.value = 'Quebec';
  }
  
  if (repSelect) {
    const reps = [...(customLists.representantes || [])].sort((a, b) => a.localeCompare(b, 'fr'));
    repSelect.innerHTML = '<option value="">-- Sélectionner --</option>' + 
      reps.map(r => '<option value="' + r + '">' + r + '</option>').join('');
  }
  
  if (intSelect) {
    const ints = [...(customLists.intervenants || [])].sort((a, b) => a.localeCompare(b, 'fr'));
    intSelect.innerHTML = '<option value="">-- Sélectionner --</option>' + 
      ints.map(i => '<option value="' + i + '">' + i + '</option>').join('');
  }
}

function confirmAddMoulage() {
  const nameInput = document.getElementById('addMoulageName').value.trim();
  const name = nameInput || 'Sans nom';  // Valeur par défaut si vide
  const order = document.getElementById('addMoulageOrder').value.trim();
  const region = document.getElementById('addMoulageRegion').value || 'Quebec';
  const client = document.getElementById('addMoulageClient').value;
  const representant = document.getElementById('addMoulageRepresentant').value;
  const intervenant = document.getElementById('addMoulageIntervenant').value;
  const soumission = document.getElementById('addMoulageSoumission').value.trim();
  const numeroPO = document.getElementById('addMoulageNumeroPO').value.trim();
  const dateRecue = document.getElementById('addMoulageDateRecue').value;
  const dateRobot = document.getElementById('addMoulageDateRobot').value;
  const dateLivraison = document.getElementById('addMoulageDateLivraison').value;
  
  // Créer la carte (pas de validation obligatoire)
  const cardId = createCard(name, order || '000000', region, 0);
  
  // Ajouter les données supplémentaires
  if (cardsData[cardId]) {
    cardsData[cardId].client = client;
    cardsData[cardId].representant = representant;
    cardsData[cardId].intervenant = intervenant;
    cardsData[cardId].numeroSoumission = soumission;
    cardsData[cardId].numeroPO = numeroPO;
    cardsData[cardId].dateRecue = dateRecue;
    cardsData[cardId].dateRobot = dateRobot;
    cardsData[cardId].dateLivraison = dateLivraison;
    saveCardToFirebase(cardId);
  }
  
  closeAddMoulageModal();
  showToast('Moulage "' + name + '" créé avec succès!');
  
  // Rafraîchir la vue Robot si active
  if (isRobotViewActive && typeof renderRobotTable === 'function') {
    setTimeout(() => renderRobotTable(), 200);
  }
  
  // Mettre à jour les compteurs mobile
  if (typeof updateMobileMenuCounts === 'function') updateMobileMenuCounts();
  if (typeof displayAllMobileCards === 'function') displayAllMobileCards();
}

// ===== IMPORT JSON POUR MOULAGE =====
function handleImportMoulageJson(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const rawData = JSON.parse(e.target.result);
      
      // Déterminer si c'est un tableau ou un objet simple
      const moulages = Array.isArray(rawData) ? rawData : [rawData];
      
      let newValuesAdded = [];
      let createdCount = 0;
      let createdNames = [];
      
      // Ajouter valeur à une liste si nouvelle
      function addToListIfNew(listKey, value) {
        if (!value || value.trim() === '') return false;
        const trimmedValue = value.trim();
        
        if (!customLists[listKey]) customLists[listKey] = [];
        
        const exists = customLists[listKey].some(item => 
          item.toLowerCase() === trimmedValue.toLowerCase()
        );
        
        if (!exists) {
          customLists[listKey].push(trimmedValue);
          customLists[listKey].sort((a, b) => a.localeCompare(b, 'fr'));
          newValuesAdded.push(trimmedValue + ' (' + listKey + ')');
          return true;
        }
        return false;
      }
      
      // Traiter chaque moulage
      moulages.forEach(data => {
        // Ajouter les nouvelles valeurs aux listes
        if (data.client) addToListIfNew('moulageClients', data.client);
        if (data.representante || data.representant) addToListIfNew('representantes', data.representante || data.representant);
        if (data.intervenant) addToListIfNew('intervenants', data.intervenant);
        if (data.region) addToListIfNew('regions', data.region);
        
        // Créer la carte
        const name = data.name || data.nom || 'Sans nom';
        const order = data.order || data.commande || data.numeroCommande || '000000';
        const region = data.region || 'Quebec';
        
        const cardId = createCard(name, order, region, 0);
        
        // Ajouter toutes les données
        if (cardsData[cardId]) {
          cardsData[cardId].client = data.client || '';
          cardsData[cardId].representant = data.representante || data.representant || '';
          cardsData[cardId].intervenant = data.intervenant || '';
          cardsData[cardId].numeroSoumission = data.numeroSoumission || data.soumission || '';
          cardsData[cardId].numeroPO = data.numeroPO || data.po || '';
          cardsData[cardId].dateRecue = data.dateRecue || new Date().toISOString().split('T')[0];
          cardsData[cardId].dateRobot = data.dateRobot || '';
          cardsData[cardId].dateLivraison = data.dateLivraison || data.livraison || '';
          cardsData[cardId].dateEssayage = data.dateEssayage || '';
          cardsData[cardId].item = data.item || '';
          cardsData[cardId].notes = data.notes || '';
          saveCardToFirebase(cardId);
          createdCount++;
          createdNames.push(name + ' (#' + order + ')');
        }
      });
      
      // Sauvegarder les listes si nouvelles valeurs
      if (newValuesAdded.length > 0) {
        saveCustomLists();
      }
      
      closeAddMoulageModal();
      
      // Rafraîchir
      if (isRobotViewActive && typeof renderRobotTable === 'function') {
        setTimeout(() => renderRobotTable(), 200);
      }
      
      // Message succès
      let msg = '';
      if (createdCount === 1) {
        msg = 'Moulage "' + createdNames[0] + '" créé!';
      } else {
        msg = createdCount + ' moulages créés:\n• ' + createdNames.slice(0, 10).join('\n• ');
        if (createdNames.length > 10) {
          msg += '\n• ... et ' + (createdNames.length - 10) + ' autres';
        }
      }
      
      if (newValuesAdded.length > 0) {
        msg += '\n\nNouvelles valeurs ajoutées aux listes:\n• ' + newValuesAdded.slice(0, 10).join('\n• ');
        if (newValuesAdded.length > 10) {
          msg += '\n• ... et ' + (newValuesAdded.length - 10) + ' autres';
        }
      }
      alert('✅ ' + msg);
      
    } catch (error) {
      console.error('Erreur import JSON:', error);
      alert('❌ Erreur lors de l\'import du JSON!\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}

// ===== CALENDRIER UNIFIÉ =====
const CAL_MONTHS = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
const CAL_DAYS = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];

let calState = { year: 0, month: 0, selected: '', callback: null, clearCallback: null, mode: 'modal', anchorEl: null };

function showCalendar(options = {}) {
  const { value = '', onSelect = null, onClear = null, mode = 'modal', anchor = null } = options;
  
  // Fermer tout calendrier existant
  closeCalendar();
  
  // Initialiser l'état
  const d = value ? new Date(value + 'T12:00:00') : new Date();
  calState = { 
    year: d.getFullYear(), 
    month: d.getMonth(), 
    selected: value, 
    callback: onSelect, 
    clearCallback: onClear,
    mode: mode,
    anchorEl: anchor
  };
  
  // Créer le calendrier
  const cal = document.createElement('div');
  cal.id = 'unifiedCalendar';
  cal.className = mode === 'modal' ? 'cal-overlay' : 'cal-popup';
  cal.onclick = mode === 'modal' ? (e) => { if (e.target === cal) closeCalendar(); } : (e) => e.stopPropagation();
  
  const popup = document.createElement('div');
  popup.className = 'cal-container';
  popup.innerHTML = renderCalendarContent();
  
  if (mode === 'modal') {
    cal.appendChild(popup);
  } else {
    cal.appendChild(popup);
  }
  
  document.body.appendChild(cal);
  
  // Positionner si mode inline
  if (mode === 'inline' && anchor) {
    const rect = anchor.getBoundingClientRect();
    cal.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
    cal.style.top = Math.min(rect.bottom + 5, window.innerHeight - 320) + 'px';
  }
}

function renderCalendarContent() {
  const { year, month, selected } = calState;
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date().toISOString().split('T')[0];
  
  let daysHtml = '';
  
  // Jours vides du début
  for (let i = 0; i < firstDay; i++) daysHtml += '<div class="cal-cell empty"></div>';
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let cls = 'cal-cell';
    if (dateStr === today) cls += ' today';
    if (dateStr === selected) cls += ' selected';
    daysHtml += `<div class="${cls}" onclick="selectCalDate('${dateStr}')">${day}</div>`;
  }
  
  return `
    <div class="cal-header">
      <button onclick="navCal(-1)">◀</button>
      <span>${CAL_MONTHS[month]} ${year}</span>
      <button onclick="navCal(1)">▶</button>
    </div>
    <div class="cal-weekdays">${CAL_DAYS.map(d => `<span>${d}</span>`).join('')}</div>
    <div class="cal-grid">${daysHtml}</div>
    <div class="cal-footer">
      <button class="cal-btn today" onclick="selectCalDate('${today}')">Aujourd'hui</button>
      <button class="cal-btn clear" onclick="clearCalDate()">Effacer</button>
      <button class="cal-btn close" onclick="closeCalendar()">Fermer</button>
    </div>
  `;
}

function navCal(dir) {
  calState.month += dir;
  if (calState.month < 0) { calState.month = 11; calState.year--; }
  if (calState.month > 11) { calState.month = 0; calState.year++; }
  document.querySelector('#unifiedCalendar .cal-container').innerHTML = renderCalendarContent();
}

function selectCalDate(dateStr) {
  if (calState.callback) calState.callback(dateStr);
  closeCalendar();
}

function clearCalDate() {
  if (calState.clearCallback) calState.clearCallback();
  else if (calState.callback) calState.callback('');
  closeCalendar();
}

function closeCalendar() {
  document.getElementById('unifiedCalendar')?.remove();
}

// Format date FR
function formatDateFR(dateStr) {
  if (!dateStr) return '-- Sélectionner --';
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
}

// ===== COMPATIBILITÉ ANCIEN CODE =====
// Calendrier popup (fiche moulage)
function openCalendarPopup(targetId) {
  const hiddenInput = document.getElementById(targetId);
  const currentValue = hiddenInput?.value || '';
  
  showCalendar({
    value: currentValue,
    mode: 'modal',
    onSelect: (dateStr) => {
      if (hiddenInput) hiddenInput.value = dateStr;
      const displayEl = document.getElementById(targetId + 'Display');
      if (displayEl) displayEl.textContent = formatDateFR(dateStr);
    }
  });
}
function closeCalendarPopup() { closeCalendar(); }
function calendarPrev() { navCal(-1); }
function calendarNext() { navCal(1); }
function calendarToday() { selectCalDate(new Date().toISOString().split('T')[0]); }
function calendarClear() { clearCalDate(); }
function selectCalendarDate(dateStr) { selectCalDate(dateStr); }

// Calendrier table (vue Robot)
function showTableCalendar(cardId, field, cell) {
  const currentDate = cardsData[cardId]?.[field] || '';
  
  showCalendar({
    value: currentDate,
    mode: 'inline',
    anchor: cell,
    onSelect: (dateStr) => {
      if (cardsData[cardId]) {
        cardsData[cardId][field] = dateStr;
        saveCardToFirebase(cardId);
        renderRobotTable();
      }
    }
  });
}

// ===== NAVIGATION PAGES =====
let currentPage = 'moulages';

// Configuration des pages
const pageConfig = {
  'moulages': {
    logoText: 'Moulage',
    title: 'Outil de gestion des moulages',
    addBtn: '+ Ajouter moulage',
    showSearch: true
  },
  'serie': {
    logoText: 'Série+',
    title: 'Outil de gestion des séries',
    addBtn: '+ Ajouter commande',
    showSearch: true
  },
  'inventaire': {
    logoText: 'Inventaire',
    title: 'Outil de gestion de l\'inventaire',
    addBtn: '+ Ajouter inventaire',
    showSearch: true
  },
  'jobs': {
    logoText: 'Job en attente',
    title: 'Outil de gestion des jobs en attente',
    addBtn: '+ Ajouter job en attente',
    showSearch: true
  }
};

function updateLogoMenu() {
  const menu = document.getElementById('logoMenu');
  if (!menu) return;
  
  menu.innerHTML = '';
  Object.keys(pageConfig).forEach(page => {
    if (page !== currentPage) {
      const item = document.createElement('div');
      item.className = 'logo-menu-item';
      item.textContent = pageConfig[page].logoText;
      item.onclick = () => switchToPage(page);
      menu.appendChild(item);
    }
  });
}

function switchToPage(page) {
  currentPage = page;
  const config = pageConfig[page];
  if (!config) return;
  
  // Mettre à jour le logo
  const logoText = document.getElementById('logoBottomText');
  if (logoText) logoText.textContent = config.logoText;
  
  // Mettre à jour le titre principal
  const titleEl = document.getElementById('pageMainTitle');
  if (titleEl) titleEl.textContent = config.title;
  
  // Mettre à jour le bouton d'ajout
  const addBtn = document.getElementById('btnAddItem');
  if (addBtn) addBtn.textContent = config.addBtn;
  
  // Afficher/cacher la barre de recherche
  const searchRow = document.getElementById('searchRow');
  if (searchRow) searchRow.style.display = config.showSearch ? '' : 'none';
  
  // Effacer la recherche quand on change de page
  const searchInput = document.getElementById('searchInput');
  const searchClear = document.getElementById('searchClear');
  if (searchInput) searchInput.value = '';
  if (searchClear) searchClear.classList.add('hidden');
  document.querySelectorAll('.mcard, .job-card, .cmd-card').forEach(c => c.style.display = '');
  
  // Mettre à jour le menu
  updateLogoMenu();
  
  // Cacher toutes les pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  
  // Afficher la page demandée
  const pageEl = document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1));
  if (pageEl) {
    pageEl.classList.add('active');
  }
}

// Fonction appelée par le bouton d'ajout
function handleAddButton() {
  switch (currentPage) {
    case 'moulages':
      showAddMoulageModal();
      break;
    case 'jobs':
      showAddJobModal();
      break;
    case 'serie':
      showCmdAddModal();
      break;
    case 'inventaire':
      openInvFiche();
      break;
  }
}

window.showAddMoulageModal = showAddMoulageModal;
window.closeAddMoulageModal = closeAddMoulageModal;
window.confirmAddMoulage = confirmAddMoulage;
window.handleImportMoulageJson = handleImportMoulageJson;
window.switchToPage = switchToPage;
window.handleAddButton = handleAddButton;
window.openCalendarPopup = openCalendarPopup;
window.closeCalendarPopup = closeCalendarPopup;
window.calendarPrev = calendarPrev;
window.calendarNext = calendarNext;
window.calendarToday = calendarToday;
window.calendarClear = calendarClear;
window.selectCalendarDate = selectCalendarDate;
window.formatDateFR = formatDateFR;
window.createCard = createCard;
window.generateCardId = generateCardId;
window.showCalendar = showCalendar;
window.closeCalendar = closeCalendar;
window.navCal = navCal;
window.selectCalDate = selectCalDate;
window.clearCalDate = clearCalDate;


// =============================================================================

// =============================================================================


// PAGE JOBS EN ATTENTE
// =============================================================================

let jobsData = {
  // 6 jobs exemple pour tests - dates 2025
  'job_ex_1': {
    type: 'question',
    order: '287001',
    client: 'Centre ABC',
    numeroPO: 'PO-2025-001',
    numeroSoumission: 'S-001',
    representant: 'Marie-Soleil',
    intervenant: 'Dr Martin',
    region: 'Quebec',
    assignee: 'Sonia',
    dateRecue: '2025-12-01',
    dateAmene: '2025-12-15',
    dateLivraison: '2025-12-28',
    notes: '',
    createdAt: '2025-12-15T10:00:00Z'
  },
  'job_ex_2': {
    type: 'question',
    order: '287002',
    client: 'Clinique XYZ',
    numeroPO: 'PO-2025-002',
    numeroSoumission: 'S-002',
    representant: 'Valérie',
    intervenant: 'Dr Tremblay',
    region: 'Canada anglais',
    assignee: 'Jacinthe',
    dateRecue: '2025-12-05',
    dateAmene: '2025-12-18',
    dateLivraison: '2025-12-30',
    notes: '',
    createdAt: '2025-12-18T10:00:00Z'
  },
  'job_ex_3': {
    type: 'question',
    order: '287003',
    client: 'SAT IRDPQ Hamel',
    numeroPO: 'PO-2025-003',
    numeroSoumission: 'S-003',
    representant: 'Marie-Pier',
    intervenant: 'Isabelle Neault',
    region: 'Quebec',
    assignee: 'Nadia',
    dateRecue: '2025-12-10',
    dateAmene: '2025-12-19',
    dateLivraison: '2026-01-05',
    notes: '',
    createdAt: '2025-12-19T10:00:00Z'
  },
  'job_ex_4': {
    type: 'question',
    order: '287004',
    client: 'IWK Nouvelle Ecosse',
    numeroPO: 'PO-2025-004',
    numeroSoumission: 'S-004',
    representant: 'Fabrys',
    intervenant: 'Jenny Jackson',
    region: 'Quebec',
    assignee: 'Nouveau',
    dateRecue: '2025-12-08',
    dateAmene: '2025-12-20',
    dateLivraison: '2026-01-10',
    notes: '',
    createdAt: '2025-12-20T10:00:00Z'
  },
  'job_ex_5': {
    type: 'question',
    order: '287005',
    client: 'Stan Cassidy Nouveau Brunswick',
    numeroPO: 'PO-2025-005',
    numeroSoumission: 'S-005',
    representant: 'Multipass',
    intervenant: 'Pam McKaskill',
    region: 'Canada anglais',
    assignee: 'Sonia',
    dateRecue: '2025-12-12',
    dateAmene: '2025-12-21',
    dateLivraison: '2026-01-15',
    notes: '',
    createdAt: '2025-12-21T10:00:00Z'
  },
  'job_ex_6': {
    type: 'question',
    order: '287006',
    client: 'TLC Medical',
    numeroPO: 'PO-2025-006',
    numeroSoumission: 'S-006',
    representant: 'Marie-Soleil',
    intervenant: 'Eric Gagnon',
    region: 'Quebec',
    assignee: 'Nouveau',
    dateRecue: '2025-12-14',
    dateAmene: '2025-12-21',
    dateLivraison: '2026-01-20',
    notes: '',
    createdAt: '2025-12-21T11:00:00Z'
  }
};
let currentJobId = null;

// Charger les jobs depuis Firebase
function loadJobsFromFirebase() {
  // D'abord charger depuis localStorage
  let localData = null;
  try {
    const stored = localStorage.getItem('physipro_jobs');
    if (stored) {
      localData = JSON.parse(stored);
      // Fusionner avec les exemples
      Object.keys(localData).forEach(key => {
        jobsData[key] = localData[key];
      });
      console.log('📋 Jobs chargés depuis localStorage:', Object.keys(localData).length);
    }
  } catch(e) {
    console.error('Erreur chargement localStorage jobs:', e);
  }
  
  // Afficher immédiatement
  renderJobs();
  if (typeof renderMobileJobsList === 'function') renderMobileJobsList();
  
  if (!firebaseDb) {
    return;
  }
  
  firebaseDb.ref('jobs').on('value', snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      // Fusionner avec les données existantes (Firebase a priorité)
      Object.keys(data).forEach(key => {
        jobsData[key] = data[key];
      });
      // Nettoyer les notes corrompues
      cleanCorruptedNotes(jobsData, 'jobs');
      // Sauvegarder en local
      saveJobsToLocalStorage();
    }
    renderJobs();
    if (typeof renderMobileJobsList === 'function') renderMobileJobsList();
    if (typeof updateMobileMenuCounts === 'function') updateMobileMenuCounts();
  });
}

// Sauvegarder tous les jobs en localStorage
function saveJobsToLocalStorage() {
  try {
    // Sauvegarder TOUS les jobs (y compris les exemples modifiés)
    localStorage.setItem('physipro_jobs', JSON.stringify(jobsData));
    console.log('💾 Jobs sauvegardés:', Object.keys(jobsData).length);
  } catch(e) {
    console.error('Erreur sauvegarde localStorage jobs:', e);
  }
}

// Sauvegarder un job
function saveJobToFirebase(jobId) {
  if (!jobsData[jobId]) return;
  
  // Toujours sauvegarder en localStorage
  saveJobsToLocalStorage();
  
  // Si Firebase disponible, sauvegarder aussi là
  if (firebaseDb) {
    firebaseDb.ref('jobs/' + jobId).set(jobsData[jobId])
      .then(() => console.log('✅ Job sauvegardé:', jobId))
      .catch(e => console.error('❌ Erreur Firebase job:', e));
  }
}

// Supprimer un job (résolu)
function deleteJobFromFirebase(jobId) {
  // Supprimer des données locales
  delete jobsData[jobId];
  
  // Sauvegarder en localStorage
  saveJobsToLocalStorage();
  
  // Si Firebase disponible, supprimer aussi là
  if (firebaseDb) {
    firebaseDb.ref('jobs/' + jobId).remove()
      .catch(e => console.error('Erreur suppression Firebase:', e));
  }
  
  renderJobs();
  closeJobFiche();
  showToast('Job résolu et archivé');
}

// Calculer jours en attente
function calcJobDays(dateStr) {
  if (!dateStr) return 0;
  const date = new Date(dateStr);
  const today = new Date();
  return Math.floor((today - date) / (1000 * 60 * 60 * 24));
}

// Classe couleur jours
function getDaysClass(days) {
  if (days < 10) return 'ok';       // Même couleur que la carte
  if (days < 15) return 'warn';     // Jaune
  if (days < 25) return 'danger';   // Rouge
  return 'critical';                // Rouge clignotant
}

// Formater numéro de soumission (enlever les zéros au début si trop long)
function formatSoumission(num) {
  if (!num) return '-';
  // Si plus de 8 caractères et commence par des zéros, enlever les 4 premiers zéros
  if (num.length > 8 && num.startsWith('0000')) {
    return num.substring(4);
  }
  return num;
}

// Formater date en français
function formatJobDate(dateStr) {
  if (!dateStr) return '-- Sélectionner --';
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Classe région pour CSS
function getRegionClass(region) {
  if (region === 'Quebec') return 'region-quebec';
  if (region === 'Canada anglais') return 'region-canada-anglais';
  if (region === 'France') return 'region-france';
  return 'region-quebec';
}

// Nom court région
function getRegionShort(region) {
  if (region === 'Quebec') return 'QC';
  if (region === 'Canada anglais') return 'CA-EN';
  if (region === 'France') return 'FR';
  return '--';
}

// Créer une mini-carte PROPRE
function createJobMiniCard(jobId, job) {
  const days = calcJobDays(job.dateAmene);
  const daysClass = getDaysClass(days);
  const regionClass = getRegionClass(job.region);
  const regionShort = getRegionShort(job.region);
  const orderDisplay = job.order || '000000';
  const daysLabel = `${days}j en attente`;
  
  return `
    <div class="job-mini ${regionClass}" onclick="openJobFiche('${jobId}')">
      <div class="job-mini-row1">
        <span class="job-mini-region">${regionShort}</span>
        <span class="job-mini-order">#${orderDisplay}</span>
        <span class="job-mini-rep">${job.representant || '-'}</span>
      </div>
      <div class="job-mini-row2">
        <span class="job-mini-client">${job.client || '-'}</span>
      </div>
      <div class="job-mini-days ${daysClass}">${daysLabel}</div>
    </div>
  `;
}

// Afficher les jobs
function renderJobs() {
  const listSonia = document.getElementById('listSonia');
  const listJacinthe = document.getElementById('listJacinthe');
  const listNadia = document.getElementById('listNadia');
  const listNouveau = document.getElementById('listNouveau');
  
  // Si on est sur mobile, ces éléments n'existent pas - ne pas planter
  if (!listSonia && !listJacinthe && !listNadia && !listNouveau) return;
  
  let htmlSonia = '', htmlJacinthe = '', htmlNadia = '', htmlNouveau = '';
  let countSonia = 0, countJacinthe = 0, countNadia = 0, countNouveau = 0;
  
  // Trier par jours en attente (plus ancien en haut)
  const sorted = Object.entries(jobsData || {})
    .filter(([id, job]) => job && job.type === 'question')
    .sort((a, b) => calcJobDays(b[1].dateAmene) - calcJobDays(a[1].dateAmene));
  
  sorted.forEach(([id, job]) => {
    const card = createJobMiniCard(id, job);
    const assignee = job.assignee || 'Nouveau';
    
    if (assignee === 'Sonia') {
      htmlSonia += card;
      countSonia++;
    } else if (assignee === 'Jacinthe') {
      htmlJacinthe += card;
      countJacinthe++;
    } else if (assignee === 'Nadia') {
      htmlNadia += card;
      countNadia++;
    } else {
      htmlNouveau += card;
      countNouveau++;
    }
  });
  
  if (listSonia) listSonia.innerHTML = htmlSonia || '<div class="jobs-empty"><div class="jobs-empty-icon">✓</div><p>Aucun</p></div>';
  if (listJacinthe) listJacinthe.innerHTML = htmlJacinthe || '<div class="jobs-empty"><div class="jobs-empty-icon">✓</div><p>Aucun</p></div>';
  if (listNadia) listNadia.innerHTML = htmlNadia || '<div class="jobs-empty"><div class="jobs-empty-icon">✓</div><p>Aucun</p></div>';
  if (listNouveau) listNouveau.innerHTML = htmlNouveau || '<div class="jobs-empty"><div class="jobs-empty-icon">🆕</div><p>Aucun</p></div>';
  
  const countSoniaEl = document.getElementById('countSonia');
  const countJacintheEl = document.getElementById('countJacinthe');
  const countNadiaEl = document.getElementById('countNadia');
  const countNouveauEl = document.getElementById('countNouveau');
  
  if (countSoniaEl) countSoniaEl.textContent = countSonia;
  if (countJacintheEl) countJacintheEl.textContent = countJacinthe;
  if (countNadiaEl) countNadiaEl.textContent = countNadia;
  if (countNouveauEl) countNouveauEl.textContent = countNouveau;
}

// ===== FICHE JOB =====
function openJobFiche(jobId) {
  currentJobId = jobId;
  const job = jobsData[jobId];
  if (!job) return;
  
  let overlay = document.getElementById('jobFicheOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'jobFicheOverlay';
    overlay.className = 'job-fiche-overlay';
    document.body.appendChild(overlay);
  }
  
  const isMateriau = job.type === 'materiau';
  const regionClass = getRegionClass(job.region);
  
  overlay.innerHTML = `
    <div class="job-fiche ${regionClass}">
      <div class="job-fiche-main">
        <div class="job-fiche-header">
          <h2>Job en attente #${job.order || '------'}</h2>
          <button class="job-fiche-close" onclick="closeJobFiche()">×</button>
        </div>
        
        <div class="job-fiche-body">
          <!-- Ligne 1: Client + Commande -->
          <div class="job-fiche-row">
            <div class="job-fiche-field">
              <label>Client</label>
              <select id="jfClient" onchange="updateJobField('client', this.value)">
                <option value="">-- Sélectionner --</option>
                ${(customLists.moulageClients || []).map(c => `<option value="${c}" ${job.client === c ? 'selected' : ''}>${c}</option>`).join('')}
              </select>
            </div>
            <div class="job-fiche-field">
              <label>N° Commande</label>
              <input type="text" id="jfOrder" value="${job.order || ''}" onchange="updateJobField('order', this.value)">
            </div>
          </div>
          
          <!-- Ligne 2: PO + Soumission -->
          <div class="job-fiche-row">
            <div class="job-fiche-field">
              <label>Numéro PO</label>
              <input type="text" id="jfPO" value="${job.numeroPO || ''}" onchange="updateJobField('numeroPO', this.value)">
            </div>
            <div class="job-fiche-field">
              <label>Numéro Soumission</label>
              <input type="text" id="jfSoum" value="${job.numeroSoumission || ''}" onchange="updateJobField('numeroSoumission', this.value)">
            </div>
          </div>
          
          <!-- Ligne 3: Rep + Interv + Région -->
          <div class="job-fiche-row">
            <div class="job-fiche-field">
              <label>Représentante</label>
              <select id="jfRep" onchange="updateJobField('representant', this.value)">
                <option value="">-- Sélectionner --</option>
                ${(customLists.representantes || []).map(r => `<option value="${r}" ${job.representant === r ? 'selected' : ''}>${r}</option>`).join('')}
              </select>
            </div>
            <div class="job-fiche-field">
              <label>Intervenant</label>
              <select id="jfInterv" onchange="updateJobField('intervenant', this.value)">
                <option value="">-- Sélectionner --</option>
                ${(customLists.intervenants || []).map(i => `<option value="${i}" ${job.intervenant === i ? 'selected' : ''}>${i}</option>`).join('')}
              </select>
            </div>
          </div>
          
          <!-- Ligne: Assigné + Région -->
          <div class="job-fiche-row">
            <div class="job-fiche-field">
              <label>Assigné à</label>
              <select id="jfAssignee" onchange="updateJobField('assignee', this.value); renderJobs();">
                <option value="Sonia" ${job.assignee === 'Sonia' ? 'selected' : ''}>Sonia</option>
                <option value="Jacinthe" ${job.assignee === 'Jacinthe' ? 'selected' : ''}>Jacinthe</option>
                <option value="Nadia" ${job.assignee === 'Nadia' ? 'selected' : ''}>Nadia</option>
                <option value="Nouveau" ${(job.assignee === 'Nouveau' || !job.assignee) ? 'selected' : ''}>Nouveau</option>
              </select>
            </div>
            <div class="job-fiche-field">
              <label>Région</label>
              <select id="jfRegion" onchange="updateJobField('region', this.value); updateFicheRegionColor();">
                <option value="Quebec" ${job.region === 'Quebec' ? 'selected' : ''}>Québec</option>
                <option value="Canada anglais" ${job.region === 'Canada anglais' ? 'selected' : ''}>Canada anglais</option>
                <option value="France" ${job.region === 'France' ? 'selected' : ''}>France</option>
              </select>
            </div>
          </div>
          
          <!-- Ligne: Dates -->
          <div class="job-fiche-row">
            <div class="job-fiche-field">
              <label>Date réception</label>
              <div class="job-date-pill" id="jfDateRecue" onclick="openJobCalendar('dateRecue', this)">${formatJobDate(job.dateRecue)}</div>
            </div>
            <div class="job-fiche-field">
              <label>Mise en attente</label>
              <div class="job-date-pill" id="jfDateAmene" onclick="openJobCalendar('dateAmene', this)">${formatJobDate(job.dateAmene)}</div>
            </div>
            <div class="job-fiche-field">
              <label>Livraison prévue</label>
              <div class="job-date-pill" id="jfDateLivraison" onclick="openJobCalendar('dateLivraison', this)">${formatJobDate(job.dateLivraison)}</div>
            </div>
          </div>
        </div>
        
        <div class="job-fiche-footer">
          <button class="job-fiche-btn btn-delete" onclick="deleteJob()">🗑️ Supprimer</button>
          <button class="job-fiche-btn btn-close" onclick="closeJobFiche()">Fermer</button>
        </div>
      </div>
      
      <div class="job-fiche-notes">
        <div class="job-notes-header">
          <div class="job-notes-header-left">
            <span>📝 Notes & Questions</span>
            <button class="add-link-btn" onclick="showInsertLinkPopup('job')" title="Insérer un lien">🔗 Lien</button>
            <div class="job-notes-photos-btns">
              <button class="job-photo-btn ${job.photo1 ? 'has-link' : ''}" onclick="openJobPhotoMenu(1)" title="Photo 1">📷</button>
              <button class="job-photo-btn ${job.photo2 ? 'has-link' : ''}" onclick="openJobPhotoMenu(2)" title="Photo 2">📷</button>
              <button class="job-photo-btn ${job.photo3 ? 'has-link' : ''}" onclick="openJobPhotoMenu(3)" title="Photo 3">📷</button>
            </div>
          </div>
          <button class="job-notes-close" onclick="closeJobFiche()">×</button>
        </div>
        
        <!-- Boutons d'action - toute la largeur -->
        <div class="job-notes-actions">
          <button class="job-notes-action-btn btn-resolve" onclick="resolveJob()">✓ Résolu</button>
          <button class="job-notes-action-btn btn-email" onclick="sendJobEmailWithQuestions()">Envoyer questionnement service client</button>
          <button class="job-notes-action-btn btn-print" onclick="printJobNotes()">🖨️ Imprimer</button>
        </div>
        
        <div class="job-notes-body">
          <!-- Zone Questions -->
          <div class="job-questions-section">
            <div class="job-questions-label">❓ Questions pour intervenant / acheteur / agent service client</div>
            <div class="job-questions-content" 
                 id="jobQuestionsContent" 
                 contenteditable="true" 
                 onblur="saveJobQuestions()"
                 onpaste="handleQuestionsPaste(event)"
                 onclick="handleQuestionsLinkClick(event)">${job.questions || ''}</div>
          </div>
          
          <!-- Zone Réponse -->
          <div class="job-response-section">
            <div class="job-response-label">✅ Réponse</div>
            <div class="job-response-content" 
                 id="jobResponseContent" 
                 contenteditable="true" 
                 onblur="saveJobResponse()"
                 onclick="handleQuestionsLinkClick(event)">${job.response || ''}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Menu photo popup -->
    <div class="job-photo-menu" id="jobPhotoMenu" style="display:none;">
      <div class="job-photo-menu-header">📷 Photo <span id="jobPhotoMenuNum">1</span></div>
      <div class="job-photo-menu-body">
        <input type="text" id="jobPhotoUrl" placeholder="Coller l'URL de l'image..." onkeyup="if(event.key==='Enter')saveJobPhotoUrl()">
      </div>
      <div class="job-photo-menu-btns">
        <button onclick="viewJobPhoto()">👁️ Voir</button>
        <button onclick="saveJobPhotoUrl()">💾 Sauver</button>
        <button onclick="clearJobPhoto()">🗑️</button>
        <button onclick="closeJobPhotoMenu()">Fermer</button>
      </div>
    </div>
  `;
  
  overlay.style.display = 'flex';
  
  // Initialiser le redimensionnement des images existantes
  setTimeout(() => initNotesImageResizing(), 100);
}

function closeJobFiche() {
  // Sauvegarder avant de fermer
  if (currentJobId && jobsData[currentJobId]) {
    saveJobToFirebase(currentJobId);
  }
  const overlay = document.getElementById('jobFicheOverlay');
  if (overlay) overlay.style.display = 'none';
  currentJobId = null;
  closeJobPhotoMenu();
  closeCalendar();
  // Rafraîchir la liste
  renderJobs();
}

function updateFicheRegionColor() {
  const region = document.getElementById('jfRegion')?.value || 'Quebec';
  const fiche = document.querySelector('.job-fiche');
  if (fiche) {
    fiche.className = 'job-fiche ' + getRegionClass(region);
  }
}

function updateJobField(field, value) {
  if (!currentJobId || !jobsData[currentJobId]) return;
  jobsData[currentJobId][field] = value;
  jobsData[currentJobId].updatedAt = new Date().toISOString();
  saveJobToFirebase(currentJobId);
  renderJobs();
  
  // Mettre à jour la classe région si changement
  if (field === 'region') {
    const fiche = document.querySelector('.job-fiche');
    if (fiche) {
      fiche.className = 'job-fiche ' + getRegionClass(value);
    }
  }
}

// Sélectionner la région
function selectJobRegion(region) {
  document.querySelectorAll('.job-region-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.job-region-btn[data-region="${region}"]`)?.classList.add('active');
  updateJobField('region', region);
}

// ===== CALENDRIER POUR JOBS =====
function openJobCalendar(field, element) {
  if (!currentJobId) return;
  
  showCalendar({
    value: jobsData[currentJobId][field] || '',
    mode: 'modal',
    onSelect: (dateStr) => {
      if (dateStr && currentJobId && jobsData[currentJobId]) {
        jobsData[currentJobId][field] = dateStr;
        element.textContent = formatJobDate(dateStr);
        saveJobToFirebase(currentJobId);
        renderJobs();
      }
      closeCalendar();
    },
    onClear: () => {
      if (currentJobId && jobsData[currentJobId]) {
        jobsData[currentJobId][field] = '';
        element.textContent = '-- Sélectionner --';
        saveJobToFirebase(currentJobId);
        renderJobs();
      }
      closeCalendar();
    }
  });
}

// ===== PHOTOS =====
let currentJobPhotoNum = 1;

function openJobPhotoMenu(num) {
  currentJobPhotoNum = num;
  const job = jobsData[currentJobId];
  if (!job) return;
  
  document.getElementById('jobPhotoMenuNum').textContent = num;
  document.getElementById('jobPhotoUrl').value = job['photo' + num] || '';
  document.getElementById('jobPhotoMenu').style.display = 'block';
}

function closeJobPhotoMenu() {
  const menu = document.getElementById('jobPhotoMenu');
  if (menu) menu.style.display = 'none';
}

function saveJobPhotoUrl() {
  if (!currentJobId) return;
  const url = document.getElementById('jobPhotoUrl').value.trim();
  jobsData[currentJobId]['photo' + currentJobPhotoNum] = url;
  saveJobToFirebase(currentJobId);
  
  const btns = document.querySelectorAll('.job-photo-btn');
  if (btns[currentJobPhotoNum - 1]) {
    btns[currentJobPhotoNum - 1].classList.toggle('has-link', !!url);
  }
  
  closeJobPhotoMenu();
  showToast('Photo enregistrée');
}

function viewJobPhoto() {
  const url = document.getElementById('jobPhotoUrl').value.trim();
  if (url) window.open(url, '_blank');
}

function clearJobPhoto() {
  document.getElementById('jobPhotoUrl').value = '';
  saveJobPhotoUrl();
}

// ===== NOTES =====
function insertJobNoteTimestamp(event) {
  const content = document.getElementById('jobNotesContent');
  if (!content || !currentJobId) return;
  
  const isEmpty = !content.innerHTML || content.innerHTML === '<br>' || content.innerHTML.trim() === '';
  
  const now = new Date();
  const userName = currentUser?.name || 'Utilisateur';
  const dateStr = now.toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric' });
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  // Vérifier si le dernier timestamp est le même (éviter doublons)
  const signatureText = `${userName} - ${dateStr} ${timeStr}`;
  if (content.innerHTML.includes(signatureText)) {
    return; // Déjà signé cette minute
  }
  
  const timestamp = `<div class="note-timestamp"><strong>${userName}</strong> - ${dateStr} ${timeStr}</div>`;
  
  if (isEmpty) {
    content.innerHTML = timestamp + '<div><br></div>';
  } else {
    content.innerHTML += '<br>' + timestamp + '<div><br></div>';
  }
  
  // Placer le curseur à la fin
  setTimeout(() => {
    content.focus();
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(content);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
    content.scrollTop = content.scrollHeight;
    
    // Sauvegarder
    saveJobNotes();
  }, 10);
}

function handleJobNotesPaste(event) {
  // Bloquer le collage d'images - utiliser le bouton Lien à la place
  const items = event.clipboardData?.items;
  if (!items) return;
  
  for (let item of items) {
    if (item.type.indexOf('image') !== -1) {
      event.preventDefault();
      alert('⚠️ Les images ne peuvent pas être collées directement.\n\nUtilisez le bouton "🔗 Lien" pour ajouter un lien vers votre image (Google Drive, Dropbox, etc.)');
      return;
    }
  }
}

// Rendre une image redimensionnable comme Word
function makeImageResizable(img) {
  let isResizing = false;
  let startX, startY, startWidth, startHeight;
  
  img.addEventListener('mousedown', function(e) {
    // Commencer le redimensionnement seulement si on est près du bord
    const rect = img.getBoundingClientRect();
    const isNearEdge = (rect.right - e.clientX < 20) && (rect.bottom - e.clientY < 20);
    
    if (isNearEdge) {
      e.preventDefault();
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startWidth = img.offsetWidth;
      startHeight = img.offsetHeight;
      img.classList.add('resizing');
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
  });
  
  function onMouseMove(e) {
    if (!isResizing) return;
    const newWidth = startWidth + (e.clientX - startX);
    if (newWidth > 50 && newWidth < 500) {
      img.style.width = newWidth + 'px';
      img.style.height = 'auto';
    }
  }
  
  function onMouseUp() {
    isResizing = false;
    img.classList.remove('resizing');
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    saveJobNotes();
  }
}

// Initialiser le redimensionnement pour les images existantes
function initNotesImageResizing() {
  const content = document.getElementById('jobNotesContent');
  if (content) {
    content.querySelectorAll('img').forEach(img => {
      img.style.cursor = 'nwse-resize';
      makeImageResizable(img);
    });
  }
}

function saveJobNotes() {
  if (!currentJobId) return;
  const content = document.getElementById('jobNotesContent');
  if (content) {
    jobsData[currentJobId].notes = content.innerHTML;
    saveJobToFirebase(currentJobId);
  }
}

// ===== INSERTION DE LIENS DANS LES NOTES =====
// Variable pour sauvegarder la sélection
let savedSelection = null;

function saveSelection() {
  const sel = window.getSelection();
  if (sel.rangeCount > 0) {
    savedSelection = sel.getRangeAt(0).cloneRange();
  }
}

function restoreSelection() {
  if (savedSelection) {
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedSelection);
  }
}

function showInsertLinkPopup(target, cardId = null) {
  // Sauvegarder la sélection/position du curseur AVANT d'ouvrir le popup
  saveSelection();
  
  // Supprimer popup existant
  document.getElementById('insertLinkOverlay')?.remove();
  document.getElementById('insertLinkPopup')?.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'insertLinkOverlay';
  overlay.className = 'insert-link-popup-overlay';
  overlay.onclick = closeInsertLinkPopup;
  
  const popup = document.createElement('div');
  popup.id = 'insertLinkPopup';
  popup.className = 'insert-link-popup';
  popup.dataset.target = target;
  popup.dataset.cardId = cardId || '';
  popup.onclick = e => e.stopPropagation();
  popup.innerHTML = `
    <div class="insert-link-header">
      <span>🔗 Insérer un lien</span>
      <button class="insert-link-close" onclick="closeInsertLinkPopup()">×</button>
    </div>
    <div class="insert-link-body">
      <div class="insert-link-field">
        <label>URL du lien (image, document, page web...)</label>
        <input type="url" id="insertLinkUrl" placeholder="https://drive.google.com/..." oninput="updateLinkPreview()">
      </div>
      <div class="insert-link-field">
        <label>Texte à afficher (optionnel)</label>
        <input type="text" id="insertLinkText" placeholder="Ex: Photo client, Devis, etc." value="📎 Voir le fichier">
      </div>
      <div class="insert-link-preview" id="insertLinkPreview">
        <span style="color:#94a3b8;">Aperçu: </span>
        <a href="#" class="note-link" onclick="return false;">🔗 📎 Voir le fichier</a>
      </div>
    </div>
    <div class="insert-link-btns">
      <button class="btn-cancel" onclick="closeInsertLinkPopup()">Annuler</button>
      <button class="btn-insert" onclick="insertLinkIntoNotes()">✓ Insérer</button>
    </div>
  `;
  
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  
  setTimeout(() => document.getElementById('insertLinkUrl')?.focus(), 100);
}

function updateLinkPreview() {
  const url = document.getElementById('insertLinkUrl')?.value || '';
  const text = document.getElementById('insertLinkText')?.value || '📎 Voir le fichier';
  const preview = document.getElementById('insertLinkPreview');
  
  if (preview) {
    if (url) {
      preview.innerHTML = `<span style="color:#94a3b8;">Aperçu: </span><a href="${url}" target="_blank" class="note-link">🔗 ${text}</a>`;
    } else {
      preview.innerHTML = `<span style="color:#94a3b8;">Aperçu: </span><a href="#" class="note-link" onclick="return false;">🔗 ${text}</a>`;
    }
  }
}

function closeInsertLinkPopup() {
  document.getElementById('insertLinkOverlay')?.remove();
  document.getElementById('insertLinkPopup')?.remove();
}

function insertLinkIntoNotes() {
  const popup = document.getElementById('insertLinkPopup');
  const target = popup?.dataset?.target;
  const cardId = popup?.dataset?.cardId;
  
  const url = document.getElementById('insertLinkUrl')?.value?.trim();
  const text = document.getElementById('insertLinkText')?.value?.trim() || '📎 Voir le fichier';
  
  if (!url) {
    alert('Veuillez entrer une URL');
    return;
  }
  
  const linkHTML = `<a href="${url}" target="_blank" class="note-link">🔗 ${text}</a>&nbsp;`;
  let contentElement = null;
  
  if (target === 'job') {
    // Insérer dans la zone Questions
    contentElement = document.getElementById('jobQuestionsContent');
    if (contentElement) {
      // Restaurer la sélection et insérer à la position du curseur
      contentElement.focus();
      restoreSelection();
      document.execCommand('insertHTML', false, linkHTML);
      saveJobQuestions();
    }
  } else if (target === 'moulage' && cardId) {
    contentElement = document.getElementById('notesContent_' + cardId);
    if (contentElement) {
      contentElement.focus();
      restoreSelection();
      document.execCommand('insertHTML', false, linkHTML);
      saveMoulageNotes(cardId);
    }
  } else if (target === 'moulage_popup' && cardId) {
    contentElement = document.getElementById('notesContent_popup_' + cardId);
    if (contentElement) {
      contentElement.focus();
      restoreSelection();
      document.execCommand('insertHTML', false, linkHTML);
      savePopupNotes(cardId);
    }
  } else if (target === 'mobile_moulage') {
    contentElement = document.getElementById('mobileNotesContent');
    if (contentElement) {
      contentElement.focus();
      restoreSelection();
      document.execCommand('insertHTML', false, linkHTML);
      saveMobileNotesContent();
    }
  } else if (target === 'mobile_job') {
    contentElement = document.getElementById('mobileJobNotesContent');
    if (contentElement) {
      contentElement.focus();
      restoreSelection();
      document.execCommand('insertHTML', false, linkHTML);
      saveMobileJobNotesContent();
    }
  }
  
  savedSelection = null;
  closeInsertLinkPopup();
}

// Exposer les fonctions
window.showInsertLinkPopup = showInsertLinkPopup;
window.closeInsertLinkPopup = closeInsertLinkPopup;
window.updateLinkPreview = updateLinkPreview;
window.insertLinkIntoNotes = insertLinkIntoNotes;

// ===== MODAL AJOUT =====
let addJobType = 'question';
let addJobDates = { dateRecue: '', dateAmene: new Date().toISOString().split('T')[0] };

let addJobAssignee = 'Nouveau';

function showAddJobModal(defaultType = 'question', assignee = 'Nouveau') {
  addJobType = defaultType;
  addJobAssignee = assignee;
  addJobDates = { dateRecue: '', dateAmene: new Date().toISOString().split('T')[0] };
  
  const modalTitle = `Ajouter - ${assignee}`;
  
  let modal = document.getElementById('jobAddModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'jobAddModal';
    modal.className = 'job-add-overlay';
    document.body.appendChild(modal);
  }
  
  modal.innerHTML = `
    <div class="job-add-modal">
      <div class="job-add-header">
        <h3>${modalTitle}</h3>
        <div class="job-add-header-btns">
          <input type="file" id="jobJsonInput" accept=".json" style="display:none" onchange="handleImportJobJson(event)" multiple>
          <button class="job-header-import-btn" onclick="document.getElementById('jobJsonInput').click()">📥 JSON</button>
          <button class="job-add-close" onclick="closeAddJobModal()">×</button>
        </div>
      </div>
      <div class="job-add-body">
        <!-- Client + Commande -->
        <div class="job-add-row">
          <div class="job-add-field" style="flex:3;">
            <label>Client</label>
            <select id="addJobClient">
              <option value="">-- Sélectionner --</option>
              ${(customLists.moulageClients || []).map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
          </div>
          <div class="job-add-field" style="flex:1;">
            <label>N° Commande *</label>
            <input type="text" id="addJobOrder" placeholder="000000" value="000000" onclick="if(this.value==='000000')this.select()">
          </div>
        </div>
        
        <!-- Assigné à + Région -->
        <div class="job-add-row">
          <div class="job-add-field">
            <label>Assigné à</label>
            <select id="addJobAssignee">
              <option value="Sonia" ${assignee === 'Sonia' ? 'selected' : ''}>Sonia</option>
              <option value="Jacinthe" ${assignee === 'Jacinthe' ? 'selected' : ''}>Jacinthe</option>
              <option value="Nadia" ${assignee === 'Nadia' ? 'selected' : ''}>Nadia</option>
              <option value="Nouveau" ${assignee === 'Nouveau' ? 'selected' : ''}>Nouveau</option>
            </select>
          </div>
          <div class="job-add-field">
            <label>Région</label>
            <select id="addJobRegion">
              <option value="Quebec">Québec</option>
              <option value="Canada anglais">Canada anglais</option>
              <option value="France">France</option>
            </select>
          </div>
        </div>
        
        <!-- Représentante + Intervenant -->
        <div class="job-add-row">
          <div class="job-add-field">
            <label>Représentante</label>
            <select id="addJobRep">
              <option value="">-- Sélectionner --</option>
              ${(customLists.representantes || ['Marie-Soleil', 'Marie-Pier']).map(r => `<option value="${r}">${r}</option>`).join('')}
            </select>
          </div>
          <div class="job-add-field">
            <label>Intervenant</label>
            <select id="addJobInterv">
              <option value="">-- Sélectionner --</option>
              ${(customLists.intervenants || []).map(i => `<option value="${i}">${i}</option>`).join('')}
            </select>
          </div>
        </div>
        
        <!-- PO + Soumission -->
        <div class="job-add-row">
          <div class="job-add-field">
            <label>Numéro PO</label>
            <input type="text" id="addJobPO" placeholder="PO">
          </div>
          <div class="job-add-field">
            <label>Numéro Soumission</label>
            <input type="text" id="addJobSoum" placeholder="Soumission">
          </div>
        </div>
        
        <!-- Dates -->
        <div class="job-add-row">
          <div class="job-add-field">
            <label>Date réception</label>
            <div class="job-add-date-pill" id="addDateRecue" onclick="openAddJobCalendar('dateRecue', this)">-- Sélectionner --</div>
          </div>
          <div class="job-add-field">
            <label>Date mise en attente</label>
            <div class="job-add-date-pill" id="addDateAmene" onclick="openAddJobCalendar('dateAmene', this)">${formatJobDate(addJobDates.dateAmene)}</div>
          </div>
        </div>
      </div>
      <div class="job-add-footer">
        <button class="job-add-btn cancel" onclick="closeAddJobModal()">Annuler</button>
        <button class="job-add-btn save" onclick="saveNewJob()">💾 Ajouter</button>
      </div>
    </div>
  `;
  
  modal.style.display = 'flex';
}

// Import JSON - comme moulages
function handleImportJobJson(event) {
  const files = event.target.files;
  if (!files || files.length === 0) return;
  
  let totalImported = 0;
  let filesProcessed = 0;
  
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        const jobsArray = Array.isArray(data) ? data : [data];
        
        jobsArray.forEach(job => {
          if (job.order) {
            const jobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            jobsData[jobId] = {
              type: job.type || 'question',
              order: job.order || '',
              numeroPO: job.numeroPO || job.po || '',
              numeroSoumission: job.numeroSoumission || job.soumission || '',
              client: job.client || '',
              representant: job.representant || job.rep || '',
              intervenant: job.intervenant || '',
              region: job.region || 'Quebec',
              dateRecue: job.dateRecue || '',
              dateAmene: job.dateAmene || new Date().toISOString().split('T')[0],
              dateLivraison: job.dateLivraison || '',
              materiau: job.materiau || '',
              notes: job.notes || '',
              createdAt: new Date().toISOString()
            };
            saveJobToFirebase(jobId);
            totalImported++;
          }
        });
        
        filesProcessed++;
        if (filesProcessed === files.length) {
          renderJobs();
          closeAddJobModal();
          showToast(`${totalImported} job(s) importé(s)!`);
        }
      } catch (err) {
        console.error('Erreur JSON:', err);
        showToast('Erreur dans le fichier JSON');
      }
    };
    reader.readAsText(file);
  });
  
  event.target.value = '';
}

function openAddJobCalendar(field, element) {
  showCalendar({
    value: addJobDates[field] || '',
    mode: 'modal',
    onSelect: (dateStr) => {
      if (dateStr) {
        addJobDates[field] = dateStr;
        element.textContent = formatJobDate(dateStr);
      }
      closeCalendar();
    },
    onClear: () => {
      addJobDates[field] = '';
      element.textContent = '-- Sélectionner --';
      closeCalendar();
    }
  });
}

function closeAddJobModal() {
  const modal = document.getElementById('jobAddModal');
  if (modal) modal.style.display = 'none';
  closeCalendar();
}

function saveNewJob() {
  const order = document.getElementById('addJobOrder').value.trim();
  if (!order) {
    alert('Numéro de commande requis');
    return;
  }
  
  const jobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  jobsData[jobId] = {
    type: addJobType,
    order: order,
    numeroPO: document.getElementById('addJobPO').value.trim(),
    numeroSoumission: document.getElementById('addJobSoum')?.value.trim() || '',
    client: document.getElementById('addJobClient').value,
    representant: document.getElementById('addJobRep').value,
    intervenant: document.getElementById('addJobInterv').value,
    region: document.getElementById('addJobRegion').value || 'Quebec',
    assignee: document.getElementById('addJobAssignee')?.value || 'Nouveau',
    dateRecue: addJobDates.dateRecue,
    dateAmene: addJobDates.dateAmene,
    notes: '',
    createdAt: new Date().toISOString()
  };
  
  saveJobToFirebase(jobId);
  closeAddJobModal();
  renderJobs();
  // Mettre à jour la liste mobile aussi
  if (typeof renderMobileJobsList === 'function') renderMobileJobsList();
  if (typeof updateMobileMenuCounts === 'function') updateMobileMenuCounts();
  showToast('Job ajouté!');
}

// ===== ACTIONS =====

// Sauvegarder les questions
function saveJobQuestions() {
  if (!currentJobId) return;
  const content = document.getElementById('jobQuestionsContent');
  if (content) {
    jobsData[currentJobId].questions = content.innerHTML;
    saveJobToFirebase(currentJobId);
  }
}

// Gérer le collage d'images et de liens dans la zone Questions
function handleQuestionsPaste(e) {
  const items = e.clipboardData?.items;
  if (!items) return;
  
  // Chercher une image d'abord
  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf('image') !== -1) {
      e.preventDefault();
      const blob = items[i].getAsFile();
      
      // Afficher un placeholder pendant l'upload
      const placeholder = document.createElement('div');
      placeholder.style.cssText = 'padding:10px;background:#f0f9ff;border:2px dashed #3b82f6;border-radius:8px;text-align:center;margin:4px 0;';
      placeholder.innerHTML = '⏳ Upload de l\'image en cours...';
      
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(placeholder);
      } else {
        document.getElementById('jobQuestionsContent').appendChild(placeholder);
      }
      
      // Uploader sur Firebase Storage
      uploadImageToFirebase(blob, placeholder);
      return;
    }
  }
  
  // Si c'est du texte, vérifier s'il y a des URLs à convertir en liens
  const text = e.clipboardData?.getData('text/plain');
  if (text) {
    // Regex pour détecter les URLs
    const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi;
    
    if (urlRegex.test(text)) {
      e.preventDefault();
      
      // Convertir les URLs en liens cliquables
      const htmlContent = text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
      
      // Insérer le HTML à la position du curseur
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        range.deleteContents();
        
        const temp = document.createElement('div');
        temp.innerHTML = htmlContent;
        
        const frag = document.createDocumentFragment();
        while (temp.firstChild) {
          frag.appendChild(temp.firstChild);
        }
        
        range.insertNode(frag);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
      }
      
      saveJobQuestions();
      showToast('🔗 Lien(s) ajouté(s) - Cliquez pour ouvrir');
    }
  }
}

// Uploader une image sur Firebase Storage
async function uploadImageToFirebase(blob, placeholder) {
  try {
    // Vérifier si Firebase Storage est disponible
    if (!firebase.storage) {
      throw new Error('Firebase Storage non disponible');
    }
    
    const storage = firebase.storage();
    const timestamp = Date.now();
    const fileName = `questions/${currentJobId || 'unknown'}_${timestamp}.png`;
    const storageRef = storage.ref(fileName);
    
    // Uploader le fichier
    const snapshot = await storageRef.put(blob);
    
    // Obtenir l'URL de téléchargement
    const downloadURL = await snapshot.ref.getDownloadURL();
    
    // Créer le conteneur avec image et lien
    const container = document.createElement('div');
    container.style.cssText = 'margin:8px 0;padding:8px;background:#f0f9ff;border:1px solid #bfdbfe;border-radius:8px;';
    container.innerHTML = `
      <img src="${downloadURL}" style="max-width:100%;max-height:200px;border-radius:4px;display:block;margin-bottom:6px;">
      <a href="${downloadURL}" target="_blank" style="font-size:11px;color:#2563eb;word-break:break-all;">📎 ${downloadURL}</a>
    `;
    
    // Remplacer le placeholder
    placeholder.replaceWith(container);
    
    saveJobQuestions();
    showToast('✅ Image uploadée et lien créé!');
    
  } catch (error) {
    console.error('Erreur upload:', error);
    
    // Fallback: afficher l'image en base64 (ne sera pas dans l'email)
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = document.createElement('img');
      img.src = event.target.result;
      img.style.cssText = 'max-width:100%;max-height:200px;margin:4px 0;border-radius:4px;border:1px solid #ddd;';
      placeholder.replaceWith(img);
      saveJobQuestions();
      showToast('📷 Image affichée (lien non créé: ' + error.message + ')');
    };
    reader.readAsDataURL(blob);
  }
}

// Gérer les clics sur les liens dans la zone Questions
function handleQuestionsLinkClick(e) {
  // Vérifier si le clic est sur un lien ou un élément enfant d'un lien
  let target = e.target;
  while (target && target !== e.currentTarget) {
    if (target.tagName === 'A' && target.href) {
      e.preventDefault();
      e.stopPropagation();
      // Ouvrir le lien dans un nouvel onglet
      window.open(target.href, '_blank');
      return;
    }
    target = target.parentElement;
  }
}

// Sauvegarder la réponse
function saveJobResponse() {
  if (!currentJobId) return;
  const content = document.getElementById('jobResponseContent');
  if (content) {
    jobsData[currentJobId].response = content.innerHTML;
    saveJobToFirebase(currentJobId);
  }
}

// Résolu = envoie email à Daniel avec questions + réponses + liens
function resolveJob() {
  if (!currentJobId) return;
  const job = jobsData[currentJobId];
  if (!job) return;
  
  if (!confirm('Marquer ce job comme résolu?\n\nUn email sera envoyé à Daniel pour notification.')) return;
  
  // Récupérer les questions (texte seulement)
  const questionsEl = document.getElementById('jobQuestionsContent');
  let questionsText = '';
  if (questionsEl) {
    const temp = document.createElement('div');
    temp.innerHTML = questionsEl.innerHTML;
    questionsText = temp.innerText || temp.textContent || '';
  }
  
  // Récupérer les réponses (texte seulement)
  const responseEl = document.getElementById('jobResponseContent');
  let responseText = '';
  if (responseEl) {
    const temp = document.createElement('div');
    temp.innerHTML = responseEl.innerHTML;
    responseText = temp.innerText || temp.textContent || '';
  }
  
  // Récupérer les liens photos
  let photosText = '';
  if (job.photo1) photosText += `📷 Photo 1: ${job.photo1}\n`;
  if (job.photo2) photosText += `📷 Photo 2: ${job.photo2}\n`;
  if (job.photo3) photosText += `📷 Photo 3: ${job.photo3}\n`;
  
  // Construire l'email
  const subject = encodeURIComponent(`✓ Job #${job.order} RÉSOLU - ${job.client}`);
  
  let body = `Bonjour Daniel,\n\n`;
  body += `Le job en attente suivant a été marqué comme RÉSOLU:\n\n`;
  body += `═══════════════════════════════════════\n`;
  body += `📋 COMMANDE: #${job.order}\n`;
  body += `👤 CLIENT: ${job.client || '-'}\n`;
  body += `📍 RÉGION: ${job.region || '-'}\n`;
  body += `👩 REPRÉSENTANTE: ${job.representant || '-'}\n`;
  body += `👨‍⚕️ INTERVENANT: ${job.intervenant || '-'}\n`;
  body += `📅 EN ATTENTE DEPUIS: ${formatJobDate(job.dateAmene)}\n`;
  body += `═══════════════════════════════════════\n\n`;
  
  if (questionsText.trim()) {
    body += `❓ QUESTIONS:\n${questionsText}\n\n`;
  }
  
  if (responseText.trim()) {
    body += `✅ RÉPONSES:\n${responseText}\n\n`;
  }
  
  if (photosText) {
    body += `🖼️ LIENS PHOTOS/DOCUMENTS:\n${photosText}\n`;
  }
  
  body += `\n---\nNotification automatique PhysiPro`;
  
  // Ouvrir l'email
  window.open(`mailto:atelieratp@physipro.com?subject=${subject}&body=${encodeURIComponent(body)}`);
  
  // Supprimer le job
  deleteJobFromFirebase(currentJobId);
}

// Supprimer sans notification
function deleteJob() {
  if (!currentJobId) return;
  if (!confirm('⚠️ Supprimer ce job définitivement?\n\nCette action est irréversible.')) return;
  deleteJobFromFirebase(currentJobId);
}

// Email avec questions et liens photos
function sendJobEmailWithQuestions() {
  if (!currentJobId) return;
  const job = jobsData[currentJobId];
  if (!job) return;
  
  // Récupérer les questions (garder les liens)
  const questionsEl = document.getElementById('jobQuestionsContent');
  let questionsText = '';
  let imagesLinks = [];
  
  if (questionsEl) {
    // Cloner le contenu pour manipulation
    const temp = document.createElement('div');
    temp.innerHTML = questionsEl.innerHTML;
    
    // Extraire les liens des images uploadées (Firebase Storage)
    temp.querySelectorAll('a').forEach(a => {
      const href = a.href || '';
      if (href.includes('firebasestorage') || href.includes('firebase')) {
        imagesLinks.push(href);
      }
    });
    
    // Convertir les <a> en texte avec URL
    temp.querySelectorAll('a').forEach(a => {
      a.textContent = a.href;
    });
    
    // Retirer les images pour le texte (on garde juste le lien)
    temp.querySelectorAll('img').forEach(img => img.remove());
    
    questionsText = temp.innerText || temp.textContent || '';
    // Nettoyer les espaces multiples
    questionsText = questionsText.replace(/\n{3,}/g, '\n\n').trim();
  }
  
  // Récupérer les liens photos existants
  let photosText = '';
  if (job.photo1) photosText += `📷 Photo 1: ${job.photo1}\n`;
  if (job.photo2) photosText += `📷 Photo 2: ${job.photo2}\n`;
  if (job.photo3) photosText += `📷 Photo 3: ${job.photo3}\n`;
  
  // Sujet avec nom de l'assignée
  const assignee = job.assignee || 'Service client';
  const subject = encodeURIComponent(`Pour ${assignee} - Commande #${job.order} en questionnement`);
  
  let body = `Bonjour,\n\n`;
  body += `Concernant la commande #${job.order} pour ${job.client || 'le client'}:\n\n`;
  
  if (questionsText.trim()) {
    body += `📋 QUESTIONS:\n${questionsText}\n\n`;
  } else {
    body += `📋 QUESTIONS:\n[Aucune question spécifiée]\n\n`;
  }
  
  // Ajouter les images uploadées dans les questions
  if (imagesLinks.length > 0) {
    body += `🖼️ IMAGES JOINTES:\n`;
    imagesLinks.forEach((link, idx) => {
      body += `📷 Image ${idx + 1}: ${link}\n`;
    });
    body += `\n`;
  }
  
  if (photosText) {
    body += `📎 LIENS PHOTOS/DOCUMENTS:\n${photosText}\n`;
  }
  
  body += `\n---\n`;
  body += `Informations du job:\n`;
  body += `• Commande: #${job.order}\n`;
  body += `• Client: ${job.client || '-'}\n`;
  body += `• PO: ${job.numeroPO || '-'}\n`;
  body += `• Assigné à: ${assignee}\n`;
  body += `• Représentante: ${job.representant || '-'}\n`;
  body += `• Intervenant: ${job.intervenant || '-'}\n`;
  body += `• Région: ${job.region || '-'}\n`;
  
  window.open(`mailto:orders@physipro.com?subject=${subject}&body=${encodeURIComponent(body)}`);
}

// Imprimer les questions et réponses
function printJobNotes() {
  if (!currentJobId) return;
  const job = jobsData[currentJobId];
  if (!job) return;
  
  const questionsEl = document.getElementById('jobQuestionsContent');
  const responseEl = document.getElementById('jobResponseContent');
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Job #${job.order} - Questions & Réponses</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { font-size: 18px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .info { margin-bottom: 20px; font-size: 12px; color: #666; }
        .section { margin-bottom: 15px; }
        .section-title { font-size: 13px; font-weight: bold; margin-bottom: 5px; padding: 5px; background: #f0f0f0; }
        .section-content { padding: 10px; border: 1px solid #ddd; min-height: 40px; }
        .questions { background: #fff9e6; border-color: #f59e0b; }
        .response { background: #dcfce7; border-color: #22c55e; }
        .photos { font-size: 11px; margin-top: 15px; }
        .photos a { color: #2563eb; }
        @media print { body { padding: 0; } }
      </style>
    </head>
    <body>
      <h1>📋 Job #${job.order} - ${job.client || 'Client'}</h1>
      <div class="info">
        <strong>Région:</strong> ${job.region || '-'} | 
        <strong>Rep:</strong> ${job.representant || '-'} | 
        <strong>Intervenant:</strong> ${job.intervenant || '-'} |
        <strong>Date:</strong> ${new Date().toLocaleDateString('fr-CA')}
      </div>
      
      <div class="section">
        <div class="section-title">❓ Questions</div>
        <div class="section-content questions">${questionsEl?.innerHTML || '<em>Aucune question</em>'}</div>
      </div>
      
      <div class="section">
        <div class="section-title">✅ Réponses</div>
        <div class="section-content response">${responseEl?.innerHTML || '<em>Aucune réponse</em>'}</div>
      </div>
      
      ${(job.photo1 || job.photo2 || job.photo3) ? `
      <div class="photos">
        <strong>🖼️ Liens photos:</strong><br>
        ${job.photo1 ? `<a href="${job.photo1}" target="_blank">Photo 1</a><br>` : ''}
        ${job.photo2 ? `<a href="${job.photo2}" target="_blank">Photo 2</a><br>` : ''}
        ${job.photo3 ? `<a href="${job.photo3}" target="_blank">Photo 3</a><br>` : ''}
      </div>
      ` : ''}
      
      <script>window.onload = function() { window.print(); }<\/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}

// Ancienne fonction pour compatibilité
async function sendJobEmail() {
  sendJobEmailWithQuestions();
}

// Init
function initJobsPage() {
  loadJobsFromFirebase();
}

// Exports
window.showAddJobModal = showAddJobModal;
window.closeAddJobModal = closeAddJobModal;
window.saveNewJob = saveNewJob;
window.handleImportJobJson = handleImportJobJson;
window.openJobFiche = openJobFiche;
window.closeJobFiche = closeJobFiche;
window.updateJobField = updateJobField;
window.updateFicheRegionColor = updateFicheRegionColor;
window.selectJobRegion = selectJobRegion;
window.openJobCalendar = openJobCalendar;
window.openAddJobCalendar = openAddJobCalendar;
window.openJobPhotoMenu = openJobPhotoMenu;
window.closeJobPhotoMenu = closeJobPhotoMenu;
window.saveJobPhotoUrl = saveJobPhotoUrl;
window.viewJobPhoto = viewJobPhoto;
window.clearJobPhoto = clearJobPhoto;
window.insertJobNoteTimestamp = insertJobNoteTimestamp;
window.handleJobNotesPaste = handleJobNotesPaste;
window.makeImageResizable = makeImageResizable;
window.initNotesImageResizing = initNotesImageResizing;
window.saveJobNotes = saveJobNotes;
window.saveJobQuestions = saveJobQuestions;
window.handleQuestionsPaste = handleQuestionsPaste;
window.handleQuestionsLinkClick = handleQuestionsLinkClick;
window.uploadImageToFirebase = uploadImageToFirebase;
window.saveJobResponse = saveJobResponse;
window.resolveJob = resolveJob;
window.deleteJob = deleteJob;
window.sendJobEmail = sendJobEmail;
window.sendJobEmailWithQuestions = sendJobEmailWithQuestions;
window.printJobNotes = printJobNotes;

// INTERFACE MOBILE - COMPLÈTEMENT SÉPARÉE DU DESKTOP
// =============================================================================

// Détecter si on est sur mobile/tablette
function isMobileDevice() {
  // Détection plus stricte : seulement si petit écran ET appareil mobile
  const isSmallScreen = window.innerWidth <= 1024;
  const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
  const isMobileUserAgent = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  // Mobile seulement si petit écran ET (userAgent mobile OU très petit écran)
  return isSmallScreen && (isMobileUserAgent || window.innerWidth <= 768);
}

// Variables globales mobile
var currentMobileFicheId = null;
var mobileSwipeCurrentPage = 0; // 0=Info, 1=Notes

// Fonction appelée APRÈS la connexion réussie
function initMobileAfterLogin() {
  if (!isMobileDevice()) return;
  
  // Cacher le board desktop
  const appRoot = document.querySelector('.app-root');
  if (appRoot) appRoot.style.display = 'none';
  
  // Créer les overlays mobiles s'ils n'existent pas
  if (!document.getElementById('mobileHomeOverlay')) {
    createMobileHomeHTML();
  }
  if (!document.getElementById('mobileMenuOverlay')) {
    createMobileMenuHTML();
  }
  
  // Afficher le menu principal
  showMobileMenu();
  
  // Mettre à jour les compteurs
  let checkCount = 0;
  const checkInterval = setInterval(() => {
    updateMobileDataCount();
    const moulagesCount = Object.keys(cardsData || {}).length;
    const jobsCount = Object.keys(jobsData || {}).filter(k => jobsData[k] && jobsData[k].type === 'question').length;
    
    const menuMoulagesCount = document.getElementById('menuMoulagesCount');
    const menuJobsCount = document.getElementById('menuJobsCount');
    if (menuMoulagesCount) menuMoulagesCount.textContent = `(${moulagesCount})`;
    if (menuJobsCount) menuJobsCount.textContent = `(${jobsCount})`;
    
    checkCount++;
    if (checkCount >= 10 || moulagesCount > 0) {
      clearInterval(checkInterval);
    }
  }, 1000);
}

// Mettre à jour le compteur de moulages chargés
function updateMobileDataCount() {
  const count = Object.keys(cardsData).length;
  const countEl = document.getElementById('mobileDataCount');
  
  if (countEl) {
    if (count > 0) {
      countEl.textContent = `${count} moulage${count > 1 ? 's' : ''} chargé${count > 1 ? 's' : ''}`;
      countEl.style.color = '#22c55e';
      
      // Afficher les cartes si pas de recherche en cours
      const input = document.getElementById('mobileSearchInput');
      if (!input || input.value.trim() === '') {
        displayAllMobileCards();
      }
    } else {
      countEl.textContent = '⏳ Chargement...';
      countEl.style.color = '#fbbf24';
    }
  }
}

// Créer le HTML de l'écran d'accueil mobile
function createMobileHomeHTML() {
  const mobileHTML = `
    <!-- ÉCRAN D'ACCUEIL MOBILE -->
    <div class="mobile-home-overlay" id="mobileHomeOverlay">
      <div class="mobile-home-header">
        <button class="mobile-home-back" onclick="closeMobileMoulages()">←</button>
        <h1 class="mobile-home-title">Outil de gestion des moulages</h1>
        <button class="mobile-home-add" onclick="showAddMoulageModal()">+</button>
      </div>
      
      <div class="mobile-search-container">
        <div class="mobile-search-box">
          <span class="mobile-search-icon">🔍</span>
          <input type="text" id="mobileSearchInput" placeholder="Rechercher..." autocomplete="off">
          <span class="mobile-search-clear" id="mobileSearchClear" onclick="clearMobileSearch()">✕</span>
        </div>
        <div class="mobile-cards-count" id="mobileDataCount">⏳ Chargement...</div>
      </div>
      
      <div class="mobile-search-results" id="mobileSearchResults">
        <div class="mobile-search-hint" id="mobileSearchHint">
          <div class="mobile-search-hint-icon">⏳</div>
          <div class="mobile-search-hint-text">
            Chargement des moulages...<br>
            Veuillez patienter
          </div>
        </div>
      </div>
    </div>
    
    <!-- FICHE MOBILE AVEC SWIPE - 2 PAGES -->
    <div class="mobile-fiche-overlay" id="mobileFicheOverlay">
      <div class="mobile-fiche-header">
        <button class="mobile-fiche-back" onclick="closeMobileFiche()">
          ← Retour
        </button>
        <div class="mobile-fiche-title" id="mobileFicheTitle">Nom du moulage</div>
        <div class="mobile-fiche-order" id="mobileFicheOrder">#000000</div>
      </div>
      
      <div class="mobile-fiche-swipe-container" id="mobileFicheSwipeContainer">
        <div class="mobile-fiche-swipe-wrapper-2pages" id="mobileFicheSwipeWrapper">
          
          <!-- PAGE INFO (gauche - index 0) -->
          <div class="mobile-fiche-page mobile-page-info" id="mobilePageInfo">
            <!-- Contenu généré dynamiquement -->
          </div>
          
          <!-- PAGE NOTES (droite - index 1) -->
          <div class="mobile-fiche-page mobile-page-notes" id="mobilePageNotes">
            <!-- Section Photos 1-6 -->
            <div class="mobile-notes-photos-section" id="mobileNotesPhotos">
              <!-- Contenu généré dynamiquement -->
            </div>
            <div class="mobile-notes-content-editable" 
                 id="mobileNotesContent" 
                 contenteditable="true"
                 onclick="insertMobileNoteTimestamp(event)"
                 onpaste="handleMobileNotesPaste(event)"
                 onblur="saveMobileNotesContent()"></div>
          </div>
          
        </div>
      </div>
      
      <div class="mobile-swipe-hint" id="mobileSwipeHint">
        <span class="mobile-swipe-hint-arrow">←</span>
        <span>Glissez pour Notes</span>
        <span class="mobile-swipe-hint-arrow">→</span>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', mobileHTML);
  
  // Initialiser les événements
  initMobileSearchEvents();
  initMobileSwipeEvents();
}

// Afficher l'écran d'accueil mobile
function showMobileHome() {
  const overlay = document.getElementById('mobileHomeOverlay');
  if (overlay) {
    overlay.classList.add('active');
    setTimeout(() => {
      const input = document.getElementById('mobileSearchInput');
      if (input) input.focus();
    }, 300);
  }
}

// Masquer l'écran d'accueil mobile
function hideMobileHome() {
  const overlay = document.getElementById('mobileHomeOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

// Basculer vers le mode desktop
function switchToDesktopMode() {
  hideMobileHome();
  closeMobileFiche();
  const appRoot = document.querySelector('.app-root');
  if (appRoot) appRoot.style.display = '';
}

// Initialiser les événements de recherche
function initMobileSearchEvents() {
  const input = document.getElementById('mobileSearchInput');
  const clearBtn = document.getElementById('mobileSearchClear');
  
  if (input) {
    input.addEventListener('input', function() {
      const query = this.value.trim();
      clearBtn.classList.toggle('visible', query.length > 0);
      performMobileSearch(query);
    });
  }
  
  // Afficher tous les moulages au démarrage
  setTimeout(() => {
    displayAllMobileCards();
  }, 500);
}

// Afficher toutes les cartes de moulages
function displayAllMobileCards() {
  const results = document.getElementById('mobileSearchResults');
  if (!results) return;
  
  const dataCount = Object.keys(cardsData).length;
  if (dataCount === 0) {
    results.innerHTML = `
      <div class="mobile-search-hint">
        <div class="mobile-search-hint-icon">⏳</div>
        <div class="mobile-search-hint-text">
          Chargement des données...<br>
          Veuillez patienter
        </div>
      </div>
    `;
    return;
  }
  
  // Trier : EN ATTENTE en premier, puis par nom alphabétique
  const sortedCards = Object.entries(cardsData)
    .sort((a, b) => {
      const isAttenteA = (a[1].columnIndex === 7) ? 0 : 1;
      const isAttenteB = (b[1].columnIndex === 7) ? 0 : 1;
      
      // En attente en premier
      if (isAttenteA !== isAttenteB) return isAttenteA - isAttenteB;
      
      // Puis par nom alphabétique
      const nameA = (a[1].name || '').toLowerCase();
      const nameB = (b[1].name || '').toLowerCase();
      return nameA.localeCompare(nameB, 'fr');
    });
  
  results.innerHTML = sortedCards.map(([cardId, card]) => createMobileCardHTML(cardId, card)).join('');
}

// Créer le HTML d'une carte mobile (style PC compact)
function createMobileCardHTML(cardId, card) {
  const regionClass = getMobileRegionClass(card.region);
  const daysInfo = calculateMobileDaysRemaining(card);
  const isEnAttente = card.columnIndex === 7;
  
  // Texte région abrégé
  let regionText = 'QC';
  if (regionClass === 'region-on') regionText = 'ON';
  else if (regionClass === 'region-ma') regionText = 'MA';
  
  // Représentante (raccourcie)
  let repText = '-';
  if (card.representant) {
    repText = card.representant;
    if (repText.length > 12) {
      repText = repText.split(' ')[0];
    }
  }
  
  // Raison attente
  const raisonAttente = card.raisonAttente || '';
  
  // Statut basé sur la colonne
  const statusNames = ['Robot', 'Dégauchage', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expédition', 'En attente'];
  const statusClasses = ['robot', 'degauchage', 'essayage', 'atelier', 'couture', 'peinture', 'expedition', 'attente'];
  const colIndex = card.columnIndex || 0;
  const statusText = statusNames[colIndex] || 'Robot';
  const statusClass = statusClasses[colIndex] || 'robot';
  
  // HTML pour la carte - Statut + Nom sur la même ligne
  return `
    <div class="mobile-card ${regionClass} ${isEnAttente ? 'en-attente' : ''}" onclick="openMobileFiche('${cardId}')">
      <div class="mobile-card-top">
        <div class="mobile-card-status status-${statusClass}">${statusText}</div>
        <div class="mobile-card-name">${card.name || 'Sans nom'}</div>
      </div>
      <div class="mobile-card-middle">
        <span class="mobile-card-rep">${repText}</span>
        <span class="mobile-card-order">#${card.order || '000000'}</span>
        <span class="mobile-card-region">${regionText}</span>
      </div>
      ${isEnAttente 
        ? `<div class="mobile-card-attente-badge">⏳ EN ATTENTE</div>
           ${raisonAttente ? `<div class="mobile-card-raison">${raisonAttente}</div>` : ''}`
        : `<div class="mobile-card-delay ${daysInfo.class}">${daysInfo.text}</div>`
      }
    </div>
  `;
}

// Calculer les jours restants pour mobile (version simplifiée et robuste)
function calculateMobileDaysRemaining(card) {
  // Si pas de date livraison, retourner vide
  if (!card.dateLivraison) return { text: '-', class: '' };
  
  try {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dateLiv = new Date(card.dateLivraison + 'T00:00:00');
    
    if (isNaN(dateLiv.getTime())) return { text: '-', class: '' };
    
    // Calculer différence en jours
    const diffTime = dateLiv - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
      return { text: `${Math.abs(diffDays)}j retard`, class: 'retard' };
    } else if (diffDays <= 3) {
      return { text: `${diffDays}j`, class: 'urgent' };
    } else if (diffDays <= 10) {
      return { text: `${diffDays}j`, class: 'warning' };
    } else {
      return { text: `${diffDays}j`, class: '' };
    }
  } catch (e) {
    return { text: '-', class: '' };
  }
}

// Obtenir la classe de région
function getMobileRegionClass(region) {
  if (!region) return 'region-qc';
  const r = region.toLowerCase();
  if (r.includes('ontario') || r.includes('on')) return 'region-on';
  if (r.includes('maritime') || r.includes('ma') || r.includes('nova') || r.includes('halifax')) return 'region-ma';
  return 'region-qc';
}

// Effacer la recherche
function clearMobileSearch() {
  const input = document.getElementById('mobileSearchInput');
  const clearBtn = document.getElementById('mobileSearchClear');
  
  if (input) input.value = '';
  if (clearBtn) clearBtn.classList.remove('visible');
  
  displayAllMobileCards();
}

// Effectuer la recherche mobile
function performMobileSearch(query) {
  const results = document.getElementById('mobileSearchResults');
  if (!results) return;
  
  const dataCount = Object.keys(cardsData).length;
  if (dataCount === 0) {
    results.innerHTML = `
      <div class="mobile-search-hint">
        <div class="mobile-search-hint-icon">⏳</div>
        <div class="mobile-search-hint-text">
          Chargement des données en cours...<br>
          Veuillez patienter quelques secondes
        </div>
      </div>
    `;
    return;
  }
  
  // Si pas de recherche, afficher tous les moulages
  if (query.length < 1) {
    displayAllMobileCards();
    return;
  }
  
  const queryLower = query.toLowerCase();
  const matches = [];
  
  // Rechercher dans toutes les cartes
  Object.entries(cardsData).forEach(([cardId, card]) => {
    const allFields = [
      card.name, card.order, card.client, card.intervenant,
      card.representant, card.numeroPO, card.numeroSoumission,
      card.region, card.item, card.notes
    ].filter(Boolean).map(f => String(f).toLowerCase());
    
    if (allFields.some(field => field.includes(queryLower))) {
      matches.push({ cardId, card });
    }
  });
  
  // Afficher les résultats
  if (matches.length === 0) {
    results.innerHTML = `
      <div class="mobile-no-results">
        <div class="mobile-no-results-icon">🔍</div>
        <div class="mobile-no-results-text">Aucun moulage trouvé pour "${query}"</div>
      </div>
    `;
    return;
  }
  
  // Trier : EN ATTENTE en premier, puis par nom alphabétique
  matches.sort((a, b) => {
    const isAttenteA = (a.card.columnIndex === 7) ? 0 : 1;
    const isAttenteB = (b.card.columnIndex === 7) ? 0 : 1;
    
    if (isAttenteA !== isAttenteB) return isAttenteA - isAttenteB;
    
    const nameA = (a.card.name || '').toLowerCase();
    const nameB = (b.card.name || '').toLowerCase();
    return nameA.localeCompare(nameB, 'fr');
  });
  
  results.innerHTML = matches.map(({ cardId, card }) => createMobileCardHTML(cardId, card)).join('');
}

// Ouvrir une fiche mobile
function openMobileFiche(cardId) {
  const card = cardsData[cardId];
  if (!card) return;
  
  currentMobileFicheId = cardId;
  mobileSwipeCurrentPage = 0; // Commencer sur Info (page 0)
  mobileNoteTimestampAdded = false; // Réinitialiser pour permettre nouvelle signature
  
  // Mettre à jour le header
  document.getElementById('mobileFicheTitle').textContent = card.name || 'Sans nom';
  document.getElementById('mobileFicheOrder').textContent = '#' + (card.order || '000000');
  
  // Générer le contenu des pages
  renderMobilePageInfo(card);
  renderMobilePageNotes(card);
  
  // Afficher la fiche
  document.getElementById('mobileFicheOverlay').classList.add('active');
  
  // Positionner sur la page Info (page 0)
  updateMobileSwipePosition2Pages(0, false);
  
  // Masquer le hint après 3 secondes
  setTimeout(() => {
    const hint = document.getElementById('mobileSwipeHint');
    if (hint) hint.style.opacity = '0';
  }, 3000);
}

// Fermer la fiche mobile
function closeMobileFiche() {
  // Sauvegarder les notes avant de fermer
  saveMobileNotesContent();
  
  document.getElementById('mobileFicheOverlay').classList.remove('active');
  currentMobileFicheId = null;
  
  // Réafficher le hint pour la prochaine fois
  const hint = document.getElementById('mobileSwipeHint');
  if (hint) hint.style.opacity = '1';
  
  showMobileHome();
  
  // Rafraîchir la liste des cartes
  const input = document.getElementById('mobileSearchInput');
  if (!input || input.value.trim() === '') {
    displayAllMobileCards();
  } else {
    performMobileSearch(input.value.trim());
  }
}

// Générer la page Info
function renderMobilePageInfo(card) {
  const container = document.getElementById('mobilePageInfo');
  
  // Calculer le statut
  const colIndex = card.columnIndex || 0;
  const colNames = ['Robot', 'Dégauchage', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expédition', 'En attente'];
  const currentDept = colNames[colIndex] || 'Robot';
  const isAttente = colIndex === 7;
  const raisonAttente = card.raisonAttente || '';
  
  // Déterminer le texte du statut avec article
  let article = 'À ';
  if (currentDept === 'Robot' || currentDept === 'Dégauchage') article = 'Au ';
  else if (currentDept === 'Atelier' || currentDept === 'Essayage') article = "À l'";
  else if (currentDept === 'Couture' || currentDept === 'Peinture' || currentDept === 'Expédition') article = 'À la ';
  else if (isAttente) article = '';
  
  // Date depuis (à partir du tracking)
  let dateSince = '';
  const deptKey = ['robot', 'degauchage', 'essayage', 'atelier', 'couture', 'peinture', 'expedition'][colIndex];
  if (isAttente && card.dateAttente) {
    dateSince = card.dateAttente;
  } else if (card.tracking && card.tracking[deptKey] && card.tracking[deptKey].entree) {
    dateSince = card.tracking[deptKey].entree;
  } else if (card.dateRecue) {
    dateSince = card.dateRecue;
  }
  
  // Texte statut sur une ligne
  let statutLine = isAttente ? 'EN ATTENTE' : `${article}${currentDept}`;
  if (dateSince) statutLine += ` depuis ${dateSince}`;
  
  container.innerHTML = `
    <div class="mobile-info-card" style="flex: 1;">
      <!-- STATUT - Cliquable pour voir/modifier l'historique -->
      <div class="mobile-status-block ${isAttente ? 'attente' : ''}" onclick="openMobileDeptHistory()">
        <span class="mobile-status-text">${statutLine}</span>
        <span class="mobile-status-edit">📊 Voir historique</span>
        ${isAttente && raisonAttente ? `<span class="mobile-status-raison blink">${raisonAttente}</span>` : ''}
      </div>
      
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">👤 Nom du Moulage</span>
        <span class="mobile-info-value" style="font-weight:700;">${card.name || '-'}</span>
      </div>
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">🔢 # de commande</span>
        <span class="mobile-info-value highlight">${card.order || '-'}</span>
      </div>
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">📋 # de soumission</span>
        <span class="mobile-info-value">${formatSoumission(card.numeroSoumission)}</span>
      </div>
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">📑 # de PO</span>
        <span class="mobile-info-value">${card.numeroPO || '-'}</span>
      </div>
      <div class="mobile-info-row size-plus1">
        <span class="mobile-info-label">🏢 Client</span>
        <span class="mobile-info-value shrink-text">${card.client || '-'}</span>
      </div>
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">🗺️ Région</span>
        <span class="mobile-info-value">${card.region || '-'}</span>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">👩‍⚕️ Intervenant</span>
        <span class="mobile-info-value shrink-text">${card.intervenant || '-'}</span>
      </div>
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">👩‍💼 Représentante</span>
        <span class="mobile-info-value shrink-text">${card.representant || '-'}</span>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <!-- DATES CLIQUABLES (labels courts, taille réduite) -->
      <div class="mobile-info-row mobile-date-row">
        <span class="mobile-info-label">📥 Réception</span>
        <span class="mobile-info-value mobile-date-editable" onclick="openMobileMoulageCalendar('dateRecue')">${card.dateRecue || 'Sélectionner'}</span>
      </div>
      <div class="mobile-info-row mobile-date-row">
        <span class="mobile-info-label">📦 Livraison</span>
        <span class="mobile-info-value mobile-date-editable highlight" onclick="openMobileMoulageCalendar('dateLivraison')">${card.dateLivraison || 'Sélectionner'}</span>
      </div>
      <div class="mobile-info-row mobile-date-row">
        <span class="mobile-info-label">🤖 Fab. robot</span>
        <span class="mobile-info-value mobile-date-editable" onclick="openMobileMoulageCalendar('dateRobot')">${card.dateRobot || 'Sélectionner'}</span>
      </div>
      <div class="mobile-info-row mobile-date-row">
        <span class="mobile-info-label">📅 RDV essayage</span>
        <span class="mobile-info-value mobile-date-editable" onclick="openMobileMoulageCalendar('dateEssayage')">${card.dateEssayage || 'Sélectionner'}</span>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <!-- ITEM CLIQUABLE -->
      <div class="mobile-info-row size-plus2">
        <span class="mobile-info-label">📦 Item</span>
        <span class="mobile-info-value mobile-item-editable" onclick="openMobileItemSelector()">${card.item || '-- Sélectionner --'}</span>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <!-- PHOTOS - 3 boutons avec icône caméra -->
      <div class="mobile-photos-section">
        <div class="mobile-photos-row">
          <div class="mobile-photo-btn ${card.photoClient ? 'has-photo' : ''}" onclick="openMobilePhotoLink('client')">📷 Client</div>
          <div class="mobile-photo-btn ${card.photoAtelier ? 'has-photo' : ''}" onclick="openMobilePhotoLink('atelier')">📷 Atelier</div>
          <div class="mobile-photo-btn ${card.photoDevis ? 'has-photo' : ''}" onclick="openMobilePhotoLink('devis')">📷 Devis</div>
        </div>
      </div>
    </div>
  `;
}

// Générer la page Notes (avec support images)
function renderMobilePageNotes(card) {
  // Générer les 6 boutons photos (vert si vide, bleu si plein) - Utilise notePhoto1, etc. pour synchro avec PC
  const photosSection = document.getElementById('mobileNotesPhotos');
  if (photosSection) {
    photosSection.innerHTML = `
      <div class="mobile-notes-photos-row">
        <span class="mobile-photo-icon-notes">📷</span>
        <div class="mobile-photo-btn-notes ${card.notePhoto1 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('notePhoto1')">${card.notePhoto1 ? '1 ✓' : '1'}</div>
        <div class="mobile-photo-btn-notes ${card.notePhoto2 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('notePhoto2')">${card.notePhoto2 ? '2 ✓' : '2'}</div>
        <div class="mobile-photo-btn-notes ${card.notePhoto3 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('notePhoto3')">${card.notePhoto3 ? '3 ✓' : '3'}</div>
        <div class="mobile-photo-btn-notes ${card.notePhoto4 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('notePhoto4')">${card.notePhoto4 ? '4 ✓' : '4'}</div>
        <div class="mobile-photo-btn-notes ${card.notePhoto5 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('notePhoto5')">${card.notePhoto5 ? '5 ✓' : '5'}</div>
        <div class="mobile-photo-btn-notes ${card.notePhoto6 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('notePhoto6')">${card.notePhoto6 ? '6 ✓' : '6'}</div>
      </div>
    `;
  }
  
  // Notes (contenteditable avec support images)
  const content = document.getElementById('mobileNotesContent');
  if (content) {
    content.innerHTML = card.notes || '';
    // Initialiser le redimensionnement des images existantes
    setTimeout(() => initMobileNotesImageResizing(), 100);
  }
}

// Variable globale pour le timestamp moulages
var mobileNoteTimestampAdded = false;

// Insérer timestamp au clic dans les notes moulage mobile  
function insertMobileNoteTimestamp(event) {
  if (mobileNoteTimestampAdded) return;
  mobileNoteTimestampAdded = true;
  
  const content = document.getElementById('mobileNotesContent');
  if (!content) return;
  
  let userName = 'Utilisateur';
  if (currentUser && currentUser.name) {
    userName = currentUser.name;
  }
  
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `<div><strong>— ${userName} (${dateStr} à ${timeStr}) —</strong></div><div><br></div>`;
  
  content.innerHTML += signature;
  
  // Placer le curseur à la fin
  const range = document.createRange();
  const sel = window.getSelection();
  range.selectNodeContents(content);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
  content.focus();
  
  saveMobileNotesContent();
}

// Gérer le collage d'images dans les notes moulage mobile
function handleMobileNotesPaste(event) {
  const items = event.clipboardData?.items;
  if (!items) return;
  
  for (let item of items) {
    if (item.type.indexOf('image') !== -1) {
      event.preventDefault();
      const file = item.getAsFile();
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.width = '150px';
        img.style.cursor = 'nwse-resize';
        img.style.display = 'block';
        img.style.margin = '5px 0';
        
        makeMobileNoteImageResizable(img);
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);
          range.setStartAfter(img);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        } else {
          document.getElementById('mobileNotesContent').appendChild(img);
        }
        
        saveMobileNotesContent();
      };
      
      reader.readAsDataURL(file);
      break;
    }
  }
}

// Rendre une image redimensionnable (moulages)
function makeMobileNoteImageResizable(img) {
  let isResizing = false;
  let startX, startWidth;
  
  img.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      const rect = img.getBoundingClientRect();
      const isNearEdge = (rect.right - touch.clientX < 30) && (rect.bottom - touch.clientY < 30);
      
      if (isNearEdge) {
        e.preventDefault();
        isResizing = true;
        startX = touch.clientX;
        startWidth = img.offsetWidth;
        img.style.opacity = '0.7';
      }
    }
  }, { passive: false });
  
  img.addEventListener('touchmove', function(e) {
    if (!isResizing) return;
    e.preventDefault();
    const touch = e.touches[0];
    const newWidth = startWidth + (touch.clientX - startX);
    if (newWidth > 50 && newWidth < 300) {
      img.style.width = newWidth + 'px';
      img.style.height = 'auto';
    }
  }, { passive: false });
  
  img.addEventListener('touchend', function() {
    if (isResizing) {
      isResizing = false;
      img.style.opacity = '1';
      saveMobileNotesContent();
    }
  });
  
  // Mouse events
  img.addEventListener('mousedown', function(e) {
    const rect = img.getBoundingClientRect();
    const isNearEdge = (rect.right - e.clientX < 20) && (rect.bottom - e.clientY < 20);
    
    if (isNearEdge) {
      e.preventDefault();
      isResizing = true;
      startX = e.clientX;
      startWidth = img.offsetWidth;
      
      const onMouseMove = (e) => {
        if (!isResizing) return;
        const newWidth = startWidth + (e.clientX - startX);
        if (newWidth > 50 && newWidth < 300) {
          img.style.width = newWidth + 'px';
          img.style.height = 'auto';
        }
      };
      
      const onMouseUp = () => {
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveMobileNotesContent();
      };
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
  });
}

// Initialiser le redimensionnement des images existantes (moulages)
function initMobileNotesImageResizing() {
  const content = document.getElementById('mobileNotesContent');
  if (content) {
    content.querySelectorAll('img').forEach(img => {
      img.style.cursor = 'nwse-resize';
      img.style.maxWidth = '100%';
      makeMobileNoteImageResizable(img);
    });
  }
}

// Sauvegarder les notes moulage mobile
function saveMobileNotesContent() {
  if (!currentMobileFicheId || !cardsData[currentMobileFicheId]) return;
  const content = document.getElementById('mobileNotesContent');
  if (content) {
    cardsData[currentMobileFicheId].notes = content.innerHTML;
    saveCardToFirebase(currentMobileFicheId);
  }
}

// Ouvrir le lien photo (si existe)
function openMobilePhotoLink(photoType) {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  const photoKey = `photo${photoType.charAt(0).toUpperCase() + photoType.slice(1)}`;
  const photoUrl = card[photoKey];
  
  if (photoUrl) {
    window.open(photoUrl, '_blank');
  } else {
    alert('Aucun lien photo défini. Cliquez sur 📷 pour ajouter un lien.');
  }
}

// Menu pour ajouter les liens photos
function openMobilePhotoMenu() {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  if (!card) {
    alert('Erreur: carte non trouvée');
    return;
  }
  
  // Préparer les valeurs (éviter undefined)
  const photoClient = card.photoClient || '';
  const photoAtelier = card.photoAtelier || '';
  const photoDevis = card.photoDevis || '';
  
  const menuHTML = `
    <div class="mobile-photo-menu-overlay" id="mobilePhotoMenu" onclick="closeMobilePhotoMenu(event)">
      <div class="mobile-photo-menu" onclick="event.stopPropagation()">
        <div class="mobile-photo-menu-header">
          <span>📷 Liens Photos</span>
          <button onclick="closeMobilePhotoMenu()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">✕</button>
        </div>
        <div class="mobile-photo-menu-content">
          <div class="mobile-photo-menu-field">
            <label>👤 Client</label>
            <input type="url" id="photoClientInput" value="${photoClient}" placeholder="URL de la photo client">
          </div>
          <div class="mobile-photo-menu-field">
            <label>🔧 Atelier</label>
            <input type="url" id="photoAtelierInput" value="${photoAtelier}" placeholder="URL de la photo atelier">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📄 Devis/Modifs</label>
            <input type="url" id="photoDevisInput" value="${photoDevis}" placeholder="URL du devis/modifs">
          </div>
        </div>
        <div class="mobile-photo-menu-actions">
          <button class="mobile-photo-save-btn" onclick="saveMobilePhotos()">💾 Sauvegarder</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', menuHTML);
}

function closeMobilePhotoMenu(event) {
  if (event && event.target.id !== 'mobilePhotoMenu') return;
  const menu = document.getElementById('mobilePhotoMenu');
  if (menu) menu.remove();
}

// ===== CALENDRIER POUR DATES MOULAGE MOBILE =====
function openMobileMoulageCalendar(field) {
  if (!currentMobileFicheId) return;
  const card = cardsData[currentMobileFicheId];
  if (!card) return;
  
  const currentDate = card[field] || '';
  
  showCalendar({
    value: currentDate,
    mode: 'modal',
    onSelect: (dateStr) => {
      if (currentMobileFicheId && cardsData[currentMobileFicheId]) {
        cardsData[currentMobileFicheId][field] = dateStr;
        saveCardToFirebase(currentMobileFicheId);
        renderMobilePageInfo(cardsData[currentMobileFicheId]);
        renderAllCards();
      }
    }
  });
}

// ===== SÉLECTEUR D'ITEM MOBILE =====
function openMobileItemSelector() {
  if (!currentMobileFicheId) return;
  const card = cardsData[currentMobileFicheId];
  if (!card) return;
  
  const items = customLists.items || ['Appui-tête', 'Coussin', 'Dossier', 'Siège', 'Siège + Dossier'];
  
  const menuHTML = `
    <div class="mobile-item-selector-overlay" id="mobileItemSelector" onclick="closeMobileItemSelector(event)">
      <div class="mobile-item-selector" onclick="event.stopPropagation()">
        <div class="mobile-item-selector-header">
          <span>📦 Sélectionner un Item</span>
          <button onclick="closeMobileItemSelector()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">✕</button>
        </div>
        <div class="mobile-item-selector-body">
          ${items.map(item => `
            <div class="mobile-item-option ${card.item === item ? 'selected' : ''}" onclick="selectMobileItem('${item}')">${item}</div>
          `).join('')}
          <div class="mobile-item-option" onclick="selectMobileItem('')">-- Aucun --</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', menuHTML);
}

function closeMobileItemSelector(event) {
  if (event && event.target.id !== 'mobileItemSelector') return;
  const menu = document.getElementById('mobileItemSelector');
  if (menu) menu.remove();
}

function selectMobileItem(item) {
  if (!currentMobileFicheId) return;
  cardsData[currentMobileFicheId].item = item;
  saveCardToFirebase(currentMobileFicheId);
  closeMobileItemSelector({ target: { id: 'mobileItemSelector' } });
  renderMobilePageInfo(cardsData[currentMobileFicheId]);
  displayAllMobileCards();
}

// ===== HISTORIQUE DES DÉPARTEMENTS MOBILE =====
function openMobileDeptHistory() {
  if (!currentMobileFicheId) return;
  const card = cardsData[currentMobileFicheId];
  if (!card) return;
  
  const depts = [
    { key: 'robot', name: 'Robot', icon: '🤖' },
    { key: 'degauchage', name: 'Dégauchage', icon: '🔧' },
    { key: 'essayage', name: 'Essayage', icon: '👔' },
    { key: 'atelier', name: 'Atelier', icon: '🏭' },
    { key: 'couture', name: 'Couture', icon: '🧵' },
    { key: 'peinture', name: 'Peinture', icon: '🎨' },
    { key: 'expedition', name: 'Expédition', icon: '📦' }
  ];
  
  const tracking = card.tracking || {};
  const colIndex = card.columnIndex || 0;
  
  let historyHTML = depts.map((dept, idx) => {
    const data = tracking[dept.key] || {};
    const entree = data.entree || '';
    const sortie = data.sortie || '';
    const isCurrent = idx === colIndex;
    const isCompleted = entree && sortie;
    const isActive = entree && !sortie;
    
    let jours = '-';
    if (isCompleted) {
      jours = calcJoursOuvrables(entree, sortie) + 'j';
    } else if (isActive) {
      jours = calcJoursOuvrables(entree, new Date().toISOString().split('T')[0]) + 'j';
    }
    
    let statusClass = '';
    if (isCompleted) statusClass = 'completed';
    else if (isActive) statusClass = 'active';
    
    return `
      <div class="mobile-dept-row ${statusClass} ${isCurrent ? 'current' : ''}">
        <div class="mobile-dept-name">${dept.icon} ${dept.name}</div>
        <div class="mobile-dept-dates">
          <div class="mobile-dept-date-field">
            <label>Entrée</label>
            <input type="date" value="${entree}" onchange="updateMobileDeptDate('${dept.key}', 'entree', this.value)">
          </div>
          <div class="mobile-dept-date-field">
            <label>Sortie</label>
            <input type="date" value="${sortie}" onchange="updateMobileDeptDate('${dept.key}', 'sortie', this.value)">
          </div>
          <div class="mobile-dept-jours">${jours}</div>
        </div>
      </div>
    `;
  }).join('');
  
  const menuHTML = `
    <div class="mobile-dept-history-overlay" id="mobileDeptHistory" onclick="closeMobileDeptHistory(event)">
      <div class="mobile-dept-history" onclick="event.stopPropagation()">
        <div class="mobile-dept-history-header">
          <span>📊 Historique des départements</span>
          <button onclick="closeMobileDeptHistory()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">✕</button>
        </div>
        <div class="mobile-dept-history-body">
          ${historyHTML}
        </div>
        <div class="mobile-dept-history-footer">
          <button onclick="closeMobileDeptHistory()" class="mobile-dept-close-btn">Fermer</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', menuHTML);
}

function closeMobileDeptHistory(event) {
  if (event && event.target.id !== 'mobileDeptHistory') return;
  const menu = document.getElementById('mobileDeptHistory');
  if (menu) menu.remove();
}

function updateMobileDeptDate(deptKey, field, value) {
  if (!currentMobileFicheId) return;
  
  if (!cardsData[currentMobileFicheId].tracking) {
    cardsData[currentMobileFicheId].tracking = {};
  }
  if (!cardsData[currentMobileFicheId].tracking[deptKey]) {
    cardsData[currentMobileFicheId].tracking[deptKey] = {};
  }
  
  cardsData[currentMobileFicheId].tracking[deptKey][field] = value;
  saveCardToFirebase(currentMobileFicheId);
  
  // Rafraîchir l'historique
  closeMobileDeptHistory({ target: { id: 'mobileDeptHistory' } });
  openMobileDeptHistory();
  
  // Rafraîchir la fiche
  renderMobilePageInfo(cardsData[currentMobileFicheId]);
}

function saveMobilePhotos() {
  if (!currentMobileFicheId) return;
  
  const clientInput = document.getElementById('photoClientInput');
  const atelierInput = document.getElementById('photoAtelierInput');
  const devisInput = document.getElementById('photoDevisInput');
  
  if (clientInput) cardsData[currentMobileFicheId].photoClient = clientInput.value.trim();
  if (atelierInput) cardsData[currentMobileFicheId].photoAtelier = atelierInput.value.trim();
  if (devisInput) cardsData[currentMobileFicheId].photoDevis = devisInput.value.trim();
  
  saveCardToFirebase(currentMobileFicheId);
  closeMobilePhotoMenu({ target: { id: 'mobilePhotoMenu' } });
  renderMobilePageInfo(cardsData[currentMobileFicheId]);
}

// Ouvrir le lien photo 1-6
function openMobilePhotoLink1to6(photoKey) {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  const photoUrl = card[photoKey];
  
  if (photoUrl) {
    window.open(photoUrl, '_blank');
  } else {
    alert('Aucun lien défini. Cliquez sur 📷 pour ajouter des liens.');
  }
}

// Menu pour ajouter les liens photos 1-6 (utilise notePhoto pour synchro avec PC)
function openMobilePhotos1to6Menu() {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  if (!card) {
    alert('Erreur: carte non trouvée');
    return;
  }
  
  // Préparer les valeurs (éviter undefined)
  const photo1 = card.notePhoto1 || '';
  const photo2 = card.notePhoto2 || '';
  const photo3 = card.notePhoto3 || '';
  const photo4 = card.notePhoto4 || '';
  const photo5 = card.notePhoto5 || '';
  const photo6 = card.notePhoto6 || '';
  
  const menuHTML = `
    <div class="mobile-photo-menu-overlay" id="mobilePhotos1to6Menu" onclick="closeMobilePhotos1to6Menu(event)">
      <div class="mobile-photo-menu" onclick="event.stopPropagation()">
        <div class="mobile-photo-menu-header">
          <span>📷 Liens Photos 1-6</span>
          <button onclick="closeMobilePhotos1to6Menu()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">✕</button>
        </div>
        <div class="mobile-photo-menu-content">
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 1</label>
            <input type="url" id="notePhoto1Input" value="${photo1}" placeholder="URL photo 1">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 2</label>
            <input type="url" id="notePhoto2Input" value="${photo2}" placeholder="URL photo 2">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 3</label>
            <input type="url" id="notePhoto3Input" value="${photo3}" placeholder="URL photo 3">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 4</label>
            <input type="url" id="notePhoto4Input" value="${photo4}" placeholder="URL photo 4">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 5</label>
            <input type="url" id="notePhoto5Input" value="${photo5}" placeholder="URL photo 5">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 6</label>
            <input type="url" id="notePhoto6Input" value="${photo6}" placeholder="URL photo 6">
          </div>
        </div>
        <div class="mobile-photo-menu-actions">
          <button class="mobile-photo-save-btn" onclick="saveMobilePhotos1to6()">💾 Sauvegarder</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', menuHTML);
}

function closeMobilePhotos1to6Menu(event) {
  if (event && event.target.id !== 'mobilePhotos1to6Menu') return;
  const menu = document.getElementById('mobilePhotos1to6Menu');
  if (menu) menu.remove();
}

function saveMobilePhotos1to6() {
  if (!currentMobileFicheId) return;
  
  // Utilise notePhoto pour synchro avec PC
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById(`notePhoto${i}Input`);
    if (input) {
      cardsData[currentMobileFicheId][`notePhoto${i}`] = input.value.trim();
    }
  }
  
  saveCardToFirebase(currentMobileFicheId);
  closeMobilePhotos1to6Menu({ target: { id: 'mobilePhotos1to6Menu' } });
  renderMobilePageNotes(cardsData[currentMobileFicheId]);
}

// ===== GESTION DU SWIPE =====

let swipeStartX = 0;
let swipeCurrentX = 0;
let swipeIsDragging = false;

function initMobileSwipeEvents() {
  setTimeout(() => {
    const container = document.getElementById('mobileFicheSwipeContainer');
    if (!container) return;
    
    // Touch events
    container.addEventListener('touchstart', handleMobileSwipeStart, { passive: true });
    container.addEventListener('touchmove', handleMobileSwipeMove, { passive: false });
    container.addEventListener('touchend', handleMobileSwipeEnd);
    
    // Mouse events (pour tester sur desktop)
    container.addEventListener('mousedown', handleMobileSwipeStart);
    container.addEventListener('mousemove', handleMobileSwipeMove);
    container.addEventListener('mouseup', handleMobileSwipeEnd);
    container.addEventListener('mouseleave', handleMobileSwipeEnd);
  }, 500);
}

function handleMobileSwipeStart(e) {
  swipeIsDragging = true;
  swipeStartX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  swipeCurrentX = swipeStartX;
  
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.classList.add('dragging');
  }
}

function handleMobileSwipeMove(e) {
  if (!swipeIsDragging) return;
  
  swipeCurrentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  const diff = swipeCurrentX - swipeStartX;
  
  let newOffset = (mobileSwipeCurrentPage * -50) + (diff / window.innerWidth * 50);
  newOffset = Math.max(-50, Math.min(0, newOffset));
  
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.style.transform = `translateX(${newOffset}%)`;
  }
  
  if (e.type === 'touchmove' && Math.abs(diff) > 10) {
    e.preventDefault();
  }
}

function handleMobileSwipeEnd(e) {
  if (!swipeIsDragging) return;
  swipeIsDragging = false;
  
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.classList.remove('dragging');
  }
  
  const diff = swipeCurrentX - swipeStartX;
  const threshold = window.innerWidth * 0.2;
  
  let newPage = mobileSwipeCurrentPage;
  
  if (diff > threshold && mobileSwipeCurrentPage > 0) {
    newPage = mobileSwipeCurrentPage - 1;
  } else if (diff < -threshold && mobileSwipeCurrentPage < 1) {
    newPage = mobileSwipeCurrentPage + 1;
  }
  
  goToMobilePage(newPage);
}

function goToMobilePage(pageIndex) {
  if (pageIndex < 0) pageIndex = 0;
  if (pageIndex > 1) pageIndex = 1;
  
  mobileSwipeCurrentPage = pageIndex;
  updateMobileSwipePosition2Pages(pageIndex, true);
}

// Position pour 2 pages (50% chaque)
function updateMobileSwipePosition2Pages(pageIndex, animate) {
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.style.transition = animate ? 'transform 0.3s ease-out' : 'none';
    wrapper.style.transform = `translateX(${pageIndex * -50}%)`;
  }
}

// Exposer les fonctions mobile globalement
window.isMobileDevice = isMobileDevice;
window.initMobileAfterLogin = initMobileAfterLogin;
window.switchToDesktopMode = switchToDesktopMode;
window.clearMobileSearch = clearMobileSearch;
window.openMobileFiche = openMobileFiche;
window.closeMobileFiche = closeMobileFiche;
window.openMobilePhotoLink = openMobilePhotoLink;
window.openMobilePhotoMenu = openMobilePhotoMenu;
window.closeMobilePhotoMenu = closeMobilePhotoMenu;
window.saveMobilePhotos = saveMobilePhotos;
window.openMobilePhotoLink1to6 = openMobilePhotoLink1to6;
window.openMobilePhotos1to6Menu = openMobilePhotos1to6Menu;
window.closeMobilePhotos1to6Menu = closeMobilePhotos1to6Menu;
window.saveMobilePhotos1to6 = saveMobilePhotos1to6;
window.openMobileMoulageCalendar = openMobileMoulageCalendar;
window.openMobileItemSelector = openMobileItemSelector;
window.closeMobileItemSelector = closeMobileItemSelector;
window.selectMobileItem = selectMobileItem;
window.openMobileDeptHistory = openMobileDeptHistory;
window.closeMobileDeptHistory = closeMobileDeptHistory;
window.updateMobileDeptDate = updateMobileDeptDate;
window.insertMobileNoteTimestamp = insertMobileNoteTimestamp;
window.handleMobileNotesPaste = handleMobileNotesPaste;
window.saveMobileNotesContent = saveMobileNotesContent;

// ===== MOBILE MENU & JOBS =====
var currentMobileJobId = null;
var mobileJobSwipePage = 0;

// Créer le HTML du menu mobile
function createMobileMenuHTML() {
  const menuHTML = `
    <!-- MENU MOBILE - CHOIX MOULAGES / JOBS -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay">
      <div class="mobile-menu-title">Outil de gestion simplifiée</div>
      <div class="mobile-menu-author">par Daniel Charest</div>
      <div class="mobile-menu-buttons">
        <button class="mobile-menu-btn btn-moulages" onclick="openMobileMoulages()">
          <span class="mobile-menu-btn-icon">📋</span>
          <span class="mobile-menu-btn-text">Moulages</span>
          <span class="mobile-menu-btn-count" id="menuMoulagesCount"></span>
        </button>
        <button class="mobile-menu-btn btn-jobs" onclick="openMobileJobs()">
          <span class="mobile-menu-btn-icon">⏳</span>
          <span class="mobile-menu-btn-text">Job en attente</span>
          <span class="mobile-menu-btn-count" id="menuJobsCount"></span>
        </button>
      </div>
      <div class="mobile-desktop-btn" onclick="switchToDesktopMode()">
        💻 Version complète
      </div>
    </div>
    
    <!-- LISTE JOBS MOBILE -->
    <div class="mobile-jobs-overlay" id="mobileJobsOverlay">
      <div class="mobile-jobs-header">
        <button class="mobile-jobs-back" onclick="closeMobileJobs()">←</button>
        <div class="mobile-jobs-title">Job en attente de réponse</div>
        <button class="mobile-jobs-add" onclick="showMobileAddJob()">+</button>
      </div>
      <div class="mobile-jobs-list" id="mobileJobsList"></div>
    </div>
    
    <!-- FICHE JOB MOBILE -->
    <div class="mobile-job-fiche-overlay" id="mobileJobFicheOverlay">
      <div class="mobile-job-fiche-header" id="mobileJobFicheHeader">
        <button class="mobile-job-fiche-back" onclick="closeMobileJobFiche()">← Retour</button>
        <div class="mobile-job-fiche-title" id="mobileJobFicheTitle">Job #000000</div>
      </div>
      <div class="mobile-job-swipe-indicator" id="mobileJobSwipeIndicator">
        ← Glissez pour voir les notes →
      </div>
      <div class="mobile-job-fiche-swipe" id="mobileJobFicheSwipe">
        <div class="mobile-job-fiche-wrapper" id="mobileJobFicheWrapper">
          <div class="mobile-job-fiche-page page-info" id="mobileJobPageInfo"></div>
          <div class="mobile-job-fiche-page page-notes" id="mobileJobPageNotes"></div>
        </div>
      </div>
      <div class="mobile-job-fiche-footer">
        <button class="mobile-job-fiche-btn btn-done" onclick="resolveMobileJob()">✓ Résolu</button>
        <button class="mobile-job-fiche-btn btn-email" onclick="emailMobileJob()">✉️ Email</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', menuHTML);
  initMobileJobSwipe();
}

// Ouvrir le menu mobile (au lieu de l'écran moulages directement)
function showMobileMenu() {
  // S'assurer que le menu existe
  if (!document.getElementById('mobileMenuOverlay')) {
    createMobileMenuHTML();
  }
  
  // Mettre à jour les compteurs
  updateMobileMenuCounts();
  
  // Afficher le menu
  document.getElementById('mobileMenuOverlay').classList.add('active');
  document.getElementById('mobileHomeOverlay')?.classList.remove('active');
  document.getElementById('mobileJobsOverlay')?.classList.remove('active');
}

// Mettre à jour les compteurs du menu mobile
function updateMobileMenuCounts() {
  const moulagesCount = Object.keys(cardsData || {}).length;
  const jobsCount = Object.keys(jobsData || {}).filter(k => jobsData[k] && jobsData[k].type === 'question').length;
  
  const moulagesCountEl = document.getElementById('menuMoulagesCount');
  const jobsCountEl = document.getElementById('menuJobsCount');
  if (moulagesCountEl) moulagesCountEl.textContent = `(${moulagesCount})`;
  if (jobsCountEl) jobsCountEl.textContent = `(${jobsCount})`;
}

// Ouvrir les Moulages depuis le menu
function openMobileMoulages() {
  document.getElementById('mobileMenuOverlay')?.classList.remove('active');
  document.getElementById('mobileHomeOverlay')?.classList.add('active');
}

// Fermer les Moulages et retourner au menu
function closeMobileMoulages() {
  document.getElementById('mobileHomeOverlay')?.classList.remove('active');
  document.getElementById('mobileMenuOverlay')?.classList.add('active');
}

// Ouvrir les Jobs depuis le menu
function openMobileJobs() {
  document.getElementById('mobileMenuOverlay')?.classList.remove('active');
  document.getElementById('mobileJobsOverlay')?.classList.add('active');
  renderMobileJobsList();
}

// Fermer les Jobs et retourner au menu
function closeMobileJobs() {
  document.getElementById('mobileJobsOverlay')?.classList.remove('active');
  document.getElementById('mobileMenuOverlay')?.classList.add('active');
}

// Rendre la liste des jobs mobile (seulement type question)
function renderMobileJobsList() {
  const list = document.getElementById('mobileJobsList');
  if (!list) return;
  
  const questionJobs = Object.entries(jobsData || {})
    .filter(([id, job]) => job && job.type === 'question')
    // Trier par temps d'attente décroissant (plus ancien = plus de jours en haut)
    .sort((a, b) => {
      const daysA = calcJobDays(a[1].dateAmene);
      const daysB = calcJobDays(b[1].dateAmene);
      return daysB - daysA; // Plus de jours = en haut
    });
  
  if (questionJobs.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.6);padding:40px;">Aucun job en attente</div>';
    return;
  }
  
  list.innerHTML = questionJobs.map(([id, job]) => {
    const regionClass = job.region === 'Canada anglais' ? 'region-on' : job.region === 'France' ? 'region-fr' : '';
    const days = calcJobDays(job.dateAmene);
    const daysClass = getDaysClass(days);
    
    return `
      <div class="mobile-job-card ${regionClass}" onclick="openMobileJobFiche('${id}')">
        <div class="mobile-job-card-row1">
          <span class="mobile-job-card-order">#${job.order || '------'}</span>
          <span class="mobile-job-card-rep">${job.representant || '-'}</span>
        </div>
        <div class="mobile-job-card-row2">
          <span class="mobile-job-card-client">${job.client || '-'}</span>
        </div>
        <div class="mobile-job-card-days ${daysClass}">${days}j en attente</div>
      </div>
    `;
  }).join('');
}

// Ouvrir la fiche job mobile
function openMobileJobFiche(jobId) {
  currentMobileJobId = jobId;
  mobileJobNoteTimestampAdded = false; // Réinitialiser pour permettre nouvelle signature
  const job = jobsData[jobId];
  if (!job) return;
  
  // Header
  const header = document.getElementById('mobileJobFicheHeader');
  header.className = 'mobile-job-fiche-header';
  if (job.region === 'Canada anglais') header.classList.add('region-on');
  else if (job.region === 'France') header.classList.add('region-fr');
  
  document.getElementById('mobileJobFicheTitle').textContent = `Job #${job.order || '------'}`;
  
  // Page Info
  renderMobileJobPageInfo(job);
  
  // Page Notes
  renderMobileJobPageNotes(job);
  
  // Reset swipe
  mobileJobSwipePage = 0;
  setMobileJobSwipePage(0, false);
  updateMobileJobSwipeIndicator();
  
  // Afficher
  document.getElementById('mobileJobFicheOverlay')?.classList.add('active');
}

// Fermer la fiche job mobile
function closeMobileJobFiche() {
  document.getElementById('mobileJobFicheOverlay')?.classList.remove('active');
  currentMobileJobId = null;
}

// Rendre la page Info du job mobile
function renderMobileJobPageInfo(job) {
  const page = document.getElementById('mobileJobPageInfo');
  if (!page) return;
  
  page.innerHTML = `
    <div class="mobile-job-field">
      <label>Client</label>
      <select id="mobileJobClient" onchange="updateMobileJobField('client', this.value)">
        <option value="">-- Sélectionner --</option>
        ${(customLists.moulageClients || []).map(c => `<option value="${c}" ${job.client === c ? 'selected' : ''}>${c}</option>`).join('')}
      </select>
    </div>
    
    <div class="mobile-job-field-row">
      <div class="mobile-job-field">
        <label>N° Commande</label>
        <input type="text" value="${job.order || ''}" onchange="updateMobileJobField('order', this.value)">
      </div>
      <div class="mobile-job-field">
        <label>Région</label>
        <select onchange="updateMobileJobField('region', this.value)">
          <option value="Quebec" ${job.region === 'Quebec' ? 'selected' : ''}>Québec</option>
          <option value="Canada anglais" ${job.region === 'Canada anglais' ? 'selected' : ''}>Canada anglais</option>
          <option value="France" ${job.region === 'France' ? 'selected' : ''}>France</option>
        </select>
      </div>
    </div>
    
    <div class="mobile-job-field-row">
      <div class="mobile-job-field">
        <label>PO</label>
        <input type="text" value="${job.numeroPO || ''}" onchange="updateMobileJobField('numeroPO', this.value)">
      </div>
      <div class="mobile-job-field">
        <label>Soumission</label>
        <input type="text" value="${job.numeroSoumission || ''}" onchange="updateMobileJobField('numeroSoumission', this.value)">
      </div>
    </div>
    
    <div class="mobile-job-field-row">
      <div class="mobile-job-field">
        <label>Représentante</label>
        <select onchange="updateMobileJobField('representant', this.value)">
          <option value="">--</option>
          ${(customLists.representantes || []).map(r => `<option value="${r}" ${job.representant === r ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
      </div>
      <div class="mobile-job-field">
        <label>Intervenant</label>
        <select onchange="updateMobileJobField('intervenant', this.value)">
          <option value="">--</option>
          ${(customLists.intervenants || []).map(i => `<option value="${i}" ${job.intervenant === i ? 'selected' : ''}>${i}</option>`).join('')}
        </select>
      </div>
    </div>
    
    <div class="mobile-job-field-row">
      <div class="mobile-job-field">
        <label>Réception</label>
        <div class="mobile-job-date-pill" onclick="openMobileJobCalendar('dateRecue')">${formatJobDate(job.dateRecue)}</div>
      </div>
      <div class="mobile-job-field">
        <label>En attente</label>
        <div class="mobile-job-date-pill" onclick="openMobileJobCalendar('dateAmene')">${formatJobDate(job.dateAmene)}</div>
      </div>
      <div class="mobile-job-field">
        <label>Livraison</label>
        <div class="mobile-job-date-pill" onclick="openMobileJobCalendar('dateLivraison')">${formatJobDate(job.dateLivraison)}</div>
      </div>
    </div>
  `;
}

// Rendre la page Notes du job mobile (avec support images comme desktop)
function renderMobileJobPageNotes(job) {
  const page = document.getElementById('mobileJobPageNotes');
  if (!page) return;
  
  page.innerHTML = `
    <div class="mobile-job-notes-area">
      <div class="mobile-job-notes-header">📝 Notes (collez des images!)</div>
      <div class="mobile-job-notes-content" 
           id="mobileJobNotesContent" 
           contenteditable="true"
           onclick="insertMobileJobNoteTimestamp(event)"
           onpaste="handleMobileJobNotesPaste(event)"
           onblur="saveMobileJobNotesContent()">${job.notes || ''}</div>
    </div>
  `;
  
  // Initialiser le redimensionnement des images existantes
  setTimeout(() => initMobileJobNotesImageResizing(), 100);
}

// Insérer timestamp au clic dans les notes job mobile
var mobileJobNoteTimestampAdded = false;

function insertMobileJobNoteTimestamp(event) {
  if (mobileJobNoteTimestampAdded) return;
  mobileJobNoteTimestampAdded = true;
  
  const content = document.getElementById('mobileJobNotesContent');
  if (!content) return;
  
  let userName = 'Utilisateur';
  if (currentUser && currentUser.name) {
    userName = currentUser.name;
  }
  
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `<div><strong>— ${userName} (${dateStr} à ${timeStr}) —</strong></div><div><br></div>`;
  
  // Ajouter à la fin
  content.innerHTML += signature;
  
  // Placer le curseur à la fin
  const range = document.createRange();
  const sel = window.getSelection();
  range.selectNodeContents(content);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
  content.focus();
  
  // Sauvegarder
  saveMobileJobNotesContent();
}

// Gérer le collage d'images dans les notes job mobile
function handleMobileJobNotesPaste(event) {
  const items = event.clipboardData?.items;
  if (!items) return;
  
  for (let item of items) {
    if (item.type.indexOf('image') !== -1) {
      event.preventDefault();
      const file = item.getAsFile();
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '100%';
        img.style.width = '150px';
        img.style.cursor = 'nwse-resize';
        img.style.display = 'block';
        img.style.margin = '5px 0';
        
        // Activer le redimensionnement
        makeMobileJobImageResizable(img);
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(img);
          range.setStartAfter(img);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        } else {
          document.getElementById('mobileJobNotesContent').appendChild(img);
        }
        
        saveMobileJobNotesContent();
      };
      
      reader.readAsDataURL(file);
      break;
    }
  }
}

// Rendre une image redimensionnable (touch + mouse)
function makeMobileJobImageResizable(img) {
  let isResizing = false;
  let startX, startWidth;
  
  // Touch events
  img.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      const touch = e.touches[0];
      const rect = img.getBoundingClientRect();
      const isNearEdge = (rect.right - touch.clientX < 30) && (rect.bottom - touch.clientY < 30);
      
      if (isNearEdge) {
        e.preventDefault();
        isResizing = true;
        startX = touch.clientX;
        startWidth = img.offsetWidth;
        img.style.opacity = '0.7';
      }
    }
  }, { passive: false });
  
  img.addEventListener('touchmove', function(e) {
    if (!isResizing) return;
    e.preventDefault();
    const touch = e.touches[0];
    const newWidth = startWidth + (touch.clientX - startX);
    if (newWidth > 50 && newWidth < 300) {
      img.style.width = newWidth + 'px';
      img.style.height = 'auto';
    }
  }, { passive: false });
  
  img.addEventListener('touchend', function() {
    if (isResizing) {
      isResizing = false;
      img.style.opacity = '1';
      saveMobileJobNotesContent();
    }
  });
  
  // Mouse events (pour desktop)
  img.addEventListener('mousedown', function(e) {
    const rect = img.getBoundingClientRect();
    const isNearEdge = (rect.right - e.clientX < 20) && (rect.bottom - e.clientY < 20);
    
    if (isNearEdge) {
      e.preventDefault();
      isResizing = true;
      startX = e.clientX;
      startWidth = img.offsetWidth;
      
      const onMouseMove = (e) => {
        if (!isResizing) return;
        const newWidth = startWidth + (e.clientX - startX);
        if (newWidth > 50 && newWidth < 300) {
          img.style.width = newWidth + 'px';
          img.style.height = 'auto';
        }
      };
      
      const onMouseUp = () => {
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveMobileJobNotesContent();
      };
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
  });
}

// Initialiser le redimensionnement des images existantes
function initMobileJobNotesImageResizing() {
  const content = document.getElementById('mobileJobNotesContent');
  if (content) {
    content.querySelectorAll('img').forEach(img => {
      img.style.cursor = 'nwse-resize';
      img.style.maxWidth = '100%';
      makeMobileJobImageResizable(img);
    });
  }
}

// Sauvegarder les notes job mobile
function saveMobileJobNotesContent() {
  if (!currentMobileJobId || !jobsData[currentMobileJobId]) return;
  const content = document.getElementById('mobileJobNotesContent');
  if (content) {
    jobsData[currentMobileJobId].notes = content.innerHTML;
    saveJobToFirebase(currentMobileJobId);
  }
}

// Mettre à jour un champ du job mobile
function updateMobileJobField(field, value) {
  if (!currentMobileJobId || !jobsData[currentMobileJobId]) return;
  jobsData[currentMobileJobId][field] = value;
  saveJobToFirebase(currentMobileJobId);
  renderMobileJobsList();
}

// Ouvrir le calendrier pour une date de job mobile
function openMobileJobCalendar(field) {
  const job = jobsData[currentMobileJobId];
  if (!job) return;
  
  const currentDate = job[field] || '';
  
  showCalendar({
    value: currentDate,
    mode: 'modal',
    onSelect: (dateStr) => {
      if (currentMobileJobId && jobsData[currentMobileJobId]) {
        jobsData[currentMobileJobId][field] = dateStr;
        saveJobToFirebase(currentMobileJobId);
        renderMobileJobPageInfo(jobsData[currentMobileJobId]);
        renderMobileJobsList();
      }
    }
  });
}

// Résoudre le job mobile
function resolveMobileJob() {
  if (!currentMobileJobId) return;
  if (confirm('Marquer ce job comme résolu?')) {
    deleteJobFromFirebase(currentMobileJobId);
    closeMobileJobFiche();
    renderMobileJobsList();
  }
}

// Email du job mobile
function emailMobileJob() {
  if (!currentMobileJobId) return;
  currentJobId = currentMobileJobId;
  sendJobEmail();
}

// Variables globales pour le swipe jobs
var jobSwipeIsDragging = false;
var jobSwipeStartX = 0;
var jobSwipeCurrentX = 0;

// Initialiser le swipe pour les jobs mobiles (identique aux moulages)
function initMobileJobSwipe() {
  setTimeout(() => {
    const container = document.getElementById('mobileJobFicheSwipe');
    if (!container) return;
    
    // Touch events
    container.addEventListener('touchstart', handleJobSwipeStart, { passive: true });
    container.addEventListener('touchmove', handleJobSwipeMove, { passive: false });
    container.addEventListener('touchend', handleJobSwipeEnd);
    
    // Mouse events (pour tester sur desktop)
    container.addEventListener('mousedown', handleJobSwipeStart);
    container.addEventListener('mousemove', handleJobSwipeMove);
    container.addEventListener('mouseup', handleJobSwipeEnd);
    container.addEventListener('mouseleave', handleJobSwipeEnd);
  }, 500);
}

function handleJobSwipeStart(e) {
  jobSwipeIsDragging = true;
  jobSwipeStartX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  jobSwipeCurrentX = jobSwipeStartX;
  
  const wrapper = document.getElementById('mobileJobFicheWrapper');
  if (wrapper) {
    wrapper.style.transition = 'none';
  }
}

function handleJobSwipeMove(e) {
  if (!jobSwipeIsDragging) return;
  
  jobSwipeCurrentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  const diff = jobSwipeCurrentX - jobSwipeStartX;
  
  // Calculer la nouvelle position en suivant le doigt
  let newOffset = (mobileJobSwipePage * -50) + (diff / window.innerWidth * 50);
  newOffset = Math.max(-50, Math.min(0, newOffset));
  
  const wrapper = document.getElementById('mobileJobFicheWrapper');
  if (wrapper) {
    wrapper.style.transform = `translateX(${newOffset}%)`;
  }
  
  if (e.type === 'touchmove' && Math.abs(diff) > 10) {
    e.preventDefault();
  }
}

function handleJobSwipeEnd(e) {
  if (!jobSwipeIsDragging) return;
  jobSwipeIsDragging = false;
  
  const diff = jobSwipeCurrentX - jobSwipeStartX;
  const threshold = window.innerWidth * 0.2;
  
  let newPage = mobileJobSwipePage;
  
  if (diff > threshold && mobileJobSwipePage > 0) {
    newPage = mobileJobSwipePage - 1;
  } else if (diff < -threshold && mobileJobSwipePage < 1) {
    newPage = mobileJobSwipePage + 1;
  }
  
  mobileJobSwipePage = newPage;
  setMobileJobSwipePage(newPage, true);
  updateMobileJobSwipeIndicator();
}

// Définir la page du swipe job
function setMobileJobSwipePage(pageIndex, animate) {
  const wrapper = document.getElementById('mobileJobFicheWrapper');
  if (wrapper) {
    wrapper.style.transition = animate ? 'transform 0.3s ease-out' : 'none';
    wrapper.style.transform = `translateX(${pageIndex * -50}%)`;
  }
}

// Mettre à jour l'indicateur de swipe
function updateMobileJobSwipeIndicator() {
  const indicator = document.getElementById('mobileJobSwipeIndicator');
  if (indicator) {
    indicator.textContent = mobileJobSwipePage === 0 
      ? '← Glissez pour voir les notes →' 
      : '← Glissez pour voir les infos →';
  }
}

// Afficher le modal d'ajout de job mobile
function showMobileAddJob() {
  showAddJobModal('question');
}

// Exposer les nouvelles fonctions
window.showMobileMenu = showMobileMenu;
window.openMobileMoulages = openMobileMoulages;
window.closeMobileMoulages = closeMobileMoulages;
window.openMobileJobs = openMobileJobs;
window.closeMobileJobs = closeMobileJobs;
window.openMobileJobFiche = openMobileJobFiche;
window.closeMobileJobFiche = closeMobileJobFiche;
window.updateMobileJobField = updateMobileJobField;
window.openMobileJobCalendar = openMobileJobCalendar;
window.insertMobileJobNoteTimestamp = insertMobileJobNoteTimestamp;
window.handleMobileJobNotesPaste = handleMobileJobNotesPaste;
window.saveMobileJobNotesContent = saveMobileJobNotesContent;
window.resolveMobileJob = resolveMobileJob;
window.emailMobileJob = emailMobileJob;
window.showMobileAddJob = showMobileAddJob;

// ===== IMPORT/EXPORT & LOG FUNCTIONS =====
let logEntries = [];

function openImportExportMenu() {
  document.getElementById('importExportOverlay')?.classList.remove('hidden');
  document.getElementById('settingsOverlay')?.classList.add('hidden');
}

function closeImportExportMenu() {
  document.getElementById('importExportOverlay')?.classList.add('hidden');
}

function openLogMenu() {
  renderLogEntries();
  document.getElementById('logOverlay')?.classList.remove('hidden');
  document.getElementById('settingsOverlay')?.classList.add('hidden');
}

function closeLogMenu() {
  document.getElementById('logOverlay')?.classList.add('hidden');
}

// Fermer avec clic sur overlay
document.getElementById('importExportOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'importExportOverlay') closeImportExportMenu();
});
document.getElementById('logOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'logOverlay') closeLogMenu();
});

// Exporter TOUTES les données
function exportAllData() {
  const exportData = {
    version: 'PhysiPro_v2.18',
    exportDate: new Date().toISOString(),
    exportedBy: currentUser?.email || 'Anonyme',
    moulages: cardsData,
    logs: logEntries
  };
  
  downloadJSON(exportData, `physipro_backup_${formatDateForFilename()}.json`);
  addLogEntry('Export', 'Export complet effectué');
  alert('✅ Export complet effectué!\n\nFichier téléchargé avec toutes les données.');
}

// Exporter seulement les moulages
function exportMoulagesOnly() {
  const exportData = {
    version: 'PhysiPro_v2.18',
    exportDate: new Date().toISOString(),
    exportType: 'moulages_only',
    moulages: cardsData
  };
  
  downloadJSON(exportData, `physipro_moulages_${formatDateForFilename()}.json`);
  addLogEntry('Export', 'Export moulages effectué');
  alert('✅ Export des moulages effectué!');
}

// Télécharger JSON
function downloadJSON(data, filename) {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function formatDateForFilename() {
  const now = new Date();
  return now.toISOString().slice(0,10).replace(/-/g, '') + '_' + 
         now.toTimeString().slice(0,5).replace(':', '');
}

// Importer fichier
function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      if (!importedData.version || !importedData.version.startsWith('PhysiPro')) {
        alert('❌ Fichier invalide!\n\nCe fichier ne semble pas être un export PhysiPro valide.');
        return;
      }
      
      const confirmMsg = `⚠️ ATTENTION!\n\nVous êtes sur le point d'importer des données du ${new Date(importedData.exportDate).toLocaleString('fr-CA')}.\n\nCette action ajoutera les données importées.\n\nÊtes-vous sûr de vouloir continuer?`;
      
      if (!confirm(confirmMsg)) return;
      
      let importCount = 0;
      
      if (importedData.moulages) {
        Object.keys(importedData.moulages).forEach(cardId => {
          cardsData[cardId] = importedData.moulages[cardId];
          saveCardToFirebase(cardId);
          importCount++;
        });
      }
      
      loadCardsFromFirebase();
      addLogEntry('Import', `${importCount} moulages importés`);
      alert(`✅ Importation réussie!\n\n• ${importCount} moulages importés\n\nL'affichage a été rafraîchi.`);
      closeImportExportMenu();
      
    } catch (error) {
      console.error('Erreur d\'importation:', error);
      alert('❌ Erreur lors de l\'importation!\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}

// Log entries
function addLogEntry(action, details) {
  let userName = 'Anonyme';
  if (currentUser?.name) {
    userName = currentUser.name;
  } else if (currentUser?.email) {
    userName = currentUser.email.split('@')[0];
  }
  
  const entry = {
    time: new Date().toLocaleString('fr-CA'),
    user: userName,
    action,
    details
  };
  logEntries.unshift(entry);
  if (logEntries.length > 100) logEntries.pop();
}

function renderLogEntries() {
  const container = document.getElementById('logContent');
  if (!container) return;
  
  if (logEntries.length === 0) {
    container.innerHTML = '<div class="log-empty">Aucune activité enregistrée</div>';
    return;
  }
  
  container.innerHTML = logEntries.map(e => `
    <div class="log-entry">
      <div class="log-time">${e.time} - ${e.user}</div>
      <div><span class="log-action">${e.action}</span>: ${e.details}</div>
    </div>
  `).join('');
}

// Connecter les boutons settings
document.getElementById('btnImportExport')?.addEventListener('click', openImportExportMenu);
document.getElementById('btnArchives')?.addEventListener('click', openLogMenu);

// Exposer fonctions globalement
window.openImportExportMenu = openImportExportMenu;
window.closeImportExportMenu = closeImportExportMenu;
window.openLogMenu = openLogMenu;
window.closeLogMenu = closeLogMenu;
window.exportAllData = exportAllData;
window.exportMoulagesOnly = exportMoulagesOnly;
window.handleImportFile = handleImportFile;

// ===== INVENTAIRE =====
let inventaireData = {};
let currentInvId = null;

// Initialiser l'inventaire
function initInventaire() {
  loadInventaireFromFirebase();
  renderInventaireCubes();
}

// Charger depuis Firebase
function loadInventaireFromFirebase() {
  if (!firebaseDb) {
    renderInventaireCubes();
    return;
  }
  firebaseDb.ref('inventaire').on('value', (snapshot) => {
    inventaireData = snapshot.val() || {};
    renderInventaireCubes();
  });
}

// Calculer combien de cubes rentrent dans une rangée
function getMaxCubesPerRow() {
  return 5; // Maintenant fixe: positions 1-5
}

// Variable pour le drag and drop
let draggedInvId = null;

// Afficher les cubes dans les rangées horizontales
function renderInventaireCubes() {
  const rowMain = document.getElementById('invRowMain');
  const statusPablo = document.getElementById('invStatusPablo');
  const statusCheckna = document.getElementById('invStatusCheckna');
  
  if (!rowMain) return;
  
  rowMain.innerHTML = '';
  
  // Vider tous les slots Pablo
  for (let i = 0; i <= 5; i++) {
    const slot = document.getElementById('invSlotPablo' + i);
    if (slot) slot.innerHTML = '';
  }
  
  // Vider tous les slots Checkna
  for (let i = 0; i <= 5; i++) {
    const slot = document.getElementById('invSlotCheckna' + i);
    if (slot) slot.innerHTML = '';
  }
  
  // Reset statuts
  if (statusPablo) statusPablo.textContent = '';
  if (statusCheckna) statusCheckna.textContent = '';
  
  // Trier par position puis par nom
  const items = Object.entries(inventaireData).sort((a, b) => {
    const posA = a[1].position || 0;
    const posB = b[1].position || 0;
    if (posA !== posB) return posA - posB;
    return (a[1].nom || '').localeCompare(b[1].nom || '');
  });
  
  // Répartir les items dans les slots
  items.forEach(([id, item]) => {
    const cube = createInvCube(id, item);
    
    const rang = item.rang || 'main';
    const position = item.position || 0;
    
    if (rang === 'pablo') {
      const slot = document.getElementById('invSlotPablo' + position);
      if (slot) {
        slot.appendChild(cube);
        if (position === 0 && statusPablo) {
          statusPablo.textContent = '🔧 En production';
        }
      }
    } else if (rang === 'checkna') {
      const slot = document.getElementById('invSlotCheckna' + position);
      if (slot) {
        slot.appendChild(cube);
        if (position === 0 && statusCheckna) {
          statusCheckna.textContent = '🔧 En production';
        }
      }
    } else {
      // À faire (main)
      rowMain.appendChild(cube);
    }
  });
  
  // Ajouter bouton + dans la zone À faire
  const addBtnMain = document.createElement('div');
  addBtnMain.className = 'inv-add-cube';
  addBtnMain.innerHTML = '+';
  addBtnMain.onclick = () => openInvFiche(null, 'main');
  rowMain.appendChild(addBtnMain);
  
  // Setup drag and drop zones
  setupInvDragDropZones();
}

// Créer un cube avec drag and drop
function createInvCube(id, item) {
  const cube = document.createElement('div');
  cube.className = 'inv-cube';
  cube.draggable = true;
  cube.dataset.id = id;
  
  const qtyHtml = item.quantite ? `<div class="inv-cube-qty">${item.quantite}</div>` : '';
  
  cube.innerHTML = `
    ${qtyHtml}
    <div class="inv-cube-name">${item.nom || 'Sans nom'}</div>
    <div class="inv-cube-number">${item.code || '---'}</div>
  `;
  
  // Click pour ouvrir fiche
  cube.onclick = (e) => {
    if (!cube.classList.contains('dragging')) {
      openInvFiche(id);
    }
  };
  
  // Drag events
  cube.addEventListener('dragstart', (e) => {
    draggedInvId = id;
    cube.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  
  cube.addEventListener('dragend', () => {
    cube.classList.remove('dragging');
    draggedInvId = null;
    // Retirer tous les highlights
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  });
  
  return cube;
}

// Setup des zones de drop (appelé une fois au chargement)
let invDragDropInitialized = false;

function setupInvDragDropZones() {
  if (invDragDropInitialized) return;
  invDragDropInitialized = true;
  
  // Zone À faire
  const rowMain = document.getElementById('invRowMain');
  if (rowMain) {
    rowMain.addEventListener('dragover', (e) => {
      e.preventDefault();
      rowMain.classList.add('drag-over');
    });
    rowMain.addEventListener('dragleave', (e) => {
      // Vérifier qu'on quitte vraiment la zone
      if (!rowMain.contains(e.relatedTarget)) {
        rowMain.classList.remove('drag-over');
      }
    });
    rowMain.addEventListener('drop', (e) => {
      e.preventDefault();
      rowMain.classList.remove('drag-over');
      if (draggedInvId) {
        moveInvItem(draggedInvId, 'main', 0);
      }
    });
  }
  
  // Slots Pablo et Checkna
  document.querySelectorAll('.inv-col-slot, .inv-col-zero').forEach(slot => {
    slot.addEventListener('dragover', (e) => {
      e.preventDefault();
      slot.classList.add('drag-over');
    });
    slot.addEventListener('dragleave', () => {
      slot.classList.remove('drag-over');
    });
    slot.addEventListener('drop', (e) => {
      e.preventDefault();
      slot.classList.remove('drag-over');
      if (draggedInvId) {
        const rang = slot.dataset.rang;
        const pos = parseInt(slot.dataset.pos);
        moveInvItem(draggedInvId, rang, pos);
      }
    });
  });
}

// Déplacer un item
function moveInvItem(id, newRang, newPosition) {
  if (!inventaireData[id]) return;
  
  inventaireData[id].rang = newRang;
  inventaireData[id].position = newPosition;
  inventaireData[id].updatedAt = new Date().toISOString();
  
  // Sauvegarder
  if (firebaseDb) {
    firebaseDb.ref('inventaire/' + id).set(inventaireData[id]);
  }
  
  renderInventaireCubes();
  showToast('Déplacé vers ' + (newRang === 'main' ? 'À faire' : newRang + ' pos ' + newPosition));
}

// Toggle zone
function toggleInvZone(zoneId) {
  const content = document.getElementById(zoneId);
  if (content) {
    content.style.display = content.style.display === 'none' ? '' : 'none';
  }
}

// Ouvrir fiche
function openInvFiche(id = null, defaultRang = 'main') {
  currentInvId = id;
  const overlay = document.getElementById('invFicheOverlay');
  const title = document.getElementById('invFicheTitle');
  const btnDelete = document.getElementById('invBtnDelete');
  
  if (id && inventaireData[id]) {
    const item = inventaireData[id];
    title.textContent = 'Modifier - ' + (item.nom || item.code || 'Article');
    document.getElementById('invNom').value = item.nom || '';
    document.getElementById('invCode').value = item.code || '';
    document.getElementById('invQuantite').value = item.quantite || '';
    document.getElementById('invRang').value = item.rang || 'main';
    document.getElementById('invPosition').value = item.position || 0;
    // Afficher/masquer position selon rang
    updateInvPositionVisibility();
    btnDelete.style.display = '';
  } else {
    title.textContent = 'Nouvel article';
    document.getElementById('invNom').value = '';
    document.getElementById('invCode').value = '';
    document.getElementById('invQuantite').value = '';
    document.getElementById('invRang').value = defaultRang;
    document.getElementById('invPosition').value = 1;
    updateInvPositionVisibility();
    btnDelete.style.display = 'none';
  }
  
  overlay.classList.remove('hidden');
}

// Afficher/masquer le champ position selon le rang
function updateInvPositionVisibility() {
  const rang = document.getElementById('invRang').value;
  const positionField = document.getElementById('invPositionField');
  if (positionField) {
    positionField.style.display = (rang === 'pablo' || rang === 'checkna') ? '' : 'none';
  }
}

// Fermer fiche
function closeInvFiche() {
  document.getElementById('invFicheOverlay').classList.add('hidden');
  currentInvId = null;
}

// Sauvegarder
function saveInvItem() {
  const rang = document.getElementById('invRang').value;
  const positionVal = document.getElementById('invPosition').value;
  const quantiteVal = document.getElementById('invQuantite').value.trim();
  
  const item = {
    nom: document.getElementById('invNom').value.trim(),
    code: document.getElementById('invCode').value.trim(),
    quantite: quantiteVal ? parseInt(quantiteVal) : null,
    rang: rang,
    position: (rang === 'pablo' || rang === 'checkna') ? parseInt(positionVal) : 0,
    updatedAt: new Date().toISOString()
  };
  
  if (!item.nom && !item.code) {
    alert('Veuillez entrer un nom ou un numéro de produit');
    return;
  }
  
  const id = currentInvId || 'inv_' + Date.now();
  
  if (!currentInvId) {
    item.createdAt = new Date().toISOString();
  }
  
  inventaireData[id] = item;
  
  if (firebaseDb) {
    firebaseDb.ref('inventaire/' + id).set(item);
  }
  
  renderInventaireCubes();
  closeInvFiche();
  showToast('Article enregistré');
}

// Supprimer
function deleteInvItem() {
  if (!currentInvId) return;
  if (!confirm('Supprimer cet article?')) return;
  
  delete inventaireData[currentInvId];
  
  if (firebaseDb) {
    firebaseDb.ref('inventaire/' + currentInvId).remove();
  }
  
  renderInventaireCubes();
  closeInvFiche();
  showToast('Article supprimé');
}

// Exposer fonctions inventaire
window.openInvFiche = openInvFiche;
window.renderInventaireCubes = renderInventaireCubes;
window.updateInvPositionVisibility = updateInvPositionVisibility;
window.moveInvItem = moveInvItem;
window.closeInvFiche = closeInvFiche;
window.saveInvItem = saveInvItem;
window.deleteInvItem = deleteInvItem;
window.toggleInvZone = toggleInvZone;
window.initInventaire = initInventaire;

// ===== COMMANDES (SÉRIE+) =====
// Données de test - commandes pré-créées pour démonstration
const TEST_COMMANDES = {
  'test1': {
    order: '454654',
    client: 'Vermeiren',
    dateLivraison: '2025-01-15',
    items: [
      { name: 'Premium', grandeurs: [
        { name: 'S', qty: 5, atelier: { status: 'done', note: '', qtyFait: 5 }, couture: { status: 'partial', note: '', qtyFait: 3, employe: '' }, inspection: { status: 'todo', note: '', qtyFait: 0, exped: 'attente' } },
        { name: 'M', qty: 10, atelier: { status: 'partial', note: 'Test note', qtyFait: 7 }, couture: { status: 'todo', note: '', qtyFait: 0, employe: '' }, inspection: { status: 'todo', note: '', qtyFait: 0, exped: 'attente' } }
      ]},
      { name: 'Ultra', grandeurs: [
        { name: 'L', qty: 3, atelier: { status: 'todo', note: '', qtyFait: 0 }, couture: { status: 'todo', note: '', qtyFait: 0, employe: '' }, inspection: { status: 'todo', note: '', qtyFait: 0, exped: 'attente' } }
      ]}
    ]
  },
  'test2': {
    order: '156333',
    client: 'HME',
    dateLivraison: '2025-01-05',
    items: []
  },
  'test3': {
    order: '789012',
    client: 'France',
    dateLivraison: '2025-02-01',
    items: [
      { name: 'Physiair', grandeurs: [
        { name: 'XL', qty: 8, atelier: { status: 'done', note: '', qtyFait: 8 }, couture: { status: 'done', note: '', qtyFait: 8, employe: 'Mario' }, inspection: { status: 'partial', note: '', qtyFait: 4, exped: 'partiel' } }
      ]}
    ]
  }
};

// Commandes data - initialisé avec les données de test
let commandesData = JSON.parse(JSON.stringify(TEST_COMMANDES));
let currentCmdId = null;
const CMD_CLIENTS = ['Vermeiren', 'HME', 'C1SOUTH', 'Cubro', 'France'];

// Listes des valeurs pour Item et Grandeur
const CMD_ITEM_VALUES = ["Premium", "Ultra", "PZ Siliko", "Physiair", "Easy-fit", "HP2", "Cinch", "Resolve", "Brio", "Appuis Thoraciques"];
const CMD_GRANDEUR_VALUES = ["10 x 10", "12 x 12", "12 x 14", "14 x 14", "14 x 16", "16 x 16", "16 x 18", "18 x 16", "18 x 18", "18 x 20", "20 x 20", "20 x 18", "20 x 16", "20 x 22", "22 x 18", "22 x 20"];

// Listes des employés
let EMPLOYES_ATELIER = ['Mario', 'Sina', 'Cassie'];
let EMPLOYES_COUTURE = ['Michelle', 'Francine', 'Stéphanie', 'Valérie'];

// Options d'expédition
let EXPEDITION_OPTIONS = [
  { value: 'attente', label: 'En attente', blink: false, color: '' },
  { value: 'pret', label: 'Prêt expédition', blink: true, color: '' },
  { value: 'expedie', label: 'Expédié', blink: false, color: '' }
];

// ===== SYSTÈME DE RECETTES ET MATÉRIAUX =====
// Recettes par défaut pour chaque type d'item
const CMD_RECETTES = {
  "HP2": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" }
  ],
  "HP2 Ultra": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" },
    { code: "COQ-2S", materiau: "Coquille 2Sizer", qty: 1, epaisseur: "" },
    { code: "VIS-T36", materiau: "Feuille Viscose T36 (cuvette)", qty: 1, epaisseur: "" }
  ],
  "Ultra": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" },
    { code: "COQ-2S", materiau: "Coquille 2Sizer", qty: 1, epaisseur: "" }
  ],
  "Premium": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" }
  ],
  "Easy-fit": [
    { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" }
  ],
  "Brio": [
    { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1.5, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" },
    { code: "BIS-BR", materiau: "Biseau pour Brio", qty: 1, epaisseur: "" }
  ],
  "Coussin Brio": [
    { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1.5, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" },
    { code: "BIS-BR", materiau: "Biseau pour Brio", qty: 1, epaisseur: "" },
    { code: "BUT-AB", materiau: "Butée ABD Néocor", qty: 1, epaisseur: "" },
    { code: "NEO-40", materiau: "Feuille Néocor VF40", qty: 0.5, epaisseur: "½″" }
  ],
  "Physiair": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "AIR-M", materiau: "Feuille Air mou", qty: 1, epaisseur: "½″" }
  ],
  "Cinch": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "½″" },
    { code: "CIN-S", materiau: "Sangle Cinch", qty: 1, epaisseur: "" }
  ],
  "Resolve": [
    { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
    { code: "RES-F", materiau: "Foam Resolve", qty: 1, epaisseur: "1″" }
  ],
  "PZ Siliko": [
    { code: "SIL-22", materiau: "Feuille Silicone 22x24", qty: 1, epaisseur: "1″" },
    { code: "PZ-B", materiau: "Base PZ", qty: 1, epaisseur: "" }
  ]
};

// Recettes personnalisées (peuvent être ajoutées/modifiées)
let customRecettes = {};

// Obtenir la recette pour un item
function getRecetteForItem(itemName) {
  if (!itemName) return [];
  
  // D'abord vérifier les recettes personnalisées (exact match)
  const customKey = itemName.replace(/[.#$/[\]]/g, '_');
  if (customRecettes[customKey]) {
    return customRecettes[customKey];
  }
  
  // Vérifier les recettes par défaut (exact match)
  if (CMD_RECETTES[itemName]) {
    return CMD_RECETTES[itemName];
  }
  
  // Recherche partielle dans les recettes par défaut
  const itemNameLower = itemName.toLowerCase();
  for (const [key, value] of Object.entries(CMD_RECETTES)) {
    if (key.toLowerCase().includes(itemNameLower) || itemNameLower.includes(key.toLowerCase())) {
      return value;
    }
  }
  
  // Recherche partielle dans les recettes personnalisées
  for (const [key, value] of Object.entries(customRecettes)) {
    const keyClean = key.replace(/_/g, ' ').toLowerCase();
    if (keyClean.includes(itemNameLower) || itemNameLower.includes(keyClean)) {
      return value;
    }
  }
  
  return [];
}

// Mettre à jour la section Matériaux
function updateMateriauxSection(cmdId) {
  const container = document.getElementById('cmdMateriauxContainer');
  const totalContainer = document.getElementById('cmdMateriauxTotalTop');
  if (!container) return;
  
  const cmd = commandesData[cmdId];
  if (!cmd || !cmd.items || cmd.items.length === 0) {
    container.innerHTML = '<div style="color:#9ca3af;font-size:9px;text-align:center;padding:10px;grid-column:1/-1;">Aucun item - Ajoutez des items dans le Tableau</div>';
    if (totalContainer) totalContainer.innerHTML = '';
    return;
  }
  
  // Collecter tous les matériaux pour le total
  const totalMateriaux = {};
  
  // Préparer les colonnes par item
  const columns = [];
  
  // Pour chaque item dans la commande
  cmd.items.forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    
    // Calculer la quantité totale (somme de toutes les grandeurs)
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    // Créer les lignes pour cet item
    const lines = [];
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const matQty = parseFloat(mat.qty) || 1;
        const qtyNeeded = matQty * (totalQty || 1);
        const qtyDisplay = qtyNeeded % 1 === 0 ? qtyNeeded : qtyNeeded.toFixed(1);
        const epaisseur = mat.epaisseur || '';
        const code = mat.code || '';
        const matName = mat.materiau || 'Matériau';
        const fullName = epaisseur ? `${matName} ${epaisseur}` : matName;
        
        lines.push({ code, fullName, qtyDisplay });
        
        // Ajouter au total
        const key = code || fullName;
        if (!totalMateriaux[key]) {
          totalMateriaux[key] = { code, name: fullName, qty: 0 };
        }
        totalMateriaux[key].qty += qtyNeeded;
      });
    }
    
    columns.push({
      name: itemName,
      qty: totalQty,
      lines: lines,
      hasRecette: recette && recette.length > 0
    });
  });
  
  // Générer le HTML des colonnes (2 par rangée)
  let html = '';
  
  for (let i = 0; i < columns.length; i += 2) {
    const left = columns[i];
    const right = columns[i + 1];
    
    // Colonne gauche
    html += `<div class="cmd-materiaux-column">
      <div class="cmd-materiaux-header">${left.name} (×${left.qty || 0})</div>
      <div class="cmd-materiaux-list">`;
    
    if (left.hasRecette) {
      left.lines.forEach(line => {
        html += `<div class="cmd-materiaux-item">
          <span class="cmd-materiaux-code">${line.code}</span>
          <span class="cmd-materiaux-name">${line.fullName}</span>
          <span class="cmd-materiaux-qty">${line.qtyDisplay}</span>
        </div>`;
      });
    } else {
      html += '<div style="color:#f59e0b;font-size:8px;font-style:italic;text-align:center;padding:4px;">⚠ Pas de recette</div>';
    }
    
    html += '</div></div>';
    
    // Colonne droite (si existe)
    if (right) {
      html += `<div class="cmd-materiaux-column">
        <div class="cmd-materiaux-header">${right.name} (×${right.qty || 0})</div>
        <div class="cmd-materiaux-list">`;
      
      if (right.hasRecette) {
        right.lines.forEach(line => {
          html += `<div class="cmd-materiaux-item">
            <span class="cmd-materiaux-code">${line.code}</span>
            <span class="cmd-materiaux-name">${line.fullName}</span>
            <span class="cmd-materiaux-qty">${line.qtyDisplay}</span>
          </div>`;
        });
      } else {
        html += '<div style="color:#f59e0b;font-size:8px;font-style:italic;text-align:center;padding:4px;">⚠ Pas de recette</div>';
      }
      
      html += '</div></div>';
    }
  }
  
  container.innerHTML = html;
  
  // Générer le HTML du Total Matériaux
  const totalKeys = Object.keys(totalMateriaux);
  let totalHtml = '';
  
  if (totalKeys.length > 0) {
    totalHtml = `
      <div class="cmd-materiaux-total">
        <div class="cmd-materiaux-total-header">📦 TOTAL MATÉRIAUX</div>
        <div class="cmd-materiaux-total-list">
    `;
    
    totalKeys.forEach(key => {
      const mat = totalMateriaux[key];
      const qtyDisplay = mat.qty % 1 === 0 ? mat.qty : mat.qty.toFixed(1);
      totalHtml += `
        <div class="cmd-materiaux-total-item">
          <span class="code">${mat.code || ''}</span>
          <span class="name">${mat.name}</span>
          <span class="qty">${qtyDisplay}</span>
        </div>
      `;
    });
    
    totalHtml += '</div></div>';
  }
  
  // Mettre à jour la section Total Matériaux
  if (totalContainer) {
    totalContainer.innerHTML = totalHtml;
  }
}

// Initialiser les commandes
// ===== GESTION DES RECETTES =====
let recettesPopupOverlay = null;

function openRecettesInfo() {
  openRecettesPopup();
}

function openRecettesPopup() {
  // Fermer si déjà ouvert
  if (recettesPopupOverlay) recettesPopupOverlay.remove();
  
  // Fusionner les recettes par défaut et personnalisées
  const allRecettes = {};
  Object.entries(CMD_RECETTES).forEach(([name, mats]) => {
    allRecettes[name] = { materiaux: JSON.parse(JSON.stringify(mats)), isDefault: true };
  });
  Object.entries(customRecettes).forEach(([name, mats]) => {
    allRecettes[name] = { materiaux: JSON.parse(JSON.stringify(mats)), isDefault: false };
  });
  
  recettesPopupOverlay = document.createElement('div');
  recettesPopupOverlay.id = 'recettesPopupOverlay';
  recettesPopupOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:35000;';
  recettesPopupOverlay.onclick = (e) => { if (e.target === recettesPopupOverlay) closeRecettesPopup(); };
  
  const popup = document.createElement('div');
  popup.style.cssText = 'background:white;border-radius:12px;width:95%;max-width:700px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;';
  
  popup.innerHTML = `
    <div style="background:linear-gradient(to bottom,#3f6eb8,#1d3560);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;font-size:14px;">⚙ Gestion des Recettes</h3>
      <div style="display:flex;gap:8px;">
        <button onclick="addNewRecette()" style="padding:6px 12px;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:11px;">+ Nouvelle Recette</button>
        <button onclick="closeRecettesPopup()" style="padding:6px 12px;background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.4);border-radius:6px;cursor:pointer;font-size:11px;">Fermer</button>
      </div>
    </div>
    <div id="recettesListContainer" style="flex:1;overflow-y:auto;padding:12px;background:#f8fafc;">
      ${renderRecettesList(allRecettes)}
    </div>
  `;
  
  recettesPopupOverlay.appendChild(popup);
  document.body.appendChild(recettesPopupOverlay);
}

function renderRecettesList(allRecettes) {
  let html = '';
  
  Object.entries(allRecettes).sort((a,b) => a[0].localeCompare(b[0])).forEach(([itemName, data]) => {
    const safeItemName = itemName.replace(/'/g, "\\'");
    html += `
      <div class="recette-card" style="background:white;border:1px solid #d1d5db;border-radius:8px;margin-bottom:10px;overflow:hidden;">
        <div style="background:linear-gradient(to bottom,#e2e8f0,#cbd5e1);padding:8px 12px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-weight:700;color:#1e3a5f;font-size:12px;">${itemName} ${data.isDefault ? '<span style="font-size:9px;color:#64748b;">(défaut)</span>' : '<span style="font-size:9px;color:#22c55e;">(personnalisée)</span>'}</span>
          <div style="display:flex;gap:4px;">
            <button onclick="addMateriauToRecette('${safeItemName}')" style="padding:3px 8px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px;">+ Matériau</button>
            <button onclick="renameRecette('${safeItemName}')" style="padding:3px 8px;background:#f59e0b;color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px;">✏ Renommer</button>
            <button onclick="deleteRecette('${safeItemName}')" style="padding:3px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:10px;">🗑</button>
          </div>
        </div>
        <div style="padding:8px;">
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr style="background:#f1f5f9;">
                <th style="padding:4px;text-align:left;width:70px;border-bottom:1px solid #d1d5db;">Code</th>
                <th style="padding:4px;text-align:left;border-bottom:1px solid #d1d5db;">Matériau</th>
                <th style="padding:4px;text-align:left;width:60px;border-bottom:1px solid #d1d5db;">Épaisseur</th>
                <th style="padding:4px;text-align:center;width:40px;border-bottom:1px solid #d1d5db;">Qté</th>
                <th style="padding:4px;width:30px;border-bottom:1px solid #d1d5db;"></th>
              </tr>
            </thead>
            <tbody>
    `;
    
    data.materiaux.forEach((mat, idx) => {
      html += `
        <tr style="border-bottom:1px dotted #e5e7eb;">
          <td style="padding:3px;"><input type="text" value="${mat.code || ''}" onchange="updateRecetteMat('${safeItemName}',${idx},'code',this.value)" style="width:100%;padding:2px 4px;border:1px solid #d1d5db;border-radius:3px;font-size:10px;"></td>
          <td style="padding:3px;"><input type="text" value="${mat.materiau || ''}" onchange="updateRecetteMat('${safeItemName}',${idx},'materiau',this.value)" style="width:100%;padding:2px 4px;border:1px solid #d1d5db;border-radius:3px;font-size:10px;"></td>
          <td style="padding:3px;"><input type="text" value="${mat.epaisseur || ''}" onchange="updateRecetteMat('${safeItemName}',${idx},'epaisseur',this.value)" style="width:100%;padding:2px 4px;border:1px solid #d1d5db;border-radius:3px;font-size:10px;"></td>
          <td style="padding:3px;"><input type="number" value="${mat.qty || 1}" min="0.1" step="0.1" onchange="updateRecetteMat('${safeItemName}',${idx},'qty',parseFloat(this.value))" style="width:100%;padding:2px 4px;border:1px solid #d1d5db;border-radius:3px;font-size:10px;text-align:center;"></td>
          <td style="padding:3px;text-align:center;"><button onclick="deleteMateriauFromRecette('${safeItemName}',${idx})" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;padding:2px 6px;font-size:10px;">✕</button></td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;
  });
  
  if (Object.keys(allRecettes).length === 0) {
    html = '<div style="text-align:center;color:#64748b;padding:40px;">Aucune recette. Cliquez sur "+ Nouvelle Recette" pour commencer.</div>';
  }
  
  return html;
}

function refreshRecettesList() {
  const container = document.getElementById('recettesListContainer');
  if (!container) return;
  
  const allRecettes = {};
  Object.entries(CMD_RECETTES).forEach(([name, mats]) => {
    allRecettes[name] = { materiaux: JSON.parse(JSON.stringify(mats)), isDefault: true };
  });
  Object.entries(customRecettes).forEach(([name, mats]) => {
    allRecettes[name] = { materiaux: JSON.parse(JSON.stringify(mats)), isDefault: false };
  });
  
  container.innerHTML = renderRecettesList(allRecettes);
}

function closeRecettesPopup() {
  if (recettesPopupOverlay) {
    recettesPopupOverlay.remove();
    recettesPopupOverlay = null;
  }
  // Rafraîchir les matériaux si une fiche est ouverte
  if (currentCmdId) {
    updateMateriauxSection(currentCmdId);
  }
}

function addNewRecette() {
  const name = prompt('Nom de la nouvelle recette (ex: "HP2 Custom"):');
  if (!name || name.trim() === '') return;
  
  const cleanName = name.trim();
  if (CMD_RECETTES[cleanName] || customRecettes[cleanName]) {
    alert('Une recette avec ce nom existe déjà!');
    return;
  }
  
  // Créer une recette vide
  customRecettes[cleanName] = [
    { code: '', materiau: 'Nouveau matériau', qty: 1, epaisseur: '' }
  ];
  
  saveRecettesToFirebase();
  refreshRecettesList();
}

function renameRecette(oldName) {
  const newName = prompt('Nouveau nom pour la recette:', oldName);
  if (!newName || newName.trim() === '' || newName === oldName) return;
  
  const cleanNewName = newName.trim();
  if (CMD_RECETTES[cleanNewName] || customRecettes[cleanNewName]) {
    alert('Une recette avec ce nom existe déjà!');
    return;
  }
  
  // Copier la recette
  let recette = customRecettes[oldName] || CMD_RECETTES[oldName];
  if (!recette) return;
  
  recette = JSON.parse(JSON.stringify(recette));
  
  // Supprimer l'ancienne (si personnalisée)
  if (customRecettes[oldName]) {
    delete customRecettes[oldName];
  }
  
  // Créer la nouvelle
  customRecettes[cleanNewName] = recette;
  
  saveRecettesToFirebase();
  refreshRecettesList();
}

function deleteRecette(itemName) {
  if (!confirm(`Supprimer la recette "${itemName}"?`)) return;
  
  if (customRecettes[itemName]) {
    delete customRecettes[itemName];
    saveRecettesToFirebase();
    refreshRecettesList();
  } else if (CMD_RECETTES[itemName]) {
    // Pour les recettes par défaut, on les "masque" en créant une version vide
    customRecettes[itemName] = [];
    saveRecettesToFirebase();
    refreshRecettesList();
  }
}

function addMateriauToRecette(itemName) {
  // Récupérer ou créer la recette personnalisée
  if (!customRecettes[itemName]) {
    customRecettes[itemName] = JSON.parse(JSON.stringify(CMD_RECETTES[itemName] || []));
  }
  
  customRecettes[itemName].push({
    code: '',
    materiau: 'Nouveau matériau',
    qty: 1,
    epaisseur: ''
  });
  
  saveRecettesToFirebase();
  refreshRecettesList();
}

function deleteMateriauFromRecette(itemName, matIdx) {
  // Récupérer ou créer la recette personnalisée
  if (!customRecettes[itemName]) {
    customRecettes[itemName] = JSON.parse(JSON.stringify(CMD_RECETTES[itemName] || []));
  }
  
  if (customRecettes[itemName].length <= 1) {
    alert('Une recette doit avoir au moins un matériau. Supprimez la recette entière si nécessaire.');
    return;
  }
  
  customRecettes[itemName].splice(matIdx, 1);
  saveRecettesToFirebase();
  refreshRecettesList();
}

function updateRecetteMat(itemName, matIdx, field, value) {
  // Récupérer ou créer la recette personnalisée
  if (!customRecettes[itemName]) {
    customRecettes[itemName] = JSON.parse(JSON.stringify(CMD_RECETTES[itemName] || []));
  }
  
  if (customRecettes[itemName][matIdx]) {
    customRecettes[itemName][matIdx][field] = value;
    saveRecettesToFirebase();
  }
}

function saveRecettesToFirebase() {
  if (firebaseDb) {
    firebaseDb.ref('customRecettes').set(customRecettes)
      .then(() => console.log('Recettes sauvegardées'))
      .catch(e => console.error('Erreur sauvegarde recettes:', e));
  }
  // Aussi sauvegarder en localStorage comme backup
  try {
    localStorage.setItem('physipro_custom_recettes', JSON.stringify(customRecettes));
  } catch(e) {}
}

function loadRecettesFromFirebase() {
  // D'abord charger depuis localStorage
  try {
    const stored = localStorage.getItem('physipro_custom_recettes');
    if (stored) {
      customRecettes = JSON.parse(stored);
    }
  } catch(e) {}
  
  // Puis depuis Firebase (prioritaire)
  if (firebaseDb) {
    firebaseDb.ref('customRecettes').on('value', snap => {
      if (snap.val()) {
        customRecettes = snap.val();
        console.log('Recettes chargées:', Object.keys(customRecettes).length);
      }
    });
  }
}

// ===== IMPRESSION DES MATÉRIAUX =====
function printMateriaux(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  // Calculer les matériaux totaux
  const totalMateriaux = {};
  // Détails par item
  const itemsDetails = [];
  
  (cmd.items || []).forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    const itemDetail = {
      name: itemName,
      qty: totalQty,
      materiaux: []
    };
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const qtyNeeded = (parseFloat(mat.qty) || 1) * (totalQty || 1);
        const key = mat.code || mat.materiau;
        const fullName = mat.materiau + (mat.epaisseur ? ' ' + mat.epaisseur : '');
        
        // Ajouter au total
        if (!totalMateriaux[key]) {
          totalMateriaux[key] = { code: mat.code || '', name: fullName, qty: 0 };
        }
        totalMateriaux[key].qty += qtyNeeded;
        
        // Ajouter aux détails de l'item
        itemDetail.materiaux.push({
          code: mat.code || '',
          name: fullName,
          qty: qtyNeeded
        });
      });
    }
    
    if (itemDetail.materiaux.length > 0) {
      itemsDetails.push(itemDetail);
    }
  });
  
  // Créer la fenêtre d'impression
  let printHtml = `<!DOCTYPE html><html><head><title>Matériaux - ${cmd.order}</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; font-size: 12px; }
      h1 { color: #1e3a5f; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; font-size: 18px; margin-bottom: 10px; }
      h2 { color: #1e3a5f; font-size: 14px; margin: 20px 0 8px 0; padding: 6px 10px; background: #e2e8f0; border-radius: 4px; }
      h3 { color: #374151; font-size: 12px; margin: 15px 0 5px 0; padding: 4px 8px; background: #f1f5f9; border-left: 3px solid #3b82f6; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
      th, td { border: 1px solid #d1d5db; padding: 6px 8px; text-align: left; }
      th { background: #3b82f6; color: white; font-size: 11px; }
      .total-section { background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 20px; }
      .total-section h2 { background: #3b82f6; color: white; margin: -12px -12px 12px -12px; padding: 10px; border-radius: 6px 6px 0 0; }
      .qty { font-weight: bold; color: #059669; text-align: right; font-size: 13px; }
      .item-section { page-break-inside: avoid; margin-bottom: 15px; }
      .info { color: #64748b; margin-bottom: 15px; }
      @media print { body { padding: 10px; } }
    </style>
  </head><body>
    <h1>📦 Liste Matériaux - Commande #${cmd.order}</h1>
    <p class="info"><strong>Client:</strong> ${cmd.client} | <strong>Date livraison:</strong> ${cmd.dateLivraison || 'N/A'} | <strong>Imprimé:</strong> ${new Date().toLocaleString('fr-CA')}</p>
    
    <!-- TOTAL DES MATÉRIAUX EN HAUT -->
    <div class="total-section">
      <h2>📋 TOTAL MATÉRIAUX À PRÉPARER</h2>
      <table>
        <thead><tr><th style="width:80px;">Code</th><th>Matériau</th><th style="width:60px;">Quantité</th></tr></thead>
        <tbody>`;
  
  Object.values(totalMateriaux).forEach(mat => {
    const qtyDisplay = mat.qty % 1 === 0 ? mat.qty : mat.qty.toFixed(1);
    printHtml += `<tr><td><strong>${mat.code}</strong></td><td>${mat.name}</td><td class="qty">${qtyDisplay}</td></tr>`;
  });
  
  printHtml += `</tbody></table></div>
    
    <!-- DÉTAILS PAR ITEM -->
    <h2>📝 DÉTAILS PAR ITEM</h2>`;
  
  itemsDetails.forEach(item => {
    printHtml += `
      <div class="item-section">
        <h3>${item.name} (×${item.qty})</h3>
        <table>
          <thead><tr><th style="width:80px;">Code</th><th>Matériau</th><th style="width:60px;">Quantité</th></tr></thead>
          <tbody>`;
    
    item.materiaux.forEach(mat => {
      const qtyDisplay = mat.qty % 1 === 0 ? mat.qty : mat.qty.toFixed(1);
      printHtml += `<tr><td>${mat.code}</td><td>${mat.name}</td><td class="qty">${qtyDisplay}</td></tr>`;
    });
    
    printHtml += `</tbody></table></div>`;
  });
  
  printHtml += `</body></html>`;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printHtml);
  printWindow.document.close();
  setTimeout(() => printWindow.print(), 250);
}

function initCommandes() {
  // Charger les recettes personnalisées
  loadRecettesFromFirebase();
  
  // D'abord essayer de charger depuis localStorage
  try {
    const stored = localStorage.getItem('physipro_commandes');
    if (stored) {
      const localData = JSON.parse(stored);
      if (localData && Object.keys(localData).length > 0) {
        // Fusionner avec commandesData existant (données de test)
        Object.keys(localData).forEach(key => {
          commandesData[key] = localData[key];
        });
        console.log('📦 Commandes chargées depuis localStorage:', Object.keys(localData).length);
      }
    }
  } catch(e) {
    console.error('Erreur chargement localStorage:', e);
  }
  
  // TOUJOURS afficher les cartes immédiatement avec les données locales
  renderCommandes();
  console.log('📦 Commandes affichées:', Object.keys(commandesData).length);
  
  // Si pas de Firebase, c'est terminé
  if (!firebaseDb) {
    return;
  }
  
  // Avec Firebase - écouter les changements (mise à jour en arrière-plan)
  firebaseDb.ref('commandes').on('value', snapshot => {
    const firebaseData = snapshot.val();
    
    if (firebaseData && Object.keys(firebaseData).length > 0) {
      // Firebase a des données - les fusionner (Firebase a priorité)
      Object.keys(firebaseData).forEach(key => {
        commandesData[key] = firebaseData[key];
      });
      // Nettoyer les notes corrompues
      cleanCorruptedNotes(commandesData, 'commandes');
      console.log('☁️ Commandes Firebase chargées:', Object.keys(firebaseData).length);
      
      // Sauvegarder tout en localStorage
      saveCommandesToLocalStorage();
      // Re-rendre avec les données Firebase
      renderCommandes();
    }
  }, error => {
    console.warn('⚠️ Firebase commandes non disponible:', error.message);
    // Les cartes sont déjà affichées depuis localStorage, pas besoin de faire plus
  });
}

// Sauvegarder les commandes en localStorage
function saveCommandesToLocalStorage() {
  try {
    localStorage.setItem('physipro_commandes', JSON.stringify(commandesData));
  } catch(e) {
    console.error('Erreur sauvegarde localStorage:', e);
  }
}

// Rendre le board de commandes
function renderCommandes() {
  CMD_CLIENTS.forEach(client => {
    const col = document.getElementById('col' + client);
    if (col) col.innerHTML = '';
  });
  
  const sorted = Object.entries(commandesData).sort((a, b) => {
    const posA = a[1].position ?? 999;
    const posB = b[1].position ?? 999;
    return posA - posB;
  });
  
  sorted.forEach(([cmdId, cmd]) => {
    const col = document.getElementById('col' + (cmd.client || 'Vermeiren'));
    if (col) {
      col.appendChild(createCmdCard(cmdId, cmd));
    }
  });
  
  updateCmdCounts();
}

// Créer une carte commande
// Jours fériés Québec
const JOURS_FERIES = [
  '2024-01-01', '2024-03-29', '2024-05-20', '2024-06-24', '2024-07-01', '2024-09-02', '2024-10-14', '2024-12-25', '2024-12-26',
  '2025-01-01', '2025-04-18', '2025-05-19', '2025-06-24', '2025-07-01', '2025-09-01', '2025-10-13', '2025-12-25', '2025-12-26',
  '2026-01-01', '2026-04-03', '2026-05-18', '2026-06-24', '2026-07-01', '2026-09-07', '2026-10-12', '2026-12-25', '2026-12-26'
];

function isJourFerie(date) {
  const dateStr = date.toISOString().split('T')[0];
  return JOURS_FERIES.includes(dateStr);
}

function isJourOuvrable(date) {
  const jour = date.getDay();
  if (jour === 0 || jour === 6) return false;
  if (isJourFerie(date)) return false;
  return true;
}

function calculerJoursOuvrables(dateDebut, dateFin) {
  if (!dateDebut || !dateFin) return null;
  
  const aujourdHui = new Date();
  aujourdHui.setHours(0, 0, 0, 0);
  const fin = new Date(dateFin);
  fin.setHours(0, 0, 0, 0);
  
  let jours = 0;
  const current = new Date(aujourdHui);
  
  if (fin < aujourdHui) {
    while (current > fin) {
      current.setDate(current.getDate() - 1);
      if (isJourOuvrable(current)) jours--;
    }
  } else {
    while (current < fin) {
      current.setDate(current.getDate() + 1);
      if (isJourOuvrable(current)) jours++;
    }
  }
  
  return jours;
}

function createCmdCard(cmdId, data) {
  const card = document.createElement('div');
  card.className = `cmd-card client-${(data.client || 'vermeiren').toLowerCase()}`;
  card.setAttribute('data-cmd-id', cmdId);
  
  // Calculer délai en JOURS OUVRABLES
  let delayText = '-- jours ouvrables';
  let delayClass = '';
  
  const hasValidDateLivraison = data.dateLivraison && data.dateLivraison !== '' && data.dateLivraison !== 'AAAA-MM-JJ';
  
  if (hasValidDateLivraison) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const livraison = new Date(data.dateLivraison);
    livraison.setHours(0, 0, 0, 0);
    
    if (livraison < today) {
      const joursRetard = Math.abs(calculerJoursOuvrables(livraison, today));
      delayText = `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`;
      delayClass = 'delai-retard';
    } else if (livraison.getTime() === today.getTime()) {
      delayText = "Aujourd'hui!";
      delayClass = 'delai-retard';
    } else {
      const joursRestants = calculerJoursOuvrables(today, livraison);
      delayText = `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`;
      
      if (joursRestants <= 3) delayClass = 'delai-rouge';
      else if (joursRestants <= 10) delayClass = 'delai-jaune';
      else delayClass = 'delai-vert';
    }
  }
  
  // Structure IDENTIQUE à l'ancien fichier
  card.innerHTML = `
    <div class="cmd-card-header">
      <div class="cmd-card-info">
        <div class="cmd-card-title-line">
          <div class="cmd-card-client">${data.client || 'Client'}</div>
        </div>
        <div class="cmd-card-order-line">
          <input type="text" class="cmd-card-order" value="${data.order || '000000'}" maxlength="6">
          <button class="cmd-card-fiche-btn" onclick="event.stopPropagation(); openCmdFiche('${cmdId}')">Fiche</button>
        </div>
      </div>
    </div>
    <div class="cmd-card-separator"></div>
    <div class="cmd-card-delay ${delayClass}"><span>${delayText}</span></div>
    <div class="cmd-card-footer">
      <button class="cmd-card-btn btn-move" onclick="event.stopPropagation(); openCmdRangMenu('${cmdId}', this)">Rang</button>
      <button class="cmd-card-btn btn-delete" onclick="event.stopPropagation(); confirmDeleteCmd('${cmdId}')">Supprimer</button>
    </div>
  `;
  
  // Event listener pour édition du numéro de commande
  const orderInput = card.querySelector('.cmd-card-order');
  orderInput.addEventListener('blur', () => {
    commandesData[cmdId].order = orderInput.value;
    saveCommandeToFirebase(cmdId);
  });
  
  return card;
}

// Menu de rang pour commandes
function openCmdRangMenu(cmdId, btn) {
  // Fermer tout menu existant
  document.querySelectorAll('.cmd-rang-menu').forEach(m => m.remove());
  
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const client = cmd.client;
  const col = document.getElementById('col' + client);
  if (!col) return;
  
  // Compter les cartes dans la colonne
  const cardsInCol = Object.entries(commandesData)
    .filter(([id, c]) => c.client === client)
    .sort((a, b) => (a[1].position ?? 999) - (b[1].position ?? 999));
  
  const currentPos = cardsInCol.findIndex(([id]) => id === cmdId) + 1;
  const totalCards = cardsInCol.length;
  
  // Créer le menu
  const menu = document.createElement('div');
  menu.className = 'cmd-rang-menu';
  menu.style.cssText = 'position:fixed;background:white;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:20000;padding:10px;min-width:150px;';
  
  const rect = btn.getBoundingClientRect();
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 5) + 'px';
  
  menu.innerHTML = `
    <div style="font-weight:700;color:#1e3a5f;margin-bottom:8px;font-size:12px;">Rang: ${currentPos} / ${totalCards}</div>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <button onclick="moveCmdToRang('${cmdId}', 1)" style="padding:6px 12px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">⬆ Premier</button>
      <button onclick="moveCmdToRang('${cmdId}', ${currentPos - 1})" style="padding:6px 12px;background:#64748b;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;" ${currentPos <= 1 ? 'disabled' : ''}>↑ Monter</button>
      <button onclick="moveCmdToRang('${cmdId}', ${currentPos + 1})" style="padding:6px 12px;background:#64748b;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;" ${currentPos >= totalCards ? 'disabled' : ''}>↓ Descendre</button>
      <button onclick="moveCmdToRang('${cmdId}', ${totalCards})" style="padding:6px 12px;background:#3b82f6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">⬇ Dernier</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Fermer au clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

// Déplacer une commande à un rang spécifique
function moveCmdToRang(cmdId, newRang) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const client = cmd.client;
  
  // Obtenir toutes les cartes de cette colonne
  const cardsInCol = Object.entries(commandesData)
    .filter(([id, c]) => c.client === client)
    .sort((a, b) => (a[1].position ?? 999) - (b[1].position ?? 999));
  
  // Retirer la carte actuelle
  const currentIdx = cardsInCol.findIndex(([id]) => id === cmdId);
  if (currentIdx === -1) return;
  
  const [removed] = cardsInCol.splice(currentIdx, 1);
  
  // Insérer à la nouvelle position
  const newIdx = Math.max(0, Math.min(newRang - 1, cardsInCol.length));
  cardsInCol.splice(newIdx, 0, removed);
  
  // Mettre à jour les positions
  cardsInCol.forEach(([id, c], idx) => {
    commandesData[id].position = idx;
  });
  
  // Sauvegarder et rafraîchir
  Object.keys(commandesData).forEach(id => saveCommandeToFirebase(id));
  renderCommandes();
  
  // Fermer le menu
  document.querySelectorAll('.cmd-rang-menu').forEach(m => m.remove());
  showToast('Position mise à jour');
}

// Mettre à jour les compteurs
function updateCmdCounts() {
  CMD_CLIENTS.forEach(client => {
    const col = document.getElementById('col' + client);
    const countEl = document.getElementById('count' + client);
    if (col && countEl) {
      countEl.textContent = col.querySelectorAll('.cmd-card').length;
    }
  });
}

// Ouvrir la fiche commande
function openCmdFiche(cmdId) {
  currentCmdId = cmdId;
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  if (!cmd.items) cmd.items = [];
  
  const overlay = document.getElementById('cmdFicheOverlay');
  const content = document.getElementById('cmdFicheContent');
  
  let delaiHtml = renderCmdDelai(cmd);
  
  content.innerHTML = `
    <div class="cmd-fiche-header">
      <div class="cmd-fiche-header-left">
        <div class="cmd-fiche-logo">
          <img src="https://raw.githubusercontent.com/Physipro-list/Physipro-serie/main/logo-physiprodemi1.png" alt="PhysiPro"/>
        </div>
        <div class="cmd-fiche-title">Commande #${cmd.order || '000000'} - ${cmd.client || ''}</div>
      </div>
      <div class="cmd-fiche-tabs">
        <button class="cmd-fiche-tab tab-info active" id="tabInfo" onclick="switchCmdTab('info')">📋 Info / Magasin</button>
        <button class="cmd-fiche-tab tab-tableau" id="tabTableau" onclick="switchCmdTab('tableau')">📊 Tableau</button>
      </div>
      <button class="cmd-fiche-close" onclick="closeCmdFiche()">✕</button>
    </div>
    
    <div class="cmd-fiche-body">
      <!-- VUE INFO -->
      <div class="cmd-view-info active" id="viewInfo">
        <div class="cmd-panel cmd-panel-info">
          <div class="cmd-panel-header">📋 Information</div>
          <div class="cmd-panel-body">
            <div class="cmd-info-row">
              <div class="cmd-info-field">
                <label>Client</label>
                <select id="cfClient" onchange="updateCmdField('client', this.value)">
                  ${CMD_CLIENTS.map(c => `<option value="${c}" ${cmd.client === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
              </div>
              <div class="cmd-info-field">
                <label>N° Commande</label>
                <input type="text" id="cfOrder" value="${cmd.order || ''}" onblur="updateCmdField('order', this.value)" maxlength="10">
              </div>
            </div>
            
            <div class="cmd-info-row">
              <div class="cmd-info-field">
                <label>N° PO</label>
                <input type="text" id="cfPO" value="${cmd.numeroPO || ''}" onblur="updateCmdField('numeroPO', this.value)">
              </div>
              <div class="cmd-info-field">
                <label>N° Soumission</label>
                <input type="text" id="cfSoumission" value="${cmd.numeroSoumission || ''}" onblur="updateCmdField('numeroSoumission', this.value)">
              </div>
            </div>
            
            <div class="cmd-info-row">
              <div class="cmd-info-field">
                <label>Date reçue</label>
                <div class="cmd-date-pill" id="cfDateRecue" onclick="openCmdCalendar('dateRecue', this)">${cmd.dateRecue || 'Sélectionner...'}</div>
              </div>
              <div class="cmd-info-field">
                <label>Date livraison</label>
                <div class="cmd-date-pill" id="cfDateLiv" onclick="openCmdCalendar('dateLivraison', this)">${cmd.dateLivraison || 'Sélectionner...'}</div>
              </div>
            </div>
            
            <div id="cmdDelaiDisplay">${delaiHtml}</div>
            
            <div class="cmd-notes-section">
              <label>Notes</label>
              <div class="cmd-notes-content" id="cfNotes" contenteditable="true" onblur="updateCmdField('notes', this.innerHTML)">${cmd.notes || ''}</div>
            </div>
          </div>
        </div>
        
        <!-- PANNEAU MAGASIN (droite) -->
        <div class="cmd-panel cmd-panel-magasin" style="display: flex; flex-direction: column;">
          <div class="cmd-panel-header" style="display: flex; align-items: center; gap: 8px;">
            <span>📦 Magasin</span>
            <div style="display: flex; gap: 4px; margin-left: auto;">
              <button class="cmd-recettes-btn" onclick="openRecettesInfo()">⚙ Recettes</button>
              <button onclick="printMateriaux('${cmdId}')" style="font-size: 8px; padding: 3px 8px; background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">🖨 Imprimer</button>
            </div>
          </div>
          <!-- Total Matériaux - EN HAUT juste après le header -->
          <div class="cmd-materiaux-total-section-top" id="cmdMateriauxTotalTop">
            <!-- Généré par updateMateriauxSection -->
          </div>
          <!-- Zone scrollable pour les recettes -->
          <div class="cmd-panel-body" style="flex: 1; overflow-y: auto; padding: 8px;">
            <div class="cmd-materiaux-container" id="cmdMateriauxContainer">
              <!-- Les colonnes seront générées dynamiquement par item -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- VUE TABLEAU -->
      <div class="cmd-view-tableau" id="viewTableau">
        <div class="cmd-tableau-body">
          <div class="cmd-items-list" id="atelierItemsList">
            ${renderDeptItems(cmd.items, cmdId)}
          </div>
        </div>
      </div>
    </div>
    
    <div class="cmd-fiche-footer">
      <button class="cmd-fiche-btn btn-close" onclick="closeCmdFiche()">Fermer</button>
    </div>
  `;
  
  overlay.classList.add('active');
  
  // Mettre à jour les matériaux automatiquement
  setTimeout(() => updateMateriauxSection(cmdId), 100);
}

// Rendre le délai grand format
function renderCmdDelai(cmd) {
  if (!cmd.dateLivraison || cmd.dateLivraison === 'AAAA-MM-JJ') {
    return '<div class="cmd-delai-big" style="background:#f1f5f9;color:#64748b;"><div class="cmd-delai-big-jours">--</div><div class="cmd-delai-big-label">jours</div></div>';
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const livraison = new Date(cmd.dateLivraison);
  livraison.setHours(0, 0, 0, 0);
  
  const diff = Math.ceil((livraison - today) / (1000 * 60 * 60 * 24));
  let delaiClass = '';
  let label = 'jours restants';
  
  if (diff < 0) {
    delaiClass = 'delai-retard';
    label = 'jours de retard';
  } else if (diff <= 5) {
    delaiClass = 'delai-rouge';
  } else if (diff <= 10) {
    delaiClass = 'delai-jaune';
  } else {
    delaiClass = 'delai-vert';
  }
  
  const dateStr = livraison.toLocaleDateString('fr-CA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  
  return `
    <div class="cmd-delai-big ${delaiClass}">
      <div class="cmd-delai-big-jours">${Math.abs(diff)}</div>
      <div class="cmd-delai-big-label">${label}</div>
      <div class="cmd-delai-big-date">📅 ${dateStr}</div>
    </div>
  `;
}

// Calendrier pour commandes
let cmdCalendarField = null;
let cmdCalendarElement = null;
let cmdCalendarDate = new Date();

function openCmdCalendar(field, element) {
  cmdCalendarField = field;
  cmdCalendarElement = element;
  
  // Date actuelle ou sélectionnée
  const currentValue = commandesData[currentCmdId]?.[field];
  cmdCalendarDate = currentValue ? new Date(currentValue) : new Date();
  
  renderCmdCalendar();
}

function renderCmdCalendar() {
  // Fermer si existe
  document.querySelectorAll('.cmd-calendar-popup').forEach(p => p.remove());
  
  const popup = document.createElement('div');
  popup.className = 'cmd-calendar-popup';
  popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.4);z-index:35000;padding:15px;min-width:280px;';
  
  const year = cmdCalendarDate.getFullYear();
  const month = cmdCalendarDate.getMonth();
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  
  // Header
  let html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <button onclick="cmdCalendarNav(-1)" style="background:#3b82f6;color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;">◀</button>
      <span style="font-weight:700;color:#1e3a5f;">${monthNames[month]} ${year}</span>
      <button onclick="cmdCalendarNav(1)" style="background:#3b82f6;color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;">▶</button>
    </div>
    <table style="width:100%;border-collapse:collapse;text-align:center;">
      <thead><tr style="color:#64748b;font-size:11px;">
        <th style="padding:5px;">Dim</th><th style="padding:5px;">Lun</th><th style="padding:5px;">Mar</th>
        <th style="padding:5px;">Mer</th><th style="padding:5px;">Jeu</th><th style="padding:5px;">Ven</th><th style="padding:5px;">Sam</th>
      </tr></thead><tbody>
  `;
  
  // Jours
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date().toISOString().split('T')[0];
  const selected = commandesData[currentCmdId]?.[cmdCalendarField] || '';
  
  let day = 1;
  for (let w = 0; w < 6; w++) {
    html += '<tr>';
    for (let d = 0; d < 7; d++) {
      if ((w === 0 && d < firstDay) || day > daysInMonth) {
        html += '<td></td>';
      } else {
        const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const isToday = dateStr === today;
        const isSelected = dateStr === selected;
        const style = isSelected ? 'background:#3b82f6;color:white;' : isToday ? 'background:#dbeafe;' : '';
        html += '<td style="padding:5px;"><button onclick="selectCmdDate(\'' + dateStr + '\')" style="width:28px;height:28px;border:none;border-radius:50%;cursor:pointer;' + style + '">' + day + '</button></td>';
        day++;
      }
    }
    html += '</tr>';
    if (day > daysInMonth) break;
  }
  
  html += `</tbody></table>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button onclick="selectCmdDate('')" style="flex:1;padding:8px;background:#f1f5f9;border:none;border-radius:6px;cursor:pointer;">Effacer</button>
      <button onclick="closeCmdCalendar()" style="flex:1;padding:8px;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;">Fermer</button>
    </div>
  `;
  
  popup.innerHTML = html;
  document.body.appendChild(popup);
}

function cmdCalendarNav(dir) {
  cmdCalendarDate.setMonth(cmdCalendarDate.getMonth() + dir);
  renderCmdCalendar();
}

function selectCmdDate(dateStr) {
  if (!currentCmdId || !cmdCalendarField) return;
  
  commandesData[currentCmdId][cmdCalendarField] = dateStr;
  saveCommandeToFirebase(currentCmdId);
  
  // Mettre à jour l'affichage
  if (cmdCalendarElement) {
    cmdCalendarElement.textContent = dateStr || 'Sélectionner...';
  }
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalendarField === 'dateLivraison') {
    updateCmdDelaiDisplay();
  }
  
  closeCmdCalendar();
}

function closeCmdCalendar() {
  document.querySelectorAll('.cmd-calendar-popup').forEach(p => p.remove());
  cmdCalendarField = null;
  cmdCalendarElement = null;
}

function updateCmdDelaiDisplay() {
  if (!currentCmdId || !commandesData[currentCmdId]) return;
  const display = document.getElementById('cmdDelaiDisplay');
  if (display) {
    display.innerHTML = renderCmdDelai(commandesData[currentCmdId]);
  }
}

// ===== TABLEAU À 3 SECTIONS =====
function renderDeptItems(items, cmdId) {
  let html = `
    <table class="cmd-items-table">
      <colgroup>
        <col style="width: 12px;">
        <col style="width: 52px;">
        <col style="width: 24px;">
        <col style="width: 32px;">
        <col style="width: 42px;">
        <col style="width: 30px;">
        <col style="width: 52px;">
        <col style="width: 24px;">
        <col style="width: 32px;">
        <col style="width: 42px;">
        <col style="width: 58px;">
        <col style="width: 30px;">
        <col style="width: 52px;">
        <col style="width: 24px;">
        <col style="width: 32px;">
        <col style="width: 42px;">
        <col style="width: 88px;">
        <col style="width: 30px;">
        <col style="width: 14px;">
      </colgroup>
      <thead>
        <tr>
          <th class="section-header atelier" colspan="6">Atelier</th>
          <th class="section-header couture" colspan="6">Couture</th>
          <th class="section-header" colspan="7">Inspection</th>
        </tr>
        <tr>
          <th class="cmd-col-header cmd-col-plus"></th>
          <th class="cmd-col-header cmd-col-item"><button class="cmd-table-add-item-green" onclick="addCmdItemDept('${cmdId}')">+ Item</button></th>
          <th class="cmd-col-header cmd-col-qty">Qté</th>
          <th class="cmd-col-header cmd-col-total">Total</th>
          <th class="cmd-col-header cmd-col-status">Status</th>
          <th class="cmd-col-header cmd-col-notes border-right-solid">Notes</th>
          <th class="cmd-col-header cmd-col-item">Item</th>
          <th class="cmd-col-header cmd-col-qty">Qté</th>
          <th class="cmd-col-header cmd-col-total">Total</th>
          <th class="cmd-col-header cmd-col-status">Status</th>
          <th class="cmd-col-header cmd-col-emp">Emp.</th>
          <th class="cmd-col-header cmd-col-notes border-right-solid">Notes</th>
          <th class="cmd-col-header cmd-col-item">Item</th>
          <th class="cmd-col-header cmd-col-qty">Qté</th>
          <th class="cmd-col-header cmd-col-total">Total</th>
          <th class="cmd-col-header cmd-col-status">Status</th>
          <th class="cmd-col-header cmd-col-exped">Expédition</th>
          <th class="cmd-col-header cmd-col-notes">Notes</th>
          <th class="cmd-col-header cmd-col-x"></th>
        </tr>
      </thead>
      <tbody>
  `;
  
  if (!items || items.length === 0) {
    html += `<tr><td colspan="19" style="text-align:center;color:#9ca3af;padding:10px;font-size:8px;">Aucun item - Cliquez sur "+ Item" pour ajouter</td></tr>`;
  } else {
    items.forEach((item, itemIdx) => {
      const grandeurs = item.grandeurs || [];
      
      let totalQty = 0;
      grandeurs.forEach(g => { totalQty += parseInt(g.qty) || 0; });
      
      html += `
        <tr class="item-row">
          <td class="cmd-col-plus"><button class="cmd-table-add-grandeur" onclick="addCmdGrandeurDept('${cmdId}', ${itemIdx})">+</button></td>
          <td class="cmd-col-item"><button class="cmd-table-item-pill" onclick="openCmdItemMenu('${cmdId}', ${itemIdx}, event)">${item.name || 'Item'}</button></td>
          <td class="cmd-col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="cmd-col-total"></td>
          <td class="cmd-col-status"></td>
          <td class="cmd-col-notes border-right-solid"></td>
          <td class="cmd-col-item"><span class="cmd-table-item-name">${item.name || 'Item'}</span></td>
          <td class="cmd-col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="cmd-col-total"></td>
          <td class="cmd-col-status"></td>
          <td class="cmd-col-emp"></td>
          <td class="cmd-col-notes border-right-solid"></td>
          <td class="cmd-col-item"><span class="cmd-table-item-name">${item.name || 'Item'}</span></td>
          <td class="cmd-col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="cmd-col-total"></td>
          <td class="cmd-col-status"></td>
          <td class="cmd-col-exped"></td>
          <td class="cmd-col-notes"></td>
          <td class="cmd-col-x"><span class="cmd-table-delete-text" onclick="deleteCmdItemDept('${cmdId}', ${itemIdx})">−</span></td>
        </tr>
      `;
      
      grandeurs.forEach((g, gIdx) => {
        const qtyTotal = g.qty || 0;
        
        const atelierData = g.atelier || { status: 'todo', note: '', qtyFait: 0 };
        const atelierStatusClass = atelierData.status === 'done' ? 'done' : (atelierData.status === 'partial' ? 'partial' : 'todo');
        const atelierStatusText = atelierData.status === 'done' ? 'Complet' : (atelierData.status === 'partial' ? 'Partiel' : 'À faire');
        const atelierQtyFait = atelierData.qtyFait || 0;
        const atelierNoteClass = atelierData.note ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        
        const coutureData = g.couture || { status: 'todo', note: '', qtyFait: 0, employe: '' };
        const coutureStatusClass = coutureData.status === 'done' ? 'done' : (coutureData.status === 'partial' ? 'partial' : 'todo');
        const coutureStatusText = coutureData.status === 'done' ? 'Complet' : (coutureData.status === 'partial' ? 'Partiel' : 'À faire');
        const coutureQtyFait = coutureData.qtyFait || 0;
        const coutureNoteClass = coutureData.note ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        
        const inspData = g.inspection || { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
        const inspStatusClass = inspData.status === 'done' ? 'done' : (inspData.status === 'partial' ? 'partial' : 'todo');
        const inspStatusText = inspData.status === 'done' ? 'Emboîté' : (inspData.status === 'partial' ? 'Partiel' : 'À faire');
        const inspQtyFait = inspData.qtyFait || 0;
        const inspNoteClass = inspData.note ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        const inspExped = inspData.exped || 'attente';
        
        const expedOption = EXPEDITION_OPTIONS.find(o => o.value === inspExped) || { label: inspExped, blink: false, color: '' };
        let inspExpedClass = '';
        if (expedOption.blink) inspExpedClass = 'blink-green';
        else if (expedOption.color === 'yellow') inspExpedClass = 'yellow-bg';
        else if (inspExped === 'expedie') inspExpedClass = 'expedie';
        
        html += `
          <tr class="grandeur-row">
            <td class="cmd-col-plus"></td>
            <td class="cmd-col-item"><button class="cmd-table-grandeur-pill" onclick="openCmdGrandeurMenu('${cmdId}', ${itemIdx}, ${gIdx}, event)">${g.name || 'Grandeur'}</button></td>
            <td class="cmd-col-qty"><input type="text" class="cmd-table-qty-input" value="${qtyTotal}" maxlength="3" onfocus="this.select()" oninput="this.value=this.value.replace(/[^0-9]/g,'')" onchange="updateCmdGrandeurQty('${cmdId}', ${itemIdx}, ${gIdx}, this.value)"></td>
            <td class="cmd-col-total"><div class="cmd-table-fait-container"><input type="text" class="cmd-table-fait-input-top" value="${atelierQtyFait}" maxlength="3" onfocus="this.select()" oninput="limitQtyInputText(this, ${qtyTotal})" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'atelier', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="cmd-col-status"><button class="cmd-table-status ${atelierStatusClass}">${atelierStatusText}</button></td>
            <td class="cmd-col-notes border-right-solid"><button class="${atelierNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'atelier', event)">Notes</button></td>
            <td class="cmd-col-item"><span class="cmd-table-grandeur-readonly">${g.name || 'Grandeur'}</span></td>
            <td class="cmd-col-qty"><span class="cmd-table-qty-readonly">${qtyTotal}</span></td>
            <td class="cmd-col-total"><div class="cmd-table-fait-container"><input type="text" class="cmd-table-fait-input-top" value="${coutureQtyFait}" maxlength="3" onfocus="this.select()" oninput="limitQtyInputText(this, ${qtyTotal})" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="cmd-col-status"><button class="cmd-table-status ${coutureStatusClass}">${coutureStatusText}</button></td>
            <td class="cmd-col-emp">
              <select class="cmd-table-emp-select" onchange="handleCmdEmployeSelect(this, '${cmdId}', ${itemIdx}, ${gIdx}, 'couture')">
                <option value="">Employé</option>
                ${EMPLOYES_COUTURE.map(emp => `<option value="${emp}" ${coutureData.employe === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                <option value="__ADD__">➕ Ajouter</option>
                <option value="__REMOVE__">➖ Supprimer</option>
              </select>
            </td>
            <td class="cmd-col-notes border-right-solid"><button class="${coutureNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', event)">Notes</button></td>
            <td class="cmd-col-item"><span class="cmd-table-grandeur-readonly">${g.name || 'Grandeur'}</span></td>
            <td class="cmd-col-qty"><span class="cmd-table-qty-readonly">${qtyTotal}</span></td>
            <td class="cmd-col-total"><div class="cmd-table-fait-container"><input type="text" class="cmd-table-fait-input-top" value="${inspQtyFait}" maxlength="3" onfocus="this.select()" oninput="limitQtyInputText(this, ${qtyTotal})" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'inspection', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="cmd-col-status"><button class="cmd-table-status ${inspStatusClass}">${inspStatusText}</button></td>
            <td class="cmd-col-exped">
              <select class="cmd-table-exped-select ${inspExpedClass}" onchange="handleCmdExpedSelect(this, '${cmdId}', ${itemIdx}, ${gIdx})">
                ${EXPEDITION_OPTIONS.map(opt => `<option value="${opt.value}" ${inspExped === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                <option value="__ADD__">➕ Ajouter</option>
                <option value="__REMOVE__">➖ Supprimer</option>
              </select>
            </td>
            <td class="cmd-col-notes"><button class="${inspNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'inspection', event)">Notes</button></td>
            <td class="cmd-col-x"><span class="cmd-table-delete-text" onclick="deleteCmdGrandeurDept('${cmdId}', ${itemIdx}, ${gIdx})">−</span></td>
          </tr>
        `;
      });
    });
  }
  
  html += `</tbody></table>`;
  return html;
}

// ===== FONCTIONS TABLEAU =====
function addCmdItemDept(cmdId) {
  if (!commandesData[cmdId].items) commandesData[cmdId].items = [];
  commandesData[cmdId].items.push({ name: '', grandeurs: [] });
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function deleteCmdItemDept(cmdId, itemIdx) {
  commandesData[cmdId].items.splice(itemIdx, 1);
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function addCmdGrandeurDept(cmdId, itemIdx) {
  if (!commandesData[cmdId].items[itemIdx].grandeurs) {
    commandesData[cmdId].items[itemIdx].grandeurs = [];
  }
  commandesData[cmdId].items[itemIdx].grandeurs.push({ 
    name: '', 
    qty: 0,
    atelier: { status: 'todo', note: '', qtyFait: 0 },
    couture: { status: 'todo', note: '', qtyFait: 0, employe: '' },
    inspection: { status: 'todo', note: '', qtyFait: 0, exped: 'attente' }
  });
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function deleteCmdGrandeurDept(cmdId, itemIdx, gIdx) {
  commandesData[cmdId].items[itemIdx].grandeurs.splice(gIdx, 1);
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdGrandeurQty(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].qty = parseInt(value) || 0;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function limitQtyInputText(input, maxQty) {
  input.value = input.value.replace(/[^0-9]/g, '');
  let val = parseInt(input.value) || 0;
  if (val > maxQty) input.value = maxQty;
}

function updateCmdQtyFait(cmdId, itemIdx, gIdx, dept, value) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0 };
  
  const qtyFait = parseInt(value) || 0;
  const qtyTotal = parseInt(g.qty) || 0;
  
  g[dept].qtyFait = Math.min(qtyFait, qtyTotal);
  
  if (g[dept].qtyFait === 0) g[dept].status = 'todo';
  else if (g[dept].qtyFait >= qtyTotal) g[dept].status = 'done';
  else g[dept].status = 'partial';
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function refreshCmdDeptTables(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const atelierList = document.getElementById('atelierItemsList');
  if (atelierList) atelierList.innerHTML = renderDeptItems(cmd.items, cmdId);
  
  // Mettre à jour la section matériaux
  updateMateriauxSection(cmdId);
}

// ===== MENUS DE SÉLECTION =====
function closeCmdSelectMenu() {
  const existing = document.querySelector('.cmd-select-menu');
  if (existing) existing.remove();
}

function openCmdItemMenu(cmdId, itemIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 2) + 'px';
  
  menu.innerHTML = `
    <div class="cmd-select-title">Item commande</div>
    ${CMD_ITEM_VALUES.map(val => `
      <button class="cmd-select-option" onclick="selectCmdItem('${cmdId}', ${itemIdx}, '${val}')">${val}</button>
    `).join('')}
  `;
  
  document.body.appendChild(menu);
  setTimeout(() => { document.addEventListener('click', closeCmdSelectMenu, { once: true }); }, 10);
}

function selectCmdItem(cmdId, itemIdx, value) {
  commandesData[cmdId].items[itemIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

function openCmdGrandeurMenu(cmdId, itemIdx, gIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  menu.style.left = ((window.innerWidth - 150) / 2) + 'px';
  menu.style.top = ((window.innerHeight - 200) / 2) + 'px';
  
  menu.innerHTML = `
    <div class="cmd-select-title">Grandeur</div>
    ${CMD_GRANDEUR_VALUES.map(val => `
      <button class="cmd-select-option" onclick="selectCmdGrandeur('${cmdId}', ${itemIdx}, ${gIdx}, '${val}')">${val}</button>
    `).join('')}
  `;
  
  document.body.appendChild(menu);
  setTimeout(() => { document.addEventListener('click', closeCmdSelectMenu, { once: true }); }, 10);
}

function selectCmdGrandeur(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

// ===== NOTES =====
function closeCmdGrandeurNote() {
  const popup = document.getElementById('cmdMiniNotePopup');
  if (popup) popup.remove();
}

function openCmdGrandeurNoteDept(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0 };
  
  const popup = document.createElement('div');
  popup.className = 'cmd-mini-note-popup';
  popup.id = 'cmdMiniNotePopup';
  
  popup.innerHTML = `
    <textarea id="cmdMiniNoteText">${g[dept].note || ''}</textarea>
    <div class="mini-note-btns">
      <button class="save-btn" onclick="saveCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}')">OK</button>
      <button class="close-btn" onclick="closeCmdGrandeurNote()">✕</button>
    </div>
  `;
  
  document.body.appendChild(popup);
  popup.style.left = ((window.innerWidth - 180) / 2) + 'px';
  popup.style.top = ((window.innerHeight - 100) / 2) + 'px';
}

function saveCmdGrandeurNoteDept(cmdId, itemIdx, gIdx, dept) {
  const textarea = document.getElementById('cmdMiniNoteText');
  if (textarea) {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0 };
    g[dept].note = textarea.value;
    saveCommandeToFirebase(cmdId);
    refreshCmdDeptTables(cmdId);
  }
  closeCmdGrandeurNote();
}

// ===== EMPLOYÉS =====
function handleCmdEmployeSelect(selectEl, cmdId, itemIdx, gIdx, dept) {
  const value = selectEl.value;
  
  if (value === '__ADD__') {
    const newEmp = prompt('Nom du nouvel employé:');
    if (newEmp && newEmp.trim()) {
      const empName = newEmp.trim();
      if (!EMPLOYES_COUTURE.includes(empName)) {
        EMPLOYES_COUTURE.push(empName);
      }
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0, employe: '' };
      g[dept].employe = empName;
      saveCommandeToFirebase(cmdId);
      refreshCmdDeptTables(cmdId);
    } else {
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      selectEl.value = g[dept]?.employe || '';
    }
  } else if (value === '__REMOVE__') {
    const empList = EMPLOYES_COUTURE.map((e, i) => `${i + 1}. ${e}`).join('\n');
    const choice = prompt(`Supprimer quel employé?\n${empList}\n\nNuméro:`);
    if (choice) {
      const index = parseInt(choice) - 1;
      if (index >= 0 && index < EMPLOYES_COUTURE.length) {
        EMPLOYES_COUTURE.splice(index, 1);
        refreshCmdDeptTables(cmdId);
      }
    }
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    selectEl.value = g.couture?.employe || '';
  } else {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0, employe: '' };
    g[dept].employe = value;
    saveCommandeToFirebase(cmdId);
  }
}

// ===== EXPÉDITION =====
function handleCmdExpedSelect(selectEl, cmdId, itemIdx, gIdx) {
  const value = selectEl.value;
  
  if (value === '__ADD__') {
    const newLabel = prompt('Nom de la nouvelle option:');
    if (newLabel && newLabel.trim()) {
      const optValue = newLabel.trim().toLowerCase().replace(/\s+/g, '_');
      const blink = confirm('Cette option doit-elle clignoter en vert?');
      let color = '';
      if (!blink) {
        const isYellow = confirm('Cette option doit-elle être jaune?');
        if (isYellow) color = 'yellow';
      }
      EXPEDITION_OPTIONS.push({ value: optValue, label: newLabel.trim(), blink, color });
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
      g.inspection.exped = optValue;
      saveCommandeToFirebase(cmdId);
      refreshCmdDeptTables(cmdId);
    } else {
      const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
      selectEl.value = g.inspection?.exped || 'attente';
    }
  } else if (value === '__REMOVE__') {
    const optList = EXPEDITION_OPTIONS.map((o, i) => `${i + 1}. ${o.label}`).join('\n');
    const choice = prompt(`Supprimer quelle option?\n${optList}\n\nNuméro:`);
    if (choice) {
      const index = parseInt(choice) - 1;
      if (index >= 0 && index < EXPEDITION_OPTIONS.length) {
        EXPEDITION_OPTIONS.splice(index, 1);
        refreshCmdDeptTables(cmdId);
      }
    }
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    selectEl.value = g.inspection?.exped || 'attente';
  } else {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
    g.inspection.exped = value;
    saveCommandeToFirebase(cmdId);
    
    const expedOption = EXPEDITION_OPTIONS.find(o => o.value === value) || {};
    selectEl.className = 'cmd-table-exped-select';
    if (expedOption.blink) selectEl.classList.add('blink-green');
    else if (expedOption.color === 'yellow') selectEl.classList.add('yellow-bg');
    else if (value === 'expedie') selectEl.classList.add('expedie');
  }
}

// ===== AUTRES FONCTIONS =====
function switchCmdTab(tab) {
  const tabInfo = document.getElementById('tabInfo');
  const tabTableau = document.getElementById('tabTableau');
  const viewInfo = document.getElementById('viewInfo');
  const viewTableau = document.getElementById('viewTableau');
  
  if (tab === 'info') {
    tabInfo.classList.add('active');
    tabTableau.classList.remove('active');
    viewInfo.classList.add('active');
    viewTableau.classList.remove('active');
    // Rafraîchir les matériaux quand on revient sur Info/Magasin
    if (currentCmdId) {
      setTimeout(() => updateMateriauxSection(currentCmdId), 50);
    }
  } else {
    tabInfo.classList.remove('active');
    tabTableau.classList.add('active');
    viewInfo.classList.remove('active');
    viewTableau.classList.add('active');
  }
}

function closeCmdFiche() {
  // Sauvegarder avant de fermer
  if (currentCmdId && commandesData[currentCmdId]) {
    saveCommandeToFirebase(currentCmdId);
  }
  document.getElementById('cmdFicheOverlay').classList.remove('active');
  currentCmdId = null;
  renderCommandes();
}

function updateCmdField(field, value) {
  if (!currentCmdId || !commandesData[currentCmdId]) return;
  commandesData[currentCmdId][field] = value;
  commandesData[currentCmdId].updatedAt = new Date().toISOString();
  saveCommandeToFirebase(currentCmdId);
}

function saveCommandeToFirebase(cmdId) {
  if (!commandesData[cmdId]) return;
  
  // Toujours sauvegarder en localStorage
  saveCommandesToLocalStorage();
  
  // Si Firebase disponible, sauvegarder aussi là
  if (firebaseDb) {
    firebaseDb.ref('commandes/' + cmdId).set(commandesData[cmdId])
      .then(() => console.log('✅ Commande sauvegardée:', cmdId))
      .catch(e => console.error('❌ Erreur Firebase:', e));
  }
}

function showCmdAddModal() {
  document.getElementById('cmdAddModal').classList.add('active');
  document.getElementById('cmdAddOrder').value = '';
  document.getElementById('cmdAddDesc').value = '';
  document.getElementById('cmdAddPO').value = '';
  document.getElementById('cmdAddDateLivraison').value = '';
  // Focus sur le champ numéro de commande
  setTimeout(() => {
    document.getElementById('cmdAddOrder').focus();
  }, 100);
}

function closeCmdAddModal() {
  document.getElementById('cmdAddModal').classList.remove('active');
}

function confirmAddCommande() {
  const client = document.getElementById('cmdAddClient').value;
  const order = document.getElementById('cmdAddOrder').value.trim();
  const desc = document.getElementById('cmdAddDesc').value.trim();
  const po = document.getElementById('cmdAddPO').value.trim();
  const dateLiv = document.getElementById('cmdAddDateLivraison').value;
  
  if (!order) {
    alert('Veuillez entrer un numéro de commande');
    return;
  }
  
  const cmdId = 'cmd_' + Date.now();
  const newCmd = {
    client: client,
    order: order,
    description: desc,
    numeroPO: po,
    dateLivraison: dateLiv,
    dateRecue: new Date().toISOString().split('T')[0],
    statut: 'En cours',
    notes: '',
    items: [],
    createdAt: new Date().toISOString(),
    position: Object.keys(commandesData).length
  };
  
  commandesData[cmdId] = newCmd;
  saveCommandeToFirebase(cmdId);
  renderCommandes();
  closeCmdAddModal();
  showToast('Commande ajoutée');
}

function confirmDeleteCmd(cmdId) {
  if (confirm('Supprimer cette commande?')) {
    deleteCmd(cmdId);
  }
}

function deleteCmd(cmdId) {
  // Supprimer des données locales
  delete commandesData[cmdId];
  
  // Sauvegarder en localStorage
  saveCommandesToLocalStorage();
  
  // Si Firebase disponible, supprimer aussi là
  if (firebaseDb) {
    firebaseDb.ref('commandes/' + cmdId).remove();
  }
  
  renderCommandes();
  showToast('Commande supprimée');
}

// Exposer fonctions commandes
window.initCommandes = initCommandes;
window.renderCommandes = renderCommandes;
window.openCmdFiche = openCmdFiche;
window.closeCmdFiche = closeCmdFiche;
window.showCmdAddModal = showCmdAddModal;
window.closeCmdAddModal = closeCmdAddModal;
window.confirmAddCommande = confirmAddCommande;
window.confirmDeleteCmd = confirmDeleteCmd;
window.updateCmdField = updateCmdField;
window.switchCmdTab = switchCmdTab;
window.addCmdItemDept = addCmdItemDept;
window.deleteCmdItemDept = deleteCmdItemDept;
window.addCmdGrandeurDept = addCmdGrandeurDept;
window.deleteCmdGrandeurDept = deleteCmdGrandeurDept;
window.updateCmdGrandeurQty = updateCmdGrandeurQty;
window.updateCmdQtyFait = updateCmdQtyFait;
window.limitQtyInputText = limitQtyInputText;
window.openCmdItemMenu = openCmdItemMenu;
window.selectCmdItem = selectCmdItem;
window.openCmdGrandeurMenu = openCmdGrandeurMenu;
window.selectCmdGrandeur = selectCmdGrandeur;
window.openCmdGrandeurNoteDept = openCmdGrandeurNoteDept;
window.saveCmdGrandeurNoteDept = saveCmdGrandeurNoteDept;
window.closeCmdGrandeurNote = closeCmdGrandeurNote;
window.handleCmdEmployeSelect = handleCmdEmployeSelect;
window.handleCmdExpedSelect = handleCmdExpedSelect;
window.refreshCmdDeptTables = refreshCmdDeptTables;
window.saveCommandeToFirebase = saveCommandeToFirebase;
window.deleteCmd = deleteCmd;
window.openRecettesPopup = openRecettesPopup;
window.closeRecettesPopup = closeRecettesPopup;
window.addNewRecette = addNewRecette;
window.renameRecette = renameRecette;
window.deleteRecette = deleteRecette;
window.addMateriauToRecette = addMateriauToRecette;
window.deleteMateriauFromRecette = deleteMateriauFromRecette;
window.updateRecetteMat = updateRecetteMat;
window.printMateriaux = printMateriaux;
window.updateMateriauxSection = updateMateriauxSection;
window.openCmdRangMenu = openCmdRangMenu;
window.moveCmdToRang = moveCmdToRang;
window.openCmdCalendar = openCmdCalendar;
window.cmdCalendarNav = cmdCalendarNav;
window.selectCmdDate = selectCmdDate;
window.closeCmdCalendar = closeCmdCalendar;
</script>
</body>
</html>
