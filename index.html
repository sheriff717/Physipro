<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Physipro Moulage – v6.9.0 – FIREBASE AUTH</title>
  <!-- Firebase SDK - Chargement avec fallback -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // Vérifier immédiatement si Firebase est chargé
    window.firebaseReady = (typeof firebase !== 'undefined');
</script>
  <style>
    html, body{margin:0;padding:0;}
    /* ----- SHELL SPFX-READY ----- */
    .physiproRoot{
      min-height:100vh;
      font-family:Arial,Helvetica,sans-serif;
      background:linear-gradient(to bottom,#0b1d36,#3f6eb8);
      background-attachment:fixed;
      color:#fff;
    }
    .app-shell{
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* ----- TOP BAR (entête globale compacte) ----- */
    .topbar{
      flex:0 0 auto;
      width:100%;
      box-sizing:border-box;
      padding:10px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(to bottom,#04152c,#325f9b);
      box-shadow:0 2px 6px rgba(0,0,0,0.45);
      position:relative;
    }
    .tb-left{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .tb-left img{
      height:62px;
    }
    .tb-center{
      position:absolute;
      left:50%;
      top:46%;
      transform:translate(-50%,-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .top-title{
      font-size:26px;
      white-space:nowrap;
      font-weight:700;
      font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:#fdfdfd;
      text-shadow:0 2px 3px rgba(0,0,0,0.85);
    }
    .tb-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      justify-content:flex-start;
      margin-left:auto;
      height:100%;
      padding-top:5px;
      gap:12px;
      position:relative;
      z-index:50;
    }
    .tb-right-top{
      display:flex;
      gap:10px;
    }
    .add-btn{
      padding:6px 18px;
      font-size:10px;
      font-weight:600;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.45);
      background:linear-gradient(to bottom,#3f6eb8,#1d3560);
      color:#ffffff;
      cursor:pointer;
      box-shadow:inset 0 1px 2px rgba(255,255,255,0.18),0 2px 4px rgba(0,0,0,0.7);
    }

    .top-search-row{
      position:absolute;
      left:50%;
      bottom:0;
      transform:translateX(-50%);
      width:100%;
      display:flex;
      justify-content:center;
      pointer-events:auto;
    }
    .search-box{
      display:flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid #325f9b;
      background:rgba(2,11,24,0.55);
      box-shadow:0 2px 4px rgba(0,0,0,0.55);
      width:100%;
      max-width:460px;
      margin-bottom:2px;
    }
    .search-icon{
      font-size:10px;
      opacity:0.9;
      margin-right:4px;
    }
    .search-box input{
      flex:1;
      min-width:0;
      padding:3px 5px;
      font-size:10px;
      border-radius:999px;
      border:none;
      background:transparent;
      color:#ffffff;
      outline:none;
    }
    .search-box input::placeholder{
      color:rgba(210,220,240,0.7);
    }
    .search-clear{
      padding:0 8px;
      font-size:11px;
      border:none;
      background:transparent;
      color:rgba(210,220,240,0.9);
      cursor:pointer;
    }

    /* ----- BOARD WRAPPER ----- */
    .board-wrapper{
      flex:1 1 auto;
      padding:4px 0 16px;
      box-sizing:border-box;
      display:flex;
      justify-content:flex-start;
    }
    .boards-container{
      width:100%;
      max-width:100%;
    }
    .board{
      width:100%;
      display:grid;
      grid-template-columns:repeat(8, minmax(0,1fr));
      column-gap:4px;
    }

    /* ----- COLUMN HEADERS ----- */
    .col{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .colheader{
      position: relative;
      border-radius:18px;
      padding:6px 28px 6px 12px;
      text-align:center;
      font-weight:700;
      font-size:10px;
      color:#ffffff;
      box-shadow:0 2px 3px rgba(0,0,0,0.8);
      border:1px solid rgba(0,0,0,0.8);
      background:linear-gradient(to bottom,#2b5b99,#103561);
    }
    .colheader span.col-count{
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      padding: 0 6px;
      border-radius: 0 17px 17px 0;
      background: linear-gradient(to bottom, #1a3a5c, #0d1f33);
      border-left: 1px solid rgba(100, 180, 255, 0.4);
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .colheader.en-attente{
      background:linear-gradient(to bottom,#b81f1f,#6e0505);
    }
    .colheader.en-attente span.col-count{
      background: linear-gradient(to bottom, #5c1a1a, #330d0d);
      border-left: 1px solid rgba(255, 100, 100, 0.4);
    }

    /* ----- CARD ----- */
    .mcard{
      position: relative;
      margin:1px 2px 1px;
      border-radius:14px;
      background:#3b3b3b;
      border:1px solid rgba(0,0,0,0.55);
      box-shadow:0 2px 4px rgba(0,0,0,0.7);
      display:flex;
      flex-direction:column;
      color:#ffffff;
      font-size:10px;
      overflow:hidden;
    }

    /* Card header */
    .mcard-header{
      background:linear-gradient(to bottom,#5d5d5d,#3a3a3a);
      padding:4px 4px 2px;
      box-sizing:border-box;
      text-align:center;
    }
.mcard.region-qc .mcard-header{
  background:linear-gradient(to bottom,#04152c,#325f9b);
}
.mcard.region-ma .mcard-header{
  background:linear-gradient(to bottom,#5a2f99,#c49bf7);
}
.mcard.region-on .mcard-header{
  background:linear-gradient(to bottom,#704414,#E8B97A);
}


    .mcard-title{
      margin:1px 0 0;
      font-size:11px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      cursor:pointer;
    }
    .mcard-title:hover{
      text-decoration:underline;
      text-decoration-style:dotted;
    }
    .mcard-title-input{
      width:100%;
      font-size:11px;
      font-weight:700;
      background:rgba(0,0,0,0.3);
      border:1px solid #00aaff;
      border-radius:4px;
      color:#fff;
      text-align:center;
      padding:2px 4px;
      box-sizing:border-box;
      outline:none;
    }
    .mcard-order{
      margin:0 0 2px;
      font-size:11px;
      cursor:pointer;
    }
    .mcard-order:hover{
      text-decoration:underline;
      text-decoration-style:dotted;
    }
    .mcard-order-input{
      width:80px;
      font-size:11px;
      background:rgba(0,0,0,0.3);
      border:1px solid #00aaff;
      border-radius:4px;
      color:#fff;
      text-align:center;
      padding:2px 4px;
      box-sizing:border-box;
      outline:none;
    }
    .mcard-delays{
      margin-top:2px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .mcard-delay-pill{
      border-radius:999px;
      background:linear-gradient(to bottom,#0b5f2a,#063618);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:5px 14px;
      box-sizing:border-box;
    }
    .mcard-delay-pill span{
      font-size:11px;
      font-weight:700;
      white-space:nowrap;
    }

    /* Card body: grid 2 colonnes 45/55 */
    .mcard-body{
      padding:4px 4px 4px;
      display:grid;
      grid-template-columns:0.9fr 1.1fr;
      column-gap:3px;
      box-sizing:border-box;
    }
    .mcard-column{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .mcard-pill{
      background:linear-gradient(to bottom,#b3b3b3,#666666);
      color:#ffffff;
      font-size:8px;
      font-weight:700;
      border-radius:10px;
      height:11px;
      line-height:11px;
      padding:0 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 1px 2px rgba(0,0,0,0.9);
      border:1px solid #000000;
      box-sizing:border-box;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    

    .mcard-pill-small{
      font-size:8px;
    }

/* ===== DEPARTMENT TRACKING SYSTEM ===== */
.dept-pill-wrapper{
  position:relative;
  display:flex;
  align-items:center;
  width:100%;
}
.mcard-pill.dept-trackable{
  cursor:pointer;
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
  padding:0 6px;
  text-align:center;
}
.mcard-pill.dept-trackable:hover{
  box-shadow:0 0 0 1px rgba(255,255,255,0.6);
}

/* Department Info Popup */
.dept-info-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:15000;
}
.dept-info-overlay.hidden{
  display:none;
}
.dept-info-panel{
  background:linear-gradient(to bottom,#0b2343,#06315a);
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.3);
  box-shadow:0 8px 24px rgba(0,0,0,0.9);
  padding:8px;
  min-width:320px;
  max-width:400px;
  color:#ffffff;
}
.dept-info-header{
  font-size:18px;
  font-weight:700;
  margin-bottom:14px;
  padding-bottom:10px;
  border-bottom:2px solid rgba(255,255,255,0.2);
  display:flex;
  align-items:center;
  gap:10px;
}
.dept-info-row{
  display:flex;
  justify-content:space-between;
  padding:9px 0;
  font-size:14px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.dept-info-row:last-child{
  border-bottom:none;
}
.dept-info-label{
  color:rgba(255,255,255,0.75);
  font-weight:600;
}
.dept-info-value{
  font-weight:700;
  color:#00aaff;
  text-align:right;
}
.dept-info-close{
  margin-top:16px;
  width:100%;
  padding:10px;
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  border:none;
  border-radius:999px;
  color:#ffffff;
  font-weight:700;
  font-size:10px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,0.5);
}
.dept-info-close:hover{
  background:linear-gradient(to bottom,#0099ee,#0066bb);
  transform:translateY(-1px);
}

/* Champs de date éditables */
.dept-info-date-input{
  background:rgba(0,0,0,0.4);
  border:1px solid rgba(100,180,255,0.3);
  border-radius:6px;
  color:#00aaff;
  font-size:13px;
  font-weight:700;
  padding:4px 8px;
  text-align:right;
  cursor:pointer;
}
.dept-info-date-input:focus{
  outline:none;
  border-color:#00aaff;
  box-shadow:0 0 0 2px rgba(0,170,255,0.3);
}
.dept-info-save-btn{
  margin-top:12px;
  width:100%;
  padding:8px;
  background:linear-gradient(to bottom,#0b5f2a,#063618);
  border:none;
  border-radius:6px;
  color:#fff;
  font-weight:700;
  font-size:12px;
  cursor:pointer;
}
.dept-info-save-btn:hover{
  background:linear-gradient(to bottom,#0d7a35,#085020);
}
.dept-info-days-display{
  font-size:12px;
  color:#ffaa00;
  text-align:center;
  margin-top:8px;
  padding:6px;
  background:rgba(255,170,0,0.1);
  border-radius:6px;
}

/* ===== DEPARTMENT TRACKING PILL STATES v3.6.7 ===== */
/* État: Pas encore démarré - style normal */
.mcard-pill.dept-trackable.dept-not-started{
  /* Pas de changement, garde le style par défaut */
}

/* État: En cours - léger indicateur discret */
.mcard-pill.dept-trackable.dept-in-progress{
  /* Garde le style normal, pas de vert fluo */
}

/* État: Terminé - légèrement atténué */
.mcard-pill.dept-trackable.dept-completed{
  opacity:0.75;
}

/* Badge de durée - petite pastille verte à l'extrême droite */
.dept-duration-badge{
  position: absolute;
  right: 1px;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to bottom, #00aa00, #007700);
  color: #fff;
  font-weight: 700;
  font-size: 7px;
  padding: 1px 4px;
  border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* ===== ANIMATION CLIGNOTEMENT EMPLOYÉ ===== */
@keyframes blink-green {
  0%, 100% { background:linear-gradient(to bottom,#0b5f2a,#063618); box-shadow:0 0 8px rgba(0,255,0,0.6); }
  50% { background:linear-gradient(to bottom,#0d7a35,#085020); box-shadow:0 0 16px rgba(0,255,0,0.9); }
}

/* Pastille employé - clignotement vert quand actif */
.mcard-employee-label.employee-active {
  animation: blink-green 1s infinite;
  border: 1px solid #00ff00 !important;
  cursor: pointer;
}

/* ===== PASTILLE DÉPARTEMENT EN PRODUCTION - CLIGNOTANTE VERTE ===== */
.dept-pill-in-production {
  animation: blink-dept-green 1s infinite !important;
  border: 1px solid #00ff00 !important;
}

@keyframes blink-dept-green {
  0%, 100% {
    background: linear-gradient(to bottom, #0b5f2a, #063618);
    border-color: rgba(0, 255, 0, 0.5);
    box-shadow: 0 0 4px rgba(0, 255, 0, 0.3);
  }
  50% {
    background: linear-gradient(to bottom, #0d7a35, #085020);
    border-color: rgba(0, 255, 0, 1);
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
  }
}

/* ===== PASTILLE DÉPARTEMENT EN ATTENTE - CLIGNOTANTE ROUGE SYNCHRONISÉE ===== */
.dept-pill-en-attente {
  background: linear-gradient(to bottom, #cc0000, #7a0000) !important;
  color: #ffffff !important;
  animation: blink-red-sync 1.5s ease-in-out infinite !important;
  animation-delay: 0s !important;
}

/* ===== CARTES EN PRODUCTION - BORDURE VERTE CLIGNOTANTE ===== */
/* Quand un employé est sélectionné et en production */
.mcard.in-production {
  animation: blink-border-green 1s infinite;
}

@keyframes blink-border-green {
  0%, 100% {
    border: 1px solid rgba(0, 255, 0, 0.5);
    box-shadow: 0 2px 4px rgba(0,0,0,0.7), 0 0 6px rgba(0, 255, 0, 0.3);
  }
  50% {
    border: 1px solid rgba(0, 255, 0, 1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.7), 0 0 12px rgba(0, 255, 0, 0.6);
  }
}

/* ===== ANIMATION CLIGNOTEMENT ROUGE (EN ATTENTE) ===== */
@keyframes blink-red {
  0%, 100% { background:linear-gradient(to bottom,#b30000,#6a0000); box-shadow:0 0 4px rgba(255,0,0,0.3); }
  50% { background:linear-gradient(to bottom,#dd3333,#990000); box-shadow:0 0 8px rgba(255,0,0,0.5); }
}

/* ===== ANIMATION SYNCHRONISÉE POUR TOUS LES ÉLÉMENTS ROUGES ===== */
@keyframes blink-red-sync {
  0%, 100% { 
    background: linear-gradient(to bottom, #cc0000, #7a0000);
    box-shadow: 0 1px 2px rgba(0,0,0,0.5), 0 0 3px rgba(255,0,0,0.3);
  }
  50% { 
    background: linear-gradient(to bottom, #ff3333, #aa0000);
    box-shadow: 0 1px 2px rgba(0,0,0,0.5), 0 0 8px rgba(255,0,0,0.6);
  }
}

/* Pastille "En attente de réponse..." - rouge clignotant quand activée */
.mcard-attente-reason.attente-active {
  background: linear-gradient(to bottom, #cc0000, #7a0000);
  color: #ffffff;
  animation: blink-red-sync 1.5s ease-in-out infinite;
  animation-delay: 0s !important;
}

/* Pastille représentante - rouge clignotant quand en attente actif */
.mcard-menu.representant-alert {
  background: linear-gradient(to bottom, #cc0000, #7a0000) !important;
  color: #ffffff !important;
  animation: blink-red-sync 1.5s ease-in-out infinite;
  animation-delay: 0s !important;
}

/* Pastille département (Atelier, Robot, Couture) - clignotement synchronisé */
.mcard-pill.dept-trackable.dept-blink-alert {
  animation: blink-red-sync 1.5s ease-in-out infinite !important;
  animation-delay: 0s !important;
}

/* ===== CARTES EN COLONNE "EN ATTENTE" - ALERTE VISUELLE ===== */
/* La classe in-attente-column marque la carte dans la colonne En attente */
/* La classe attente-alert-active déclenche le clignotement rouge */
.mcard.in-attente-column {
  /* Pas de clignotement par défaut */
}

/* Clignotement SEULEMENT quand attente-alert-active est présent */
.mcard.in-attente-column.attente-alert-active {
  animation: blink-border-red 2s ease-in-out infinite;
  animation-delay: 0s !important;
}

@keyframes blink-border-red {
  0%, 100% {
    border: 1px solid rgba(180, 50, 50, 0.3);
    box-shadow: 0 2px 4px rgba(0,0,0,0.7);
  }
  50% {
    border: 1px solid rgba(200, 50, 50, 0.6);
    box-shadow: 0 2px 4px rgba(0,0,0,0.7), 0 0 4px rgba(255, 0, 0, 0.2);
  }
}

/* ===== INDICATEUR FIREBASE (ancien - masqué) ===== */
.firebase-status{
  display:none !important;
}
.firebase-status.connected{
  background:linear-gradient(to bottom,#0b5f2a,#063618);
  color:#fff;
  border:1px solid #00ff00;
}
.firebase-status.disconnected{
  background:linear-gradient(to bottom,#cc0000,#7a0000);
  color:#fff;
  border:1px solid #ff0000;
}
.firebase-status.connecting{
  background:linear-gradient(to bottom,#d4a100,#8b6f00);
  color:#fff;
  border:1px solid #ffcc00;
}
.firebase-dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#00ff00;
}
.firebase-status.disconnected .firebase-dot{
  background:#ff0000;
}
.firebase-status.connecting .firebase-dot{
  background:#ffcc00;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%, 100% { opacity:1; }
  50% { opacity:0.3; }
}

/* ===== MENU LIENS PHOTO ===== */
.photo-links-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:15000;
}
.photo-links-overlay.hidden{
  display:none;
}
.photo-links-panel{
  background:linear-gradient(to bottom,#0a1929,#0d2847);
  border-radius:16px;
  border:1px solid rgba(100,180,255,0.3);
  box-shadow:0 12px 40px rgba(0,0,0,0.9);
  padding:16px;
  width:680px;
  max-width:95vw;
  max-height:90vh;
  overflow-y:auto;
  color:#ffffff;
}
.photo-links-title{
  font-size:18px;
  font-weight:700;
  text-align:center;
  margin-bottom:16px;
  padding-bottom:12px;
  border-bottom:2px solid rgba(100,180,255,0.3);
  color:#fff;
  text-shadow:0 2px 4px rgba(0,0,0,0.5);
}
.photo-links-grid{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:12px;
  margin-bottom:16px;
}
.photo-link-section{
  background:linear-gradient(to bottom,rgba(20,50,90,0.6),rgba(10,30,60,0.6));
  border-radius:12px;
  border:1px solid rgba(100,180,255,0.2);
  padding:12px;
  display:flex;
  flex-direction:column;
}
.photo-link-label{
  font-size:13px;
  font-weight:700;
  margin-bottom:10px;
  color:#64b5f6;
  text-align:center;
  padding-bottom:6px;
  border-bottom:1px solid rgba(100,180,255,0.2);
}
.photo-link-list{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
  flex:1;
}
.photo-link-row{
  display:flex;
  align-items:center;
  gap:4px;
}
.photo-link-row .photo-link-input{
  flex:1;
  min-width:0;
}
.photo-link-input{
  padding:6px 8px;
  border-radius:6px;
  border:1px solid rgba(100,180,255,0.3);
  background:rgba(0,0,0,0.4);
  color:#fff;
  font-size:11px;
  width:100%;
  box-sizing:border-box;
}
.photo-link-input::placeholder{
  color:rgba(150,180,220,0.5);
  font-size:10px;
}
.photo-link-input:focus{
  outline:none;
  border-color:#00aaff;
  box-shadow:0 0 0 2px rgba(0,170,255,0.2);
}
.photo-link-row-delete{
  padding:4px 6px;
  border-radius:4px;
  border:none;
  background:linear-gradient(to bottom,#7a0000,#4a0000);
  color:#fff;
  font-size:10px;
  cursor:pointer;
  flex-shrink:0;
}
.photo-link-row-delete:hover{
  background:linear-gradient(to bottom,#990000,#5a0000);
}
.photo-link-section-actions{
  display:flex;
  gap:6px;
  margin-top:auto;
  padding-top:8px;
}
.photo-link-btn{
  flex:1;
  padding:6px 8px;
  border-radius:6px;
  border:none;
  font-weight:600;
  font-size:10px;
  cursor:pointer;
  text-align:center;
}
.photo-link-add-btn{
  background:linear-gradient(to bottom,#444,#333);
  color:#fff;
}
.photo-link-add-btn:hover{
  background:linear-gradient(to bottom,#555,#444);
}
.photo-link-btn-save-section{
  background:linear-gradient(to bottom,#0b5f2a,#063618);
  color:#fff;
}
.photo-link-btn-save-section:hover{
  background:linear-gradient(to bottom,#0d7a35,#085020);
}
.photo-links-close{
  width:100%;
  padding:12px;
  background:linear-gradient(to bottom,#3f6eb8,#1d3560);
  border:none;
  border-radius:999px;
  color:#ffffff;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
}
.photo-links-close:hover{
  background:linear-gradient(to bottom,#4a7fc9,#234171);
  transform:translateY(-1px);
}

/* Indicateur visuel sur les pastilles photo */
.mcard-photo-pill.has-photos{
  background:linear-gradient(to bottom,#0b5f2a,#063618) !important;
  box-shadow:0 0 0 1px #00ff00;
}

/* ===== VIEWER PHOTO MODERNE STYLE NETFLIX ===== */
.photo-viewer-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.92);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20050;
}
.photo-viewer-overlay.hidden{
  display:none;
}
.photo-viewer-backdrop{
  position:absolute;
  inset:0;
}
.photo-viewer-panel{
  position:relative;
  background:linear-gradient(to bottom,#0a1525,#05101a);
  border-radius:20px;
  border:1px solid rgba(100,180,255,0.2);
  box-shadow:0 12px 50px rgba(0,0,0,0.95);
  padding:20px;
  max-width:92vw;
  max-height:92vh;
  display:flex;
  flex-direction:column;
  box-sizing:border-box;
}
.photo-viewer-close{
  position:absolute;
  top:10px;
  right:14px;
  width:36px;
  height:36px;
  border-radius:50%;
  border:none;
  background:rgba(255,255,255,0.1);
  color:#fff;
  font-size:22px;
  cursor:pointer;
  transition:all 0.2s;
  z-index:10;
}
.photo-viewer-close:hover{
  background:rgba(255,100,100,0.4);
  transform:scale(1.1);
}
.photo-viewer-main{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin:16px 0;
  flex:1;
}
.photo-viewer-image{
  max-width:75vw;
  max-height:65vh;
  border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,0.9);
  object-fit:contain;
  background:#000;
}
.photo-viewer-nav{
  border:none;
  width:50px;
  height:80px;
  border-radius:12px;
  cursor:pointer;
  background:rgba(255,255,255,0.08);
  color:#fff;
  font-size:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.2s;
}
.photo-viewer-nav:hover{
  background:rgba(100,180,255,0.3);
  transform:scale(1.05);
}
.photo-viewer-thumbs{
  margin-top:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  overflow-x:auto;
  padding:6px 2px;
}
.photo-viewer-thumb{
  flex:0 0 auto;
  width:80px;
  height:56px;
  border-radius:10px;
  overflow:hidden;
  border:3px solid transparent;
  cursor:pointer;
  box-shadow:0 3px 10px rgba(0,0,0,0.7);
  transition:all 0.2s;
}
.photo-viewer-thumb:hover{
  transform:scale(1.08);
  border-color:rgba(100,180,255,0.5);
}
.photo-viewer-thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.photo-viewer-thumb.active{
  border-color:#00aaff;
  box-shadow:0 0 0 3px rgba(0,170,255,0.5);
  transform:scale(1.05);
}
.photo-viewer-counter{
  text-align:center;
  font-size:14px;
  color:rgba(255,255,255,0.7);
  margin-top:8px;
}
.photo-viewer-open-btn{
  display:block;
  margin:12px auto 0;
  padding:10px 20px;
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  color:#ffffff;
  border:none;
  border-radius:25px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 3px 10px rgba(0,0,0,0.5);
  transition:all 0.2s;
}
.photo-viewer-open-btn:hover{
  background:linear-gradient(to bottom,#00bbff,#0088dd);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(0,0,0,0.6);
}
.photo-viewer-image{
  cursor:pointer;
}
/* ===== ÉCRAN DE CONNEXION ===== */
.login-overlay{
  position:fixed;
  inset:0;
  background:linear-gradient(to bottom,#0b1d36,#3f6eb8);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:25000;
}
.login-overlay.hidden{
  display:none;
}
.login-panel{
  background:linear-gradient(to bottom,#0b2343,#06315a);
  border-radius:18px;
  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 8px 30px rgba(0,0,0,0.85);
  padding:40px;
  max-width:400px;
  width:90%;
  color:#fff;
  text-align:center;
}
.login-logo{
  height:80px;
  margin-bottom:20px;
}
.login-title{
  font-size:24px;
  font-weight:700;
  margin-bottom:10px;
}
.login-subtitle{
  font-size:14px;
  opacity:0.8;
  margin-bottom:30px;
}
.login-input{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(0,0,0,0.3);
  color:#fff;
  font-size:11px;
  text-align:center;
  margin-bottom:20px;
  box-sizing:border-box;
  letter-spacing:3px;
}
.login-input::placeholder{
  color:rgba(255,255,255,0.5);
  letter-spacing:normal;
}
.login-input:focus{
  outline:none;
  border-color:#00aaff;
  box-shadow:0 0 10px rgba(0,170,255,0.3);
}
.login-btn{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  color:#fff;
  font-weight:700;
  font-size:11px;
  cursor:pointer;
  margin-bottom:15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
}
.login-btn:hover{
  background:linear-gradient(to bottom,#00bbff,#0088dd);
  transform:translateY(-1px);
}
.login-error{
  color:#ff6666;
  font-size:12px;
  margin-top:10px;
  min-height:20px;
}
/* ===== BADGE UTILISATEUR TRANSPARENT (texte seulement) ===== */
.user-badge-pill{
  padding:0;
  background:transparent;
  border:none;
  color:rgba(255,255,255,0.85);
  display:flex;
  align-items:center;
  gap:8px;
  font-size:11px;
  position:relative;
  z-index:100;
}
.user-badge-name{
  font-weight:600;
}
.user-badge-dot{
  width:6px;
  height:6px;
  border-radius:50%;
  background:#00ff00;
  flex-shrink:0;
}
.user-badge-dot.disconnected{
  background:#ff4444;
}
.user-badge-dot.connecting{
  background:#ffcc00;
  animation:pulse 1s infinite;
}
.user-badge-status-text{
  opacity:0.7;
  font-size:10px;
}
.user-badge-logout{
  background:rgba(255,80,80,0.25);
  border:1px solid rgba(255,100,100,0.5);
  color:rgba(255,255,255,0.9);
  padding:4px 12px;
  border-radius:999px;
  font-size:10px;
  cursor:pointer;
  font-weight:600;
  margin-left:4px;
  transition:all 0.15s ease;
  pointer-events:auto;
  position:relative;
  z-index:101;
}
.user-badge-logout:hover{
  background:rgba(255,60,60,0.5);
  border-color:rgba(255,100,100,0.8);
  color:#fff;
  transform:translateY(-1px);
  box-shadow:0 2px 4px rgba(0,0,0,0.4);
}
.login-user-role{
  display:none;
}
/* Mode lecture seule - désactiver les interactions */
.readonly-mode .mcard-btn-delete,
.readonly-mode .mcard-btn-move,
.readonly-mode #addCardBtn{
  display:none !important;
}
.readonly-mode .mcard-menu,
.readonly-mode .mcard-pill-date,
.readonly-mode .mcard-title,
.readonly-mode .mcard-order,
.readonly-mode .mcard-employee-label,
.readonly-mode .mcard-expedition-btn{
  pointer-events:none !important;
  cursor:default !important;
}
.readonly-mode .mcard-title:hover,
.readonly-mode .mcard-order:hover{
  text-decoration:none !important;
}
/* Notes cliquables en mode lecture seule pour voir le contenu */
.readonly-mode .mcard-notes-input{
  cursor:pointer !important;
  pointer-events:auto !important;
}
.readonly-mode .mcard-notes-input:hover{
  background:rgba(0,170,255,0.15) !important;
  border-color:#00aaff !important;
}

/* ===== POPUP NOTES LECTURE SEULE ===== */
.notes-readonly-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20000;
}
.notes-readonly-overlay.hidden{
  display:none;
}
.notes-readonly-panel{
  background:linear-gradient(to bottom,#0b2343,#06315a);
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.3);
  box-shadow:0 8px 24px rgba(0,0,0,0.9);
  padding:8px;
  min-width:320px;
  max-width:500px;
  width:90%;
  max-height:80vh;
  color:#ffffff;
}
.notes-readonly-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
  padding-bottom:10px;
  border-bottom:2px solid rgba(255,255,255,0.2);
}
.notes-readonly-title{
  font-size:18px;
  font-weight:700;
}
.notes-readonly-card-name{
  font-size:12px;
  opacity:0.7;
  margin-top:4px;
}
.notes-readonly-close{
  background:rgba(255,255,255,0.2);
  border:none;
  color:#fff;
  width:32px;
  height:32px;
  border-radius:50%;
  font-size:18px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.notes-readonly-close:hover{
  background:rgba(255,255,255,0.3);
}
.notes-readonly-content{
  background:rgba(0,0,0,0.3);
  border-radius:10px;
  padding:15px;
  min-height:100px;
  max-height:50vh;
  overflow-y:auto;
  font-size:14px;
  line-height:1.6;
  white-space:pre-wrap;
  word-wrap:break-word;
}
.notes-readonly-empty{
  color:rgba(255,255,255,0.5);
  font-style:italic;
  text-align:center;
  padding:8px;
}

/* ===== NOTIFICATION REPRÉSENTANTES (MARIE-PIER / MARIE-SOLEIL) ===== */
.representante-notification-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 30000;
}
.representante-notification-overlay.hidden {
  display: none;
}
.representante-notification-panel {
  background: linear-gradient(to bottom, #1a3a5c, #0d2340);
  border-radius: 12px;
  border: 1px solid rgba(100,180,255,0.4);
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  padding: 20px 30px;
  max-width: 400px;
  width: 90%;
  color: #fff;
  text-align: center;
}
.representante-notification-icon {
  font-size: 28px;
  margin-bottom: 10px;
}
.representante-notification-message {
  font-size: 13px;
  line-height: 1.5;
  margin-bottom: 15px;
  color: rgba(255,255,255,0.9);
}
.representante-notification-close {
  padding: 8px 20px;
  border-radius: 6px;
  border: none;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: #fff;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
}
.representante-notification-close:hover {
  background: linear-gradient(to bottom, #4a7fc9, #234171);
}

/* ===== ÉCRAN DE CONFIGURATION FIREBASE ===== */
.firebase-setup-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20000;
}
.firebase-setup-overlay.hidden{
  display:none;
}
.firebase-setup-panel{
  background:linear-gradient(to bottom,#0b2343,#06315a);
  border-radius:18px;
  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 8px 20px rgba(0,0,0,0.85);
  padding:30px;
  max-width:600px;
  width:90%;
  color:#fff;
}
.firebase-setup-title{
  font-size:24px;
  font-weight:700;
  text-align:center;
  margin-bottom:20px;
}
.firebase-setup-subtitle{
  font-size:14px;
  text-align:center;
  margin-bottom:30px;
  opacity:0.8;
}
.firebase-setup-input{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(0,0,0,0.3);
  color:#fff;
  font-size:12px;
  font-family:monospace;
  margin-bottom:20px;
  box-sizing:border-box;
}
.firebase-setup-input::placeholder{
  color:rgba(255,255,255,0.5);
}
.firebase-setup-btn{
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  color:#fff;
  font-weight:700;
  font-size:14px;
  cursor:pointer;
  margin-bottom:15px;
}
.firebase-setup-btn:hover{
  background:linear-gradient(to bottom,#00bbff,#0088dd);
}
.firebase-setup-help{
  font-size:11px;
  opacity:0.7;
  text-align:center;
}

/* ===== ZONE DE NOTES PAR-DESSUS CARTE ===== */
.notes-card-overlay {
  position: fixed;
  /* Position sera définie dynamiquement par JavaScript */
  width: 340px; /* Environ 2 cartes de large */
  height: 200px; /* Hauteur similaire aux cartes */
  background: linear-gradient(to bottom,#0b2343,#06315a);
  border-radius: 10px;
  border: 2px solid #00aaff;
  box-shadow: 0 4px 30px rgba(0,170,255,0.5), 0 0 60px rgba(0,0,0,0.8);
  z-index: 15000;
  display: flex;
  flex-direction: column;
  padding: 6px;
  box-sizing: border-box;
}
.notes-card-overlay.hidden {
  display: none;
}
.notes-card-overlay-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 14999;
}
.notes-card-overlay-backdrop.hidden {
  display: none;
}
.notes-card-header {
  display: flex;
  align-items: center;
  gap: 5px;
  padding-bottom: 4px;
  margin-bottom: 4px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
  height: 18px;
  min-height: 18px;
}
.notes-card-title {
  font-size: 11px;
  line-height: 1;
}
.notes-card-card-info {
  flex: 1;
  font-size: 10px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1;
}
.notes-card-link-btn {
  padding: 1px 6px;
  border-radius: 3px;
  border: 1px solid rgba(255,255,255,0.3);
  background: linear-gradient(to bottom,#3f6eb8,#1d3560);
  color: #fff;
  font-size: 9px;
  cursor: pointer;
  line-height: 1;
  height: 16px;
}
.notes-card-link-btn:hover {
  background: linear-gradient(to bottom,#4a7fc9,#234171);
}
.notes-card-photo-btn {
  padding: 1px 6px;
  border-radius: 3px;
  border: 1px solid rgba(255,255,255,0.3);
  background: linear-gradient(to bottom,#8B4513,#5D2E0C);
  color: #fff;
  font-size: 9px;
  cursor: pointer;
  line-height: 1;
  height: 16px;
  display: none; /* Caché par défaut */
}
.notes-card-photo-btn.has-link {
  display: inline-block;
  animation: blink-yellow-photo 1.5s ease-in-out infinite;
  border: 2px solid #ffff00;
}
.notes-card-close {
  background: rgba(255,255,255,0.1);
  border: none;
  color: #fff;
  font-size: 11px;
  cursor: pointer;
  padding: 1px 5px;
  border-radius: 3px;
  line-height: 1;
  height: 16px;
}
.notes-card-close:hover {
  background: rgba(255,100,100,0.3);
  color: #ff6666;
}
@keyframes blink-yellow-photo {
  0%, 100% {
    border-color: rgba(255, 255, 0, 0.5);
    box-shadow: 0 0 4px rgba(255, 255, 0, 0.3);
  }
  50% {
    border-color: rgba(255, 255, 0, 1);
    box-shadow: 0 0 10px rgba(255, 255, 0, 0.6);
  }
}

/* ===== POPUP LIEN DANS NOTES ===== */
.notes-link-popup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(to bottom,#1a3a5c,#0d2340);
  border-radius: 10px;
  border: 2px solid #00aaff;
  padding: 15px;
  z-index: 15010;
  min-width: 300px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.8);
}
.notes-link-popup.hidden {
  display: none;
}
.notes-link-popup-title {
  font-size: 13px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 10px;
  text-align: center;
}
.notes-link-popup-input {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 12px;
  margin-bottom: 12px;
  box-sizing: border-box;
}
.notes-link-popup-input:focus {
  outline: none;
  border-color: #00aaff;
}
.notes-link-popup-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}
.notes-link-popup-btn {
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  font-weight: 600;
  font-size: 11px;
  cursor: pointer;
}
.notes-link-popup-save {
  background: linear-gradient(to bottom,#0b5f2a,#063618);
  color: #fff;
}
.notes-link-popup-save:hover {
  background: linear-gradient(to bottom,#0d7a35,#085020);
}
.notes-link-popup-close {
  background: linear-gradient(to bottom,#666,#444);
  color: #fff;
}
.notes-link-popup-close:hover {
  background: linear-gradient(to bottom,#777,#555);
}
.notes-card-textarea {
  flex: 1;
  width: 100%;
  min-height: 80px;
  max-height: 200px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 11px;
  font-family: inherit;
  resize: none;
  box-sizing: border-box;
  overflow-y: auto;
  line-height: 1.4;
}
.notes-card-textarea:focus {
  outline: none;
  border-color: #00aaff;
}
/* Style du scrollbar pour le textarea */
.notes-card-textarea::-webkit-scrollbar {
  width: 6px;
}
.notes-card-textarea::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
  border-radius: 3px;
}
.notes-card-textarea::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
}
.notes-card-textarea::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.5);
}
.notes-card-save {
  margin-top: 6px;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  background: linear-gradient(to bottom,#00aaff,#0077cc);
  color: #fff;
  font-weight: 700;
  font-size: 9px;
  cursor: pointer;
}

/* Masquer l'ancien overlay global */
.notes-overlay {
  display: none !important;
}

/* Zone de notes sur la carte - aperçu limité */
.mcard-notes-input {
  max-height: 52px;
  overflow: hidden;
  cursor: pointer;
  resize: none;
  font-size: 11px;
  font-weight: 400;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
  color: #000;
  letter-spacing: 0.3px;
  padding: 4px 5px 5px 5px;
  box-sizing: border-box;
}

/* ===== MENU DÉLAI PAR RÉGION ===== */
.delay-config-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 12000;
}
.delay-config-overlay.hidden {
  display: none;
}
.delay-config-panel {
  background: linear-gradient(to bottom,#0b2343,#06315a);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.3);
  box-shadow: 0 8px 24px rgba(0,0,0,0.9);
  padding: 20px;
  width: 90%;
  max-width: 350px;
  color: #fff;
}
.delay-config-title {
  font-size: 16px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 16px;
}
.delay-config-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.delay-config-region {
  font-weight: 600;
  font-size: 14px;
}
.delay-config-input {
  width: 70px;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 14px;
  text-align: center;
}
.delay-config-unit {
  font-size: 12px;
  opacity: 0.7;
  margin-left: 6px;
}
.delay-config-save {
  margin-top: 16px;
  width: 100%;
  padding: 10px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom,#00aaff,#0077cc);
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
}

/* Pastille délai plus haute */
.mcard-delay-pill {
  min-height: 14px;
  padding: 1px 4px;
  cursor: pointer;
  font-size: 11px;
}

/* ===== PASTILLE SWITCH DÉLAI/ATTENTE ===== */
/* Dans colonne En attente : fond rouge par défaut */
.mcard.in-attente-column .mcard-delay-pill {
  background: linear-gradient(to bottom, #cc0000, #990000) !important;
  cursor: pointer;
}

/* Mode alternatif (délai) dans colonne En attente */
.mcard.in-attente-column .mcard-delay-pill.show-delay-mode {
  background: linear-gradient(to bottom, #0b5f2a, #063618) !important;
}

/* Le nombre de jours en évidence dans la colonne En attente */
.mcard.in-attente-column .mcard-delay-pill .jours-nombre {
  font-weight: 900;
  color: #FFFF00;
}

/* Clignotement de la pastille quand alerte active en attente */
.mcard.in-attente-column .mcard-delay-pill.attente-active:not(.show-delay-mode) {
  animation: blink-red 1.5s infinite;
  border: 1px solid #ff0000 !important;
}

/* Indicateur visuel de switch (petit triangle) */
.mcard.in-attente-column .mcard-delay-pill::after {
  content: "⇄";
  margin-left: 6px;
  font-size: 9px;
  opacity: 0.7;
}

/* Réduire l'espace entre les pastilles délai/attente et le body */
.mcard.in-attente-column .mcard-body {
  padding-top: 1px;
}

/* ===== DELETE CONFIRMATION DIALOG ===== */
.delete-confirm-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:16000;
}
.delete-confirm-overlay.hidden{
  display:none;
}
.delete-confirm-panel{
  background:linear-gradient(to bottom,#1a2a3a,#0d1a2a);
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.15);
  box-shadow:0 4px 16px rgba(0,0,0,0.5);
  padding:14px 20px;
  min-width:220px;
  max-width:280px;
  color:#ffffff;
  text-align:center;
}
.delete-confirm-icon{
  display:none;
}
.delete-confirm-title{
  font-size:12px;
  font-weight:600;
  margin-bottom:4px;
  color:#ffffff;
}
.delete-confirm-message{
  font-size:10px;
  margin-bottom:12px;
  color:rgba(255,255,255,0.6);
}
.delete-confirm-buttons{
  display:flex;
  gap:8px;
  justify-content:center;
}
.delete-confirm-btn{
  padding:5px 14px;
  border-radius:999px;
  border:none;
  font-weight:600;
  font-size:9px;
  cursor:pointer;
  box-shadow:0 1px 3px rgba(0,0,0,0.3);
  transition:all 0.2s;
}
.delete-confirm-btn-yes{
  background:linear-gradient(to bottom,#6b5555,#4a3838);
  color:#ffffff;
}
.delete-confirm-btn-yes:hover{
  background:linear-gradient(to bottom,#7a6060,#5a4545);
}
.delete-confirm-btn-no{
  background:linear-gradient(to bottom,#4a6080,#2d4055);
  color:#ffffff;
}
.delete-confirm-btn-no:hover{
  background:linear-gradient(to bottom,#5a7090,#3d5065);
}


    
/* ---- Thèmes par région ---- */
.mcard.region-qc{
  background:#325f9b;
}

.mcard.region-qc .mcard-menu[data-menu-field="region"]{
  background:linear-gradient(to bottom,#1a3d6b,#123a7f);
  color:#ffffff;
}

.mcard.region-on{
  background:#8b5a1c;
}

.mcard.region-on .mcard-menu[data-menu-field="region"]{
  background:linear-gradient(to bottom,#704414,#E8B97A);
  color:#ffffff;
  border:1px solid #3b220a;
}

.mcard.region-ma{
  background:#4f357f;
}

.mcard.region-ma .mcard-menu[data-menu-field="region"]{
  background:linear-gradient(to bottom,#4a2594,#240b57);
  color:#f7f1ff;
  border:1px solid #14052f;
}



.mcard.region-qc .mcard-pill:not(.mcard-pill-date):not(.mcard-btn-move):not(.mcard-btn-delete),
.mcard.region-qc .mcard-employee-label,
.mcard.region-qc .mcard-menu:not([data-menu-field="region"]){
  background:linear-gradient(to bottom,#4a7fc2,#2d5a8f);
  border:1px solid #173a5e;
}


.mcard.region-on .mcard-pill:not(.mcard-pill-date):not(.mcard-btn-move):not(.mcard-btn-delete),
.mcard.region-on .mcard-employee-label,
.mcard.region-on .mcard-menu:not([data-menu-field="region"]){
  background:linear-gradient(to bottom,#b8803f,#8b5a1c);
  border:1px solid #5a3a12;
}


.mcard.region-ma .mcard-pill:not(.mcard-pill-date):not(.mcard-btn-move):not(.mcard-btn-delete),
.mcard.region-ma .mcard-employee-label,
.mcard.region-ma .mcard-menu:not([data-menu-field="region"]){
  background:linear-gradient(to bottom,#7a52b3,#4f357f);
  border:1px solid #2e1f4b;
}


/* Footer */

.mcard-pill-date.has-date{
  font-style:normal;
}
.mcard-pill-date i{
  font-style:italic;
}
.mcard-menu{
  cursor:pointer;
}
.mcard-menu:hover{
  box-shadow:0 0 0 1px rgba(255,255,255,0.7);
}
/* Style hover pour Lien photo */
.mcard-pill.photo-link-pill{
  cursor:pointer;
}
.mcard-pill.photo-link-pill:hover{
  box-shadow:0 0 0 1px rgba(255,255,255,0.7);
}
/* Overlay menu */
.vp-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20000;
}
.vp-overlay.hidden{
  display:none;
}
.vp-panel{ 
  width:320px; 
  background:linear-gradient(to bottom,#0b2343,#06315a); 
  border-radius:12px; 
  border:1px solid rgba(255,255,255,0.2); 
  box-shadow:0 4px 12px rgba(0,0,0,0.6); 
  padding:14px 16px; 
  box-sizing:border-box; 
  color:#ffffff; 
  font-size:15px; 
}
.vp-panel-title{
  font-size:18px;
  font-weight:700;
  text-align:center;
  margin-bottom:6px;
}
.vp-panel-hint{
  font-size:12px;
  text-align:center;
  opacity:0.6;
  margin-bottom:8px;
}
.vp-list{
  max-height:240px;
  overflow-y:auto;
  margin-bottom:8px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.vp-item{ padding:10px 14px; border-radius:6px; border:1px solid rgba(255,255,255,0.15); background:linear-gradient(to bottom,#233d63,#12243f); text-align:center; cursor:pointer; user-select:none; font-size:15px; transition:all 0.15s ease; }
.vp-item:hover{
  background:linear-gradient(to bottom,#2d4a73,#1a3050);
  border-color:rgba(255,255,255,0.3);
}
.vp-item.selected{
  border-color:#00aaff;
  box-shadow:0 0 0 2px rgba(0,170,255,0.4);
  background:linear-gradient(to bottom,#1a4a7a,#0d3055);
}
.vp-input-row{
  margin:8px 0 10px;
}
.vp-input{ width:100%; box-sizing:border-box; padding:10px 14px; border-radius:6px; border:1px solid rgba(255,255,255,0.35); background:rgba(5,20,40,0.9); color:#ffffff; font-size:14px; outline:none; }
.vp-input::placeholder{
  color:rgba(200,210,230,0.65);
}
.vp-buttons{
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:8px;
}
.vp-btn{ flex:1; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.5); background:transparent; cursor:pointer; font-weight:600; font-size:12px; color:#ffffff; box-shadow:0 2px 4px rgba(0,0,0,0.7); transition:all 0.15s ease; white-space:nowrap; }
.vp-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 3px 6px rgba(0,0,0,0.8);
}
.vp-btn-primary{
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  border-color:transparent;
}
.vp-btn-primary:hover{
  background:linear-gradient(to bottom,#00bbff,#0088dd);
}
.vp-btn-danger{
  background:linear-gradient(to bottom,#dc3545,#a71d2a);
  border-color:transparent;
}
.vp-btn-danger:hover{
  background:linear-gradient(to bottom,#e4606d,#dc3545);
}
    .mcard-footer{
      padding:2px 5px 4px;
      border-top:1px solid rgba(0,0,0,0.45);
      background:rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
      gap:0;
      box-sizing:border-box;
    }
    
.mcard-notes-label{
  background:linear-gradient(to bottom,#b3b3b3,#666666);
  border-radius:10px 10px 0 0;
  border:1px solid rgba(0,0,0,0.3);
  border-bottom:none;
  font-weight:700;
  text-align:center;
  padding:0 6px;
  font-size:6px;
  height:11px;
  line-height:11px;
  color:#ffffff;
  box-shadow:0 1px 2px rgba(0,0,0,0.5);
  cursor:pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== PASTILLE NOTES AVEC CONTENU - CLIGNOTEMENT SUBTIL ===== */
.mcard-notes-label.has-notes {
  animation: blink-notes-subtle 2.5s ease-in-out infinite;
}

@keyframes blink-notes-subtle {
  0%, 100% {
    opacity: 1;
    box-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  50% {
    opacity: 0.7;
    box-shadow: 0 1px 2px rgba(0,0,0,0.5), 0 0 6px rgba(255,255,255,0.4);
  }
}

/* Pastille Notes selon la région - Québec (bleu) */
.mcard.region-qc .mcard-notes-label {
  background: linear-gradient(to bottom, #4a7fc2, #2d5a8f);
  border-color: rgba(255,255,255,0.25);
}
/* Pastille Notes selon la région - Ontario (orange) */
.mcard.region-on .mcard-notes-label {
  background: linear-gradient(to bottom, #b8803f, #8b5a1c);
  border-color: rgba(255,255,255,0.25);
}
/* Pastille Notes selon la région - Maritimes (mauve) */
.mcard.region-ma .mcard-notes-label {
  background: linear-gradient(to bottom, #7a52b3, #4f357f);
  border-color: rgba(255,255,255,0.25);
}

    .mcard-employee-label{
      background:linear-gradient(to bottom,#b3b3b3,#666666);
      border-radius:10px;
      border:1px solid #000000;
      font-weight:700;
      text-align:center;
      padding:0 6px;
      font-size:7px;
      height:11px;
      line-height:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
    }
    
    /* Special status pills */
    .mcard-expedition-btn{
      cursor:pointer;
      transition:background 0.3s;
    }
    .mcard-expedition-btn:hover{
      box-shadow:0 0 0 1px rgba(255,255,255,0.7);
    }
    .mcard-expedition-btn.expedited{
      background:linear-gradient(to bottom,#0b5f2a,#063618);
      cursor:default;
    }
    
    .mcard-attente-reason{
      background:linear-gradient(to bottom,#b3b3b3,#666666);
      color:#000000;
      cursor:pointer;
      box-sizing:border-box;
    }
    .mcard-attente-reason:hover{
      box-shadow:0 0 0 1px rgba(255,255,255,0.7);
    }
    /* Quand une raison d'attente est sélectionnée - rouge avec clignotement */
    .mcard-attente-reason.attente-active {
      background: linear-gradient(to bottom, #cc0000, #7a0000);
      color: #ffffff;
      animation: blink-red-sync 1.5s ease-in-out infinite;
      animation-delay: 0s !important;
    }
    .mcard-notes-input{
      width:100%;
      min-height:28px;
      max-height:28px;
      resize:none;
      border-radius:0 0 8px 8px;
      border:1px solid #000000;
      border-top:none;
      padding:4px 5px 5px 5px;
      font-size:9px;
      line-height:1.5;
      box-sizing:border-box;
      background:#f4f4f4;
      color:#000;
    }
    .mcard-footer-buttons{
      display:flex;
      gap:4px;
    }
    .mcard-btn{
      flex:1;
      border-radius:20px;
      border:1px solid #000000;
      padding:1px 4px;
      font-size:7px;
      font-weight:600;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.3);
    }
    .mcard-btn-move{
      background:linear-gradient(to bottom,#2269b3,#003a80);
      color:#ffffff;
    }
    .mcard-btn-delete{
      background:linear-gradient(to bottom,#cc0000,#7a0000);
      color:#ffffff;
    }
  
    /* --- Date wrapper styling --- */
    .date-wrapper{
      position:relative;
      display:block;
      width:100%;
    }
    .date-input{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      border:none;
      cursor:pointer;
      background:transparent;
      pointer-events:none;
    }
    
/* ===== MOVE MENU OVERLAY ===== */
.move-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
.move-overlay.hidden{
  display:none;
}
.move-panel{
  background:linear-gradient(to bottom,#0b2343,#06315a);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 8px 20px rgba(0,0,0,0.85);
  padding:12px;
  max-width:85%;
  width:720px;
  box-sizing:border-box;
}
.move-columns{
  display:grid;
  grid-template-columns:repeat(8, 1fr);
  gap:6px;
  margin-bottom:12px;
}
.move-column{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.move-column-header{
  background:linear-gradient(to bottom,#2b5b99,#103561);
  border-radius:8px;
  padding:5px 4px;
  text-align:center;
  font-weight:700;
  font-size:8px;
  color:#ffffff;
  border:1px solid rgba(0,0,0,0.8);
  box-shadow:0 2px 3px rgba(0,0,0,0.8);
}
.move-column-header.selected{
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  box-shadow:0 0 0 2px #00aaff;
}
.move-positions{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.move-position-btn{
  background:linear-gradient(to bottom,#233d63,#12243f);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:6px;
  padding:4px;
  text-align:center;
  font-weight:600;
  font-size:9px;
  color:#ffffff;
  cursor:pointer;
  transition:all 0.2s;
}
.move-position-btn:hover{
  background:linear-gradient(to bottom,#2a4570,#1a2d50);
  box-shadow:0 0 0 1px rgba(0,170,255,0.5);
}
.move-position-btn.selected{
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  border-color:#00aaff;
  box-shadow:0 0 0 2px #00aaff;
}
.move-footer{
  display:flex;
  justify-content:center;
  padding-top:8px;
  border-top:1px solid rgba(255,255,255,0.1);
}
.move-btn{
  padding:5px 18px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.5);
  background:transparent;
  cursor:pointer;
  font-weight:600;
  font-size:10px;
  color:#ffffff;
  box-shadow:0 2px 4px rgba(0,0,0,0.7);
}
.move-btn-close{
  background:linear-gradient(to bottom,#cc0000,#7a0000);
  border-color:transparent;
}
.move-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 3px 6px rgba(0,0,0,0.9);
}

/* ===== CALENDAR OVERLAY ===== */
.calendar-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:11000;
}
.calendar-overlay.hidden{
  display:none;
}
.calendar-panel{
  background:linear-gradient(to bottom,#04152c,#325f9b);
  border-radius:18px;
  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 8px 20px rgba(0,0,0,0.85);
  padding:8px;
  box-sizing:border-box;
  min-width:320px;
}
.calendar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
  padding:10px;
}
.calendar-nav-btn{
  background:transparent;
  border:1px solid rgba(255,255,255,0.5);
  color:#ffffff;
  font-size:20px;
  font-weight:700;
  cursor:pointer;
  width:40px;
  height:40px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.calendar-nav-btn:hover{
  background:rgba(255,255,255,0.1);
}
.calendar-month-year{
  font-size:18px;
  font-weight:700;
  color:#ffffff;
}
.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7, 1fr);
  gap:5px;
}
.calendar-day-header{
  text-align:center;
  font-size:12px;
  font-weight:700;
  color:rgba(255,255,255,0.7);
  padding:8px 0;
}
.calendar-day{
  text-align:center;
  padding:10px;
  font-size:14px;
  cursor:pointer;
  border-radius:8px;
  background:rgba(255,255,255,0.1);
  color:#ffffff;
  border:1px solid transparent;
}
.calendar-day:hover{
  background:rgba(255,255,255,0.2);
  border-color:rgba(255,255,255,0.4);
}
.calendar-day.selected{
  background:linear-gradient(to bottom,#00aaff,#0077cc);
  font-weight:700;
}
.calendar-day.today{
  border-color:#00aaff;
  font-weight:700;
}
.calendar-day.other-month{
  opacity:0.3;
}
.calendar-day.empty{
  cursor:default;
  background:transparent;
}
.calendar-day.empty:hover{
  background:transparent;
  border-color:transparent;
}

/* ===== COUNTDOWN PILL COLORS ===== */
.mcard-delay-pill.countdown-green{
  background:linear-gradient(to bottom,#0b5f2a,#063618);
}
.mcard-delay-pill.countdown-yellow{
  background:linear-gradient(to bottom,#d4a100,#8b6f00);
}
.mcard-delay-pill.countdown-red{
  background:linear-gradient(to bottom,#cc0000,#7a0000);
}
.mcard-delay-pill.countdown-late{
  background:linear-gradient(to bottom,#ff0000,#990000);
  animation:blink-late 1s infinite;
}
@keyframes blink-late{
  0%, 100% { opacity:1; }
  50% { opacity:0.4; }
}
    

/* ===== LOG OVERLAY ===== */
.log-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
.log-overlay.hidden{
  display:none;
}
.log-panel{
  background:linear-gradient(to bottom,#0b2343,#06315a);
  border-radius:18px;
  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 8px 20px rgba(0,0,0,0.85);
  padding:24px;
  max-width:95%;
  width:1400px;
  max-height:90vh;
  display:flex;
  flex-direction:column;
  box-sizing:border-box;
}
.log-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  padding-bottom:12px;
  border-bottom:2px solid rgba(255,255,255,0.2);
}
.log-title{
  font-size:24px;
  font-weight:700;
  color:#ffffff;
  display:flex;
  align-items:center;
  gap:10px;
}
.log-stats{
  font-size:12px;
  color:rgba(255,255,255,0.7);
}
.log-controls{
  display:flex;
  gap:10px;
  margin-bottom:16px;
}
.log-btn{
  padding:8px 16px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.5);
  background:linear-gradient(to bottom,#3f6eb8,#1d3560);
  color:#ffffff;
  cursor:pointer;
  font-weight:600;
  font-size:11px;
  box-shadow:0 2px 4px rgba(0,0,0,0.7);
}
.log-btn:hover{
  background:linear-gradient(to bottom,#4a7dc9,#234171);
}
.log-btn-danger{
  background:linear-gradient(to bottom,#cc0000,#7a0000);
}
.log-btn-danger:hover{
  background:linear-gradient(to bottom,#dd0000,#8b0000);
}
.log-search{
  flex:1;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.3);
  background:rgba(0,0,0,0.3);
  color:#ffffff;
  font-size:11px;
}
.log-search::placeholder{
  color:rgba(255,255,255,0.5);
}
.log-content{
  flex:1;
  overflow-y:auto;
  padding-right:8px;
}
.log-content::-webkit-scrollbar{
  width:8px;
}
.log-content::-webkit-scrollbar-track{
  background:rgba(0,0,0,0.3);
  border-radius:4px;
}
.log-content::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,0.3);
  border-radius:4px;
}
.log-content::-webkit-scrollbar-thumb:hover{
  background:rgba(255,255,255,0.5);
}
.log-entry{
  background:rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:12px;
  padding:16px;
  margin-bottom:12px;
  transition:all 0.2s;
}
.log-entry:hover{
  background:rgba(0,0,0,0.4);
  border-color:rgba(255,255,255,0.3);
  box-shadow:0 4px 8px rgba(0,0,0,0.5);
}
.log-entry-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:12px;
  padding-bottom:8px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.log-entry-title{
  font-size:18px;
  font-weight:700;
  color:#ffffff;
}
.log-entry-order{
  font-size:14px;
  color:rgba(255,255,255,0.8);
  margin-top:2px;
}
.log-entry-deleted{
  font-size:11px;
  color:rgba(255,100,100,1);
  font-weight:600;
}
.log-entry-body{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:12px;
}
.log-entry-section{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.log-entry-label{
  font-size:10px;
  color:rgba(255,255,255,0.6);
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.05em;
}
.log-entry-value{
  font-size:12px;
  color:#ffffff;
  background:rgba(255,255,255,0.1);
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
}
.log-entry-timeline{
  grid-column:1 / -1;
  margin-top:8px;
}
.log-timeline-title{
  font-size:11px;
  color:rgba(255,255,255,0.7);
  font-weight:700;
  margin-bottom:8px;
  text-transform:uppercase;
}
.log-timeline-items{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:8px;
}
.log-timeline-item{
  background:rgba(255,255,255,0.05);
  padding:8px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
}
.log-timeline-dept{
  font-size:11px;
  font-weight:700;
  color:#00aaff;
  margin-bottom:4px;
}
.log-timeline-dates{
  font-size:10px;
  color:rgba(255,255,255,0.7);
}
.log-empty{
  text-align:center;
  padding:60px 20px;
  color:rgba(255,255,255,0.5);
  font-size:14px;
}
.log-empty-icon{
  font-size:48px;
  margin-bottom:16px;
  opacity:0.5;
}

.mcard-pill-date{
  cursor:pointer;
  background:#000000;
  color:#ffffff;
  border-radius:8px;
  border:1px solid #000000;
  height:11px;
  line-height:11px;
  padding:0 5px;
  font-size:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  box-sizing:border-box;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.mcard-pill-date i{
  font-style:italic;
  color:#cccccc;
}
.mcard-pill-date.has-date{
  font-style:normal;
  color:#ffffff;
}

/* ===== RESPONSIVE MOBILE STYLES ===== */
@media screen and (max-width: 1200px) {
  .top-title {
    font-size: 18px;
  }
  .tb-left img {
    height: 50px;
  }
}

@media screen and (max-width: 900px) {
  .topbar {
    flex-wrap: wrap;
    height: auto;
    padding: 8px;
  }
  .tb-left {
    order: 1;
  }
  .tb-center {
    position: relative;
    left: auto;
    top: auto;
    transform: none;
    order: 3;
    width: 100%;
    justify-content: center;
    margin-top: 8px;
  }
  .tb-right {
    order: 2;
  }
  .top-search-row {
    position: relative;
    left: auto;
    bottom: auto;
    transform: none;
    order: 4;
    width: 100%;
    margin-top: 8px;
  }
  .top-title {
    font-size: 16px;
  }
  .login-user-info {
    margin-left: 10px;
    padding: 4px 8px;
    font-size: 9px;
  }
  .login-logout-btn {
    padding: 3px 6px;
    font-size: 8px;
  }
}

@media screen and (max-width: 768px) {
  .board {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px;
  }
  .col {
    min-width: 100%;
    max-width: 100%;
  }
  .mcard {
    width: 100%;
  }
  .top-title {
    font-size: 14px;
    letter-spacing: 0.04em;
  }
  .tb-left img {
    height: 40px;
  }
  .add-btn {
    padding: 5px 12px;
    font-size: 9px;
  }
  .colheader {
    font-size: 12px;
  }
  .login-user-info {
    margin-left: 8px;
    padding: 4px 8px;
    font-size: 8px;
    gap: 5px;
  }
  .login-user-role {
    display: none;
  }
  .login-logout-btn {
    padding: 2px 5px;
    font-size: 7px;
  }
}

@media screen and (max-width: 480px) {
  .topbar {
    padding: 5px;
  }
  .tb-left img {
    height: 35px;
  }
  .top-title {
    font-size: 11px;
    letter-spacing: 0.02em;
  }
  .add-btn {
    padding: 4px 8px;
    font-size: 8px;
  }
  .search-box {
    max-width: 100%;
    padding: 2px 8px;
  }
  .search-box input {
    font-size: 9px;
  }
  .mcard-title {
    font-size: 10px;
  }
  .mcard-order {
    font-size: 9px;
  }
  .mcard-pill {
    font-size: 7px;
    padding: 0 4px;
    height: 10px;
    line-height: 10px;
  }
  .mcard-notes-input {
    font-size: 8px;
    line-height: 1.5;
    padding: 4px 5px 5px 5px;
  }
  .login-user-info {
    margin-left: 5px;
    padding: 3px 6px;
    font-size: 7px;
    gap: 4px;
  }
  .login-user-name {
    max-width: 50px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .login-logout-btn {
    padding: 2px 4px;
    font-size: 6px;
  }
  /* Cacher le titre sur très petits écrans */
  .tb-center {
    display: none;
  }
}

/* Touch-friendly pour mobile */
@media (hover: none) and (pointer: coarse) {
  .mcard-pill,
  .mcard-menu,
  .mcard-btn,
  .add-btn,
  .login-logout-btn {
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .mcard-notes-input {
    min-height: 60px;
  }
  .vp-item {
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

/* Viewport meta pour mobile */
html {
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}


/* === COMPACT PHOTO MENU & PILLS === */
.mcard-photo-pills-row{
  display:flex; gap:2px; margin-bottom:4px;
}
.mcard-photo-pill{
  flex:1; height:10px; line-height:10px; font-size:6px; padding:0 2px;
  border-radius:7px; text-align:center; font-weight:700; cursor:pointer;
  background:linear-gradient(to bottom,#4a7fc2,#2d5a8f); border:1px solid #000;
}
.mcard.region-on .mcard-photo-pill{ background:linear-gradient(to bottom,#b8803f,#8b5a1c);}
.mcard.region-ma .mcard-photo-pill{ background:linear-gradient(to bottom,#7a52b3,#4f357f);}


/* Hover effect for photo pills */
.mcard-photo-pill:hover{
  box-shadow:0 0 0 1px rgba(255,255,255,0.6);
  cursor:pointer;
}

</style>
</head>
<body>
<div class="physiproRoot">
  <div class="app-shell">
    <header class="topbar">
      <div class="tb-left">
        <img alt="Physipro Moulage" src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png"/>
      </div>
      <div class="tb-center">
        <div class="top-title">Outil de gestion des moulages</div>
      </div>
      <div class="tb-right">
        <div class="tb-right-top">
          <button class="add-btn" id="logBtn">📋 Log</button>
          <button class="add-btn" id="addCardBtn">+ Ajouter moulage</button>
        </div>
        <!-- User Badge compact rond en bas -->
        <div id="userInfoBadge" class="user-badge-pill" style="display:none;">
          <span class="user-badge-name" id="currentUserName">-</span>
          <div class="user-badge-dot" id="userBadgeDot"></div>
          <span class="user-badge-status-text" id="userBadgeStatusText">Connecté</span>
          <button class="user-badge-logout" id="logoutBtn">Déconnexion</button>
        </div>
      </div>
      <div class="top-search-row">
        <div class="search-box">
          <span class="search-icon">🔍</span>
          <input id="searchInput" type="text" placeholder="Rechercher un moulage…"/>
          <button class="search-clear" id="searchClear">Effacer</button>
        </div>
      </div>
    </header>

    <main class="board-wrapper">
      <div class="boards-container">
        <div class="board" id="boardPage1">
          <!-- 8 colonnes: Robot, Dégauchage, Essayage, Atelier, Couture, Peinture, Expédition, En attente -->

          <!-- Robot -->
          <section class="col">
            <div class="colheader">Robot<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-1">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-menu" data-menu-field="employe_robot">⚙️ Robot – Employés</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- Dégauchage -->
          <section class="col">
            <div class="colheader">Dégauchage<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-2">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-menu" data-menu-field="employe_degauchage">🪚 Dégauchage – Employés</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- Essayage -->
          <section class="col">
            <div class="colheader">Essayage<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-3">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label" data-status-field="essayage">En Essayage</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- Atelier -->
          <section class="col">
            <div class="colheader">Atelier<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-4">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-menu" data-menu-field="employe_atelier">📐 Atelier – Employés</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- Couture -->
          <section class="col">
            <div class="colheader">Couture<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-5">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-menu" data-menu-field="employe_couture">🧵 Couture – Employés</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- Peinture -->
          <section class="col">
            <div class="colheader">Peinture<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-6">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-menu" data-menu-field="employe_peinture">🎨 Peinture – Employés</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- Expédition -->
          <section class="col">
            <div class="colheader">Expédition<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-7">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-expedition-btn" data-status-field="expedition">🚚 Expédition</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

          <!-- En attente -->
          <section class="col">
            <div class="colheader en-attente">En attente<span class="col-count">0</span></div>
            <article class="mcard" data-card-id="default-8">
              <div class="mcard-header">
                <div class="mcard-title">Nom du moulage</div>
                <div class="mcard-order">686887</div>
                <div class="mcard-delays">
                  <div class="mcard-delay-pill"><span>Délai restant 0 jours</span></div>
                  
                </div>
              </div>
              <div class="mcard-body">
                <div class="mcard-column">
                  <div class="mcard-pill">Date reçue</div>
                  <div class="date-wrapper" data-date-field="date-recue">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-recue"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill mcard-menu" data-menu-field="region">Région</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="client">Client</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="intervenant">Intervenant</div>
                  <div class="mcard-pill mcard-menu" data-menu-field="representant">Représentante</div>
                  <div class="mcard-pill photo-link-pill">Lien photo</div>
                </div>
                <div class="mcard-column">
                  <div class="mcard-pill">Robot</div>
                  <div class="date-wrapper" data-date-field="date-robot">
                    <div class="mcard-pill mcard-pill-date" data-date-field="date-robot"><i>AAAA-MM-JJ</i></div>
                    <input type="date" class="date-input">
                  </div>
                  <div class="mcard-pill">Dégauchage</div>
                  <div class="mcard-pill">Essayage</div>
                  <div class="mcard-pill">Atelier</div>
                  <div class="mcard-pill">Couture</div>
                  <div class="mcard-pill">Peinture</div>
                </div>
              </div>
              <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
                <div class="mcard-employee-label mcard-menu mcard-attente-reason" data-menu-field="raison_attente">En attente - Raison</div>
                <div class="mcard-notes-label">Notes</div>
                <textarea class="mcard-notes-input"></textarea>
                <div class="mcard-footer-buttons">
                  <button class="mcard-btn mcard-btn-move">Déplacer</button>
                  <button class="mcard-btn mcard-btn-delete">Supprimer</button>
                </div>
              </div>
            </article>
          </section>

        </div>
      </div>
    </main>
  </div>
</div>

<div id="vpOverlay" class="vp-overlay hidden">
  <div class="vp-panel">
    <div class="vp-panel-title">Sélectionner une valeur</div>
    <div class="vp-panel-hint">Cliquez sur une valeur pour l'appliquer</div>
    <div class="vp-list" id="vpList"></div>
    <div class="vp-input-row">
      <input id="vpNewValue" class="vp-input" type="text" placeholder="Nouvelle valeur…">
    </div>
    <div class="vp-buttons">
      <button class="vp-btn vp-btn-primary" id="vpAdd">+ Ajouter</button>
      <button class="vp-btn vp-btn-danger" id="vpDelete">✕ Supprimer</button>
      <button class="vp-btn" id="vpClose">Fermer</button>
    </div>
  </div>
</div>

<!-- Move Menu Overlay -->
<div id="moveOverlay" class="move-overlay hidden">
  <div class="move-panel">
    <div class="move-columns" id="moveColumns">
      <!-- Columns will be generated dynamically -->
    </div>
    <div class="move-footer">
      <button class="move-btn move-btn-close" id="moveClose">Fermer</button>
    </div>
  </div>
</div>

<!-- Calendar Overlay -->
<div id="calendarOverlay" class="calendar-overlay hidden">
  <div class="calendar-panel" id="calendarPanel">
    <div class="calendar-header">
      <button class="calendar-nav-btn" id="calPrevMonth">◀</button>
      <div class="calendar-month-year" id="calMonthYear"></div>
      <button class="calendar-nav-btn" id="calNextMonth">▶</button>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- Calendar will be generated dynamically -->
    </div>
  </div>
</div>

<!-- Department Info Popup -->
<div id="deptInfoOverlay" class="dept-info-overlay hidden">
  <div class="dept-info-panel">
    <div class="dept-info-header" id="deptInfoTitle"></div>
    <div id="deptInfoContent"></div>
    <button class="dept-info-close" id="deptInfoClose">Fermer</button>
  </div>
</div>

<!-- Delete Confirmation Dialog -->
<div id="deleteConfirmOverlay" class="delete-confirm-overlay hidden">
  <div class="delete-confirm-panel">
    <div class="delete-confirm-title">Supprimer cette carte ?</div>
    <div class="delete-confirm-message">Cette action est irréversible.</div>
    <div class="delete-confirm-buttons">
      <button class="delete-confirm-btn delete-confirm-btn-yes" id="deleteConfirmYes">Supprimer</button>
      <button class="delete-confirm-btn delete-confirm-btn-no" id="deleteConfirmNo">Annuler</button>
    </div>
  </div>
</div>

<!-- Delay Configuration Overlay -->
<div id="delayConfigOverlay" class="delay-config-overlay hidden">
  <div class="delay-config-panel">
    <div class="delay-config-title">⏱️ Configuration des délais</div>
    <div class="delay-config-row">
      <span class="delay-config-region">🔵 Québec</span>
      <div>
        <input type="number" class="delay-config-input" id="delayQuebec" value="90" min="1">
        <span class="delay-config-unit">jours</span>
      </div>
    </div>
    <div class="delay-config-row">
      <span class="delay-config-region">🟠 Ontario</span>
      <div>
        <input type="number" class="delay-config-input" id="delayOntario" value="30" min="1">
        <span class="delay-config-unit">jours</span>
      </div>
    </div>
    <div class="delay-config-row">
      <span class="delay-config-region">🟣 Maritime</span>
      <div>
        <input type="number" class="delay-config-input" id="delayMaritime" value="45" min="1">
        <span class="delay-config-unit">jours</span>
      </div>
    </div>
    <button class="delay-config-save" id="delayConfigSave">Enregistrer</button>
  </div>
</div>

<!-- Photo Links Overlay -->
<div id="photoLinksOverlay" class="photo-links-overlay hidden">
  <div class="photo-links-panel">
    <div class="photo-links-title">📷 Galerie Photos du Moulage</div>
    
    <div class="photo-links-grid">
      <!-- Colonne Photo Client -->
      <div class="photo-link-section" data-photo-type="client">
        <div class="photo-link-label">📸 Photo Client</div>
        <div class="photo-link-list" id="photoListClient">
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 1..." data-index="0"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 2..." data-index="1"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 3..." data-index="2"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 4..." data-index="3"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 5..." data-index="4"><button class="photo-link-row-delete">✕</button></div>
        </div>
        <div class="photo-link-section-actions">
          <button class="photo-link-btn photo-link-btn-save-section" data-type="client">💾 Enregistrer</button>
        </div>
      </div>

      <!-- Colonne Photo Atelier -->
      <div class="photo-link-section" data-photo-type="atelier">
        <div class="photo-link-label">🔧 Photo Atelier</div>
        <div class="photo-link-list" id="photoListAtelier">
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 1..." data-index="0"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 2..." data-index="1"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 3..." data-index="2"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 4..." data-index="3"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 5..." data-index="4"><button class="photo-link-row-delete">✕</button></div>
        </div>
        <div class="photo-link-section-actions">
          <button class="photo-link-btn photo-link-btn-save-section" data-type="atelier">💾 Enregistrer</button>
        </div>
      </div>

      <!-- Colonne Photo Devis/Modif -->
      <div class="photo-link-section" data-photo-type="devis">
        <div class="photo-link-label">📝 Photo Devis</div>
        <div class="photo-link-list" id="photoListDevis">
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 1..." data-index="0"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 2..." data-index="1"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 3..." data-index="2"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 4..." data-index="3"><button class="photo-link-row-delete">✕</button></div>
          <div class="photo-link-row"><input type="text" class="photo-link-input" placeholder="Lien 5..." data-index="4"><button class="photo-link-row-delete">✕</button></div>
        </div>
        <div class="photo-link-section-actions">
          <button class="photo-link-btn photo-link-btn-save-section" data-type="devis">💾 Enregistrer</button>
        </div>
      </div>
    </div>

    <button class="photo-links-close" id="photoLinksClose">Fermer</button>
  </div>
</div>

<!-- Photo Viewer Overlay -->
<div id="photoViewerOverlay" class="photo-viewer-overlay hidden">
  <div class="photo-viewer-backdrop"></div>
  <div class="photo-viewer-panel">
    <button class="photo-viewer-close" id="photoViewerClose" aria-label="Fermer">×</button>
    <div class="photo-viewer-main">
      <button class="photo-viewer-nav photo-viewer-prev" id="photoViewerPrev">‹</button>
      <img id="photoViewerImage" class="photo-viewer-image" src="" alt="Photo du moulage" title="Cliquez pour ouvrir dans un nouvel onglet">
      <button class="photo-viewer-nav photo-viewer-next" id="photoViewerNext">›</button>
    </div>
    <div class="photo-viewer-thumbs" id="photoViewerThumbs"></div>
    <div class="photo-viewer-counter" id="photoViewerCounter">1 / 1</div>
    <button class="photo-viewer-open-btn" id="photoViewerOpenBtn">🔗 Ouvrir dans un nouvel onglet</button>
  </div>
</div>


<!-- Login Overlay -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-panel">
    <img class="login-logo" src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Physipro">
    <div class="login-title">Outil de gestion des moulages</div>
    <div class="login-subtitle">Entrez votre mot de passe pour accéder</div>
    <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" maxlength="20">
    <button class="login-btn" id="loginBtn">Se connecter</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- Firebase Setup Overlay -->
<!-- Firebase Setup DÉSACTIVÉ - Configuration intégrée directement -->

<!-- Firebase Status Indicator -->
<div id="firebaseStatus" class="firebase-status connecting">
  <div class="firebase-dot"></div>
  <span id="firebaseStatusText">Connexion...</span>
</div>

<!-- Log Overlay -->
<div id="logOverlay" class="log-overlay hidden">
  <div class="log-panel">
    <div class="log-header">
      <div>
        <div class="log-title">📋 Historique des suppressions</div>
        <div class="log-stats" id="logStats">0 entrées</div>
      </div>
    </div>
    <div class="log-controls">
      <input type="text" id="logSearch" class="log-search" placeholder="🔍 Rechercher dans le log...">
      <button class="log-btn" id="logExport">📥 Exporter CSV</button>
      <button class="log-btn log-btn-danger" id="logClear">🗑️ Effacer tout</button>
      <button class="log-btn" id="logClose">✕ Fermer</button>
    </div>
    <div class="log-controls" style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:12px;">
      <span style="font-size:12px;font-weight:700;color:rgba(255,255,255,0.8);margin-right:10px;">📦 Gestion des cartes:</span>
      <button class="log-btn" id="cardsExport" style="background:linear-gradient(to bottom,#0b5f2a,#063618);">📤 Exporter cartes</button>
      <button class="log-btn" id="cardsImport" style="background:linear-gradient(to bottom,#3f6eb8,#1d3560);">📥 Importer cartes</button>
      <input type="file" id="cardsImportFile" accept=".json" style="display:none;">
    </div>
    <div class="log-content" id="logContent">
      <div class="log-empty">
        <div class="log-empty-icon">📋</div>
        <div>Aucune suppression enregistrée</div>
      </div>
    </div>
  </div>
</div>

<!-- Notes Readonly Popup (pour visiteurs) -->
<div id="notesReadonlyOverlay" class="notes-readonly-overlay hidden">
  <div class="notes-readonly-panel">
    <div class="notes-readonly-header">
      <div>
        <div class="notes-readonly-title">📝 Notes</div>
        <div class="notes-readonly-card-name" id="notesReadonlyCardName">-</div>
      </div>
      <button class="notes-readonly-close" id="notesReadonlyClose">✕</button>
    </div>
    <div class="notes-readonly-content" id="notesReadonlyContent">
      <div class="notes-readonly-empty">Aucune note</div>
    </div>
  </div>
</div>

<!-- Backdrop et Container pour le popup Notes (global, en dehors des cartes) -->
<div id="notesCardBackdrop" class="notes-card-overlay-backdrop hidden"></div>
<div id="notesCardOverlayGlobal" class="notes-card-overlay hidden">
  <div class="notes-card-header">
    <span class="notes-card-title">📝</span>
    <span class="notes-card-card-info" id="notesCardInfo"></span>
    <button class="notes-card-link-btn" id="notesCardLinkBtn">🔗 Lien</button>
    <button class="notes-card-photo-btn" id="notesCardPhotoBtn">📷 Photo</button>
    <button class="notes-card-close" id="notesCardCloseBtn">✕</button>
  </div>
  <textarea class="notes-card-textarea" id="notesCardTextarea" placeholder="Écrivez vos notes ici..."></textarea>
  <button class="notes-card-save" id="notesCardSaveBtn">Fermer</button>
  <div class="notes-link-popup hidden" id="notesLinkPopup">
    <div class="notes-link-popup-title">🔗 Ajouter un lien photo</div>
    <input type="text" class="notes-link-popup-input" id="notesLinkInput" placeholder="https://...">
    <div class="notes-link-popup-buttons">
      <button class="notes-link-popup-btn notes-link-popup-save" id="notesLinkSaveBtn">Enregistrer</button>
      <button class="notes-link-popup-btn notes-link-popup-close" id="notesLinkCloseBtn">Fermer</button>
    </div>
  </div>
</div>

<!-- Notification Représentantes (Marie-Pier / Marie-Soleil) -->
<div id="representanteNotificationOverlay" class="representante-notification-overlay hidden">
  <div class="representante-notification-panel">
    <div class="representante-notification-icon">⚠️</div>
    <div class="representante-notification-title">Attention requise!</div>
    <div class="representante-notification-message" id="representanteNotificationMessage">
      Un de vos moulages est en attente. Vérifiez la note pour savoir la raison et si vous pouvez le débloquer.
    </div>
    <button class="representante-notification-close" id="representanteNotificationClose">OK</button>
  </div>
</div>

<script>
// ===== VÉRIFICATION QUE FIREBASE EST CHARGÉ =====
if(typeof firebase === 'undefined'){
  alert("❌ ERREUR: Firebase n'a pas pu être chargé.\n\nCe fichier doit être ouvert via un serveur web, pas directement depuis votre ordinateur.\n\nSolutions:\n1. Utilisez un serveur local (Live Server, XAMPP, etc.)\n2. Ou hébergez le fichier en ligne");
  throw new Error("Firebase non chargé - fichier ouvert localement?");
}

// ===== SYSTÈME DE SÉCURITÉ AVEC FIREBASE AUTHENTICATION =====

// Table de correspondance mot de passe -> email Firebase
const PASSWORD_TO_EMAIL = {
  "007000": "mario@physipro.local",
  "067700": "sina@physipro.local",
  "047700": "cassie@physipro.local",
  "047800": "stephanie@physipro.local",
  "063900": "valerie@physipro.local",
  "028500": "daniel@physipro.local",
  "010400": "michelle@physipro.local",
  "062100": "francine@physipro.local",
  "035100": "mariesoleil@physipro.local",
  "045600": "mariepier@physipro.local",
  "066600": "multipass@physipro.local",
  "099600": "fabrys@physipro.local",
  "Lecture202500": "visiteur@physipro.local"
};

// Informations des utilisateurs
const USERS = {
  "mario@physipro.local": { name: "Mario", role: "editor" },
  "sina@physipro.local": { name: "Sina", role: "editor" },
  "cassie@physipro.local": { name: "Cassie", role: "editor" },
  "stephanie@physipro.local": { name: "Stéphanie", role: "editor" },
  "valerie@physipro.local": { name: "Valérie", role: "editor" },
  "daniel@physipro.local": { name: "Daniel", role: "editor" },
  "michelle@physipro.local": { name: "Michelle", role: "editor" },
  "francine@physipro.local": { name: "Francine", role: "editor" },
  "mariesoleil@physipro.local": { name: "Marie-Soleil", role: "editor" },
  "mariepier@physipro.local": { name: "Marie-Pier", role: "editor" },
  "multipass@physipro.local": { name: "Multipass", role: "editor" },
  "fabrys@physipro.local": { name: "Fabrys", role: "editor" },
  "visiteur@physipro.local": { name: "Visiteur", role: "viewer" }
};

// Variables de session
let _sessionValid = false;
let currentUser = null;
let isReadOnly = false;
let firebaseAuth = null;

// ===== PROTECTION ANTI-BYPASS =====
(function securityInit(){
  // Désactiver le clic droit quand non connecté (sauf sur le formulaire de login)
  document.addEventListener('contextmenu', function(e){
    if(!_sessionValid && !e.target.closest('.login-panel')){
      e.preventDefault();
      return false;
    }
  });
  
  // Protéger l'overlay de login contre la manipulation CSS
  const loginOverlay = document.getElementById("loginOverlay");
  if(loginOverlay){
    // Vérification périodique que l'overlay reste visible si non connecté
    setInterval(function(){
      if(!_sessionValid && loginOverlay){
        // S'assurer que l'overlay est visible
        if(loginOverlay.classList.contains("hidden")){
          loginOverlay.classList.remove("hidden");
        }
        // Ne pas toucher aux styles si l'overlay est déjà correctement affiché
        const style = window.getComputedStyle(loginOverlay);
        if(style.display === "none" || style.visibility === "hidden"){
          loginOverlay.style.display = "flex";
          loginOverlay.style.visibility = "visible";
        }
      }
    }, 1000);
  }
})();

// ===== INITIALISATION DU LOGIN =====
(function initLogin(){
  // Event listeners pour le login
  document.getElementById("loginBtn").addEventListener("click", attemptLogin);
  document.getElementById("loginPassword").addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      attemptLogin();
    }
  });
  document.getElementById("logoutBtn").addEventListener("click", logout);
  
  // Focus sur le champ mot de passe
  setTimeout(function(){
    document.getElementById("loginPassword").focus();
  }, 100);
})();

// ===== TENTATIVE DE CONNEXION AVEC FIREBASE AUTH =====
async function attemptLogin(){
  const password = document.getElementById("loginPassword").value.trim();
  const errorEl = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");
  
  if(!password){
    errorEl.textContent = "Veuillez entrer un mot de passe";
    return;
  }
  
  // Trouver l'email correspondant au mot de passe
  const email = PASSWORD_TO_EMAIL[password];
  if(!email){
    errorEl.textContent = "Mot de passe incorrect";
    document.getElementById("loginPassword").value = "";
    document.getElementById("loginPassword").focus();
    return;
  }
  
  // Afficher un indicateur de chargement
  loginBtn.textContent = "Connexion...";
  loginBtn.disabled = true;
  errorEl.textContent = "";
  
  try{
    // Connexion via Firebase Authentication
    const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
    console.log("✅ Firebase Auth: Connexion réussie pour " + email);
    
    // Récupérer les infos utilisateur
    const userInfo = USERS[email];
    if(userInfo){
      loginUserSuccess(userInfo, email);
    } else {
      throw new Error("Utilisateur non trouvé dans la configuration");
    }
    
  } catch(error){
    console.error("❌ Erreur Firebase Auth:", error.code, error.message);
    
    // Messages d'erreur en français
    let errorMessage = "Erreur de connexion";
    switch(error.code){
      case "auth/wrong-password":
        errorMessage = "Mot de passe incorrect";
        break;
      case "auth/user-not-found":
        errorMessage = "Utilisateur non trouvé";
        break;
      case "auth/too-many-requests":
        errorMessage = "Trop de tentatives. Réessayez plus tard.";
        break;
      case "auth/network-request-failed":
        errorMessage = "Erreur réseau. Vérifiez votre connexion.";
        break;
      case "auth/invalid-credential":
        errorMessage = "Mot de passe incorrect";
        break;
      default:
        errorMessage = "Erreur: " + error.message;
    }
    
    errorEl.textContent = errorMessage;
    document.getElementById("loginPassword").value = "";
    document.getElementById("loginPassword").focus();
  }
  
  // Restaurer le bouton
  loginBtn.textContent = "Connexion";
  loginBtn.disabled = false;
}

// ===== CONNEXION RÉUSSIE =====
function loginUserSuccess(userInfo, email){
  currentUser = userInfo;
  isReadOnly = (userInfo.role === "viewer");
  _sessionValid = true;
  
  // Masquer l'écran de login
  document.getElementById("loginOverlay").classList.add("hidden");
  
  // Afficher le badge utilisateur
  const userBadge = document.getElementById("userInfoBadge");
  const userNameEl = document.getElementById("currentUserName");
  const userRoleEl = document.getElementById("currentUserRole");
  
  if(userBadge) userBadge.style.display = "flex";
  if(userNameEl) userNameEl.textContent = userInfo.name;
  if(userRoleEl) userRoleEl.textContent = isReadOnly ? "(Lecture seule)" : "(Éditeur)";
  
  // Activer le mode lecture seule si nécessaire
  if(isReadOnly){
    document.body.classList.add("readonly-mode");
    console.log("👁️ Mode lecture seule activé pour " + userInfo.name);
  } else {
    document.body.classList.remove("readonly-mode");
    console.log("✏️ Mode édition activé pour " + userInfo.name);
  }
  
  console.log("🔐 Session Firebase sécurisée établie pour " + userInfo.name);
  
  // Vérifier les notifications pour les représentantes
  if(typeof window.checkRepresentanteNotification === 'function'){
    console.log("🔔 Déclenchement vérification notification pour " + userInfo.name);
    window.checkRepresentanteNotification();
  }

  // Sécurité supplémentaire : forcer le chargement Firebase après login
  try {
    if (typeof firebaseDb !== "undefined" && firebaseDb) {
      isFirebaseMode = true;
      console.log("⚡ Chargement Firebase après login (sécurité).");
      removeDefaultCards();
      loadCardsFromFirebase();
      setupRealtimeListeners();
    }
  } catch(e){
    console.error("Erreur lors du chargement Firebase après login:", e);
  }

}

// ===== DÉCONNEXION =====
async function logout(){
  try{
    await firebaseAuth.signOut();
    console.log("🔓 Déconnexion Firebase réussie");
  } catch(error){
    console.error("Erreur déconnexion:", error);
  }
  
  _sessionValid = false;
  currentUser = null;
  isReadOnly = false;
  
  // Recharger la page
  location.reload();
}

// ===== FIREBASE CONFIGURATION SYSTEM - TEMPS RÉEL COMPLET =====
let firebaseApp = null;
let firebaseDb = null;
var isFirebaseMode = false;
const storagePrefix = "physipro_v280_";
let isInitialLoad = true;
let localCardIdCounter = 100;
let firebaseRealtimeAttached = false;

// ===== CONFIGURATION FIREBASE INTÉGRÉE (SÉCURISÉE) =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCk7bqVnx08Kz1fVq1W24AuW854KY9jPno",
  authDomain: "liste-des-moulages-physipro.firebaseapp.com",
  databaseURL: "https://liste-des-moulages-physipro-default-rtdb.firebaseio.com",
  projectId: "liste-des-moulages-physipro",
  storageBucket: "liste-des-moulages-physipro.firebasestorage.app",
  messagingSenderId: "24566847562",
  appId: "1:24566847562:web:db492bdd33116373e0eeb3"
};

// ===== CONNEXION AUTOMATIQUE À FIREBASE =====
(function initFirebaseAuto(){
  const statusDiv = document.getElementById("firebaseStatus");
  const statusText = document.getElementById("firebaseStatusText");
  const badgeDot = document.getElementById("userBadgeDot");
  const badgeStatusText = document.getElementById("userBadgeStatusText");
  
  // Fonction pour mettre à jour les indicateurs
  function updateStatus(state, text){
    if(statusDiv){
      statusDiv.classList.remove("connecting", "disconnected", "connected");
      statusDiv.classList.add(state);
    }
    if(statusText) statusText.textContent = text;
    
    if(badgeDot){
      badgeDot.classList.remove("connecting", "disconnected");
      if(state === "disconnected") badgeDot.classList.add("disconnected");
      if(state === "connecting") badgeDot.classList.add("connecting");
    }
    if(badgeStatusText) badgeStatusText.textContent = text;
  }
  
  updateStatus("connecting", "Connexion...");
  
  try{
    // Initialiser Firebase avec la configuration intégrée
    firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
    

// ---- AUTHENTIFICATION AUTOMATIQUE ----
firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        console.log("Authentifié automatiquement:", user.uid);
        window.userIsAuthenticated = true;
    } else {
        firebase.auth().signInAnonymously().catch(function(error) {
            console.error("Erreur auth anonyme:", error);
        });
    }
});
firebaseDb = firebase.database();
    firebaseAuth = firebase.auth();
    
    // Flags et helper pour charger les cartes une seule fois
    let firebaseInitialCardsLoaded = false;
    let firebaseConnected = false;
    
    function tryInitialFirebaseLoad(){
      if(firebaseInitialCardsLoaded) return;
      if(!firebaseDb) return;
      firebaseInitialCardsLoaded = true;
      isFirebaseMode = true;
      console.log("🚀 Chargement initial des cartes Firebase");
      // Supprimer les cartes par défaut du HTML
      removeDefaultCards();
      // Charger les cartes depuis Firebase
      loadCardsFromFirebase();
      // Écouter les changements en temps réel
      setupRealtimeListeners();
    }
    
    // Écouter les changements d'état d'authentification
    firebaseAuth.onAuthStateChanged(function(user){
      if(user){
        // Utilisateur déjà connecté (session persistante ou connexion en cours)
        console.log("🔄 Session Firebase détectée: " + (user.email || "[anonyme]"));
        const userInfo = user.email ? USERS[user.email] : null;
        if(userInfo){
          loginUserSuccess(userInfo, user.email);
        }
        // Dès qu'on a un utilisateur Firebase valide, on tente le chargement
        tryInitialFirebaseLoad();
      } else {
        console.log("👤 Aucune session Firebase active");
      }
    });
    
    // Tester la connexion à la base de données
    firebaseDb.ref(".info/connected").on("value", function(snap){
      if(snap.val() === true){
        firebaseConnected = true;
        updateStatus("connected", "Connecté");
        console.log("✅ Firebase connecté automatiquement - Mode temps réel activé!");
        // Si la connexion est bonne, on tente aussi le chargement
        tryInitialFirebaseLoad();
      } else {
        firebaseConnected = false;
        updateStatus("disconnected", "Déconnecté");
      }
    });
    
  } catch(e){
    console.error("Erreur Firebase:", e);
    updateStatus("disconnected", "Erreur");
  }
})();

// Supprimer les cartes par défaut du HTML
function removeDefaultCards(){
  const defaultCards = document.querySelectorAll(".mcard");
  defaultCards.forEach(card => {
    if(!card.dataset.firebaseId){
      card.remove();
    }
  });
  updateAllColumnCounts();
}

// ===== FONCTIONS DE SAUVEGARDE FIREBASE =====

// Sauvegarder une carte complète vers Firebase
function saveCardToFirebase(cardId, cardData){
  // Vérifier la session avant toute opération
  if(!_sessionValid){
    console.warn("⛔ Opération Firebase bloquée - Session invalide");
    return;
  }
  if(!isFirebaseMode || !firebaseDb) return;
  firebaseDb.ref("cards/" + cardId).set(cardData);
  console.log("💾 Carte " + cardId + " sauvegardée sur Firebase");
}

// Sauvegarder un champ spécifique d'une carte
function saveCardFieldToFirebase(cardId, field, value){
  // Vérifier la session avant toute opération
  if(!_sessionValid){
    console.warn("⛔ Opération Firebase bloquée - Session invalide");
    return;
  }
  console.log("📤 saveCardFieldToFirebase appelé - cardId=" + cardId + ", field=" + field + ", isFirebaseMode=" + isFirebaseMode);
  if(!isFirebaseMode || !firebaseDb){
    console.warn("⚠️ saveCardFieldToFirebase IGNORÉ - isFirebaseMode=" + isFirebaseMode + ", firebaseDb=" + !!firebaseDb);
    return;
  }
  firebaseDb.ref("cards/" + cardId + "/" + field).set(value);
  console.log("💾 Champ " + field + " de carte " + cardId + " sauvegardé sur Firebase");
}

// Supprimer une carte de Firebase
function deleteCardFromFirebase(cardId){
  // Vérifier la session avant toute opération
  if(!_sessionValid){
    console.warn("⛔ Opération Firebase bloquée - Session invalide");
    return;
  }
  if(!isFirebaseMode || !firebaseDb) return;
  firebaseDb.ref("cards/" + cardId).remove();
  console.log("🗑️ Carte " + cardId + " supprimée de Firebase");
}

// Fonction générique pour sauvegarder des données
function saveData(key, value){
  // Vérifier la session avant toute opération
  if(!_sessionValid){
    console.warn("⛔ Opération Firebase bloquée - Session invalide");
    return;
  }
  if(isFirebaseMode && firebaseDb){
    // Parser la clé pour voir si c'est une carte
    if(key.startsWith("card_")){
      const parts = key.split("_");
      const cardId = parts[1];
      const field = parts.slice(2).join("_");
      saveCardFieldToFirebase(cardId, field, value);
    } else {
      firebaseDb.ref("data/" + key).set(value);
    }
  }
  // Toujours sauvegarder en local aussi (backup)
  try{
    localStorage.setItem(storagePrefix + key, typeof value === 'object' ? JSON.stringify(value) : value);
  }catch(e){}
}

// ===== CHARGEMENT DEPUIS FIREBASE =====

function loadCardsFromFirebase(){
  if(!isFirebaseMode || !firebaseDb) return;
  
  firebaseDb.ref("cards").once("value", function(snap){
    const cardsData = snap.val();
    isInitialLoad = true;
    
    if(cardsData){
      console.log("📥 Chargement de " + Object.keys(cardsData).length + " cartes depuis Firebase");
      Object.keys(cardsData).forEach(cardId => {
        const cardData = cardsData[cardId];
        createOrUpdateCardFromData(cardId, cardData);
      });
    } else {
      console.log("📭 Aucune carte dans Firebase");
    }
    
    isInitialLoad = false;
    updateAllColumnCounts();
    
    // Vérifier les notifications pour les représentantes après le chargement
    if(typeof window.checkRepresentanteNotification === 'function'){
      console.log("🔔 Vérification notification après chargement Firebase...");
      window.checkRepresentanteNotification();
    }
  });
}

// ===== ÉCOUTE EN TEMPS RÉEL =====

function setupRealtimeListeners(){
  if(!isFirebaseMode || !firebaseDb) return;
  if (typeof firebaseRealtimeAttached !== "undefined" && firebaseRealtimeAttached) return;
  firebaseRealtimeAttached = true;

  // Écouter l'ajout de nouvelles cartes
  firebaseDb.ref("cards").on("child_added", function(snap){
    if(isInitialLoad) return; // Ignorer pendant le chargement initial
    
    const cardId = snap.key;
    const cardData = snap.val();
    
    // Vérifier si la carte existe déjà
    const existingCard = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
    if(!existingCard){
      console.log("🆕 Nouvelle carte reçue: " + cardId);
      createOrUpdateCardFromData(cardId, cardData);
      updateAllColumnCounts();
    }
  });
  
  // Écouter les modifications de cartes
  firebaseDb.ref("cards").on("child_changed", function(snap){
    const cardId = snap.key;
    const cardData = snap.val();
    console.log("🔄 Carte modifiée: " + cardId);
    createOrUpdateCardFromData(cardId, cardData);
  });
  
  // Écouter la suppression de cartes
  firebaseDb.ref("cards").on("child_removed", function(snap){
    const cardId = snap.key;
    console.log("🗑️ Carte supprimée: " + cardId);
    const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
    if(card){
      card.remove();
      updateAllColumnCounts();
    }
  });
  
  console.log("👂 Écoute temps réel activée");
}

// ===== CRÉATION/MISE À JOUR DE CARTE DEPUIS DONNÉES =====

function createOrUpdateCardFromData(cardId, data){
  let card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
  let isNewCard = false;
  
  if(card){
    // Mettre à jour la carte existante
    console.log("📋 createOrUpdateCardFromData - Mise à jour carte existante: " + cardId);
    updateExistingCard(card, data);
  } else {
    // Créer une nouvelle carte
    console.log("📋 createOrUpdateCardFromData - Création nouvelle carte: " + cardId);
    card = createNewCardElement(cardId, data);
    isNewCard = true;
    
    // Placer dans la bonne colonne
    // IMPORTANT: position 0 = premier rang, donc on vérifie explicitement !== undefined
    const columnIndex = data.column || 0;
    const position = (data.position !== undefined && data.position !== null) ? data.position : 999;
    placeCardInColumn(card, columnIndex, position);
    
    // IMPORTANT: Appeler updateExistingCard pour appliquer TOUTES les données (raison_attente, alertes, etc.)
    console.log("📋 createOrUpdateCardFromData - Application des données Firebase sur nouvelle carte: " + cardId);
    updateExistingCard(card, data);
  }
  
  // Réinitialiser le tracking des départements pour cette carte
  // (ajoute les classes et attributs nécessaires pour les pastilles de la colonne droite)
  if(typeof window.initDepartmentTracking === 'function'){
    setTimeout(function(){
      window.initDepartmentTracking();
    }, 50);
  }
  
  return card;
}

// Fonction pour appliquer le thème de couleur selon la région
function applyRegionTheme(card, value){
  if (!card) return;
  card.classList.remove("region-qc","region-on","region-ma");
  if (value === "Québec"){
    card.classList.add("region-qc");
  } else if (value === "Ontario"){
    card.classList.add("region-on");
  } else if (value === "Maritime"){
    card.classList.add("region-ma");
  }
}

function updateExistingCard(card, data){
  const cardId = card.dataset.cardId;
  
  // Mise à jour du titre
  const titleEl = card.querySelector(".mcard-title");
  if(titleEl && !titleEl.classList.contains("editing")){
    titleEl.textContent = data.title || "Nom du moulage";
  }
  
  // Mise à jour du numéro de commande
  const orderEl = card.querySelector(".mcard-order");
  if(orderEl && !orderEl.classList.contains("editing")){
    orderEl.textContent = data.order || "000000";
  }
  
  // Mise à jour des dates
  if(data.dateRecue){
    const dateRecuePill = card.querySelector('.mcard-pill-date[data-date-field="date-recue"]');
    if(dateRecuePill){
      dateRecuePill.textContent = data.dateRecue;
      dateRecuePill.classList.add("has-date");
    }
    // Aussi en localStorage
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_date-recue", data.dateRecue); }catch(e){}
  }
  if(data.dateRobot){
    const dateRobotPill = card.querySelector('.mcard-pill-date[data-date-field="date-robot"]');
    if(dateRobotPill){
      dateRobotPill.textContent = data.dateRobot;
      dateRobotPill.classList.add("has-date");
    }
    // Aussi en localStorage
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_date-robot", data.dateRobot); }catch(e){}
  }
  
  // Mise à jour des menus
  const menuFields = ["region", "client", "intervenant", "representant"];
  menuFields.forEach(field => {
    if(data[field]){
      const pill = card.querySelector('.mcard-menu[data-menu-field="'+field+'"]');
      if(pill) pill.textContent = data[field];
      // Aussi en localStorage
      try{ localStorage.setItem("physipro_v280_card_" + cardId + "_" + field, data[field]); }catch(e){}
    }
  });
  
  // Mise à jour de la région (thème couleur)
  if(data.region){
    applyRegionTheme(card, data.region);
  }
  
  // Mise à jour des notes
  const notesEl = card.querySelector(".mcard-notes-input");
  if(notesEl && document.activeElement !== notesEl){
    notesEl.value = data.notes || "";
  }
  // Aussi en localStorage
  if(data.notes){
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_notes", data.notes); }catch(e){}
  }
  if(data.notesDate){
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_notes_date", data.notesDate); }catch(e){}
  }
  if(data.notesAuthor){
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_notes_author", data.notesAuthor); }catch(e){}
  }
  
  // Mise à jour de tous les employés par département
  const employeeFields = ["employe_robot", "employe_degauchage", "employe_atelier", "employe_couture", "employe_peinture"];
  employeeFields.forEach(field => {
    if(data[field]){
      const pill = card.querySelector('.mcard-menu[data-menu-field="'+field+'"]');
      if(pill){
        pill.textContent = data[field];
        // Si actif, ajouter le clignotement
        if(data[field + "_active"]){
          pill.classList.add("employee-active");
        }
      }
      // Aussi en localStorage
      try{ localStorage.setItem("physipro_v280_card_" + cardId + "_" + field, data[field]); }catch(e){}
      if(data[field + "_active"]){
        try{ localStorage.setItem("physipro_v280_card_" + cardId + "_" + field + "_active", "true"); }catch(e){}
      }
    }
  });
  
  // Mise à jour de la raison d'attente (accepter les deux formats de clé)
  const raisonValue = data.raisonAttente || data.raison_attente;
  console.log("📋 updateExistingCard - Carte " + cardId + " - data.raisonAttente:", data.raisonAttente, "- data.raison_attente:", data.raison_attente, "- raisonValue:", raisonValue);
  
  // IMPORTANT: Vérifier DABORD que la carte est DANS la colonne "En attente" (colonne 7)
  const col = card.closest(".col");
  const board = document.querySelector(".board");
  const columns = board ? Array.from(board.querySelectorAll(".col")) : [];
  const currentColIndex = col ? columns.indexOf(col) : -1;
  const isInAttenteColumn = (currentColIndex === 7);
  
  // NE créer/mettre à jour la pastille raison QUE si la carte est dans En attente
  if(raisonValue && raisonValue !== "En attente - Raison" && isInAttenteColumn){
    console.log("📋 updateExistingCard - Carte dans En attente, mise à jour raison pour carte " + cardId);
    let attentePill = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
    console.log("📋 updateExistingCard - Pastille existante:", !!attentePill);
    
    // Si la pastille n'existe pas mais qu'on a une raison, on doit la créer
    if(!attentePill){
      console.log("🔧 Création de la pastille raison_attente pour carte " + cardId);
      const footer = card.querySelector(".mcard-footer");
      const notesLabel = card.querySelector(".mcard-notes-label");
      
      // Supprimer l'ancienne pastille employé si elle existe
      const oldEmployeePill = footer.querySelector(".mcard-employee-label");
      if(oldEmployeePill && !oldEmployeePill.classList.contains("mcard-attente-reason")){
        oldEmployeePill.remove();
      }
      
      // Créer la nouvelle pastille
      attentePill = document.createElement("div");
      attentePill.className = "mcard-employee-label mcard-menu mcard-attente-reason";
      attentePill.dataset.menuField = "raison_attente";
      
      if(notesLabel){
        notesLabel.insertAdjacentElement("beforebegin", attentePill);
      } else {
        footer.insertBefore(attentePill, footer.firstChild);
      }
    }
    
    if(attentePill){
      attentePill.textContent = raisonValue;
      // Aussi en localStorage
      try{ localStorage.setItem("physipro_v280_card_" + cardId + "_raison_attente", raisonValue); }catch(e){}
      
      // Activer les alertes si nécessaire
      if(data.attenteAlertActive || data.raisonAttenteActive || data.attenteActive || raisonNecessiteAlerte(raisonValue)){
        attentePill.classList.add("attente-active");
        card.classList.add("attente-alert-active");
        card.classList.add("in-attente-column");
        
        // Aussi la représentante
        const repPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(repPill) repPill.classList.add("representant-alert");
        
        // Activer le clignotement rouge sur le département correspondant
        const deptForRaison = data.attenteDept || getDeptFromRaison(raisonValue);
        if(deptForRaison){
          activateDeptPillRed(card, deptForRaison);
        }
        
        // Sauvegarder en localStorage
        try{
          localStorage.setItem("physipro_v280_card_" + cardId + "_raison_attente_active", "true");
          localStorage.setItem("physipro_v280_card_" + cardId + "_attente_alert_active", "true");
          localStorage.setItem("physipro_v280_card_" + cardId + "_representant_alert", "true");
        }catch(e){}
        
        console.log("🔴 Alerte restaurée depuis Firebase pour carte " + cardId + " - Raison: " + raisonValue);
      }
    } else {
      console.log("⚠️ Impossible de créer la pastille raison_attente pour carte " + cardId);
    }
  } else if(raisonValue && !isInAttenteColumn){
    // La carte a une raison mais n'est PAS dans En attente - supprimer la pastille si elle existe
    console.log("📋 Carte " + cardId + " pas dans En attente (col " + currentColIndex + "), suppression de la pastille raison si présente");
    const attentePillToRemove = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
    if(attentePillToRemove){
      attentePillToRemove.remove();
    }
    // Nettoyer localStorage
    try{
      localStorage.removeItem("physipro_v280_card_" + cardId + "_raison_attente");
      localStorage.setItem("physipro_v280_card_" + cardId + "_raison_attente_active", "false");
    }catch(e){}
  }
  
  // Mise à jour de l'expédition
  if(data.expeditionStatus === "expedited" && data.expeditionDate){
    const expeditionBtn = card.querySelector(".mcard-expedition-btn");
    if(expeditionBtn){
      expeditionBtn.textContent = "🚚 Expédié - " + data.expeditionDate;
      expeditionBtn.classList.add("expedited");
    }
    // Aussi en localStorage
    try{
      localStorage.setItem("physipro_v280_card_" + cardId + "_expedition_status", data.expeditionStatus);
      localStorage.setItem("physipro_v280_card_" + cardId + "_expedition_date", data.expeditionDate);
    }catch(e){}
  }
  
  // Mise à jour des liens photos
  if(data.photo_client){
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_photo_client", data.photo_client); }catch(e){}
  }
  if(data.photo_atelier){
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_photo_atelier", data.photo_atelier); }catch(e){}
  }
  if(data.photo_devis){
    try{ localStorage.setItem("physipro_v280_card_" + cardId + "_photo_devis", data.photo_devis); }catch(e){}
  }
  
  // Vérifier si la carte doit changer de colonne
  if(data.column !== undefined){
    const currentCol = card.closest(".col");
    const board = document.querySelector(".board");
    const columns = Array.from(board.querySelectorAll(".col"));
    const currentColIndex = columns.indexOf(currentCol);
    
    if(currentColIndex !== data.column){
      // IMPORTANT: Si on SORT de la colonne "En attente" (7), nettoyer TOUT
      if(currentColIndex === 7 && data.column !== 7){
        console.log("🔄 Firebase: Carte " + cardId + " sort de En attente - Nettoyage...");
        
        // Retirer toutes les classes liées à En attente
        card.classList.remove("in-attente-column");
        card.classList.remove("attente-alert-active");
        card.classList.remove("attention-needed");
        
        // Remettre la pastille de délai en mode normal
        const delayPill = card.querySelector('.mcard-delay-pill');
        if(delayPill){
          delayPill.classList.remove("attente-active");
          delayPill.dataset.attenteDepuis = "";
          delayPill.innerHTML = '<span>Délai restant 0 jours</span>';
        }
        
        // Retirer le clignotement de la représentante
        const repPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(repPill) repPill.classList.remove("representant-alert");
        
        // Retirer le clignotement de la raison
        const raisonPill = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
        if(raisonPill) raisonPill.classList.remove("attente-active");
        
        // Retirer le clignotement rouge de tous les départements
        if(typeof deactivateDeptPillRed === 'function'){
          deactivateDeptPillRed(card);
        }
        
        // Nettoyer toutes les pastilles
        const allPills = card.querySelectorAll('.mcard-pill, .mcard-menu');
        allPills.forEach(pill => {
          pill.classList.remove("dept-pill-en-attente");
          pill.classList.remove("attente-active");
          pill.classList.remove("representant-alert");
        });
      }
      
      placeCardInColumn(card, data.column, data.position || 999);
    }
  }
  
  // Mettre à jour l'indicateur de notes
  if(typeof updateNotesIndicator === 'function'){
    updateNotesIndicator(card, cardId);
  }
}

function createNewCardElement(cardId, data){
  const card = document.createElement("article");
  card.className = "mcard";
  card.dataset.cardId = cardId;
  card.dataset.firebaseId = cardId;
  
  // Appliquer le thème de région
  if(data.region === "Québec") card.classList.add("region-qc");
  else if(data.region === "Ontario") card.classList.add("region-on");
  else if(data.region === "Maritime") card.classList.add("region-ma");
  
  card.innerHTML = generateCardHTML(data);
  
  return card;
}

function generateCardHTML(data){
  const title = data.title || "Nouveau Moulage";
  const order = data.order || "000000";
  const dateRecue = data.dateRecue || "<i>AAAA-MM-JJ</i>";
  const dateRobot = data.dateRobot || "<i>AAAA-MM-JJ</i>";
  const region = data.region || "Région";
  const client = data.client || "Client";
  const intervenant = data.intervenant || "Intervenant";
  const representant = data.representant || "Représentante";
  const notes = data.notes || "";
  const employee = data.employee || getDefaultEmployeeLabel(data.column || 0);
  const employeeField = getEmployeeFieldForColumn(data.column || 0);
  
  const dateRecueClass = data.dateRecue ? "has-date" : "";
  const dateRobotClass = data.dateRobot ? "has-date" : "";
  
  // Déterminer si c'est la colonne "En attente" pour ajouter la classe spéciale
  const isAttenteColumn = (data.column === 7);
  const employeeClass = isAttenteColumn ? "mcard-employee-label mcard-menu mcard-attente-reason" : "mcard-employee-label mcard-menu";
  
  return `
    <div class="mcard-header">
      <div class="mcard-title">${title}</div>
      <div class="mcard-order">${order}</div>
      <div class="mcard-delays">
        <div class="mcard-delay-pill" data-attente-depuis="${data.attenteDepuis || ''}"><span>Délai restant 0 jours</span></div>
      </div>
    </div>
    <div class="mcard-body">
      <div class="mcard-column">
        <div class="mcard-pill">Date reçue</div>
        <div class="date-wrapper" data-date-field="date-recue">
          <div class="mcard-pill mcard-pill-date ${dateRecueClass}" data-date-field="date-recue">${dateRecue}</div>
          <input type="date" class="date-input">
        </div>
        <div class="mcard-pill mcard-menu" data-menu-field="region">${region}</div>
        <div class="mcard-pill mcard-menu" data-menu-field="client">${client}</div>
        <div class="mcard-pill mcard-menu" data-menu-field="intervenant">${intervenant}</div>
        <div class="mcard-pill mcard-menu" data-menu-field="representant">${representant}</div>
        <div class="mcard-pill photo-link-pill">Lien photo</div>
      </div>
      <div class="mcard-column">
        <div class="mcard-pill">Robot</div>
        <div class="date-wrapper" data-date-field="date-robot">
          <div class="mcard-pill mcard-pill-date ${dateRobotClass}" data-date-field="date-robot">${dateRobot}</div>
          <input type="date" class="date-input">
        </div>
        <div class="mcard-pill">Dégauchage</div>
        <div class="mcard-pill">Essayage</div>
        <div class="mcard-pill">Atelier</div>
        <div class="mcard-pill">Couture</div>
        <div class="mcard-pill">Peinture</div>
      </div>
    </div>
    <div class="mcard-footer">
       <div class="mcard-photo-pills-row">
         <div class="mcard-photo-pill" data-photo-type="client">Photo client</div>
         <div class="mcard-photo-pill" data-photo-type="atelier">Photo atelier</div>
         <div class="mcard-photo-pill" data-photo-type="devis">Photo devis</div>
       </div>
      <div class="${employeeClass}" data-menu-field="${employeeField}">${employee}</div>
      <div class="mcard-notes-label">Notes</div>
      <textarea class="mcard-notes-input">${notes}</textarea>
      <div class="mcard-footer-buttons">
        <button class="mcard-btn mcard-btn-move">Déplacer</button>
        <button class="mcard-btn mcard-btn-delete">Supprimer</button>
      </div>
    </div>
  `;
}

function getDefaultEmployeeLabel(columnIndex){
  const labels = {
    0: "⚙️ Robot – Employés",
    1: "🪚 Dégauchage – Employés",
    2: "♿ En Essayage",
    3: "📐 Atelier – Employés",
    4: "🧵 Couture – Employés",
    5: "🎨 Peinture – Employés",
    6: "🚚 Expédition",
    7: "En attente - Raison"
  };
  return labels[columnIndex] || "Employé";
}

function getEmployeeFieldForColumn(columnIndex){
  const fields = {
    0: "employe_robot",
    1: "employe_degauchage",
    2: "essayage",
    3: "employe_atelier",
    4: "employe_couture",
    5: "employe_peinture",
    6: "expedition",
    7: "raison_attente"
  };
  return fields[columnIndex] || "employe_robot";
}

function placeCardInColumn(card, columnIndex, position){
  const board = document.querySelector(".board");
  const columns = Array.from(board.querySelectorAll(".col"));
  const targetColumn = columns[columnIndex];
  
  if(!targetColumn) return;
  
  // Retirer la carte de sa position actuelle si elle existe
  if(card.parentNode){
    card.remove();
  }
  
  const existingCards = Array.from(targetColumn.querySelectorAll(".mcard"));
  const colheader = targetColumn.querySelector(".colheader");
  
  if(position <= 0 || existingCards.length === 0){
    colheader.insertAdjacentElement("afterend", card);
  } else if(position >= existingCards.length){
    targetColumn.appendChild(card);
  } else {
    existingCards[position].insertAdjacentElement("beforebegin", card);
  }
  
  updateAllColumnCounts();
}

function updateAllColumnCounts(){
  const board = document.querySelector(".board");
  if(!board) return;
  const columns = Array.from(board.querySelectorAll(".col"));
  
  columns.forEach(col => {
    const header = col.querySelector(".colheader");
    const countSpan = header ? header.querySelector(".col-count") : null;
    const cards = col.querySelectorAll(".mcard");
    if(countSpan){
      countSpan.textContent = cards.length;
    }
  });
}

// ===== EXTRACTION DES DONNÉES D'UNE CARTE =====

function extractCardData(card){
  const cardId = card.dataset.cardId;
  const col = card.closest(".col");
  const board = document.querySelector(".board");
  const columns = Array.from(board.querySelectorAll(".col"));
  const columnIndex = columns.indexOf(col);
  const cardsInColumn = Array.from(col.querySelectorAll(".mcard"));
  const position = cardsInColumn.indexOf(card);
  
  const data = {
    column: columnIndex,
    position: position,
    title: card.querySelector(".mcard-title")?.textContent || "Nouveau Moulage",
    order: card.querySelector(".mcard-order")?.textContent || "000000",
    notes: card.querySelector(".mcard-notes-input")?.value || "",
    updatedAt: Date.now(),
    updatedBy: currentUser ? currentUser.name : "Inconnu"
  };
  
  // Dates
  const dateRecuePill = card.querySelector('.mcard-pill-date[data-date-field="date-recue"]');
  if(dateRecuePill && dateRecuePill.classList.contains("has-date")){
    data.dateRecue = dateRecuePill.textContent;
  }
  const dateRobotPill = card.querySelector('.mcard-pill-date[data-date-field="date-robot"]');
  if(dateRobotPill && dateRobotPill.classList.contains("has-date")){
    data.dateRobot = dateRobotPill.textContent;
  }
  
  // Menus
  const menuFields = ["region", "client", "intervenant", "representant"];
  menuFields.forEach(field => {
    const pill = card.querySelector('.mcard-menu[data-menu-field="'+field+'"]');
    if(pill){
      const text = pill.textContent;
      if(text && text !== field.charAt(0).toUpperCase() + field.slice(1) && text !== "Représentante"){
        data[field] = text;
      }
    }
  });
  
  // Tous les employés par département
  const employeeFields = ["employe_robot", "employe_degauchage", "employe_atelier", "employe_couture", "employe_peinture"];
  employeeFields.forEach(field => {
    const pill = card.querySelector('.mcard-menu[data-menu-field="'+field+'"]');
    if(pill){
      data[field] = pill.textContent;
      if(pill.classList.contains("employee-active")){
        data[field + "_active"] = true;
      }
    }
    // Récupérer aussi depuis localStorage
    try{
      const storedValue = localStorage.getItem("physipro_v280_card_" + cardId + "_" + field);
      if(storedValue && !data[field]){
        data[field] = storedValue;
      }
      const activeState = localStorage.getItem("physipro_v280_card_" + cardId + "_" + field + "_active");
      if(activeState === "true"){
        data[field + "_active"] = true;
      }
    }catch(e){}
  });
  
  // État production
  try{
    const inProd = localStorage.getItem("physipro_v280_card_" + cardId + "_in_production");
    if(inProd === "true"){
      data.inProduction = true;
    }
  }catch(e){}
  
  // Raison attente
  const attentePill = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
  if(attentePill){
    data.raisonAttente = attentePill.textContent;
    data.attenteActive = attentePill.classList.contains("attente-active");
  }
  try{
    const storedRaison = localStorage.getItem("physipro_v280_card_" + cardId + "_raison_attente");
    if(storedRaison && !data.raisonAttente){
      data.raisonAttente = storedRaison;
    }
  }catch(e){}
  
  // État alerte représentante
  try{
    const repAlert = localStorage.getItem("physipro_v280_card_" + cardId + "_representant_alert");
    if(repAlert === "true"){
      data.representantAlert = true;
    }
  }catch(e){}
  
  // Notes date et auteur
  try{
    const notesDate = localStorage.getItem("physipro_v280_card_" + cardId + "_notes_date");
    const notesAuthor = localStorage.getItem("physipro_v280_card_" + cardId + "_notes_author");
    if(notesDate) data.notesDate = notesDate;
    if(notesAuthor) data.notesAuthor = notesAuthor;
  }catch(e){}
  
  // Expédition
  try{
    const expStatus = localStorage.getItem("physipro_v280_card_" + cardId + "_expedition_status");
    const expDate = localStorage.getItem("physipro_v280_card_" + cardId + "_expedition_date");
    if(expStatus) data.expeditionStatus = expStatus;
    if(expDate) data.expeditionDate = expDate;
  }catch(e){}
  
  return data;
}

// ===== GÉNÉRATION D'ID UNIQUE =====

function generateUniqueCardId(){
  return "card_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
}

const MENU_DATA = {
  "regions": [
    "Québec",
    "Ontario",
    "Maritime"
  ],
  "delays": {
    "Québec": 90,
    "Ontario": 30,
    "Maritime": 45
  },
  "clients": [
    "MEDPLUS",
    "METRO HEALTH",
    "TLC medical",
    "Lucie Bruneau.",
    "CMR",
    "Ciss Laurentides bouclier"
  ],
  "intervenants": [
    "Anna",
    "Jenny Jackson",
    "Pam",
    "Maryse Bernard",
    "Anna Caufield",
    "Lee Ann Best",
    "Charles Larose"
  ],
  "representantes": [
    "Marie-Soleil",
    "Marie-Piers"
  ],
  "employees": {
    "robot": [
      "Mario Jaques",
      "Sina"
    ],
    "degauchage": [
      "Pierre",
      "Serge",
      "Nestor",
      "Mathieu",
      "Daniel"
    ],
    "essayage": "status-only",
    "atelier": [
      "Pierre",
      "Serge",
      "Nestor",
      "Mathieu",
      "Daniel",
      "Valérie",
      "Tommy",
      "Saul",
      "Checkna"
    ],
    "couture": [
      "Stéphanie",
      "Cassie",
      "Thérèse",
      "Louisette",
      "Suave",
      "Martine"
    ],
    "peinture": [
      "Manuel",
      "Cheickna",
      "Saul",
      "Pablo"
    ],
    "expedition": "button-only",
    "attente": {
      "raisons": [
        "En attente de pièces",
        "En attente d'approbation client",
        "En attente de réponse couture",
        "En attente de réponse atelier",
        "En attente de réponse robot",
        "En attente de posit",
        "En attente ROHO",
        "En attente de plaques d'aluminium"
      ]
    }
  }
};

// ===== RAISONS QUI DÉCLENCHENT L'ALERTE ROUGE =====
const RAISONS_ALERTE_ROUGE = [
  "En attente d'approbation client",
  "En attente de réponse couture",
  "En attente de réponse atelier",
  "En attente de réponse robot",
  "En attente de ROHO"
];

// Mapping raison -> département pour le clignotement rouge
const RAISON_DEPT_MAP = {
  "En attente d'approbation client": "Atelier",
  "En attente de réponse couture": "Couture",
  "En attente de réponse atelier": "Atelier",
  "En attente de réponse robot": "Robot",
  "En attente de ROHO": "Atelier"
};

// Fonction helper pour vérifier si une raison nécessite une alerte
function raisonNecessiteAlerte(raison){
  return RAISONS_ALERTE_ROUGE.includes(raison);
}

// Fonction pour vérifier si une carte a une raison qui nécessite une alerte
function cardNecessiteAlerte(card){
  const cardId = card.dataset.cardId || "unknown";
  // Chercher la pastille "En attente - Raison"
  const raisonPill = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
  console.log("🔍 cardNecessiteAlerte - Carte " + cardId + " - Pastille trouvée:", !!raisonPill);
  if(!raisonPill){
    console.log("🔍 cardNecessiteAlerte - Pas de pastille raison_attente");
    return false;
  }
  const raison = raisonPill.textContent.trim();
  console.log("🔍 cardNecessiteAlerte - Raison lue:", raison);
  // Ignorer le texte par défaut
  if(raison === "En attente - Raison" || raison === ""){
    console.log("🔍 cardNecessiteAlerte - Raison par défaut ou vide");
    return false;
  }
  const result = raisonNecessiteAlerte(raison);
  console.log("🔍 cardNecessiteAlerte - Résultat:", result);
  return result;
}

// Fonction pour trouver la pastille département par nom dans une carte
function findDeptPillByName(card, deptName){
  const pills = card.querySelectorAll('.mcard-column .mcard-pill');
  for(let pill of pills){
    const text = pill.textContent.trim();
    if(text === deptName){
      return pill;
    }
  }
  return null;
}

// Fonction pour activer le clignotement rouge sur la pastille département (en attente)
function activateDeptPillRed(card, deptName){
  const pill = findDeptPillByName(card, deptName);
  if(pill){
    pill.classList.add("dept-pill-en-attente");
  }
}

// Fonction pour désactiver le clignotement rouge sur la pastille département
function deactivateDeptPillRed(card){
  const pills = card.querySelectorAll('.mcard-pill.dept-pill-en-attente');
  pills.forEach(pill => pill.classList.remove("dept-pill-en-attente"));
}

// Fonction pour obtenir le département correspondant à une raison
function getDeptFromRaison(raison){
  return RAISON_DEPT_MAP[raison] || null;
}

(function(){
  const storagePrefix = "physipro_v280_";
  // Assign card ids
  const cards = Array.from(document.querySelectorAll(".mcard"));
  cards.forEach((card, index) => {
    if (!card.dataset.cardId) {
      card.dataset.cardId = String(index + 1);
    }
  });

  // ---- Restore saved dates on page load ----
  const dateWrappers = document.querySelectorAll(".date-wrapper");
  dateWrappers.forEach(wrapper => {
    const card = wrapper.closest(".mcard");
    const cardId = card ? card.dataset.cardId : "0";
    const field = wrapper.dataset.dateField || (wrapper.querySelector(".mcard-pill-date")?.dataset.dateField) || "date";
    const pill = wrapper.querySelector(".mcard-pill-date");
    const input = wrapper.querySelector(".date-input");
    if (!pill || !input) return;
    
    // Restore saved date from localStorage
    try{
      const stored = localStorage.getItem(storagePrefix + "card_" + cardId + "_" + field);
      if (stored){
        pill.classList.add("has-date");
        pill.textContent = stored;
        input.value = stored;
      }
    }catch(e){console.warn("Failed to restore date:", e);}
  });
  
  // ---- Menu handling ----
  const vpOverlay = document.getElementById("vpOverlay");
  const vpList = document.getElementById("vpList");
  const vpNewValue = document.getElementById("vpNewValue");
  const vpAdd = document.getElementById("vpAdd");
  const vpDelete = document.getElementById("vpDelete");
  const vpClose = document.getElementById("vpClose");

  const employeeDefaults = Array.from(new Set(
    []
      .concat(MENU_DATA.employees.robot || [])
      .concat(MENU_DATA.employees.degauchage || [])
      .concat(MENU_DATA.employees.atelier || [])
      .concat(MENU_DATA.employees.couture || [])
      .concat(MENU_DATA.employees.peinture || [])
  ));

  const defaultOptions = {
    region: MENU_DATA.regions.slice(),
    client: MENU_DATA.clients.slice(),
    intervenant: MENU_DATA.intervenants.slice(),
    representant: MENU_DATA.representantes.slice(),
    employe_robot: MENU_DATA.employees.robot.slice(),
    employe_degauchage: MENU_DATA.employees.degauchage.slice(),
    employe_atelier: MENU_DATA.employees.atelier.slice(),
    employe_couture: MENU_DATA.employees.couture.slice(),
    employe_peinture: MENU_DATA.employees.peinture.slice(),
    raison_attente: MENU_DATA.employees.attente.raisons.slice()
  };

  let optionCache = {};
  let currentMenuField = null;
  let currentMenuTarget = null;
  let currentSelectedValue = null;

  function loadOptions(field){
    if (optionCache[field]) return optionCache[field];
    let arr = [];
    try{
      const raw = localStorage.getItem(storagePrefix + "options_" + field);
      if (raw){
        arr = JSON.parse(raw);
      } else if (defaultOptions[field]) {
        arr = defaultOptions[field].slice();
      }
    }catch(e){
      console.warn("Failed to load options for " + field + ":", e);
      arr = defaultOptions[field] ? defaultOptions[field].slice() : [];
    }
    optionCache[field] = arr;
    return arr;
  }

  function saveOptions(field){
    try{
      localStorage.setItem(storagePrefix + "options_" + field, JSON.stringify(optionCache[field] || []));
    }catch(e){console.warn("Failed to save options for " + field + ":", e);}
  }

  function renderOptions(field){
    const items = loadOptions(field);
    vpList.innerHTML = "";
    currentSelectedValue = null;
    items.forEach(value => {
      const div = document.createElement("div");
      div.className = "vp-item";
      div.textContent = value;
      
      // Simple clic = appliquer et fermer
      div.addEventListener("click", function(e){
        applyMenuValue(value);
      });
      
      vpList.appendChild(div);
    });
  }

  function openMenu(field, target){
    currentMenuField = field;
    currentMenuTarget = target;
    renderOptions(field);
    vpNewValue.value = "";
    vpOverlay.classList.remove("hidden");
    vpNewValue.blur();
  }

  function closeMenu(){
    vpOverlay.classList.add("hidden");
    currentMenuField = null;
    currentMenuTarget = null;
    currentSelectedValue = null;
  }

  function applyMenuValue(value){
    if (!currentMenuTarget || !currentMenuField) return;
    const card = currentMenuTarget.closest(".mcard");
    const cardId = card ? card.dataset.cardId : "0";
    
    // For employee fields, show "Nom - En production"
    if(currentMenuField.startsWith("employe_")){
      const icons = {
        "employe_robot": "⚙️",
        "employe_degauchage": "🪚",
        "employe_atelier": "📐",
        "employe_couture": "🧵",
        "employe_peinture": "🎨"
      };
      const icon = icons[currentMenuField] || "";
      // Format: "Icône Nom - En production"
      currentMenuTarget.textContent = icon + " " + value + " - En production";
      
      // Activer le clignotement vert de la pastille employé SEULEMENT
      currentMenuTarget.classList.add("employee-active");
      
      // Sauvegarder l'état actif
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_" + currentMenuField + "_active", "true");
      }catch(e){}
      
      // Update employee in department data
      const deptMap = {
        "employe_robot": "robot",
        "employe_degauchage": "degauchage",
        "employe_atelier": "atelier",
        "employe_couture": "couture",
        "employe_peinture": "peinture"
      };
      const deptName = deptMap[currentMenuField];
      if(deptName && window.updateDepartmentEmployee){
        window.updateDepartmentEmployee(cardId, deptName, value);
      }
    } else if(currentMenuField === "raison_attente"){
      // Pour "En attente", sauvegarder la valeur
      currentMenuTarget.textContent = value;
      
      // D'abord, retirer tous les clignotements rouges sur les pastilles département
      deactivateDeptPillRed(card);
      
      // Vérifier si cette raison nécessite une alerte rouge
      if(raisonNecessiteAlerte(value)){
        currentMenuTarget.classList.add("attente-active");
        
        // Sauvegarder l'état actif
        try{
          localStorage.setItem(storagePrefix + "card_" + cardId + "_raison_attente_active", "true");
        }catch(e){}
        
        // Activer le clignotement rouge sur la pastille représentante
        const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(representantPill){
          representantPill.classList.add("representant-alert");
          try{
            localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "true");
          }catch(e){}
        }
        
        // Activer le clignotement de la bordure rouge de la carte
        card.classList.add("attente-alert-active");
        try{
          localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_alert_active", "true");
        }catch(e){}
        
        // Activer le clignotement rouge sur la pastille de délai (maintenant en mode attente)
        const delayPill = card.querySelector('.mcard-delay-pill');
        if(delayPill){
          delayPill.classList.add("attente-active");
        }
        
        // Activer le clignotement rouge sur la pastille département correspondante
        const deptForRaison = getDeptFromRaison(value);
        if(deptForRaison){
          activateDeptPillRed(card, deptForRaison);
          try{
            localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_dept", deptForRaison);
          }catch(e){}
        }
        
        console.log("🔴 ALERTE ACTIVÉE - Raison: " + value + " - Dept: " + deptForRaison);
      } else {
        // Raison qui ne nécessite PAS d'alerte - RETIRER TOUS les clignotements
        currentMenuTarget.classList.remove("attente-active");
        
        // Retirer le clignotement de la pastille de délai
        const delayPill = card.querySelector('.mcard-delay-pill');
        if(delayPill){
          delayPill.classList.remove("attente-active");
        }
        
        try{
          localStorage.setItem(storagePrefix + "card_" + cardId + "_raison_attente_active", "false");
          localStorage.removeItem(storagePrefix + "card_" + cardId + "_attente_dept");
          localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_alert_active", "false");
        }catch(e){}
        
        // Retirer le clignotement de la représentante
        const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(representantPill){
          representantPill.classList.remove("representant-alert");
          try{
            localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "false");
          }catch(e){}
        }
        
        // Retirer le clignotement de la bordure rouge de la carte
        card.classList.remove("attente-alert-active");
        card.classList.remove("attention-needed");
        
        console.log("⚪ Pas d'alerte pour cette raison: " + value);
      }
    } else {
      currentMenuTarget.textContent = value;
      
      // ===== PRÉSERVER LE CLIGNOTEMENT REPRÉSENTANTE DANS COLONNE EN ATTENTE =====
      // Si on change la représentante et que la carte est dans "En attente", garder le clignotement SI la raison le nécessite
      if(currentMenuField === "representant"){
        const col = card.closest(".col");
        if(col){
          const board = document.querySelector(".board");
          const columns = Array.from(board.querySelectorAll(".col"));
          const colIndex = columns.indexOf(col);
          
          // Colonne 7 = En attente - vérifier si la raison nécessite une alerte
          if(colIndex === 7 && cardNecessiteAlerte(card)){
            currentMenuTarget.classList.add("representant-alert");
            try{
              localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "true");
            }catch(e){}
            console.log("🔴 Clignotement représentante PRÉSERVÉ après changement de nom - carte en En attente");
          }
        }
      }
    }
    
    if (currentMenuField === "region"){
      applyRegionTheme(card, value);
    }
    
    // Sauvegarder la valeur (pour employés, sauvegarder le texte complet avec "En production")
    let valueToSave = value;
    if(currentMenuField.startsWith("employe_")){
      const icons = {
        "employe_robot": "⚙️",
        "employe_degauchage": "🪚",
        "employe_atelier": "📐",
        "employe_couture": "🧵",
        "employe_peinture": "🎨"
      };
      const icon = icons[currentMenuField] || "";
      // Nettoyer d'abord les icônes existantes de la valeur pour éviter duplication
      let cleanValue = value.replace(/^[⚙️🪚👔📐🧵🎨🤖🏭❤️♿🚚]+\s*/g, '').trim();
      // Enlever aussi " - En production" si présent
      cleanValue = cleanValue.replace(/\s*-\s*En production$/i, '').trim();
      valueToSave = icon + " " + cleanValue + " - En production";
    }
    
    try{
      localStorage.setItem(storagePrefix + "card_" + cardId + "_" + currentMenuField, valueToSave);
    }catch(e){console.warn("Failed to save menu value:", e);}
    
    // ===== SAUVEGARDE SUR FIREBASE =====
    console.log("🔍 DEBUG: isFirebaseMode=" + isFirebaseMode + ", saveCardFieldToFirebase=" + (typeof saveCardFieldToFirebase));
    if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
      // Sauvegarder la valeur du champ (avec texte complet pour employés)
      saveCardFieldToFirebase(cardId, currentMenuField, valueToSave);
      console.log("💾 Firebase: Sauvegarde " + currentMenuField + " = " + valueToSave + " pour carte " + cardId);
      
      // Pour les employés, sauvegarder aussi l'état actif (simplifié)
      if(currentMenuField.startsWith("employe_")){
        saveCardFieldToFirebase(cardId, currentMenuField + "_active", true);
      }
      
      // Pour la raison d'attente, sauvegarder avec la clé camelCase ET les états d'alerte
      if(currentMenuField === "raison_attente"){
        // Sauvegarder aussi en camelCase pour la compatibilité
        saveCardFieldToFirebase(cardId, "raisonAttente", value);
        console.log("💾 Firebase: Sauvegarde raisonAttente = " + value);
        
        // Sauvegarder le département correspondant
        const deptForRaison = getDeptFromRaison(value);
        if(deptForRaison){
          saveCardFieldToFirebase(cardId, "attenteDept", deptForRaison);
          console.log("💾 Firebase: Sauvegarde attenteDept = " + deptForRaison);
        }
        
        if(raisonNecessiteAlerte(value)){
          saveCardFieldToFirebase(cardId, "raisonAttenteActive", true);
          saveCardFieldToFirebase(cardId, "representantAlert", true);
          saveCardFieldToFirebase(cardId, "attenteAlertActive", true);
          saveCardFieldToFirebase(cardId, "attenteActive", true);
          console.log("💾 Firebase: Alertes activées pour raison: " + value);
        } else {
          saveCardFieldToFirebase(cardId, "raisonAttenteActive", false);
          saveCardFieldToFirebase(cardId, "representantAlert", false);
          saveCardFieldToFirebase(cardId, "attenteAlertActive", false);
          saveCardFieldToFirebase(cardId, "attenteActive", false);
        }
      }
      
      console.log("💾 Firebase: Champ " + currentMenuField + " sauvegardé pour carte " + cardId);
    } else {
      console.warn("⚠️ Firebase NON ACTIF - isFirebaseMode=" + isFirebaseMode);
    }
    
    closeMenu();
  }

  vpAdd.addEventListener("click", function(){
    const field = currentMenuField;
    if (!field) return;
    const v = vpNewValue.value.trim();
    if (!v) return;
    const items = loadOptions(field);
    if (!items.includes(v)){
      items.push(v);
      optionCache[field] = items;
      saveOptions(field);
      renderOptions(field);
      vpNewValue.value = "";
    }
  });

  vpDelete.addEventListener("click", function(){
    const field = currentMenuField;
    if (!field){
      alert("Veuillez ouvrir un menu d'abord");
      return;
    }
    
    // Demander quelle valeur supprimer
    const items = loadOptions(field);
    if(items.length === 0){
      alert("Aucune valeur à supprimer dans cette liste");
      return;
    }
    
    const valueToDelete = prompt("Entrez la valeur exacte à supprimer de la liste:\n\nValeurs disponibles:\n" + items.join("\n"));
    if(!valueToDelete || valueToDelete.trim() === "") return;
    
    if(items.includes(valueToDelete.trim())){
      if(confirm('Supprimer "' + valueToDelete.trim() + '" de la liste ?')){
        let newItems = items.filter(x => x !== valueToDelete.trim());
        optionCache[field] = newItems;
        saveOptions(field);
        renderOptions(field);
        console.log("🗑️ Valeur supprimée de la liste: " + valueToDelete.trim());
      }
    } else {
      alert("Valeur non trouvée dans la liste");
    }
  });

  vpClose.addEventListener("click", function(){
    closeMenu();
  });

  vpOverlay.addEventListener("click", function(e){
    if (e.target === vpOverlay){
      closeMenu();
    }
  });

  // Menu pill click - utilisant la délégation d'événements pour tous les menus
  document.addEventListener("click", function(e){
    // Vérifier si on n'est pas dans un overlay
    if(e.target.closest(".vp-overlay") || 
       e.target.closest(".move-overlay") || 
       e.target.closest(".calendar-overlay") ||
       e.target.closest(".photo-links-overlay") ||
       e.target.closest(".login-overlay") ||
       e.target.closest(".firebase-setup-overlay")){
      return;
    }
    
    // EXCLUSION: Ne pas intercepter le bouton Expédition
    if(e.target.closest(".mcard-expedition-btn")){
      return; // Laisser le handler d'expédition gérer ce clic
    }
    
    const pill = e.target.closest(".mcard-menu");
    if (pill){
      // Si c'est une pastille employé qui clignote, ne pas ouvrir le menu
      // (le toggle du clignotement sera géré par un autre handler)
      if(pill.classList.contains("mcard-employee-label") && pill.classList.contains("employee-active")){
        return; // Laisser le handler de toggle gérer ce clic
      }
      
      e.preventDefault();
      e.stopPropagation();
      const field = pill.dataset.menuField;
      if (field){
        console.log("📋 Ouverture menu: " + field);
        openMenu(field, pill);
      }
    }
  }, true); // Capture phase pour être sûr d'attraper l'événement

  // Expedition button handling
  document.addEventListener("click", function(e){
    const expeditionBtn = e.target.closest(".mcard-expedition-btn");
    if (expeditionBtn && !expeditionBtn.classList.contains("expedited")){
      const card = expeditionBtn.closest(".mcard");
      const cardId = card ? card.dataset.cardId : "0";
      const now = new Date();
      const dateStr = now.getFullYear() + "-" + 
                      String(now.getMonth() + 1).padStart(2, '0') + "-" + 
                      String(now.getDate()).padStart(2, '0');
      const timeStr = String(now.getHours()).padStart(2, '0') + ":" + 
                      String(now.getMinutes()).padStart(2, '0');
      
      expeditionBtn.textContent = "🚚 Expédié - " + dateStr + " " + timeStr;
      expeditionBtn.classList.add("expedited");
      
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_expedition_status", "expedited");
        localStorage.setItem(storagePrefix + "card_" + cardId + "_expedition_date", dateStr + " " + timeStr);
      }catch(e){console.warn("Failed to save expedition status:", e);}
      
      // Sauvegarder sur Firebase
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(cardId, "expeditionStatus", "expedited");
        saveCardFieldToFirebase(cardId, "expeditionDate", dateStr + " " + timeStr);
        console.log("💾 Firebase: Expédition sauvegardée pour carte " + cardId);
      }
    }
  });

  // Restore saved menu selections
  cards.forEach(card => {
    const cardId = card.dataset.cardId;
    ["region","client","intervenant","representant","employe_robot","employe_degauchage","employe_atelier","employe_couture","employe_peinture","raison_attente"].forEach(field => {
      const pill = card.querySelector('.mcard-menu[data-menu-field="'+field+'"]');
      if (!pill) return;
      try{
        const stored = localStorage.getItem(storagePrefix + "card_" + cardId + "_" + field);
        if (stored){
          pill.textContent = stored;
          if (field === "region"){
            applyRegionTheme(card, stored);
          }
          
          // Restaurer le clignotement rouge pour "raison_attente"
          // SEULEMENT si la carte est dans la colonne "En attente" (colonne 7)
          if (field === "raison_attente"){
            const col = card.closest(".col");
            const board = document.querySelector(".board");
            const cols = Array.from(board.querySelectorAll(".col"));
            const currentColIndex = cols.indexOf(col);
            
            // Ne restaurer QUE si la carte est dans la colonne En attente
            if(currentColIndex === 7){
              const activeState = localStorage.getItem(storagePrefix + "card_" + cardId + "_raison_attente_active");
              if(activeState === "true"){
                pill.classList.add("attente-active");
                // Restaurer aussi le clignotement de la bordure
                card.classList.add("attente-alert-active");
                card.classList.add("in-attente-column");
              }
            } else {
              // La carte n'est plus dans En attente, nettoyer le localStorage
              localStorage.setItem(storagePrefix + "card_" + cardId + "_raison_attente_active", "false");
              localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_alert_active", "false");
              localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "false");
            }
          }
          
          // Restaurer le clignotement rouge pour "representant"
          // SEULEMENT si la carte est dans la colonne "En attente" (colonne 7)
          if (field === "representant"){
            const col = card.closest(".col");
            const board = document.querySelector(".board");
            const cols = Array.from(board.querySelectorAll(".col"));
            const currentColIndex = cols.indexOf(col);
            
            // Ne restaurer QUE si la carte est dans la colonne En attente
            if(currentColIndex === 7){
              const alertState = localStorage.getItem(storagePrefix + "card_" + cardId + "_representant_alert");
              if(alertState === "true"){
                pill.classList.add("representant-alert");
              }
            }
          }
          
          // Restaurer le clignotement vert et la bordure pour les employés actifs
          // SEULEMENT si la carte est dans la colonne correspondante
          if (field.startsWith("employe_")){
            const activeState = localStorage.getItem(storagePrefix + "card_" + cardId + "_" + field + "_active");
            if(activeState === "true"){
              // Vérifier que la carte est dans la bonne colonne pour ce champ
              const col = card.closest(".col");
              const board = document.querySelector(".board");
              const cols = Array.from(board.querySelectorAll(".col"));
              const currentColIndex = cols.indexOf(col);
              
              // Mapping champ employé → index de colonne
              const fieldToColumnMap = {
                "employe_robot": 0,
                "employe_degauchage": 1,
                "employe_atelier": 3,
                "employe_couture": 4,
                "employe_peinture": 5
              };
              
              const expectedColumn = fieldToColumnMap[field];
              
              // Ne restaurer le clignotement QUE si la carte est dans la bonne colonne
              if(currentColIndex === expectedColumn){
                pill.classList.add("employee-active");
              } else {
                // La carte a changé de colonne, nettoyer l'état
                localStorage.setItem(storagePrefix + "card_" + cardId + "_" + field + "_active", "false");
              }
            }
          }
        }
      }catch(e){console.warn("Failed to restore menu selection:", e);}
    });
    
    // Restore expedition status
    const expeditionBtn = card.querySelector(".mcard-expedition-btn");
    if (expeditionBtn){
      try{
        const status = localStorage.getItem(storagePrefix + "card_" + cardId + "_expedition_status");
        const date = localStorage.getItem(storagePrefix + "card_" + cardId + "_expedition_date");
        if (status === "expedited" && date){
          expeditionBtn.textContent = "🚚 Expédié - " + date;
          expeditionBtn.classList.add("expedited");
        }
      }catch(e){console.warn("Failed to restore expedition status:", e);}
    }
  });
})();

// ===== MOVE MENU SYSTEM =====
(function(){
  const moveOverlay = document.getElementById("moveOverlay");
  const moveColumns = document.getElementById("moveColumns");
  const moveClose = document.getElementById("moveClose");
  
  const COLUMN_NAMES = [
    "Robot",
    "Dégauchage", 
    "Essayage",
    "Atelier",
    "Couture",
    "Peinture",
    "Expédition",
    "En attente"
  ];
  
  let currentCardToMove = null;
  let selectedColumn = null;
  let selectedPosition = null;
  
  function openMoveMenu(card){
    currentCardToMove = card;
    selectedColumn = null;
    selectedPosition = null;
    
    // Get all columns
    const board = document.querySelector(".board");
    const columns = Array.from(board.querySelectorAll(".col"));
    
    // Build move menu
    moveColumns.innerHTML = "";
    
    columns.forEach((col, colIndex) => {
      const cards = Array.from(col.querySelectorAll(".mcard"));
      const cardCount = cards.length;
      
      // Create column container
      const moveCol = document.createElement("div");
      moveCol.className = "move-column";
      
      // Column header
      const header = document.createElement("div");
      header.className = "move-column-header";
      header.textContent = COLUMN_NAMES[colIndex];
      header.dataset.columnIndex = colIndex;
      
      header.addEventListener("click", function(){
        // Remove previous selection
        moveColumns.querySelectorAll(".move-column-header").forEach(h => {
          h.classList.remove("selected");
        });
        header.classList.add("selected");
        selectedColumn = colIndex;
      });
      
      moveCol.appendChild(header);
      
      // Position buttons container
      const positions = document.createElement("div");
      positions.className = "move-positions";
      
      // Afficher cardCount + 1 positions (si 0 cartes → position 1, si 2 cartes → positions 1,2,3)
      const maxPosition = cardCount + 1;
      for(let pos = 1; pos <= maxPosition; pos++){
        const posBtn = document.createElement("div");
        posBtn.className = "move-position-btn";
        posBtn.textContent = pos;
        posBtn.dataset.position = pos;
        posBtn.dataset.columnIndex = colIndex;
        
        posBtn.addEventListener("click", function(){
          selectedColumn = colIndex;
          selectedPosition = pos;
          
          // Remove previous selections
          moveColumns.querySelectorAll(".move-position-btn").forEach(btn => {
            btn.classList.remove("selected");
          });
          moveColumns.querySelectorAll(".move-column-header").forEach(h => {
            h.classList.remove("selected");
          });
          
          // Mark selected
          posBtn.classList.add("selected");
          moveColumns.querySelector('.move-column-header[data-column-index="'+colIndex+'"]').classList.add("selected");
          
          // Execute move
          executeMoveCard(currentCardToMove, colIndex, pos);
        });
        
        positions.appendChild(posBtn);
      }
      
      moveCol.appendChild(positions);
      moveColumns.appendChild(moveCol);
    });
    
    moveOverlay.classList.remove("hidden");
  }
  
  function closeMoveMenu(){
    moveOverlay.classList.add("hidden");
    currentCardToMove = null;
    selectedColumn = null;
    selectedPosition = null;
  }
  
  function executeMoveCard(card, targetColumnIndex, position){
    const board = document.querySelector(".board");
    const columns = Array.from(board.querySelectorAll(".col"));
    const targetColumn = columns[targetColumnIndex];
    const cardsInTarget = Array.from(targetColumn.querySelectorAll(".mcard"));
    
    // Save card ID before move
    const cardId = card.dataset.cardId;
    const storagePrefix = "physipro_v280_";
    
    // ===== TRACKING: Détecter l'ancienne colonne AVANT le déplacement =====
    const oldCol = card.closest(".col");
    const oldColIndex = oldCol ? columns.indexOf(oldCol) : -1;
    console.log(`🔄 MOVE: Card ${cardId} de colonne ${oldColIndex} vers colonne ${targetColumnIndex}`);
    
    // ===== DÉSACTIVER LE CLIGNOTEMENT VERT QUAND LA CARTE CHANGE DE COLONNE =====
    if(oldColIndex !== targetColumnIndex){
      // Désactiver l'état "En production" de l'employé SEULEMENT
      const employeePill = card.querySelector(".mcard-employee-label.employee-active");
      if(employeePill){
        employeePill.classList.remove("employee-active");
        const currentText = employeePill.textContent;
        employeePill.textContent = currentText.replace(" - En production", "");
      }
      // Nettoyer le localStorage
      try{
        const employeeFields = ["employe_robot", "employe_degauchage", "employe_atelier", "employe_couture", "employe_peinture"];
        employeeFields.forEach(field => {
          localStorage.setItem(storagePrefix + "card_" + cardId + "_" + field + "_active", "false");
        });
      }catch(e){}
      console.log("🟢 Clignotement vert employé désactivé - carte a changé de colonne");
    }
    
    // ===== GESTION DE LA COLONNE "EN ATTENTE" (colonne 7) =====
    // Si on SORT de "En attente" → DÉSACTIVER TOUS les clignotements rouges et NETTOYER TOUT
    if(oldColIndex === 7 && targetColumnIndex !== 7){
      console.log("🔴➡️⚪ SORTIE de En attente - Nettoyage COMPLET en cours...");
      
      // 1. Retirer TOUTES les classes liées à "En attente"
      card.classList.remove("in-attente-column");
      card.classList.remove("attente-alert-active");
      card.classList.remove("attention-needed");
      
      // 2. Retirer le clignotement de la représentante
      const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
      if(representantPill){
        representantPill.classList.remove("representant-alert");
      }
      
      // 3. Retirer le clignotement de la pastille En attente - Raison
      const attentePill = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
      if(attentePill){
        attentePill.classList.remove("attente-active");
      }
      
      // 4. Remettre la pastille de délai en mode normal (Délai restant)
      const delayPill = card.querySelector('.mcard-delay-pill');
      if(delayPill){
        delayPill.classList.remove("attente-active");
        delayPill.dataset.attenteDepuis = "";
        // Remettre le texte "Délai restant" - sera recalculé par updateCountdown
        delayPill.innerHTML = '<span>Délai restant 0 jours</span>';
      }
      
      // 5. Retirer le clignotement rouge de TOUTES les pastilles département
      if(typeof deactivateDeptPillRed === 'function'){
        deactivateDeptPillRed(card);
      }
      
      // 6. NETTOYAGE COMPLET: Enlever TOUTES les classes de clignotement possibles sur TOUTES les pastilles
      const allPills = card.querySelectorAll('.mcard-pill, .mcard-menu');
      allPills.forEach(pill => {
        pill.classList.remove("dept-pill-en-attente");
        pill.classList.remove("attente-active");
        pill.classList.remove("representant-alert");
      });
      
      // 7. Nettoyer le localStorage
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "false");
        localStorage.setItem(storagePrefix + "card_" + cardId + "_raison_attente_active", "false");
        localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_alert_active", "false");
        localStorage.removeItem(storagePrefix + "card_" + cardId + "_attente_dept");
        localStorage.removeItem(storagePrefix + "card_" + cardId + "_raison_attente");
        localStorage.removeItem(storagePrefix + "card_" + cardId + "_attente_depuis");
      }catch(e){}
      
      // 8. IMPORTANT: Effacer TOUTES les alertes sur Firebase pour éviter qu'elles se réactivent
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(cardId, "raisonAttente", null);
        saveCardFieldToFirebase(cardId, "raison_attente", null);
        saveCardFieldToFirebase(cardId, "raisonAttenteActive", false);
        saveCardFieldToFirebase(cardId, "representantAlert", false);
        saveCardFieldToFirebase(cardId, "attenteAlertActive", false);
        saveCardFieldToFirebase(cardId, "attenteActive", false);
        saveCardFieldToFirebase(cardId, "attenteDept", null);
        saveCardFieldToFirebase(cardId, "attenteDepuis", null);
      }
      
      console.log("✅ Carte " + cardId + " sortie de En attente - TOUT nettoyé (classes, localStorage, Firebase)");
      
      // Recalculer le délai restant pour cette carte
      if(typeof window.updateCardCountdown === 'function'){
        window.updateCardCountdown(cardId);
      }
    }
    
    // Si on ENTRE dans "En attente" → Transformer la pastille en "En attente depuis X jours"
    if(targetColumnIndex === 7 && oldColIndex !== 7){
      card.classList.add("in-attente-column");
      
      // Sauvegarder la date d'entrée (format ISO pour calcul)
      const now = new Date();
      const dateISO = now.toISOString().split('T')[0]; // YYYY-MM-DD
      
      // Trouver la pastille de délai et la transformer
      const delayPill = card.querySelector('.mcard-delay-pill');
      if(delayPill){
        delayPill.dataset.attenteDepuis = dateISO;
        delayPill.innerHTML = 'En attente depuis&nbsp;<span class="jours-nombre">0</span>&nbsp;jour';
      }
      
      // Sauvegarder la date ISO pour calcul ultérieur
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_depuis", dateISO);
      }catch(e){}
      
      // Sauvegarder sur Firebase
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(cardId, "attenteDepuis", dateISO);
      }
      
      console.log("📋 Carte arrivée en En attente - Date: " + dateISO);
    }
    
    // ===== TRACKING: Enregistrer la SORTIE de l'ancienne colonne =====
    if(oldColIndex >= 0 && oldColIndex !== targetColumnIndex){
      if(typeof window.trackDepartmentExit === 'function'){
        window.trackDepartmentExit(cardId, oldColIndex, card);
      }
    }
    
    // Remove card from current position
    card.remove();
    
    // Insert at specified position
    if(position <= 1 || cardsInTarget.length === 0){
      // Insert at beginning (after colheader)
      const colheader = targetColumn.querySelector(".colheader");
      colheader.insertAdjacentElement("afterend", card);
    } else if(position > cardsInTarget.length){
      // Insert at end
      targetColumn.appendChild(card);
    } else {
      // Insert before the card at position
      const refCard = cardsInTarget[position - 1];
      refCard.insertAdjacentElement("beforebegin", card);
    }
    
    // ===== TRACKING: Enregistrer l'ENTRÉE dans la nouvelle colonne =====
    if(oldColIndex !== targetColumnIndex){
      if(typeof window.trackDepartmentEntry === 'function'){
        window.trackDepartmentEntry(cardId, targetColumnIndex);
      }
    }
    
    // Update employee pill based on new column
    updateEmployeePillForColumn(card, targetColumnIndex);
    
    // Restore expedition status if it exists (PERMANENT)
    const expeditionBtn = card.querySelector(".mcard-expedition-btn");
    if(expeditionBtn){
      try{
        const status = localStorage.getItem("physipro_v280_card_" + cardId + "_expedition_status");
        const date = localStorage.getItem("physipro_v280_card_" + cardId + "_expedition_date");
        if(status === "expedited" && date){
          expeditionBtn.textContent = "🚚 Expédié - " + date;
          expeditionBtn.classList.add("expedited");
        }
      }catch(e){console.warn("Failed to restore expedition status after move:", e);}
    }
    
    // Update card counts
    updateAllColumnCounts();
    
    // ===== FIREBASE: Sauvegarder le déplacement =====
    if(isFirebaseMode && firebaseDb){
      // Calculer la nouvelle position
      const newCardsInColumn = Array.from(targetColumn.querySelectorAll(".mcard"));
      const newPosition = newCardsInColumn.indexOf(card);
      
      // Extraire toutes les données de la carte et sauvegarder
      const cardData = extractCardData(card);
      cardData.column = targetColumnIndex;
      cardData.position = newPosition;
      cardData.updatedAt = Date.now();
      cardData.updatedBy = currentUser ? currentUser.name : "Inconnu";
      
      saveCardToFirebase(cardId, cardData);
      console.log(`💾 Déplacement sauvegardé sur Firebase: ${cardId} → colonne ${targetColumnIndex}`);
    }
    
    // ===== TRACKING: Rafraîchir les visuels =====
    if(typeof window.refreshTrackingVisuals === 'function'){
      setTimeout(() => window.refreshTrackingVisuals(cardId), 100);
    }
    
    // Close menu
    closeMoveMenu();
  }
  
  function updateEmployeePillForColumn(card, columnIndex){
    const footer = card.querySelector(".mcard-footer");
    if(!footer) return;
    
    // Remove ALL old employee/status/attente elements (TRÈS complet)
    // Inclure tous les sélecteurs possibles pour la pastille raison attente
    const oldElements = footer.querySelectorAll(".mcard-employee-label, .mcard-attente-reason, .attente-raison-pill, [data-menu-field='raison_attente']");
    oldElements.forEach(el => {
      console.log("🗑️ Suppression de:", el.className, el.textContent.substring(0, 30));
      el.remove();
    });
    
    // AUSSI: Nettoyer toutes les classes de clignotement rouge sur la carte si on ne va PAS vers En attente
    if(columnIndex !== 7){
      card.classList.remove("in-attente-column");
      card.classList.remove("attente-alert-active");
      card.classList.remove("attention-needed");
      
      // Remettre la pastille de délai en mode normal
      const delayPill = card.querySelector('.mcard-delay-pill');
      if(delayPill){
        delayPill.classList.remove("attente-active");
        delayPill.dataset.attenteDepuis = "";
        if(delayPill.innerHTML.includes("En attente")){
          delayPill.innerHTML = '<span>Délai restant 0 jours</span>';
        }
      }
      
      // Retirer le clignotement de la représentante
      const repPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
      if(repPill) repPill.classList.remove("representant-alert");
      
      // Retirer le clignotement rouge de TOUS les départements
      const allPills = card.querySelectorAll('.mcard-pill, .mcard-menu');
      allPills.forEach(pill => {
        pill.classList.remove("dept-pill-en-attente");
        pill.classList.remove("attente-active");
        pill.classList.remove("representant-alert");
      });
      
      // Nettoyer le localStorage de la raison attente
      const cardId = card.dataset.cardId;
      try{
        localStorage.removeItem("physipro_v280_card_" + cardId + "_raison_attente");
        localStorage.setItem("physipro_v280_card_" + cardId + "_raison_attente_active", "false");
      }catch(e){}
    }
    
    // Column mapping with icons and fields
    const columnConfig = {
      0: { icon: "⚙️", label: "Robot – Employés", field: "employe_robot", type: "menu" },
      1: { icon: "🪚", label: "Dégauchage – Employés", field: "employe_degauchage", type: "menu" },
      2: { icon: "♿", label: "En Essayage", field: "essayage", type: "status" },
      3: { icon: "📐", label: "Atelier – Employés", field: "employe_atelier", type: "menu" },
      4: { icon: "🧵", label: "Couture – Employés", field: "employe_couture", type: "menu" },
      5: { icon: "🎨", label: "Peinture – Employés", field: "employe_peinture", type: "menu" },
      6: { icon: "🚚", label: "Expédition", field: "expedition", type: "expedition" },
      7: { icon: "", label: "En attente - Raison", field: "raison_attente", type: "waiting" }
    };
    
    const config = columnConfig[columnIndex];
    if(!config) return;
    
    const notesLabel = footer.querySelector(".mcard-notes-label");
    const cardId = card.dataset.cardId;
    
    // Create new employee/status element
    const newElement = document.createElement("div");
    newElement.className = "mcard-employee-label";
    
    if(config.type === "menu"){
      // Regular employee menu
      newElement.classList.add("mcard-menu");
      newElement.dataset.menuField = config.field;
      newElement.textContent = config.icon + " " + config.label;
      
      // Restore saved value (mais PAS l'état actif car la carte vient de changer de colonne)
      try{
        const stored = localStorage.getItem("physipro_v280_card_" + cardId + "_" + config.field);
        if(stored){
          // Nettoyer les icônes existantes avant d'ajouter la nouvelle
          // pour éviter l'accumulation d'icônes lors des déplacements multiples
          let cleanedValue = stored.replace(/^[⚙️🪚👔📐🧵🎨🤖🏭❤️♿🚚]+\s*/g, '').trim();
          // Ne PAS restaurer le clignotement car la carte vient de bouger
          // L'utilisateur devra re-sélectionner "En production"
          newElement.textContent = config.icon + " " + cleanedValue;
        }
      }catch(e){}
      
    } else if(config.type === "status"){
      // Essayage - with wheelchair icon
      newElement.dataset.statusField = config.field;
      newElement.textContent = config.icon + " " + config.label;
      
    } else if(config.type === "expedition"){
      // Expedition button
      newElement.classList.add("mcard-expedition-btn");
      newElement.dataset.statusField = config.field;
      
      // Check if already expedited
      try{
        const status = localStorage.getItem("physipro_v280_card_" + cardId + "_expedition_status");
        const date = localStorage.getItem("physipro_v280_card_" + cardId + "_expedition_date");
        if(status === "expedited" && date){
          newElement.textContent = "🚚 Expédié - " + date;
          newElement.classList.add("expedited");
        } else {
          newElement.textContent = config.icon + " " + config.label;
        }
      }catch(e){
        newElement.textContent = config.icon + " " + config.label;
      }
      
    } else if(config.type === "waiting"){
      // En attente - red menu
      newElement.classList.add("mcard-menu", "mcard-attente-reason");
      newElement.dataset.menuField = config.field;
      newElement.textContent = config.label;
      
      // NE PAS restaurer la valeur sauvegardée - laisser l'utilisateur choisir une nouvelle raison
      // car on vient d'arriver dans En attente
    }
    
    // Insert before notes label
    if(notesLabel){
      notesLabel.insertAdjacentElement("beforebegin", newElement);
    } else {
      footer.insertBefore(newElement, footer.firstChild);
    }
  }
  
  function updateAllCardCounts(){
    const board = document.querySelector(".board");
    const columns = Array.from(board.querySelectorAll(".col"));
    
    columns.forEach(col => {
      const header = col.querySelector(".colheader");
      const countSpan = header.querySelector(".col-count");
      const cards = col.querySelectorAll(".mcard");
      if(countSpan){
        countSpan.textContent = cards.length;
      }
    });
  }
  
  // Close button
  moveClose.addEventListener("click", closeMoveMenu);
  
  // Close on overlay click
  moveOverlay.addEventListener("click", function(e){
    if(e.target === moveOverlay){
      closeMoveMenu();
    }
  });
  
  // Move button clicks
  document.addEventListener("click", function(e){
    const moveBtn = e.target.closest(".mcard-btn-move");
    if(moveBtn){
      const card = moveBtn.closest(".mcard");
      if(card){
        openMoveMenu(card);
      }
    }
  });
  
  // Expose executeMoveCard globally for department tracking
  window.executeMoveCard = executeMoveCard;
})();

// ===== CALENDAR SYSTEM =====
(function(){
  const calendarOverlay = document.getElementById("calendarOverlay");
  const calendarPanel = document.getElementById("calendarPanel");
  const calendarGrid = document.getElementById("calendarGrid");
  const calMonthYear = document.getElementById("calMonthYear");
  const calPrevMonth = document.getElementById("calPrevMonth");
  const calNextMonth = document.getElementById("calNextMonth");
  
  let currentCalendarDate = new Date();
  let targetDatePill = null;
  let targetCardId = null;
  let targetDateField = null;
  
  const MONTHS = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  const DAYS = ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"];
  
  function openCalendar(pill, cardId, dateField){
    targetDatePill = pill;
    targetCardId = cardId;
    targetDateField = dateField;
    
    // Get current value if exists
    const currentValue = pill.textContent;
    if(currentValue && currentValue !== "AAAA-MM-JJ" && !currentValue.includes("i")){
      try{
        const parts = currentValue.split("-");
        if(parts.length === 3){
          currentCalendarDate = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
        }
      }catch(e){}
    } else {
      currentCalendarDate = new Date();
    }
    
    renderCalendar();
    calendarOverlay.classList.remove("hidden");
  }
  
  function closeCalendar(){
    calendarOverlay.classList.add("hidden");
    targetDatePill = null;
    targetCardId = null;
    targetDateField = null;
  }
  
  function renderCalendar(){
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    calMonthYear.textContent = MONTHS[month] + " " + year;
    
    calendarGrid.innerHTML = "";
    
    // Day headers
    DAYS.forEach(day => {
      const header = document.createElement("div");
      header.className = "calendar-day-header";
      header.textContent = day;
      calendarGrid.appendChild(header);
    });
    
    // First day of month
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const firstDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    const today = new Date();
    const todayStr = today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,'0') + "-" + String(today.getDate()).padStart(2,'0');
    
    // Empty cells before first day
    for(let i = 0; i < firstDayOfWeek; i++){
      const emptyDay = document.createElement("div");
      emptyDay.className = "calendar-day empty";
      calendarGrid.appendChild(emptyDay);
    }
    
    // Days of month
    for(let day = 1; day <= daysInMonth; day++){
      const dayDiv = document.createElement("div");
      dayDiv.className = "calendar-day";
      dayDiv.textContent = day;
      
      const dateStr = year + "-" + String(month+1).padStart(2,'0') + "-" + String(day).padStart(2,'0');
      
      if(dateStr === todayStr){
        dayDiv.classList.add("today");
      }
      
      dayDiv.addEventListener("click", function(){
        selectDate(year, month, day);
      });
      
      calendarGrid.appendChild(dayDiv);
    }
  }
  
  function selectDate(year, month, day){
    const dateStr = year + "-" + String(month+1).padStart(2,'0') + "-" + String(day).padStart(2,'0');
    
    if(targetDatePill && targetCardId && targetDateField){
      targetDatePill.classList.add("has-date");
      targetDatePill.textContent = dateStr;
      
      // Save to localStorage
      try{
        localStorage.setItem("physipro_v280_card_" + targetCardId + "_" + targetDateField, dateStr);
      }catch(e){console.warn("Failed to save date:", e);}
      
      // Sauvegarder sur Firebase
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        // Convertir date-recue en dateRecue, date-robot en dateRobot
        const firebaseField = targetDateField.replace("-", "").replace("recue", "Recue").replace("robot", "Robot");
        saveCardFieldToFirebase(targetCardId, firebaseField, dateStr);
        console.log("💾 Firebase: Date " + targetDateField + " sauvegardée pour carte " + targetCardId);
      }
      
      // Update hidden input
      const wrapper = targetDatePill.closest(".date-wrapper");
      if(wrapper){
        const input = wrapper.querySelector(".date-input");
        if(input) input.value = dateStr;
      }
      
      // If this is date_robot, trigger countdown calculation
      if(targetDateField === "date-robot"){
        updateCountdown(targetCardId);
      }
    }
    
    closeCalendar();
  }
  
  calPrevMonth.addEventListener("click", function(){
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
  });
  
  calNextMonth.addEventListener("click", function(){
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
  });
  
  calendarOverlay.addEventListener("click", function(e){
    if(e.target === calendarOverlay){
      closeCalendar();
    }
  });
  
  // Intercept date pill clicks
  document.addEventListener("click", function(e){
    const datePill = e.target.closest(".mcard-pill-date");
    if(datePill){
      e.stopPropagation();
      const wrapper = datePill.closest(".date-wrapper");
      if(wrapper){
        const card = datePill.closest(".mcard");
        const cardId = card ? card.dataset.cardId : "0";
        const dateField = wrapper.dataset.dateField || "date";
        openCalendar(datePill, cardId, dateField);
      }
    }
  });
})();

// ===== ADD CARD SYSTEM =====
(function(){
  const addCardBtn = document.getElementById("addCardBtn");
  const board = document.querySelector(".board");
  
  if(addCardBtn){
    addCardBtn.addEventListener("click", function(){
      console.log("🔘 Bouton Ajouter cliqué");
      console.log("   _sessionValid:", _sessionValid);
      console.log("   isFirebaseMode:", isFirebaseMode);
      console.log("   firebaseDb:", !!firebaseDb);
      console.log("   currentUser:", currentUser);
      
      // Vérifier si connecté
      if(!_sessionValid){
        alert("Vous devez être connecté pour ajouter une carte");
        return;
      }
      
      // Get Robot column (first column)
      const columns = Array.from(board.querySelectorAll(".col"));
      const robotColumn = columns[0];
      if(!robotColumn) return;
      
      // Générer un ID unique
      const newCardId = generateUniqueCardId();
      
      // Créer les données de la carte
      const cardData = {
        column: 0,
        position: 0,
        title: "Nouveau Moulage",
        order: "000000",
        notes: "",
        createdAt: Date.now(),
        createdBy: currentUser ? currentUser.name : "Inconnu",
        updatedAt: Date.now(),
        updatedBy: currentUser ? currentUser.name : "Inconnu"
      };
      
      // Si Firebase est connecté, sauvegarder sur Firebase (la carte sera créée via listener)
      if(isFirebaseMode && firebaseDb){
        console.log("📤 Tentative de sauvegarde sur Firebase...");
        saveCardToFirebase(newCardId, cardData);
        console.log(`✅ Nouvelle carte créée sur Firebase: ID ${newCardId}`);
      } else {
        // Mode hors ligne: créer localement
        console.log("📴 Mode hors ligne - création locale");
        const newCard = createOrUpdateCardFromData(newCardId, cardData);
        updateAllColumnCounts();
        console.log(`✅ Nouvelle carte créée localement: ID ${newCardId}`);
      }
    });
  }
})();

// ===== DELETE CARD SYSTEM =====
(function(){
  const deleteConfirmOverlay = document.getElementById("deleteConfirmOverlay");
  const deleteConfirmYes = document.getElementById("deleteConfirmYes");
  const deleteConfirmNo = document.getElementById("deleteConfirmNo");
  let cardToDelete = null;
  
  function showDeleteConfirmation(card){
    cardToDelete = card;
    deleteConfirmOverlay.classList.remove("hidden");
  }
  
  function hideDeleteConfirmation(){
    deleteConfirmOverlay.classList.add("hidden");
    cardToDelete = null;
  }
  
  function deleteCard(){
    if(!cardToDelete) return;
    
    const cardId = cardToDelete.dataset.cardId;
    const col = cardToDelete.closest(".col");
    
    // ===== SAVE TO LOG BEFORE DELETION =====
    try{
      const logData = extractCardDataForLog(cardToDelete);
      saveToLog(logData);
      console.log(`📋 Card ${cardId} data saved to log before deletion`);
    }catch(e){
      console.warn("Failed to save card to log:", e);
    }
    
    // ===== SUPPRIMER DE FIREBASE =====
    if(isFirebaseMode && firebaseDb){
      deleteCardFromFirebase(cardId);
      // La carte sera supprimée via le listener Firebase
    } else {
      // Mode hors ligne: supprimer localement
      cardToDelete.remove();
      updateAllColumnCounts();
    }
    
    // Clean up localStorage for this card
    try{
      const storagePrefix = "physipro_v280_";
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if(key.includes("card_" + cardId + "_") || key.includes(cardId)){
          localStorage.removeItem(key);
        }
      });
      console.log(`🗑️ Card ${cardId} deleted`);
    }catch(e){
      console.warn("Failed to clean localStorage:", e);
    }
    
    hideDeleteConfirmation();
  }
  
  // Extract all card data for logging
  function extractCardDataForLog(card){
    const cardId = card.dataset.cardId;
    const storagePrefix = "physipro_v280_";
    
    // Get basic info
    const title = card.querySelector(".mcard-title")?.textContent || "Sans nom";
    const order = card.querySelector(".mcard-order")?.textContent || "N/A";
    
    // Get dates
    const dateRecue = localStorage.getItem(storagePrefix + "card_" + cardId + "_date-recue") || "N/A";
    const dateRobot = localStorage.getItem(storagePrefix + "card_" + cardId + "_date-robot") || "N/A";
    
    // Get menu selections
    const region = card.querySelector('.mcard-menu[data-menu-field="region"]')?.textContent || "Région";
    const client = card.querySelector('.mcard-menu[data-menu-field="client"]')?.textContent || "Client";
    const intervenant = card.querySelector('.mcard-menu[data-menu-field="intervenant"]')?.textContent || "Intervenant";
    const representant = card.querySelector('.mcard-menu[data-menu-field="representant"]')?.textContent || "Représentante";
    
    // Get employees
    const employeRobot = card.querySelector('.mcard-menu[data-menu-field="employe_robot"]')?.textContent.replace("🤖 Robot – ", "").replace("Employés", "N/A") || "N/A";
    const employeDegauchage = card.querySelector('.mcard-menu[data-menu-field="employe_degauchage"]')?.textContent.replace("✂️ Dégauchage – ", "").replace("Employés", "N/A") || "N/A";
    const employeAtelier = card.querySelector('.mcard-menu[data-menu-field="employe_atelier"]')?.textContent.replace("🔨 Atelier – ", "").replace("Employés", "N/A") || "N/A";
    const employeCouture = card.querySelector('.mcard-menu[data-menu-field="employe_couture"]')?.textContent.replace("🧵 Couture – ", "").replace("Employés", "N/A") || "N/A";
    const employePeinture = card.querySelector('.mcard-menu[data-menu-field="employe_peinture"]')?.textContent.replace("🎨 Peinture – ", "").replace("Employés", "N/A") || "N/A";
    
    // Get notes
    const notes = card.querySelector(".mcard-notes-input")?.value || "";
    
    // Get department tracking data
    const deptTracking = {};
    const DEPT_CONFIG_NAMES = ["Robot", "Dégauchage", "Essayage", "Atelier", "Couture", "Peinture", "Expédition", "En attente"];
    
    DEPT_CONFIG_NAMES.forEach(deptName => {
      const trackingData = localStorage.getItem(storagePrefix + "card_" + cardId + "_dept_" + deptName);
      if(trackingData){
        try{
          deptTracking[deptName] = JSON.parse(trackingData);
        }catch(e){
          deptTracking[deptName] = null;
        }
      }
    });
    
    // Get expedition status
    const expeditionStatus = localStorage.getItem(storagePrefix + "card_" + cardId + "_expedition_status") || "non expédié";
    const expeditionDate = localStorage.getItem(storagePrefix + "card_" + cardId + "_expedition_date") || "N/A";
    
    return {
      cardId,
      title,
      order,
      dateRecue,
      dateRobot,
      region,
      client,
      intervenant,
      representant,
      employees: {
        robot: employeRobot,
        degauchage: employeDegauchage,
        atelier: employeAtelier,
        couture: employeCouture,
        peinture: employePeinture
      },
      notes,
      deptTracking,
      expeditionStatus,
      expeditionDate,
      deletedAt: new Date().toISOString()
    };
  }
  
  // Save card data to log
  function saveToLog(cardData){
    const storagePrefix = "physipro_v280_";
    const logKey = storagePrefix + "deletion_log";
    
    try{
      let log = [];
      const existingLog = localStorage.getItem(logKey);
      if(existingLog){
        log = JSON.parse(existingLog);
      }
      
      log.unshift(cardData); // Add to beginning
      
      // Keep only last 500 entries to prevent storage overflow
      if(log.length > 500){
        log = log.slice(0, 500);
      }
      
      localStorage.setItem(logKey, JSON.stringify(log));
    }catch(e){
      console.error("Failed to save to log:", e);
    }
  }
  
  // Yes button
  deleteConfirmYes.addEventListener("click", function(){
    deleteCard();
  });
  
  // No button
  deleteConfirmNo.addEventListener("click", function(){
    hideDeleteConfirmation();
  });
  
  // Close on overlay click
  deleteConfirmOverlay.addEventListener("click", function(e){
    if(e.target === deleteConfirmOverlay){
      hideDeleteConfirmation();
    }
  });
  
  // Delete button clicks
  document.addEventListener("click", function(e){
    const deleteBtn = e.target.closest(".mcard-btn-delete");
    if(deleteBtn){
      const card = deleteBtn.closest(".mcard");
      if(card){
        showDeleteConfirmation(card);
      }
    }
  });
})();

// ===== COUNTDOWN SYSTEM =====
(function(){
  const storagePrefix = "physipro_v280_";
  
  function updateCountdown(cardId){
    const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
    if(!card) return;
    
    // Get region
    const regionPill = card.querySelector('.mcard-menu[data-menu-field="region"]');
    const region = regionPill ? regionPill.textContent.trim() : "";
    
    // Get delay for region
    const delayDays = MENU_DATA.delays[region] || 90;
    
    // Get robot date
    const robotDateStr = localStorage.getItem(storagePrefix + "card_" + cardId + "_date-robot");
    
    const delayPill = card.querySelector(".mcard-delay-pill");
    if(!delayPill) return;
    
    // Vérifier si la carte est dans la colonne En attente
    const isInAttente = card.classList.contains("in-attente-column");
    
    // Calculer le délai restant (toujours, même en attente)
    let remainingDays = delayDays;
    let delayClass = "countdown-green";
    let delayText = "Délai restant " + delayDays + " jours";
    
    if(robotDateStr){
      try{
        const robotDate = new Date(robotDateStr);
        const today = new Date();
        today.setHours(0,0,0,0);
        robotDate.setHours(0,0,0,0);
        
        const diffTime = today - robotDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        remainingDays = delayDays - diffDays;
        
        // Déterminer la classe de couleur
        if(remainingDays < 0){
          delayText = "EN RETARD - " + Math.abs(remainingDays) + " jours";
          delayClass = "countdown-late";
        } else if(remainingDays === 0){
          delayText = "Délai restant AUJOURD'HUI";
          delayClass = "countdown-red";
        } else if(remainingDays <= delayDays * 0.1){
          delayText = "Délai restant " + remainingDays + " jour" + (remainingDays > 1 ? "s" : "");
          delayClass = "countdown-red";
        } else if(remainingDays <= delayDays * 0.5){
          delayText = "Délai restant " + remainingDays + " jours";
          delayClass = "countdown-yellow";
        } else {
          delayText = "Délai restant " + remainingDays + " jours";
          delayClass = "countdown-green";
        }
      }catch(e){
        console.warn("Failed to calculate countdown:", e);
      }
    }
    
    // Stocker les données de délai sur la pastille pour le switch
    delayPill.dataset.delayText = delayText;
    delayPill.dataset.delayClass = delayClass;
    delayPill.dataset.remainingDays = remainingDays;
    
    // Si en mode "show-delay-mode" ou pas en attente, afficher le délai
    if(!isInAttente || delayPill.classList.contains("show-delay-mode")){
      // Remove all countdown classes
      delayPill.classList.remove("countdown-green","countdown-yellow","countdown-red","countdown-late");
      delayPill.classList.add(delayClass);
      
      const span = delayPill.querySelector("span");
      if(span){
        span.textContent = delayText;
      } else {
        delayPill.innerHTML = '<span>' + delayText + '</span>';
      }
    }
    // Sinon, on laisse l'affichage "En attente depuis" (géré par updateJoursAttente)
  }
  
  // Update all countdowns on page load
  function updateAllCountdowns(){
    const cards = document.querySelectorAll(".mcard");
    cards.forEach(card => {
      const cardId = card.dataset.cardId;
      if(cardId) updateCountdown(cardId);
    });
  }
  
  // Run on load
  setTimeout(updateAllCountdowns, 500);
  
  // Update every minute
  setInterval(updateAllCountdowns, 60000);
  
  // Make updateCountdown available globally
  window.updateCountdown = updateCountdown;
  window.updateCardCountdown = updateCountdown;
  
  // Expose for department tracking to adjust countdown
  window.adjustCountdownForEssayage = function(cardId){
    updateCountdown(cardId);
  };
})();

// ===== MISE À JOUR DES JOURS EN ATTENTE + SWITCH CLIQUABLE =====
(function(){
  const storagePrefix = "physipro_v280_";
  
  function updateJoursAttente(){
    // Mettre à jour uniquement les cartes dans la colonne En attente
    const cards = document.querySelectorAll('.mcard.in-attente-column');
    cards.forEach(function(card){
      const delayPill = card.querySelector('.mcard-delay-pill');
      if(!delayPill) return;
      
      // Si en mode "show-delay-mode", ne pas écraser avec "En attente depuis"
      if(delayPill.classList.contains("show-delay-mode")) return;
      
      const cardId = card.dataset.cardId;
      let dateEntree = delayPill.dataset.attenteDepuis;
      
      // Si pas de date dans l'attribut, chercher dans localStorage
      if(!dateEntree){
        try{
          dateEntree = localStorage.getItem(storagePrefix + "card_" + cardId + "_attente_depuis");
          if(dateEntree) delayPill.dataset.attenteDepuis = dateEntree;
        }catch(e){}
      }
      
      if(!dateEntree || dateEntree === '--' || dateEntree === '') return;
      
      // Calculer le nombre de jours
      const dateObj = new Date(dateEntree);
      const aujourdhui = new Date();
      const diffTime = aujourdhui - dateObj;
      let joursAttente = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      if(joursAttente < 0) joursAttente = 0;
      
      const joursPluriel = joursAttente <= 1 ? "jour" : "jours";
      
      // Stocker pour le switch
      delayPill.dataset.attenteText = 'En attente depuis ' + joursAttente + ' ' + joursPluriel;
      delayPill.dataset.joursAttente = joursAttente;
      
      // Mettre à jour l'affichage de la pastille (mode attente)
      delayPill.innerHTML = 'En attente depuis&nbsp;<span class="jours-nombre">' + joursAttente + '</span>&nbsp;' + joursPluriel;
    });
  }
  
  // Handler pour le switch de la pastille (clic)
  document.addEventListener("click", function(e){
    const delayPill = e.target.closest(".mcard-delay-pill");
    if(!delayPill) return;
    
    const card = delayPill.closest(".mcard");
    if(!card) return;
    
    // Seulement dans la colonne En attente
    if(!card.classList.contains("in-attente-column")) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const cardId = card.dataset.cardId;
    
    // Toggle le mode
    if(delayPill.classList.contains("show-delay-mode")){
      // Revenir au mode "En attente depuis"
      delayPill.classList.remove("show-delay-mode");
      delayPill.classList.remove("countdown-green","countdown-yellow","countdown-red","countdown-late");
      
      // Afficher "En attente depuis"
      const joursAttente = delayPill.dataset.joursAttente || "0";
      const joursPluriel = parseInt(joursAttente) <= 1 ? "jour" : "jours";
      delayPill.innerHTML = 'En attente depuis&nbsp;<span class="jours-nombre">' + joursAttente + '</span>&nbsp;' + joursPluriel;
    } else {
      // Passer au mode "Délai restant"
      delayPill.classList.add("show-delay-mode");
      
      // Afficher le délai restant (stocké par updateCountdown)
      const delayText = delayPill.dataset.delayText || "Délai restant 0 jours";
      const delayClass = delayPill.dataset.delayClass || "countdown-green";
      
      delayPill.classList.remove("countdown-green","countdown-yellow","countdown-red","countdown-late");
      delayPill.classList.add(delayClass);
      delayPill.innerHTML = '<span>' + delayText + '</span>';
    }
  });
  
  // Exécuter au chargement
  setTimeout(updateJoursAttente, 600);
  
  // Aussi après le countdown
  setTimeout(updateJoursAttente, 700);
  
  // Mettre à jour toutes les heures (les jours changent à minuit)
  setInterval(updateJoursAttente, 3600000);
  
  // Rendre disponible globalement
  window.updateJoursAttente = updateJoursAttente;
})();

// ===== DEPARTMENT TRACKING SYSTEM v3.6.5 =====
// Tracking AUTOMATIQUE basé sur les COLONNES du tableau
// Quand une carte ENTRE dans une colonne → entrée enregistrée automatiquement
// Quand une carte SORT d'une colonne → sortie enregistrée + employé + nombre de jours
(function(){
  const storagePrefix = "physipro_v280_";
  const deptInfoOverlay = document.getElementById("deptInfoOverlay");
  const deptInfoTitle = document.getElementById("deptInfoTitle");
  const deptInfoContent = document.getElementById("deptInfoContent");
  const deptInfoClose = document.getElementById("deptInfoClose");
  
  // Configuration: mapping colonne → département
  // Colonnes: 0=Robot, 1=Dégauchage, 2=Essayage, 3=Atelier, 4=Couture, 5=Peinture, 6=Expédition, 7=En attente
  const DEPT_CONFIG = {
    "robot":      { name: "Robot",      icon: "⚙️", colIndex: 0 },
    "degauchage": { name: "Dégauchage", icon: "🪚", colIndex: 1 },
    "essayage":   { name: "Essayage",   icon: "👔", colIndex: 2, pausesCountdown: true },
    "atelier":    { name: "Atelier",    icon: "📐", colIndex: 3 },
    "couture":    { name: "Couture",    icon: "🧵", colIndex: 4 },
    "peinture":   { name: "Peinture",   icon: "🎨", colIndex: 5 }
  };
  
  // Reverse mapping: colIndex → deptName
  const COL_TO_DEPT = {};
  Object.keys(DEPT_CONFIG).forEach(key => {
    COL_TO_DEPT[DEPT_CONFIG[key].colIndex] = key;
  });
  
  function getTodayString(){
    const today = new Date();
    return today.getFullYear() + "-" + String(today.getMonth()+1).padStart(2,'0') + "-" + String(today.getDate()).padStart(2,'0');
  }
  
  function calculateDays(dateStr1, dateStr2){
    if(!dateStr1 || !dateStr2) return 0;
    try{
      const d1 = new Date(dateStr1);
      const d2 = new Date(dateStr2);
      d1.setHours(0,0,0,0);
      d2.setHours(0,0,0,0);
      const diffTime = d2 - d1;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays === 0 && dateStr1 === dateStr2 ? 1 : (diffDays < 0 ? 0 : diffDays + 1);
    }catch(e){
      return 0;
    }
  }
  
  function getDepartmentData(cardId, deptName){
    try{
      const raw = localStorage.getItem(storagePrefix + "card_" + cardId + "_dept_" + deptName);
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      return null;
    }
  }
  
  function saveDepartmentData(cardId, deptName, data){
    try{
      localStorage.setItem(storagePrefix + "card_" + cardId + "_dept_" + deptName, JSON.stringify(data));
    }catch(e){
      console.warn("Failed to save department data:", e);
    }
  }
  
  // Récupérer l'employé sélectionné sur la carte (depuis la pastille employé en bas)
  function getEmployeeFromCard(card){
    const employeePill = card.querySelector('.mcard-employee-label.mcard-menu');
    if(employeePill){
      const text = employeePill.textContent.trim();
      // Nettoyer les icônes
      let cleanText = text.replace(/[⚙️🪚👔📐🧵🎨🤖🏭❤️]/g, '').trim();
      // Si contient "–" ou "Employés", pas d'employé sélectionné
      if(cleanText.includes("–") || cleanText.includes("Employés")){
        return null;
      }
      return cleanText;
    }
    return null;
  }
  
  // ENTRÉE automatique dans un département (quand carte arrive dans colonne)
  function recordDepartmentEntry(cardId, colIndex){
    const deptName = COL_TO_DEPT[colIndex];
    if(!deptName) return; // Colonne sans tracking (Expédition, En attente)
    
    let data = getDepartmentData(cardId, deptName);
    
    // Seulement si pas déjà en cours dans ce département
    if(!data || data.exit){
      data = {
        entry: getTodayString(),
        exit: null,
        employee: null
      };
      saveDepartmentData(cardId, deptName, data);
      console.log(`📥 ENTRÉE AUTO: Card ${cardId} → ${deptName} (colonne ${colIndex}) le ${data.entry}`);
      updatePillVisual(cardId, deptName);
    }
  }
  
  // SORTIE automatique d'un département (quand carte quitte colonne)
  function recordDepartmentExit(cardId, oldColIndex, card){
    const deptName = COL_TO_DEPT[oldColIndex];
    if(!deptName) return; // Colonne sans tracking
    
    let data = getDepartmentData(cardId, deptName);
    if(data && data.entry && !data.exit){
      data.exit = getTodayString();
      
      // Récupérer l'employé AVANT le déplacement
      if(card){
        const employee = getEmployeeFromCard(card);
        if(employee){
          data.employee = employee;
        }
      }
      
      saveDepartmentData(cardId, deptName, data);
      
      const days = calculateDays(data.entry, data.exit);
      console.log(`📤 SORTIE AUTO: Card ${cardId} ← ${deptName} (${days}J) Employé: ${data.employee || 'N/A'}`);
      
      updatePillVisual(cardId, deptName);
      
      // Si Essayage, ajuster le countdown
      if(DEPT_CONFIG[deptName].pausesCountdown){
        adjustCountdownForEssayageDays(cardId);
      }
    }
  }
  
  // Mettre à jour l'apparence visuelle de la pastille
  function updatePillVisual(cardId, deptName){
    const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
    if(!card) return;
    
    // Chercher par data-dept-name OU data-dept
    let pill = card.querySelector('.mcard-pill.dept-trackable[data-dept-name="'+deptName+'"]');
    if(!pill){
      pill = card.querySelector('.mcard-pill.dept-trackable[data-dept="'+deptName+'"]');
    }
    if(!pill) return;
    
    const data = getDepartmentData(cardId, deptName);
    const config = DEPT_CONFIG[deptName];
    
    // Réinitialiser les classes
    pill.classList.remove("dept-not-started", "dept-in-progress", "dept-completed");
    
    if(!data || !data.entry){
      // Pas encore commencé
      pill.classList.add("dept-not-started");
      pill.textContent = config.name;
    } else if(!data.exit){
      // En cours
      pill.classList.add("dept-in-progress");
      pill.textContent = config.name;
    } else {
      // Terminé - afficher nom + nombre de jours
      pill.classList.add("dept-completed");
      const days = calculateDays(data.entry, data.exit);
      pill.innerHTML = config.name + ' <span class="dept-duration-badge">' + days + 'J</span>';
    }
  }
  
  function adjustCountdownForEssayageDays(cardId){
    const essayageData = getDepartmentData(cardId, "essayage");
    if(!essayageData || !essayageData.exit) return;
    
    const essayageDays = calculateDays(essayageData.entry, essayageData.exit);
    
    const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
    if(!card) return;
    
    const regionPill = card.querySelector('.mcard-menu[data-menu-field="region"]');
    const region = regionPill ? regionPill.textContent.trim() : "";
    const baseDelay = MENU_DATA.delays[region] || 90;
    
    const robotDateStr = localStorage.getItem(storagePrefix + "card_" + cardId + "_date-robot");
    if(!robotDateStr) return;
    
    try{
      const robotDate = new Date(robotDateStr);
      const today = new Date();
      today.setHours(0,0,0,0);
      robotDate.setHours(0,0,0,0);
      
      const diffTime = today - robotDate;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      const adjustedDelay = baseDelay + essayageDays;
      const remainingDays = adjustedDelay - diffDays;
      
      const delayPill = card.querySelector(".mcard-delay-pill");
      if(delayPill){
        const span = delayPill.querySelector("span");
        if(span){
          delayPill.classList.remove("countdown-green","countdown-yellow","countdown-red","countdown-late");
          
          if(remainingDays < 0){
            span.textContent = "EN RETARD - " + Math.abs(remainingDays) + " jours";
            delayPill.classList.add("countdown-late");
          } else if(remainingDays === 0){
            span.textContent = "Délai restant AUJOURD'HUI";
            delayPill.classList.add("countdown-red");
          } else if(remainingDays <= adjustedDelay * 0.1){
            span.textContent = "Délai restant " + remainingDays + " jour" + (remainingDays > 1 ? "s" : "");
            delayPill.classList.add("countdown-red");
          } else if(remainingDays <= adjustedDelay * 0.5){
            span.textContent = "Délai restant " + remainingDays + " jours";
            delayPill.classList.add("countdown-yellow");
          } else {
            span.textContent = "Délai restant " + remainingDays + " jours";
            delayPill.classList.add("countdown-green");
          }
        }
      }
    }catch(e){
      console.warn("Failed to adjust countdown:", e);
    }
  }
  
  // Afficher les infos du département (clic sur pastille)
  // Variable pour stocker le contexte actuel du popup
  let currentDeptPopupContext = null;
  
  function showDepartmentInfo(cardId, deptName, clickedPill){
    const config = DEPT_CONFIG[deptName];
    if(!config) return;
    
    const data = getDepartmentData(cardId, deptName);
    
    // Stocker le contexte pour la sauvegarde
    currentDeptPopupContext = { cardId, deptName, clickedPill };
    
    deptInfoTitle.textContent = config.icon + " " + config.name;
    
    // Convertir la date du format DD/MM/YYYY vers YYYY-MM-DD pour l'input
    function toInputFormat(dateStr){
      if(!dateStr) return "";
      const parts = dateStr.split("/");
      if(parts.length === 3){
        return parts[2] + "-" + parts[1] + "-" + parts[0];
      }
      return dateStr;
    }
    
    let html = '';
    
    if(!data || !data.entry){
      // Pas encore passé - permettre de définir manuellement les dates
      html = `
        <div class="dept-info-row">
          <div class="dept-info-label">Statut:</div>
          <div class="dept-info-value">Pas encore passé ici</div>
        </div>
        <div class="dept-info-row" style="margin-top:12px;border-top:1px solid rgba(100,180,255,0.2);padding-top:12px;">
          <div class="dept-info-label" style="font-size:12px;color:#64b5f6;">📝 Ajouter manuellement:</div>
        </div>
        <div class="dept-info-row">
          <div class="dept-info-label">Date d'entrée:</div>
          <input type="date" class="dept-info-date-input" id="deptEntryDate" value="">
        </div>
        <div class="dept-info-row">
          <div class="dept-info-label">Date de sortie:</div>
          <input type="date" class="dept-info-date-input" id="deptExitDate" value="">
        </div>
        <div class="dept-info-days-display" id="deptDaysDisplay">
          Sélectionnez les dates pour calculer la durée
        </div>
        <button class="dept-info-save-btn" id="deptSaveBtn">💾 Enregistrer les dates</button>
      `;
    } else if(!data.exit){
      // En cours - permettre de modifier la date d'entrée
      const days = calculateDays(data.entry, getTodayString());
      const entryInputVal = toInputFormat(data.entry);
      html = `
        <div class="dept-info-row">
          <div class="dept-info-label">Statut:</div>
          <div class="dept-info-value" style="color:#00ff00;">✅ En cours</div>
        </div>
        <div class="dept-info-row">
          <div class="dept-info-label">Date d'entrée:</div>
          <input type="date" class="dept-info-date-input" id="deptEntryDate" value="${entryInputVal}">
        </div>
        <div class="dept-info-row">
          <div class="dept-info-label">Durée actuelle:</div>
          <div class="dept-info-value" id="deptDaysValue">${days} jour${days > 1 ? 's' : ''}</div>
        </div>
      `;
      if(data.employee){
        html += `
        <div class="dept-info-row">
          <div class="dept-info-label">Employé:</div>
          <div class="dept-info-value">${data.employee}</div>
        </div>
        `;
      }
      html += `
        <button class="dept-info-save-btn" id="deptSaveBtn">💾 Enregistrer la modification</button>
        <div class="dept-info-row" style="margin-top:8px;opacity:0.7;">
          <div class="dept-info-value" style="text-align:center;font-size:9px;">
            La sortie sera enregistrée automatiquement<br>quand la carte quittera cette colonne.
          </div>
        </div>
      `;
    } else {
      // Terminé - permettre de modifier les deux dates
      const days = calculateDays(data.entry, data.exit);
      const entryInputVal = toInputFormat(data.entry);
      const exitInputVal = toInputFormat(data.exit);
      html = `
        <div class="dept-info-row">
          <div class="dept-info-label">Statut:</div>
          <div class="dept-info-value" style="color:#888;">✓ Terminé</div>
        </div>
        <div class="dept-info-row">
          <div class="dept-info-label">Date d'entrée:</div>
          <input type="date" class="dept-info-date-input" id="deptEntryDate" value="${entryInputVal}">
        </div>
        <div class="dept-info-row">
          <div class="dept-info-label">Date de sortie:</div>
          <input type="date" class="dept-info-date-input" id="deptExitDate" value="${exitInputVal}">
        </div>
        <div class="dept-info-days-display" id="deptDaysDisplay">
          Durée totale: <strong>${days} jour${days > 1 ? 's' : ''}</strong>
        </div>
      `;
      if(data.employee){
        html += `
        <div class="dept-info-row">
          <div class="dept-info-label">Employé:</div>
          <div class="dept-info-value">${data.employee}</div>
        </div>
        `;
      }
      if(config.pausesCountdown){
        html += `
        <div class="dept-info-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,170,0,0.3);">
          <div class="dept-info-label">⏸️ Délai pausé:</div>
          <div class="dept-info-value" style="color:#ffaa00">+${days} jour${days > 1 ? 's' : ''}</div>
        </div>
        `;
      }
      html += `
        <button class="dept-info-save-btn" id="deptSaveBtn">💾 Enregistrer les modifications</button>
      `;
    }
    
    deptInfoContent.innerHTML = html;
    deptInfoOverlay.classList.remove("hidden");
    
    // Ajouter les event listeners pour le calcul en temps réel
    const entryInput = document.getElementById("deptEntryDate");
    const exitInput = document.getElementById("deptExitDate");
    const daysDisplay = document.getElementById("deptDaysDisplay");
    const saveBtn = document.getElementById("deptSaveBtn");
    
    function updateDaysDisplay(){
      if(!daysDisplay) return;
      const entry = entryInput ? entryInput.value : "";
      const exit = exitInput ? exitInput.value : "";
      
      if(entry && exit){
        const entryDate = new Date(entry);
        const exitDate = new Date(exit);
        const diffTime = exitDate - entryDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if(diffDays >= 0){
          daysDisplay.innerHTML = 'Durée totale: <strong>' + diffDays + ' jour' + (diffDays > 1 ? 's' : '') + '</strong>';
          daysDisplay.style.color = "#00ff00";
        } else {
          daysDisplay.innerHTML = '⚠️ La date de sortie doit être après l\'entrée';
          daysDisplay.style.color = "#ff6666";
        }
      } else if(entry && !exit){
        const entryDate = new Date(entry);
        const today = new Date();
        const diffTime = today - entryDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        daysDisplay.innerHTML = 'En cours depuis: <strong>' + diffDays + ' jour' + (diffDays > 1 ? 's' : '') + '</strong>';
        daysDisplay.style.color = "#ffaa00";
      } else {
        daysDisplay.innerHTML = 'Sélectionnez les dates pour calculer la durée';
        daysDisplay.style.color = "";
      }
    }
    
    if(entryInput) entryInput.addEventListener("change", updateDaysDisplay);
    if(exitInput) exitInput.addEventListener("change", updateDaysDisplay);
    
    // Sauvegarde
    if(saveBtn){
      saveBtn.addEventListener("click", function(){
        if(!currentDeptPopupContext) return;
        
        const { cardId, deptName, clickedPill } = currentDeptPopupContext;
        const entry = entryInput ? entryInput.value : "";
        const exit = exitInput ? exitInput.value : "";
        
        // Convertir vers format DD/MM/YYYY
        function toDisplayFormat(dateStr){
          if(!dateStr) return "";
          const parts = dateStr.split("-");
          if(parts.length === 3){
            return parts[2] + "/" + parts[1] + "/" + parts[0];
          }
          return dateStr;
        }
        
        const entryFormatted = toDisplayFormat(entry);
        const exitFormatted = toDisplayFormat(exit);
        
        // Récupérer l'employé existant
        const existingData = getDepartmentData(cardId, deptName);
        const employee = existingData ? existingData.employee : "";
        
        // Construire le nouvel objet de données
        const newData = {};
        if(entryFormatted) newData.entry = entryFormatted;
        if(exitFormatted) newData.exit = exitFormatted;
        if(employee) newData.employee = employee;
        
        // Sauvegarder
        const key = storagePrefix + "card_" + cardId + "_dept_" + deptName;
        try{
          if(Object.keys(newData).length > 0){
            localStorage.setItem(key, JSON.stringify(newData));
          } else {
            localStorage.removeItem(key);
          }
          
          // Firebase
          if(typeof isFirebaseMode !== "undefined" && isFirebaseMode && typeof saveCardFieldToFirebase === "function"){
            saveCardFieldToFirebase(cardId, "dept_" + deptName, JSON.stringify(newData));
          }
          
          // Mettre à jour l'affichage de la pastille
          updatePillVisual(cardId, deptName);
          
          // Feedback
          saveBtn.textContent = "✓ Enregistré!";
          saveBtn.style.background = "linear-gradient(to bottom,#00aa00,#008800)";
          
          setTimeout(function(){
            deptInfoOverlay.classList.add("hidden");
          }, 800);
          
          console.log("✅ Dates département " + deptName + " mises à jour pour carte " + cardId);
        }catch(e){
          console.error("Erreur sauvegarde dates département:", e);
        }
      });
    }
  }
  
  // Initialiser le tracking pour toutes les cartes (ajoute classes et attributs, mais PAS les event listeners)
  function initDepartmentTracking(){
    const cards = document.querySelectorAll(".mcard");
    cards.forEach(card => {
      const cardId = card.dataset.cardId;
      if(!cardId) return;
      
      const rightColumn = card.querySelector(".mcard-column:last-child");
      if(!rightColumn) return;
      
      // Trouver les pastilles de département (exclure date-robot)
      const pills = Array.from(rightColumn.querySelectorAll(".mcard-pill")).filter(p => !p.classList.contains("mcard-pill-date"));
      
      const deptNames = ["robot", "degauchage", "essayage", "atelier", "couture", "peinture"];
      pills.forEach((pill, index) => {
        if(index < deptNames.length){
          const deptName = deptNames[index];
          const config = DEPT_CONFIG[deptName];
          
          // Éviter les doublons d'initialisation des attributs
          if(pill.dataset.trackingInit === "true") return;
          pill.dataset.trackingInit = "true";
          
          pill.classList.add("dept-trackable");
          pill.dataset.deptName = deptName;
          pill.dataset.dept = deptName;
          
          // Mettre le texte initial SANS icône
          pill.textContent = config.name;
          
          // NOTE: Les event listeners sont gérés par délégation (voir plus bas)
          
          // Mettre à jour l'apparence
          updatePillVisual(cardId, deptName);
        }
      });
      
      // Enregistrer l'entrée pour la colonne actuelle
      const col = card.closest(".col");
      if(col){
        const board = document.querySelector(".board");
        const cols = Array.from(board.querySelectorAll(".col"));
        const colIndex = cols.indexOf(col);
        recordDepartmentEntry(cardId, colIndex);
      }
    });
  }
  
  // ===== DÉLÉGATION D'ÉVÉNEMENTS POUR LES PASTILLES DÉPARTEMENT =====
  // Utilise la délégation au niveau du document pour capturer les clics sur TOUTES les pastilles
  // (y compris celles créées dynamiquement après le chargement initial)
  document.addEventListener("click", function(e){
    const pill = e.target.closest(".mcard-pill.dept-trackable");
    if(pill){
      // Vérifier qu'on n'est pas dans un overlay
      if(e.target.closest(".vp-overlay") || e.target.closest(".dept-info-overlay")) return;
      
      const card = pill.closest(".mcard");
      if(!card) return;
      
      const cardId = card.dataset.cardId;
      const deptName = pill.dataset.deptName || pill.dataset.dept;
      
      if(cardId && deptName){
        e.stopPropagation();
        e.preventDefault();
        showDepartmentInfo(cardId, deptName, pill);
      }
    }
  });
  
  // Fermer le popup
  deptInfoClose.addEventListener("click", function(){
    deptInfoOverlay.classList.add("hidden");
  });
  
  deptInfoOverlay.addEventListener("click", function(e){
    if(e.target === deptInfoOverlay){
      deptInfoOverlay.classList.add("hidden");
    }
  });
  
  // Initialiser au chargement
  setTimeout(initDepartmentTracking, 600);
  
  // Exposer les fonctions globalement pour le système de déplacement
  window.trackDepartmentEntry = function(cardId, colIndex){
    recordDepartmentEntry(cardId, colIndex);
  };
  window.trackDepartmentExit = function(cardId, colIndex, card){
    recordDepartmentExit(cardId, colIndex, card);
  };
  window.refreshTrackingVisuals = function(cardId){
    Object.keys(DEPT_CONFIG).forEach(deptName => {
      updatePillVisual(cardId, deptName);
    });
  };
  
  // Autres fonctions exposées
  window.showDepartmentInfo = showDepartmentInfo;
  window.recordDepartmentEntry = recordDepartmentEntry;
  window.recordDepartmentExit = recordDepartmentExit;
  window.initDepartmentTracking = initDepartmentTracking;
  window.updatePillVisual = updatePillVisual;
})();

// ===== NOTES SYSTEM - POPUP GLOBAL =====
(function(){
  const storagePrefix = "physipro_v280_";
  
  // Éléments du popup global
  const backdrop = document.getElementById("notesCardBackdrop");
  const overlay = document.getElementById("notesCardOverlayGlobal");
  const cardInfo = document.getElementById("notesCardInfo");
  const closeBtn = document.getElementById("notesCardCloseBtn");
  const textarea = document.getElementById("notesCardTextarea");
  const saveBtn = document.getElementById("notesCardSaveBtn");
  const linkBtn = document.getElementById("notesCardLinkBtn");
  const photoBtn = document.getElementById("notesCardPhotoBtn");
  const linkPopup = document.getElementById("notesLinkPopup");
  const linkInput = document.getElementById("notesLinkInput");
  const linkSaveBtn = document.getElementById("notesLinkSaveBtn");
  const linkCloseBtn = document.getElementById("notesLinkCloseBtn");
  
  let currentCard = null;
  let currentCardId = null;
  
  // Fonction pour formater la date
  function formatNoteDate(dateStr){
    if(!dateStr) return "";
    try{
      const date = new Date(dateStr);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return day + "/" + month + "/" + year;
    }catch(e){
      return "";
    }
  }
  
  // Fonction pour mettre à jour l'indicateur de notes sur la pastille
  // Fonction pour mettre à jour l'indicateur de notes sur la pastille (version compacte)
  function updateNotesIndicator(card, cardId){
    const notesLabel = card.querySelector(".mcard-notes-label");
    const notesInput = card.querySelector(".mcard-notes-input");
    if(!notesLabel) return;

    const notesContent = notesInput ? notesInput.value.trim() : "";

    if(notesContent){
      notesLabel.classList.add("has-notes");
      // Afficher seulement la dernière ligne, compact, avec ellipse si trop long
      const lines = notesContent.split("\n").map(l => l.trim()).filter(l => l.length > 0);
      let lastLine = lines.length ? lines[lines.length - 1] : "";
      if(lastLine.length > 70){
        lastLine = lastLine.substring(0, 67) + "...";
      }
      notesLabel.textContent = lastLine || "Notes";
    } else {
      notesLabel.classList.remove("has-notes");
      notesLabel.textContent = "Notes";
    }
  }
  
  // Fonction pour mettre à jour l'état du bouton Photos
  function updatePhotoButtonState(){
    if(!currentCardId) return;
    const link = localStorage.getItem(storagePrefix + "card_" + currentCardId + "_notes_link");
    if(link && link.trim()){
      photoBtn.classList.add("has-link");
    } else {
      photoBtn.classList.remove("has-link");
    }
  }
  
  // Vérifier si une carte a un lien photo dans les notes
  function cardHasPhotoLink(cardId){
    const link = localStorage.getItem(storagePrefix + "card_" + cardId + "_notes_link");
    return link && link.trim() !== "";
  }
  
  // Exposer globalement pour utilisation dans d'autres modules
  window.updateNotesIndicator = updateNotesIndicator;
  window.cardHasPhotoLink = cardHasPhotoLink;
  
  // Déterminer l'index de colonne d'une carte
  function getCardColumnIndex(card){
    const col = card.closest(".col");
    if(!col) return -1;
    const board = col.closest(".board");
    if(!board) return -1;
    const columns = Array.from(board.querySelectorAll(".col"));
    return columns.indexOf(col);
  }
  
  // Positionner le popup selon la carte et sa colonne
  function positionNotesPopup(card){
    const rect = card.getBoundingClientRect();
    const colIndex = getCardColumnIndex(card);
    const popupWidth = 340; // Largeur du popup
    
    // Hauteur du popup = hauteur de la carte
    const popupHeight = rect.height;
    overlay.style.height = popupHeight + 'px';
    
    // Position verticale: aligné avec le haut de la carte
    let top = rect.top;
    
    // Ajuster si trop bas
    if(top + popupHeight > window.innerHeight - 10){
      top = window.innerHeight - popupHeight - 10;
    }
    if(top < 10) top = 10;
    
    // Position horizontale selon la colonne
    let left;
    
    if(colIndex === 0){
      // Colonne 1 (Robot) - popup s'étend vers la droite
      left = rect.left;
    } else if(colIndex === 7){
      // Colonne 8 (En attente) - popup s'étend vers la gauche
      left = rect.right - popupWidth;
    } else {
      // Colonnes 2-7 - popup centré sur la carte
      left = rect.left + (rect.width / 2) - (popupWidth / 2);
    }
    
    // S'assurer que le popup reste dans l'écran
    if(left < 10) left = 10;
    if(left + popupWidth > window.innerWidth - 10){
      left = window.innerWidth - popupWidth - 10;
    }
    
    overlay.style.top = top + 'px';
    overlay.style.left = left + 'px';
    overlay.style.transform = 'none';
  }
  
  // Ouvrir le popup de notes
  // Version améliorée : curseur toujours sur nouvelle ligne après nom+date
  function openNotesPopup(card){
    currentCard = card;
    currentCardId = card.dataset.cardId;

    // Récupérer le numéro de commande seulement
    const orderEl = card.querySelector(".mcard-order");
    const order = orderEl ? orderEl.textContent : "";
    cardInfo.textContent = order && order !== "000000" ? "#" + order : "Nouveau";

    // Contenu actuel des notes dans la carte
    const originalTextarea = card.querySelector(".mcard-notes-input");
    let existingNotes = originalTextarea ? (originalTextarea.value || "") : "";

    // Déterminer le nom de l'utilisateur connecté
    let userName = "Anonyme";
    if(typeof currentUser !== "undefined" && currentUser && currentUser.name){
      userName = currentUser.name;
    }

    // Date/heure compacte pour estampiller
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const compactDateTime = day + "/" + month + " " + hours + ":" + minutes;

    // Vérifier si c'est une représentante assignée
    let isAssignedRep = false;
    try{
      if(typeof MENU_DATA !== "undefined" && MENU_DATA && Array.isArray(MENU_DATA.representantes)){
        if(MENU_DATA.representantes.includes(userName)){
          const repPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
          isAssignedRep = repPill && repPill.textContent.trim() === userName;
        }
      }
    }catch(e){}

    // Construire le contenu des notes
    let notesWork = existingNotes.trimEnd();
    
    if(!notesWork){
      // Aucune note existante : commencer avec nom + date + nouvelle ligne
      notesWork = userName + "-" + compactDateTime + ":\n";
    } else {
      // Notes existantes
      
      // Si c'est une représentante assignée, ajouter "Vu par"
      if(isAssignedRep){
        const vuLine = "Vu par " + userName + "-" + compactDateTime;
        // Ajouter "Vu par" seulement si pas déjà présent avec ce nom
        if(!notesWork.includes("Vu par " + userName)){
          notesWork = notesWork + "\n" + vuLine;
        }
      }
      
      // Toujours ajouter une nouvelle ligne avec nom + date pour le nouveau message
      notesWork = notesWork + "\n" + userName + "-" + compactDateTime + ":\n";
    }

    textarea.value = notesWork;

    // Charger le lien existant
    const existingLink = localStorage.getItem(storagePrefix + "card_" + currentCardId + "_notes_link") || "";
    linkInput.value = existingLink;

    // Mettre à jour l'état du bouton Photos
    updatePhotoButtonState();

    // Positionner le popup sur la carte
    positionNotesPopup(card);

    // Mémoriser le contenu original pour détecter les changements à la fermeture
    card.dataset.originalNotes = textarea.value;

    // Afficher le popup
    backdrop.classList.remove("hidden");
    overlay.classList.remove("hidden");

    // Positionner le curseur à la fin (sur la nouvelle ligne vide)
    textarea.focus();
    try{
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);
      // Scroll vers le bas pour voir le curseur
      textarea.scrollTop = textarea.scrollHeight;
    }catch(e){}
  }
  
  // Fermer le popup de notes (avec sauvegarde automatique)
  // Fermer le popup de notes (sauvegarde auto + auteur + date)
  function closeNotesPopup(){
    // === SAUVEGARDE AUTOMATIQUE ===
    if(currentCard && currentCardId){
      const value = textarea.value;
      const originalTextarea = currentCard.querySelector(".mcard-notes-input");
      const originalNotes = currentCard.dataset.originalNotes || "";

      // Obtenir le nom de l'auteur
      let authorName = "Anonyme";
      if(typeof currentUser !== 'undefined' && currentUser && currentUser.name){
        authorName = currentUser.name;
      }

      try{
        let finalValue = value;

        // Vérifier si le contenu a changé depuis l'ouverture
        const contentChanged = (value !== originalNotes);

        // Si l'utilisateur a ajouté du nouveau contenu
        if(contentChanged && value.trim()){
          // Trouver le nouveau contenu
          let newContent = "";
          if(value.length > originalNotes.length && value.startsWith(originalNotes)){
            newContent = value.substring(originalNotes.length).trim();
          } else if(value !== originalNotes){
            newContent = value.trim();
          }

          // Si c'est du nouveau contenu (pas juste "Vu par" ou un marqueur)
          if(newContent && !newContent.startsWith("Vu par ") && !newContent.startsWith("✓ Vu") && !newContent.startsWith("📝")){
            // Mettre à jour la date et l'auteur pour le nouveau contenu
            localStorage.setItem(storagePrefix + "card_" + currentCardId + "_notes_date", new Date().toISOString());
            localStorage.setItem(storagePrefix + "card_" + currentCardId + "_notes_author", authorName);
          }
        }

        // Sauvegarder en localStorage
        localStorage.setItem(storagePrefix + "card_" + currentCardId + "_notes", finalValue);

        // Mettre à jour le textarea original de la carte
        if(originalTextarea){
          originalTextarea.value = finalValue;
        }

        // Mettre à jour l'indicateur visuel (dernière ligne compacte)
        updateNotesIndicator(currentCard, currentCardId);

        // Sauvegarder sur Firebase
        if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
          saveCardFieldToFirebase(currentCardId, "notes", finalValue);
          if(finalValue.trim()){
            saveCardFieldToFirebase(currentCardId, "notesDate", new Date().toISOString());
            saveCardFieldToFirebase(currentCardId, "notesAuthor", authorName);
          }
        }
      }catch(err){
        console.error("Erreur sauvegarde auto notes:", err);
      }

      // Nettoyer
      delete currentCard.dataset.originalNotes;
    }

    // Fermer les popups
    backdrop.classList.add("hidden");
    overlay.classList.add("hidden");
    if(typeof linkPopup !== 'undefined' && linkPopup){
      linkPopup.classList.add("hidden");
    }
    currentCard = null;
    currentCardId = null;
  }
  
  // Event listeners
  closeBtn.addEventListener("click", closeNotesPopup);
  backdrop.addEventListener("click", closeNotesPopup);
  
  // Bouton Liens - ouvrir le popup
  linkBtn.addEventListener("click", function(e){
    e.stopPropagation();
    linkPopup.classList.remove("hidden");
    linkInput.focus();
  });
  
  // Bouton Photos - ouvrir le lien
  photoBtn.addEventListener("click", function(e){
    e.stopPropagation();
    if(!currentCardId) return;
    const link = localStorage.getItem(storagePrefix + "card_" + currentCardId + "_notes_link");
    if(link && link.trim()){
      window.open(link.trim(), "_blank");
    }
  });
  
  // Sauvegarder le lien
  linkSaveBtn.addEventListener("click", function(e){
    e.stopPropagation();
    if(!currentCardId) return;
    
    const linkValue = linkInput.value.trim();
    try{
      localStorage.setItem(storagePrefix + "card_" + currentCardId + "_notes_link", linkValue);
      updatePhotoButtonState();
      
      // Sauvegarder sur Firebase si connecté
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(currentCardId, "notesLink", linkValue);
      }
    }catch(err){}
    linkPopup.classList.add("hidden");
  });
  
  // Fermer le popup lien
  linkCloseBtn.addEventListener("click", function(e){
    e.stopPropagation();
    linkPopup.classList.add("hidden");
  });
  
  // Bouton Fermer - la sauvegarde est automatique dans closeNotesPopup()
  saveBtn.addEventListener("click", function(e){
    e.stopPropagation();
    closeNotesPopup();
  });
  
  // Fermer avec Escape
  document.addEventListener("keydown", function(e){
    if(e.key === "Escape" && !overlay.classList.contains("hidden")){
      closeNotesPopup();
    }
  });
  
  // Intercepter les clics sur les zones de notes
  document.addEventListener("click", function(e){
    // Ne pas ouvrir si on clique sur l'overlay lui-même
    if(e.target.closest("#notesCardOverlayGlobal")) return;
    if(e.target.closest("#notesCardBackdrop")) return;
    
    // Ne pas ouvrir en mode readonly (les visiteurs ont leur propre popup)
    if(document.body.classList.contains("readonly-mode")) return;
    
    const notesLabel = e.target.closest(".mcard-notes-label");
    const notesInput = e.target.closest(".mcard-notes-input");
    
    if(notesLabel || notesInput){
      const card = e.target.closest(".mcard");
      if(!card) return;
      
      e.preventDefault();
      e.stopPropagation();
      openNotesPopup(card);
    }
  });
  
  // Empêcher le focus direct sur le textarea de la carte
  document.addEventListener("focus", function(e){
    if(e.target.classList.contains("mcard-notes-input")){
      // Ne pas interférer en mode readonly
      if(document.body.classList.contains("readonly-mode")) return;
      
      e.target.blur();
      const card = e.target.closest(".mcard");
      if(card){
        openNotesPopup(card);
      }
    }
  }, true);
  
  // Restaurer les indicateurs de notes au chargement
  function restoreNotesIndicators(){
    const cards = document.querySelectorAll(".mcard");
    cards.forEach(card => {
      const cardId = card.dataset.cardId;
      if(!cardId) return;
      
      // Restaurer le contenu des notes
      try{
        const savedNotes = localStorage.getItem(storagePrefix + "card_" + cardId + "_notes");
        const notesInput = card.querySelector(".mcard-notes-input");
        if(savedNotes && notesInput){
          notesInput.value = savedNotes;
        }
        
        // Mettre à jour l'indicateur visuel
        updateNotesIndicator(card, cardId);
      }catch(e){}
    });
  }
  
  // Restaurer au chargement
  setTimeout(restoreNotesIndicators, 500);
  
  console.log("✅ Notes system with global popup activated");
})();

// ===== TOGGLE EMPLOYEE BLINKING =====
// ===== DELAY CONFIGURATION SYSTEM =====
(function(){
  const delayConfigOverlay = document.getElementById("delayConfigOverlay");
  const delayConfigSave = document.getElementById("delayConfigSave");
  const delayQuebec = document.getElementById("delayQuebec");
  const delayOntario = document.getElementById("delayOntario");
  const delayMaritime = document.getElementById("delayMaritime");
  const storagePrefix = "physipro_v280_";
  
  // Charger les délais sauvegardés
  function loadDelays(){
    try{
      const q = localStorage.getItem(storagePrefix + "delay_quebec");
      const o = localStorage.getItem(storagePrefix + "delay_ontario");
      const m = localStorage.getItem(storagePrefix + "delay_maritime");
      if(q) delayQuebec.value = q;
      if(o) delayOntario.value = o;
      if(m) delayMaritime.value = m;
      
      // Mettre à jour MENU_DATA
      MENU_DATA.delays["Québec"] = parseInt(delayQuebec.value) || 90;
      MENU_DATA.delays["Ontario"] = parseInt(delayOntario.value) || 30;
      MENU_DATA.delays["Maritime"] = parseInt(delayMaritime.value) || 45;
    }catch(e){}
  }
  
  function saveDelays(){
    try{
      localStorage.setItem(storagePrefix + "delay_quebec", delayQuebec.value);
      localStorage.setItem(storagePrefix + "delay_ontario", delayOntario.value);
      localStorage.setItem(storagePrefix + "delay_maritime", delayMaritime.value);
      
      // Mettre à jour MENU_DATA
      MENU_DATA.delays["Québec"] = parseInt(delayQuebec.value) || 90;
      MENU_DATA.delays["Ontario"] = parseInt(delayOntario.value) || 30;
      MENU_DATA.delays["Maritime"] = parseInt(delayMaritime.value) || 45;
    }catch(e){}
    
    // Recalculer tous les délais
    document.querySelectorAll(".mcard").forEach(card => {
      if(card.dataset.cardId && window.updateCountdown){
        window.updateCountdown(card.dataset.cardId);
      }
    });
    
    closeDelayConfig();
  }
  
  function openDelayConfig(){
    loadDelays();
    delayConfigOverlay.classList.remove("hidden");
  }
  
  function closeDelayConfig(){
    delayConfigOverlay.classList.add("hidden");
  }
  
  delayConfigSave.addEventListener("click", saveDelays);
  delayConfigOverlay.addEventListener("click", function(e){
    if(e.target === delayConfigOverlay) closeDelayConfig();
  });
  
  // Clic sur la pastille délai pour ouvrir la config
  document.addEventListener("click", function(e){
    const delayPill = e.target.closest(".mcard-delay-pill");
    if(delayPill){
      e.stopPropagation();
      openDelayConfig();
    }
  });
  
  // Charger au démarrage
  loadDelays();
})();

// ===== LOG VIEWER SYSTEM =====
(function(){
  const logOverlay = document.getElementById("logOverlay");
  const logContent = document.getElementById("logContent");
  const logStats = document.getElementById("logStats");
  const logSearch = document.getElementById("logSearch");
  const logClose = document.getElementById("logClose");
  const logExport = document.getElementById("logExport");
  const logClear = document.getElementById("logClear");
  const logBtn = document.getElementById("logBtn");
  const storagePrefix = "physipro_v280_";
  const logKey = storagePrefix + "deletion_log";
  
  let currentLog = [];
  
  function openLog(){
    loadLog();
    renderLog();
    logOverlay.classList.remove("hidden");
  }
  
  function closeLog(){
    logOverlay.classList.add("hidden");
  }
  
  function loadLog(){
    try{
      const data = localStorage.getItem(logKey);
      currentLog = data ? JSON.parse(data) : [];
    }catch(e){
      console.error("Failed to load log:", e);
      currentLog = [];
    }
  }
  
  function renderLog(searchTerm = ""){
    if(currentLog.length === 0){
      logContent.innerHTML = `
        <div class="log-empty">
          <div class="log-empty-icon">📋</div>
          <div>Aucune suppression enregistrée</div>
        </div>
      `;
      logStats.textContent = "0 entrées";
      return;
    }
    
    // Filter by search term
    let filteredLog = currentLog;
    if(searchTerm){
      const term = searchTerm.toLowerCase();
      filteredLog = currentLog.filter(entry => {
        return (
          entry.title.toLowerCase().includes(term) ||
          entry.order.toLowerCase().includes(term) ||
          entry.region.toLowerCase().includes(term) ||
          entry.client.toLowerCase().includes(term) ||
          entry.intervenant.toLowerCase().includes(term) ||
          entry.representant.toLowerCase().includes(term) ||
          entry.notes.toLowerCase().includes(term)
        );
      });
    }
    
    logStats.textContent = `${filteredLog.length} entrée${filteredLog.length > 1 ? 's' : ''} ${searchTerm ? '(filtrées)' : ''}`;
    
    if(filteredLog.length === 0){
      logContent.innerHTML = `
        <div class="log-empty">
          <div class="log-empty-icon">🔍</div>
          <div>Aucun résultat pour "${searchTerm}"</div>
        </div>
      `;
      return;
    }
    
    logContent.innerHTML = filteredLog.map(entry => {
      const deletedDate = new Date(entry.deletedAt);
      const formattedDate = deletedDate.toLocaleDateString('fr-CA') + ' ' + 
                           deletedDate.toLocaleTimeString('fr-CA', {hour: '2-digit', minute: '2-digit'});
      
      // Format department timeline
      let timelineHTML = '';
      if(entry.deptTracking && Object.keys(entry.deptTracking).length > 0){
        timelineHTML = '<div class="log-entry-timeline"><div class="log-timeline-title">📊 Historique des départements</div><div class="log-timeline-items">';
        
        for(const [dept, data] of Object.entries(entry.deptTracking)){
          if(data && data.entries && data.entries.length > 0){
            const lastEntry = data.entries[data.entries.length - 1];
            const entryDate = new Date(lastEntry.enteredAt).toLocaleDateString('fr-CA');
            const exitDate = lastEntry.exitedAt ? new Date(lastEntry.exitedAt).toLocaleDateString('fr-CA') : "En cours";
            const duration = lastEntry.exitedAt ? 
              Math.floor((new Date(lastEntry.exitedAt) - new Date(lastEntry.enteredAt)) / (1000 * 60 * 60 * 24)) + ' jours' : 
              '...';
            
            timelineHTML += `
              <div class="log-timeline-item">
                <div class="log-timeline-dept">${dept}</div>
                <div class="log-timeline-dates">
                  Entrée: ${entryDate}<br>
                  Sortie: ${exitDate}<br>
                  Durée: ${duration}
                </div>
              </div>
            `;
          }
        }
        
        timelineHTML += '</div></div>';
      }
      
      return `
        <div class="log-entry">
          <div class="log-entry-header">
            <div>
              <div class="log-entry-title">${entry.title}</div>
              <div class="log-entry-order">Commande: ${entry.order}</div>
            </div>
            <div class="log-entry-deleted">Supprimé le ${formattedDate}</div>
          </div>
          <div class="log-entry-body">
            <div class="log-entry-section">
              <div class="log-entry-label">Date reçue</div>
              <div class="log-entry-value">${entry.dateRecue}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Date robot</div>
              <div class="log-entry-value">${entry.dateRobot}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Région</div>
              <div class="log-entry-value">${entry.region}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Client</div>
              <div class="log-entry-value">${entry.client}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Intervenant</div>
              <div class="log-entry-value">${entry.intervenant}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Représentant</div>
              <div class="log-entry-value">${entry.representant}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Employé Robot</div>
              <div class="log-entry-value">${entry.employees.robot}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Employé Dégauchage</div>
              <div class="log-entry-value">${entry.employees.degauchage}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Employé Atelier</div>
              <div class="log-entry-value">${entry.employees.atelier}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Employé Couture</div>
              <div class="log-entry-value">${entry.employees.couture}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Employé Peinture</div>
              <div class="log-entry-value">${entry.employees.peinture}</div>
            </div>
            <div class="log-entry-section">
              <div class="log-entry-label">Statut expédition</div>
              <div class="log-entry-value">${entry.expeditionStatus === "expedited" ? "Expédié le " + entry.expeditionDate : "Non expédié"}</div>
            </div>
            ${entry.notes ? `
            <div class="log-entry-section" style="grid-column: 1 / -1;">
              <div class="log-entry-label">Notes</div>
              <div class="log-entry-value">${entry.notes}</div>
            </div>
            ` : ''}
            ${timelineHTML}
          </div>
        </div>
      `;
    }).join('');
  }
  
  function exportToCSV(){
    if(currentLog.length === 0){
      alert("Aucune donnée à exporter");
      return;
    }
    
    // CSV Headers
    let csv = "Titre,Numéro de commande,Date reçue,Date robot,Région,Client,Intervenant,Représentant,";
    csv += "Employé Robot,Employé Dégauchage,Employé Atelier,Employé Couture,Employé Peinture,";
    csv += "Statut expédition,Date expédition,Notes,Date de suppression\n";
    
    // CSV Data
    currentLog.forEach(entry => {
      const row = [
        entry.title,
        entry.order,
        entry.dateRecue,
        entry.dateRobot,
        entry.region,
        entry.client,
        entry.intervenant,
        entry.representant,
        entry.employees.robot,
        entry.employees.degauchage,
        entry.employees.atelier,
        entry.employees.couture,
        entry.employees.peinture,
        entry.expeditionStatus,
        entry.expeditionDate,
        entry.notes.replace(/"/g, '""').replace(/\n/g, ' '),
        new Date(entry.deletedAt).toLocaleString('fr-CA')
      ];
      
      csv += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `physipro_log_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log("📥 Log exported to CSV");
  }
  
  function clearLog(){
    if(currentLog.length === 0){
      alert("Le log est déjà vide");
      return;
    }
    
    if(confirm(`Êtes-vous sûr de vouloir effacer TOUT le log?\n\n${currentLog.length} entrée(s) seront supprimées définitivement.`)){
      try{
        localStorage.removeItem(logKey);
        currentLog = [];
        renderLog();
        console.log("🗑️ Log cleared");
      }catch(e){
        console.error("Failed to clear log:", e);
        alert("Erreur lors de l'effacement du log");
      }
    }
  }
  
  // Event listeners
  logBtn.addEventListener("click", openLog);
  logClose.addEventListener("click", closeLog);
  logExport.addEventListener("click", exportToCSV);
  logClear.addEventListener("click", clearLog);
  
  logOverlay.addEventListener("click", function(e){
    if(e.target === logOverlay){
      closeLog();
    }
  });
  
  logSearch.addEventListener("input", function(){
    renderLog(logSearch.value);
  });
  
  console.log("✅ Log viewer system activated");
})();

// ===== SEARCH SYSTEM =====
(function(){
  const searchInput = document.getElementById("searchInput");
  const searchClear = document.getElementById("searchClear");
  
  if(!searchInput || !searchClear){
    console.warn("Search elements not found");
    return;
  }
  
  function performSearch(){
    const searchTerm = searchInput.value.toLowerCase().trim();
    const cards = document.querySelectorAll(".mcard");
    let visibleCount = 0;
    let hiddenCount = 0;
    
    cards.forEach(card => {
      if(!searchTerm){
        // Si la recherche est vide, afficher toutes les cartes
        card.style.display = "";
        visibleCount++;
        return;
      }
      
      // Chercher dans tous les champs texte de la carte
      let cardText = "";
      
      // Titre
      const title = card.querySelector(".mcard-title");
      if(title) cardText += title.textContent + " ";
      
      // Numéro de commande
      const order = card.querySelector(".mcard-order");
      if(order) cardText += order.textContent + " ";
      
      // Toutes les pastilles
      const pills = card.querySelectorAll(".mcard-pill, .mcard-menu, .mcard-employee-label");
      pills.forEach(pill => {
        cardText += pill.textContent + " ";
      });
      
      // Notes
      const notes = card.querySelector(".mcard-notes-input");
      if(notes) cardText += notes.value + " ";
      
      // Vérifier si le terme de recherche est trouvé
      cardText = cardText.toLowerCase();
      if(cardText.includes(searchTerm)){
        card.style.display = "";
        visibleCount++;
      } else {
        card.style.display = "none";
        hiddenCount++;
      }
    });
    
    // Mettre à jour les compteurs de colonnes
    updateColumnCounts();
    
    // Log pour debug
    if(searchTerm){
      console.log(`🔍 Recherche: "${searchTerm}" - ${visibleCount} cartes trouvées, ${hiddenCount} cachées`);
    }
  }
  
  function updateColumnCounts(){
    const columns = document.querySelectorAll(".col");
    columns.forEach(col => {
      const visibleCards = Array.from(col.querySelectorAll(".mcard")).filter(card => {
        return card.style.display !== "none";
      });
      const countSpan = col.querySelector(".col-count");
      if(countSpan){
        countSpan.textContent = visibleCards.length;
      }
    });
  }
  
  function clearSearch(){
    searchInput.value = "";
    performSearch();
    searchInput.focus();
  }
  
  // Event listeners
  searchInput.addEventListener("input", performSearch);
  searchInput.addEventListener("keyup", function(e){
    if(e.key === "Escape"){
      clearSearch();
    }
  });
  
  searchClear.addEventListener("click", clearSearch);
  
  // Initialiser les compteurs au chargement
  setTimeout(updateColumnCounts, 500);
  
  console.log("✅ Search system activated");
})();

// ===== EDITABLE TITLE & ORDER SYSTEM =====
(function(){
  const storagePrefix = "physipro_v280_";
  
  // Fonction pour créer un input d'édition pour le titre
  function editTitle(titleEl){
    if(titleEl.classList.contains("editing")) return;
    
    const card = titleEl.closest(".mcard");
    const cardId = card ? card.dataset.cardId : "0";
    const currentValue = titleEl.textContent;
    
    // Créer l'input
    const input = document.createElement("input");
    input.type = "text";
    input.className = "mcard-title-input";
    input.value = currentValue === "Nom du moulage" || currentValue === "Nouveau Moulage" ? "" : currentValue;
    input.placeholder = "Nom du moulage";
    
    // Marquer comme en édition
    titleEl.classList.add("editing");
    titleEl.style.display = "none";
    titleEl.parentNode.insertBefore(input, titleEl.nextSibling);
    input.focus();
    input.select();
    
    // Fonction de sauvegarde
    function saveTitle(){
      const newValue = input.value.trim() || "Nom du moulage";
      titleEl.textContent = newValue;
      titleEl.classList.remove("editing");
      titleEl.style.display = "";
      input.remove();
      
      // Sauvegarder sur Firebase si connecté
      if(isFirebaseMode && firebaseDb){
        saveCardFieldToFirebase(cardId, "title", newValue);
      }
      // Aussi en local
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_title", newValue);
      }catch(e){}
      console.log(`✏️ Titre carte ${cardId} modifié: "${newValue}"`);
    }
    
    // Enter pour sauvegarder
    input.addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        saveTitle();
      } else if(e.key === "Escape"){
        titleEl.classList.remove("editing");
        titleEl.style.display = "";
        input.remove();
      }
    });
    
    // Blur pour sauvegarder
    input.addEventListener("blur", saveTitle);
  }
  
  // Fonction pour créer un input d'édition pour le numéro de commande
  function editOrder(orderEl){
    if(orderEl.classList.contains("editing")) return;
    
    const card = orderEl.closest(".mcard");
    const cardId = card ? card.dataset.cardId : "0";
    const currentValue = orderEl.textContent;
    
    // Créer l'input
    const input = document.createElement("input");
    input.type = "text";
    input.className = "mcard-order-input";
    input.value = currentValue === "686887" || currentValue === "000000" ? "" : currentValue;
    input.placeholder = "000000";
    input.maxLength = 6;
    
    // Marquer comme en édition
    orderEl.classList.add("editing");
    orderEl.style.display = "none";
    orderEl.parentNode.insertBefore(input, orderEl.nextSibling);
    input.focus();
    input.select();
    
    // Fonction de sauvegarde
    function saveOrder(){
      let newValue = input.value.trim();
      // Valider: seulement des chiffres, max 6
      newValue = newValue.replace(/[^0-9]/g, '').substring(0, 6);
      if(!newValue) newValue = "000000";
      // Pad avec des zéros si nécessaire
      newValue = newValue.padStart(6, '0');
      
      orderEl.textContent = newValue;
      orderEl.classList.remove("editing");
      orderEl.style.display = "";
      input.remove();
      
      // Sauvegarder sur Firebase si connecté
      if(isFirebaseMode && firebaseDb){
        saveCardFieldToFirebase(cardId, "order", newValue);
      }
      // Aussi en local
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_order", newValue);
      }catch(e){}
      console.log(`✏️ Commande carte ${cardId} modifiée: "${newValue}"`);
    }
    
    // Enter pour sauvegarder
    input.addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        saveOrder();
      } else if(e.key === "Escape"){
        orderEl.classList.remove("editing");
        orderEl.style.display = "";
        input.remove();
      }
    });
    
    // Blur pour sauvegarder
    input.addEventListener("blur", saveOrder);
    
    // Filtrer les entrées non numériques
    input.addEventListener("input", function(){
      input.value = input.value.replace(/[^0-9]/g, '');
    });
  }
  
  // Event listener pour les clics sur les titres
  document.addEventListener("click", function(e){
    const title = e.target.closest(".mcard-title");
    if(title && !title.classList.contains("editing")){
      e.stopPropagation();
      editTitle(title);
    }
  });
  
  // Event listener pour les clics sur les numéros de commande
  document.addEventListener("click", function(e){
    const order = e.target.closest(".mcard-order");
    if(order && !order.classList.contains("editing")){
      e.stopPropagation();
      editOrder(order);
    }
  });
  
  // Restaurer les titres et commandes sauvegardés au chargement
  function restoreTitlesAndOrders(){
    const cards = document.querySelectorAll(".mcard");
    cards.forEach(card => {
      const cardId = card.dataset.cardId;
      if(!cardId) return;
      
      // Restaurer le titre
      const titleEl = card.querySelector(".mcard-title");
      if(titleEl){
        try{
          const savedTitle = localStorage.getItem(storagePrefix + "card_" + cardId + "_title");
          if(savedTitle){
            titleEl.textContent = savedTitle;
          }
        }catch(e){}
      }
      
      // Restaurer le numéro de commande
      const orderEl = card.querySelector(".mcard-order");
      if(orderEl){
        try{
          const savedOrder = localStorage.getItem(storagePrefix + "card_" + cardId + "_order");
          if(savedOrder){
            orderEl.textContent = savedOrder;
          }
        }catch(e){}
      }
    });
  }
  
  // Restaurer au chargement
  setTimeout(restoreTitlesAndOrders, 300);
  
  console.log("✅ Editable title & order system activated");
})();

// ===== TOGGLE RED BLINKING (ATTENTE & REPRESENTANT) =====
(function(){
  const storagePrefix = "physipro_v280_";
  
  // Clic sur pastille employé qui clignote vert → arrêter le clignotement
  document.addEventListener("click", function(e){
    const employeePill = e.target.closest(".mcard-employee-label.employee-active");
    if(employeePill && !e.target.closest(".vp-overlay")){
      const card = employeePill.closest(".mcard");
      if(!card) return;
      
      const cardId = card.dataset.cardId;
      const field = employeePill.dataset.menuField;
      
      // Arrêter le clignotement de l'employé
      employeePill.classList.remove("employee-active");
      
      // Retirer " - En production" du texte
      const currentText = employeePill.textContent;
      let newText = currentText;
      if(currentText.includes(" - En production")){
        newText = currentText.replace(" - En production", "");
        employeePill.textContent = newText;
      }
      
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_" + field + "_active", "false");
        // Sauvegarder aussi le texte sans "En production"
        localStorage.setItem(storagePrefix + "card_" + cardId + "_" + field, newText);
      }catch(err){}
      
      console.log("🟢 Clignotement employé arrêté pour carte " + cardId + " - Texte: " + newText);
      
      // Sauvegarder sur Firebase si connecté
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(cardId, field + "_active", false);
        saveCardFieldToFirebase(cardId, field, newText);
      }
      
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    }
  }, true);
  
  // Clic sur pastille représentante qui clignote rouge → arrêter le clignotement
  document.addEventListener("click", function(e){
    const representantPill = e.target.closest(".mcard-menu.representant-alert");
    if(representantPill && !e.target.closest(".vp-overlay")){
      const card = representantPill.closest(".mcard");
      if(!card) return;
      
      const cardId = card.dataset.cardId;
      
      // Arrêter le clignotement de la représentante
      representantPill.classList.remove("representant-alert");
      
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "false");
      }catch(err){}
      
      // Sauvegarder sur Firebase
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(cardId, "representantAlert", false);
      }
      
      console.log("🔴 Clignotement représentante arrêté pour carte " + cardId);
      
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    }
  }, true);
  
  // Clic sur pastille "En attente" qui clignote rouge → arrêter le clignotement
  document.addEventListener("click", function(e){
    const attentePill = e.target.closest(".mcard-attente-reason.attente-active");
    if(attentePill && !e.target.closest(".vp-overlay")){
      const card = attentePill.closest(".mcard");
      if(!card) return;
      
      const cardId = card.dataset.cardId;
      
      // Arrêter le clignotement de la pastille "En attente"
      attentePill.classList.remove("attente-active");
      
      // Arrêter aussi le clignotement de la représentante associée
      const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
      if(representantPill){
        representantPill.classList.remove("representant-alert");
        try{
          localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "false");
        }catch(err){}
      }
      
      // Arrêter le clignotement rouge de la pastille département
      deactivateDeptPillRed(card);
      
      // Retirer la bordure rouge de la carte
      card.classList.remove("attention-needed");
      card.classList.remove("attente-alert-active");
      
      try{
        localStorage.setItem(storagePrefix + "card_" + cardId + "_raison_attente_active", "false");
        localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_alert_active", "false");
        localStorage.removeItem(storagePrefix + "card_" + cardId + "_attente_dept");
      }catch(err){}
      
      // Sauvegarder sur Firebase
      if(typeof isFirebaseMode !== 'undefined' && isFirebaseMode && typeof saveCardFieldToFirebase === 'function'){
        saveCardFieldToFirebase(cardId, "raisonAttenteActive", false);
        saveCardFieldToFirebase(cardId, "representantAlert", false);
        saveCardFieldToFirebase(cardId, "attenteAlertActive", false);
      }
      
      console.log("🔴 Clignotement 'En attente' arrêté pour carte " + cardId);
      
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    }
  }, true);
})();

console.log("✅ PhysiPro v6.9.0 - Dates département éditables + GitHub Ready");
// v3.7.0 - Zone notes maximisée, clic employé actif arrête clignotement sans menu, badge durée plus petit
// v3.7.0+ - Système de recherche activé
// v3.7.1 - Système de log des suppressions avec export CSV et historique complet
// v3.8.0 - Clignotement ROUGE pour pastille "En attente" et représentante
// v4.0.0 - Firebase temps réel + Titre et numéro de commande éditables en cliquant
// v4.1.0 - Système de connexion avec mots de passe + Mode lecture seule
// v4.2.0 - Menu Liens photo avec 3 types de liens (dossier client, moulage atelier, devis)
// v5.0.0 - SYNCHRONISATION TEMPS RÉEL COMPLÈTE - Toutes les modifications visibles instantanément par tous
// v5.1.0 - Badge utilisateur repositionné + Compatibilité téléphones mobiles
// v5.2.0 - Menu amélioré (sélection + application séparées), suppression de valeurs corrigée, optimisation
// v5.3.0 - Nouvelles cartes Firebase ont maintenant la même structure que les cartes originales

// ===== PHOTO LINKS SYSTEM - VERSION MODERNE =====
// Support OneDrive / SharePoint avec conversion automatique des liens
(function(){
  const storagePrefix = "physipro_v280_";
  const photoLinksOverlay = document.getElementById("photoLinksOverlay");
  const photoLinksClose = document.getElementById("photoLinksClose");

  const photoListClient = document.getElementById("photoListClient");
  const photoListAtelier = document.getElementById("photoListAtelier");
  const photoListDevis = document.getElementById("photoListDevis");

  const viewerOverlay = document.getElementById("photoViewerOverlay");
  const viewerClose = document.getElementById("photoViewerClose");
  const viewerImage = document.getElementById("photoViewerImage");
  const viewerThumbs = document.getElementById("photoViewerThumbs");
  const viewerPrev = document.getElementById("photoViewerPrev");
  const viewerNext = document.getElementById("photoViewerNext");
  const viewerCounter = document.getElementById("photoViewerCounter");

  const sectionLists = {
    client: photoListClient,
    atelier: photoListAtelier,
    devis: photoListDevis
  };

  let currentPhotoCardId = null;
  let currentPhotoPill = null;
  let currentViewerPhotos = [];
  let currentViewerIndex = 0;

  // ==========================================
  // CONVERTISSEUR PRO SHAREPOINT / ONEDRIVE
  // Exposé globalement pour accès depuis partout
  // ==========================================
  
  // Fonction pour convertir un lien SharePoint/OneDrive en lien direct
  window.convertLinkPro = async function(url, callback) {
    if(!url || typeof url !== 'string') {
      if(callback) callback([url || '']);
      return;
    }
    
    url = url.trim();
    
    try {
      let isSharePoint = url.includes("sharepoint.com");
      let isOneDrive = url.includes("onedrive") || url.includes("1drv.ms");

      // Si ce n'est ni SharePoint ni OneDrive, traiter les autres types
      if (!isSharePoint && !isOneDrive) {
        // Google Drive
        if(url.includes("drive.google.com")){
          const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
          if(match){
            if(callback) callback(["https://drive.google.com/uc?export=view&id=" + match[1]]);
            return;
          }
          const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
          if(match2){
            if(callback) callback(["https://drive.google.com/uc?export=view&id=" + match2[1]]);
            return;
          }
        }
        
        // Dropbox
        if(url.includes("dropbox.com")){
          if(callback) callback([url.replace("dl=0", "raw=1").replace("www.dropbox.com", "dl.dropboxusercontent.com")]);
          return;
        }
        
        // Imgur
        if(url.includes("imgur.com") && !url.includes("i.imgur.com")){
          const match = url.match(/imgur\.com\/([a-zA-Z0-9]+)$/);
          if(match){
            if(callback) callback(["https://i.imgur.com/" + match[1] + ".jpg"]);
            return;
          }
        }
        
        // Lien direct (déjà une image)
        if(callback) callback([url]);
        return;
      }


      // Conversion SharePoint/OneDrive (liens de partage :i:/)
      try {
        const originalUrl = url.trim();
        const u = new URL(originalUrl);

        // Si ce n'est pas un lien de type :i: ou :f:, on renvoie tel quel
        if (!u.pathname.includes("/:i:/") && !u.pathname.includes("/:f:/")) {
          console.warn("Format SharePoint non reconnu, utilisation du lien original");
          if (callback) callback([originalUrl]);
          return;
        }

        const isImage = u.pathname.includes("/:i:/");

        if (isImage) {
          // Pour une image unique : utiliser le endpoint officiel download.aspx
          // en conservant tous les paramètres d'origine (dont le token ?e=...).
          const origin = u.origin; // https://physipro-my.sharepoint.com
          const direct = origin + "/_layouts/15/download.aspx?SourceUrl=" + encodeURIComponent(originalUrl);
          console.log("📸 Lien SharePoint image via download.aspx:", direct);
          if (callback) callback([direct]);
          return;
        } else {
          // Pour un dossier SharePoint (:f:/), on renvoie le lien original.
          console.log("📁 Lien dossier SharePoint utilisé tel quel (pas de conversion dossier):", originalUrl);
          if (callback) callback([originalUrl]);
          return;
        }
      } catch (errShare) {
        console.error("Erreur conversion SharePoint/OneDrive:", errShare);
        if (callback) callback([url]);
        return;
      }
      }
    } catch(e) {
      console.error("Erreur convertLinkPro:", e);
      if(callback) callback([url]);
    }
  };
  
  // Fonction synchrone pour conversion simple (compatibilité)
  window.convertToDirectLink = function(url){
    if(!url) return url;
    url = url.trim();

    // Pour SharePoint/OneDrive, utiliser la même logique que dans convertLinkPro
    if(url.includes("sharepoint.com") || url.includes("onedrive") || url.includes("1drv.ms")){
      try {
        const originalUrl = url.trim();
        const u = new URL(originalUrl);

        if (u.pathname.includes("/:i:/")) {
          const origin = u.origin;
          return origin + "/_layouts/15/download.aspx?SourceUrl=" + encodeURIComponent(originalUrl);
        }

        // Dossiers ou autres formats : renvoyer l'URL telle quelle
        return originalUrl;
      } catch(e){
        console.error("Erreur convertToDirectLink (SharePoint/OneDrive):", e);
        return url;
      }
    }

    // Google Drive
    if(url.includes("drive.google.com")){
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if(match) return "https://drive.google.com/uc?export=view&id=" + match[1];
      const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if(match2) return "https://drive.google.com/uc?export=view&id=" + match2[1];
    }
       console.error("Erreur convertToDirectLink (SharePoint/OneDrive):", e);
        return url;
      }
    }

    // Google Drive
    if(url.includes("drive.google.com")){
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if(match) return "https://drive.google.com/uc?export=view&id=" + match[1];
      const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if(match2) return "https://drive.google.com/uc?export=view&id=" + match2[1];
    }
-9_-]+)/);
      if(match) return "https://drive.google.com/uc?export=view&id=" + match[1];
      const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if(match2) return "https://drive.google.com/uc?export=view&id=" + match2[1];
    }
    
    // Dropbox
    if(url.includes("dropbox.com")){
      return url.replace("dl=0", "raw=1").replace("www.dropbox.com", "dl.dropboxusercontent.com");
    }
    
    // Imgur
    if(url.includes("imgur.com") && !url.includes("i.imgur.com")){
      const match = url.match(/imgur\.com\/([a-zA-Z0-9]+)$/);
      if(match) return "https://i.imgur.com/" + match[1] + ".jpg";
    }
    
    return url;
  };
  
  // Alias local
  const convertLinkPro = window.convertLinkPro;
  const convertToDirectLink = window.convertToDirectLink;
  
  // ==========================================
  // AUTO-CONVERSION DES LIENS PHOTO
  // ==========================================
  
  let photoInputTimers = {};
  
  // Activer l'auto-conversion sur un champ input
  function enableAutoConversionOnInput(input){
    if(!input || input.dataset.autoConvertEnabled) return;
    input.dataset.autoConvertEnabled = "true";
    
    input.addEventListener("input", function(){
      const inputId = this.dataset.index || Math.random().toString();
      
      // Anti multi-déclenchements
      if(photoInputTimers[inputId]) clearTimeout(photoInputTimers[inputId]);
      
      // Attendre que l'utilisateur ait fini de coller
      photoInputTimers[inputId] = setTimeout(() => {
        processAutoConversionForInput(this);
      }, 500);
    });
    
    // Aussi sur paste pour une conversion immédiate
    input.addEventListener("paste", function(e){
      const inputEl = this;
      setTimeout(() => {
        processAutoConversionForInput(inputEl);
      }, 100);
    });
  }
  
  // Convertir le contenu d'un input
  async function processAutoConversionForInput(input){
    if(!input) return;
    
    let rawUrl = input.value.trim();
    if(!rawUrl) return;
    
    // Vérifier si c'est un lien SharePoint/OneDrive qui nécessite conversion
    if(rawUrl.includes("sharepoint.com") || rawUrl.includes("onedrive") || rawUrl.includes("1drv.ms")){
      try {
        // Utiliser la conversion pro
        await convertLinkPro(rawUrl, function(convertedUrls){
          if(convertedUrls && convertedUrls.length > 0 && convertedUrls[0] !== rawUrl){
            input.value = convertedUrls[0];
            console.log("✅ Lien auto-converti:", convertedUrls[0]);
            
            // Feedback visuel
            input.style.backgroundColor = "#1a3a1a";
            setTimeout(() => {
              input.style.backgroundColor = "";
            }, 1000);
          }
        });
      } catch(e) {
        console.warn("Erreur auto-conversion:", e);
      }
    }
  }
  
  // Activer l'auto-conversion sur tous les champs photo existants
  function enableAllPhotoAutoConversion(){
    const inputs = document.querySelectorAll("input.photo-link-input");
    inputs.forEach(input => enableAutoConversionOnInput(input));
  }
  
  // Exposer globalement pour accès depuis d'autres parties du code
  window.enableAllPhotoAutoConversion = enableAllPhotoAutoConversion;

  function parseStoredPhotoValue(raw){
    if(!raw) return [];
    try{
      const trimmed = String(raw).trim();
      if(!trimmed) return [];
      if(trimmed.startsWith("[")){
        const arr = JSON.parse(trimmed);
        if(Array.isArray(arr)) return arr.filter(v => typeof v === "string" && v.trim());
        return [];
      }
      return [trimmed];
    }catch(e){
      return [];
    }
  }

  function loadPhotoListForType(type){
    const listEl = sectionLists[type];
    if(!listEl) return;

    let urls = [];
    try{
      const raw = localStorage.getItem(storagePrefix + "card_" + currentPhotoCardId + "_photo_" + type);
      urls = parseStoredPhotoValue(raw);
    }catch(e){
      urls = [];
    }

    // Remplir les 5 champs d'input existants
    const inputs = listEl.querySelectorAll("input.photo-link-input");
    inputs.forEach((input, idx) => {
      input.value = urls[idx] || "";
    });
  }

  function collectUrlsFromList(listEl){
    const urls = [];
    if(!listEl) return urls;
    const inputs = listEl.querySelectorAll("input.photo-link-input");
    inputs.forEach(input => {
      const v = input.value.trim();
      if(v) urls.push(v);
    });
    return urls;
  }

  function savePhotoSection(type){
    if(!currentPhotoCardId) return;
    const listEl = sectionLists[type];
    if(!listEl) return;

    const urls = collectUrlsFromList(listEl);
    const key = storagePrefix + "card_" + currentPhotoCardId + "_photo_" + type;
    const raw = urls.length ? JSON.stringify(urls) : "";

    try{
      if(raw){
        localStorage.setItem(key, raw);
      } else {
        localStorage.removeItem(key);
      }

      if(typeof isFirebaseMode !== "undefined" && isFirebaseMode && typeof saveCardFieldToFirebase === "function"){
        saveCardFieldToFirebase(currentPhotoCardId, "photo_" + type, raw);
        console.log("💾 Firebase: Liens photo " + type + " sauvegardés (" + urls.length + ")");
      }
      
      // Mettre à jour l'indicateur sur la pastille correspondante
      updatePhotoPillsForCard(currentPhotoCardId);
      
      // Feedback visuel
      const btn = listEl.closest(".photo-link-section").querySelector(".photo-link-btn-save-section");
      if(btn){
        const originalText = btn.textContent;
        btn.textContent = "✓ Enregistré!";
        btn.style.background = "linear-gradient(to bottom,#0b7a35,#085020)";
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = "";
        }, 1500);
      }
    }catch(e){
      console.warn("Erreur sauvegarde liens photo:", e);
    }
  }

  function updatePhotoPillsForCard(cardId){
    const card = document.querySelector('.mcard[data-card-id="' + cardId + '"]');
    if(!card) return;
    
    const types = ["client", "atelier", "devis"];
    types.forEach(type => {
      const pill = card.querySelector('.mcard-photo-pill[data-photo-type="' + type + '"]');
      if(pill){
        try{
          const raw = localStorage.getItem(storagePrefix + "card_" + cardId + "_photo_" + type);
          const urls = parseStoredPhotoValue(raw);
          if(urls.length > 0){
            pill.classList.add("has-photos");
          } else {
            pill.classList.remove("has-photos");
          }
        }catch(e){}
      }
    });
  }

  // Ouvrir le viewer de photos avec conversion Pro
  async function openPhotoViewer(urls, startIndex){
    if(!urls || !urls.length) return;
    
    // Garder les URLs originales pour le bouton "Ouvrir"
    currentViewerPhotosOriginal = urls.slice();
    
    // Convertir tous les liens avec la méthode Pro (supporte les dossiers SharePoint)
    let allConvertedUrls = [];
    
    for(let url of urls){
      await convertLinkPro(url, function(convertedUrls){
        convertedUrls.forEach(u => allConvertedUrls.push(u));
      });
    }
    
    currentViewerPhotos = allConvertedUrls;
    currentViewerIndex = Math.max(0, Math.min(startIndex || 0, currentViewerPhotos.length - 1));
    
    console.log("📸 Viewer ouvert avec " + currentViewerPhotos.length + " image(s)");
    
    renderViewer();
    viewerOverlay.classList.remove("hidden");
  }
  
  // Variable pour stocker les URLs originales
  let currentViewerPhotosOriginal = [];

  function renderViewer(){
    if(!currentViewerPhotos.length){
      viewerOverlay.classList.add("hidden");
      return;
    }
    const url = currentViewerPhotos[currentViewerIndex];
    viewerImage.src = url;
    
    // Compteur
    if(viewerCounter){
      viewerCounter.textContent = (currentViewerIndex + 1) + " / " + currentViewerPhotos.length;
    }

    // Thumbs
    viewerThumbs.innerHTML = "";
    currentViewerPhotos.forEach((u, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "photo-viewer-thumb" + (idx === currentViewerIndex ? " active" : "");
      wrap.dataset.index = String(idx);
      const img = document.createElement("img");
      img.src = u;
      img.onerror = function(){ this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='56'%3E%3Crect fill='%23333' width='80' height='56'/%3E%3Ctext x='40' y='32' text-anchor='middle' fill='%23666' font-size='10'%3EErreur%3C/text%3E%3C/svg%3E"; };
      wrap.appendChild(img);
      viewerThumbs.appendChild(wrap);
    });
  }
  
  // Ouvrir le lien dans un nouvel onglet (utile pour SharePoint)
  function openCurrentPhotoInNewTab(){
    const originalUrl = currentViewerPhotosOriginal[currentViewerIndex] || currentViewerPhotos[currentViewerIndex];
    if(originalUrl){
      window.open(originalUrl, '_blank');
    }
  }
  
  // Bouton "Ouvrir dans un nouvel onglet"
  const photoViewerOpenBtn = document.getElementById("photoViewerOpenBtn");
  if(photoViewerOpenBtn){
    photoViewerOpenBtn.addEventListener("click", openCurrentPhotoInNewTab);
  }
  
  // Clic sur l'image pour ouvrir dans un nouvel onglet
  if(viewerImage){
    viewerImage.addEventListener("click", openCurrentPhotoInNewTab);
  }

  function closePhotoViewer(){
    viewerOverlay.classList.add("hidden");
    currentViewerPhotos = [];
    currentViewerIndex = 0;
    viewerImage.src = "";
    viewerThumbs.innerHTML = "";
  }

  function openPhotoLinksMenu(cardId, pill){
    currentPhotoCardId = cardId;
    currentPhotoPill = pill || null;

    ["client","atelier","devis"].forEach(type => loadPhotoListForType(type));
    photoLinksOverlay.classList.remove("hidden");
    
    // Activer l'auto-conversion sur tous les champs photo
    setTimeout(() => {
      enableAllPhotoAutoConversion();
    }, 100);
  }

  function closePhotoLinksMenu(){
    photoLinksOverlay.classList.add("hidden");
    currentPhotoCardId = null;
    currentPhotoPill = null;
  }

  // Overlay listeners
  if(photoLinksClose){
    photoLinksClose.addEventListener("click", closePhotoLinksMenu);
  }
  if(photoLinksOverlay){
    photoLinksOverlay.addEventListener("click", function(e){
      if(e.target === photoLinksOverlay){
        closePhotoLinksMenu();
      }
    });
  }

  // Gestion des clics dans le panneau de liens
  const panel = document.querySelector(".photo-links-panel");
  if(panel){
    panel.addEventListener("click", function(e){
      const target = e.target;

      // Effacer un champ
      if(target.classList.contains("photo-link-row-delete")){
        const row = target.closest(".photo-link-row");
        if(row){
          const input = row.querySelector("input");
          if(input) input.value = "";
        }
      }

      // Enregistrer une section
      if(target.classList.contains("photo-link-btn-save-section")){
        const type = target.getAttribute("data-type");
        savePhotoSection(type);
      }
    });
  }

  // Clic sur la pastille "Lien photo" (ancienne)
  document.addEventListener("click", function(e){
    const pill = e.target.closest(".mcard-pill.photo-link-pill");
    if(pill){
      e.stopPropagation();
      const card = pill.closest(".mcard");
      if(!card) return;
      const cardId = card.dataset.cardId;
      openPhotoLinksMenu(cardId, pill);
    }
  });

  // Clic sur les pastilles photo (Photo client, Photo atelier, Photo devis)
  document.addEventListener("click", function(e){
    const pill = e.target.closest(".mcard-photo-pill");
    if(!pill) return;
    
    const card = pill.closest(".mcard");
    if(!card) return;
    
    const type = pill.getAttribute("data-photo-type");
    const cardId = card.dataset.cardId;
    
    e.stopPropagation();
    
    // Récupérer les URLs de ce type
    try{
      const raw = localStorage.getItem(storagePrefix + "card_" + cardId + "_photo_" + type);
      const urls = parseStoredPhotoValue(raw);
      
      if(urls.length > 0){
        // Ouvrir le viewer directement avec les photos de ce type
        openPhotoViewer(urls, 0);
      } else {
        // Pas de photos, ouvrir le menu pour en ajouter
        openPhotoLinksMenu(cardId, pill);
      }
    }catch(e){
      openPhotoLinksMenu(cardId, pill);
    }
  });

  // Restauration visuelle des pastilles au chargement
  function restorePhotoIndicators(){
    const cards = document.querySelectorAll(".mcard");
    cards.forEach(card => {
      const cardId = card.dataset.cardId;
      if(!cardId) return;
      updatePhotoPillsForCard(cardId);
    });
  }
  setTimeout(restorePhotoIndicators, 400);

  // VIEWER listeners
  if(viewerOverlay){
    viewerOverlay.addEventListener("click", function(e){
      if(e.target === viewerOverlay || e.target === document.querySelector(".photo-viewer-backdrop")){
        closePhotoViewer();
      }
    });
  }
  if(viewerClose){
    viewerClose.addEventListener("click", closePhotoViewer);
  }
  if(viewerPrev){
    viewerPrev.addEventListener("click", function(){
      if(!currentViewerPhotos.length) return;
      currentViewerIndex = (currentViewerIndex - 1 + currentViewerPhotos.length) % currentViewerPhotos.length;
      renderViewer();
    });
  }
  if(viewerNext){
    viewerNext.addEventListener("click", function(){
      if(!currentViewerPhotos.length) return;
      currentViewerIndex = (currentViewerIndex + 1) % currentViewerPhotos.length;
      renderViewer();
    });
  }
  if(viewerThumbs){
    viewerThumbs.addEventListener("click", function(e){
      const thumb = e.target.closest(".photo-viewer-thumb");
      if(thumb){
        const idx = parseInt(thumb.dataset.index || "0", 10);
        if(!isNaN(idx)){
          currentViewerIndex = idx;
          renderViewer();
        }
      }
    });
  }

  document.addEventListener("keydown", function(e){
    if(viewerOverlay && !viewerOverlay.classList.contains("hidden")){
      if(e.key === "Escape"){
        closePhotoViewer();
      } else if(e.key === "ArrowLeft"){
        if(currentViewerPhotos.length){
          currentViewerIndex = (currentViewerIndex - 1 + currentViewerPhotos.length) % currentViewerPhotos.length;
          renderViewer();
        }
      } else if(e.key === "ArrowRight"){
        if(currentViewerPhotos.length){
          currentViewerIndex = (currentViewerIndex + 1) % currentViewerPhotos.length;
          renderViewer();
        }
      }
    }
  });

  console.log("✅ Nouveau système de liens & viewer photo activé");
})()
;

// ===== RESTAURATION VISUELLE CARTES EN ATTENTE =====
(function(){
  const storagePrefix = "physipro_v280_";
  
  function restoreAttenteColumnVisuals(){
    const board = document.querySelector(".board");
    if(!board) return;
    
    const columns = Array.from(board.querySelectorAll(".col"));
    const attenteColumn = columns[7]; // Colonne En attente est l'index 7
    
    if(!attenteColumn) return;
    
    const cardsInAttente = attenteColumn.querySelectorAll(".mcard");
    cardsInAttente.forEach(card => {
      const cardId = card.dataset.cardId;
      
      // TOUJOURS ajouter in-attente-column pour les cartes DANS la colonne En attente
      card.classList.add("in-attente-column");
      
      // Transformer la pastille de délai en "En attente depuis"
      const delayPill = card.querySelector('.mcard-delay-pill');
      if(delayPill){
        // Récupérer la date d'entrée
        let dateEntree = delayPill.dataset.attenteDepuis;
        if(!dateEntree){
          try{
            dateEntree = localStorage.getItem(storagePrefix + "card_" + cardId + "_attente_depuis");
            if(dateEntree) delayPill.dataset.attenteDepuis = dateEntree;
          }catch(e){}
        }
        
        // Si pas de date, mettre la date d'aujourd'hui
        if(!dateEntree || dateEntree === ''){
          dateEntree = new Date().toISOString().split('T')[0];
          delayPill.dataset.attenteDepuis = dateEntree;
          try{
            localStorage.setItem(storagePrefix + "card_" + cardId + "_attente_depuis", dateEntree);
          }catch(e){}
        }
        
        // Calculer les jours
        const dateObj = new Date(dateEntree);
        const aujourdhui = new Date();
        const diffTime = aujourdhui - dateObj;
        let joursAttente = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if(joursAttente < 0) joursAttente = 0;
        const joursPluriel = joursAttente <= 1 ? "jour" : "jours";
        
        // Stocker les données pour le switch
        delayPill.dataset.joursAttente = joursAttente;
        delayPill.dataset.attenteText = 'En attente depuis ' + joursAttente + ' ' + joursPluriel;
        
        // S'assurer que le mode show-delay-mode est retiré
        delayPill.classList.remove("show-delay-mode");
        
        // Mettre à jour l'affichage (mode attente par défaut)
        delayPill.innerHTML = 'En attente depuis&nbsp;<span class="jours-nombre">' + joursAttente + '</span>&nbsp;' + joursPluriel;
      }
      
      // Ajouter les alertes visuelles SEULEMENT si la raison le nécessite
      if(cardNecessiteAlerte(card)){
        card.classList.add("attention-needed");
        if(delayPill) delayPill.classList.add("attente-active");
        
        // Vérifier si le clignotement de la représentante doit être activé
        const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(representantPill){
          try{
            const alertState = localStorage.getItem(storagePrefix + "card_" + cardId + "_representant_alert");
            if(alertState !== "false"){
              representantPill.classList.add("representant-alert");
              localStorage.setItem(storagePrefix + "card_" + cardId + "_representant_alert", "true");
            }
          }catch(e){}
        }
        
        // Restaurer le clignotement rouge sur la pastille département
        const raisonPill = card.querySelector('.attente-raison-pill');
        if(raisonPill){
          const raison = raisonPill.textContent.trim();
          const deptForRaison = getDeptFromRaison(raison);
          if(deptForRaison){
            activateDeptPillRed(card, deptForRaison);
          }
        }
      } else {
        // Pas d'alerte clignotante pour cette raison - mais GARDER in-attente-column
        card.classList.remove("attention-needed");
        if(delayPill) delayPill.classList.remove("attente-active");
        
        const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(representantPill){
          representantPill.classList.remove("representant-alert");
        }
        
        // Retirer tout clignotement rouge de pastille département
        deactivateDeptPillRed(card);
      }
    });
    
    // AUSSI: Nettoyer les cartes qui ne sont PAS dans En attente
    const allCards = board.querySelectorAll(".mcard");
    allCards.forEach(card => {
      const col = card.closest(".col");
      const colIndex = columns.indexOf(col);
      
      // Si la carte n'est PAS dans la colonne En attente (index 7)
      if(colIndex !== 7){
        // Retirer toutes les classes liées à En attente
        card.classList.remove("in-attente-column");
        card.classList.remove("attente-alert-active");
        card.classList.remove("attention-needed");
        
        // Remettre la pastille en mode "Délai restant"
        const delayPill = card.querySelector('.mcard-delay-pill');
        if(delayPill){
          delayPill.classList.remove("attente-active");
          delayPill.dataset.attenteDepuis = "";
          // Ne pas écraser si le délai est déjà calculé correctement
          if(delayPill.innerHTML.includes("En attente")){
            delayPill.innerHTML = '<span>Délai restant 0 jours</span>';
          }
        }
        
        // Retirer les alertes
        const representantPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
        if(representantPill) representantPill.classList.remove("representant-alert");
        
        const raisonPill = card.querySelector('.mcard-menu[data-menu-field="raison_attente"]');
        if(raisonPill) raisonPill.classList.remove("attente-active");
        
        // Retirer le clignotement rouge des départements
        if(typeof deactivateDeptPillRed === 'function'){
          deactivateDeptPillRed(card);
        }
      }
    });
    
    console.log("✅ Visuels En attente restaurés pour " + cardsInAttente.length + " cartes");
  }
  
  // Restaurer au chargement (après le chargement Firebase)
  setTimeout(restoreAttenteColumnVisuals, 800);
  
  // Exposer globalement pour être appelé après les mises à jour Firebase
  window.restoreAttenteColumnVisuals = restoreAttenteColumnVisuals;
})();

// ===== SYSTÈME D'IMPORT/EXPORT DES CARTES =====
(function(){
  const cardsExportBtn = document.getElementById("cardsExport");
  const cardsImportBtn = document.getElementById("cardsImport");
  const cardsImportFile = document.getElementById("cardsImportFile");
  
  // Exporter toutes les cartes
  cardsExportBtn.addEventListener("click", function(){
    const cards = document.querySelectorAll(".mcard");
    const exportData = {
      version: "5.4.0",
      exportDate: new Date().toISOString(),
      exportedBy: currentUser ? currentUser.name : "Inconnu",
      cards: []
    };
    
    cards.forEach(card => {
      const cardData = extractCardData(card);
      cardData.cardId = card.dataset.cardId;
      exportData.cards.push(cardData);
    });
    
    // Créer et télécharger le fichier JSON
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "physipro_cartes_" + new Date().toISOString().split("T")[0] + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log("📤 " + exportData.cards.length + " cartes exportées");
    alert("✅ " + exportData.cards.length + " cartes exportées avec succès!");
  });
  
  // Déclencher le sélecteur de fichier
  cardsImportBtn.addEventListener("click", function(){
    cardsImportFile.click();
  });
  
  // Importer les cartes
  cardsImportFile.addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(evt){
      try{
        const importData = JSON.parse(evt.target.result);
        
        if(!importData.cards || !Array.isArray(importData.cards)){
          alert("❌ Fichier invalide: pas de cartes trouvées");
          return;
        }
        
        const confirmMsg = "Voulez-vous importer " + importData.cards.length + " cartes ?\n\n" +
                          "Fichier exporté le: " + (importData.exportDate ? new Date(importData.exportDate).toLocaleString() : "Date inconnue") + "\n" +
                          "Par: " + (importData.exportedBy || "Inconnu") + "\n\n" +
                          "⚠️ Les cartes existantes avec le même ID seront mises à jour.";
        
        if(!confirm(confirmMsg)) return;
        
        let imported = 0;
        let updated = 0;
        
        importData.cards.forEach(cardData => {
          const cardId = cardData.cardId || generateUniqueCardId();
          const existingCard = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
          
          if(existingCard){
            // Mettre à jour la carte existante
            updateExistingCard(existingCard, cardData);
            updated++;
          } else {
            // Créer une nouvelle carte
            const newCard = createNewCardElement(cardId, cardData);
            placeCardInColumn(newCard, cardData.column || 0, cardData.position || 999);
            imported++;
          }
          
          // Sauvegarder sur Firebase si connecté
          if(isFirebaseMode && firebaseDb){
            saveCardToFirebase(cardId, cardData);
          }
        });
        
        updateAllColumnCounts();
        
        console.log("📥 Import terminé: " + imported + " nouvelles cartes, " + updated + " mises à jour");
        alert("✅ Import terminé!\n\n" + imported + " nouvelles cartes créées\n" + updated + " cartes mises à jour");
        
      } catch(err){
        console.error("Erreur d'import:", err);
        alert("❌ Erreur lors de l'import: " + err.message);
      }
    };
    reader.readAsText(file);
    
    // Reset le champ pour permettre de réimporter le même fichier
    e.target.value = "";
  });
  
  console.log("✅ Cards import/export system activated");
})();

// ===== SYSTÈME DE NOTES LECTURE SEULE (VISITEURS) =====
(function(){
  const notesOverlay = document.getElementById("notesReadonlyOverlay");
  const notesContent = document.getElementById("notesReadonlyContent");
  const notesCardName = document.getElementById("notesReadonlyCardName");
  const notesClose = document.getElementById("notesReadonlyClose");
  
  function openNotesReadonly(card){
    const textarea = card.querySelector(".mcard-notes-input");
    const titleEl = card.querySelector(".mcard-title");
    const orderEl = card.querySelector(".mcard-order");
    
    const notesText = textarea ? textarea.value.trim() : "";
    const cardTitle = titleEl ? titleEl.textContent : "Sans nom";
    const cardOrder = orderEl ? orderEl.textContent : "";
    
    // Afficher le nom de la carte
    notesCardName.textContent = cardTitle + (cardOrder ? " - #" + cardOrder : "");
    
    // Afficher le contenu des notes
    if(notesText){
      notesContent.innerHTML = "";
      notesContent.textContent = notesText;
    } else {
      notesContent.innerHTML = '<div class="notes-readonly-empty">Aucune note pour ce moulage</div>';
    }
    
    notesOverlay.classList.remove("hidden");
  }
  
  function closeNotesReadonly(){
    notesOverlay.classList.add("hidden");
  }
  
  // Clic sur zone notes en mode lecture seule
  document.addEventListener("click", function(e){
    // Vérifier si on est en mode lecture seule
    if(!document.body.classList.contains("readonly-mode")) return;
    
    const notesInput = e.target.closest(".mcard-notes-input");
    if(notesInput){
      e.preventDefault();
      e.stopPropagation();
      
      const card = notesInput.closest(".mcard");
      if(card){
        openNotesReadonly(card);
      }
    }
  });
  
  // Fermer le popup
  notesClose.addEventListener("click", closeNotesReadonly);
  
  notesOverlay.addEventListener("click", function(e){
    if(e.target === notesOverlay){
      closeNotesReadonly();
    }
  });
  
  // Fermer avec Escape
  document.addEventListener("keydown", function(e){
    if(e.key === "Escape" && !notesOverlay.classList.contains("hidden")){
      closeNotesReadonly();
    }
  });
  
  console.log("✅ Notes readonly system for visitors activated");
})();

// ===== SYSTÈME DE NOTIFICATION REPRÉSENTANTES (MARIE-PIER / MARIE-SOLEIL) =====
(function(){
  const storagePrefix = "physipro_v280_";
  const notificationOverlay = document.getElementById("representanteNotificationOverlay");
  const notificationMessage = document.getElementById("representanteNotificationMessage");
  const notificationCloseBtn = document.getElementById("representanteNotificationClose");
  
  let notificationCheckDone = false;
  
  // Vérifier si l'utilisateur actuel est une représentante concernée
  function isTargetRepresentante(){
    if(!currentUser) return false;
    const name = currentUser.name;
    // Utiliser la liste des représentantes de MENU_DATA
    return typeof MENU_DATA !== 'undefined' && MENU_DATA.representantes && MENU_DATA.representantes.includes(name);
  }
  
  // Trouver les cartes en attente assignées à la représentante avec raison valide
  function findUnseenCardsInAttenteForRepresentante(){
    if(!currentUser) {
      console.log("🔔 Pas d'utilisateur connecté");
      return [];
    }
    
    const board = document.querySelector(".board");
    if(!board) {
      console.log("🔔 Board non trouvé");
      return [];
    }
    
    const columns = Array.from(board.querySelectorAll(".col"));
    const attenteColumn = columns[7]; // Colonne 8 = En attente
    if(!attenteColumn) {
      console.log("🔔 Colonne En attente non trouvée");
      return [];
    }
    
    const cards = attenteColumn.querySelectorAll(".mcard");
    console.log("🔔 Cartes dans En attente:", cards.length);
    const matchingCards = [];
    
    cards.forEach(card => {
      const cardId = card.dataset.cardId;
      if(!cardId) return;
      
      // Vérifier si cette carte a DÉJÀ été vue
      const notificationSeen = localStorage.getItem(storagePrefix + "card_" + cardId + "_notification_seen_by");
      if(notificationSeen) {
        console.log("🔔 Carte " + cardId + " déjà vue par " + notificationSeen);
        return;
      }
      
      // Vérifier la raison - utiliser la fonction globale
      const hasValidReason = cardNecessiteAlerte(card);
      console.log("🔔 Carte " + cardId + " - raison valide:", hasValidReason);
      if(!hasValidReason) return;
      
      // Vérifier la représentante assignée
      const repPill = card.querySelector('.mcard-menu[data-menu-field="representant"]');
      if(repPill){
        const repName = repPill.textContent.trim();
        console.log("🔔 Carte " + cardId + " - représentante:", repName, "- utilisateur:", currentUser.name);
        if(repName === currentUser.name){
          // Récupérer le nom et numéro de commande
          const titleEl = card.querySelector(".mcard-title");
          const orderEl = card.querySelector(".mcard-order");
          const title = titleEl ? titleEl.textContent : "Moulage";
          const order = orderEl ? orderEl.textContent : "";
          
          matchingCards.push({ 
            cardId: cardId, 
            card: card,
            name: title,
            order: order
          });
          console.log("🔔 ✅ Carte " + cardId + " CORRESPOND!");
        }
      }
    });
    
    return matchingCards;
  }
  
  // Afficher la notification
  function showRepresentanteNotification(){
    console.log("🔔 showRepresentanteNotification() appelé");
    console.log("🔔 notificationCheckDone:", notificationCheckDone);
    console.log("🔔 currentUser:", currentUser);
    console.log("🔔 isTargetRepresentante():", isTargetRepresentante());
    
    if(notificationCheckDone) {
      console.log("🔔 Notification déjà vérifiée, skip");
      return;
    }
    if(!isTargetRepresentante()) {
      console.log("🔔 Utilisateur n'est pas une représentante cible, skip");
      return;
    }
    
    setTimeout(function(){
      console.log("🔔 Recherche des cartes non vues...");
      const matchingCards = findUnseenCardsInAttenteForRepresentante();
      console.log("🔔 Cartes trouvées:", matchingCards.length, matchingCards);
      
      if(matchingCards.length === 0) {
        console.log("🔔 Aucune carte correspondante trouvée");
        return;
      }
      
      notificationCheckDone = true;
      
      // Construire le message avec les noms des moulages
      let message = "";
      if(matchingCards.length === 1){
        const c = matchingCards[0];
        const orderStr = c.order && c.order !== "000000" ? " #" + c.order : "";
        message = "Le moulage <strong>" + c.name + orderStr + "</strong> est maintenant en attente. Vérifiez la note pour voir la raison et pour faire le suivi si nécessaire.";
      } else {
        message = "Les moulages suivants sont en attente:<br>";
        matchingCards.forEach(c => {
          const orderStr = c.order && c.order !== "000000" ? " #" + c.order : "";
          message += "• <strong>" + c.name + orderStr + "</strong><br>";
        });
        message += "Vérifiez les notes pour voir les raisons et faire le suivi si nécessaire.";
      }
      
      notificationMessage.innerHTML = message;
      notificationOverlay.classList.remove("hidden");
      
    }, 3000);
  }
  
  // Fermer la notification
  function closeRepresentanteNotification(){
    notificationOverlay.classList.add("hidden");
  }
  
  if(notificationCloseBtn){
    notificationCloseBtn.addEventListener("click", closeRepresentanteNotification);
  }
  
  // Exposer les fonctions et constantes globalement
  window.checkRepresentanteNotification = showRepresentanteNotification;
  window.RAISONS_NOTIFICATION = RAISONS_ALERTE_ROUGE;
  
  console.log("✅ Representante notification system activated");
})();

console.log("✅ PhysiPro v6.9.0 - VERSION GITHUB PAGES");

</script>


</body>
</html>
