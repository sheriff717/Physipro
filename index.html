<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhysiPro Moulage v12.0</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
/* =====================================================
   PHYSIPRO MOULAGE v12.0 - CODE PROPRE
   ===================================================== */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  overflow: hidden;
  font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  background: #0f172a;
  color: #fff;
}

.app-root {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100%;
  overflow: hidden;
}

.hidden { display: none !important; }

/* ===== TOP BAR ===== */
.topbar {
  flex: 0 0 auto;
  width: 100%;
  padding: 4px 20px 6px 20px;
  min-height: 75px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.45);
  position: relative;
}

.tb-left { display: flex; align-items: center; gap: 10px; }

.logo-flip-container {
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  position: relative; z-index: 100;
}

.logo-main {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.logo-top-fixed img {
  height: 40px;
  width: auto;
  object-fit: contain;
  filter: brightness(1.1) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.logo-bottom-text {
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 15px;
  font-weight: 600;
  color: #fff;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
  margin-top: -4px;
  text-align: center;
  letter-spacing: 0.3px;
}

/* Menu à droite du logo */
.logo-menu {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.logo-flip-container:hover .logo-menu {
  opacity: 1;
  pointer-events: auto;
}

.logo-menu-item {
  font-family: 'Segoe UI', sans-serif;
  font-size: 11px;
  font-weight: 600;
  color: #fff;
  padding: 3px 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  border-radius: 5px;
  background: rgba(255,255,255,0.15);
}

.logo-menu-item:hover {
  background: rgba(74, 142, 245, 0.6);
  transform: translateX(3px);
}

.tb-center {
  position: absolute; left: 50%; top: 35%;
  transform: translate(-50%, -50%);
  display: flex; align-items: center; justify-content: center; gap: 5px;
}

.top-title {
  font-size: 22px; white-space: nowrap; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: #fdfdfd; text-shadow: 0 2px 3px rgba(0,0,0,0.85);
}

.settings-btn {
  font-size: 22px; background: none; border: none;
  cursor: pointer; padding: 5px; border-radius: 50%; transition: all 0.2s;
}

.settings-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(45deg); }

.tb-right { 
  position: relative;
  display: flex; 
  flex-direction: column; 
  align-items: flex-end; 
  justify-content: center;
  height: 100%;
}

.user-status {
  position: absolute;
  bottom: -8px;
  right: 0;
  display: flex; align-items: center; gap: 4px;
  padding: 1px 6px; background: rgba(255,255,255,0.1);
  border-radius: 8px; font-size: 8px;
}

.status-dot { width: 6px; height: 6px; border-radius: 50%; background: #6b7280; }
.status-dot.online { background: #22c55e; }
.user-name { color: #fff; font-weight: 500; }

.user-role-badge {
  display: inline-block; margin-left: 4px; padding: 1px 4px;
  border-radius: 6px; font-size: 7px; font-weight: 600;
}
.user-role-badge.admin { background: #dc2626; color: #fff; }
.user-role-badge.editor { background: #2563eb; color: #fff; }
.user-role-badge.viewer { background: #6b7280; color: #fff; }

.header-btn {
  padding: 4px 12px;
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  color: #fff; border: 1px solid #000; border-radius: 6px;
  font-size: 11px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 3px rgba(0,0,0,0.3);
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.header-btn:hover { transform: translateY(-1px); box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 3px 8px rgba(0,0,0,0.4); }

.search-row {
  position: absolute; bottom: 8px; left: 50%;
  transform: translateX(-50%);
  display: flex; align-items: center; gap: 10px;
}

.search-box {
  display: flex; align-items: center;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 20px; padding: 4px 12px; min-width: 480px;
}

.search-box:focus-within { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.4); }
.search-icon { font-size: 14px; margin-right: 8px; opacity: 0.7; }

.search-input {
  background: transparent; border: none; color: #fff;
  font-size: 13px; width: 100%; outline: none;
}

.search-input::placeholder { color: rgba(255,255,255,0.5); }

.search-clear {
  background: none; border: none; color: rgba(255,255,255,0.6);
  cursor: pointer; font-size: 14px; padding: 2px 6px;
}

.search-clear:hover { color: #fff; }

/* ===== SETTINGS MENU ===== */
.settings-overlay {
  position: fixed; 
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); 
  z-index: 10000;
  display: flex; 
  align-items: flex-start; 
  justify-content: flex-end; 
  padding-top: 100px;
  padding-right: 20px;
}
.settings-overlay.hidden { display: none !important; }

.settings-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0f172a);
  border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  min-width: 220px; overflow: hidden;
}

.settings-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
  color: #fff; font-weight: 600; font-size: 14px;
}

.settings-close-btn {
  background: rgba(255,255,255,0.1); border: none; color: #fff;
  width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 12px;
}

.settings-close-btn:hover { background: #ef4444; }

.settings-content { padding: 10px; display: flex; flex-direction: column; gap: 5px; }

.settings-item {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 15px; background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
  color: #fff; font-size: 13px; cursor: pointer; transition: all 0.2s;
}

.settings-item:hover { background: rgba(255,255,255,0.15); }
.settings-item.logout { border-color: rgba(239,68,68,0.3); }
.settings-item.logout:hover { background: rgba(239,68,68,0.2); }
.settings-icon { font-size: 18px; }

/* ===== IMPORT/EXPORT MENU ===== */
.import-export-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}
.import-export-overlay.hidden { display: none; }

.import-export-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0a1628);
  border: 2px solid #4a8ef5;
  border-radius: 12px;
  width: 500px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.import-export-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #04152c, #4a8ef5);
  border-bottom: 1px solid #4a8ef5;
  border-radius: 10px 10px 0 0;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
}

.import-export-close-btn {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.import-export-close-btn:hover { filter: brightness(1.2); }

.import-export-content { padding: 20px; }

.import-export-section { margin-bottom: 15px; }
.import-export-section h3 { margin: 0 0 10px 0; font-size: 15px; color: #4ade80; }
.import-export-section p { margin: 0 0 15px 0; font-size: 12px; color: #94a3b8; line-height: 1.4; }

.import-export-btn {
  width: 100%;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: filter 0.2s;
}
.import-export-btn:hover { filter: brightness(1.1); }

.export-btn { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; }
.import-btn { background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; }

.export-options { display: flex; gap: 10px; margin-top: 10px; }

.import-export-btn-small {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #4a8ef5;
  background: rgba(74, 142, 245, 0.2);
  color: #fff;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}
.import-export-btn-small:hover { background: rgba(74, 142, 245, 0.4); }

.import-export-divider {
  height: 1px;
  background: linear-gradient(to right, transparent, #4a8ef5, transparent);
  margin: 20px 0;
}

.import-warning {
  background: rgba(239, 68, 68, 0.2);
  border: 1px solid rgba(239, 68, 68, 0.4);
  border-radius: 8px;
  padding: 10px;
  margin-top: 10px;
  font-size: 11px;
  color: #fca5a5;
}

/* ===== LOG MODAL ===== */
.log-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}
.log-overlay.hidden { display: none; }

.log-popup {
  background: linear-gradient(to bottom, #1e3a5f, #0a1628);
  border: 2px solid #4a8ef5;
  border-radius: 12px;
  width: 600px;
  max-width: 95vw;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #04152c, #4a8ef5);
  border-bottom: 1px solid #4a8ef5;
  border-radius: 10px 10px 0 0;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
}

.log-close-btn {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border: none;
  color: white;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
}
.log-close-btn:hover { filter: brightness(1.2); }

.log-content {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.log-entry {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 10px 15px;
  margin-bottom: 8px;
  font-size: 12px;
}

.log-time {
  color: #94a3b8;
  font-size: 11px;
  margin-bottom: 4px;
}

.log-action {
  color: #4ade80;
  font-weight: 600;
}

.log-empty {
  text-align: center;
  color: #64748b;
  padding: 40px;
  font-style: italic;
}

/* ===== BOARD ===== */
.board-wrapper { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

.board {
  flex: 1; display: grid; grid-template-columns: repeat(8, minmax(0, 1fr));
  gap: 4px; padding: 4px; overflow-x: hidden; overflow-y: hidden; min-height: 0;
}

.col {
  background: linear-gradient(180deg, rgba(30,58,95,0.95) 0%, rgba(15,23,42,0.98) 100%);
  border-radius: 12px; display: flex; flex-direction: column;
  min-width: 0; max-height: 100%; overflow: hidden;
  border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.col-header {
  padding: 8px 10px;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: #fff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  flex-shrink: 0; cursor: default;
  position: relative;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 4px rgba(0,0,0,0.3);
}

.col-header.clickable { cursor: pointer; }
.col-header.clickable:hover { background: linear-gradient(to bottom, #0a2540 0%, #5a9ef5 100%); }
.col-header.en-attente { background: linear-gradient(to bottom, #4a1010 0%, #dc2626 100%); }

.col-icon { position: absolute; left: 8px; font-size: 12px; }
.col-title { text-align: center; }

.col-count {
  position: absolute;
  right: 8px;
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  padding: 2px 6px;
  border-radius: 10px; font-size: 10px; font-weight: 600;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  border: 1px solid rgba(0,0,0,0.5);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.2);
}

.col-content {
  flex: 1; overflow-y: auto; padding: 1px;
  display: flex; flex-direction: column; gap: 2px;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.col-content::-webkit-scrollbar { display: none; } /* Chrome/Safari/Opera */

/* ===== CARTES COMPACTES ===== */
.mcard {
  position: relative;
  margin: 1px 0;
  padding: 0px 6px 2px 6px;
  border-radius: 8px;
  background: linear-gradient(to bottom, #1a3a5a 0%, #3a6a9a 35%, #5a9acf 100%);
  border: 2px solid #000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  color: #fff;
  font-size: 8px;
  overflow: visible;
}

/* Couleurs par region - dégradé métallique lumineux */
.mcard.region-qc {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 2px 6px rgba(0,0,0,0.35);
}
.mcard.region-on {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
  box-shadow: inset 0 2px 3px rgba(255,255,255,0.4), 0 2px 6px rgba(0,0,0,0.35);
}
.mcard.region-ma {
  background: linear-gradient(to bottom, #451238 0%, #8D2E6A 40%, #C7458C 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.2), 0 2px 6px rgba(0,0,0,0.35);
}

/* Texte blanc avec bordure noire */
.mcard .mcard-title,
.mcard .mcard-order,
.mcard .mcard-region-pill,
.mcard .mcard-delay-pill,
.mcard .mcard-btn-move,
.mcard .mcard-btn-delete,
.mcard .mcard-fiche-btn {
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Header carte - compact */
.mcard-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 0;
  padding: 0;
}

.mcard-info { width: 100%; text-align: center; }

.mcard-title-line {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0px;
}

.mcard-title {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  margin-top: 3px;
  margin-bottom: 3px;
  padding-top: 0px;
  cursor: text;
  border: none;
  background: transparent;
  padding-left: 0;
  padding-right: 0;
  width: 100%;
  outline: none;
  font-family: inherit;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

.mcard-title:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

.mcard-order-line {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #fff;
  position: relative;
  width: 100%;
  height: 12px;
  padding: 0 35px;
  box-sizing: border-box;
  margin-top: 0px;
}

/* Pastille region (Quebec, Ontario, Maritime) - même style que bouton Fiche */
.mcard-region-pill {
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  color: #fff;
  font-size: 7px;
  font-weight: 700;
  padding: 2px 4px;
  border-radius: 6px;
  border: 1px solid #000;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  text-align: center;
  line-height: 1;
  cursor: pointer;
  transition: all 0.2s;
  z-index: 10;
  white-space: nowrap;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.4);
}

.mcard-region-pill:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.1);
}

/* Pastille région par couleur de carte */
.mcard.region-qc .mcard-region-pill {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
}
.mcard.region-on .mcard-region-pill {
  background: linear-gradient(to bottom, #E8B97A, #704414);
}
.mcard.region-ma .mcard-region-pill {
  background: linear-gradient(to bottom, #C7458C, #451238);
}

/* Bouton Fiche a droite */
.mcard-fiche-btn {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(to bottom, #6b7fa8, #4a5a7a);
  border: 1px solid rgba(0,0,0,0.5);
  border-radius: 6px;
  padding: 2px 4px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
  text-align: center;
  z-index: 10;
  pointer-events: auto;
  color: #fff;
  text-shadow: 1px 1px 0 #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

.mcard-fiche-btn:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.2);
}

/* Bouton Fiche par region - même couleur que la carte */
.mcard.region-qc .mcard-fiche-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  border: 1px solid #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-fiche-btn {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  border: 1px solid #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-fiche-btn {
  background: linear-gradient(to bottom, #C7458C, #451238);
  border: 1px solid #000;
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-order {
  cursor: text;
  border: none;
  background: transparent;
  color: #fff;
  font-size: 12px;
  font-family: inherit;
  font-weight: 600;
  padding: 0;
  width: 60px;
  outline: none;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  text-align: center;
}

.mcard-order:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

.mcard-title.locked,
.mcard-order.locked {
  cursor: not-allowed;
  opacity: 0.9;
  font-weight: 700;
}

/* Separateur */
.mcard-separator {
  height: 1px;
  background: rgba(255,255,255,0.25);
  margin: 0px -6px 0px -6px;
}

/* Pastille delai */
.mcard-delay-pill {
  width: 100%;
  padding: 0px 3px;
  font-size: 7px;
  font-weight: 700;
  border-radius: 999px;
  background: linear-gradient(to bottom, #4a6fa5, #2d4a6f);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #000;
  margin-top: 1px;
  margin-bottom: 1px;
  box-sizing: border-box;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  cursor: pointer;
}

/* Pastille delai par region - même couleur que la carte */
.mcard.region-qc .mcard-delay-pill {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-delay-pill {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.5);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-delay-pill {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.25);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Couleurs delai - PLUS DE VERT, seulement jaune et rouge */
.mcard-delay-pill.delai-vert { } /* Pas de style spécial, garde la couleur de la carte */
.mcard-delay-pill.delai-jaune { background: linear-gradient(to bottom, #f59e0b, #d97706) !important; color: #000 !important; text-shadow: none !important; }
.mcard-delay-pill.delai-rouge { background: linear-gradient(to bottom, #ef4444, #b91c1c) !important; }
.mcard-delay-pill.delai-retard {
  background: linear-gradient(to bottom, #ef4444, #b91c1c) !important;
  animation: pulse-retard-delai 0.8s infinite !important;
}

@keyframes pulse-retard-delai {
  0%, 100% { background: linear-gradient(to bottom, #dc2626, #7f1d1d); box-shadow: 0 0 4px #dc2626; }
  50% { background: linear-gradient(to bottom, #ef4444, #dc2626); box-shadow: 0 0 8px #ef4444; }
}

/* Colonne En attente */
.mcard.in-attente-column .mcard-delay-pill {
  background: linear-gradient(to bottom, #dc2626, #b91c1c);
}

.mcard.in-attente-column .mcard-delay-pill.attente-active {
  animation: blinkRed 0.8s infinite;
}

@keyframes blinkRed {
  0%, 49% { background: #dc2626; box-shadow: none; }
  50%, 100% { background: #ff0000; box-shadow: 0 0 4px #ff0000, 0 0 8px #ff0000; }
}

/* Expédié - même couleur que la carte */
.mcard .mcard-delay-pill.expedie { cursor: default !important; animation: none !important; }
.mcard.region-qc .mcard-delay-pill.expedie { background: linear-gradient(to bottom, #4a8ef5, #04152c) !important; }
.mcard.region-on .mcard-delay-pill.expedie { background: linear-gradient(to bottom, #E8B97A, #704414) !important; }
.mcard.region-ma .mcard-delay-pill.expedie { background: linear-gradient(to bottom, #C7458C, #451238) !important; }

/* Boutons footer */
.mcard-footer-buttons {
  display: flex;
  gap: 2px;
  margin-top: 1px;
}

.mcard-btn {
  flex: 1;
  padding: 1px 3px;
  font-size: 7px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid #000;
  cursor: pointer;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
  line-height: 1;
  white-space: nowrap;
}

.mcard-btn:hover { filter: brightness(1.1); }

.mcard-btn-move {
  background: linear-gradient(to bottom, #1e3a5f, #0f2744);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Bouton deplacer par region - même couleur que la carte */
.mcard.region-qc .mcard-btn-move {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-on .mcard-btn-move {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.5), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}
.mcard.region-ma .mcard-btn-move {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.25), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

.mcard-btn-delete {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
}

/* Badge priorite */
.priority-badge {
  position: absolute;
  top: -1px;
  left: -1px;
  width: 16px;
  height: 16px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  border-radius: 6px 0 6px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  color: #fff;
  box-shadow: 1px 1px 3px rgba(0,0,0,0.4);
  z-index: 10;
  border: none;
  pointer-events: none;
}

.priority-badge.hidden { display: none; }
.priority-badge.p1 { background: linear-gradient(to bottom, #ef4444, #dc2626); }
.priority-badge.p2 { background: linear-gradient(to bottom, #f97316, #ea580c); }
.priority-badge.p3 { background: linear-gradient(to bottom, #eab308, #ca8a04); }
.priority-badge.p4 { background: linear-gradient(to bottom, #22c55e, #16a34a); }
.priority-badge.p5 { background: linear-gradient(to bottom, #3b82f6, #2563eb); }

/* Menu priorite */
.priority-menu {
  position: absolute;
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  padding: 8px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 10000;
  min-width: 180px;
}

.priority-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 13px;
  color: #fff;
  transition: background 0.2s;
}

.priority-menu-item:hover { background: rgba(255,255,255,0.1); }

.priority-dot {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  color: #fff;
}

.priority-dot.p1 { background: #ef4444; }
.priority-dot.p2 { background: #f97316; }
.priority-dot.p3 { background: #eab308; }
.priority-dot.p4 { background: #22c55e; }
.priority-dot.p5 { background: #3b82f6; }
.priority-dot.none { background: #6b7280; }

/* ===== FICHE MOULAGE EXPANDED ===== */
.card-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 999;
}
.card-overlay.active { display: block; }

.mcard.mcard-expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  width: 1050px;
  height: 90vh;
  max-height: 90vh;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  overflow: hidden;
  display: flex;
  text-shadow: none !important;
}

.mcard.mcard-expanded *,
.mcard.mcard-expanded input,
.mcard.mcard-expanded select,
.mcard.mcard-expanded label,
.mcard.mcard-expanded span,
.mcard.mcard-expanded div {
  text-shadow: none !important;
}

@media (max-width: 1100px) {
  .mcard.mcard-expanded {
    width: 95vw;
    flex-direction: column;
    max-height: 85vh;
    overflow-y: auto;
  }
  .mcard.mcard-expanded .mcard-fiche {
    width: 100% !important;
    border-right: none !important;
    border-bottom: 1px solid #e2e8f0;
  }
  .mcard.mcard-expanded .mcard-notes-page {
    width: 100% !important;
    min-height: 250px;
  }
}

.mcard.mcard-expanded .mcard-header,
.mcard.mcard-expanded .mcard-delay-pill,
.mcard.mcard-expanded .mcard-footer-buttons,
.mcard.mcard-expanded .mcard-separator {
  display: none !important;
}

/* Sidebar tracking */
.mcard-tracking-sidebar {
  display: none;
  width: 140px;
  flex-shrink: 0;
  background: #ffffff;
  border-right: 2px solid #e2e8f0;
  padding: 10px 8px;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-tracking-sidebar { display: flex; }

.tracking-sidebar-title {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
}

.tracking-pills-container {
  display: flex;
  flex-direction: column;
  gap: 3px;
  flex: 1;
  overflow: hidden;
}

.tracking-dept-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 8px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  flex: 1;
}

.tracking-dept-pill:hover { background: #eff6ff; border-color: #3b82f6; }
.tracking-dept-pill.active { background: linear-gradient(to right, #dbeafe, #eff6ff); border-color: #3b82f6; border-width: 2px; }
.tracking-dept-pill.completed { background: linear-gradient(to right, #dcfce7, #f0fdf4); border-color: #22c55e; }

.tracking-pill-icon { font-size: 14px; }
.tracking-pill-name { font-size: 10px; font-weight: 600; color: #374151; flex: 1; }
.tracking-pill-jours { font-size: 15px; font-weight: 800; color: #1e40af; min-width: 32px; text-align: center; }
.tracking-dept-pill.completed .tracking-pill-jours { color: #16a34a; }
.tracking-dept-pill.active .tracking-pill-jours { color: #2563eb; }

/* Contenu fiche - Page gauche */
.mcard-fiche {
  display: none;
  padding: 12px 14px;
  padding-bottom: 55px;
  width: 420px;
  flex-shrink: 0;
  border-right: 1px solid #e2e8f0;
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
  box-sizing: border-box;
}

.mcard.mcard-expanded .mcard-fiche { display: block; }

/* Page Notes - Page droite */
.mcard-notes-page {
  display: none;
  flex: 1;
  min-width: 450px;
  padding: 12px;
  background: #f8fafc;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-notes-page { display: flex; }

.notes-page-header {
  font-size: 14px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
  flex-shrink: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notes-header-left {
  display: flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
  color: #1e40af;
  line-height: 1;
}

.notes-header-left .camera-icon {
  font-size: 16px;
  line-height: 1;
}

.notes-header-center {
  flex: 1;
  text-align: center;
  font-size: 15px;
}

.notes-close-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notes-photos-row {
  display: flex;
  gap: 4px;
  margin-bottom: 6px;
  flex-shrink: 0;
}

.notes-photo-btn {
  flex: 1;
  padding: 4px 2px;
  font-size: 9px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.notes-photo-btn:hover { background: #f3f4f6; }
.notes-photo-btn.has-link { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; border-color: #15803d; }

.notes-page-textarea {
  flex: 1;
  width: 100%;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.4;
  background: white;
}

.notes-photos-links {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  margin-bottom: 8px;
}

.photo-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.photo-link-row label { font-size: 9px; font-weight: 600; color: #374151; width: 50px; }
.photo-link-row input { flex: 1; padding: 4px 6px; font-size: 9px; border: 1px solid #d1d5db; border-radius: 4px; }

.save-photos-btn {
  margin-top: 6px;
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}

/* Fiche header */
.fiche-header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 15px;
  margin-bottom: 6px;
  padding-bottom: 4px;
  border-bottom: 1px solid #e2e8f0;
}

.fiche-header .fiche-logo img { height: 35px; }
.fiche-header .fiche-title { text-align: center; flex: 1; }
.fiche-header .fiche-title h3 { margin: 0; font-size: 14px; font-weight: 700; color: #0f172a; }

.fiche-priority-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  color: #fff;
  font-size: 11px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.2s;
  border: none;
}

.fiche-priority-btn:hover { transform: scale(1.05); }
.fiche-priority-emoji { font-size: 12px; }

/* Fiche section et grilles */
.fiche-section { margin-bottom: 6px; }
.fiche-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.fiche-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

.fiche-field { display: flex; flex-direction: column; }

.fiche-label {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  min-height: 16px;
}

.list-manage-btn {
  padding: 2px 6px;
  font-size: 10px;
  background: #e5e7eb;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin-left: 4px;
}
.list-manage-btn:hover { background: #d1d5db; }

.fiche-input, .fiche-select {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  font-weight: 500;
  color: #1f2937;
  background: #fff;
  box-sizing: border-box;
  text-align: center;
}

.fiche-input:focus, .fiche-select:focus { outline: none; border-color: #3b82f6; }

.fiche-input.locked {
  background: #f1f5f9;
  color: #1e40af;
  font-weight: 600;
  cursor: not-allowed;
  border-color: #93c5fd;
}

.fiche-date-pill {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1f2937;
  font-weight: 500;
  cursor: pointer;
  box-sizing: border-box;
}

.fiche-date-pill:hover { background: #f9fafb; border-color: #9ca3af; }

/* Section En attente */
.fiche-attente-section {
  display: none;
  background: linear-gradient(to right, #fef2f2, #fee2e2);
  border: 1px solid #fca5a5;
  border-radius: 6px;
  padding: 8px;
  margin: 8px 0;
}

.fiche-attente-section.visible { display: block; }

.attente-badge-full {
  font-size: 11px;
  font-weight: 700;
  color: #dc2626;
  cursor: pointer;
  text-align: center;
}

.attente-days-full {
  font-size: 10px;
  color: #991b1b;
  text-align: center;
  margin-top: 4px;
}

/* Section Photos */
.fiche-photos-section {
  position: absolute;
  bottom: 8px;
  left: 10px;
  right: 10px;
}

.photos-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.photos-label {
  font-size: 14px;
  font-weight: 700;
  color: #1e40af;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.photos-label .camera-icon {
  font-size: 18px;
}

.photo-btn {
  flex: 1;
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 700;
  background: #f3f4f6;
  border: 2px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
}

.photo-btn:hover { background: #e5e7eb; }
.photo-btn.has-link { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; border-color: #15803d; }
.photo-btn.has-link.blink-green-photo { animation: blinkGreen 1s infinite; }

@keyframes blinkGreen {
  0%, 100% { background: linear-gradient(to bottom, #22c55e, #16a34a); }
  50% { background: linear-gradient(to bottom, #4ade80, #22c55e); box-shadow: 0 0 8px #22c55e; }
}

/* Calendrier popup */
.fiche-calendar-popup {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  padding: 12px;
  z-index: 2000;
  min-width: 260px;
}

.fiche-calendar-popup.active { display: block; }

.cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0; }
.cal-title { font-size: 11px; font-weight: 700; color: #1e3a5f; }
.cal-nav { display: flex; align-items: center; gap: 8px; }
.cal-nav button { width: 24px; height: 24px; border: none; background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
.cal-month-year { font-size: 11px; font-weight: 600; color: #1e3a5f; min-width: 100px; text-align: center; }
.cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
.cal-weekday { text-align: center; font-size: 8px; font-weight: 700; color: #64748b; padding: 4px 0; }
.cal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
.cal-day { width: 32px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: none; background: #f8fafc; border-radius: 4px; cursor: pointer; color: #334155; }
.cal-day:hover { background: #dbeafe; }
.cal-day.other-month { color: #cbd5e1; background: transparent; }
.cal-day.today { background: #fef3c7; font-weight: 700; border: 1px solid #f59e0b; }
.cal-day.selected { background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; font-weight: 700; }
.cal-buttons { display: flex; gap: 6px; justify-content: center; margin-top: 10px; padding-top: 8px; border-top: 1px solid #e2e8f0; }
.cal-buttons button { padding: 6px 14px; font-size: 10px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; }
.btn-today { background: linear-gradient(to bottom, #10b981, #059669); color: white; }
.btn-close-cal { background: linear-gradient(to bottom, #6b7280, #4b5563); color: white; }

/* Menu photos popup */
.photos-menu-popup {
  display: none;
  position: absolute;
  bottom: 45px;
  left: 10px;
  right: 10px;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  z-index: 100;
}

.photos-menu-popup.active { display: block; }

.photos-menu-header {
  font-size: 12px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid #e2e8f0;
  text-align: center;
}

.photos-menu-field {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.photos-menu-field label {
  font-size: 10px;
  font-weight: 600;
  color: #374151;
  width: 80px;
}

.photos-menu-field input {
  flex: 1;
  padding: 6px 8px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.photos-menu-btns {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.photos-menu-btns button {
  flex: 1;
  padding: 8px;
  font-size: 11px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.photos-menu-btns button:first-child {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.photos-menu-btns button:last-child {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Menu tracking dates */
.tracking-dates-menu {
  position: fixed;
  background: white;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  z-index: 20000;
  min-width: 200px;
  overflow: hidden;
}

.tracking-menu-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
}

.tracking-menu-row {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  border-bottom: 1px solid #e5e7eb;
}

.tracking-menu-label {
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  width: 60px;
}

.tracking-menu-date {
  flex: 1;
  font-size: 12px;
  color: #2563eb;
  cursor: pointer;
  padding: 6px 10px;
  background: #eff6ff;
  border-radius: 4px;
  text-align: center;
}

.tracking-menu-date:hover { background: #dbeafe; }

.tracking-menu-footer {
  padding: 10px;
  text-align: center;
}

.tracking-menu-footer button {
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

/* Notes photos links panel */
.notes-photos-links-panel {
  display: none;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
}

.notes-photos-links-panel.active { display: block; }

.notes-photo-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}

.notes-photo-link-row label {
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  width: 55px;
}

.notes-photo-link-row input {
  flex: 1;
  padding: 5px 8px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.notes-save-photos-btn {
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Camera icon clickable */
.notes-camera-icon {
  font-size: 14px;
  cursor: pointer;
  margin-left: 6px;
  transition: transform 0.2s;
}

.notes-camera-icon:hover { transform: scale(1.2); }

/* ===== LIST MANAGER ===== */
.list-manager-overlay {
  position: fixed;
  inset: 0;
  background: rgba(4, 21, 44, 0.85);
  backdrop-filter: blur(4px);
  z-index: 60000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.list-manager-overlay.hidden { display: none; }

.list-manager-popup {
  background: linear-gradient(145deg, #0d2137 0%, #1a3a5c 50%, #0d2137 100%);
  border-radius: 16px;
  box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(74, 142, 245, 0.3);
  min-width: 380px;
  max-width: 480px;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.list-manager-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 20px;
  background: linear-gradient(to bottom, #04152c 0%, #1a3a5c 100%);
  border-bottom: 1px solid rgba(74, 142, 245, 0.3);
}

.list-manager-header h3 {
  margin: 0;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
}

.list-manager-close-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.list-manager-close-btn:hover {
  background: #ef4444;
  border-color: #ef4444;
}

.list-manager-content {
  padding: 20px;
  flex: 1;
  overflow-y: auto;
}

.list-manager-items {
  max-height: 350px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.list-manager-item {
  display: flex;
  align-items: center;
  padding: 12px 14px;
  background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  color: #fff;
  font-size: 13px;
  transition: all 0.2s;
}

.list-manager-item:hover {
  background: linear-gradient(135deg, rgba(74, 142, 245, 0.2) 0%, rgba(74, 142, 245, 0.1) 100%);
  border-color: rgba(74, 142, 245, 0.4);
}

.list-manager-item .item-index {
  color: rgba(255,255,255,0.4);
  font-size: 11px;
  margin-right: 12px;
  min-width: 24px;
}

.list-manager-item .item-name {
  flex: 1;
  font-weight: 500;
}

.list-manager-item .btn-remove-item {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  border: none;
  color: #fff;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8;
}

.list-manager-item:hover .btn-remove-item { opacity: 1; }
.list-manager-item .btn-remove-item:hover { transform: scale(1.1); }

.list-manager-footer {
  padding: 14px 16px;
  background: linear-gradient(to bottom, #0d2137 0%, #04152c 100%);
  border-top: 1px solid rgba(74, 142, 245, 0.2);
  display: flex;
  align-items: center;
  gap: 10px;
}

.list-manager-input-wrapper {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
}

.list-manager-input-wrapper input {
  width: 100%;
  padding: 12px 50px 12px 14px;
  border-radius: 10px;
  border: 2px solid rgba(74, 142, 245, 0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 13px;
}

.list-manager-input-wrapper input:focus {
  outline: none;
  border-color: #4a8ef5;
  background: rgba(0,0,0,0.4);
}

.list-manager-input-wrapper input::placeholder {
  color: rgba(255,255,255,0.4);
}

.btn-add-inside {
  position: absolute;
  right: 6px;
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  border: none;
  color: #fff;
  width: 34px;
  height: 34px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 20px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-add-inside:hover { transform: scale(1.08); }

.btn-close-list {
  padding: 12px 20px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: #fff;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
}

.btn-close-list:hover {
  background: rgba(255,255,255,0.2);
}

.list-manager-item.just-added {
  animation: flash-green 0.5s ease;
}

@keyframes flash-green {
  0% { background: rgba(34, 197, 94, 0.5); }
  100% { background: rgba(255,255,255,0.05); }
}

.list-manager-item.just-removed {
  animation: flash-red 0.3s ease forwards;
}

@keyframes flash-red {
  0% { background: rgba(239, 68, 68, 0.5); opacity: 1; }
  100% { background: rgba(239, 68, 68, 0.2); opacity: 0; transform: translateX(20px); }
}

/* ===== MENUS CONTEXTUELS UNIFIÉS ===== */
.ctx-menu {
  position: fixed;
  background: linear-gradient(145deg, #0d2137 0%, #1a3a5c 50%, #0d2137 100%);
  border-radius: 12px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(74, 142, 245, 0.2);
  z-index: 25000;
  min-width: 240px;
  max-width: 300px;
  overflow: hidden;
}

.ctx-menu.raison {
  box-shadow: 0 15px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(239, 68, 68, 0.3);
}

.ctx-header {
  background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  color: white;
  padding: 12px 16px;
  font-size: 13px;
  font-weight: 700;
  text-align: center;
}

.ctx-menu.raison .ctx-header {
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
}

.ctx-body { padding: 10px; }

.ctx-region {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  margin: 4px 0;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.ctx-region:hover { background: rgba(74, 142, 245, 0.15); }
.ctx-region.active { background: rgba(74, 142, 245, 0.2); border-color: #3b82f6; }

.ctx-region-name {
  flex: 1;
  font-size: 12px;
  font-weight: 600;
  color: #fff;
}

.ctx-input {
  width: 50px;
  padding: 4px 6px;
  font-size: 12px;
  font-weight: 700;
  text-align: center;
  border: 1px solid #4a8ef5;
  border-radius: 4px;
  background: rgba(255,255,255,0.1);
  color: #fff;
}

.ctx-unit {
  font-size: 10px;
  color: #9ca3af;
  margin-left: 6px;
}

.ctx-options {
  max-height: 200px;
  overflow-y: auto;
  padding: 8px;
}

.ctx-option {
  padding: 10px 12px;
  font-size: 11px;
  color: #fff;
  cursor: pointer;
  border-radius: 6px;
  margin-bottom: 3px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  transition: all 0.2s;
}

.ctx-option:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  transform: translateX(2px);
}

.ctx-option.selected {
  background: rgba(239, 68, 68, 0.25);
  border-color: #ef4444;
  font-weight: 700;
}

.ctx-actions {
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 8px;
  display: flex;
  gap: 6px;
}

.ctx-footer {
  padding: 10px;
  background: rgba(0,0,0,0.2);
  border-top: 1px solid rgba(255,255,255,0.1);
  text-align: center;
}

.ctx-btn {
  padding: 8px 16px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(135deg, #4a8ef5 0%, #2563eb 100%);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.1s;
}

.ctx-btn:hover { transform: scale(1.02); }
.ctx-btn.primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
.ctx-btn.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.ctx-btn.small { flex: 1; padding: 8px 10px; font-size: 10px; }

/* Animation clignotante attente active */
.mcard-delay-pill.attente-active {
  animation: blinkAttente 1s infinite;
}

@keyframes blinkAttente {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; background: #ef4444; }
}

/* ===== VUE ROBOT HORIZONTALE ===== */
.robot-horizontal-container {
  display: none;
  flex-direction: column;
  position: fixed;
  inset: 0;
  padding: 12px;
  background: linear-gradient(to bottom, #1a3a5c, #4a7ab8);
  z-index: 500;
}

.robot-horizontal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  margin-bottom: 10px;
  background: linear-gradient(to bottom, #04152c, #325f9b);
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.45);
}

.robot-horizontal-header h2 { color: #fff; margin: 0; font-size: 16px; }

.robot-horizontal-scroll {
  flex: 1;
  overflow: auto;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.45);
}

.robot-horizontal-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.robot-horizontal-table thead {
  position: sticky;
  top: 0;
  z-index: 100;
}

.robot-horizontal-table th {
  position: relative;
  background: linear-gradient(to bottom, #1e40af, #0f172a);
  color: #fff;
  padding: 6px 4px;
  text-align: center;
  font-weight: 600;
  font-size: 10px;
  border: 1px solid #3b82f6;
  white-space: nowrap;
  min-width: 60px;
}

.resize-handle {
  position: absolute;
  top: 0; right: 0; bottom: 0;
  width: 5px;
  cursor: col-resize;
  background: rgba(255,255,255,0.2);
}

.resize-handle:hover { background: rgba(255,255,255,0.5); }

.robot-horizontal-table td {
  padding: 4px;
  border: 1px solid #d1d5db;
  font-size: 10px;
  color: #1f2937;
  text-align: center;
  background: white;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.robot-horizontal-table td.editable {
  cursor: text;
  background: #fffbeb;
}

.robot-horizontal-table td.locked {
  cursor: not-allowed;
  background: #f1f5f9;
  color: #1e40af;
  font-weight: 600;
}

.robot-horizontal-table td.editable:hover { background: #fef3c7; }
.robot-horizontal-table td.editable:focus { outline: 2px solid #3b82f6; background: #dbeafe; }

.robot-horizontal-table tbody tr:nth-child(even) td { background: #f8fafc; }
.robot-horizontal-table tbody tr:nth-child(even) td.editable { background: #fefce8; }
.robot-horizontal-table tbody tr:hover td { background: #e0f2fe !important; }

/* Select simple */
.table-select {
  width: 100%;
  padding: 3px 4px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  background: white;
  cursor: pointer;
}

.table-select:focus { outline: none; border-color: #3b82f6; }

/* Cellule date */
.date-cell {
  cursor: pointer;
  font-size: 10px;
}

.date-cell:hover { background: #dbeafe !important; color: #1e40af; }
.date-cell.has-date { color: #166534; font-weight: 600; background: #dcfce7 !important; }
.date-cell.placeholder { color: #9ca3af; font-style: italic; }

/* Notes */
.notes-cell { padding: 3px !important; }

.notes-btn {
  padding: 3px 8px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  background: #f3f4f6;
  cursor: pointer;
}

.notes-btn:hover { background: #e5e7eb; }

.notes-btn.has-notes {
  background: linear-gradient(to bottom, #fbbf24, #f59e0b);
  color: white;
  border-color: #d97706;
  animation: blink-notes 1s infinite;
}

@keyframes blink-notes { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

.rang-robot-text { font-weight: 600; color: #1e40af; }

/* Popup Notes - style fiche */
.notes-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 29000;
}

.notes-popup-page {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #f8fafc;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  z-index: 30000;
  width: 550px;
  height: 500px;
  display: flex;
  flex-direction: column;
  padding: 14px;
}

.notes-popup-page .notes-page-header {
  font-size: 14px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 2px solid #3b82f6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notes-popup-page .notes-header-left {
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 700;
  color: #1e40af;
}

.notes-popup-page .notes-header-center {
  flex: 1;
  text-align: center;
  font-size: 16px;
}

.notes-popup-page .notes-close-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.notes-popup-page .notes-photos-row {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
}

.notes-popup-page .notes-photo-btn {
  flex: 1;
  padding: 8px 4px;
  font-size: 11px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
}

.notes-popup-page .notes-photo-btn:hover { background: #f3f4f6; }
.notes-popup-page .notes-photo-btn.has-link { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; border-color: #15803d; }

.notes-popup-page .notes-page-textarea {
  flex: 1;
  width: 100%;
  padding: 12px;
  font-size: 13px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.5;
  background: white;
}

.notes-popup-page .notes-photos-links-panel {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
}

.notes-popup-page .notes-photo-link-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.notes-popup-page .notes-photo-link-row label {
  width: 60px;
  font-size: 11px;
  font-weight: 600;
  color: #374151;
}

.notes-popup-page .notes-photo-link-row input {
  flex: 1;
  padding: 6px 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.notes-popup-page .notes-save-photos-btn {
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: 30px; left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  color: #fff; padding: 14px 28px; border-radius: 12px;
  font-weight: 600; font-size: 14px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5); z-index: 99999;
  opacity: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

/* ===== MODAL AJOUTER MOULAGE ===== */
.add-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}
.add-modal-overlay.hidden { display: none; }

.add-modal {
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  width: 95%;
  max-width: 580px;
}

.add-modal-header {
  background: linear-gradient(to bottom, #1e40af, #1e3a8a);
  color: white;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-radius: 12px 12px 0 0;
}

.add-modal-header h3 {
  margin: 0;
  font-size: 15px;
  font-weight: 700;
}

.add-modal-header-btns {
  display: flex;
  align-items: center;
  gap: 8px;
}

.add-json-btn {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  border: none;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.add-json-btn:hover {
  filter: brightness(1.1);
}

.add-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 22px;
  cursor: pointer;
  line-height: 1;
}

.add-modal-body {
  padding: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.add-modal-field {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.add-modal-field label {
  font-size: 11px;
  font-weight: 600;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 4px;
}

.add-modal-field input,
.add-modal-field select {
  padding: 5px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 12px;
  transition: border-color 0.2s;
}

.add-modal-field input:focus,
.add-modal-field select:focus {
  outline: none;
  border-color: #3b82f6;
}

.add-field-manage-btn {
  background: #e5e7eb;
  border: none;
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 9px;
  cursor: pointer;
}

.add-field-manage-btn:hover {
  background: #3b82f6;
  color: white;
}

.add-modal-footer {
  padding: 10px 14px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  border-radius: 0 0 12px 12px;
}

.add-modal-footer button {
  padding: 7px 16px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 5px;
  cursor: pointer;
  border: none;
}

.add-btn-cancel {
  background: #e5e7eb;
  color: #374151;
}

.add-btn-confirm {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.add-btn-confirm:hover {
  filter: brightness(1.1);
}

/* ===== CALENDRIER POPUP ===== */
/* ===== CALENDRIER UNIFIÉ ===== */
.cal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 25000;
}

.cal-popup {
  position: fixed;
  z-index: 25000;
}

.cal-container {
  background: linear-gradient(to bottom, #1e3a5f, #0d2137);
  border-radius: 10px;
  padding: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  min-width: 260px;
}

.cal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  color: #fff;
  font-weight: 600;
  font-size: 13px;
}

.cal-header button {
  background: rgba(255,255,255,0.1);
  border: none;
  color: #fff;
  padding: 4px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}
.cal-header button:hover { background: rgba(255,255,255,0.2); }

.cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 4px;
}
.cal-weekdays span {
  text-align: center;
  font-size: 9px;
  color: #888;
  padding: 4px 0;
}

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.cal-cell {
  text-align: center;
  padding: 7px 3px;
  font-size: 11px;
  color: #fff;
  cursor: pointer;
  border-radius: 3px;
  background: rgba(255,255,255,0.05);
}
.cal-cell:hover { background: rgba(74,142,245,0.4); }
.cal-cell.today { border: 2px solid #4a8ef5; }
.cal-cell.selected { background: #4a8ef5; font-weight: bold; }
.cal-cell.empty { cursor: default; background: transparent; }

.cal-footer {
  display: flex;
  gap: 6px;
  margin-top: 10px;
  justify-content: center;
}

.cal-btn {
  padding: 5px 10px;
  border-radius: 4px;
  border: none;
  font-size: 10px;
  cursor: pointer;
  font-weight: 600;
}
.cal-btn.today { background: linear-gradient(to bottom, #4a8ef5, #2563eb); color: #fff; }
.cal-btn.clear { background: linear-gradient(to bottom, #ef4444, #dc2626); color: #fff; }
.cal-btn.close { background: linear-gradient(to bottom, #6b7280, #4b5563); color: #fff; }

/* Date picker field style */
.date-picker-field {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 5px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: white;
  cursor: pointer;
  font-size: 11px;
  color: #6b7280;
  transition: border-color 0.2s;
}
.date-picker-field:hover { border-color: #3b82f6; }
.date-picker-field.has-value { color: #111827; }
.date-picker-icon { font-size: 12px; }

/* ===== STRUCTURE MULTI-PAGES ===== */
.page {
  display: none !important;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

.page.active {
  display: flex !important;
}

.page-placeholder {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  color: white;
  text-align: center;
  background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
}

.page-placeholder h1 {
  font-size: 48px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.page-placeholder p {
  font-size: 18px;
  opacity: 0.7;
}

/* ===== LOGIN ===== */
.login-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom, #0b1d36, #3f6eb8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50000;
}
.login-overlay.hidden { display: none; }

.login-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 30px rgba(0,0,0,0.85);
  padding: 40px;
  max-width: 500px;
  width: 90%;
  color: #fff;
  text-align: center;
}

.login-logo-flip-container {
  width: 385px;
  height: 140px;
  margin: 15px auto 25px auto;
}

.login-logo-flip-inner {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-logo-flip-front { display: flex; align-items: center; justify-content: center; }
.login-logo-flip-front img { height: 122px; width: auto; object-fit: contain; }

.login-title-container { text-align: center; margin-bottom: 10px; }
.login-title { font-size: 18px; font-weight: 700; margin-bottom: 3px; line-height: 1.3; }
.login-author {
  font-family: 'Brush Script MT', 'Segoe Script', 'Bradley Hand', cursive;
  font-size: 22px;
  color: rgba(255,255,255,0.7);
  font-style: italic;
}
.login-subtitle { font-size: 13px; opacity: 0.8; margin-bottom: 25px; }

.login-input {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 18px;
  text-align: center;
  margin-bottom: 20px;
  box-sizing: border-box;
  letter-spacing: 3px;
}
.login-input::placeholder { color: rgba(255,255,255,0.5); letter-spacing: normal; font-size: 14px; }
.login-input:focus { outline: none; border-color: #00aaff; box-shadow: 0 0 10px rgba(0,170,255,0.3); }
.login-input-email { letter-spacing: normal !important; text-align: center !important; }

.login-btn {
  width: 100%;
  padding: 14px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #00aaff, #0077cc);
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.login-btn:hover { background: linear-gradient(to bottom, #00bbff, #0088dd); transform: translateY(-1px); }
.login-btn:disabled { opacity: 0.6; cursor: not-allowed; }

.login-error { color: #ff6666; font-size: 12px; margin-top: 10px; min-height: 20px; }

.login-remember {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 10px 0 15px 0;
  font-size: 13px;
  color: rgba(255,255,255,0.8);
}
.login-remember input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #00aaff; }
.login-remember label { cursor: pointer; }

.login-forgot-btn {
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.7);
  font-size: 12px;
  cursor: pointer;
  margin-top: 5px;
  text-decoration: underline;
}
.login-forgot-btn:hover { color: #00aaff; }

/* ===== MOVE MENU (ancien avec rangs) ===== */
.move-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.move-overlay.hidden {
  display: none;
}

.move-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 10px;
  max-width: 95%;
  width: 750px;
  box-sizing: border-box;
}

.move-title {
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.move-columns {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.move-column {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.move-column-header {
  background: linear-gradient(to bottom, #2b5b99, #103561);
  border-radius: 6px;
  padding: 4px 2px;
  text-align: center;
  font-weight: 700;
  font-size: 7px;
  color: #ffffff;
  border: 1px solid rgba(0,0,0,0.5);
}

.move-column-header.current {
  background: linear-gradient(to bottom, #059669, #047857);
}

.move-positions {
  display: flex;
  flex-direction: column;
  gap: 2px;
  max-height: 200px;
  overflow-y: auto;
}

.move-position-btn {
  background: linear-gradient(to bottom, #233d63, #12243f);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 4px;
  padding: 3px 2px;
  text-align: center;
  font-weight: 600;
  font-size: 8px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.15s;
}

.move-position-btn:hover {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  border-color: #3b82f6;
}

.move-footer {
  display: flex;
  justify-content: center;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.move-btn-close {
  padding: 5px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  cursor: pointer;
  font-weight: 600;
  font-size: 10px;
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* ===== CONFIRM DELETE MENU ===== */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20001;
}

.confirm-overlay.hidden {
  display: none;
}

.confirm-panel {
  background: linear-gradient(to bottom, #1a1a2e, #16213e);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 20px;
  text-align: center;
  max-width: 300px;
}

.confirm-title {
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.confirm-message {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
  margin-bottom: 16px;
}

.confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.confirm-btn {
  padding: 8px 20px;
  border-radius: 999px;
  border: none;
  font-weight: 600;
  font-size: 11px;
  cursor: pointer;
  color: #fff;
}

.confirm-btn-yes {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.confirm-btn-no {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
}

.confirm-btn:hover {
  filter: brightness(1.1);
}

/* =============================================================================
   INTERFACE MOBILE - COMPLÈTEMENT SÉPARÉE DU DESKTOP
   N'affecte PAS l'apparence desktop. Activé uniquement sur mobile/tablette.
============================================================================= */

/* Écran d'accueil mobile */
.mobile-home-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom, #04152c 0%, #1a4a7a 50%, #4a8ef5 100%);
  z-index: 100000;
  flex-direction: column;
  overflow: hidden;
}

.mobile-home-overlay.active {
  display: flex;
}

.mobile-home-header {
  padding: 20px;
  text-align: center;
  background: linear-gradient(to bottom, #04152c 0%, #0d2d4d 100%);
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.mobile-home-logo {
  height: 50px;
  margin-bottom: 10px;
}

.mobile-home-title {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 0.02em;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  margin: 0;
  line-height: 1.3;
}

.mobile-home-subtitle {
  font-size: 11px;
  color: rgba(255,255,255,0.6);
  margin-top: 5px;
}

/* Barre de recherche mobile */
.mobile-search-container {
  padding: 15px 20px;
  background: rgba(0,0,0,0.2);
}

.mobile-search-box {
  display: flex;
  align-items: center;
  background: rgba(255,255,255,0.95);
  border-radius: 25px;
  padding: 10px 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.mobile-search-box input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 16px;
  color: #333;
  outline: none;
}

.mobile-search-box input::placeholder {
  color: #999;
}

.mobile-search-icon {
  font-size: 20px;
  color: #666;
  margin-right: 10px;
}

.mobile-search-clear {
  font-size: 18px;
  color: #999;
  cursor: pointer;
  padding: 5px;
  display: none;
}

.mobile-search-clear.visible {
  display: block;
}

/* Résultats de recherche */
.mobile-search-results {
  flex: 1;
  overflow-y: auto;
  padding: 10px 15px;
  -webkit-overflow-scrolling: touch;
}

/* Message aucun résultat */
.mobile-no-results {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255,255,255,0.7);
}

.mobile-no-results-icon {
  font-size: 50px;
  margin-bottom: 15px;
}

.mobile-no-results-text {
  font-size: 16px;
}

/* Message initial */
.mobile-search-hint {
  text-align: center;
  padding: 60px 30px;
  color: rgba(255,255,255,0.6);
}

.mobile-search-hint-icon {
  font-size: 60px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.mobile-search-hint-text {
  font-size: 15px;
  line-height: 1.5;
}

/* Compteur de cartes */
.mobile-cards-count {
  font-size: 12px;
  color: rgba(255,255,255,0.6);
  text-align: center;
  padding: 8px;
  margin-bottom: 5px;
}

/* Cartes mobiles */
.mobile-card {
  background: linear-gradient(135deg, #1e3a5f, #0d2240);
  border-radius: 10px;
  padding: 12px 15px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: transform 0.2s;
  border-left: 4px solid #3b82f6;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}

.mobile-card:active {
  transform: scale(0.98);
}

.mobile-card.region-qc {
  border-left-color: #3b82f6;
}

.mobile-card.region-on {
  border-left-color: #E8B97A;
  background: linear-gradient(135deg, #3d2815, #1a1108);
}

.mobile-card.region-ma {
  border-left-color: #C7458C;
  background: linear-gradient(135deg, #4a1535, #2a0a1a);
}

.mobile-card-name {
  flex: 1;
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  min-width: 100px;
}

.mobile-card-order {
  font-size: 13px;
  color: rgba(255,255,255,0.8);
  font-weight: 600;
}

.mobile-card-client {
  width: 100%;
  font-size: 11px;
  color: rgba(255,255,255,0.5);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.mobile-card-delay {
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
  background: rgba(255,255,255,0.2);
  color: #fff;
}

.mobile-card-delay.urgent {
  background: #f59e0b;
  color: #000;
}

.mobile-card-delay.retard {
  background: #ef4444;
  color: #fff;
  animation: mobileBlink 1s infinite;
}

@keyframes mobileBlink {
  50% { opacity: 0.5; }
}

/* Bouton accès desktop */
.mobile-desktop-btn {
  margin: 15px 20px;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 10px;
  color: rgba(255,255,255,0.8);
  font-size: 13px;
  text-align: center;
  cursor: pointer;
}

.mobile-desktop-btn:active {
  background: rgba(255,255,255,0.2);
}

/* =============================================================================
   FICHE MOBILE AVEC SWIPE - 2 PAGES (Info et Notes)
============================================================================= */

.mobile-fiche-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #ffffff;
  z-index: 100001;
  flex-direction: column;
  overflow: hidden;
}

.mobile-fiche-overlay.active {
  display: flex;
  animation: mobileSlideInUp 0.3s ease-out;
}

@keyframes mobileSlideInUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Header de la fiche mobile */
.mobile-fiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 15px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  border-bottom: none;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  gap: 10px;
}

.mobile-fiche-back {
  display: flex;
  align-items: center;
  gap: 4px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: #fff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  flex-shrink: 0;
}

.mobile-fiche-title {
  flex: 1;
  text-align: center;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.mobile-fiche-order {
  font-size: 13px;
  color: #fff;
  font-weight: 700;
  background: rgba(255,255,255,0.2);
  padding: 6px 10px;
  border-radius: 6px;
  flex-shrink: 0;
}

/* Container des pages swipe - PLEIN ÉCRAN */
.mobile-fiche-swipe-container {
  flex: 1;
  position: relative;
  overflow: hidden;
  width: 100%;
}

/* Wrapper pour 2 pages seulement */
.mobile-fiche-swipe-wrapper-2pages {
  display: flex;
  width: 200%;
  height: 100%;
  transition: transform 0.3s ease-out;
  will-change: transform;
}

.mobile-fiche-swipe-wrapper-2pages.dragging {
  transition: none;
}

.mobile-fiche-swipe-wrapper-2pages .mobile-fiche-page {
  width: 50%;
  min-width: 50%;
}

.mobile-fiche-page {
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 15px 12px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  flex-shrink: 0;
}

/* Page Info - PLEINE PAGE BLANCHE avec marges */
.mobile-page-info {
  background: #ffffff;
  padding: 15px 25px;
}

@media (min-width: 600px) {
  .mobile-page-info {
    padding: 20px 40px;
  }
}

/* Carte info */
.mobile-info-card {
  background: #ffffff;
  border-radius: 10px;
  padding: 8px 12px;
  margin-bottom: 0;
  border: 1px solid #e2e8f0;
  flex: 1;
  overflow-y: auto;
}

/* BLOC STATUT - Très visible en haut */
.mobile-status-block {
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  border-radius: 10px;
  padding: 10px 12px;
  margin-bottom: 8px;
  text-align: center;
  box-shadow: 0 3px 10px rgba(30, 64, 175, 0.3);
}

.mobile-status-block.attente {
  background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
  box-shadow: 0 3px 10px rgba(220, 38, 38, 0.3);
  animation: pulseAttente 2s infinite;
}

@keyframes pulseAttente {
  0%, 100% { box-shadow: 0 3px 10px rgba(220, 38, 38, 0.3); }
  50% { box-shadow: 0 3px 15px rgba(220, 38, 38, 0.6); }
}

.mobile-status-dept {
  font-size: 16px;
  font-weight: 800;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.mobile-status-raison {
  font-size: 10px;
  font-weight: 600;
  color: rgba(255,255,255,0.9);
  margin-top: 4px;
  padding: 4px 8px;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  display: inline-block;
}

/* Lignes d'info compactes */
.mobile-info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 3px 0;
  border-bottom: 1px solid #f1f5f9;
}

.mobile-info-row:last-child {
  border-bottom: none;
}

.mobile-info-row.double {
  flex-wrap: wrap;
  gap: 2px;
}

.mobile-info-half {
  display: flex;
  justify-content: space-between;
  width: 48%;
}

.mobile-info-label {
  font-size: 9px;
  color: #64748b;
  font-weight: 500;
  flex-shrink: 0;
}

.mobile-info-value {
  font-size: 9px;
  color: #1e293b;
  font-weight: 600;
  text-align: right;
  max-width: 55%;
  word-break: break-word;
}

.mobile-info-value.highlight {
  color: #16a34a;
  font-weight: 700;
}

/* Séparateur de section subtil */
.mobile-section-divider {
  height: 1px;
  background: linear-gradient(to right, transparent, #cbd5e1, transparent);
  margin: 3px 0;
}

/* BOUTONS PHOTOS - Pleine largeur, vert si vide */
.mobile-photos-section {
  margin-top: 6px;
}

.mobile-photos-grid {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.mobile-photo-btn-full {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
}

.mobile-photo-btn-full.has-photo {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
}

.mobile-photo-btn-full:active {
  transform: scale(0.98);
}

/* Slider compte expiré */
.mobile-expire-section {
  margin-top: 8px;
  padding: 8px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.mobile-expire-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.mobile-expire-label {
  font-size: 10px;
  font-weight: 600;
  color: #64748b;
}

.mobile-expire-toggle {
  position: relative;
  width: 44px;
  height: 24px;
  background: #cbd5e1;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.3s;
}

.mobile-expire-toggle.active {
  background: #ef4444;
}

.mobile-expire-toggle::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.mobile-expire-toggle.active::after {
  transform: translateX(20px);
}

/* Page Notes (droite) - PLEINE PAGE BLANCHE */
.mobile-page-notes {
  background: #ffffff;
}

/* Photos 1-6 sur page Notes */
.mobile-notes-photos-row {
  display: grid;
  grid-template-columns: 30px repeat(6, 1fr);
  gap: 4px;
  padding: 8px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
}

.mobile-photo-icon-notes {
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mobile-photo-btn-notes {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 4px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-radius: 6px;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
}

.mobile-photo-btn-notes.has-photo {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
}

.mobile-photo-btn-notes:active {
  transform: scale(0.95);
}

/* Textarea plein écran pour Notes */
.mobile-notes-textarea-full {
  width: 100%;
  height: 100%;
  flex: 1;
  padding: 15px;
  border: none;
  background: #ffffff;
  color: #1e293b;
  font-size: 16px;
  resize: none;
  box-sizing: border-box;
  font-family: inherit;
  line-height: 1.6;
}

.mobile-notes-textarea-full:focus {
  outline: none;
}

.mobile-notes-textarea-full::placeholder {
  color: #94a3b8;
}

/* Menu popup photos */
.mobile-photo-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200000;
  padding: 20px;
}

.mobile-photo-menu {
  background: #fff;
  border-radius: 16px;
  width: 100%;
  max-width: 350px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.mobile-photo-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
}

.mobile-photo-menu-content {
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
}

.mobile-photo-menu-field {
  margin-bottom: 15px;
}

.mobile-photo-menu-field label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  margin-bottom: 6px;
}

.mobile-photo-menu-field input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
}

.mobile-photo-menu-field input:focus {
  outline: none;
  border-color: #3b82f6;
}

.mobile-photo-menu-actions {
  padding: 15px 20px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
}

.mobile-photo-save-btn {
  width: 100%;
  padding: 12px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
}

/* Indicateurs swipe */
.mobile-swipe-hint {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 15px;
  color: #94a3b8;
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
  background: rgba(255,255,255,0.9);
  padding: 8px 16px;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: opacity 0.5s;
}

.mobile-swipe-hint-arrow {
  font-size: 18px;
  color: #3b82f6;
}
  </style>
</head>
<body>

<div class="app-root">
  <header class="topbar">
    <div class="tb-left">
      <div class="logo-flip-container" id="logoFlipContainer">
        <div class="logo-main">
          <div class="logo-top-fixed">
            <img src="https://raw.githubusercontent.com/Physipro-list/Physipro-serie/main/logo-physiprodemi1.png" alt="PhysiPro"/>
          </div>
          <div class="logo-bottom-text" id="logoBottomText">Moulage</div>
        </div>
        <div class="logo-menu" id="logoMenu">
          <div class="logo-menu-item" onclick="switchToPage('serie')">Série +</div>
          <div class="logo-menu-item" onclick="switchToPage('inventaire')">Inventaire</div>
          <div class="logo-menu-item" onclick="switchToPage('jobs')">Jobs en attente</div>
        </div>
      </div>
    </div>
    
    <div class="tb-center">
      <span class="top-title">Outil de gestion des moulages</span>
      <button class="settings-btn" id="btnSettings" title="Parametres">⚙️</button>
    </div>
    
    <div class="tb-right">
      <button class="header-btn" id="btnAddMoulage">+ Ajouter moulage</button>
      <div class="user-status" id="userStatus">
        <span class="status-dot"></span>
        <span class="user-name">Non connecte</span>
      </div>
    </div>
    
    <div class="search-row">
      <div class="search-box">
        <span class="search-icon">&#128269;</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Rechercher (nom, commande, client...)">
        <button class="search-clear hidden" id="searchClear">&#10005;</button>
      </div>
    </div>
  </header>
  
  <div class="page active" id="pageMoulages">
    <div class="board-wrapper">
      <div class="board" id="boardMoulages">
        <div class="col"><div class="col-header clickable" onclick="toggleRobotView()" title="Cliquer pour vue tableau"><span class="col-icon">⚙️</span><span class="col-title">Robot</span><span class="col-count" id="countRobot">0</span></div><div class="col-content" id="colRobot"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🪚</span><span class="col-title">Dégauchage</span><span class="col-count" id="countDégauchage">0</span></div><div class="col-content" id="colDégauchage"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">♿</span><span class="col-title">Essayage</span><span class="col-count" id="countEssayage">0</span></div><div class="col-content" id="colEssayage"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🔨</span><span class="col-title">Atelier</span><span class="col-count" id="countAtelier">0</span></div><div class="col-content" id="colAtelier"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🧵</span><span class="col-title">Couture</span><span class="col-count" id="countCouture">0</span></div><div class="col-content" id="colCouture"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🎨</span><span class="col-title">Peinture</span><span class="col-count" id="countPeinture">0</span></div><div class="col-content" id="colPeinture"></div></div>
        <div class="col"><div class="col-header"><span class="col-icon">🚚</span><span class="col-title">Expédition</span><span class="col-count" id="countExpedition">0</span></div><div class="col-content" id="colExpedition"></div></div>
        <div class="col"><div class="col-header en-attente"><span class="col-icon">⏳</span><span class="col-title">En attente</span><span class="col-count" id="countAttente">0</span></div><div class="col-content" id="colAttente"></div></div>
      </div>
    </div>
    
    <!-- Vue Robot Horizontale (en dehors du board-wrapper) -->
    <div id="robotHorizontalView" class="robot-horizontal-container">
      <div class="robot-horizontal-header">
        <h2>📊 Robot - Vue Tableau</h2>
        <div style="display:flex;gap:10px;">
          <button class="header-btn" onclick="showAddMoulageModal()" style="background:linear-gradient(to bottom,#22c55e,#16a34a);padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;">+ Ajouter</button>
          <button class="header-btn" onclick="toggleRobotView()" style="background:linear-gradient(to bottom,#3b82f6,#1e40af);padding:8px 16px;font-size:13px;font-weight:600;border-radius:6px;">← Kanban</button>
        </div>
      </div>
      <div class="robot-horizontal-scroll">
        <table class="robot-horizontal-table" id="robotTable">
          <thead>
            <tr>
              <th style="width:100px">Nom<div class="resize-handle"></div></th>
              <th style="width:90px"># Commande<div class="resize-handle"></div></th>
              <th style="width:90px"># Soumission<div class="resize-handle"></div></th>
              <th style="width:90px">Client<div class="resize-handle"></div></th>
              <th style="width:90px">Priorité<div class="resize-handle"></div></th>
              <th style="width:50px">Rang<div class="resize-handle"></div></th>
              <th style="width:70px">Région<div class="resize-handle"></div></th>
              <th style="width:80px">Item<div class="resize-handle"></div></th>
              <th style="width:85px">Reçue<div class="resize-handle"></div></th>
              <th style="width:85px">Livraison<div class="resize-handle"></div></th>
              <th style="width:85px">Essayage<div class="resize-handle"></div></th>
              <th style="width:90px">Représent.<div class="resize-handle"></div></th>
              <th style="width:50px">File<div class="resize-handle"></div></th>
              <th style="width:50px">Angle<div class="resize-handle"></div></th>
              <th style="width:50px">RUSH<div class="resize-handle"></div></th>
              <th style="width:40px">Notes</th>
            </tr>
          </thead>
          <tbody id="robotTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Page Série -->
  <div class="page" id="pageSerie">
    <div class="page-placeholder">
      <h1>📦 Série</h1>
      <p>Page en développement</p>
      <button class="header-btn" onclick="switchToPage('moulages')" style="background:linear-gradient(to bottom,#3b82f6,#1e40af);padding:12px 24px;font-size:14px;">← Retour aux Moulages</button>
    </div>
  </div>
  
  <!-- Page Inventaire -->
  <div class="page" id="pageInventaire">
    <div class="page-placeholder">
      <h1>📋 Inventaire</h1>
      <p>Page en développement</p>
      <button class="header-btn" onclick="switchToPage('moulages')" style="background:linear-gradient(to bottom,#3b82f6,#1e40af);padding:12px 24px;font-size:14px;">← Retour aux Moulages</button>
    </div>
  </div>
  
  <!-- Page Jobs en Attente -->
  <div class="page" id="pageJobs">
    <div class="page-placeholder">
      <h1>⏳ Jobs en Attente</h1>
      <p>Page en développement</p>
      <button class="header-btn" onclick="switchToPage('moulages')" style="background:linear-gradient(to bottom,#3b82f6,#1e40af);padding:12px 24px;font-size:14px;">← Retour aux Moulages</button>
    </div>
  </div>
  
  <!-- Settings Overlay (position fixe, hors flux) -->
  <div class="settings-overlay hidden" id="settingsOverlay">
    <div class="settings-popup">
      <div class="settings-header">
        <span>&#9881; Parametres</span>
        <button class="settings-close-btn" id="settingsCloseBtn">&#10005;</button>
      </div>
      <div class="settings-content">
        <button class="settings-item" id="btnImportExport"><span class="settings-icon">&#128230;</span><span>Importer / Exporter</span></button>
        <button class="settings-item" id="btnArchives"><span class="settings-icon">&#128203;</span><span>Log / Archives</span></button>
        <button class="settings-item logout" id="btnLogout"><span class="settings-icon">&#128682;</span><span>Deconnexion</span></button>
      </div>
    </div>
  </div>
  
  <!-- Menu Import/Export -->
  <div class="import-export-overlay hidden" id="importExportOverlay">
    <div class="import-export-popup">
      <div class="import-export-header">
        <span>📦 Importer / Exporter les données</span>
        <button class="import-export-close-btn" onclick="closeImportExportMenu()">✕</button>
      </div>
      <div class="import-export-content">
        <div class="import-export-section">
          <h3>📤 Exporter les données</h3>
          <p>Télécharger toutes vos données (moulages, paramètres) dans un fichier JSON.</p>
          <button class="import-export-btn export-btn" onclick="exportAllData()">
            <span>📥</span> Exporter toutes les données
          </button>
          <div class="export-options">
            <button class="import-export-btn-small" onclick="exportMoulagesOnly()">Moulages seulement</button>
          </div>
        </div>
        <div class="import-export-divider"></div>
        <div class="import-export-section">
          <h3>📥 Importer les données</h3>
          <p>Charger des données depuis un fichier JSON exporté précédemment.</p>
          <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
          <button class="import-export-btn import-btn" onclick="document.getElementById('importFileInput').click()">
            <span>📤</span> Importer un fichier
          </button>
          <div class="import-warning">
            ⚠️ L'importation ajoutera les données au système. Exportez d'abord vos données actuelles!
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Menu Log/Archives -->
  <div class="log-overlay hidden" id="logOverlay">
    <div class="log-popup">
      <div class="log-header">
        <span>📋 Journal des activités</span>
        <button class="log-close-btn" onclick="closeLogMenu()">✕</button>
      </div>
      <div class="log-content" id="logContent">
        <div class="log-empty">Aucune activité enregistrée</div>
      </div>
    </div>
  </div>
  
  <!-- Menu de déplacement avec rangs -->
  <div class="move-overlay hidden" id="moveOverlay">
    <div class="move-panel">
      <div class="move-title">Déplacer vers quelle colonne?</div>
      <div class="move-columns" id="moveColumns">
        <!-- Généré dynamiquement -->
      </div>
      <div class="move-footer">
        <button class="move-btn-close" id="moveClose">Annuler</button>
      </div>
    </div>
  </div>
  
  <!-- Confirmation suppression -->
  <div class="confirm-overlay hidden" id="confirmOverlay">
    <div class="confirm-panel">
      <div class="confirm-title">⚠️ Confirmer la suppression</div>
      <div class="confirm-message" id="confirmMessage">Voulez-vous vraiment supprimer ce moulage?</div>
      <div class="confirm-buttons">
        <button class="confirm-btn confirm-btn-yes" id="confirmYes">Oui, supprimer</button>
        <button class="confirm-btn confirm-btn-no" id="confirmNo">Non, annuler</button>
      </div>
    </div>
  </div>
  
  <!-- Overlay pour la fiche moulage -->
  <div class="card-overlay" id="cardOverlay" onclick="closeFiche()"></div>
  
  <!-- List Manager Overlay -->
  <div class="list-manager-overlay hidden" id="listManagerOverlay">
    <div class="list-manager-popup">
      <div class="list-manager-header">
        <h3 id="listManagerTitle">&#9881; Gérer les valeurs</h3>
        <button class="list-manager-close-btn" onclick="closeListManager()">&#10005;</button>
      </div>
      <div class="list-manager-content">
        <div class="list-manager-items" id="listManagerItems"></div>
      </div>
      <div class="list-manager-footer">
        <div class="list-manager-input-wrapper">
          <input type="text" id="listManagerNewItem" placeholder="Nouvelle valeur..." onkeypress="if(event.key==='Enter'){addListItem();}">
          <button class="btn-add-inside" onclick="addListItem()" title="Ajouter">+</button>
        </div>
        <button class="btn-close-list" onclick="closeListManager()">Fermer</button>
      </div>
    </div>
  </div>
  
  <div id="loginOverlay" class="login-overlay">
    <div class="login-panel">
      <div class="login-logo-flip-container">
        <div class="login-logo-flip-inner">
          <div class="login-logo-flip-front">
            <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro1.png" alt="PhysiPro Moulage">
          </div>
        </div>
      </div>
      <div class="login-title-container">
        <div class="login-title">Outil d'aide de gestion pour les moulages</div>
        <div class="login-author">par Daniel Charest</div>
      </div>
      <div class="login-subtitle">Connectez-vous avec votre email d'entreprise</div>
      <input type="email" id="loginEmail" class="login-input login-input-email" placeholder="Email d'entreprise" autocomplete="email">
      <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" maxlength="50" autocomplete="current-password">
      <div class="login-remember">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">Se souvenir de moi sur cet ordinateur</label>
      </div>
      <button class="login-btn" id="loginBtn">Se connecter</button>
      <button class="login-forgot-btn" id="forgotPasswordBtn">Mot de passe oublie?</button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>
</div>

<script>
// =====================================================
// PHYSIPRO MOULAGE v12.0 - JAVASCRIPT PROPRE
// =====================================================

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCk7bqVnx08Kz1fVq1W24AuW854KY9jPno",
  authDomain: "liste-des-moulages-physipro.firebaseapp.com",
  databaseURL: "https://liste-des-moulages-physipro-default-rtdb.firebaseio.com",
  projectId: "liste-des-moulages-physipro",
  storageBucket: "liste-des-moulages-physipro.firebasestorage.app",
  messagingSenderId: "24566847562",
  appId: "1:24566847562:web:db492bdd33116373e0eeb3"
};

// Utilisateurs autorises (identique au fichier original)
const USERS = {
  "atelieratp@physipro.com": { name: "Daniel Charest", role: "admin", tempHash: "997a5fb50ce12b5619bdb2ecc2dc05f216af0ab61bb3f2609017c3fcb62da2ae" },
  "simdut@physipro.com": { name: "Cassie Valois", role: "editor", tempHash: "b36e5a61cadecc891b457429048e44133cf8dae501a9cfc4c423bcf00715da30" },
  "mplanguedoc@physipro.com": { name: "Marie-Pier Languedoc", role: "editor", tempHash: "ff5cfebfb49c5213aa2304f15e19c3147f48d55aa26ea299f7457c0209f804e0" },
  "marie-soleil.riverin@physipro.com": { name: "Marie-Soleil Riverin", role: "editor", tempHash: "722d36562183c87fa53ce5c44d424c63c6c3b2b27c72c7a233663d9f568fecc2" },
  "michelle.bouchard@physipro.com": { name: "Michelle Bouchard", role: "editor", tempHash: "a899253b54dd6c800f9513919186a55948f9ff0d6162b9fdb200bdaf60a500f3" },
  "ngagne@physipro.com": { name: "Nadia Gagne", role: "editor", tempHash: "cb2a7765e640d51841f9aa8dfc335e19bcbd894b0c8cc096d97a073c9a4b548d" },
  "cncatp@physipro.com": { name: "Sina Lotfollah", role: "editor", tempHash: "1d537709c14a89facf0704bd2c091d9da8b48fe69b0c65de5741db0b9ad7919d" },
  "magasinatp3@physipro.com": { name: "Stephane Delorme", role: "editor", tempHash: "5042c15596f4aad0f612d50e0c013476f84a1d709527eca42821cf423f6092c0" },
  "sroy@physipro.com": { name: "Stephanie Roy", role: "editor", tempHash: "eeff8c3b9ae24e6a2d8b3c8766c0a7bf927bf479da0aa94e21061ded39c6ce6d" },
  "magasinatp2@physipro.com": { name: "Sylvain Carrier", role: "editor", tempHash: "ffdebc076a622154180f479624c9a9e1c4ff4c832f62aca8f15341d16cfda6ef" },
  "mario.jacques@physipro.com": { name: "Mario Jacques", role: "editor", tempHash: "15d700ad21280a8c2fa03075c55c70a766ea8c9db5b5d8f7a850835e67514357" },
  "valerie18@videotron.ca": { name: "Valerie Frechette", role: "editor", tempHash: "3277ff046b6d07eb1ff818f1a54ef1a7d40d72cb151fd29058efc54bfbe84d1a" },
  "fabrys.frechette@physipro.com": { name: "Fabrys Frechette", role: "viewer", tempHash: "2815e7664309c9785471fe9dba0c2ed4f97dd52a89f5e2b17fa695187d07c34e" },
  "rh@physipro.com": { name: "Roxanne Valois", role: "viewer", tempHash: "47fb2d990d95be18c1e0206e1f3640bcaf5ed0345bbb220757556d0fd3424f07" },
  "sonia.boulanger@physipro.com": { name: "Sonia Boulanger", role: "viewer", tempHash: "847267f5801f9d09b17995593d69db5a4b6a425c3d8594d8cdf81227c80e1fec" },
  "magasinatp1@physipro.com": { name: "Stephane Duchesneau", role: "viewer", tempHash: "bbca07c4246a26a6c438c325d29329b90693a5d26ccc166dd30ae755c9cfc540" },
  "marioouellette@physipro.com": { name: "Mario Ouellette", role: "viewer", tempHash: "71b5601cad7b61f8a9bbf42546303b4676990f07d8ecee70a89c464b36553c4a" },
  "service3@physipro.com": { name: "Jacynthe Gaumond", role: "viewer", tempHash: "fd9f31c199a09b28b4d0eafe0dd63713f219141c2723a62ec68106079c3b10b5" }
};

const COLUMNS = [
  { id: 0, name: 'Robot', contentId: 'colRobot', countId: 'countRobot' },
  { id: 1, name: 'Dégauchage', contentId: 'colDégauchage', countId: 'countDégauchage' },
  { id: 2, name: 'Essayage', contentId: 'colEssayage', countId: 'countEssayage' },
  { id: 3, name: 'Atelier', contentId: 'colAtelier', countId: 'countAtelier' },
  { id: 4, name: 'Couture', contentId: 'colCouture', countId: 'countCouture' },
  { id: 5, name: 'Peinture', contentId: 'colPeinture', countId: 'countPeinture' },
  { id: 6, name: 'Expédition', contentId: 'colExpedition', countId: 'countExpedition' },
  { id: 7, name: 'En attente', contentId: 'colAttente', countId: 'countAttente' }
];

let firebaseAuth, firebaseDb, currentUser = null, cardsData = {};

// Listes personnalisables (triees alphabetiquement)
let customLists = {
  moulageClients: [
    'IWK Nouvelle Ecosse',
    'MED +',
    'Metro Health Nouveau Brunswick',
    'SAT Baie Comeau',
    'SAT CRE Sherbrooke',
    'SAT CRDPCA',
    'SAT Gaspesie Saint Anne des Monts',
    'SAT IRDPQ Hamel',
    'SAT Joliette',
    'SAT Jonquiere Saguenay Lac Saint Jean',
    'SAT Mont Joli',
    'SAT Sept Iles',
    'SAT Trois Rivieres',
    'Stan Cassidy Nouveau Brunswick',
    'TLC Medical'
  ],
  regions: ['Maritime', 'Ontario', 'Quebec'],
  intervenants: [
    'Anna Caulfield',
    'Annie Bourgeois',
    'Anne Sophie Montminy',
    'Camille Morel',
    'Cindy Audet',
    'Eric Gagnon',
    'Godefroy Neault',
    'Isabelle Neault',
    'Jenny Jackson',
    'Joelle Bourdages',
    'Josee Bedard',
    'Josianne Labrecque',
    'Judith Lagimoniere',
    'Julie Lefebvre',
    'Lisa Houde',
    'Louis Matton',
    'Maggie MCCann',
    'Marie Michelle Hamel',
    'Marie Smith',
    'Mario Lebouthiller',
    'Martine Comeau',
    'Mireille Lefebvre',
    'Nadyne Gobeil',
    'Pam McKaskill',
    'Stephanie DAstou',
    'Tabitha Knowles',
    'Ysabelle Fugere'
  ],
  representantes: ['Fabrys', 'Marie-Pier', 'Marie-Soleil', 'Multipass'],
  items: [
    'Appui-tête',
    'Coussin',
    'Dossier',
    'Siège',
    'Siège + Dossier'
  ],
  raisonsAttente: [
    "En attente de pièces",
    "En attente d'approbation client",
    "En attente de réponse couture",
    "En attente de réponse atelier",
    "En attente de réponse robot",
    "En attente de posit",
    "En attente ROHO",
    "En attente de plaques d'aluminium",
    "En attente de fichiers de scans"
  ]
};

let currentListKey = null;
let currentListTitle = null;

// Elements DOM
const loginOverlay = document.getElementById('loginOverlay');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const userStatusEl = document.getElementById('userStatus');

// Init Firebase
function initFirebase() {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    firebaseAuth = firebase.auth();
    firebaseDb = firebase.database();
    return true;
  } catch (e) {
    console.error("Erreur Firebase:", e);
    return false;
  }
}

// Connexion
async function attemptLogin() {
  const email = loginEmail.value.trim().toLowerCase();
  const password = loginPassword.value;
  
  if (!email) { loginError.textContent = "Veuillez entrer votre email"; return; }
  if (!password) { loginError.textContent = "Veuillez entrer votre mot de passe"; return; }
  
  const userInfo = USERS[email];
  if (!userInfo) { loginError.textContent = "Cet email n'est pas autorise"; return; }
  
  loginBtn.textContent = "Connexion...";
  loginBtn.disabled = true;
  loginError.textContent = "";
  
  try {
    await firebaseAuth.signInWithEmailAndPassword(email, password);
    // Sauvegarder si checkbox cochee
    if (document.getElementById('rememberMe').checked) {
      localStorage.setItem('physipro_remember', JSON.stringify({ email, password }));
    } else {
      localStorage.removeItem('physipro_remember');
    }
    loginSuccess(userInfo, email);
  } catch (error) {
    const messages = {
      "auth/wrong-password": "Email ou mot de passe incorrect",
      "auth/invalid-credential": "Email ou mot de passe incorrect",
      "auth/user-not-found": "Compte non trouve",
      "auth/too-many-requests": "Trop de tentatives, reessayez plus tard",
      "auth/network-request-failed": "Erreur reseau"
    };
    loginError.textContent = messages[error.code] || "Erreur de connexion";
    loginPassword.value = "";
  }
  
  loginBtn.textContent = "Se connecter";
  loginBtn.disabled = false;
}

function loginSuccess(userInfo, email) {
  currentUser = { ...userInfo, email };
  loginOverlay.classList.add('hidden');
  
  const statusDot = userStatusEl.querySelector('.status-dot');
  const userName = userStatusEl.querySelector('.user-name');
  if (statusDot) statusDot.classList.add('online');
  if (userName) userName.innerHTML = userInfo.name + '<span class="user-role-badge ' + userInfo.role + '">' + 
    ({ admin: 'Admin', editor: 'Editeur', viewer: 'Lecteur' }[userInfo.role] || userInfo.role) + '</span>';
  
  loadCardsFromFirebase();
  loadCustomLists();
  showToast("Connexion réussie!");
  
  // Initialiser l'interface mobile si on est sur mobile/tablette
  if (typeof initMobileAfterLogin === 'function') {
    initMobileAfterLogin();
  }
}

function loadSavedCredentials() {
  try {
    const saved = JSON.parse(localStorage.getItem('physipro_remember'));
    if (saved) {
      loginEmail.value = saved.email || '';
      loginPassword.value = saved.password || '';
    }
  } catch (e) {}
}

async function logout() {
  await firebaseAuth.signOut();
  location.reload();
}

// ===== DONNEES =====
let MENU_DATA = {
  regions: ["Quebec", "Ontario", "Maritime"],
  delays: { "Quebec": 90, "Ontario": 30, "Maritime": 45 },
  clients: [],
  intervenants: [],
  representantes: ["Marie-Soleil", "Marie-Pier", "Multipass", "Fabrys"],
  items: ["Siege", "Dossier", "Siege + Dossier"]
};

// Jours feries Quebec
const QUEBEC_HOLIDAYS = [
  '2024-01-01', '2024-04-29', '2024-05-20', '2024-06-24', '2024-07-01',
  '2024-09-02', '2024-10-14', '2024-12-25', '2024-12-26',
  '2025-01-01', '2025-04-21', '2025-05-19', '2025-06-24', '2025-07-01',
  '2025-09-01', '2025-10-13', '2025-12-25', '2025-12-26'
];

// Charger cartes depuis Firebase
function loadCardsFromFirebase() {
  firebaseDb.ref('cards').on('value', snapshot => {
    const data = snapshot.val();
    
    // Supprimer cartes qui n'existent plus
    document.querySelectorAll('.mcard[data-card-id]').forEach(card => {
      const cardId = card.dataset.cardId;
      if (!data || !data[cardId]) {
        card.remove();
        delete cardsData[cardId];
      }
    });
    
    if (data) {
      Object.keys(data).forEach(cardId => {
        const cardData = data[cardId];
        cardsData[cardId] = cardData;
        
        let card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        const isAttente = (cardData.columnIndex === 7);
        const isExpedition = (cardData.columnIndex === 6);
        
        if (card) {
          // Mettre a jour carte existante
          updateExistingCard(card, cardId, cardData);
        } else {
          // Creer nouvelle carte
          card = createCardElement(cardId, cardData);
          const columns = document.querySelectorAll('.col');
          const targetCol = columns[cardData.columnIndex || 0];
          if (targetCol) {
            const content = targetCol.querySelector('.col-content');
            if (content) content.appendChild(card);
          }
          attachCardEvents(card);
        }
      });
      
      updateColumnCounts();
      refreshAllPriorities();
      console.log(`${Object.keys(data).length} cartes synchronisees`);
    } else {
      updateColumnCounts();
    }
  });
}

// Creer element carte
function createCardElement(cardId, cardData) {
  const card = document.createElement('div');
  card.className = 'mcard';
  card.dataset.cardId = cardId;
  
  // Classe region
  if (cardData.region === 'Quebec') card.classList.add('region-qc');
  else if (cardData.region === 'Ontario') card.classList.add('region-on');
  else if (cardData.region === 'Maritime') card.classList.add('region-ma');
  
  if (cardData.columnIndex === 7) card.classList.add('in-attente-column');
  if (cardData.columnIndex === 6) card.classList.add('in-expedition-column');
  
  // Calculer delai
  const delayInfo = getDelayInfo(cardData);
  const regionText = cardData.region || '--';
  
  // Nom et commande: verrouillés si déjà remplis
  const nameLocked = cardData.name && cardData.name.trim() !== '' && cardData.name !== 'Nom du moulage';
  const orderLocked = cardData.order && cardData.order.trim() !== '' && cardData.order !== '000000';
  
  card.innerHTML = `
    <div class="priority-badge hidden" data-priority="0"></div>
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <input type="text" class="mcard-title ${nameLocked ? 'locked' : ''}" value="${cardData.name || 'Nom du moulage'}" data-field="name" ${nameLocked ? 'readonly' : ''}>
        </div>
        <div class="mcard-order-line">
          <span class="mcard-region-pill" onclick="openPriorityMenu('${cardId}', event)" title="Cliquer pour priorite">${regionText}</span>
          <input type="text" class="mcard-order ${orderLocked ? 'locked' : ''}" value="${cardData.order || '000000'}" data-field="order" maxlength="6" ${orderLocked ? 'readonly' : ''}>
          <button class="mcard-fiche-btn" data-action="open-fiche" data-card-id="${cardId}" title="Ouvrir la fiche">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="${delayInfo.classes}" onclick="openDelaiMenu('${cardId}', event)"><span>${delayInfo.text}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move">Deplacer</button>
      <button class="mcard-btn mcard-btn-delete">Supprimer</button>
    </div>
  `;
  
  return card;
}

// Mettre a jour carte existante
function updateExistingCard(card, cardId, cardData) {
  const titleInput = card.querySelector('.mcard-title');
  const orderInput = card.querySelector('.mcard-order');
  if (titleInput) titleInput.value = cardData.name || 'Nom du moulage';
  if (orderInput) orderInput.value = cardData.order || '000000';
  
  // Mettre a jour region
  card.classList.remove('region-qc', 'region-on', 'region-ma', 'in-attente-column', 'in-expedition-column');
  if (cardData.region === 'Quebec') card.classList.add('region-qc');
  else if (cardData.region === 'Ontario') card.classList.add('region-on');
  else if (cardData.region === 'Maritime') card.classList.add('region-ma');
  if (cardData.columnIndex === 7) card.classList.add('in-attente-column');
  if (cardData.columnIndex === 6) card.classList.add('in-expedition-column');
  
  // Mettre a jour pastille delai
  const delayPill = card.querySelector('.mcard-delay-pill');
  const delaySpan = delayPill?.querySelector('span');
  if (delayPill && delaySpan) {
    delayPill.className = 'mcard-delay-pill';
    const delayInfo = getDelayInfo(cardData);
    delaySpan.textContent = delayInfo.text;
    delayInfo.classes.split(' ').forEach(c => { if (c) delayPill.classList.add(c); });
  }
  
  // Deplacer si necessaire
  const columns = document.querySelectorAll('.col');
  const currentCol = card.closest('.col');
  const targetCol = columns[cardData.columnIndex || 0];
  if (currentCol !== targetCol && targetCol) {
    const content = targetCol.querySelector('.col-content');
    if (content) content.appendChild(card);
  }
}

// Calculer info delai
function getDelayInfo(cardData) {
  const isAttente = cardData.columnIndex === 7;
  const isExpedition = cardData.columnIndex === 6;
  
  if (cardData.expedie && cardData.dateExpedition) {
    return { text: `Expédié ${cardData.dateExpedition}`, classes: 'mcard-delay-pill expedie' };
  }
  
  if (isAttente) {
    let classes = 'mcard-delay-pill';
    if (cardData.raisonAttente && cardData.attenteActive) classes += ' attente-active';
    return { text: cardData.raisonAttente || '? Raison', classes };
  }
  
  if (isExpedition) {
    return { text: 'Prêt à expédier', classes: 'mcard-delay-pill' };
  }
  
  // Calculer jours restants
  const hasValidDateRobot = cardData.dateRobot && cardData.dateRobot !== '' && cardData.dateRobot !== 'AAAA-MM-JJ';
  
  if (hasValidDateRobot) {
    const joursRestants = calculateRemainingDelay(cardData);
    
    if (joursRestants < 0) {
      const joursRetard = Math.abs(joursRestants);
      return { text: `${joursRetard} jour${joursRetard > 1 ? 's' : ''} retard`, classes: 'mcard-delay-pill delai-retard' };
    } else if (joursRestants === 0) {
      return { text: "Aujourd'hui!", classes: 'mcard-delay-pill delai-retard' };
    } else {
      let colorClass = 'delai-vert';
      if (joursRestants <= 3) colorClass = 'delai-rouge';
      else if (joursRestants <= 10) colorClass = 'delai-jaune';
      return { text: `${joursRestants} jour${joursRestants > 1 ? 's' : ''} ouvrable${joursRestants > 1 ? 's' : ''}`, classes: `mcard-delay-pill ${colorClass}` };
    }
  } else {
    const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
    return { text: `${delaiTotal} jours ouvrables`, classes: 'mcard-delay-pill delai-vert' };
  }
}

// Calculer jours restants
function calculateRemainingDelay(cardData) {
  if (cardData.expedie) return 0;
  
  const delaiTotal = cardData.delaiPersonnalise || MENU_DATA.delays[cardData.region] || 90;
  const dateRobotStr = cardData.dateRobot;
  
  if (!dateRobotStr || dateRobotStr === '' || dateRobotStr === 'AAAA-MM-JJ') {
    return delaiTotal;
  }
  
  const dateRobot = new Date(dateRobotStr + 'T00:00:00');
  if (isNaN(dateRobot.getTime())) return delaiTotal;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let joursOuvrablesEcoules = compterJoursOuvrables(dateRobot, today);
  
  // Soustraire temps en essayage
  if (cardData.tracking && cardData.tracking.essayage) {
    const essayage = cardData.tracking.essayage;
    if (essayage.entree && essayage.sortie) {
      const dateEntree = new Date(essayage.entree + 'T00:00:00');
      const dateSortie = new Date(essayage.sortie + 'T00:00:00');
      if (!isNaN(dateEntree.getTime()) && !isNaN(dateSortie.getTime())) {
        const joursEssayage = compterJoursOuvrables(dateEntree, dateSortie);
        joursOuvrablesEcoules -= joursEssayage;
        if (joursOuvrablesEcoules < 0) joursOuvrablesEcoules = 0;
      }
    }
  }
  
  return delaiTotal - joursOuvrablesEcoules;
}

// Compter jours ouvrables
function compterJoursOuvrables(dateDebut, dateFin) {
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  debut.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  if (fin <= debut) return 0;
  
  let count = 0;
  const current = new Date(debut);
  current.setDate(current.getDate() + 1);
  
  while (current <= fin) {
    const dayOfWeek = current.getDay();
    const dateStr = current.toISOString().split('T')[0];
    
    if (dayOfWeek !== 0 && dayOfWeek !== 6 && !QUEBEC_HOLIDAYS.includes(dateStr)) {
      count++;
    }
    current.setDate(current.getDate() + 1);
  }
  
  return count;
}

// Attacher evenements carte
function attachCardEvents(card) {
  const cardId = card.dataset.cardId;
  
  // Input titre
  const titleInput = card.querySelector('.mcard-title');
  titleInput?.addEventListener('focus', () => titleInput.select());
  titleInput?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); titleInput.blur(); } });
  titleInput?.addEventListener('blur', () => {
    if (cardsData[cardId]) {
      cardsData[cardId].name = titleInput.value || 'Nom du moulage';
      saveCardToFirebase(cardId);
    }
  });
  
  // Input commande
  const orderInput = card.querySelector('.mcard-order');
  orderInput?.addEventListener('focus', () => orderInput.select());
  orderInput?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); orderInput.blur(); } });
  orderInput?.addEventListener('input', () => { orderInput.value = orderInput.value.replace(/[^0-9]/g, '').slice(0, 6); });
  orderInput?.addEventListener('blur', () => {
    if (cardsData[cardId]) {
      cardsData[cardId].order = orderInput.value || '000000';
      saveCardToFirebase(cardId);
    }
  });
  
  // Bouton Fiche
  const ficheBtn = card.querySelector('.mcard-fiche-btn');
  ficheBtn?.addEventListener('click', e => {
    e.stopPropagation();
    openFiche(card);
  });
  
  // Bouton Deplacer
  const moveBtn = card.querySelector('.mcard-btn-move');
  moveBtn?.addEventListener('click', e => {
    e.stopPropagation();
    openMoveMenu(cardId);
  });
  
  // Bouton Supprimer
  const deleteBtn = card.querySelector('.mcard-btn-delete');
  deleteBtn?.addEventListener('click', e => {
    e.stopPropagation();
    showDeleteConfirm(card, cardId);
  });
}

// Variables pour la suppression
let cardToDelete = null;
let cardIdToDelete = null;

function showDeleteConfirm(card, cardId) {
  cardToDelete = card;
  cardIdToDelete = cardId;
  const name = cardsData[cardId]?.name || 'ce moulage';
  document.getElementById('confirmMessage').textContent = `Voulez-vous vraiment supprimer "${name}"?`;
  document.getElementById('confirmOverlay').classList.remove('hidden');
}

function closeDeleteConfirm() {
  document.getElementById('confirmOverlay').classList.add('hidden');
  cardToDelete = null;
  cardIdToDelete = null;
}

function confirmDelete() {
  if (cardToDelete && cardIdToDelete) {
    const name = cardsData[cardIdToDelete]?.name || 'Inconnu';
    
    cardToDelete.remove();
    delete cardsData[cardIdToDelete];
    updateColumnCounts();
    firebaseDb.ref('cards/' + cardIdToDelete).remove();
    showToast('Moulage "' + name + '" supprimé');
  }
  closeDeleteConfirm();
}

// Sauvegarder carte
function saveCardToFirebase(cardId) {
  if (cardsData[cardId]) {
    firebaseDb.ref('cards/' + cardId).set(cardsData[cardId]);
  }
}

// Générer ID unique pour carte
function generateCardId() {
  return 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Créer une nouvelle carte
function createCard(name, order, region, columnIndex) {
  const cardId = generateCardId();
  const delay = MENU_DATA.delays[region] || 90;
  
  // Créer l'élément carte
  const card = document.createElement('div');
  card.className = 'mcard';
  card.dataset.cardId = cardId;
  
  // Classe région
  if (region === 'Québec' || region === 'Quebec') card.classList.add('region-qc');
  else if (region === 'Ontario') card.classList.add('region-on');
  else if (region === 'Maritime') card.classList.add('region-ma');
  
  // Marquer si colonne spéciale
  if (columnIndex === 7) card.classList.add('in-attente-column');
  if (columnIndex === 6) card.classList.add('in-expedition-column');
  
  const item = 'Siège';
  const isAttente = columnIndex === 7;
  const isExpedition = columnIndex === 6;
  
  // Déterminer le texte et la classe de couleur de la pastille délai
  let delayText = delay + ' jours ouvrables';
  let delayClass = 'mcard-delay-pill delai-vert';
  
  if (isAttente) {
    delayText = '? Raison';
    delayClass = 'mcard-delay-pill';
  } else if (isExpedition) {
    delayText = 'Expédier';
    delayClass = 'mcard-delay-pill';
  }
  
  card.innerHTML = `
    <div class="priority-badge hidden" data-priority="0"></div>
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <input type="text" class="mcard-title" value="${name}" data-field="name">
        </div>
        <div class="mcard-order-line">
          <span class="mcard-region-pill" onclick="openPriorityMenu('${cardId}', event)" title="Cliquer pour définir priorité">${region}</span>
          <input type="text" class="mcard-order" value="${order}" data-field="order" maxlength="6">
          <button class="mcard-fiche-btn" data-action="open-fiche" data-card-id="${cardId}" title="Ouvrir la fiche">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="${delayClass}" onclick="openDelaiMenu('${cardId}', event)"><span>${delayText}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move">Déplacer</button>
      <button class="mcard-btn mcard-btn-delete">Supprimer</button>
    </div>
  `;
  
  // Stocker les données avec tracking initial
  const today = new Date().toISOString().split('T')[0];
  const deptMap = {0:'robot', 1:'degauchage', 2:'essayage', 3:'atelier', 4:'couture', 5:'peinture', 6:'expedition'};
  const initialTracking = {};
  if (deptMap[columnIndex]) {
    initialTracking[deptMap[columnIndex]] = { entree: today };
  }
  
  cardsData[cardId] = {
    name, order, region,
    columnIndex,
    item,
    priority: 0,
    raisonAttente: '',
    dateRecue: today,
    dateRobot: columnIndex === 0 ? today : '',
    dateEssayage: '',
    dateLivraison: '',
    client: '',
    intervenant: '',
    representant: '',
    notes: '',
    tracking: initialTracking
  };
  
  // Ajouter à la colonne
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[columnIndex];
  if (targetCol) {
    const content = targetCol.querySelector('.col-content');
    if (content) content.appendChild(card);
  }
  
  // Attacher les événements
  attachCardEvents(card);
  updateColumnCounts();
  
  // Sauvegarder dans Firebase
  saveCardToFirebase(cardId);
  
  return cardId;
}

// Mise a jour compteurs colonnes
function updateColumnCounts() {
  COLUMNS.forEach(col => {
    const container = document.getElementById(col.contentId);
    const countEl = document.getElementById(col.countId);
    if (container && countEl) {
      countEl.textContent = container.querySelectorAll('.mcard').length;
    }
  });
}

// Rafraichir priorites
function refreshAllPriorities() {
  Object.keys(cardsData).forEach(cardId => {
    const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (card) {
      const badge = card.querySelector('.priority-badge');
      const priority = cardsData[cardId].priority || 0;
      if (badge) {
        if (priority > 0) {
          badge.textContent = priority;
          badge.className = `priority-badge p${priority}`;
        } else {
          badge.className = 'priority-badge hidden';
        }
      }
    }
  });
}

// Menu priorite
function openPriorityMenu(cardId, event) {
  event.stopPropagation();
  document.querySelector('.priority-menu')?.remove();
  
  const menu = document.createElement('div');
  menu.className = 'priority-menu';
  menu.innerHTML = `
    <div class="priority-menu-item" data-priority="0"><div class="priority-dot none">-</div>Aucune priorite</div>
    <div class="priority-menu-item" data-priority="1"><div class="priority-dot p1">1</div>Priorité 1 - URGENT</div>
    <div class="priority-menu-item" data-priority="2"><div class="priority-dot p2">2</div>Priorité 2 - Important</div>
    <div class="priority-menu-item" data-priority="3"><div class="priority-dot p3">3</div>Priorité 3 - À surveiller</div>
    <div class="priority-menu-item" data-priority="4"><div class="priority-dot p4">4</div>Priorité 4 - Normal+</div>
    <div class="priority-menu-item" data-priority="5"><div class="priority-dot p5">5</div>Priorité 5 - Basse</div>
  `;
  
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';
  document.body.appendChild(menu);
  
  menu.querySelectorAll('.priority-menu-item').forEach(item => {
    item.addEventListener('click', () => {
      const priority = parseInt(item.dataset.priority);
      if (cardsData[cardId]) {
        cardsData[cardId].priority = priority;
        saveCardToFirebase(cardId);
        refreshAllPriorities();
      }
      menu.remove();
    });
  });
  
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

// Variable pour stocker la carte à déplacer
let cardToMove = null;

// Menu deplacement avec rangs
function showMoveMenu(card) {
  cardToMove = card;
  const cardId = card.dataset.cardId;
  const currentCol = cardsData[cardId]?.columnIndex ?? 0;
  const moveColumns = document.getElementById('moveColumns');
  
  // Compter les cartes dans chaque colonne
  let html = '';
  COLUMNS.forEach((col, i) => {
    const cardsInCol = Object.values(cardsData).filter(c => c.columnIndex === i).length;
    const isCurrent = (i === currentCol);
    
    html += `
      <div class="move-column">
        <div class="move-column-header ${isCurrent ? 'current' : ''}">
          ${col.name}
        </div>
        <div class="move-positions">
    `;
    
    if (isCurrent) {
      html += `<div class="move-position-btn" style="opacity:0.4;cursor:default;font-size:7px;">Colonne actuelle</div>`;
    } else if (cardsInCol === 0) {
      html += `<button class="move-position-btn" data-col="${i}" data-pos="1">1</button>`;
    } else {
      const maxPos = cardsInCol + 1;
      for (let pos = 1; pos <= maxPos; pos++) {
        const isLast = (pos === maxPos);
        const posLabel = isLast ? `${pos} (dernier)` : pos;
        html += `<button class="move-position-btn" data-col="${i}" data-pos="${pos}">${posLabel}</button>`;
      }
    }
    
    html += `
        </div>
      </div>
    `;
  });
  
  moveColumns.innerHTML = html;
  
  // Ajouter les event listeners aux boutons de position
  moveColumns.querySelectorAll('.move-position-btn[data-col]').forEach(btn => {
    if (btn.tagName === 'BUTTON') {
      btn.addEventListener('click', () => {
        const targetCol = parseInt(btn.dataset.col);
        const targetPos = parseInt(btn.dataset.pos);
        moveCardToPosition(cardToMove, targetCol, targetPos);
        closeMoveMenu();
      });
    }
  });
  
  document.getElementById('moveOverlay').classList.remove('hidden');
}

function openMoveMenu(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) showMoveMenu(card);
}

function closeMoveMenu() {
  document.getElementById('moveOverlay').classList.add('hidden');
  cardToMove = null;
}

// Déplacer une carte vers une colonne à une position spécifique
function moveCardToPosition(card, targetColIndex, position) {
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[targetColIndex];
  const cardId = card.dataset.cardId;
  const currentColIndex = cardsData[cardId]?.columnIndex ?? -1;
  
  if (targetCol) {
    // Cibler le col-content pour l'insertion
    const targetContent = targetCol.querySelector('.col-content') || targetCol;
    const cardsInTarget = targetContent.querySelectorAll('.mcard');
    
    // Position 1 = premier, position 2 = après la 1ère carte, etc.
    if (position <= 1 || cardsInTarget.length === 0) {
      targetContent.insertBefore(card, cardsInTarget[0] || null);
    } else if (position > cardsInTarget.length) {
      targetContent.appendChild(card);
    } else {
      targetContent.insertBefore(card, cardsInTarget[position - 1]);
    }
    
    // Tracking automatique
    const today = new Date().toISOString().split('T')[0];
    const deptMap = {0:'robot', 1:'degauchage', 2:'essayage', 3:'atelier', 4:'couture', 5:'peinture', 6:'expedition'};
    
    // Si on quitte une colonne de département (0-6), marquer la sortie
    if (currentColIndex >= 0 && currentColIndex <= 6 && currentColIndex !== targetColIndex) {
      const deptKey = deptMap[currentColIndex];
      if (deptKey && cardsData[cardId]) {
        if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
        if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
        if (cardsData[cardId].tracking[deptKey].entree && !cardsData[cardId].tracking[deptKey].sortie) {
          cardsData[cardId].tracking[deptKey].sortie = today;
        }
      }
    }
    
    // Si on entre dans une colonne de département (0-6), marquer l'entrée
    if (targetColIndex >= 0 && targetColIndex <= 6) {
      const deptKey = deptMap[targetColIndex];
      if (deptKey && cardsData[cardId]) {
        if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
        if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
        if (!cardsData[cardId].tracking[deptKey].entree) {
          cardsData[cardId].tracking[deptKey].entree = today;
        }
      }
    }
    
    // Mettre à jour cardsData et sauvegarder
    if (cardsData[cardId]) {
      cardsData[cardId].columnIndex = targetColIndex;
      saveCardToFirebase(cardId);
    }
    
    updateColumnCounts();
    showToast('Déplacé vers ' + COLUMNS[targetColIndex].name + ' position ' + position);
  }
}

// ===== FICHE MOULAGE =====
let currentExpandedCard = null;
let cardOverlay = null;
let currentCalendarField = null;
let currentCalendarDate = new Date();

function openFiche(card) {
  if (!card) return;
  
  // Si c'est un ID, trouver la carte
  if (typeof card === 'string') {
    card = document.querySelector(`.mcard[data-card-id="${card}"]`);
    if (!card) return;
  }
  
  const cardId = card.dataset.cardId;
  
  // Si meme carte, ne rien faire
  if (currentExpandedCard === card) return;
  
  // Fermer la fiche precedente
  if (currentExpandedCard) {
    const prevCardId = currentExpandedCard.dataset.cardId;
    if (prevCardId && cardsData[prevCardId]) saveCardToFirebase(prevCardId);
    currentExpandedCard.classList.remove('mcard-expanded');
    currentExpandedCard = null;
  }
  
  // S'assurer que l'overlay existe
  if (!cardOverlay) cardOverlay = document.getElementById('cardOverlay');
  
  // Generer la fiche si pas deja fait
  if (!card.querySelector('.mcard-fiche')) {
    card.insertAdjacentHTML('beforeend', generateFicheHTML(card));
    attachFicheEvents(card);
  }
  
  // Ouvrir la fiche
  card.classList.add('mcard-expanded');
  if (cardOverlay) cardOverlay.classList.add('active');
  currentExpandedCard = card;
}

function closeFiche() {
  if (currentExpandedCard) {
    const cardId = currentExpandedCard.dataset.cardId;
    if (cardId && cardsData[cardId]) saveCardToFirebase(cardId);
    currentExpandedCard.classList.remove('mcard-expanded');
    
    // Fermer tous les menus et popups
    currentExpandedCard.querySelector('.fiche-calendar-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.photos-menu-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.notes-photos-links-panel')?.style.setProperty('display', 'none');
  }
  
  // Fermer les menus globaux
  document.getElementById('priorityMenu')?.remove();
  document.getElementById('delaiMenu')?.remove();
  document.getElementById('raisonAttenteMenu')?.remove();
  document.getElementById('trackingDatesMenu')?.remove();
  document.getElementById('fichePriorityMenu')?.remove();
  
  if (cardOverlay) cardOverlay.classList.remove('active');
  currentExpandedCard = null;
}

function generateFicheHTML(card) {
  const cardId = card.dataset.cardId;
  const data = cardsData[cardId] || {};
  
  const joursAttente = calcJoursAttente(data.dateAttente);
  const isEnAttente = data.columnIndex === 7;
  
  // Nom et numéro de commande: verrouillés si déjà remplis
  const nameLocked = data.name && data.name.trim() !== '';
  const orderLocked = data.order && data.order.trim() !== '';
  
  // Priorité
  const priorityLabels = {
    0: { text: '-- Aucune --', color: '#6b7280', emoji: '&#9898;' },
    1: { text: '#1 URGENT', color: '#ef4444', emoji: '&#128308;' },
    2: { text: '#2 Important', color: '#f97316', emoji: '&#128992;' },
    3: { text: '#3 À surveiller', color: '#eab308', emoji: '&#128993;' },
    4: { text: '#4 Normal+', color: '#22c55e', emoji: '&#128994;' },
    5: { text: '#5 Basse', color: '#3b82f6', emoji: '&#128309;' }
  };
  const currentPriority = data.priority || 0;
  const priorityInfo = priorityLabels[currentPriority] || priorityLabels[0];
  
  // Sidebar tracking
  const trackingHTML = generateTrackingSidebar(cardId, data);
  
  return `
    ${trackingHTML}
    <div class="mcard-fiche" data-card-id="${cardId}">
      <div class="fiche-header">
        <div class="fiche-logo"><img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro1.png" alt="Physipro"/></div>
        <div class="fiche-title"><h3>Fiche Moulage</h3></div>
        <div class="fiche-priority-btn" onclick="showFichePriorityMenu('${cardId}', event)" style="background: ${priorityInfo.color};">
          <span class="fiche-priority-emoji">${priorityInfo.emoji}</span>
          <span class="fiche-priority-text">Priorité</span>
        </div>
      </div>
      
      <div class="fiche-section">
        <div class="fiche-grid-2">
          <div class="fiche-field">
            <div class="fiche-label">Client <button class="list-manage-btn" onclick="openListManager('moulageClients', 'Client')">&#9881;</button></div>
            <select class="fiche-select" data-fiche-field="client">
              ${generateSelectOptions('moulageClients', data.client)}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Nom du moulage ${nameLocked ? '🔒' : ''}</div>
            <input type="text" class="fiche-input ${nameLocked ? 'locked' : ''}" data-fiche-field="name" value="${data.name || ''}" placeholder="Nom..." ${nameLocked ? 'readonly' : ''}>
          </div>
        </div>
        
        <div class="fiche-grid-3" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">N&#176; Soumission</div>
            <input type="text" class="fiche-input" data-fiche-field="numeroSoumission" value="${data.numeroSoumission || ''}" placeholder="Numéro...">
          </div>
          <div class="fiche-field">
            <div class="fiche-label">N&#176; PO</div>
            <input type="text" class="fiche-input" data-fiche-field="numeroPO" value="${data.numeroPO || ''}" placeholder="Numéro...">
          </div>
          <div class="fiche-field">
            <div class="fiche-label">N&#176; Commande ${orderLocked ? '🔒' : ''}</div>
            <input type="text" class="fiche-input ${orderLocked ? 'locked' : ''}" data-fiche-field="order" value="${data.order || ''}" placeholder="000000" maxlength="6" ${orderLocked ? 'readonly' : ''}>
          </div>
        </div>
        
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Région <button class="list-manage-btn" onclick="openListManager('regions', 'Région')">&#9881;</button></div>
            <select class="fiche-select" data-fiche-field="region">
              ${generateSelectOptions('regions', data.region)}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Intervenant <button class="list-manage-btn" onclick="openListManager('intervenants', 'Intervenant')">&#9881;</button></div>
            <select class="fiche-select" data-fiche-field="intervenant">
              ${generateSelectOptions('intervenants', data.intervenant)}
            </select>
          </div>
        </div>
        
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Représentante <button class="list-manage-btn" onclick="openListManager('representantes', 'Représentante')">&#9881;</button></div>
            <select class="fiche-select" data-fiche-field="representant">
              ${generateSelectOptions('representantes', data.representant)}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date RDV essayage</div>
            <div class="fiche-date-pill" data-fiche-field="dateEssayage" onclick="openCalendar('${cardId}', 'dateEssayage', this)">${data.dateEssayage || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
        
        <div class="fiche-grid-3" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Date reçue</div>
            <div class="fiche-date-pill" data-fiche-field="dateRecue" onclick="openCalendar('${cardId}', 'dateRecue', this)">${data.dateRecue || 'AAAA-MM-JJ'}</div>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date fabriquée robot</div>
            <div class="fiche-date-pill" data-fiche-field="dateRobot" onclick="openCalendar('${cardId}', 'dateRobot', this)">${data.dateRobot || 'AAAA-MM-JJ'}</div>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">&#128230; Date livraison</div>
            <div class="fiche-date-pill" data-fiche-field="dateLivraison" onclick="openCalendar('${cardId}', 'dateLivraison', this)">${data.dateLivraison || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
      </div>
      
      <div class="fiche-attente-section ${isEnAttente ? 'visible' : ''}">
        <div class="attente-badge-full">&#9203; EN ATTENTE: ${data.raisonAttente || 'Raison non specifiee'}</div>
        <div class="attente-days-full">En attente depuis ${data.dateAttente || '---'} (${joursAttente} jours)</div>
      </div>
      
      <div class="fiche-photos-section">
        <div class="photos-row">
          <span class="photos-label" onclick="togglePhotosMenu('${cardId}')" style="cursor:pointer;"><span class="camera-icon">&#128247;</span> Liens</span>
          <button class="photo-btn ${data.photoClient ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'Client', event)">Client</button>
          <button class="photo-btn ${data.photoAtelier ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'Atelier', event)">Atelier</button>
          <button class="photo-btn ${data.photoDevis ? 'has-link blink-green-photo' : ''}" onclick="openPhotoFromPill('${cardId}', 'Devis', event)">Devis/Modif</button>
        </div>
      </div>
      
      <!-- Menu Photos popup -->
      <div class="photos-menu-popup" id="photosMenuPopup_${cardId}">
        <div class="photos-menu-header">&#128247; Gérer les liens photos</div>
        <div class="photos-menu-field">
          <label>Client:</label>
          <input type="url" id="photoLinkClient_${cardId}" value="${data.photoClient || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Atelier:</label>
          <input type="url" id="photoLinkAtelier_${cardId}" value="${data.photoAtelier || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Devis/Modif:</label>
          <input type="url" id="photoLinkDevis_${cardId}" value="${data.photoDevis || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-btns">
          <button onclick="saveAllPhotoLinks('${cardId}')">&#128190; Enregistrer</button>
          <button onclick="closePhotosMenu('${cardId}')">Fermer</button>
        </div>
      </div>
      
      <div class="fiche-calendar-popup">
        <div class="cal-header"><div class="cal-title">Sélectionner une date</div></div>
        <div class="cal-nav">
          <button class="cal-prev" onclick="navigateCalendar(-1)">&#9664;</button>
          <span class="cal-month-year"></span>
          <button class="cal-next" onclick="navigateCalendar(1)">&#9654;</button>
        </div>
        <div class="cal-weekdays">
          <div class="cal-weekday">Dim</div><div class="cal-weekday">Lun</div><div class="cal-weekday">Mar</div>
          <div class="cal-weekday">Mer</div><div class="cal-weekday">Jeu</div><div class="cal-weekday">Ven</div><div class="cal-weekday">Sam</div>
        </div>
        <div class="cal-days"></div>
        <div class="cal-buttons">
          <button class="btn-today" onclick="selectToday()">Aujourd'hui</button>
          <button class="btn-close-cal" onclick="closeCalendar()">Fermer</button>
        </div>
      </div>
    </div>
    
    <div class="mcard-notes-page" data-card-id="${cardId}">
      <div class="notes-page-header">
        <span class="notes-header-left" onclick="toggleNotesPhotosPanel('${cardId}')" title="Gérer les liens photos"><span class="camera-icon">&#128247;</span> Liens</span>
        <span class="notes-header-center">&#128221; Notes</span>
        <button class="notes-close-btn" onclick="closeFiche()" title="Fermer">&#10005;</button>
      </div>
      
      <!-- Panneau liens photos (cache par defaut) -->
      <div class="notes-photos-links-panel" id="notesPhotosPanel_${cardId}">
        <div class="notes-photo-link-row">
          <label>Photo 1:</label>
          <input type="url" id="notePhotoLink1_${cardId}" value="${data.notePhoto1 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 2:</label>
          <input type="url" id="notePhotoLink2_${cardId}" value="${data.notePhoto2 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 3:</label>
          <input type="url" id="notePhotoLink3_${cardId}" value="${data.notePhoto3 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 4:</label>
          <input type="url" id="notePhotoLink4_${cardId}" value="${data.notePhoto4 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 5:</label>
          <input type="url" id="notePhotoLink5_${cardId}" value="${data.notePhoto5 || ''}" placeholder="https://...">
        </div>
        <div class="notes-photo-link-row">
          <label>Photo 6:</label>
          <input type="url" id="notePhotoLink6_${cardId}" value="${data.notePhoto6 || ''}" placeholder="https://...">
        </div>
        <button class="notes-save-photos-btn" onclick="saveNotesPhotoLinks('${cardId}')">&#128190; Enregistrer les liens</button>
      </div>
      
      <div class="notes-photos-row">
        <button class="notes-photo-btn ${data.notePhoto1 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 1)">Photo 1</button>
        <button class="notes-photo-btn ${data.notePhoto2 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 2)">Photo 2</button>
        <button class="notes-photo-btn ${data.notePhoto3 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 3)">Photo 3</button>
        <button class="notes-photo-btn ${data.notePhoto4 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 4)">Photo 4</button>
        <button class="notes-photo-btn ${data.notePhoto5 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 5)">Photo 5</button>
        <button class="notes-photo-btn ${data.notePhoto6 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 6)">Photo 6</button>
      </div>
      <textarea class="notes-page-textarea" id="notesTextarea_${cardId}" 
        placeholder="Cliquez ici pour écrire..."
        onfocus="prepareNoteWithSignature('${cardId}')"
        onblur="saveMoulageNotes('${cardId}')">${data.notes || ''}</textarea>
    </div>
  `;
}

function generateTrackingSidebar(cardId, data) {
  const depts = [
    { key: 'robot', name: 'Robot', icon: '&#9881;' },
    { key: 'degauchage', name: 'Dégauchage', icon: '&#128736;' },
    { key: 'essayage', name: 'Essayage', icon: '&#128090;' },
    { key: 'atelier', name: 'Atelier', icon: '&#128295;' },
    { key: 'couture', name: 'Couture', icon: '&#129697;' },
    { key: 'peinture', name: 'Peinture', icon: '&#127912;' },
    { key: 'expedition', name: 'Expédition', icon: '&#128230;' }
  ];
  
  const tracking = data.tracking || {};
  const currentDept = getDeptFromColumn(data.columnIndex);
  
  let html = '<div class="mcard-tracking-sidebar"><div class="tracking-sidebar-title">Suivi</div><div class="tracking-pills-container">';
  
  depts.forEach(dept => {
    const deptData = tracking[dept.key] || {};
    const isActive = dept.key === currentDept;
    const isCompleted = deptData.entree && deptData.sortie;
    const jours = isCompleted ? calcJoursOuvrables(deptData.entree, deptData.sortie) : (deptData.entree ? calcJoursOuvrables(deptData.entree, new Date().toISOString().split('T')[0]) : '-');
    
    let pillClass = 'tracking-dept-pill';
    if (isActive) pillClass += ' active';
    if (isCompleted) pillClass += ' completed';
    
    html += `
      <div class="${pillClass}" onclick="openTrackingDatesMenu('${cardId}', '${dept.key}', '${dept.icon} ${dept.name}', event)" style="cursor:pointer;">
        <span class="tracking-pill-icon">${dept.icon}</span>
        <span class="tracking-pill-name">${dept.name}</span>
        <span class="tracking-pill-jours">${jours}</span>
      </div>
    `;
  });
  
  html += '</div></div>';
  return html;
}

function getDeptFromColumn(colIndex) {
  const map = { 0: 'robot', 1: 'degauchage', 2: 'essayage', 3: 'atelier', 4: 'couture', 5: 'peinture', 6: 'expedition' };
  return map[colIndex] || null;
}

function calcJoursOuvrables(dateDebut, dateFin) {
  if (!dateDebut || !dateFin) return 0;
  const debut = new Date(dateDebut + 'T00:00:00');
  const fin = new Date(dateFin + 'T00:00:00');
  if (isNaN(debut.getTime()) || isNaN(fin.getTime())) return 0;
  return compterJoursOuvrables(debut, fin);
}

function calcJoursAttente(dateAttente) {
  if (!dateAttente) return 0;
  const debut = new Date(dateAttente + 'T00:00:00');
  const fin = new Date();
  fin.setHours(0, 0, 0, 0);
  if (isNaN(debut.getTime())) return 0;
  return Math.floor((fin - debut) / (1000 * 60 * 60 * 24));
}

function attachFicheEvents(card) {
  const cardId = card.dataset.cardId;
  
  // Inputs et selects
  card.querySelectorAll('.fiche-input, .fiche-select').forEach(el => {
    el.addEventListener('change', () => {
      const field = el.dataset.ficheField;
      if (field && cardsData[cardId]) {
        cardsData[cardId][field] = el.value;
        
        // Si region change, mettre a jour la carte
        if (field === 'region') {
          card.classList.remove('region-qc', 'region-on', 'region-ma');
          if (el.value === 'Quebec') card.classList.add('region-qc');
          else if (el.value === 'Ontario') card.classList.add('region-on');
          else if (el.value === 'Maritime') card.classList.add('region-ma');
        }
        
        // Si nom change, mettre a jour le titre
        if (field === 'name') {
          const titleInput = card.querySelector('.mcard-title');
          if (titleInput) titleInput.value = el.value;
        }
        
        // Si order change, mettre a jour le numero
        if (field === 'order') {
          const orderInput = card.querySelector('.mcard-order');
          if (orderInput) orderInput.value = el.value;
        }
        
        saveCardToFirebase(cardId);
      }
    });
  });
}

// Calendrier
let currentCalendarCardId = null;
let currentCalendarElement = null;

function openCalendar(cardId, field, element) {
  currentCalendarCardId = cardId;
  currentCalendarField = field;
  currentCalendarElement = element;
  
  const currentValue = cardsData[cardId]?.[field];
  if (currentValue && currentValue !== 'AAAA-MM-JJ') {
    currentCalendarDate = new Date(currentValue + 'T00:00:00');
  } else {
    currentCalendarDate = new Date();
  }
  
  const card = element.closest('.mcard');
  const popup = card.querySelector('.fiche-calendar-popup');
  if (popup) {
    renderTableCalendar(popup);
    popup.classList.add('active');
  }
}

function closeCalendar() {
  if (currentExpandedCard) {
    currentExpandedCard.querySelector('.fiche-calendar-popup')?.classList.remove('active');
  }
  currentCalendarCardId = null;
  currentCalendarField = null;
  currentCalendarElement = null;
}

function renderTableCalendar(popup) {
  const monthYear = popup.querySelector('.cal-month-year');
  const daysContainer = popup.querySelector('.cal-days');
  
  const months = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];
  monthYear.textContent = months[currentCalendarDate.getMonth()] + ' ' + currentCalendarDate.getFullYear();
  
  const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
  const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let html = '';
  
  // Jours du mois precedent
  for (let i = 0; i < firstDay.getDay(); i++) {
    const d = new Date(firstDay);
    d.setDate(d.getDate() - (firstDay.getDay() - i));
    html += `<button class="cal-day other-month" onclick="selectDate(${d.getFullYear()}, ${d.getMonth()}, ${d.getDate()})">${d.getDate()}</button>`;
  }
  
  // Jours du mois
  for (let d = 1; d <= lastDay.getDate(); d++) {
    const date = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), d);
    let classes = 'cal-day';
    if (date.getTime() === today.getTime()) classes += ' today';
    html += `<button class="${classes}" onclick="selectDate(${date.getFullYear()}, ${date.getMonth()}, ${d})">${d}</button>`;
  }
  
  daysContainer.innerHTML = html;
}

function navigateCalendar(direction) {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
  if (currentExpandedCard) {
    const popup = currentExpandedCard.querySelector('.fiche-calendar-popup');
    if (popup) renderTableCalendar(popup);
  }
}

function selectDate(year, month, day) {
  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  
  if (currentCalendarCardId && currentCalendarField && cardsData[currentCalendarCardId]) {
    cardsData[currentCalendarCardId][currentCalendarField] = dateStr;
    saveCardToFirebase(currentCalendarCardId);
    
    if (currentCalendarElement) {
      currentCalendarElement.textContent = dateStr;
    }
  }
  
  closeCalendar();
}

function selectToday() {
  const today = new Date();
  selectDate(today.getFullYear(), today.getMonth(), today.getDate());
}

// Photos
function openPhotoLink(cardId, field) {
  const currentUrl = cardsData[cardId]?.[field] || '';
  if (currentUrl) {
    window.open(currentUrl, '_blank');
  } else {
    const newUrl = prompt('Entrer le lien pour ' + field + ':', '');
    if (newUrl) {
      cardsData[cardId][field] = newUrl;
      saveCardToFirebase(cardId);
      // Mettre a jour le bouton
      const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
      if (card) {
        const btn = card.querySelector(`.photo-btn[onclick*="${field}"]`);
        if (btn) btn.classList.add('has-link');
      }
    }
  }
}

// ===== MENU PHOTOS FICHE =====
function togglePhotosMenu(cardId) {
  const popup = document.getElementById('photosMenuPopup_' + cardId);
  if (popup) {
    popup.classList.toggle('active');
  }
}

function closePhotosMenu(cardId) {
  const popup = document.getElementById('photosMenuPopup_' + cardId);
  if (popup) {
    popup.classList.remove('active');
  }
}

function saveAllPhotoLinks(cardId) {
  if (!cardsData[cardId]) return;
  
  const photoClient = document.getElementById('photoLinkClient_' + cardId)?.value || '';
  const photoAtelier = document.getElementById('photoLinkAtelier_' + cardId)?.value || '';
  const photoDevis = document.getElementById('photoLinkDevis_' + cardId)?.value || '';
  
  cardsData[cardId].photoClient = photoClient;
  cardsData[cardId].photoAtelier = photoAtelier;
  cardsData[cardId].photoDevis = photoDevis;
  
  saveCardToFirebase(cardId);
  
  // Mettre a jour les boutons
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    const btns = card.querySelectorAll('.photo-btn');
    btns.forEach(btn => {
      const onclick = btn.getAttribute('onclick') || '';
      if (onclick.includes('Client')) btn.classList.toggle('has-link', !!photoClient);
      if (onclick.includes('Atelier')) btn.classList.toggle('has-link', !!photoAtelier);
      if (onclick.includes('Devis')) btn.classList.toggle('has-link', !!photoDevis);
    });
  }
  
  closePhotosMenu(cardId);
  showToast('Liens photos enregistrés');
}

function openPhotoFromPill(cardId, photoType, event) {
  if (event) event.stopPropagation();
  
  const fieldName = 'photo' + photoType;
  const url = cardsData[cardId]?.[fieldName];
  
  if (url) {
    window.open(url, '_blank');
  } else {
    // Ouvrir le menu photos pour entrer le lien
    togglePhotosMenu(cardId);
  }
}

// ===== PANNEAU PHOTOS NOTES =====
function toggleNotesPhotosPanel(cardId) {
  const panel = document.getElementById('notesPhotosPanel_' + cardId);
  if (panel) {
    panel.classList.toggle('active');
  }
}

function saveNotesPhotoLinks(cardId) {
  if (!cardsData[cardId]) return;
  
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('notePhotoLink' + i + '_' + cardId);
    if (input) {
      cardsData[cardId]['notePhoto' + i] = input.value || '';
    }
  }
  
  saveCardToFirebase(cardId);
  
  // Mettre a jour les boutons
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    const btns = card.querySelectorAll('.notes-photo-btn');
    btns.forEach((btn, idx) => {
      const hasLink = !!cardsData[cardId]['notePhoto' + (idx + 1)];
      btn.classList.toggle('has-link', hasLink);
    });
  }
  
  toggleNotesPhotosPanel(cardId);
  showToast('Liens photos notes enregistrés');
}

function openNotePhoto(cardId, photoNum) {
  const fieldName = 'notePhoto' + photoNum;
  const url = cardsData[cardId]?.[fieldName] || '';
  
  if (url) {
    window.open(url, '_blank');
  } else {
    // Ouvrir le panneau pour entrer les liens
    toggleNotesPhotosPanel(cardId);
  }
}

// ===== SIGNATURE NOTES =====
function getCurrentUserName() {
  return currentUser?.name || 'Utilisateur';
}

function isRepresentante() {
  const name = getCurrentUserName();
  const reps = ['Marie-Soleil', 'Marie-Pier', 'Multipass', 'Fabrys'];
  return reps.some(r => name.toLowerCase().includes(r.toLowerCase()));
}

function prepareNoteWithSignature(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  let currentText = textarea.value;
  
  // Si representante et premiere visite, ajouter "Note vue par..."
  if (isRepresentante()) {
    const viewedMarker = 'Note vue par ' + userName;
    if (!currentText.includes(viewedMarker)) {
      const viewedLine = `*** ${viewedMarker} (${dateStr} a ${timeStr}) ***`;
      if (currentText.trim()) {
        currentText = currentText.trimEnd() + '\n\n' + viewedLine + '\n';
      } else {
        currentText = viewedLine + '\n';
      }
      textarea.value = currentText;
      // Marquer comme lu
      markNoteAsRead(cardId);
    }
  }
  
  // Ajouter signature normale
  const signature = '-- ' + userName + ' (' + dateStr + ' a ' + timeStr + ') --';
  
  // Verifier si la derniere signature est la meme (meme minute)
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('-- ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    const match = lastSignatureLine.match(/-- .+ \((\d{4}-\d{2}-\d{2}) a (\d{2}:\d{2})\) --/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  // Placer le curseur a la fin
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

function markNoteAsRead(cardId) {
  if (!cardsData[cardId]) return;
  
  const currentUser = getCurrentUserName();
  
  if (!cardsData[cardId].notesUnread) {
    cardsData[cardId].notesUnread = {};
  }
  cardsData[cardId].notesUnread[currentUser] = false;
  saveCardToFirebase(cardId);
}

// Notes
function saveMoulageNotes(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (textarea && cardsData[cardId]) {
    cardsData[cardId].notes = textarea.value;
    saveCardToFirebase(cardId);
  }
}

// ===== MENU TRACKING DATES =====
function formatDateFull(dateStr) {
  if (!dateStr) return 'Cliquer pour définir';
  const d = new Date(dateStr);
  const day = d.getDate().toString().padStart(2, '0');
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  const year = d.getFullYear();
  return day + '/' + month + '/' + year;
}

function openTrackingDatesMenu(cardId, deptKey, deptName, event) {
  event.stopPropagation();
  
  // Fermer tout menu existant
  document.getElementById('trackingDatesMenu')?.remove();
  
  const data = cardsData[cardId] || {};
  const tracking = data.tracking?.[deptKey] || {};
  const entree = tracking.entree || '';
  const sortie = tracking.sortie || '';
  
  const entreeDisplay = entree ? formatDateFull(entree) : 'Cliquer pour définir';
  const sortieDisplay = sortie ? formatDateFull(sortie) : 'Cliquer pour définir';
  
  const menu = document.createElement('div');
  menu.id = 'trackingDatesMenu';
  menu.className = 'tracking-dates-menu';
  
  menu.innerHTML = 
    '<div class="tracking-menu-header">' + deptName + '</div>' +
    '<div class="tracking-menu-row">' +
      '<span class="tracking-menu-label">Entree:</span>' +
      '<span class="tracking-menu-date" onclick="setTrackingDate(\'' + cardId + '\', \'' + deptKey + '\', \'entree\')">' + entreeDisplay + '</span>' +
    '</div>' +
    '<div class="tracking-menu-row">' +
      '<span class="tracking-menu-label">Sortie:</span>' +
      '<span class="tracking-menu-date" onclick="setTrackingDate(\'' + cardId + '\', \'' + deptKey + '\', \'sortie\')">' + sortieDisplay + '</span>' +
    '</div>' +
    '<div class="tracking-menu-footer">' +
      '<button onclick="document.getElementById(\'trackingDatesMenu\')?.remove()">Fermer</button>' +
    '</div>';
  
  document.body.appendChild(menu);
  
  // Mesurer la hauteur reelle du menu
  const menuHeight = menu.offsetHeight || 150;
  const menuWidth = menu.offsetWidth || 200;
  
  // Trouver la sidebar tracking pour positionner a droite
  const sidebar = event.target.closest('.mcard-tracking-sidebar');
  const sidebarRect = sidebar ? sidebar.getBoundingClientRect() : null;
  const pillRect = event.target.closest('.tracking-dept-pill').getBoundingClientRect();
  
  // Position horizontale: a droite de la sidebar
  let leftPos;
  if (sidebarRect) {
    leftPos = sidebarRect.right + 5;
  } else {
    leftPos = pillRect.right + 10;
  }
  
  // Si depasse a droite, mettre a gauche
  if (leftPos + menuWidth > window.innerWidth - 10) {
    leftPos = Math.max(10, pillRect.left - menuWidth - 10);
  }
  
  // Position verticale: centrer sur la pastille, mais TOUJOURS rester dans l'ecran
  const pillCenterY = pillRect.top + (pillRect.height / 2);
  let topPos = pillCenterY - (menuHeight / 2);
  
  // S'assurer que le menu reste TOUJOURS visible
  const minTop = 50; // Marge du haut
  const maxTop = window.innerHeight - menuHeight - 20; // Marge du bas
  
  if (topPos < minTop) {
    topPos = minTop;
  }
  if (topPos > maxTop) {
    topPos = maxTop;
  }
  
  menu.style.left = leftPos + 'px';
  menu.style.top = topPos + 'px';
}

function setTrackingDate(cardId, deptKey, dateType) {
  const today = new Date().toISOString().split('T')[0];
  const currentDate = cardsData[cardId]?.tracking?.[deptKey]?.[dateType];
  
  const newDate = prompt('Entrer la date (' + dateType + '):\nFormat: AAAA-MM-JJ\n\nLaisser vide pour aujourdhui', currentDate || today);
  
  if (newDate !== null) {
    if (!cardsData[cardId].tracking) cardsData[cardId].tracking = {};
    if (!cardsData[cardId].tracking[deptKey]) cardsData[cardId].tracking[deptKey] = {};
    
    cardsData[cardId].tracking[deptKey][dateType] = newDate || today;
    saveCardToFirebase(cardId);
    
    // Fermer le menu et rafraichir la fiche
    document.getElementById('trackingDatesMenu')?.remove();
    
    // Mettre a jour l'affichage dans le menu si encore ouvert
    const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
    if (card && card.classList.contains('mcard-expanded')) {
      // Regenerer la sidebar tracking
      const sidebar = card.querySelector('.mcard-tracking-sidebar');
      if (sidebar) {
        const newSidebar = document.createElement('div');
        newSidebar.innerHTML = generateTrackingSidebar(cardId, cardsData[cardId]);
        sidebar.replaceWith(newSidebar.firstElementChild);
      }
    }
    
    showToast('Date ' + dateType + ' mise a jour');
  }
}

// ===== GESTION DES LISTES PERSONNALISABLES =====

function loadCustomLists() {
  const listsRef = firebaseDb.ref('customLists');
  listsRef.once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      for (const key in data) {
        if (Array.isArray(data[key])) {
          customLists[key] = data[key];
          // Trier alphabetiquement
          customLists[key].sort((a, b) => a.localeCompare(b, 'fr'));
        }
      }
      console.log('Listes chargees depuis Firebase');
    }
  }).catch(err => {
    console.error('Erreur chargement listes:', err);
  });
}

function saveCustomLists() {
  return new Promise((resolve, reject) => {
    firebaseDb.ref('customLists').set(customLists)
      .then(() => {
        console.log('Listes sauvegardees');
        resolve();
      })
      .catch(err => {
        console.error('Erreur sauvegarde listes:', err);
        reject(err);
      });
  });
}

function openListManager(listKey, title) {
  currentListKey = listKey;
  currentListTitle = title;
  
  const overlay = document.getElementById('listManagerOverlay');
  const titleEl = document.getElementById('listManagerTitle');
  const inputEl = document.getElementById('listManagerNewItem');
  
  titleEl.innerHTML = '&#9881; Gérer les ' + title + 's';
  inputEl.value = '';
  
  renderListItems();
  overlay.classList.remove('hidden');
}

function renderListItems() {
  const itemsEl = document.getElementById('listManagerItems');
  const list = customLists[currentListKey] || [];
  
  // Si plus de 8 items, afficher sur 2 colonnes
  if (list.length > 8) {
    itemsEl.style.display = 'grid';
    itemsEl.style.gridTemplateColumns = '1fr 1fr';
    itemsEl.style.gap = '8px';
  } else {
    itemsEl.style.display = 'flex';
    itemsEl.style.flexDirection = 'column';
    itemsEl.style.gap = '8px';
  }
  
  if (list.length === 0) {
    itemsEl.innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.5);font-size:13px;">Aucune valeur dans cette liste.<br>Ajoutez-en une ci-dessous!</div>';
    return;
  }
  
  itemsEl.innerHTML = list.map((item, index) => 
    '<div class="list-manager-item" data-index="' + index + '">' +
      '<span class="item-index">#' + (index + 1) + '</span>' +
      '<span class="item-name">' + item + '</span>' +
      '<button class="btn-remove-item" onclick="removeListItem(' + index + ')" title="Supprimer">&#10005;</button>' +
    '</div>'
  ).join('');
}

function addListItem() {
  const inputEl = document.getElementById('listManagerNewItem');
  const value = inputEl.value.trim();
  
  if (!value) {
    showListToast('&#10060; Veuillez entrer une valeur', false);
    return;
  }
  
  if (!customLists[currentListKey]) {
    customLists[currentListKey] = [];
  }
  
  // Verifier si deja existant
  if (customLists[currentListKey].includes(value)) {
    showListToast('&#9888; Cette valeur existe déjà!', false);
    return;
  }
  
  // Ajouter et trier alphabetiquement
  customLists[currentListKey].push(value);
  customLists[currentListKey].sort((a, b) => a.localeCompare(b, 'fr'));
  
  inputEl.value = '';
  renderListItems();
  
  // Effet visuel sur l'element ajoute
  const newIndex = customLists[currentListKey].indexOf(value);
  const items = document.querySelectorAll('.list-manager-item');
  if (items[newIndex]) {
    items[newIndex].classList.add('just-added');
    // Scroll vers l'element ajoute
    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  // Afficher le toast IMMEDIATEMENT
  showListToast('&#10004; "' + value + '" AJOUTÉ!', true);
  
  // Sauvegarder en arriere-plan
  saveCustomLists().then(() => {
    updateAllSelectsFromLists();
  });
  
  inputEl.focus();
}

function removeListItem(index) {
  if (!customLists[currentListKey]) return;
  
  const item = customLists[currentListKey][index];
  if (confirm('Supprimer "' + item + '" de la liste?')) {
    // Animation
    const items = document.querySelectorAll('.list-manager-item');
    if (items[index]) {
      items[index].classList.add('just-removed');
    }
    
    setTimeout(() => {
      customLists[currentListKey].splice(index, 1);
      renderListItems();
      
      // Afficher le toast IMMEDIATEMENT
      showListToast('&#128465; "' + item + '" SUPPRIMÉ!', false);
      
      // Sauvegarder en arriere-plan
      saveCustomLists().then(() => {
        updateAllSelectsFromLists();
      });
    }, 300);
  }
}

function closeListManager() {
  const overlay = document.getElementById('listManagerOverlay');
  if (overlay) {
    overlay.classList.add('hidden');
  }
  // Forcer la mise a jour des selects a la fermeture
  if (currentListKey) {
    updateAllSelectsFromLists();
  }
}

// Mettre a jour tous les selects ouverts avec les nouvelles listes
function updateAllSelectsFromLists() {
  // Mapping champ -> liste
  const fieldToList = {
    'client': 'moulageClients',
    'region': 'regions',
    'intervenant': 'intervenants',
    'representant': 'representantes'
  };
  
  // Fonction pour mettre a jour les selects d'une carte
  function updateCardSelects(card) {
    if (!card) return;
    const cardId = card.dataset.cardId;
    const data = cardsData[cardId] || {};
    
    card.querySelectorAll('.fiche-select[data-fiche-field]').forEach(select => {
      const field = select.dataset.ficheField;
      const listKey = fieldToList[field];
      
      if (listKey && customLists[listKey]) {
        const currentValue = select.value || data[field] || '';
        select.innerHTML = generateSelectOptions(listKey, currentValue);
      }
    });
  }
  
  // Chercher TOUTES les fiches ouvertes par classe
  document.querySelectorAll('.mcard.mcard-expanded').forEach(updateCardSelects);
  
  // Aussi utiliser currentExpandedCard directement (au cas ou)
  if (currentExpandedCard) {
    updateCardSelects(currentExpandedCard);
  }
}

// Afficher un toast de confirmation pour les listes (TRES VISIBLE)
function showListToast(message, isSuccess = true) {
  // Supprimer les toasts existants
  document.querySelectorAll('.list-toast').forEach(t => t.remove());
  
  const toast = document.createElement('div');
  toast.className = 'list-toast';
  
  // Couleur de fond
  const bgColor = isSuccess ? '#22c55e' : '#ef4444';
  
  // Style inline DIRECT - pas d'animation
  toast.style.cssText = `
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    padding: 40px 80px !important;
    border-radius: 20px !important;
    font-size: 28px !important;
    font-weight: 900 !important;
    color: white !important;
    z-index: 9999999 !important;
    text-align: center !important;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8) !important;
    border: 5px solid white !important;
    min-width: 400px !important;
    background: ${bgColor} !important;
    opacity: 1 !important;
    visibility: visible !important;
  `;
  
  toast.innerHTML = message;
  document.body.appendChild(toast);
  
  // Disparaitre apres 5 secondes
  setTimeout(() => {
    toast.remove();
  }, 5000);
}

// Generer les options d'un select a partir d'une liste
function generateSelectOptions(listKey, selectedValue) {
  const list = customLists[listKey] || [];
  let html = '<option value="">-- Sélectionner --</option>';
  list.forEach(item => {
    const selected = (item === selectedValue) ? 'selected' : '';
    html += '<option value="' + item + '" ' + selected + '>' + item + '</option>';
  });
  return html;
}

// Menu priorite fiche
function showFichePriorityMenu(cardId, event) {
  event.stopPropagation();
  document.querySelector('.fiche-priority-menu')?.remove();
  
  const menu = document.createElement('div');
  menu.className = 'fiche-priority-menu';
  menu.style.cssText = 'position:fixed;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.25);z-index:10001;min-width:180px;';
  menu.innerHTML = `
    <div class="fiche-priority-menu-item" data-priority="0" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#6b7280;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">-</div>Aucune
    </div>
    <div class="fiche-priority-menu-item" data-priority="1" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#ef4444;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">1</div>#1 URGENT
    </div>
    <div class="fiche-priority-menu-item" data-priority="2" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#f97316;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">2</div>#2 Important
    </div>
    <div class="fiche-priority-menu-item" data-priority="3" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#eab308;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">3</div>#3 À surveiller
    </div>
    <div class="fiche-priority-menu-item" data-priority="4" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;border-bottom:1px solid #f1f5f9;">
      <div style="width:16px;height:16px;border-radius:50%;background:#22c55e;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">4</div>#4 Normal+
    </div>
    <div class="fiche-priority-menu-item" data-priority="5" style="display:flex;align-items:center;gap:10px;padding:10px 15px;cursor:pointer;font-size:12px;color:#333;">
      <div style="width:16px;height:16px;border-radius:50%;background:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;">5</div>#5 Basse
    </div>
  `;
  
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';
  document.body.appendChild(menu);
  
  menu.querySelectorAll('.fiche-priority-menu-item').forEach(item => {
    item.addEventListener('mouseover', () => item.style.background = '#f1f5f9');
    item.addEventListener('mouseout', () => item.style.background = '');
    item.addEventListener('click', () => {
      const priority = parseInt(item.dataset.priority);
      if (cardsData[cardId]) {
        cardsData[cardId].priority = priority;
        saveCardToFirebase(cardId);
        refreshAllPriorities();
        
        // Mettre a jour le bouton priorite dans la fiche
        const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        if (card) {
          const btn = card.querySelector('.fiche-priority-btn');
          if (btn) {
            const colors = { 0: '#6b7280', 1: '#ef4444', 2: '#f97316', 3: '#eab308', 4: '#22c55e', 5: '#3b82f6' };
            btn.style.background = colors[priority];
          }
        }
      }
      menu.remove();
    });
  });
  
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    });
  }, 10);
}

// Utilitaires
function showToast(msg, err = false) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const toast = document.createElement('div');
  toast.className = 'toast' + (err ? ' error' : '');
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add('visible'), 10);
  setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, 2500);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  if (!initFirebase()) { showToast('Erreur Firebase', true); return; }
  
  loadSavedCredentials();
  
  loginBtn.addEventListener('click', attemptLogin);
  loginEmail.addEventListener('keydown', e => { if (e.key === 'Enter') loginPassword.focus(); });
  loginPassword.addEventListener('keydown', e => { if (e.key === 'Enter') attemptLogin(); });
  
  document.getElementById('btnSettings').addEventListener('click', () => document.getElementById('settingsOverlay').classList.remove('hidden'));
  document.getElementById('settingsCloseBtn').addEventListener('click', () => document.getElementById('settingsOverlay').classList.add('hidden'));
  document.getElementById('settingsOverlay').addEventListener('click', e => { if (e.target.id === 'settingsOverlay') document.getElementById('settingsOverlay').classList.add('hidden'); });
  document.getElementById('btnLogout').addEventListener('click', logout);
  document.getElementById('btnAddMoulage').addEventListener('click', () => showAddMoulageModal());
  
  document.getElementById('searchInput').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.getElementById('searchClear').classList.toggle('hidden', !q);
    document.querySelectorAll('.mcard').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
  });
  document.getElementById('searchClear').addEventListener('click', () => {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchClear').classList.add('hidden');
    document.querySelectorAll('.mcard').forEach(c => c.style.display = '');
  });
  
  firebaseAuth.onAuthStateChanged(user => {
    if (user && USERS[user.email]) loginSuccess(USERS[user.email], user.email);
  });
  
  // Event listeners pour le menu de déplacement
  document.getElementById('moveClose')?.addEventListener('click', closeMoveMenu);
  document.getElementById('moveOverlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'moveOverlay') closeMoveMenu();
  });
  
  // Event listeners pour confirmation suppression
  document.getElementById('confirmYes')?.addEventListener('click', confirmDelete);
  document.getElementById('confirmNo')?.addEventListener('click', closeDeleteConfirm);
  document.getElementById('confirmOverlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'confirmOverlay') closeDeleteConfirm();
  });
});

// Exposer fonctions globales
window.openFiche = openFiche;
window.closeFiche = closeFiche;
window.openMoveMenu = openMoveMenu;
window.showMoveMenu = showMoveMenu;
window.closeMoveMenu = closeMoveMenu;
window.moveCardToPosition = moveCardToPosition;
window.showDeleteConfirm = showDeleteConfirm;
window.closeDeleteConfirm = closeDeleteConfirm;
window.confirmDelete = confirmDelete;
window.openPriorityMenu = openPriorityMenu;
window.openCalendar = openCalendar;
window.closeCalendar = closeCalendar;
window.navigateCalendar = navigateCalendar;
window.selectDate = selectDate;
window.selectToday = selectToday;
window.openPhotoLink = openPhotoLink;
window.openNotePhoto = openNotePhoto;
window.saveMoulageNotes = saveMoulageNotes;
window.showFichePriorityMenu = showFichePriorityMenu;
window.togglePhotosMenu = togglePhotosMenu;
window.closePhotosMenu = closePhotosMenu;

// ===== MENUS CONTEXTUELS UNIFIÉS (Délai / Raison Attente / Expédition) =====
let isRobotViewActive = false;

// Ferme tous les menus contextuels
function closeContextMenus() {
  document.getElementById('contextMenu')?.remove();
}

// Positionne un menu près d'un élément
function positionMenu(menu, anchor, preferLeft = false) {
  const rect = anchor.getBoundingClientRect();
  const menuW = menu.offsetWidth || 250;
  const menuH = menu.offsetHeight || 300;
  
  if (preferLeft) {
    menu.style.left = Math.max(10, rect.left - menuW - 10) + 'px';
    menu.style.top = Math.max(10, Math.min(rect.top, window.innerHeight - menuH - 10)) + 'px';
  } else {
    menu.style.left = Math.min(rect.left, window.innerWidth - menuW - 10) + 'px';
    menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - menuH - 10) + 'px';
  }
}

// Met à jour une carte après modification
function refreshCard(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card && cardsData[cardId]) {
    updateExistingCard(card, cardId, cardsData[cardId]);
  }
}

// Menu principal - dispatch selon la colonne
function openDelaiMenu(cardId, event) {
  event.stopPropagation();
  event.preventDefault();
  closeContextMenus();
  
  const cardData = cardsData[cardId];
  if (!cardData) return;
  
  // Colonne 7 (En attente) → Menu raison
  if (cardData.columnIndex === 7) {
    showRaisonMenu(cardId, event);
    return;
  }
  
  // Colonne 6 (Expédition) → Menu expédier
  if (cardData.columnIndex === 6) {
    showExpeditionMenu(cardId, event);
    return;
  }
  
  // Colonnes 0-5 → Menu délai régional
  showDelaiMenu(cardId, event);
}

// Menu Expédition (colonne 6)
function showExpeditionMenu(cardId, event) {
  const menu = document.createElement('div');
  menu.id = 'contextMenu';
  menu.className = 'ctx-menu';
  menu.onclick = e => e.stopPropagation();
  
  menu.innerHTML = `
    <div class="ctx-header">📦 Expédition</div>
    <div class="ctx-body">
      <button class="ctx-btn primary" onclick="marquerExpedie('${cardId}')">📦 Marquer comme Expédié</button>
    </div>
    <div class="ctx-footer">
      <button class="ctx-btn" onclick="closeContextMenus()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  positionMenu(menu, event.target);
}

// Menu Délai régional (colonnes 0-5)
function showDelaiMenu(cardId, event) {
  const cardData = cardsData[cardId];
  const currentRegion = cardData.region || 'Quebec';
  const delays = MENU_DATA.delays;
  
  const menu = document.createElement('div');
  menu.id = 'contextMenu';
  menu.className = 'ctx-menu';
  menu.onclick = e => e.stopPropagation();
  
  const regions = [
    { key: 'Quebec', label: 'Québec', delay: delays['Quebec'] || 90 },
    { key: 'Maritime', label: 'Maritime', delay: delays['Maritime'] || 45 },
    { key: 'Ontario', label: 'Ontario', delay: delays['Ontario'] || 30 }
  ];
  
  const rowsHtml = regions.map(r => `
    <div class="ctx-region ${currentRegion === r.key ? 'active' : ''}" data-region="${r.key}">
      <span class="ctx-region-name">${r.label}</span>
      <input type="number" class="ctx-input" data-region="${r.key}" value="${r.delay}" min="1" max="365" onclick="event.stopPropagation()">
      <span class="ctx-unit">jours</span>
    </div>
  `).join('');
  
  menu.innerHTML = `
    <div class="ctx-header">⏱ Délais par région</div>
    <div class="ctx-body">${rowsHtml}</div>
    <div class="ctx-footer">
      <button class="ctx-btn primary" onclick="saveDelai('${cardId}')">Sauvegarder</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Click sur une région pour la sélectionner
  menu.querySelectorAll('.ctx-region').forEach(row => {
    row.onclick = (e) => {
      if (e.target.tagName === 'INPUT') return;
      menu.querySelectorAll('.ctx-region').forEach(r => r.classList.remove('active'));
      row.classList.add('active');
      if (cardsData[cardId]) cardsData[cardId].region = row.dataset.region;
    };
  });
  
  positionMenu(menu, event.target);
}

function saveDelai(cardId) {
  const menu = document.getElementById('contextMenu');
  if (!menu) return;
  
  // Sauvegarder les délais
  menu.querySelectorAll('.ctx-input').forEach(input => {
    MENU_DATA.delays[input.dataset.region] = parseInt(input.value) || 30;
  });
  
  // Sauvegarder la région sélectionnée
  const activeRow = menu.querySelector('.ctx-region.active');
  if (activeRow && cardsData[cardId]) {
    const region = activeRow.dataset.region;
    cardsData[cardId].region = region;
    cardsData[cardId].delaiPersonnalise = MENU_DATA.delays[region];
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  
  closeContextMenus();
  showToast('Délai sauvegardé!');
}

function marquerExpedie(cardId) {
  const dateExp = prompt("Date d'expédition (AAAA-MM-JJ):", new Date().toISOString().split('T')[0]);
  if (dateExp && cardsData[cardId]) {
    cardsData[cardId].expedie = true;
    cardsData[cardId].dateExpedition = dateExp;
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  closeContextMenus();
}

// Menu Raison d'attente (colonne 7)
function showRaisonMenu(cardId, event) {
  const currentRaison = cardsData[cardId]?.raisonAttente || '';
  const raisons = customLists.raisonsAttente || [
    'RDV non reçu', 'Client rappeler - voir note', 'Essayage autre région',
    'Mesure à reprendre', 'Pièce à recommander', 'Vérification prix',
    'Intervention', 'Livraison reportée', 'Hors délai RAMQ', 'Sous traitement', 'Voir Fiche'
  ];
  
  const menu = document.createElement('div');
  menu.id = 'contextMenu';
  menu.className = 'ctx-menu raison';
  menu.onclick = e => e.stopPropagation();
  
  const optionsHtml = raisons.map(r => 
    `<div class="ctx-option ${r === currentRaison ? 'selected' : ''}" onclick="selectRaison('${cardId}','${r.replace(/'/g, "\\'")}')">${r}</div>`
  ).join('');
  
  menu.innerHTML = `
    <div class="ctx-header">⏳ Raison d'attente</div>
    <div class="ctx-options">${optionsHtml}</div>
    <div class="ctx-actions">
      <button class="ctx-btn small" onclick="addRaison('${cardId}')">➕ Ajouter</button>
      <button class="ctx-btn small danger" onclick="clearRaison('${cardId}')">🗑 Effacer</button>
    </div>
    <div class="ctx-footer">
      <button class="ctx-btn" onclick="closeContextMenus()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(menu);
  
  // Positionner à gauche de la carte
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  positionMenu(menu, card || event.target, true);
}

function selectRaison(cardId, raison) {
  if (cardsData[cardId]) {
    cardsData[cardId].raisonAttente = raison;
    cardsData[cardId].attenteActive = true;
    if (!cardsData[cardId].dateAttente) {
      cardsData[cardId].dateAttente = new Date().toLocaleDateString('fr-CA');
    }
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  closeContextMenus();
  showToast('Raison: ' + raison);
}

function addRaison(cardId) {
  const newRaison = prompt("Nouvelle raison d'attente:");
  if (newRaison?.trim()) {
    const raison = newRaison.trim();
    if (!customLists.raisonsAttente) customLists.raisonsAttente = [];
    if (!customLists.raisonsAttente.includes(raison)) {
      customLists.raisonsAttente.push(raison);
      customLists.raisonsAttente.sort((a, b) => a.localeCompare(b, 'fr'));
      saveCustomLists();
      showListToast('✓ "' + raison + '" AJOUTÉ!', true);
    }
    selectRaison(cardId, raison);
  }
}

function clearRaison(cardId) {
  if (cardsData[cardId]) {
    cardsData[cardId].raisonAttente = '';
    cardsData[cardId].attenteActive = false;
    cardsData[cardId].dateAttente = '';
    saveCardToFirebase(cardId);
    refreshCard(cardId);
  }
  closeContextMenus();
  showToast('Raison effacée');
}

// Alias pour compatibilité
function openRaisonAttenteMenu(cardId, event) { showRaisonMenu(cardId, event); }
function selectRaisonAttente(cardId, raison) { selectRaison(cardId, raison); }
function addRaisonAttente(cardId) { addRaison(cardId); }
function clearRaisonAttente(cardId) { clearRaison(cardId); }
function selectRegionDelai(cardId, region) { if(cardsData[cardId]) cardsData[cardId].region = region; }
function saveDelaiAndClose(cardId) { saveDelai(cardId); }

// ===== VUE ROBOT HORIZONTALE =====

function toggleRobotView() {
  isRobotViewActive = !isRobotViewActive;
  const robotView = document.getElementById('robotHorizontalView');
  if (!robotView) return;
  
  if (isRobotViewActive) {
    robotView.style.display = 'flex';
    renderRobotTable();
    setupColumnResize();
  } else {
    robotView.style.display = 'none';
  }
}

function renderRobotTable() {
  const tbody = document.getElementById('robotTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  
  // Cartes de la colonne Robot (columnIndex = 0)
  const robotCards = Object.entries(cardsData).filter(([id, card]) => 
    (card.columnIndex ?? card.column ?? -1) === 0
  );
  
  if (robotCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="16" style="text-align:center;padding:30px;color:#6b7280;">Aucune carte dans Robot</td></tr>';
    return;
  }
  
  // Listes fixes
  const lists = {
    clients: [...(customLists.moulageClients || [])].sort((a, b) => a.localeCompare(b, 'fr')),
    regions: [...(customLists.regions || ['Maritime', 'Ontario', 'Quebec'])].sort((a, b) => a.localeCompare(b, 'fr')),
    representantes: ['Marie-Pier', 'Marie-Soleil'],
    items: ['Siège', 'Dossier', 'Siège + Dossier']
  };
  
  robotCards.forEach(([cardId, card], index) => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-card-id', cardId);
    
    const rang = index + 1;
    const prio = card.priority || 0;
    const hasNotes = card.notes && card.notes.trim().length > 0;
    
    // Nom et numéro de commande: modifiables seulement si vides
    const nameEditable = !card.name || card.name.trim() === '';
    const orderEditable = !card.order || card.order.trim() === '';
    
    tr.innerHTML = `
      <td class="${nameEditable ? 'editable' : 'locked'}" ${nameEditable ? 'contenteditable="true"' : ''} data-field="name">${card.name || ''}</td>
      <td class="${orderEditable ? 'editable' : 'locked'}" ${orderEditable ? 'contenteditable="true"' : ''} data-field="order">${card.order || ''}</td>
      <td class="editable" contenteditable="true" data-field="numeroSoumission">${card.numeroSoumission || ''}</td>
      <td>${buildSelectCell(cardId, 'client', card.client, lists.clients, 'moulageClients')}</td>
      <td>
        <select class="table-select" onchange="updateTableField('${cardId}', 'priority', parseInt(this.value))">
          <option value="0" ${prio==0?'selected':''}>☆ Aucune</option>
          <option value="1" ${prio==1?'selected':''}>1️⃣ Priorité 1</option>
          <option value="2" ${prio==2?'selected':''}>2️⃣ Priorité 2</option>
          <option value="3" ${prio==3?'selected':''}>3️⃣ Priorité 3</option>
          <option value="4" ${prio==4?'selected':''}>4️⃣ Priorité 4</option>
          <option value="5" ${prio==5?'selected':''}>5️⃣ Priorité 5</option>
        </select>
      </td>
      <td><span class="rang-robot-text">${rang}</span></td>
      <td>${buildSelectCell(cardId, 'region', card.region, lists.regions, 'regions')}</td>
      <td>${buildSelectCell(cardId, 'item', card.item, lists.items, 'items')}</td>
      <td class="date-cell ${card.dateRecue?'has-date':'placeholder'}" onclick="showTableCalendar('${cardId}','dateRecue',this)">${card.dateRecue || 'AAAA-MM-JJ'}</td>
      <td class="date-cell ${card.dateLivraison?'has-date':'placeholder'}" onclick="showTableCalendar('${cardId}','dateLivraison',this)">${card.dateLivraison || 'AAAA-MM-JJ'}</td>
      <td class="date-cell ${card.dateEssayage?'has-date':'placeholder'}" onclick="showTableCalendar('${cardId}','dateEssayage',this)">${card.dateEssayage || 'AAAA-MM-JJ'}</td>
      <td>${buildSelectCell(cardId, 'representant', card.representant, lists.representantes, 'representantes')}</td>
      <td>
        <select class="table-select" onchange="updateTableField('${cardId}', 'file', this.value)">
          <option value="">--</option>
          <option value="Oui" ${card.file==='Oui'?'selected':''}>Oui</option>
          <option value="Non" ${card.file==='Non'?'selected':''}>Non</option>
        </select>
      </td>
      <td class="editable" contenteditable="true" data-field="angle">${card.angle || ''}</td>
      <td>
        <select class="table-select" onchange="updateTableField('${cardId}', 'rush', this.value)">
          <option value="">--</option>
          <option value="Oui" ${card.rush==='Oui'?'selected':''}>Oui</option>
          <option value="Non" ${card.rush==='Non'?'selected':''}>Non</option>
        </select>
      </td>
      <td class="notes-cell"><button class="notes-btn ${hasNotes?'has-notes':''}" onclick="openCardNotes('${cardId}')">📝</button></td>
    `;
    tbody.appendChild(tr);
  });
  
  setupTableEditableListeners();
}

// Construit une cellule select avec + et - gros et colorés
function buildSelectCell(cardId, field, value, list, listKey) {
  const options = list.map(item => 
    `<option value="${item}" ${value===item?'selected':''}>${item}</option>`
  ).join('');
  
  return `<select class="table-select has-pm" onchange="handleSelectChange('${cardId}','${field}','${listKey}',this)">
    <option value="__PM__">(+Valeur-)</option>
    <option value="" ${!value?'selected':''}>--</option>
    ${options}
  </select>`;
}

function handleSelectChange(cardId, field, listKey, selectEl) {
  const value = selectEl.value;
  
  if (value === '__PM__') {
    selectEl.value = cardsData[cardId]?.[field] || '';
    openListManager(listKey, getTitleForList(listKey));
  } else {
    updateTableField(cardId, field, value);
  }
}

function getTitleForList(listKey) {
  const titles = {moulageClients:'Clients', regions:'Régions', items:'Items', representantes:'Représentantes'};
  return titles[listKey] || listKey;
}

// Mise à jour d'un champ depuis le tableau
function updateTableField(cardId, field, value) {
  if (!cardsData[cardId]) return;
  cardsData[cardId][field] = value;
  saveCardToFirebase(cardId);
  
  // Sync avec Kanban
  const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
  if (card) {
    if (field === 'name') {
      const el = card.querySelector('.mcard-title');
      if (el) el.value = value;
    } else if (field === 'order') {
      const el = card.querySelector('.mcard-order');
      if (el) el.value = value;
    } else if (field === 'priority') {
      updatePriorityBadge(card, value);
    } else if (field === 'region') {
      card.classList.remove('region-qc','region-on','region-ma');
      if (value === 'Quebec') card.classList.add('region-qc');
      else if (value === 'Ontario') card.classList.add('region-on');
      else if (value === 'Maritime') card.classList.add('region-ma');
    }
  }
}

// Listeners pour cellules éditables
function setupTableEditableListeners() {
  document.querySelectorAll('#robotTableBody td.editable').forEach(cell => {
    cell.addEventListener('blur', function() {
      const row = this.closest('tr');
      const cardId = row?.getAttribute('data-card-id');
      const field = this.getAttribute('data-field');
      const value = this.textContent.trim();
      if (cardId && cardsData[cardId]) {
        cardsData[cardId][field] = value;
        saveCardToFirebase(cardId);
        
        const card = document.querySelector('.mcard[data-card-id="'+cardId+'"]');
        if (card && field === 'name') {
          const el = card.querySelector('.mcard-title');
          if (el) el.value = value;
        }
        if (card && field === 'order') {
          const el = card.querySelector('.mcard-order');
          if (el) el.value = value;
        }
      }
    });
  });
}

// Ouvre un popup Notes identique à la fiche moulage
function openCardNotes(cardId) {
  document.getElementById('notesPopupOverlay')?.remove();
  document.getElementById('notesPopup')?.remove();
  
  const card = cardsData[cardId];
  if (!card) return;
  
  const overlay = document.createElement('div');
  overlay.id = 'notesPopupOverlay';
  overlay.className = 'notes-popup-overlay';
  overlay.onclick = closeNotesPopup;
  
  const popup = document.createElement('div');
  popup.id = 'notesPopup';
  popup.className = 'notes-popup-page';
  popup.onclick = e => e.stopPropagation();
  popup.innerHTML = `
    <div class="notes-page-header">
      <span class="notes-header-left" onclick="togglePopupPhotosPanel('${cardId}')" title="Gérer les liens photos"><span class="camera-icon">📷</span> Liens</span>
      <span class="notes-header-center">📝 Notes</span>
      <button class="notes-close-btn" onclick="closeNotesPopup()" title="Fermer">✕</button>
    </div>
    
    <div class="notes-photos-links-panel" id="notesPhotosPanel_popup_${cardId}" style="display:none;">
      <div class="notes-photo-link-row"><label>Photo 1:</label><input type="url" id="notePhotoLink1_popup_${cardId}" value="${card.notePhoto1 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 2:</label><input type="url" id="notePhotoLink2_popup_${cardId}" value="${card.notePhoto2 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 3:</label><input type="url" id="notePhotoLink3_popup_${cardId}" value="${card.notePhoto3 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 4:</label><input type="url" id="notePhotoLink4_popup_${cardId}" value="${card.notePhoto4 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 5:</label><input type="url" id="notePhotoLink5_popup_${cardId}" value="${card.notePhoto5 || ''}" placeholder="https://..."></div>
      <div class="notes-photo-link-row"><label>Photo 6:</label><input type="url" id="notePhotoLink6_popup_${cardId}" value="${card.notePhoto6 || ''}" placeholder="https://..."></div>
      <button class="notes-save-photos-btn" onclick="savePopupPhotoLinks('${cardId}')">💾 Enregistrer les liens</button>
    </div>
    
    <div class="notes-photos-row">
      <button class="notes-photo-btn ${card.notePhoto1?'has-link':''}" onclick="openNotePhoto('${cardId}', 1)">Photo 1</button>
      <button class="notes-photo-btn ${card.notePhoto2?'has-link':''}" onclick="openNotePhoto('${cardId}', 2)">Photo 2</button>
      <button class="notes-photo-btn ${card.notePhoto3?'has-link':''}" onclick="openNotePhoto('${cardId}', 3)">Photo 3</button>
      <button class="notes-photo-btn ${card.notePhoto4?'has-link':''}" onclick="openNotePhoto('${cardId}', 4)">Photo 4</button>
      <button class="notes-photo-btn ${card.notePhoto5?'has-link':''}" onclick="openNotePhoto('${cardId}', 5)">Photo 5</button>
      <button class="notes-photo-btn ${card.notePhoto6?'has-link':''}" onclick="openNotePhoto('${cardId}', 6)">Photo 6</button>
    </div>
    
    <textarea class="notes-page-textarea" id="notesTextarea_popup_${cardId}" 
      placeholder="Cliquez ici pour écrire..."
      onfocus="prepareNoteWithSignature('popup_${cardId}')"
      onblur="savePopupNotes('${cardId}')">${card.notes || ''}</textarea>
  `;
  
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  
  // Focus sur le textarea
  setTimeout(() => document.getElementById('notesTextarea_popup_' + cardId)?.focus(), 100);
}

function togglePopupPhotosPanel(cardId) {
  const panel = document.getElementById('notesPhotosPanel_popup_' + cardId);
  if (panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function savePopupPhotoLinks(cardId) {
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('notePhotoLink' + i + '_popup_' + cardId);
    if (input && cardsData[cardId]) {
      cardsData[cardId]['notePhoto' + i] = input.value.trim();
    }
  }
  saveCardToFirebase(cardId);
  showToast('Liens photos sauvegardés');
  
  // Rafraîchir le popup
  closeNotesPopup();
  openCardNotes(cardId);
}

function savePopupNotes(cardId) {
  const textarea = document.getElementById('notesTextarea_popup_' + cardId);
  if (!textarea || !cardsData[cardId]) return;
  
  cardsData[cardId].notes = textarea.value.trim();
  saveCardToFirebase(cardId);
  
  // Sync avec fiche si ouverte
  const ficheTextarea = document.getElementById('notesTextarea_' + cardId);
  if (ficheTextarea) ficheTextarea.value = cardsData[cardId].notes;
  
  renderRobotTable();
}

function closeNotesPopup() {
  document.getElementById('notesPopupOverlay')?.remove();
  document.getElementById('notesPopup')?.remove();
}

// Redimensionnement colonnes
function setupColumnResize() {
  document.querySelectorAll('.resize-handle').forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      const th = this.parentElement;
      const startX = e.pageX;
      const startWidth = th.offsetWidth;
      
      function onMove(e) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 40) th.style.width = newWidth + 'px';
      }
      
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
}

// Fermer menus au clic ailleurs
document.addEventListener('click', function(e) {
  if (!e.target.closest('#unifiedCalendar') && !e.target.closest('.date-cell')) closeCalendar();
  if (!e.target.closest('.ctx-menu') && !e.target.closest('.mcard-delay-pill')) closeContextMenus();
});

// Exports window
window.toggleRobotView = toggleRobotView;
window.updateTableField = updateTableField;
window.handleSelectChange = handleSelectChange;
window.showTableCalendar = showTableCalendar;
window.navTableCal = navTableCal;
window.selectTableDate = selectTableDate;
window.closeTableCalendar = closeTableCalendar;
window.openCardNotes = openCardNotes;
window.closeNotesPopup = closeNotesPopup;
window.savePopupNotes = savePopupNotes;
window.savePopupPhotoLinks = savePopupPhotoLinks;
window.togglePopupPhotosPanel = togglePopupPhotosPanel;
window.closeContextMenus = closeContextMenus;
window.selectRaison = selectRaison;
window.addRaison = addRaison;
window.clearRaison = clearRaison;
window.saveDelai = saveDelai;
window.marquerExpedie = marquerExpedie;

// ===== MODAL AJOUTER MOULAGE =====
function showAddMoulageModal() {
  let modal = document.getElementById('addMoulageModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'addMoulageModal';
    modal.className = 'add-modal-overlay hidden';
    modal.innerHTML = `
      <div class="add-modal">
        <div class="add-modal-header">
          <h3>➕ Ajouter un moulage</h3>
          <div class="add-modal-header-btns">
            <button class="add-json-btn" onclick="document.getElementById('addMoulageJsonInput').click()">
              🤖 JSON
            </button>
            <input type="file" id="addMoulageJsonInput" accept=".json" style="display:none" onchange="handleImportMoulageJson(event)">
            <button class="add-modal-close" onclick="closeAddMoulageModal()">×</button>
          </div>
        </div>
        <div class="add-modal-body">
          <div class="add-modal-field">
            <label>Client <button class="add-field-manage-btn" onclick="openListManager('moulageClients', 'Clients')">⚙</button></label>
            <select id="addMoulageClient"></select>
          </div>
          <div class="add-modal-field">
            <label>Nom du moulage</label>
            <input type="text" id="addMoulageName" placeholder="Ex: Dupont Jean">
          </div>
          <div class="add-modal-field">
            <label>📅 Date reçue</label>
            <div class="date-picker-field" onclick="openCalendarPopup('addMoulageDateRecue')">
              <span id="addMoulageDateRecueDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addMoulageDateRecue">
          </div>
          <div class="add-modal-field">
            <label>🤖 Date fabriquée robot</label>
            <div class="date-picker-field" onclick="openCalendarPopup('addMoulageDateRobot')">
              <span id="addMoulageDateRobotDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addMoulageDateRobot">
          </div>
          <div class="add-modal-field">
            <label>📦 Date de livraison</label>
            <div class="date-picker-field" onclick="openCalendarPopup('addMoulageDateLivraison')">
              <span id="addMoulageDateLivraisonDisplay">-- Sélectionner --</span>
              <span class="date-picker-icon">📅</span>
            </div>
            <input type="hidden" id="addMoulageDateLivraison">
          </div>
          <div class="add-modal-field">
            <label>N° Commande</label>
            <input type="text" id="addMoulageOrder" placeholder="000000" maxlength="6">
          </div>
          <div class="add-modal-field">
            <label>Numéro PO</label>
            <input type="text" id="addMoulageNumeroPO" placeholder="Numéro...">
          </div>
          <div class="add-modal-field">
            <label>Région <button class="add-field-manage-btn" onclick="openListManager('regions', 'Régions')">⚙</button></label>
            <select id="addMoulageRegion"></select>
          </div>
          <div class="add-modal-field">
            <label>📋 N° Soumission</label>
            <input type="text" id="addMoulageSoumission" placeholder="Numéro de soumission...">
          </div>
          <div class="add-modal-field">
            <label>Intervenant <button class="add-field-manage-btn" onclick="openListManager('intervenants', 'Intervenants')">⚙</button></label>
            <select id="addMoulageIntervenant"></select>
          </div>
          <div class="add-modal-field">
            <label>Représentante <button class="add-field-manage-btn" onclick="openListManager('representantes', 'Représentantes')">⚙</button></label>
            <select id="addMoulageRepresentant"></select>
          </div>
        </div>
        <div class="add-modal-footer">
          <button class="add-btn-cancel" onclick="closeAddMoulageModal()">Annuler</button>
          <button class="add-btn-confirm" onclick="confirmAddMoulage()">Ajouter</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  populateAddMoulageSelects();
  
  // Reset tous les champs
  document.getElementById('addMoulageName').value = '';
  document.getElementById('addMoulageOrder').value = '';
  document.getElementById('addMoulageNumeroPO').value = '';
  document.getElementById('addMoulageSoumission').value = '';
  
  // Reset dates avec valeur par défaut pour Date reçue
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('addMoulageDateRecue').value = today;
  document.getElementById('addMoulageDateRecueDisplay').textContent = formatDateFR(today);
  document.getElementById('addMoulageDateRobot').value = '';
  document.getElementById('addMoulageDateRobotDisplay').textContent = '-- Sélectionner --';
  document.getElementById('addMoulageDateLivraison').value = '';
  document.getElementById('addMoulageDateLivraisonDisplay').textContent = '-- Sélectionner --';
  
  modal.classList.remove('hidden');
}

function closeAddMoulageModal() {
  const modal = document.getElementById('addMoulageModal');
  if (modal) modal.classList.add('hidden');
}

function populateAddMoulageSelects() {
  const clientSelect = document.getElementById('addMoulageClient');
  const regionSelect = document.getElementById('addMoulageRegion');
  const repSelect = document.getElementById('addMoulageRepresentant');
  const intSelect = document.getElementById('addMoulageIntervenant');
  
  if (clientSelect) {
    const clients = [...(customLists.moulageClients || [])].sort((a, b) => a.localeCompare(b, 'fr'));
    clientSelect.innerHTML = '<option value="">-- Sélectionner --</option>' + 
      clients.map(c => '<option value="' + c + '">' + c + '</option>').join('');
  }
  
  if (regionSelect) {
    const regions = [...(customLists.regions || ['Quebec', 'Ontario', 'Maritime'])].sort((a, b) => a.localeCompare(b, 'fr'));
    regionSelect.innerHTML = regions.map(r => '<option value="' + r + '">' + r + '</option>').join('');
    regionSelect.value = 'Quebec';
  }
  
  if (repSelect) {
    const reps = [...(customLists.representantes || [])].sort((a, b) => a.localeCompare(b, 'fr'));
    repSelect.innerHTML = '<option value="">-- Sélectionner --</option>' + 
      reps.map(r => '<option value="' + r + '">' + r + '</option>').join('');
  }
  
  if (intSelect) {
    const ints = [...(customLists.intervenants || [])].sort((a, b) => a.localeCompare(b, 'fr'));
    intSelect.innerHTML = '<option value="">-- Sélectionner --</option>' + 
      ints.map(i => '<option value="' + i + '">' + i + '</option>').join('');
  }
}

function confirmAddMoulage() {
  const nameInput = document.getElementById('addMoulageName').value.trim();
  const name = nameInput || 'Sans nom';  // Valeur par défaut si vide
  const order = document.getElementById('addMoulageOrder').value.trim();
  const region = document.getElementById('addMoulageRegion').value || 'Quebec';
  const client = document.getElementById('addMoulageClient').value;
  const representant = document.getElementById('addMoulageRepresentant').value;
  const intervenant = document.getElementById('addMoulageIntervenant').value;
  const soumission = document.getElementById('addMoulageSoumission').value.trim();
  const numeroPO = document.getElementById('addMoulageNumeroPO').value.trim();
  const dateRecue = document.getElementById('addMoulageDateRecue').value;
  const dateRobot = document.getElementById('addMoulageDateRobot').value;
  const dateLivraison = document.getElementById('addMoulageDateLivraison').value;
  
  // Créer la carte (pas de validation obligatoire)
  const cardId = createCard(name, order || '000000', region, 0);
  
  // Ajouter les données supplémentaires
  if (cardsData[cardId]) {
    cardsData[cardId].client = client;
    cardsData[cardId].representant = representant;
    cardsData[cardId].intervenant = intervenant;
    cardsData[cardId].numeroSoumission = soumission;
    cardsData[cardId].numeroPO = numeroPO;
    cardsData[cardId].dateRecue = dateRecue;
    cardsData[cardId].dateRobot = dateRobot;
    cardsData[cardId].dateLivraison = dateLivraison;
    saveCardToFirebase(cardId);
  }
  
  closeAddMoulageModal();
  showToast('Moulage "' + name + '" créé avec succès!');
  
  // Rafraîchir la vue Robot si active
  if (isRobotViewActive && typeof renderRobotTable === 'function') {
    setTimeout(() => renderRobotTable(), 200);
  }
}

// ===== IMPORT JSON POUR MOULAGE =====
function handleImportMoulageJson(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      let newValuesAdded = [];
      
      // Ajouter valeur à une liste si nouvelle
      function addToListIfNew(listKey, value) {
        if (!value || value.trim() === '') return false;
        const trimmedValue = value.trim();
        
        if (!customLists[listKey]) customLists[listKey] = [];
        
        const exists = customLists[listKey].some(item => 
          item.toLowerCase() === trimmedValue.toLowerCase()
        );
        
        if (!exists) {
          customLists[listKey].push(trimmedValue);
          customLists[listKey].sort((a, b) => a.localeCompare(b, 'fr'));
          newValuesAdded.push(trimmedValue + ' (' + listKey + ')');
          return true;
        }
        return false;
      }
      
      // Ajouter les nouvelles valeurs aux listes
      if (data.client) addToListIfNew('moulageClients', data.client);
      if (data.representante || data.representant) addToListIfNew('representantes', data.representante || data.representant);
      if (data.intervenant) addToListIfNew('intervenants', data.intervenant);
      if (data.region) addToListIfNew('regions', data.region);
      
      // Sauvegarder les listes si nouvelles valeurs
      if (newValuesAdded.length > 0) {
        saveCustomLists();
      }
      
      // Créer la carte
      const name = data.name || data.nom || 'Sans nom';
      const order = data.order || data.commande || data.numeroCommande || '000000';
      const region = data.region || 'Quebec';
      
      const cardId = createCard(name, order, region, 0);
      
      // Ajouter toutes les données
      if (cardsData[cardId]) {
        cardsData[cardId].client = data.client || '';
        cardsData[cardId].representant = data.representante || data.representant || '';
        cardsData[cardId].intervenant = data.intervenant || '';
        cardsData[cardId].numeroSoumission = data.numeroSoumission || data.soumission || '';
        cardsData[cardId].numeroPO = data.numeroPO || data.po || '';
        cardsData[cardId].dateRecue = data.dateRecue || new Date().toISOString().split('T')[0];
        cardsData[cardId].dateRobot = data.dateRobot || '';
        cardsData[cardId].dateLivraison = data.dateLivraison || data.livraison || '';
        cardsData[cardId].dateEssayage = data.dateEssayage || '';
        cardsData[cardId].item = data.item || '';
        cardsData[cardId].notes = data.notes || '';
        saveCardToFirebase(cardId);
      }
      
      closeAddMoulageModal();
      
      // Rafraîchir
      if (isRobotViewActive && typeof renderRobotTable === 'function') {
        setTimeout(() => renderRobotTable(), 200);
      }
      
      // Message succès
      let msg = 'Moulage "' + name + '" créé via JSON!';
      if (newValuesAdded.length > 0) {
        msg += '\n\nNouvelles valeurs ajoutées:\n• ' + newValuesAdded.join('\n• ');
      }
      alert('✅ ' + msg);
      
    } catch (error) {
      console.error('Erreur import JSON:', error);
      alert('❌ Erreur lors de l\'import du JSON!\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}

// ===== CALENDRIER UNIFIÉ =====
const CAL_MONTHS = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
const CAL_DAYS = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];

let calState = { year: 0, month: 0, selected: '', callback: null, clearCallback: null, mode: 'modal', anchorEl: null };

function showCalendar(options = {}) {
  const { value = '', onSelect = null, onClear = null, mode = 'modal', anchor = null } = options;
  
  // Fermer tout calendrier existant
  closeCalendar();
  
  // Initialiser l'état
  const d = value ? new Date(value + 'T12:00:00') : new Date();
  calState = { 
    year: d.getFullYear(), 
    month: d.getMonth(), 
    selected: value, 
    callback: onSelect, 
    clearCallback: onClear,
    mode: mode,
    anchorEl: anchor
  };
  
  // Créer le calendrier
  const cal = document.createElement('div');
  cal.id = 'unifiedCalendar';
  cal.className = mode === 'modal' ? 'cal-overlay' : 'cal-popup';
  cal.onclick = mode === 'modal' ? (e) => { if (e.target === cal) closeCalendar(); } : (e) => e.stopPropagation();
  
  const popup = document.createElement('div');
  popup.className = 'cal-container';
  popup.innerHTML = renderCalendarContent();
  
  if (mode === 'modal') {
    cal.appendChild(popup);
  } else {
    cal.appendChild(popup);
  }
  
  document.body.appendChild(cal);
  
  // Positionner si mode inline
  if (mode === 'inline' && anchor) {
    const rect = anchor.getBoundingClientRect();
    cal.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
    cal.style.top = Math.min(rect.bottom + 5, window.innerHeight - 320) + 'px';
  }
}

function renderCalendarContent() {
  const { year, month, selected } = calState;
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date().toISOString().split('T')[0];
  
  let daysHtml = '';
  
  // Jours vides du début
  for (let i = 0; i < firstDay; i++) daysHtml += '<div class="cal-cell empty"></div>';
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let cls = 'cal-cell';
    if (dateStr === today) cls += ' today';
    if (dateStr === selected) cls += ' selected';
    daysHtml += `<div class="${cls}" onclick="selectCalDate('${dateStr}')">${day}</div>`;
  }
  
  return `
    <div class="cal-header">
      <button onclick="navCal(-1)">◀</button>
      <span>${CAL_MONTHS[month]} ${year}</span>
      <button onclick="navCal(1)">▶</button>
    </div>
    <div class="cal-weekdays">${CAL_DAYS.map(d => `<span>${d}</span>`).join('')}</div>
    <div class="cal-grid">${daysHtml}</div>
    <div class="cal-footer">
      <button class="cal-btn today" onclick="selectCalDate('${today}')">Aujourd'hui</button>
      <button class="cal-btn clear" onclick="clearCalDate()">Effacer</button>
      <button class="cal-btn close" onclick="closeCalendar()">Fermer</button>
    </div>
  `;
}

function navCal(dir) {
  calState.month += dir;
  if (calState.month < 0) { calState.month = 11; calState.year--; }
  if (calState.month > 11) { calState.month = 0; calState.year++; }
  document.querySelector('#unifiedCalendar .cal-container').innerHTML = renderCalendarContent();
}

function selectCalDate(dateStr) {
  if (calState.callback) calState.callback(dateStr);
  closeCalendar();
}

function clearCalDate() {
  if (calState.clearCallback) calState.clearCallback();
  else if (calState.callback) calState.callback('');
  closeCalendar();
}

function closeCalendar() {
  document.getElementById('unifiedCalendar')?.remove();
}

// Format date FR
function formatDateFR(dateStr) {
  if (!dateStr) return '-- Sélectionner --';
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
}

// ===== COMPATIBILITÉ ANCIEN CODE =====
// Calendrier popup (fiche moulage)
function openCalendarPopup(targetId) {
  const hiddenInput = document.getElementById(targetId);
  const currentValue = hiddenInput?.value || '';
  
  showCalendar({
    value: currentValue,
    mode: 'modal',
    onSelect: (dateStr) => {
      if (hiddenInput) hiddenInput.value = dateStr;
      const displayEl = document.getElementById(targetId + 'Display');
      if (displayEl) displayEl.textContent = formatDateFR(dateStr);
    }
  });
}
function closeCalendarPopup() { closeCalendar(); }
function calendarPrev() { navCal(-1); }
function calendarNext() { navCal(1); }
function calendarToday() { selectCalDate(new Date().toISOString().split('T')[0]); }
function calendarClear() { clearCalDate(); }
function selectCalendarDate(dateStr) { selectCalDate(dateStr); }

// Calendrier table (vue Robot)
function showTableCalendar(cardId, field, cell) {
  const currentDate = cardsData[cardId]?.[field] || '';
  
  showCalendar({
    value: currentDate,
    mode: 'inline',
    anchor: cell,
    onSelect: (dateStr) => {
      if (cardsData[cardId]) {
        cardsData[cardId][field] = dateStr;
        saveCardToFirebase(cardId);
        renderRobotTable();
      }
    }
  });
}
function closeTableCalendar() { closeCalendar(); }
function navTableCal(dir, cardId, field) { navCal(dir); }
function selectTableDate(cardId, field, dateStr) { selectCalDate(dateStr); }

// ===== NAVIGATION PAGES =====
let currentPage = 'moulages';

// Mapping pages vers noms affichés
const pageNames = {
  'moulages': 'Moulage',
  'serie': 'Série +',
  'inventaire': 'Inventaire',
  'jobs': 'Jobs en attente'
};

function updateLogoMenu() {
  const menu = document.getElementById('logoMenu');
  if (!menu) return;
  
  // Reconstruire le menu avec les 3 autres pages (pas la page actuelle)
  menu.innerHTML = '';
  Object.keys(pageNames).forEach(page => {
    if (page !== currentPage) {
      const item = document.createElement('div');
      item.className = 'logo-menu-item';
      item.textContent = pageNames[page];
      item.onclick = () => switchToPage(page);
      menu.appendChild(item);
    }
  });
}

function switchToPage(page) {
  currentPage = page;
  
  // Changer le texte du bas du logo
  const logoText = document.getElementById('logoBottomText');
  if (logoText && pageNames[page]) {
    logoText.textContent = pageNames[page];
  }
  
  // Mettre à jour le menu
  updateLogoMenu();
  
  // Cacher toutes les pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  
  // Afficher la page demandée
  const pageEl = document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1));
  if (pageEl) {
    pageEl.classList.add('active');
  } else {
    // Page pas encore créée - afficher toast
    showToast('Page "' + pageNames[page] + '" - À développer');
    // Revenir à moulages
    currentPage = 'moulages';
    const moulagesPage = document.getElementById('pageMoulages');
    if (moulagesPage) moulagesPage.classList.add('active');
    // Remettre le texte Moulage
    if (logoText) logoText.textContent = pageNames['moulages'];
    // Mettre à jour le menu
    updateLogoMenu();
  }
}

window.showAddMoulageModal = showAddMoulageModal;
window.closeAddMoulageModal = closeAddMoulageModal;
window.confirmAddMoulage = confirmAddMoulage;
window.handleImportMoulageJson = handleImportMoulageJson;
window.switchToPage = switchToPage;
window.openCalendarPopup = openCalendarPopup;
window.closeCalendarPopup = closeCalendarPopup;
window.calendarPrev = calendarPrev;
window.calendarNext = calendarNext;
window.calendarToday = calendarToday;
window.calendarClear = calendarClear;
window.selectCalendarDate = selectCalendarDate;
window.formatDateFR = formatDateFR;
window.createCard = createCard;
window.generateCardId = generateCardId;

// =============================================================================
// INTERFACE MOBILE - COMPLÈTEMENT SÉPARÉE DU DESKTOP
// =============================================================================

// Détecter si on est sur mobile/tablette
function isMobileDevice() {
  return (window.innerWidth <= 1024) || 
         ('ontouchstart' in window) || 
         (navigator.maxTouchPoints > 0);
}

// Variables globales mobile
let currentMobileFicheId = null;
let mobileSwipeCurrentPage = 0; // 0=Info, 1=Notes

// Fonction appelée APRÈS la connexion réussie
function initMobileAfterLogin() {
  if (!isMobileDevice()) return;
  
  console.log('📱 Connexion réussie, initialisation mobile...');
  
  // Cacher immédiatement le board et header sur mobile
  const appRoot = document.querySelector('.app-root');
  if (appRoot) appRoot.style.display = 'none';
  
  // Créer l'overlay mobile s'il n'existe pas
  if (!document.getElementById('mobileHomeOverlay')) {
    createMobileHomeHTML();
  }
  
  // Afficher l'écran d'accueil mobile
  showMobileHome();
  
  // Mettre à jour le compteur plusieurs fois pour s'assurer que les données sont chargées
  let checkCount = 0;
  const checkInterval = setInterval(() => {
    updateMobileDataCount();
    checkCount++;
    const dataCount = Object.keys(cardsData).length;
    if (checkCount >= 10 || dataCount > 0) {
      clearInterval(checkInterval);
    }
  }, 1000);
}

// Mettre à jour le compteur de moulages chargés
function updateMobileDataCount() {
  const count = Object.keys(cardsData).length;
  const countEl = document.getElementById('mobileDataCount');
  
  if (countEl) {
    if (count > 0) {
      countEl.textContent = `${count} moulage${count > 1 ? 's' : ''} chargé${count > 1 ? 's' : ''}`;
      countEl.style.color = '#4ade80';
      
      // Afficher les cartes si pas de recherche en cours
      const input = document.getElementById('mobileSearchInput');
      if (!input || input.value.trim() === '') {
        displayAllMobileCards();
      }
    } else {
      countEl.textContent = '⏳ Chargement des données...';
      countEl.style.color = '#fbbf24';
    }
  }
}

// Créer le HTML de l'écran d'accueil mobile
function createMobileHomeHTML() {
  const mobileHTML = `
    <!-- ÉCRAN D'ACCUEIL MOBILE -->
    <div class="mobile-home-overlay" id="mobileHomeOverlay">
      <div class="mobile-home-header">
        <img src="https://raw.githubusercontent.com/sheriff717/Physipro-serie/main/logo-physipro1.png" class="mobile-home-logo" alt="PhysiPro">
        <h1 class="mobile-home-title">Outil d'aide de gestion pour les moulages</h1>
        <p class="mobile-home-subtitle" id="mobileDataCount">⏳ Chargement des données...</p>
      </div>
      
      <div class="mobile-search-container">
        <div class="mobile-search-box">
          <span class="mobile-search-icon">🔍</span>
          <input type="text" id="mobileSearchInput" placeholder="Rechercher..." autocomplete="off">
          <span class="mobile-search-clear" id="mobileSearchClear" onclick="clearMobileSearch()">✕</span>
        </div>
      </div>
      
      <div class="mobile-search-results" id="mobileSearchResults">
        <div class="mobile-search-hint" id="mobileSearchHint">
          <div class="mobile-search-hint-icon">⏳</div>
          <div class="mobile-search-hint-text">
            Chargement des moulages...<br>
            Veuillez patienter
          </div>
        </div>
      </div>
      
      <div class="mobile-desktop-btn" onclick="switchToDesktopMode()">
        💻 Accéder à la version complète
      </div>
    </div>
    
    <!-- FICHE MOBILE AVEC SWIPE - 2 PAGES -->
    <div class="mobile-fiche-overlay" id="mobileFicheOverlay">
      <div class="mobile-fiche-header">
        <button class="mobile-fiche-back" onclick="closeMobileFiche()">
          ← Retour
        </button>
        <div class="mobile-fiche-title" id="mobileFicheTitle">Nom du moulage</div>
        <div class="mobile-fiche-order" id="mobileFicheOrder">#000000</div>
      </div>
      
      <div class="mobile-fiche-swipe-container" id="mobileFicheSwipeContainer">
        <div class="mobile-fiche-swipe-wrapper-2pages" id="mobileFicheSwipeWrapper">
          
          <!-- PAGE INFO (gauche - index 0) -->
          <div class="mobile-fiche-page mobile-page-info" id="mobilePageInfo">
            <!-- Contenu généré dynamiquement -->
          </div>
          
          <!-- PAGE NOTES (droite - index 1) -->
          <div class="mobile-fiche-page mobile-page-notes" id="mobilePageNotes">
            <!-- Section Photos 1-6 -->
            <div class="mobile-notes-photos-section" id="mobileNotesPhotos">
              <!-- Contenu généré dynamiquement -->
            </div>
            <textarea class="mobile-notes-textarea-full" id="mobileNotesTextarea" placeholder="Écrivez vos notes ici..."></textarea>
          </div>
          
        </div>
      </div>
      
      <div class="mobile-swipe-hint" id="mobileSwipeHint">
        <span class="mobile-swipe-hint-arrow">←</span>
        <span>Glissez pour Notes</span>
        <span class="mobile-swipe-hint-arrow">→</span>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', mobileHTML);
  
  // Initialiser les événements
  initMobileSearchEvents();
  initMobileSwipeEvents();
}

// Afficher l'écran d'accueil mobile
function showMobileHome() {
  const overlay = document.getElementById('mobileHomeOverlay');
  if (overlay) {
    overlay.classList.add('active');
    setTimeout(() => {
      const input = document.getElementById('mobileSearchInput');
      if (input) input.focus();
    }, 300);
  }
}

// Masquer l'écran d'accueil mobile
function hideMobileHome() {
  const overlay = document.getElementById('mobileHomeOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

// Basculer vers le mode desktop
function switchToDesktopMode() {
  hideMobileHome();
  closeMobileFiche();
  const appRoot = document.querySelector('.app-root');
  if (appRoot) appRoot.style.display = '';
}

// Initialiser les événements de recherche
function initMobileSearchEvents() {
  const input = document.getElementById('mobileSearchInput');
  const clearBtn = document.getElementById('mobileSearchClear');
  
  if (input) {
    input.addEventListener('input', function() {
      const query = this.value.trim();
      clearBtn.classList.toggle('visible', query.length > 0);
      performMobileSearch(query);
    });
  }
  
  // Afficher tous les moulages au démarrage
  setTimeout(() => {
    displayAllMobileCards();
  }, 500);
}

// Afficher toutes les cartes de moulages
function displayAllMobileCards() {
  const results = document.getElementById('mobileSearchResults');
  if (!results) return;
  
  const dataCount = Object.keys(cardsData).length;
  if (dataCount === 0) {
    results.innerHTML = `
      <div class="mobile-search-hint">
        <div class="mobile-search-hint-icon">⏳</div>
        <div class="mobile-search-hint-text">
          Chargement des données...<br>
          Veuillez patienter
        </div>
      </div>
    `;
    return;
  }
  
  // Trier par ordre alphabétique du nom de moulage
  const sortedCards = Object.entries(cardsData)
    .sort((a, b) => {
      const nameA = (a[1].name || '').toLowerCase();
      const nameB = (b[1].name || '').toLowerCase();
      return nameA.localeCompare(nameB, 'fr');
    });
  
  results.innerHTML = `
    <div class="mobile-cards-count">${dataCount} moulage${dataCount > 1 ? 's' : ''}</div>
    ${sortedCards.map(([cardId, card]) => createMobileCardHTML(cardId, card)).join('')}
  `;
}

// Créer le HTML d'une carte mobile
function createMobileCardHTML(cardId, card) {
  const regionClass = getMobileRegionClass(card.region);
  const daysInfo = calculateMobileDaysRemaining(card);
  
  return `
    <div class="mobile-card ${regionClass}" onclick="openMobileFiche('${cardId}')">
      <div class="mobile-card-name">${card.name || 'Sans nom'}</div>
      <div class="mobile-card-order">#${card.order || '000000'}</div>
      <div class="mobile-card-client">${card.client || '-'}</div>
      <div class="mobile-card-delay ${daysInfo.class}">${daysInfo.text}</div>
    </div>
  `;
}

// Calculer les jours restants pour mobile
function calculateMobileDaysRemaining(card) {
  if (!card.dateRobot) return { text: '-', class: '' };
  
  const joursRestants = calculerJoursRestants(card.dateRobot, card.region, card);
  
  if (joursRestants < 0) {
    return { text: `${Math.abs(joursRestants)}j retard`, class: 'retard' };
  } else if (joursRestants <= 14) {
    return { text: `${joursRestants}j`, class: 'urgent' };
  } else {
    return { text: `${joursRestants}j`, class: '' };
  }
}

// Obtenir la classe de région
function getMobileRegionClass(region) {
  if (!region) return 'region-qc';
  const r = region.toLowerCase();
  if (r.includes('ontario') || r.includes('on')) return 'region-on';
  if (r.includes('maritime') || r.includes('ma') || r.includes('nova') || r.includes('halifax')) return 'region-ma';
  return 'region-qc';
}

// Effacer la recherche
function clearMobileSearch() {
  const input = document.getElementById('mobileSearchInput');
  const clearBtn = document.getElementById('mobileSearchClear');
  
  if (input) input.value = '';
  if (clearBtn) clearBtn.classList.remove('visible');
  
  displayAllMobileCards();
}

// Effectuer la recherche mobile
function performMobileSearch(query) {
  const results = document.getElementById('mobileSearchResults');
  if (!results) return;
  
  const dataCount = Object.keys(cardsData).length;
  if (dataCount === 0) {
    results.innerHTML = `
      <div class="mobile-search-hint">
        <div class="mobile-search-hint-icon">⏳</div>
        <div class="mobile-search-hint-text">
          Chargement des données en cours...<br>
          Veuillez patienter quelques secondes
        </div>
      </div>
    `;
    return;
  }
  
  // Si pas de recherche, afficher tous les moulages
  if (query.length < 1) {
    displayAllMobileCards();
    return;
  }
  
  const queryLower = query.toLowerCase();
  const matches = [];
  
  // Rechercher dans toutes les cartes
  Object.entries(cardsData).forEach(([cardId, card]) => {
    const allFields = [
      card.name, card.order, card.client, card.intervenant,
      card.representant, card.numeroPO, card.numeroSoumission,
      card.region, card.item, card.notes
    ].filter(Boolean).map(f => String(f).toLowerCase());
    
    if (allFields.some(field => field.includes(queryLower))) {
      matches.push({ cardId, card });
    }
  });
  
  // Afficher les résultats
  if (matches.length === 0) {
    results.innerHTML = `
      <div class="mobile-no-results">
        <div class="mobile-no-results-icon">🔍</div>
        <div class="mobile-no-results-text">Aucun moulage trouvé pour "${query}"</div>
      </div>
    `;
    return;
  }
  
  // Trier les résultats par ordre alphabétique du nom
  matches.sort((a, b) => {
    const nameA = (a.card.name || '').toLowerCase();
    const nameB = (b.card.name || '').toLowerCase();
    return nameA.localeCompare(nameB, 'fr');
  });
  
  results.innerHTML = `
    <div class="mobile-cards-count">${matches.length} résultat${matches.length > 1 ? 's' : ''}</div>
    ${matches.map(({ cardId, card }) => createMobileCardHTML(cardId, card)).join('')}
  `;
}

// Ouvrir une fiche mobile
function openMobileFiche(cardId) {
  const card = cardsData[cardId];
  if (!card) return;
  
  currentMobileFicheId = cardId;
  mobileSwipeCurrentPage = 0; // Commencer sur Info (page 0)
  
  // Mettre à jour le header
  document.getElementById('mobileFicheTitle').textContent = card.name || 'Sans nom';
  document.getElementById('mobileFicheOrder').textContent = '#' + (card.order || '000000');
  
  // Générer le contenu des pages
  renderMobilePageInfo(card);
  renderMobilePageNotes(card);
  
  // Afficher la fiche
  document.getElementById('mobileFicheOverlay').classList.add('active');
  
  // Positionner sur la page Info (page 0)
  updateMobileSwipePosition2Pages(0, false);
  
  // Masquer le hint après 3 secondes
  setTimeout(() => {
    const hint = document.getElementById('mobileSwipeHint');
    if (hint) hint.style.opacity = '0';
  }, 3000);
  
  // Activer auto-save pour les notes
  setupMobileNotesAutoSave();
}

// Fermer la fiche mobile
function closeMobileFiche() {
  // Sauvegarder les notes avant de fermer
  const textarea = document.getElementById('mobileNotesTextarea');
  if (textarea && currentMobileFicheId && cardsData[currentMobileFicheId]) {
    cardsData[currentMobileFicheId].notes = textarea.value;
    saveCardToFirebase(currentMobileFicheId);
  }
  
  document.getElementById('mobileFicheOverlay').classList.remove('active');
  currentMobileFicheId = null;
  
  // Réafficher le hint pour la prochaine fois
  const hint = document.getElementById('mobileSwipeHint');
  if (hint) hint.style.opacity = '1';
  
  showMobileHome();
  
  // Rafraîchir la liste des cartes
  const input = document.getElementById('mobileSearchInput');
  if (!input || input.value.trim() === '') {
    displayAllMobileCards();
  } else {
    performMobileSearch(input.value.trim());
  }
}

// Générer la page Info
function renderMobilePageInfo(card) {
  const container = document.getElementById('mobilePageInfo');
  
  // Calculer le statut
  const colIndex = card.columnIndex || 0;
  const colNames = ['Robot', 'Dégauchage', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expédition', 'En attente'];
  const currentDept = colNames[colIndex] || 'Robot';
  const isAttente = colIndex === 7;
  const raisonAttente = card.raisonAttente || '';
  
  // Déterminer le texte du statut
  let article = 'À ';
  if (currentDept === 'Robot' || currentDept === 'Dégauchage') article = 'Au ';
  else if (currentDept === 'Atelier' || currentDept === 'Essayage') article = "À l'";
  else if (currentDept === 'Couture' || currentDept === 'Peinture' || currentDept === 'Expédition') article = 'À la ';
  else if (isAttente) article = '';
  
  const statutText = isAttente ? '⏳ EN ATTENTE' : `${article}${currentDept}`;
  const compteExpire = card.compteExpire || false;
  
  container.innerHTML = `
    <div class="mobile-info-card" style="flex: 1;">
      <!-- BLOC STATUT - Très visible -->
      <div class="mobile-status-block ${isAttente ? 'attente' : ''}">
        <div class="mobile-status-dept">${statutText}</div>
        ${isAttente && raisonAttente ? `<div class="mobile-status-raison">${raisonAttente}</div>` : ''}
      </div>
      
      <!-- Infos principales sur 2 colonnes -->
      <div class="mobile-info-row">
        <span class="mobile-info-label">👤 Nom</span>
        <span class="mobile-info-value" style="font-weight:700;">${card.name || '-'}</span>
      </div>
      <div class="mobile-info-row double">
        <div class="mobile-info-half">
          <span class="mobile-info-label">🔢 Cmd</span>
          <span class="mobile-info-value highlight">${card.order || '-'}</span>
        </div>
        <div class="mobile-info-half">
          <span class="mobile-info-label">📋 Soum.</span>
          <span class="mobile-info-value">${card.numeroSoumission || '-'}</span>
        </div>
      </div>
      <div class="mobile-info-row double">
        <div class="mobile-info-half">
          <span class="mobile-info-label">🏢 Client</span>
          <span class="mobile-info-value">${card.client || '-'}</span>
        </div>
        <div class="mobile-info-half">
          <span class="mobile-info-label">🗺️ Région</span>
          <span class="mobile-info-value">${card.region || '-'}</span>
        </div>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <div class="mobile-info-row double">
        <div class="mobile-info-half">
          <span class="mobile-info-label">👩‍⚕️ Interv.</span>
          <span class="mobile-info-value">${card.intervenant || '-'}</span>
        </div>
        <div class="mobile-info-half">
          <span class="mobile-info-label">👩‍💼 Rep.</span>
          <span class="mobile-info-value">${card.representant || '-'}</span>
        </div>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <div class="mobile-info-row double">
        <div class="mobile-info-half">
          <span class="mobile-info-label">📥 Reçue</span>
          <span class="mobile-info-value">${card.dateRecue || '-'}</span>
        </div>
        <div class="mobile-info-half">
          <span class="mobile-info-label">📦 Livr.</span>
          <span class="mobile-info-value highlight">${card.dateLivraison || '-'}</span>
        </div>
      </div>
      <div class="mobile-info-row double">
        <div class="mobile-info-half">
          <span class="mobile-info-label">🤖 Robot</span>
          <span class="mobile-info-value">${card.dateRobot || '-'}</span>
        </div>
        <div class="mobile-info-half">
          <span class="mobile-info-label">📅 Essay.</span>
          <span class="mobile-info-value">${card.dateEssayage || '-'}</span>
        </div>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <div class="mobile-info-row double">
        <div class="mobile-info-half">
          <span class="mobile-info-label">📑 PO</span>
          <span class="mobile-info-value">${card.numeroPO || '-'}</span>
        </div>
        <div class="mobile-info-half">
          <span class="mobile-info-label">📦 Item</span>
          <span class="mobile-info-value">${card.item || '-'}</span>
        </div>
      </div>
      
      <div class="mobile-section-divider"></div>
      
      <!-- BOUTONS PHOTOS - Pleine largeur -->
      <div class="mobile-photos-section">
        <div class="mobile-photos-grid">
          <div class="mobile-photo-btn-full ${card.photoClient ? 'has-photo' : ''}" onclick="openMobilePhotoLink('client')">
            📷 Photo Client ${card.photoClient ? '✓' : ''}
          </div>
          <div class="mobile-photo-btn-full ${card.photoAtelier ? 'has-photo' : ''}" onclick="openMobilePhotoLink('atelier')">
            📷 Photo Atelier ${card.photoAtelier ? '✓' : ''}
          </div>
          <div class="mobile-photo-btn-full ${card.photoDevis ? 'has-photo' : ''}" onclick="openMobilePhotoLink('devis')">
            📷 Devis/Modifications ${card.photoDevis ? '✓' : ''}
          </div>
        </div>
      </div>
      
      <!-- SLIDER COMPTE EXPIRÉ -->
      <div class="mobile-expire-section">
        <div class="mobile-expire-row">
          <span class="mobile-expire-label">⚠️ Compte expiré</span>
          <div class="mobile-expire-toggle ${compteExpire ? 'active' : ''}" onclick="toggleCompteExpire()"></div>
        </div>
      </div>
    </div>
  `;
}

// Toggle compte expiré
function toggleCompteExpire() {
  if (!currentMobileFicheId || !cardsData[currentMobileFicheId]) return;
  
  const card = cardsData[currentMobileFicheId];
  card.compteExpire = !card.compteExpire;
  saveCardToFirebase(currentMobileFicheId);
  
  // Mettre à jour le toggle visuellement
  const toggle = document.querySelector('.mobile-expire-toggle');
  if (toggle) {
    toggle.classList.toggle('active', card.compteExpire);
  }
  
  showToast(card.compteExpire ? 'Compte marqué expiré' : 'Compte non expiré');
}

// Générer la page Notes
function renderMobilePageNotes(card) {
  // Générer les 6 boutons photos (vert si vide, bleu si plein)
  const photosSection = document.getElementById('mobileNotesPhotos');
  if (photosSection) {
    photosSection.innerHTML = `
      <div class="mobile-notes-photos-row">
        <span class="mobile-photo-icon-notes">📷</span>
        <div class="mobile-photo-btn-notes ${card.photo1 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('photo1')">${card.photo1 ? '1 ✓' : '1'}</div>
        <div class="mobile-photo-btn-notes ${card.photo2 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('photo2')">${card.photo2 ? '2 ✓' : '2'}</div>
        <div class="mobile-photo-btn-notes ${card.photo3 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('photo3')">${card.photo3 ? '3 ✓' : '3'}</div>
        <div class="mobile-photo-btn-notes ${card.photo4 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('photo4')">${card.photo4 ? '4 ✓' : '4'}</div>
        <div class="mobile-photo-btn-notes ${card.photo5 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('photo5')">${card.photo5 ? '5 ✓' : '5'}</div>
        <div class="mobile-photo-btn-notes ${card.photo6 ? 'has-photo' : ''}" onclick="openMobilePhotoLink1to6('photo6')">${card.photo6 ? '6 ✓' : '6'}</div>
      </div>
    `;
  }
  
  // Notes
  const textarea = document.getElementById('mobileNotesTextarea');
  if (textarea) {
    textarea.value = card.notes || '';
  }
}

// Auto-save pour les notes mobile
function setupMobileNotesAutoSave() {
  const textarea = document.getElementById('mobileNotesTextarea');
  if (!textarea) return;
  
  // Variable pour éviter d'ajouter plusieurs fois le nom
  let signatureAdded = false;
  
  // Ajouter le nom de l'utilisateur quand on clique dans les notes
  textarea.addEventListener('focus', function onFocus() {
    if (signatureAdded) return;
    signatureAdded = true;
    
    const userName = currentUser ? (currentUser.name || currentUser.email.split('@')[0]) : 'Utilisateur';
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
    
    const existingNotes = textarea.value;
    const newNotes = existingNotes + (existingNotes && !existingNotes.endsWith('\n') ? '\n' : '') + signature + '\n';
    
    textarea.value = newNotes;
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    
    // Sauvegarder immédiatement
    if (currentMobileFicheId && cardsData[currentMobileFicheId]) {
      cardsData[currentMobileFicheId].notes = textarea.value;
      saveCardToFirebase(currentMobileFicheId);
    }
  }, { once: true });
  
  // Debounce pour éviter trop de sauvegardes
  let saveTimeout;
  textarea.addEventListener('input', () => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      if (currentMobileFicheId && cardsData[currentMobileFicheId]) {
        cardsData[currentMobileFicheId].notes = textarea.value;
        saveCardToFirebase(currentMobileFicheId);
      }
    }, 1000);
  });
}

// Ouvrir le lien photo (si existe)
function openMobilePhotoLink(photoType) {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  const photoKey = `photo${photoType.charAt(0).toUpperCase() + photoType.slice(1)}`;
  const photoUrl = card[photoKey];
  
  if (photoUrl) {
    window.open(photoUrl, '_blank');
  } else {
    alert('Aucun lien photo défini. Cliquez sur 📷 pour ajouter un lien.');
  }
}

// Menu pour ajouter les liens photos
function openMobilePhotoMenu() {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  
  const menuHTML = `
    <div class="mobile-photo-menu-overlay" id="mobilePhotoMenu" onclick="closeMobilePhotoMenu(event)">
      <div class="mobile-photo-menu" onclick="event.stopPropagation()">
        <div class="mobile-photo-menu-header">
          <span>📷 Liens Photos</span>
          <button onclick="closeMobilePhotoMenu()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">✕</button>
        </div>
        <div class="mobile-photo-menu-content">
          <div class="mobile-photo-menu-field">
            <label>👤 Client</label>
            <input type="url" id="photoClientInput" value="${card.photoClient || ''}" placeholder="URL de la photo client">
          </div>
          <div class="mobile-photo-menu-field">
            <label>🔧 Atelier</label>
            <input type="url" id="photoAtelierInput" value="${card.photoAtelier || ''}" placeholder="URL de la photo atelier">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📄 Devis/Modifs</label>
            <input type="url" id="photoDevisInput" value="${card.photoDevis || ''}" placeholder="URL du devis/modifs">
          </div>
        </div>
        <div class="mobile-photo-menu-actions">
          <button class="mobile-photo-save-btn" onclick="saveMobilePhotos()">💾 Sauvegarder</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', menuHTML);
}

function closeMobilePhotoMenu(event) {
  if (event && event.target.id !== 'mobilePhotoMenu') return;
  const menu = document.getElementById('mobilePhotoMenu');
  if (menu) menu.remove();
}

function saveMobilePhotos() {
  if (!currentMobileFicheId) return;
  
  const clientInput = document.getElementById('photoClientInput');
  const atelierInput = document.getElementById('photoAtelierInput');
  const devisInput = document.getElementById('photoDevisInput');
  
  if (clientInput) cardsData[currentMobileFicheId].photoClient = clientInput.value.trim();
  if (atelierInput) cardsData[currentMobileFicheId].photoAtelier = atelierInput.value.trim();
  if (devisInput) cardsData[currentMobileFicheId].photoDevis = devisInput.value.trim();
  
  saveCardToFirebase(currentMobileFicheId);
  closeMobilePhotoMenu({ target: { id: 'mobilePhotoMenu' } });
  renderMobilePageInfo(cardsData[currentMobileFicheId]);
}

// Ouvrir le lien photo 1-6
function openMobilePhotoLink1to6(photoKey) {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  const photoUrl = card[photoKey];
  
  if (photoUrl) {
    window.open(photoUrl, '_blank');
  } else {
    alert('Aucun lien défini. Cliquez sur 📷 pour ajouter des liens.');
  }
}

// Menu pour ajouter les liens photos 1-6
function openMobilePhotos1to6Menu() {
  if (!currentMobileFicheId) return;
  
  const card = cardsData[currentMobileFicheId];
  
  const menuHTML = `
    <div class="mobile-photo-menu-overlay" id="mobilePhotos1to6Menu" onclick="closeMobilePhotos1to6Menu(event)">
      <div class="mobile-photo-menu" onclick="event.stopPropagation()">
        <div class="mobile-photo-menu-header">
          <span>📷 Liens Photos 1-6</span>
          <button onclick="closeMobilePhotos1to6Menu()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#fff;">✕</button>
        </div>
        <div class="mobile-photo-menu-content">
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 1</label>
            <input type="url" id="photo1Input" value="${card.photo1 || ''}" placeholder="URL photo 1">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 2</label>
            <input type="url" id="photo2Input" value="${card.photo2 || ''}" placeholder="URL photo 2">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 3</label>
            <input type="url" id="photo3Input" value="${card.photo3 || ''}" placeholder="URL photo 3">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 4</label>
            <input type="url" id="photo4Input" value="${card.photo4 || ''}" placeholder="URL photo 4">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 5</label>
            <input type="url" id="photo5Input" value="${card.photo5 || ''}" placeholder="URL photo 5">
          </div>
          <div class="mobile-photo-menu-field">
            <label>📷 Photo 6</label>
            <input type="url" id="photo6Input" value="${card.photo6 || ''}" placeholder="URL photo 6">
          </div>
        </div>
        <div class="mobile-photo-menu-actions">
          <button class="mobile-photo-save-btn" onclick="saveMobilePhotos1to6()">💾 Sauvegarder</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', menuHTML);
}

function closeMobilePhotos1to6Menu(event) {
  if (event && event.target.id !== 'mobilePhotos1to6Menu') return;
  const menu = document.getElementById('mobilePhotos1to6Menu');
  if (menu) menu.remove();
}

function saveMobilePhotos1to6() {
  if (!currentMobileFicheId) return;
  
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById(`photo${i}Input`);
    if (input) {
      cardsData[currentMobileFicheId][`photo${i}`] = input.value.trim();
    }
  }
  
  saveCardToFirebase(currentMobileFicheId);
  closeMobilePhotos1to6Menu({ target: { id: 'mobilePhotos1to6Menu' } });
  renderMobilePageNotes(cardsData[currentMobileFicheId]);
}

// ===== GESTION DU SWIPE =====

let swipeStartX = 0;
let swipeCurrentX = 0;
let swipeIsDragging = false;

function initMobileSwipeEvents() {
  setTimeout(() => {
    const container = document.getElementById('mobileFicheSwipeContainer');
    if (!container) return;
    
    // Touch events
    container.addEventListener('touchstart', handleMobileSwipeStart, { passive: true });
    container.addEventListener('touchmove', handleMobileSwipeMove, { passive: false });
    container.addEventListener('touchend', handleMobileSwipeEnd);
    
    // Mouse events (pour tester sur desktop)
    container.addEventListener('mousedown', handleMobileSwipeStart);
    container.addEventListener('mousemove', handleMobileSwipeMove);
    container.addEventListener('mouseup', handleMobileSwipeEnd);
    container.addEventListener('mouseleave', handleMobileSwipeEnd);
  }, 500);
}

function handleMobileSwipeStart(e) {
  swipeIsDragging = true;
  swipeStartX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  swipeCurrentX = swipeStartX;
  
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.classList.add('dragging');
  }
}

function handleMobileSwipeMove(e) {
  if (!swipeIsDragging) return;
  
  swipeCurrentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
  const diff = swipeCurrentX - swipeStartX;
  
  let newOffset = (mobileSwipeCurrentPage * -50) + (diff / window.innerWidth * 50);
  newOffset = Math.max(-50, Math.min(0, newOffset));
  
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.style.transform = `translateX(${newOffset}%)`;
  }
  
  if (e.type === 'touchmove' && Math.abs(diff) > 10) {
    e.preventDefault();
  }
}

function handleMobileSwipeEnd(e) {
  if (!swipeIsDragging) return;
  swipeIsDragging = false;
  
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.classList.remove('dragging');
  }
  
  const diff = swipeCurrentX - swipeStartX;
  const threshold = window.innerWidth * 0.2;
  
  let newPage = mobileSwipeCurrentPage;
  
  if (diff > threshold && mobileSwipeCurrentPage > 0) {
    newPage = mobileSwipeCurrentPage - 1;
  } else if (diff < -threshold && mobileSwipeCurrentPage < 1) {
    newPage = mobileSwipeCurrentPage + 1;
  }
  
  goToMobilePage(newPage);
}

function goToMobilePage(pageIndex) {
  if (pageIndex < 0) pageIndex = 0;
  if (pageIndex > 1) pageIndex = 1;
  
  mobileSwipeCurrentPage = pageIndex;
  updateMobileSwipePosition2Pages(pageIndex, true);
}

// Position pour 2 pages (50% chaque)
function updateMobileSwipePosition2Pages(pageIndex, animate) {
  const wrapper = document.getElementById('mobileFicheSwipeWrapper');
  if (wrapper) {
    wrapper.style.transition = animate ? 'transform 0.3s ease-out' : 'none';
    wrapper.style.transform = `translateX(${pageIndex * -50}%)`;
  }
}

// Exposer les fonctions mobile globalement
window.isMobileDevice = isMobileDevice;
window.initMobileAfterLogin = initMobileAfterLogin;
window.switchToDesktopMode = switchToDesktopMode;
window.clearMobileSearch = clearMobileSearch;
window.openMobileFiche = openMobileFiche;
window.closeMobileFiche = closeMobileFiche;
window.toggleCompteExpire = toggleCompteExpire;
window.openMobilePhotoLink = openMobilePhotoLink;
window.openMobilePhotoMenu = openMobilePhotoMenu;
window.closeMobilePhotoMenu = closeMobilePhotoMenu;
window.saveMobilePhotos = saveMobilePhotos;
window.openMobilePhotoLink1to6 = openMobilePhotoLink1to6;
window.openMobilePhotos1to6Menu = openMobilePhotos1to6Menu;
window.closeMobilePhotos1to6Menu = closeMobilePhotos1to6Menu;
window.saveMobilePhotos1to6 = saveMobilePhotos1to6;

// ===== IMPORT/EXPORT & LOG FUNCTIONS =====
let logEntries = [];

function openImportExportMenu() {
  document.getElementById('importExportOverlay')?.classList.remove('hidden');
  document.getElementById('settingsOverlay')?.classList.add('hidden');
}

function closeImportExportMenu() {
  document.getElementById('importExportOverlay')?.classList.add('hidden');
}

function openLogMenu() {
  renderLogEntries();
  document.getElementById('logOverlay')?.classList.remove('hidden');
  document.getElementById('settingsOverlay')?.classList.add('hidden');
}

function closeLogMenu() {
  document.getElementById('logOverlay')?.classList.add('hidden');
}

// Fermer avec clic sur overlay
document.getElementById('importExportOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'importExportOverlay') closeImportExportMenu();
});
document.getElementById('logOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'logOverlay') closeLogMenu();
});

// Exporter TOUTES les données
function exportAllData() {
  const exportData = {
    version: 'PhysiPro_v2.18',
    exportDate: new Date().toISOString(),
    exportedBy: currentUser?.email || 'Anonyme',
    moulages: cardsData,
    logs: logEntries
  };
  
  downloadJSON(exportData, `physipro_backup_${formatDateForFilename()}.json`);
  addLogEntry('Export', 'Export complet effectué');
  alert('✅ Export complet effectué!\n\nFichier téléchargé avec toutes les données.');
}

// Exporter seulement les moulages
function exportMoulagesOnly() {
  const exportData = {
    version: 'PhysiPro_v2.18',
    exportDate: new Date().toISOString(),
    exportType: 'moulages_only',
    moulages: cardsData
  };
  
  downloadJSON(exportData, `physipro_moulages_${formatDateForFilename()}.json`);
  addLogEntry('Export', 'Export moulages effectué');
  alert('✅ Export des moulages effectué!');
}

// Télécharger JSON
function downloadJSON(data, filename) {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function formatDateForFilename() {
  const now = new Date();
  return now.toISOString().slice(0,10).replace(/-/g, '') + '_' + 
         now.toTimeString().slice(0,5).replace(':', '');
}

// Importer fichier
function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      if (!importedData.version || !importedData.version.startsWith('PhysiPro')) {
        alert('❌ Fichier invalide!\n\nCe fichier ne semble pas être un export PhysiPro valide.');
        return;
      }
      
      const confirmMsg = `⚠️ ATTENTION!\n\nVous êtes sur le point d'importer des données du ${new Date(importedData.exportDate).toLocaleString('fr-CA')}.\n\nCette action ajoutera les données importées.\n\nÊtes-vous sûr de vouloir continuer?`;
      
      if (!confirm(confirmMsg)) return;
      
      let importCount = 0;
      
      if (importedData.moulages) {
        Object.keys(importedData.moulages).forEach(cardId => {
          cardsData[cardId] = importedData.moulages[cardId];
          saveCardToFirebase(cardId);
          importCount++;
        });
      }
      
      loadCardsFromFirebase();
      addLogEntry('Import', `${importCount} moulages importés`);
      alert(`✅ Importation réussie!\n\n• ${importCount} moulages importés\n\nL'affichage a été rafraîchi.`);
      closeImportExportMenu();
      
    } catch (error) {
      console.error('Erreur d\'importation:', error);
      alert('❌ Erreur lors de l\'importation!\n\n' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}

// Log entries
function addLogEntry(action, details) {
  let userName = 'Anonyme';
  if (currentUser?.name) {
    userName = currentUser.name;
  } else if (currentUser?.email) {
    userName = currentUser.email.split('@')[0];
  }
  
  const entry = {
    time: new Date().toLocaleString('fr-CA'),
    user: userName,
    action,
    details
  };
  logEntries.unshift(entry);
  if (logEntries.length > 100) logEntries.pop();
}

function renderLogEntries() {
  const container = document.getElementById('logContent');
  if (!container) return;
  
  if (logEntries.length === 0) {
    container.innerHTML = '<div class="log-empty">Aucune activité enregistrée</div>';
    return;
  }
  
  container.innerHTML = logEntries.map(e => `
    <div class="log-entry">
      <div class="log-time">${e.time} - ${e.user}</div>
      <div><span class="log-action">${e.action}</span>: ${e.details}</div>
    </div>
  `).join('');
}

// Connecter les boutons settings
document.getElementById('btnImportExport')?.addEventListener('click', openImportExportMenu);
document.getElementById('btnArchives')?.addEventListener('click', openLogMenu);

// Exposer fonctions globalement
window.openImportExportMenu = openImportExportMenu;
window.closeImportExportMenu = closeImportExportMenu;
window.openLogMenu = openLogMenu;
window.closeLogMenu = closeLogMenu;
window.exportAllData = exportAllData;
window.exportMoulagesOnly = exportMoulagesOnly;
window.handleImportFile = handleImportFile;
</script>
</body>
</html>
