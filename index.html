<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PhysiPro Moulage – v188 – Split Layout</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
/* =============================================================================
   PHYSIPRO MOULAGE - FEUILLE DE STYLES v11.0
   Structure: Reset, Layout, Cartes, Menus, Fiches, Vue Robot, Commandes, Modals
============================================================================= */

/* -----------------------------------------------------------------------------
   RESET & BASE
----------------------------------------------------------------------------- */
html, body { margin: 0; padding: 0; }

.physiproRoot {
  min-height: 100vh;
  font-family: Arial, Helvetica, sans-serif;
  background: linear-gradient(to bottom, #0b1d36, #3f6eb8);
  background-attachment: fixed;
  color: #fff;
}

.app-shell {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* ===== TOP BAR ===== */
.topbar {
  flex: 0 0 auto;
  width: 100%;
  box-sizing: border-box;
  padding: 10px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(to bottom, #1a3a5c, #4a7ab8);
  box-shadow: 0 2px 6px rgba(0,0,0,0.45);
  position: relative;
}

.tb-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Boutons logo carrés */
.logo-btn {
  width: 62px;
  height: 62px;
  padding: 4px;
  border-radius: 8px;
  border: 2px solid rgba(255,255,255,0.3);
  background: linear-gradient(to bottom, #2a4a6c, #1a3050);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.logo-btn img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.logo-btn:hover {
  background: linear-gradient(to bottom, #3a5a7c, #2a4060);
  border-color: rgba(255,255,255,0.5);
  transform: scale(1.02);
}

.logo-btn.active {
  background: linear-gradient(to bottom, #4a7ab8, #3a6aa8);
  border-color: #60a5fa;
  box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
}

.hidden {
  display: none !important;
}

.tb-center {
  position: absolute;
  left: 50%;
  top: 46%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.top-title {
  font-size: 26px;
  white-space: nowrap;
  font-weight: 700;
  font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #fdfdfd;
  text-shadow: 0 2px 3px rgba(0,0,0,0.85);
}

.tb-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 12px;
}

.tb-right-top {
  display: flex;
  gap: 10px;
}

/* Boutons header */
.header-btn {
  padding: 6px 18px;
  font-size: 10px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.45);
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: #ffffff;
  cursor: pointer;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.18), 0 2px 4px rgba(0,0,0,0.7);
}

.header-btn:hover {
  background: linear-gradient(to bottom, #4a7fc9, #264170);
}

/* Zone auth */
.tb-right-bottom {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
}

.user-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
}

.user-status .status-dot.offline {
  background: #ef4444;
}

.auth-btn {
  padding: 4px 12px;
  font-size: 10px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.3);
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
  color: #fff;
  cursor: pointer;
}

.auth-btn.login {
  background: linear-gradient(to bottom, #22c55e, #15803d);
}

/* Zone recherche */
.top-search-row {
  position: absolute;
  left: 50%;
  bottom: 0;
  transform: translateX(-50%);
  width: 100%;
  display: flex;
  justify-content: center;
}

.search-box {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid #325f9b;
  background: rgba(2,11,24,0.55);
  box-shadow: 0 2px 4px rgba(0,0,0,0.55);
  width: 100%;
  max-width: 460px;
  margin-bottom: 2px;
}

.search-box input {
  flex: 1;
  padding: 3px 5px;
  font-size: 10px;
  border: none;
  background: transparent;
  color: #fff;
  outline: none;
}

.search-box input::placeholder {
  color: rgba(210,220,240,0.7);
}

.search-clear {
  padding: 0 8px;
  font-size: 11px;
  border: none;
  background: transparent;
  color: rgba(210,220,240,0.9);
  cursor: pointer;
}

/* ===== BOARD ===== */
.board-wrapper {
  flex: 1 1 auto;
  padding: 4px 0 16px;
  display: flex;
  justify-content: flex-start;
}

.boards-container {
  width: 100%;
}

.board {
  width: 100%;
  display: grid;
  grid-template-columns: repeat(8, minmax(0, 1fr));
  column-gap: 4px;
}

/* Board commandes - 6 colonnes égales pleine largeur */
.board.commandes-board {
  grid-template-columns: repeat(5, 1fr);
  column-gap: 8px;
  padding: 0 10px;
}

.board.commandes-board .col-cmd {
  min-width: 0;
}

/* ===== COLONNES ===== */
.col {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.colheader {
  position: relative;
  border-radius: 18px;
  padding: 6px 28px 6px 12px;
  text-align: center;
  font-weight: 700;
  font-size: 10px;
  color: #fff;
  box-shadow: 0 2px 3px rgba(0,0,0,0.8);
  border: 1px solid rgba(0,0,0,0.8);
  background: linear-gradient(to bottom, #2b5b99, #103561);
}

.colheader .col-count {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 22px;
  padding: 0 6px;
  border-radius: 0 17px 17px 0;
  background: linear-gradient(to bottom, #1a3a5c, #0d1f33);
  border-left: 1px solid rgba(100, 180, 255, 0.4);
  font-size: 11px;
  font-weight: 700;
}

/* Compteur colonnes commandes */
.colheader .col-count-cmd {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 22px;
  padding: 0 6px;
  border-radius: 0 17px 17px 0;
  background: linear-gradient(to bottom, #1a3a5c, #0d1f33);
  border-left: 1px solid rgba(100, 180, 255, 0.4);
  font-size: 11px;
  font-weight: 700;
}

.colheader.en-attente {
  background: linear-gradient(to bottom, #b81f1f, #6e0505);
}

.colheader.en-attente .col-count {
  background: linear-gradient(to bottom, #5c1a1a, #330d0d);
  border-left: 1px solid rgba(255, 100, 100, 0.4);
}

/* ===== CARTES COMPACTES ===== */
.mcard {
  position: relative;
  margin: 2px 3px;
  padding: 4px 8px 3px 8px;
  border-radius: 10px;
  background: linear-gradient(to bottom, #051020 0%, #0a1e38 35%, #5a8ac9 100%);
  border: 2px solid #000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  color: #fff;
  font-size: 8px;
  overflow: hidden;
}

/* Couleurs par région - dégradé métallique glossy */
.mcard.region-qc {
  background: linear-gradient(to bottom, #04152c 0%, #4a8ef5 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}
.mcard.region-on {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #000000;
}
.mcard.region-ma {
  background: linear-gradient(to bottom, #451238 0%, #8D2E6A 40%, #C7458C 100%);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #ffffff;
}

/* Couleurs par client - priorité sur région */
.mcard.client-vermeiren {
  background: linear-gradient(to bottom, #166534 0%, #22c55e 50%, #4ade80 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
}
.mcard.client-hme {
  background: linear-gradient(to bottom, #704414 0%, #E8B97A 100%) !important;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.16), 0 2px 6px rgba(0,0,0,0.35);
  color: #000000;
}
.mcard.client-france {
  background: linear-gradient(to bottom, #a16207 0%, #eab308 50%, #facc15 100%) !important;
}

/* Couleurs de réserve pour futures régions */
.mcard.region-extra1 {
  background: linear-gradient(to bottom, #1a0a1a 0%, #351535 30%, #b06ab0 100%);
}
.mcard.region-extra2 {
  background: linear-gradient(to bottom, #1a0a0a 0%, #351515 30%, #bf6a6a 100%);
}

/* Header carte: info gauche, bouton fiche droite */
.mcard-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 1px;
}

.mcard-info {
  width: 100%;
  text-align: center;
}

.mcard-title-line {
  width: 100%;
  text-align: center;
}

.mcard-title {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 1px;
  cursor: text;
  display: block;
  border: none;
  background: transparent;
  padding: 0;
  width: 100%;
  outline: none;
  font-family: inherit;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

/* Titre Ontario texte noir */
.mcard.region-on .mcard-title {
  color: #000000;
  text-shadow: none;
}

.mcard-title:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

.mcard-order-line {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #fff;
  position: relative;
  width: 100%;
}

/* Pastille région (Québec, Ontario, Maritime) */
.mcard-region-pill {
  position: absolute;
  left: 2px;
  background: rgba(255,255,255,0.25);
  color: #fff;
  font-size: 6px;
  font-weight: 700;
  padding: 2px 4px;
  border-radius: 3px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  text-align: center;
  line-height: 1.1;
}

/* Pastille région par couleur de carte */
.mcard.region-on .mcard-region-pill {
  color: #000000;
  text-shadow: none;
}

.mcard-order {
  cursor: text;
  border: none;
  background: transparent;
  color: #fff;
  font-size: 14px;
  font-family: inherit;
  font-weight: 600;
  padding: 0;
  width: 70px;
  outline: none;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  text-align: center;
}

/* Numéro de commande Ontario texte noir */
.mcard.region-on .mcard-order {
  color: #000000;
  text-shadow: none;
}

.mcard-order:focus {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  padding: 2px 4px;
  margin: -2px -4px;
}

/* Bouton toggle (ouvre fiche) - pastille à droite du numéro */
.mcard-toggle-btn {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  padding: 1px 6px;
  font-size: 7px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid #000;
  background: linear-gradient(to bottom, #6b7fa8, #4a5a7a);
  color: #fff;
  cursor: pointer;
  white-space: nowrap;
}

.mcard-toggle-btn:hover {
  transform: translateY(-50%) scale(1.05);
  filter: brightness(1.2);
}

/* Bouton fiche par région - couleurs métalliques */
.mcard.region-qc .mcard-toggle-btn {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
}
.mcard.region-on .mcard-toggle-btn {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #000000;
}
.mcard.region-ma .mcard-toggle-btn {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
}

/* Pastille délai - pleine largeur avec coins arrondis */
.mcard-delay-pill {
  width: 100%;
  padding: 1px 4px;
  font-size: 8px;
  font-weight: 700;
  border-radius: 999px;
  background: linear-gradient(to bottom, #4a6fa5, #2d4a6f);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #000;
  margin-top: 0px;
  margin-bottom: 2px;
  box-sizing: border-box;
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-shadow: 0 1px 1px rgba(0,0,0,0.3);
}

/* Pastille délai par région - couleurs métalliques */
.mcard.region-qc .mcard-delay-pill {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18);
  color: #ffffff;
}
.mcard.region-on .mcard-delay-pill {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18);
  color: #000000;
  text-shadow: none;
}
.mcard.region-ma .mcard-delay-pill {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18);
  color: #ffffff;
}

/* Séparateur entre haut et bas de la carte */
.mcard-separator {
  height: 1px;
  background: rgba(255,255,255,0.25);
  margin: 1px -8px 1px -8px;
}

.mcard-delay-pill.delay-warning {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
}

.mcard-delay-pill.delay-danger {
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
}

.mcard-delay-pill.retard {
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
  animation: pulse-retard 1s infinite;
}

@keyframes pulse-retard {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* En colonne En attente: pastille devient rouge avec "?" cliquable */
.mcard.in-attente-column .mcard-delay-pill {
  background: linear-gradient(to bottom, #dc2626, #b91c1c);
  cursor: pointer;
}

.mcard.in-attente-column .mcard-delay-pill:hover {
  filter: brightness(1.1);
}

/* Clignotement rouge quand une raison est sélectionnée */
.mcard.in-attente-column .mcard-delay-pill.attente-active {
  animation: blinkRed 0.8s infinite;
  background: #dc2626;
}

@keyframes blinkRed {
  0%, 49% { 
    background: #dc2626;
    box-shadow: none;
  }
  50%, 100% { 
    background: #ff0000;
    box-shadow: 0 0 4px #ff0000, 0 0 8px #ff0000;
  }
}

/* En colonne Expédition: pastille garde couleur région mais cliquable */
.mcard.in-expedition-column .mcard-delay-pill {
  cursor: pointer;
}

.mcard.in-expedition-column .mcard-delay-pill:hover {
  filter: brightness(1.1);
}

/* Une fois expédié: même couleur que délai mais avec texte "Expédié" */
.mcard .mcard-delay-pill.expedie {
  cursor: default !important;
  animation: none !important;
}

/* Expédié garde exactement la couleur de la région */
.mcard.region-qc .mcard-delay-pill.expedie {
  background: linear-gradient(to bottom, #4a8ef5, #04152c) !important;
}
.mcard.region-on .mcard-delay-pill.expedie {
  background: linear-gradient(to bottom, #E8B97A, #704414) !important;
  color: #000000 !important;
  text-shadow: none !important;
}
.mcard.region-ma .mcard-delay-pill.expedie {
  background: linear-gradient(to bottom, #C7458C, #451238) !important;
}

/* Boutons carte - pleine largeur avec coins arrondis */
.mcard-footer-buttons {
  display: flex;
  gap: 4px;
  margin-top: 1px;
}

.mcard-btn {
  flex: 1;
  padding: 1px 4px;
  font-size: 8px;
  font-weight: 600;
  border-radius: 999px;
  border: 1px solid #000;
  cursor: pointer;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
  line-height: 1;
  white-space: nowrap;
}

.mcard-btn:hover {
  filter: brightness(1.1);
}

.mcard-btn-move {
  background: linear-gradient(to bottom, #1e3a5f, #0f2744);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

/* Bouton déplacer par région - couleurs métalliques */
.mcard.region-qc .mcard-btn-move {
  background: linear-gradient(to bottom, #4a8ef5, #04152c);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
}
.mcard.region-on .mcard-btn-move {
  background: linear-gradient(to bottom, #E8B97A, #704414);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #000000;
}
.mcard.region-ma .mcard-btn-move {
  background: linear-gradient(to bottom, #C7458C, #451238);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
  color: #ffffff;
}

.mcard-btn-delete {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  box-shadow: inset 0 1px 1px rgba(255,255,255,0.18), 0 1px 2px rgba(0,0,0,0.6);
}

/* ===== MENU DE DÉPLACEMENT ===== */
.move-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.move-overlay.hidden {
  display: none;
}

.move-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 10px;
  max-width: 95%;
  width: 750px;
  box-sizing: border-box;
}

.move-title {
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.move-columns {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.move-column {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.move-column-header {
  background: linear-gradient(to bottom, #2b5b99, #103561);
  border-radius: 6px;
  padding: 4px 2px;
  text-align: center;
  font-weight: 700;
  font-size: 7px;
  color: #ffffff;
  border: 1px solid rgba(0,0,0,0.5);
}

.move-column-header.current {
  background: linear-gradient(to bottom, #059669, #047857);
}

.move-positions {
  display: flex;
  flex-direction: column;
  gap: 2px;
  max-height: 200px;
  overflow-y: auto;
}

.move-position-btn {
  background: linear-gradient(to bottom, #233d63, #12243f);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 4px;
  padding: 3px 2px;
  text-align: center;
  font-weight: 600;
  font-size: 8px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.15s;
}

.move-position-btn:hover {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  border-color: #3b82f6;
}

.move-footer {
  display: flex;
  justify-content: center;
  padding-top: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.move-btn-close {
  padding: 5px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  cursor: pointer;
  font-weight: 600;
  font-size: 10px;
  color: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Menu déplacement commandes - 6 colonnes */
.move-columns-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 6px;
  margin-bottom: 10px;
}

.move-col {
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: rgba(0,0,0,0.2);
  border-radius: 8px;
  padding: 6px;
}

.move-col.current-col {
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid #10b981;
}

.move-col-header {
  text-align: center;
  font-size: 9px;
  font-weight: 700;
  color: #fff;
  padding: 4px;
  background: linear-gradient(to bottom, #2b5b99, #103561);
  border-radius: 6px;
}

.move-col.current-col .move-col-header {
  background: linear-gradient(to bottom, #059669, #047857);
}

.move-col-count {
  text-align: center;
  font-size: 8px;
  color: rgba(255,255,255,0.7);
}

.move-col-positions {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  justify-content: center;
}

.move-pos-btn {
  width: 22px;
  height: 22px;
  border-radius: 4px;
  border: 1px solid rgba(255,255,255,0.2);
  background: linear-gradient(to bottom, #233d63, #12243f);
  color: #fff;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
}

.move-pos-btn:hover {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
}

.move-pos-btn.current {
  background: linear-gradient(to bottom, #10b981, #059669);
  cursor: default;
}

.move-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.move-delete-btn {
  padding: 6px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: #fff;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
}

.move-cancel-btn {
  padding: 6px 16px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: #fff;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
}

.move-btn-close:hover {
  filter: brightness(1.1);
}

/* ===== CONFIRMATION SUPPRESSION ===== */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.confirm-overlay.hidden {
  display: none;
}

.confirm-panel {
  background: linear-gradient(to bottom, #1a1a2e, #16213e);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  box-shadow: 0 8px 20px rgba(0,0,0,0.85);
  padding: 20px;
  text-align: center;
  max-width: 300px;
}

.confirm-title {
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
}

.confirm-message {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
  margin-bottom: 16px;
}

.confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.confirm-btn {
  padding: 8px 20px;
  border-radius: 999px;
  border: none;
  font-weight: 600;
  font-size: 11px;
  cursor: pointer;
  color: #fff;
}

.confirm-btn-yes {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.confirm-btn-no {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
}

.confirm-btn:hover {
  filter: brightness(1.1);
}

/* ===== VUE HORIZONTALE ROBOT ===== */
.robot-horizontal-container {
  flex: 1;
  width: 100%;
  padding: 15px;
  box-sizing: border-box;
  background: linear-gradient(to bottom, #1a3a5c, #4a7ab8);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.robot-horizontal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #04152c, #325f9b);
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
}

.robot-horizontal-header h2 {
  color: #fff;
  margin: 0;
  font-size: 18px;
}

.robot-horizontal-scroll {
  flex: 1;
  overflow: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
}

.robot-horizontal-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.robot-horizontal-table thead {
  position: sticky;
  top: 0;
  z-index: 100;
}

.robot-horizontal-table th {
  position: relative;
  background: linear-gradient(to bottom, #325f9b, #04152c);
  color: white;
  padding: 8px 6px;
  text-align: center;
  font-weight: 700;
  font-size: 10px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  white-space: nowrap;
  min-width: 80px;
  user-select: none;
}

.resize-handle {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 4px;
  cursor: col-resize;
  background: rgba(255, 255, 255, 0.1);
}

.resize-handle:hover {
  background: rgba(255, 255, 255, 0.3);
}

.robot-horizontal-table td {
  padding: 6px;
  border: 1px solid #e5e7eb;
  font-size: 10px;
  color: #1f2937;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
}

.robot-horizontal-table td.editable {
  cursor: text;
  background: white;
}

.robot-horizontal-table td.editable:hover {
  background: #f3f4f6;
}

.robot-horizontal-table td.editable:focus {
  outline: 2px solid #3b82f6;
  background: #dbeafe;
}

.robot-horizontal-table tbody tr:nth-child(even) {
  background: #f9fafb;
}

.robot-horizontal-table tbody tr:hover {
  background: #dbeafe;
}

.robot-cell-column {
  background: #93c5fd !important;
  text-align: center;
  font-weight: 700;
  color: #1e3a8a;
}

/* Menus déroulants dans la table */
.table-select {
  width: 100%;
  padding: 2px 4px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: white;
  cursor: pointer;
}

.table-select:focus {
  outline: 2px solid #3b82f6;
  border-color: #3b82f6;
}

.table-select-cell {
  padding: 2px !important;
}

/* Cellule notes */
.notes-cell {
  text-align: center;
  padding: 2px !important;
}

.notes-btn {
  padding: 4px 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  background: #f3f4f6;
  cursor: pointer;
}

.notes-btn:hover {
  background: #e5e7eb;
}

.notes-btn.has-notes {
  background: linear-gradient(to bottom, #fbbf24, #f59e0b);
  color: white;
  border-color: #d97706;
  animation: blink-notes 1s infinite;
}

@keyframes blink-notes {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Popup de notes */
.notes-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

/* Overlay Notes Moulage */
.moulage-notes-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 25000;
}

.moulage-notes-popup {
  background: white;
  border-radius: 10px;
  width: 450px;
  max-width: 95vw;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.moulage-notes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  color: white;
  border-radius: 10px 10px 0 0;
}

.moulage-notes-header h3 {
  margin: 0;
  font-size: 14px;
}

.moulage-notes-header button {
  padding: 4px 12px;
  font-size: 11px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 4px;
  cursor: pointer;
}

.moulage-notes-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
}

.existing-notes {
  background: #fffbeb;
  border: 1px solid #fcd34d;
  border-radius: 6px;
  padding: 8px;
  min-height: 80px;
  max-height: 200px;
  overflow-y: auto;
  font-size: 11px;
  margin-bottom: 12px;
}

.existing-notes .note-entry {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #e5e7eb;
}

.existing-notes .note-entry:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.existing-notes .note-signature {
  font-weight: 700;
  color: #1e40af;
  font-size: 10px;
}

.existing-notes .note-text {
  margin-top: 4px;
  color: #374151;
}

.new-note-section {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 6px;
  padding: 8px;
}

.note-signature-line {
  font-size: 10px;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 6px;
}

.new-note-section textarea {
  width: 100%;
  height: 60px;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
}

.moulage-notes-footer {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 12px;
  background: #f1f5f9;
  border-radius: 0 0 10px 10px;
}

.btn-save-note {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.btn-close-note {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.notes-popup {
  background: white;
  border-radius: 12px;
  padding: 16px;
  width: 400px;
  max-width: 90vw;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.notes-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.notes-popup-header h4 {
  margin: 0;
  font-size: 14px;
  color: #1f2937;
}

.notes-popup-close {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #6b7280;
}

.notes-popup-close:hover {
  color: #ef4444;
}

.notes-popup-text {
  width: 100%;
  height: 200px;
  padding: 10px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  resize: vertical;
  font-family: inherit;
}

.notes-popup-text:focus {
  outline: 2px solid #3b82f6;
  border-color: #3b82f6;
}

.notes-popup-buttons {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: flex-end;
}

.notes-popup-save {
  padding: 8px 16px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

.notes-popup-save:hover {
  background: #059669;
}

.notes-popup-cancel {
  padding: 8px 16px;
  background: #6b7280;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.notes-popup-cancel:hover {
  background: #4b5563;
}

/* Calendrier popup pour la table */
.table-calendar-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.table-calendar-popup {
  background: white;
  border-radius: 12px;
  padding: 16px;
  width: 280px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.table-calendar-header {
  text-align: center;
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 12px;
  color: #1f2937;
}

.table-cal-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.table-cal-nav button {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 10px;
  cursor: pointer;
}

.table-cal-nav button:hover {
  background: #2563eb;
}

.table-cal-month {
  font-weight: 600;
  font-size: 13px;
}

.table-cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 4px;
}

.table-cal-weekday {
  text-align: center;
  font-size: 10px;
  font-weight: 600;
  color: #6b7280;
  padding: 4px;
}

.table-cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.table-cal-day {
  text-align: center;
  padding: 6px;
  font-size: 11px;
  border-radius: 4px;
  cursor: pointer;
  background: #f3f4f6;
}

.table-cal-day:hover {
  background: #dbeafe;
}

.table-cal-day.today {
  background: #3b82f6;
  color: white;
  font-weight: 600;
}

.table-cal-day.selected {
  background: #10b981;
  color: white;
}

.table-cal-day.empty {
  background: transparent;
  cursor: default;
}

.table-cal-buttons {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: center;
}

.table-cal-buttons button {
  padding: 6px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
}

.table-cal-today {
  background: #3b82f6;
  color: white;
}

.table-cal-clear {
  background: #ef4444;
  color: white;
}

.table-cal-close {
  background: #6b7280;
  color: white;
}

/* Cellules de date cliquables dans la table */
.date-cell {
  cursor: pointer;
  text-align: center;
  background: #fef3c7 !important;
}

.date-cell:hover {
  background: #fde68a !important;
}

/* ===== FICHE MOULAGE (popup centré) ===== */
.card-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

.card-overlay.active {
  display: block;
}

.mcard.mcard-expanded {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
  width: 850px;
  height: 90vh;
  max-height: 90vh;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  overflow: hidden;
  display: flex;
}

/* Responsive pour mobile */
@media (max-width: 900px) {
  .mcard.mcard-expanded {
    width: 95vw;
    flex-direction: column;
    max-height: 85vh;
    overflow-y: auto;
  }
  
  .mcard.mcard-expanded .mcard-fiche {
    width: 100% !important;
    border-right: none !important;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .mcard.mcard-expanded .mcard-notes-page {
    width: 100% !important;
    min-height: 250px;
  }
}

.mcard.mcard-expanded .mcard-header,
.mcard.mcard-expanded .mcard-top-right,
.mcard.mcard-expanded .mcard-delay-pill,
.mcard.mcard-expanded .mcard-footer-buttons {
  display: none !important;
}

.mcard.mcard-expanded .mcard-toggle-btn {
  display: flex !important;
  background: linear-gradient(to bottom, #ff4444, #cc0000);
  position: absolute;
  top: 8px;
  right: 8px;
  bottom: auto;
  width: 20px;
  height: 20px;
  z-index: 10;
}

/* Contenu fiche - Page gauche */
.mcard-fiche {
  display: none;
  padding: 12px 14px;
  padding-bottom: 55px;
  width: 420px;
  flex-shrink: 0;
  border-right: 1px solid #e2e8f0;
  overflow-y: hidden;
  overflow-x: hidden;
  position: relative;
  box-sizing: border-box;
}

.mcard.mcard-expanded .mcard-fiche {
  display: block;
}

/* Page Notes - Page droite */
.mcard-notes-page {
  display: none;
  flex: 1;
  padding: 12px;
  background: #f8fafc;
  flex-direction: column;
  overflow: hidden;
}

.mcard.mcard-expanded .mcard-notes-page {
  display: flex;
}

.mcard-notes-page .notes-page-header {
  font-size: 13px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 2px solid #3b82f6;
  flex-shrink: 0;
  text-align: center;
}

/* 6 boutons photos sur une ligne */
.notes-photos-row {
  display: flex;
  gap: 4px;
  margin-bottom: 10px;
  flex-shrink: 0;
}

.notes-photo-btn {
  flex: 1;
  padding: 5px 2px;
  font-size: 8px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.notes-photo-btn:hover {
  background: #f3f4f6;
}

.notes-photo-btn.has-link {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border-color: #15803d;
}

.mcard-notes-page .notes-page-textarea {
  flex: 1;
  width: 100%;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.2;
  background: white;
}

/* Zone de liens photos */
.notes-photos-links {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  margin-bottom: 8px;
}

.photo-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.photo-link-row label {
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  width: 50px;
}

.photo-link-row input {
  flex: 1;
  padding: 4px 6px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

.save-photos-btn {
  margin-top: 6px;
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}

.save-photos-btn:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

.fiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
  padding-bottom: 4px;
  border-bottom: 1px solid #e2e8f0;
}

.fiche-header .fiche-logo img {
  height: 24px;
}

.fiche-header .fiche-title h3 {
  margin: 0;
  font-size: 11px;
  font-weight: 700;
  color: #0f172a;
}

.fiche-header .fiche-subtitle {
  font-size: 8px;
  color: #64748b;
}

.fiche-section {
  margin-bottom: 6px;
}

.fiche-section h4 {
  margin: 0 0 4px;
  font-size: 9px;
  font-weight: 700;
  color: #0f172a;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 2px;
}

.fiche-grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
}

.fiche-grid-3 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 4px;
}

.fiche-field {
  display: flex;
  flex-direction: column;
}

.fiche-label {
  font-size: 8px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 1px;
}

.fiche-input, .fiche-select {
  width: 100%;
  min-height: 20px;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  padding: 2px 4px;
  font-size: 9px;
  font-weight: 600;
  color: #1f2937;
  background: #fff;
  box-sizing: border-box;
}

.fiche-input:focus, .fiche-select:focus {
  outline: none;
  border-color: #3b82f6;
}

/* Pastille date cliquable */
.fiche-date-pill {
  width: 100%;
  min-height: 20px;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  padding: 2px 4px;
  font-size: 9px;
  background: #f0f9ff;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1e40af;
  font-weight: 500;
  cursor: pointer;
  box-sizing: border-box;
}

.fiche-date-pill:hover {
  background: #dbeafe;
  border-color: #3b82f6;
}

/* Calendrier popup visuel */
.fiche-calendar-popup {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  padding: 12px;
  z-index: 2000;
  min-width: 260px;
}

.fiche-calendar-popup.active {
  display: block;
}

.fiche-calendar-popup .cal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid #e2e8f0;
}

.fiche-calendar-popup .cal-title {
  font-size: 11px;
  font-weight: 700;
  color: #1e3a5f;
}

.fiche-calendar-popup .cal-nav {
  display: flex;
  align-items: center;
  gap: 8px;
}

.fiche-calendar-popup .cal-nav button {
  width: 24px;
  height: 24px;
  border: none;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
}

.fiche-calendar-popup .cal-month-year {
  font-size: 11px;
  font-weight: 600;
  color: #1e3a5f;
  min-width: 100px;
  text-align: center;
}

.fiche-calendar-popup .cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  margin-bottom: 4px;
}

.fiche-calendar-popup .cal-weekday {
  text-align: center;
  font-size: 8px;
  font-weight: 700;
  color: #64748b;
  padding: 4px 0;
}

.fiche-calendar-popup .cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.fiche-calendar-popup .cal-day {
  width: 32px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  border: none;
  background: #f8fafc;
  border-radius: 4px;
  cursor: pointer;
  color: #334155;
}

.fiche-calendar-popup .cal-day:hover {
  background: #dbeafe;
}

.fiche-calendar-popup .cal-day.other-month {
  color: #cbd5e1;
  background: transparent;
}

.fiche-calendar-popup .cal-day.today {
  background: #fef3c7;
  font-weight: 700;
  border: 1px solid #f59e0b;
}

.fiche-calendar-popup .cal-day.selected {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  font-weight: 700;
}

.fiche-calendar-popup .cal-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #e2e8f0;
}

.fiche-calendar-popup .cal-buttons button {
  padding: 6px 14px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.btn-today {
  background: linear-gradient(to bottom, #10b981, #059669);
  color: white;
}

.btn-close-cal {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Durées département */
.fiche-durations-photos {
  display: grid;
  grid-template-columns: 1fr 1px 1fr;
  gap: 6px;
  margin-top: 6px;
}

.fiche-center-bar {
  background: #e2e8f0;
}

.fiche-durations table {
  width: 100%;
  border-collapse: collapse;
  font-size: 8px;
}

.fiche-durations th, .fiche-durations td {
  padding: 3px 4px;
  border-bottom: 1px solid #f1f5f9;
}

.fiche-durations th {
  text-align: left;
  background: #f8fafc;
  font-weight: 600;
}

.dept-row {
  cursor: pointer;
}

.dept-row:hover {
  background: #f1f5f9;
}

/* Date cliquable sans pastille */
.dept-date-link {
  color: #1e40af;
  font-weight: 500;
  cursor: pointer;
  font-size: 8px;
}

.dept-date-link:hover {
  text-decoration: underline;
}

/* Jours passés */
.dept-days {
  font-weight: 600;
  color: #334155;
  font-size: 8px;
}

/* Popup dates département */
.dept-dates-popup {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  padding: 15px;
  z-index: 2000;
  min-width: 280px;
}

.dept-dates-popup.active {
  display: block;
}

.dept-dates-popup h4 {
  margin: 0 0 12px;
  font-size: 12px;
  font-weight: 700;
  text-align: center;
  color: #1e3a5f;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 8px;
}

.dept-date-field {
  margin-bottom: 10px;
}

.dept-date-field label {
  display: block;
  font-size: 10px;
  font-weight: 600;
  color: #1e3a5f;
  margin-bottom: 4px;
}

.dept-date-field input {
  width: 100%;
  padding: 6px;
  font-size: 10px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  box-sizing: border-box;
}

.dept-popup-buttons {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 10px;
}

.dept-popup-buttons button {
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-save {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
}

.btn-cancel {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Mini calendriers dans popup département */
.dept-cal-container {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 8px;
  margin-top: 4px;
}

.mini-cal-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.mini-cal-btn {
  width: 22px;
  height: 22px;
  border: none;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
}

.mini-cal-title {
  font-size: 10px;
  font-weight: 600;
  color: #1e3a5f;
}

.mini-cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
  margin-bottom: 4px;
}

.mini-cal-weekdays span {
  text-align: center;
  font-size: 7px;
  font-weight: 700;
  color: #64748b;
}

.mini-cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.mini-day {
  width: 24px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  background: #fff;
  border-radius: 3px;
  cursor: pointer;
  color: #334155;
}

.mini-day:hover {
  background: #dbeafe;
}

.mini-day.other {
  color: #cbd5e1;
  background: transparent;
  cursor: default;
}

.mini-day.today {
  background: #fef3c7;
  font-weight: 700;
  border: 1px solid #f59e0b;
}

.mini-day.selected {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  font-weight: 700;
}

/* Style ligne total */
.dept-total {
  border-top: 2px solid #94a3b8;
  font-weight: 700;
  background: #f1f5f9;
}

/* Section Durées - Une seule ligne pleine largeur */
.fiche-durations-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to right, #1e3a5f, #2d5a87);
  padding: 4px 6px;
  border-radius: 4px;
  gap: 2px;
}

.dur-item-line {
  font-size: 6px;
  color: white;
  white-space: nowrap;
}

.dur-item-line b {
  color: #fef08a;
  margin-right: 1px;
}

.dur-item-line .dept-date-link {
  color: #93c5fd;
  cursor: pointer;
  text-decoration: underline;
}

.dur-total-line {
  background: #f59e0b;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 700;
}

.dur-total-line b {
  color: white;
}

/* Section Photos - Ligne avec titre et 3 pastilles */
.fiche-photos-line {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 0;
}

.photos-title {
  font-size: 8px;
  font-weight: 700;
  color: #7c3aed;
  cursor: pointer;
  padding: 3px 6px;
  background: #f3e8ff;
  border-radius: 4px;
}

/* ===== SECTION DURÉES - Design horizontal propre ===== */
.fiche-durations-section {
  display: flex;
  align-items: stretch;
  gap: 0;
  margin: 8px 0 6px 0;
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  overflow: hidden;
}

.dur-item {
  flex: 1;
  text-align: center;
  padding: 8px 2px;
  background: white;
  border-right: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 0;
}

.dur-item:last-child {
  border-right: none;
}

.dur-item.dur-date {
  flex: 1.4;
}

.dur-item-label {
  font-size: 6px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.2px;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dur-item-value {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  white-space: nowrap;
}

.dur-item-value.clickable {
  font-size: 9px;
  color: #3b82f6;
  cursor: pointer;
  text-decoration: underline;
}

.dur-item-value.clickable:hover {
  color: #1d4ed8;
}

.dur-item.total {
  background: linear-gradient(to bottom, #1e40af, #3b82f6);
  flex: 1;
}

.dur-item.total .dur-item-label {
  color: rgba(255,255,255,0.8);
}

.dur-item.total .dur-item-value {
  color: white;
  font-size: 13px;
}

/* ===== SECTION PHOTOS - Plus bas et espacée ===== */
.fiche-photos-section {
  margin: 8px 0 5px 0;
  padding: 8px 10px;
  background: #faf5ff;
  border: 1px solid #e9d5ff;
  border-radius: 8px;
}

.photos-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.photos-label {
  font-size: 11px;
  font-weight: 700;
  color: #7c3aed;
  cursor: pointer;
  white-space: nowrap;
}

.photo-btn {
  flex: 1;
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 600;
  background: white;
  color: #374151;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.photo-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.photo-btn.has-link {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border-color: #15803d;
}

/* Popup Photos menu avec 3 liens */
.photos-menu-popup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border: 2px solid #7c3aed;
  border-radius: 8px;
  padding: 12px;
  z-index: 100;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  width: 280px;
}

.photos-menu-header {
  font-size: 12px;
  font-weight: 700;
  color: #7c3aed;
  text-align: center;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid #e2e8f0;
}

.photos-menu-field {
  margin-bottom: 8px;
}

.photos-menu-field label {
  display: block;
  font-size: 9px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 2px;
}

.photos-menu-field input {
  width: 100%;
  padding: 6px 8px;
  font-size: 9px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  box-sizing: border-box;
}

.photos-menu-btns {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 10px;
}

.photos-menu-btns button {
  padding: 6px 14px;
  font-size: 10px;
  font-weight: 600;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.photos-menu-btns button:first-child {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
}

.photos-menu-btns button:last-child {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
}

/* Section Notes - Zone expandable */
.fiche-notes-zone {
  position: relative;
}

.fiche-notes-simple {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 6px;
  transition: all 0.3s ease;
}

.fiche-notes-simple:hover {
  background: linear-gradient(to bottom, #4a7dc9, #2a4a70);
}

.notes-text-center {
  font-size: 11px;
  font-weight: 700;
  color: white;
}

.notes-text-center.has-notes {
  animation: blink-notes-text 1s infinite;
}

@keyframes blink-notes-text {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Zone Notes expandée - Couvre TOUTE la fiche */
.fiche-notes-expanded {
  position: absolute;
  top: 45px;
  left: 0;
  right: 0;
  bottom: 35px;
  background: white;
  border: 2px solid #3f6eb8;
  border-radius: 6px;
  z-index: 200;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.fiche-notes-expanded .notes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  flex-shrink: 0;
}

.fiche-notes-expanded .notes-header span {
  font-size: 10px;
  font-weight: 700;
}

.fiche-notes-expanded .notes-header button {
  padding: 4px 12px;
  font-size: 10px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 3px;
  cursor: pointer;
}

.fiche-notes-expanded .notes-body {
  flex: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.fiche-notes-expanded .notes-signature {
  font-size: 10px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 6px;
  flex-shrink: 0;
}

.fiche-notes-expanded textarea {
  flex: 1;
  width: 100%;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.4;
}

.fiche-notes-expanded .notes-history {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px dashed #e2e8f0;
  font-size: 9px;
  color: #374151;
  max-height: 80px;
  overflow-y: auto;
  flex-shrink: 0;
}

.fiche-notes-expanded .note-entry {
  margin-bottom: 6px;
  padding-bottom: 6px;
  border-bottom: 1px dotted #e5e7eb;
}

.fiche-notes-expanded .note-entry:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.fiche-notes-expanded .note-entry .note-signature {
  font-weight: 700;
  color: #1e40af;
  font-size: 8px;
}

.fiche-notes-expanded .note-entry .note-text {
  margin-top: 2px;
  color: #374151;
}

/* Section En attente */
/* ===== SECTION EN ATTENTE - Pastille pleine largeur ===== */
.fiche-attente-section {
  display: none;
  flex-direction: column;
  width: 100%;
  margin: 10px 0;
  box-sizing: border-box;
}

.fiche-attente-section.visible {
  display: flex !important;
}

.attente-badge-full {
  display: block;
  width: 100%;
  background: #dc2626;
  color: #ffffff;
  padding: 8px 12px;
  border-radius: 6px 6px 0 0;
  font-size: 11px;
  font-weight: 700;
  text-align: center;
  box-sizing: border-box;
  animation: blink-attente 1.5s ease-in-out infinite;
}

.attente-days-full {
  display: block;
  width: 100%;
  background: #fee2e2;
  color: #b91c1c;
  padding: 6px 12px;
  border-radius: 0 0 6px 6px;
  font-size: 10px;
  font-weight: 600;
  text-align: center;
  border: 2px solid #dc2626;
  border-top: none;
  box-sizing: border-box;
}

@keyframes blink-attente {
  0%, 100% { background: #dc2626; }
  50% { background: #ef4444; }
}

.attente-raison {
  font-weight: 400;
}

.fiche-notes-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.fiche-notes textarea {
  width: 100%;
  min-height: 40px;
  border: 1px solid #cbd5e1;
  border-radius: 3px;
  padding: 4px;
  font-size: 8px;
  resize: vertical;
  box-sizing: border-box;
  cursor: pointer;
}

.fiche-notes.expanded {
  position: absolute;
  top: 45px;
  left: 0;
  right: 0;
  bottom: -30px;
  margin: 0;
  background: #fff;
  z-index: 200;
  display: flex;
  flex-direction: column;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 12px;
  box-sizing: border-box;
}

.fiche-notes.expanded .fiche-notes-header {
  margin-bottom: 8px;
}

.fiche-notes.expanded .fiche-notes-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.fiche-notes.expanded textarea {
  flex: 1;
  min-height: 0 !important;
  resize: none;
  cursor: text;
  font-size: 10px;
  margin-bottom: 10px;
  font-family: "Segoe UI", system-ui, sans-serif;
  line-height: 1.4;
}

.fiche-notes-close-bottom {
  display: none;
  padding: 8px 20px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #ef4444, #b91c1c);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  align-self: flex-end;
  flex-shrink: 0;
}

.fiche-notes.expanded .fiche-notes-close-bottom {
  display: block;
}

/* Boutons Notes et Fermer en bas de la fiche */
.fiche-footer-btns {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 8px;
  padding: 10px 12px;
  background: linear-gradient(to top, #f1f5f9, #f8fafc);
  border-top: 1px solid #e2e8f0;
}

.fiche-notes-btn {
  flex: 1;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
}

.fiche-notes-btn:hover {
  background: linear-gradient(to bottom, #7c8591, #5c6574);
}

.fiche-notes-btn.has-notes {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
  animation: blink-notes-btn 1s infinite;
}

@keyframes blink-notes-btn {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.fiche-close-btn-right {
  flex: 1;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}

.fiche-close-btn-right:hover {
  background: linear-gradient(to bottom, #4a7dc9, #2a4a70);
}

/* Ancien bouton fermer (compatibilité) */
.fiche-close-btn {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 5px 12px;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
}

/* Overlay Notes Moulage - Pleine zone */
.moulage-notes-overlay {
  position: absolute;
  top: 45px;
  left: 0;
  right: 0;
  bottom: 35px;
  background: white;
  border: 2px solid #3f6eb8;
  border-radius: 6px;
  z-index: 200;
  display: none;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
}

.moulage-notes-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.moulage-notes-signature {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 8px;
  text-align: center;
  flex-shrink: 0;
}

.moulage-notes-textarea {
  flex: 1;
  width: 100%;
  padding: 10px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
  line-height: 1.5;
}

/* ===== FICHE COMMANDE (2 pages split) ===== */
.cmd-fiche-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  justify-content: center;
  align-items: flex-start;
  padding: 2mm 3mm 4mm 3mm;
}

.cmd-fiche-overlay.active {
  display: flex;
}

/* Container split pour 2 pages côte à côte */
.cmd-fiche-container-split {
  display: flex;
  gap: 0;
  width: calc(100vw - 6mm);
  height: calc(100vh - 6mm);
}

/* Wrapper gauche avec onglets */
.cmd-left-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Wrapper droite */
.cmd-right-wrapper {
  flex: 2;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Container des onglets en haut */
.cmd-tabs-container {
  display: flex;
  gap: 2px;
  height: 24px;
  align-items: flex-end;
}

/* Espace pour aligner la page de droite */
.cmd-tabs-spacer {
  height: 24px;
}

/* Onglet style dossier */
.cmd-tab {
  padding: 4px 14px;
  font-size: 9px;
  font-weight: 600;
  border-radius: 6px 6px 0 0;
  cursor: pointer;
  border: 2px solid #1e3a5f;
  border-bottom: none;
}

.cmd-tab.tab-info {
  background: linear-gradient(to bottom, #e0e7ff, #c7d2fe);
  color: #1e3a5f;
}

.cmd-tab.tab-info:hover {
  background: linear-gradient(to bottom, #c7d2fe, #a5b4fc);
}

.cmd-tab.tab-info.active {
  background: #fff;
  color: #1e3a5f;
}

.cmd-tab.tab-magasin {
  background: linear-gradient(to bottom, #dcfce7, #bbf7d0);
  color: #166534;
}

.cmd-tab.tab-magasin:hover {
  background: linear-gradient(to bottom, #bbf7d0, #86efac);
}

.cmd-tab.tab-magasin.active {
  background: #fff;
  color: #166534;
}

/* Page gauche (1/3) */
.cmd-fiche-page-third {
  flex: 1;
  overflow: hidden;
  background: #fff;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  border-right: 2px solid #1e3a5f;
}

/* Contenu des onglets */
.cmd-tab-content {
  display: none;
  flex: 1;
  overflow: hidden;
  flex-direction: column;
}

.cmd-tab-content.active {
  display: flex;
}

/* Champs info dans l'onglet Information */
.cmd-info-body {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px;
}

.cmd-info-row {
  display: flex;
  gap: 8px;
}

.cmd-info-field {
  display: flex;
  flex-direction: column;
  gap: 3px;
  flex: 1;
}

.cmd-info-field.half {
  flex: 1;
}

.cmd-info-field label {
  font-size: 8px;
  font-weight: 600;
  color: #64748b;
}

.cmd-info-field input,
.cmd-info-field select {
  font-size: 10px;
  padding: 6px 8px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
}

.cmd-info-field .cmd-fiche-date-pill {
  font-size: 10px;
  padding: 6px 8px;
  background: #e0e7ff;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

/* Section Délai - Affichage professionnel */
.cmd-delai-section {
  margin-top: 8px;
  padding: 10px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.cmd-delai-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.cmd-delai-title {
  font-size: 9px;
  font-weight: 700;
  color: #1e3a5f;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cmd-delai-badge {
  font-size: 8px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 12px;
  color: white;
}

.cmd-delai-badge.urgent {
  background: linear-gradient(135deg, #ff4444, #cc0000);
  animation: pulse 1s infinite;
}

.cmd-delai-badge.warning {
  background: linear-gradient(135deg, #ffaa00, #ff8800);
}

.cmd-delai-badge.ok {
  background: linear-gradient(135deg, #00dd00, #00aa00);
}

.cmd-delai-badge.passed {
  background: linear-gradient(135deg, #9333ea, #7c3aed);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.cmd-delai-progress {
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 6px;
}

.cmd-delai-progress-bar {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.cmd-delai-progress-bar.urgent {
  background: linear-gradient(90deg, #ff4444, #cc0000);
}

.cmd-delai-progress-bar.warning {
  background: linear-gradient(90deg, #ffaa00, #ff8800);
}

.cmd-delai-progress-bar.ok {
  background: linear-gradient(90deg, #00dd00, #00aa00);
}

.cmd-delai-progress-bar.passed {
  background: linear-gradient(90deg, #9333ea, #7c3aed);
}

.cmd-delai-info {
  display: flex;
  justify-content: space-between;
  font-size: 7px;
  color: #64748b;
}

.cmd-delai-days {
  font-size: 18px;
  font-weight: 800;
  text-align: center;
  margin: 4px 0;
}

.cmd-delai-days.urgent {
  color: #cc0000;
}

.cmd-delai-days.warning {
  color: #ff8800;
}

.cmd-delai-days.ok {
  color: #00aa00;
}

.cmd-delai-days.passed {
  color: #7c3aed;
}

.cmd-delai-label {
  font-size: 8px;
  color: #64748b;
  text-align: center;
}

/* Page droite (2/3) */
.cmd-fiche-page-twothirds {
  flex: 1;
  overflow: hidden;
  background: #fff;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  display: flex;
  flex-direction: column;
}

/* Responsive pour mobile - empilé */
@media (max-width: 700px) {
  .cmd-fiche-container-split {
    flex-direction: column;
    gap: 5px;
    overflow: hidden;
  }
  
  .cmd-fiche-page-third,
  .cmd-fiche-page-twothirds {
    width: 100%;
    min-width: unset;
    max-width: unset;
    height: auto;
    min-height: 300px;
    border-radius: 8px;
    border-right: none;
  }
}

/* Container ancien (pour compatibilité) */
.cmd-fiche-container {
  display: flex;
  gap: 0;
  width: calc(100vw - 2cm);
  height: calc(100vh - 2cm);
}

/* Chaque page ancienne */
.cmd-fiche-page {
  width: 420px;
  height: 100%;
  overflow: hidden;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  color: #111;
  font-family: "Segoe UI", system-ui, sans-serif;
  position: relative;
  display: flex;
  flex-direction: column;
}

.cmd-fiche-page .cmd-fiche-body,
.cmd-fiche-page-third .cmd-fiche-body,
.cmd-fiche-page-twothirds .cmd-fiche-body {
  flex: 1;
  overflow: hidden;
}

/* Boutons Notes/Fermer toujours en bas */
.cmd-fiche-footer-btns {
  display: flex;
  gap: 8px;
  padding: 6px 10px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  margin-top: auto;
}

.cmd-notes-btn {
  flex: 1;
  padding: 6px 10px;
  font-size: 9px;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.cmd-close-btn {
  padding: 6px 16px;
  font-size: 9px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
}

.cmd-fiche-page:first-child {
  border-radius: 8px 0 0 8px;
}

.cmd-fiche-page:nth-child(2) {
  border-left: 1px solid #d1d5db;
  border-radius: 0;
}

.cmd-fiche-page:last-child {
  border-left: 1px solid #d1d5db;
  border-radius: 0 8px 8px 0;
}

/* Ancien style pour compatibilité - DÉSACTIVÉ quand contient 3 pages */
.cmd-fiche {
  background: transparent;
  border-radius: 0;
  width: auto;
  max-width: none;
  max-height: none;
  overflow: visible;
  box-shadow: none;
  position: relative;
  font-family: "Segoe UI", system-ui, sans-serif;
}

.cmd-fiche-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2px;
  padding: 6px 12px 4px 12px;
  border-bottom: 1px solid #e2e8f0;
}

.cmd-fiche-logo {
  flex-shrink: 0;
}

.cmd-fiche-logo img {
  height: 28px;
  width: auto;
}

.cmd-fiche-title {
  flex: 1;
  text-align: center;
}

.cmd-fiche-title h3 {
  margin: 0;
  font-size: 12px;
  font-weight: 700;
  color: #0f172a;
}

.cmd-fiche-title .subtitle {
  font-size: 8px;
  color: #64748b;
}

.cmd-fiche-body {
  padding: 4px 12px 35px 12px;
}

.cmd-fiche-section {
  margin-bottom: 6px;
}

.cmd-fiche-section h4 {
  margin: 0 0 4px 0;
  font-size: 11px;
  font-weight: 700;
  color: #0f172a;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 2px;
}

.cmd-fiche-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin-bottom: 8px;
}

.cmd-fiche-field {
  display: flex;
  flex-direction: column;
}

.cmd-fiche-field label {
  font-size: 10px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 2px;
}

.cmd-fiche-field input,
.cmd-fiche-field select {
  width: 100%;
  min-height: 26px;
  padding: 4px 6px;
  font-size: 11px;
  font-weight: 600;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  box-sizing: border-box;
  background: #fff;
}

.cmd-fiche-date-pill {
  width: 100%;
  min-height: 26px;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 11px;
  background: #f0f9ff;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #1e40af;
  font-weight: 700;
  cursor: pointer;
  box-sizing: border-box;
}

.cmd-fiche-separator {
  height: 1px;
  background: #e5e7eb;
  margin: 6px 0;
}

/* Section département unique par page - ULTRA COMPACT */
.cmd-department-single {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  padding: 4px;
}

/* Section Atelier/Couture côte à côte (ancien) */
.cmd-departments-container {
  display: flex;
  gap: 4px;
}

.cmd-department {
  flex: 1;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  padding: 4px;
  min-width: 0;
}

.cmd-department-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2px;
  padding-bottom: 2px;
  border-bottom: 1px solid #e2e8f0;
}

.cmd-department-title {
  font-size: 8px;
  font-weight: 700;
  color: #1f2937;
  flex: 1;
  text-align: center;
}

.cmd-dept-add-item {
  padding: 2px 6px;
  font-size: 7px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

/* Bouton + Item dans le header par-dessus le titre */
.cmd-add-item-header {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 3px 8px;
  font-size: 8px;
  font-weight: 700;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  white-space: nowrap;
  z-index: 5;
}

.cmd-add-item-header:hover {
  background: linear-gradient(to bottom, #2563eb, #1d4ed8);
}

/* Items container - avec scroll si trop d'items */
.cmd-items-list {
  display: flex;
  flex-direction: column;
  gap: 3px;
  max-height: 500px;
  overflow-y: auto;
}

/* ========================================
   PAGES 2 & 3 - TABLEAU ITEMS
   Vrai tableau avec 3 sections: Atelier | Couture | Inspection
   PASTILLES COMPACTES 12px - ESPACEMENT UNIFORME
   ======================================== */

/* Container principal du tableau */
.cmd-table-container {
  width: 100%;
  overflow-x: auto;
  padding: 4px;
}

/* Le tableau principal - ESPACEMENT UNIFORME 2px */
.cmd-items-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 2px;
  font-size: 8px;
  table-layout: fixed;
}

/* En-têtes de sections (Atelier, Couture, Inspection) */
.cmd-items-table th.section-header {
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 4px;
  text-align: center;
  height: 16px;
}

.cmd-items-table th.section-header.atelier {
  border-right: 3px solid #1e3a5f;
}

.cmd-items-table th.section-header.couture {
  border-right: 3px solid #1e3a5f;
}

/* En-têtes de colonnes */
.cmd-items-table th.col-header {
  background: #e2e8f0;
  color: #1f2937;
  font-size: 7px;
  font-weight: 700;
  padding: 0;
  text-align: center;
  white-space: nowrap;
  height: 12px;
  line-height: 12px;
}

/* Largeurs des colonnes - ÉQUILIBRÉES */
.cmd-items-table .col-plus { width: 12px; }
.cmd-items-table .col-item { width: 44px; }
.cmd-items-table .col-qty { width: 20px; }
.cmd-items-table .col-total { width: 28px; }
.cmd-items-table .col-status { width: 34px; }
.cmd-items-table .col-emp { width: 30px; }
.cmd-items-table .col-notes { width: 22px; }
.cmd-items-table .col-exped { width: 180px; }
.cmd-items-table .col-x { width: 6px; text-align: right; }

.cmd-items-table th.col-header.border-right,
.cmd-items-table td.border-right {
  border-right: 3px solid #1e3a5f;
}

/* Bordures PLEINES entre sections */
.cmd-items-table th.col-header.border-right-solid,
.cmd-items-table td.border-right-solid {
  border-right: 3px solid #1e3a5f !important;
}

/* Cellules du tableau */
.cmd-items-table td {
  padding: 0;
  text-align: center;
  vertical-align: middle;
  height: 12px;
}

/* Ligne d'item */
.cmd-items-table tr.item-row td {
  background: transparent;
  height: 14px;
}

/* Ligne de grandeur */
.cmd-items-table tr.grandeur-row td {
  background: white;
  height: 12px;
}

.cmd-items-table tr.grandeur-row:hover td {
  background: #f8fafc;
}

/* ========================================
   PASTILLES COMPACTES - TOUTES 12px HAUTEUR
   LARGEURS FIXES IDENTIQUES
   ======================================== */

/* Bouton + Item dans le header - VERT */
.cmd-table-add-item-green {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 2px;
  width: 100%;
  height: 12px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

.cmd-table-add-item-green:hover {
  background: linear-gradient(to bottom, #16a34a, #15803d);
}

/* Bouton + Item dans le header (ancien bleu) */
.cmd-table-add-item {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 2px;
  width: 18px;
  height: 12px;
  font-size: 7px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

/* Bouton + Grandeur */
.cmd-table-add-grandeur {
  width: 12px;
  height: 12px;
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 2px;
  font-size: 8px;
  font-weight: 700;
  cursor: pointer;
  padding: 0;
  line-height: 12px;
}

/* Bouton supprimer */
.cmd-table-delete {
  width: 12px;
  height: 12px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 8px;
  cursor: pointer;
  padding: 0;
  line-height: 10px;
}

/* Pastille Item (bleue foncée) - LARGEUR FIXE 55px */
.cmd-table-item-pill {
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  font-weight: 600;
  cursor: pointer;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

/* Pastille Grandeur - BLANC avec texte noir */
.cmd-table-grandeur-pill {
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  font-weight: 600;
  cursor: pointer;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Quantité totale item - BLANC avec texte noir */
.cmd-table-item-qty {
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 8px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  line-height: 12px;
  box-sizing: border-box;
}

/* Nom item readonly */
.cmd-table-item-name {
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

/* Grandeur readonly - BLANC avec texte noir */
.cmd-table-grandeur-readonly {
  font-size: 7px;
  font-weight: 600;
  color: #1f2937;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Quantité readonly - BLANC */
.cmd-table-qty-readonly {
  font-size: 8px;
  font-weight: 600;
  color: #1f2937;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 12px;
  box-sizing: border-box;
}

/* Input quantité - SANS FLECHES */
.cmd-table-qty-input {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 8px;
  font-weight: 600;
  padding: 0;
  -moz-appearance: textfield;
  line-height: 10px;
  box-sizing: border-box;
}

.cmd-table-qty-input::-webkit-outer-spin-button,
.cmd-table-qty-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Input fait (x/y) - BOUTON CLIQUABLE */
.cmd-table-fait-btn {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 7px;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  color: #1f2937;
  cursor: pointer;
}

.cmd-table-fait-btn:hover {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
}

/* Container fraction éditable X/Y */
.cmd-table-fait-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 12px;
  width: 100%;
  background: linear-gradient(to bottom, #ffffff, #f1f5f9);
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  box-sizing: border-box;
}

.cmd-table-fait-input-top {
  width: 14px;
  height: 10px;
  border: none;
  background: transparent;
  text-align: center;
  font-size: 7px;
  font-weight: 600;
  padding: 0;
  -moz-appearance: textfield;
  outline: none;
}

.cmd-table-fait-input-top::-webkit-outer-spin-button,
.cmd-table-fait-input-top::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.cmd-table-fait-input-top:focus {
  background: #e0f2fe;
}

.cmd-table-fait-separator {
  font-size: 7px;
  color: #6b7280;
  margin: 0 1px;
}

.cmd-table-fait-total {
  font-size: 7px;
  color: #6b7280;
}

/* Input fait (x/y) - ancien style */
.cmd-table-fait-input {
  width: 100%;
  height: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  font-size: 7px;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
}

/* Pastille Status */
.cmd-table-status {
  height: 12px;
  width: 100%;
  border-radius: 2px;
  font-size: 6px;
  font-weight: 600;
  color: white;
  border: none;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 12px;
  box-sizing: border-box;
}

.cmd-table-status.todo {
  background: linear-gradient(to bottom, #ff4444, #cc0000);
}

.cmd-table-status.partial {
  background: linear-gradient(to bottom, #ffaa00, #ff8800);
}

.cmd-table-status.done {
  background: linear-gradient(to bottom, #00dd00, #00aa00);
}

/* Pastille Employe */
.cmd-table-emp {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 6px;
  cursor: pointer;
  padding: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 10px;
  box-sizing: border-box;
}

/* Pastille Notes */
.cmd-table-notes {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 6px;
  cursor: pointer;
  padding: 0;
  line-height: 10px;
  box-sizing: border-box;
}

.cmd-table-notes.has-note {
  background: linear-gradient(to bottom, #fef3c7, #fde68a);
  border-color: #f59e0b;
  color: #92400e;
}

/* Pastille Expédition - même style que les autres pastilles */
.cmd-table-exped {
  border-radius: 2px;
  height: 12px;
  width: 100%;
  font-size: 7px;
  cursor: pointer;
  padding: 0 2px;
  line-height: 12px;
  box-sizing: border-box;
  border: 1px solid #cbd5e1;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cmd-table-exped.attente {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
}

.cmd-table-exped.pret {
  background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
  color: #374151;
}

/* Bouton supprimer */
.cmd-table-delete-text {
  font-size: 12px;
  font-weight: 700;
  color: #374151;
  cursor: pointer;
  line-height: 12px;
  display: block;
  text-align: center;
}

.cmd-table-delete-text:hover {
  color: #ef4444;
}

/* Colonne X à droite */
.cmd-items-table td.col-x {
  text-align: right;
  padding-right: 2px !important;
  min-width: 4px !important;
  max-width: 4px !important;
  padding: 0 !important;
  overflow: visible;
}

/* Items list container - plus de hauteur avant scroll */
.cmd-items-list {
  max-height: calc(100vh - 100px);
  overflow-y: auto;
}

/* Bouton X supprimer item */
.cmd-item-delete-btn {
  width: 14px;
  height: 14px;
  padding: 0;
  font-size: 9px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Pastille Item - bleue - RAPETISSÉE */
.cmd-item-pill {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.cmd-item-pill:hover {
  background: linear-gradient(to bottom, #4a7fc9, #2a4670);
}

.cmd-item-pill-readonly {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

/* Quantité totale item - bleue - RAPETISSÉE */
.cmd-item-qty {
  width: 100%;
  height: 14px;
  padding: 0;
  font-size: 9px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 3px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

/* Statut item */
.cmd-item-status {
  width: 100%;
  height: 14px;
  padding: 0 2px;
  font-size: 8px;
  font-weight: 600;
  border: none;
  border-radius: 3px;
  color: white;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.cmd-item-status.todo {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.cmd-item-status.partial {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
}

.cmd-item-status.complete {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
}

/* ========================================
   LIGNES GRANDEUR - Atelier | Couture | Inspection
   ======================================== */

.cmd-grandeurs-table {
  display: flex;
  flex-direction: column;
  gap: 0;
}

/* Ligne grandeur avec 3 sections */
.cmd-grandeur-row {
  display: grid;
  grid-template-columns: 14px 55px 24px 28px 45px 35px 3px 10px 55px 24px 28px 45px 50px 35px 3px 10px 55px 24px 28px 45px 35px 14px;
  gap: 2px;
  align-items: center;
  margin: 1px 0;
  padding: 0;
}

/* Ligne verticale dans les rows */
.cmd-row-line {
  width: 2px;
  height: 14px;
  background: #1e3a5f;
}

/* INSPECTION - grosse pastille État (combine Localisation + Employé) */
.cmd-grandeur-row.inspection-row {
  grid-template-columns: 14px 60px 28px 28px 55px 140px 45px 14px;
}

.cmd-dept-columns-header.inspection-header {
  grid-template-columns: 14px 60px 28px 28px 55px 140px 45px 14px;
}

.cmd-item-header.inspection-item-header {
  grid-template-columns: 12px 48px 22px 26px 50px 110px 35px 12px;
}

/* Grosse pastille État pour Inspection */
.cmd-g-etat-big {
  width: 100%;
  height: 14px;
  padding: 0 4px;
  font-size: 8px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-etat-big:hover {
  background: linear-gradient(to bottom, #4b5563, #374151);
}

.cmd-g-etat-big.inspecte {
  background: linear-gradient(to bottom, #3b82f6, #2563eb);
}

.cmd-g-etat-big.expedie {
  background: linear-gradient(to bottom, #10b981, #059669);
}

/* Pastille grandeur */
.cmd-g-name {
  width: 100%;
  height: 11px;
  padding: 0 1px;
  font-size: 7px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  background: #fff;
  box-sizing: border-box;
  cursor: pointer;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-name:hover {
  background: #f0f9ff;
  border-color: #3b82f6;
}

.cmd-g-name-readonly {
  width: 100%;
  height: 11px;
  padding: 0 1px;
  font-size: 7px;
  background: #f3f4f6;
  border-radius: 2px;
  color: #374151;
  box-sizing: border-box;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Quantité */
.cmd-g-qty {
  width: 100%;
  height: 11px;
  padding: 0;
  font-size: 7px;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  background: #fff;
  box-sizing: border-box;
}

.cmd-g-qty-readonly {
  width: 100%;
  height: 11px;
  padding: 0;
  font-size: 7px;
  background: #f3f4f6;
  border-radius: 2px;
  text-align: center;
  color: #374151;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Quantité fait */
.cmd-g-qtyfait {
  width: 100%;
  height: 11px;
  padding: 0;
  font-size: 7px;
  font-weight: 600;
  background: #e5e7eb;
  color: #374151;
  border: 1px solid #cbd5e1;
  border-radius: 2px;
  text-align: center;
  box-sizing: border-box;
}

/* Enlever flèches des inputs number */
.cmd-g-qty::-webkit-outer-spin-button,
.cmd-g-qty::-webkit-inner-spin-button,
.cmd-g-qtyfait::-webkit-outer-spin-button,
.cmd-g-qtyfait::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.cmd-g-qty, .cmd-g-qtyfait {
  -moz-appearance: textfield;
}

/* Statut grandeur */
.cmd-g-status {
  width: 100%;
  height: 11px;
  padding: 0 2px;
  font-size: 6px;
  font-weight: 600;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  color: white;
  text-align: center;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-status.todo {
  background: linear-gradient(to bottom, #ef4444, #dc2626);
}

.cmd-g-status.done {
  background: linear-gradient(to bottom, #22c55e, #16a34a);
}

.cmd-g-status.partial {
  background: linear-gradient(to bottom, #f59e0b, #d97706);
}

/* Location */
.cmd-g-loc {
  width: 100%;
  height: 11px;
  padding: 0 2px;
  font-size: 6px;
  font-weight: 600;
  background: white;
  color: #1f2937;
  border: 1px solid #d1d5db;
  border-radius: 2px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-loc:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

/* Employé */
.cmd-g-emp {
  width: 100%;
  height: 11px;
  padding: 0 2px;
  font-size: 6px;
  font-weight: 600;
  background: white;
  color: #1f2937;
  border: 1px solid #d1d5db;
  border-radius: 2px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-emp:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

/* Notes */
.cmd-g-note {
  width: 100%;
  height: 11px;
  padding: 0 1px;
  font-size: 6px;
  font-weight: 600;
  background: white;
  color: #1f2937;
  border: 1px solid #d1d5db;
  border-radius: 2px;
  cursor: pointer;
  text-align: center;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-g-note:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.cmd-g-note.has-note {
  background: linear-gradient(to bottom, #fef08a, #fde047);
  color: #92400e;
  border-color: #f59e0b;
  animation: blink-note 1s infinite;
}

@keyframes blink-note {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Bouton X supprimer grandeur */
.cmd-g-del {
  width: 12px;
  height: 12px;
  padding: 0;
  font-size: 8px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cmd-add-grandeur-btn {
  display: block;
  width: fit-content;
  padding: 2px 6px;
  font-size: 6px;
  font-weight: 600;
  background: #d1d5db;
  color: #374151;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  margin-top: 2px;
}

/* Mini popup */
.cmd-mini-note-popup {
  position: fixed;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 8px;
  width: 180px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 20000;
}

.cmd-mini-note-popup textarea,
.cmd-mini-note-popup input {
  width: 100%;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 6px;
  box-sizing: border-box;
}

.cmd-mini-note-popup textarea {
  height: 50px;
  resize: none;
}

.cmd-mini-note-popup .mini-note-btns {
  display: flex;
  gap: 4px;
  margin-top: 6px;
  justify-content: flex-end;
}

.cmd-mini-note-popup button {
  padding: 4px 10px;
  font-size: 9px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.cmd-mini-note-popup .save-btn {
  background: #10b981;
  color: white;
}

.cmd-mini-note-popup .close-btn {
  background: #6b7280;
  color: white;
}

/* Menu sélection Item/Grandeur */
.cmd-select-menu {
  position: fixed;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 6px;
  padding: 6px;
  min-width: 120px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 20000;
}

.cmd-select-menu .cmd-select-title {
  font-size: 9px;
  font-weight: 700;
  color: #374151;
  padding: 4px 6px;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 4px;
}

.cmd-select-menu .cmd-select-option {
  display: block;
  width: 100%;
  padding: 5px 8px;
  font-size: 8px;
  text-align: left;
  background: #f8fafc;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin-bottom: 2px;
}

.cmd-select-menu .cmd-select-option:hover {
  background: #3b82f6;
  color: white;
}

/* Notes section */
.cmd-notes-section {
  margin-top: 15px;
}

.cmd-notes-section h4 {
  margin: 0 0 8px 0;
  font-size: 12px;
  font-weight: 700;
  color: #1f2937;
}

.cmd-notes-textarea {
  width: 100%;
  height: 100px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 10px;
  resize: vertical;
  box-sizing: border-box;
  background: #fff;
}

/* Notes directes dans fiche commande */
.cmd-notes-direct {
  flex: 1;
  display: flex;
  flex-direction: column;
  margin-top: 8px;
  min-height: 80px;
}

.cmd-notes-header {
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 4px;
}

/* Zone notes compacte (une ligne) */
.cmd-notes-compact {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 8px;
}

.cmd-notes-compact:hover {
  background: #e0f2fe;
  border-color: #7dd3fc;
}

.cmd-notes-icon {
  font-size: 14px;
}

.cmd-notes-preview {
  font-size: 10px;
  color: #64748b;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

/* Zone notes étendue */
.cmd-notes-expanded {
  display: flex;
  flex-direction: column;
  margin-top: 8px;
  flex: 1;
  min-height: 120px;
}

.cmd-notes-header-expanded {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 11px;
  font-weight: 700;
  color: #1e40af;
  margin-bottom: 4px;
}

.cmd-notes-collapse-btn {
  font-size: 9px;
  padding: 2px 8px;
  background: #e2e8f0;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  color: #475569;
}

.cmd-notes-collapse-btn:hover {
  background: #cbd5e1;
}

.cmd-notes-textarea-direct {
  flex: 1;
  width: 100%;
  min-height: 100px;
  font-size: 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 8px;
  resize: none;
  box-sizing: border-box;
  background: #fff;
  font-family: inherit;
  line-height: 1.3;
}

.cmd-fiche-close-btn {
  position: absolute;
  bottom: 8px;
  right: 10px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 9px;
  font-weight: 600;
  cursor: pointer;
}

/* Sélecteur client sur carte commande */
.mcard-client-select {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  cursor: pointer;
  text-align: center;
  padding: 2px 4px;
  border-radius: 4px;
}

.mcard-client-select:hover {
  background: rgba(255,255,255,0.2);
}

/* Menu client popup */
.client-menu-popup {
  position: fixed;
  background: linear-gradient(to bottom, #1a3a5c, #0d2340);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  padding: 6px;
  min-width: 140px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 15000;
}

.client-menu-item {
  padding: 6px 10px;
  font-size: 11px;
  color: white;
  cursor: pointer;
  border-radius: 4px;
  text-align: center;
}

.client-menu-item:hover {
  background: rgba(255,255,255,0.2);
}

/* ===== MODAL LOG ===== */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 5000;
  justify-content: center;
  align-items: center;
}

.modal-overlay.active {
  display: flex;
}

.modal-content {
  background: linear-gradient(to bottom, #1a3a5c, #0d2340);
  border-radius: 12px;
  border: 2px solid #00aaff;
  padding: 20px;
  min-width: 400px;
  max-width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  color: #fff;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
}

.modal-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
}

/* ===== LOGIN OVERLAY ===== */
.login-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom, #0b1d36, #3f6eb8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50000;
}
.login-overlay.hidden {
  display: none;
}
.login-panel {
  background: linear-gradient(to bottom, #0b2343, #06315a);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 30px rgba(0,0,0,0.85);
  padding: 40px;
  max-width: 400px;
  width: 90%;
  color: #fff;
  text-align: center;
}
.login-logo {
  height: 80px;
  margin-bottom: 20px;
}
.login-title {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 10px;
}
.login-subtitle {
  font-size: 14px;
  opacity: 0.8;
  margin-bottom: 30px;
}
.login-input {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 18px;
  text-align: center;
  margin-bottom: 20px;
  box-sizing: border-box;
  letter-spacing: 3px;
}
.login-input::placeholder {
  color: rgba(255,255,255,0.5);
  letter-spacing: normal;
  font-size: 14px;
}
.login-input:focus {
  outline: none;
  border-color: #00aaff;
  box-shadow: 0 0 10px rgba(0,170,255,0.3);
}
.login-btn {
  width: 100%;
  padding: 14px;
  border-radius: 999px;
  border: none;
  background: linear-gradient(to bottom, #00aaff, #0077cc);
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.login-btn:hover {
  background: linear-gradient(to bottom, #00bbff, #0088dd);
  transform: translateY(-1px);
}
.login-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.login-error {
  color: #ff6666;
  font-size: 12px;
  margin-top: 10px;
  min-height: 20px;
}

.log-entries {
  max-height: 400px;
  overflow-y: auto;
}

.log-entry {
  padding: 8px;
  margin-bottom: 5px;
  background: rgba(0,0,0,0.2);
  border-radius: 6px;
  font-size: 11px;
}

.log-entry .log-time {
  color: #64748b;
  font-size: 9px;
}

/* ===== MODAL AJOUTER MOULAGE ===== */
.add-modal-field {
  margin-bottom: 12px;
}

.add-modal-field label {
  display: block;
  font-size: 11px;
  margin-bottom: 4px;
}

.add-modal-field input,
.add-modal-field select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 12px;
  box-sizing: border-box;
}

.add-modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 15px;
}

.add-modal-buttons button {
  padding: 8px 20px;
  border-radius: 6px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.btn-add {
  background: linear-gradient(to bottom, #22c55e, #15803d);
  color: #fff;
}

.btn-cancel-modal {
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: #fff;
}

/* ===== AUTH MODAL ===== */
.auth-modal-field {
  margin-bottom: 12px;
}

.auth-modal-field label {
  display: block;
  font-size: 11px;
  margin-bottom: 4px;
}

.auth-modal-field input {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 13px;
  box-sizing: border-box;
}

.auth-error {
  color: #ef4444;
  font-size: 11px;
  margin-bottom: 10px;
  display: none;
}

.auth-error.show {
  display: block;
}

/* ========================================
   SYSTÈME DE RECETTES ET MATÉRIAUX
   ======================================== */

.cmd-materiaux-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 4px;
  background: transparent;
  padding: 0;
  margin: 0;
  align-items: stretch;
  max-width: 100%;
  overflow: hidden;
}

.cmd-materiaux-column {
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 3px;
  padding: 3px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.cmd-materiaux-header {
  font-size: 8px;
  font-weight: 700;
  color: white;
  text-align: center;
  padding: 2px 4px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  border-radius: 2px;
  margin-bottom: 2px;
}

.cmd-materiaux-list {
  font-size: 8px;
  color: #374151;
  line-height: 1.3;
  flex: 1;
}

/* Grille matériaux: Code | Matériau+Épaisseur | Qté */
.cmd-materiaux-item {
  display: grid;
  grid-template-columns: 40px 1fr 20px;
  gap: 2px;
  padding: 2px 0;
  border-bottom: 1px dotted #e5e7eb;
  align-items: center;
}

.cmd-materiaux-item:last-child {
  border-bottom: none;
}

.cmd-materiaux-code {
  font-size: 8px;
  font-weight: 700;
  color: #4b5563;
  text-align: left;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cmd-materiaux-name {
  font-size: 8px;
  font-weight: 500;
  color: #1f2937;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 1px;
}

.cmd-materiaux-qty {
  font-size: 10px;
  font-weight: 700;
  color: #059669;
  text-align: right;
}

/* Section Total Matériaux - COMPACTE */
.cmd-materiaux-total {
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
  border: 1px solid #3b82f6;
  border-radius: 3px;
  padding: 3px 4px;
  margin-top: 2px;
  max-height: 120px;
  overflow-y: auto;
  overflow-x: hidden;
}

.cmd-materiaux-total-header {
  font-size: 7px;
  font-weight: 700;
  color: #1e40af;
  text-align: center;
  margin-bottom: 2px;
  padding-bottom: 2px;
  border-bottom: 1px solid #3b82f6;
  position: sticky;
  top: 0;
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
}

.cmd-materiaux-total-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1px 4px;
}

.cmd-materiaux-total-item {
  display: grid;
  grid-template-columns: 35px 1fr 18px;
  gap: 2px;
  align-items: center;
  padding: 1px 2px;
  background: white;
  border-radius: 2px;
  font-size: 6px;
  line-height: 1.2;
}

.cmd-materiaux-total-item .code {
  font-weight: 700;
  color: #1e40af;
  font-size: 6px;
}

.cmd-materiaux-total-item .name {
  font-weight: 500;
  color: #374151;
  font-size: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cmd-materiaux-total-item .qty {
  font-weight: 700;
  color: #059669;
  font-size: 8px;
  text-align: right;
}

/* Popup Notes Commande - Overlay */
.cmd-notes-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 25000;
}

.cmd-notes-popup-content {
  background: white;
  border-radius: 10px;
  width: 500px;
  max-width: 95vw;
  height: 50vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.cmd-notes-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(to bottom, #3f6eb8, #1d3560);
  color: white;
  border-radius: 10px 10px 0 0;
}

.cmd-notes-popup-header h3 {
  margin: 0;
  font-size: 14px;
}

.cmd-notes-popup-header button {
  padding: 4px 12px;
  font-size: 11px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  border-radius: 4px;
  cursor: pointer;
}

.cmd-notes-popup-body {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.cmd-existing-notes {
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 8px;
  flex: 1;
  overflow-y: auto;
  font-size: 11px;
  margin-bottom: 12px;
}

.cmd-existing-notes .note-entry {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #e5e7eb;
}

.cmd-existing-notes .note-entry:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.cmd-existing-notes .note-signature {
  font-weight: 700;
  color: #1e40af;
  font-size: 10px;
}

.cmd-existing-notes .note-text {
  margin-top: 4px;
  color: #374151;
}

.cmd-new-note-section {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 6px;
  padding: 8px;
}

.cmd-note-signature {
  font-size: 10px;
  font-weight: 700;
  color: #16a34a;
  margin-bottom: 6px;
}

.cmd-new-note-section textarea {
  width: 100%;
  height: 60px;
  padding: 8px;
  font-size: 11px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  resize: none;
  font-family: inherit;
  box-sizing: border-box;
}

.cmd-notes-popup-footer {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 12px;
  background: #f1f5f9;
  border-radius: 0 0 10px 10px;
}

.cmd-notes-popup-footer .btn-save {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.cmd-notes-popup-footer .btn-close {
  padding: 8px 20px;
  font-size: 12px;
  font-weight: 600;
  background: linear-gradient(to bottom, #6b7280, #4b5563);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

/* Bouton gérer recettes */
.cmd-recettes-btn {
  font-size: 6px;
  padding: 2px 6px;
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  margin-left: 8px;
}

.cmd-recettes-btn:hover {
  background: linear-gradient(to bottom, #7c3aed, #6d28d9);
}

/* Popup recettes */
.recettes-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 650px;
  max-width: 95vw;
  max-height: 85vh;
  background: white;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  z-index: 10000;
  overflow: hidden;
  display: none;
}

.recettes-popup.show {
  display: block;
}

.recettes-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: linear-gradient(to bottom, #8b5cf6, #7c3aed);
  color: white;
}

.recettes-popup-header h3 {
  margin: 0;
  font-size: 14px;
}

.recettes-header-btns {
  display: flex;
  gap: 8px;
}

.recettes-btn-save {
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.recettes-btn-close {
  padding: 6px 16px;
  font-size: 11px;
  font-weight: 600;
  background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.recettes-btn-delete {
  padding: 6px 12px;
  font-size: 14px;
  font-weight: 600;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.recettes-popup-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 12px 15px;
  background: #f1f5f9;
  border-top: 1px solid #e2e8f0;
}

.recettes-popup-close {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.recettes-popup-body {
  padding: 15px;
  max-height: 55vh;
  overflow-y: auto;
}

.recette-card {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 10px;
}

.recette-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.recette-card-title {
  font-size: 14px;
  font-weight: 700;
  color: #1f2937;
}

.recette-card-actions {
  display: flex;
  gap: 4px;
}

.recette-card-actions button {
  padding: 4px 10px;
  font-size: 11px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.recette-edit-btn {
  background: #3b82f6;
  color: white;
}

.recette-delete-btn {
  background: #ef4444;
  color: white;
}

.recette-materiaux-list {
  font-size: 12px;
  color: #4b5563;
}

.recette-materiau-item {
  padding: 3px 0;
  display: flex;
  justify-content: space-between;
}

.add-recette-form {
  background: #f0fdf4;
  border: 1px solid #86efac;
  border-radius: 6px;
  padding: 12px;
  margin-top: 10px;
}

.add-recette-form h4 {
  margin: 0 0 10px 0;
  font-size: 14px;
  color: #166534;
}

.add-recette-form input,
.add-recette-form textarea {
  width: 100%;
  padding: 8px;
  font-size: 12px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  margin-bottom: 8px;
  box-sizing: border-box;
}

.add-recette-form button {
  padding: 6px 12px;
  font-size: 11px;
  background: #22c55e;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Menu popup amélioré avec Ajouter/Supprimer */
.menu-popup-actions {
  display: flex;
  gap: 4px;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #e5e7eb;
}

.menu-popup-add-btn {
  flex: 1;
  padding: 4px 8px;
  font-size: 9px;
  background: linear-gradient(to bottom, #22c55e, #16a34a);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.menu-popup-delete-btn {
  flex: 1;
  padding: 4px 8px;
  font-size: 9px;
  background: linear-gradient(to bottom, #ef4444, #dc2626);
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

  </style>
</head>
<body>
<div class="physiproRoot">
  <div class="app-shell">
    
    <!-- TOP BAR -->
    <header class="topbar">
      <div class="tb-left">
        <button class="logo-btn active" id="btnLogoMoulages" onclick="switchPage('moulages')" title="Moulages">
          <img src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Moulages"/>
        </button>
        <button class="logo-btn" id="btnLogoCommandes" onclick="switchPage('commandes')" title="Commandes">
          <img src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Commandes"/>
        </button>
      </div>
      
      <div class="tb-center">
        <span class="top-title" id="pageTitle">Outil de gestion des moulages</span>
      </div>
      
      <div class="tb-right">
        <div class="tb-right-top">
          <button class="header-btn" id="btnLog">📋 Log</button>
          <button class="header-btn" id="btnAddMoulage">+ Ajouter moulage</button>
          <button class="header-btn hidden" id="btnAddCommande">+ Ajouter commande</button>
        </div>
        <div class="tb-right-bottom">
          <div class="user-status" id="userStatus">
            <span class="status-dot offline"></span>
            <span class="user-name">Non connecté</span>
          </div>
          <button class="auth-btn login" id="btnAuth">Connexion</button>
        </div>
      </div>
      
      <div class="top-search-row">
        <div class="search-box">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" placeholder="Rechercher un moulage..."/>
          <button class="search-clear" id="searchClear">Effacer</button>
        </div>
      </div>
    </header>
    
    <!-- BOARD -->
    <div class="board-wrapper">
      <div class="boards-container" id="boardsContainer">
        <div class="board" id="mainBoard">
          <div class="col" data-col="0">
            <div class="colheader" style="cursor:pointer;" onclick="toggleRobotView()" title="Cliquer pour vue horizontale">⚙️ Robot <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="1">
            <div class="colheader">🪚 Dégauchage <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="2">
            <div class="colheader">♿ Essayage <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="3">
            <div class="colheader">📐 Atelier <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="4">
            <div class="colheader">🧵 Couture <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="5">
            <div class="colheader">🎨 Peinture <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="6">
            <div class="colheader">🚚 Expédition <span class="col-count">0</span></div>
          </div>
          <div class="col" data-col="7">
            <div class="colheader en-attente">⏳ En attente <span class="col-count">0</span></div>
          </div>
        </div>
      </div>
      
      <!-- VUE HORIZONTALE ROBOT -->
      <div id="robotHorizontalView" class="robot-horizontal-container" style="display:none;">
        <div class="robot-horizontal-header">
          <h2>📊 Robot - Vue Horizontale (Éditable)</h2>
          <div style="display:flex;gap:8px;">
            <button class="header-btn" onclick="addNewMoulageFromHorizontal()" style="background:linear-gradient(to bottom,#22c55e,#16a34a);">+ Ajouter moulage</button>
            <button class="header-btn" onclick="toggleRobotView()">← Retour au Kanban</button>
          </div>
        </div>
        <div class="robot-horizontal-scroll">
          <table class="robot-horizontal-table" id="robotTable">
            <thead>
              <tr>
                <th class="resizable-th">Nom moulage<div class="resize-handle"></div></th>
                <th class="resizable-th">Client<div class="resize-handle"></div></th>
                <th class="resizable-th">N° Commande<div class="resize-handle"></div></th>
                <th class="resizable-th">Intervenant<div class="resize-handle"></div></th>
                <th class="resizable-th">Région<div class="resize-handle"></div></th>
                <th class="resizable-th">Item<div class="resize-handle"></div></th>
                <th class="resizable-th">Date Reçue<div class="resize-handle"></div></th>
                <th class="resizable-th">Date Livraison<div class="resize-handle"></div></th>
                <th class="resizable-th">Date Essayage<div class="resize-handle"></div></th>
                <th class="resizable-th">Représentante<div class="resize-handle"></div></th>
                <th class="resizable-th">File<div class="resize-handle"></div></th>
                <th class="resizable-th">Angle<div class="resize-handle"></div></th>
                <th class="resizable-th">RUSH<div class="resize-handle"></div></th>
                <th class="resizable-th">Notes<div class="resize-handle"></div></th>
              </tr>
            </thead>
            <tbody id="robotTableBody">
              <!-- Les lignes seront générées dynamiquement -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- PAGE COMMANDES -->
      <div id="commandesPage" class="boards-container hidden">
        <div class="board commandes-board" id="commandesBoard">
          <div class="col col-cmd" data-col-cmd="0">
            <div class="colheader">🏭 Magasin <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="1">
            <div class="colheader">🔧 Production <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="2">
            <div class="colheader">🔍 Inspection finale <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="3">
            <div class="colheader">🚚 Expédié <span class="col-count-cmd">0</span></div>
          </div>
          <div class="col col-cmd" data-col-cmd="4">
            <div class="colheader en-attente">📋 BO <span class="col-count-cmd">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- Overlay pour fiche moulage -->
<div class="card-overlay" id="cardOverlay"></div>

<!-- Overlay pour fiche commande -->
<div class="cmd-fiche-overlay" id="cmdFicheOverlay">
  <div class="cmd-fiche" id="cmdFicheContent">
    <!-- Contenu généré dynamiquement -->
  </div>
</div>

<!-- Menu de déplacement -->
<div class="move-overlay hidden" id="moveOverlay">
  <div class="move-panel">
    <div class="move-title">Déplacer vers quelle colonne?</div>
    <div class="move-columns" id="moveColumns">
      <!-- Généré dynamiquement -->
    </div>
    <div class="move-footer">
      <button class="move-btn-close" id="moveClose">Annuler</button>
    </div>
  </div>
</div>

<!-- Confirmation suppression -->
<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-panel">
    <div class="confirm-title">⚠️ Confirmer la suppression</div>
    <div class="confirm-message" id="confirmMessage">Voulez-vous vraiment supprimer ce moulage?</div>
    <div class="confirm-buttons">
      <button class="confirm-btn confirm-btn-yes" id="confirmYes">Oui, supprimer</button>
      <button class="confirm-btn confirm-btn-no" id="confirmNo">Non, annuler</button>
    </div>
  </div>
</div>

<!-- Modal Log -->
<div class="modal-overlay" id="logModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>📋 Journal des activités</h3>
      <button class="modal-close" id="closeLogModal">×</button>
    </div>
    <div class="log-entries" id="logEntries">
      <div class="log-entry">
        <div class="log-time">Aucune entrée</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ajouter Moulage -->
<div class="modal-overlay" id="addModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>➕ Ajouter un moulage</h3>
      <button class="modal-close" id="closeAddModal">×</button>
    </div>
    <div class="add-modal-field">
      <label>Nom du moulage</label>
      <input type="text" id="addName" placeholder="Ex: Dupont Jean">
    </div>
    <div class="add-modal-field">
      <label>Numéro de commande</label>
      <input type="text" id="addOrder" placeholder="Ex: 123456">
    </div>
    <div class="add-modal-field">
      <label>Région</label>
      <select id="addRegion">
        <option value="Québec">Québec</option>
        <option value="Ontario">Ontario</option>
        <option value="Maritime">Maritime</option>
      </select>
    </div>
    <div class="add-modal-buttons">
      <button class="btn-cancel-modal" id="cancelAdd">Annuler</button>
      <button class="btn-add" id="confirmAdd">Ajouter</button>
    </div>
  </div>
</div>

<!-- Login Overlay (plein écran) -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-panel">
    <img class="login-logo" src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Physipro">
    <div class="login-title">Outil de gestion des moulages</div>
    <div class="login-subtitle">Entrez votre mot de passe pour accéder</div>
    <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" maxlength="20">
    <button class="login-btn" id="loginBtn">Se connecter</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<script>
// ===== CONFIGURATION FIREBASE =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCk7bqVnx08Kz1fVq1W24AuW854KY9jPno",
  authDomain: "liste-des-moulages-physipro.firebaseapp.com",
  databaseURL: "https://liste-des-moulages-physipro-default-rtdb.firebaseio.com",
  projectId: "liste-des-moulages-physipro",
  storageBucket: "liste-des-moulages-physipro.firebasestorage.app",
  messagingSenderId: "24566847562",
  appId: "1:24566847562:web:db492bdd33116373e0eeb3"
};

// Table de correspondance mot de passe -> email Firebase
const PASSWORD_TO_EMAIL = {
  "007000": "mario@physipro.local",
  "067700": "sina@physipro.local",
  "047700": "cassie@physipro.local",
  "047800": "stephanie@physipro.local",
  "063900": "valerie@physipro.local",
  "028500": "daniel@physipro.local",
  "010400": "michelle@physipro.local",
  "062100": "francine@physipro.local",
  "035100": "mariesoleil@physipro.local",
  "045600": "mariepier@physipro.local",
  "066600": "multipass@physipro.local",
  "099600": "fabrys@physipro.local",
  "Lecture202500": "visiteur@physipro.local"
};

// Mapping code -> nom et email (pour notes et logs)
const USER_CODES = {
  "007000": { name: "Mario", email: "mario@physipro.local" },
  "067700": { name: "Sina", email: "sina@physipro.local" },
  "047700": { name: "Cassie", email: "cassie@physipro.local" },
  "047800": { name: "Stéphanie", email: "stephanie@physipro.local" },
  "063900": { name: "Valérie", email: "valerie@physipro.local" },
  "028500": { name: "Daniel", email: "daniel@physipro.local" },
  "010400": { name: "Michelle", email: "michelle@physipro.local" },
  "062100": { name: "Francine", email: "francine@physipro.local" },
  "035100": { name: "Marie-Soleil", email: "mariesoleil@physipro.local" },
  "045600": { name: "Marie-Pier", email: "mariepier@physipro.local" },
  "066600": { name: "Multipass", email: "multipass@physipro.local" },
  "099600": { name: "Fabrys", email: "fabrys@physipro.local" },
  "Lecture202500": { name: "Visiteur", email: "visiteur@physipro.local" }
};

// Informations des utilisateurs
const USERS = {
  "mario@physipro.local": { name: "Mario", role: "editor" },
  "sina@physipro.local": { name: "Sina", role: "editor" },
  "cassie@physipro.local": { name: "Cassie", role: "editor" },
  "stephanie@physipro.local": { name: "Stéphanie", role: "editor" },
  "valerie@physipro.local": { name: "Valérie", role: "editor" },
  "daniel@physipro.local": { name: "Daniel", role: "editor" },
  "michelle@physipro.local": { name: "Michelle", role: "editor" },
  "francine@physipro.local": { name: "Francine", role: "editor" },
  "mariesoleil@physipro.local": { name: "Marie-Soleil", role: "editor" },
  "mariepier@physipro.local": { name: "Marie-Pier", role: "editor" },
  "multipass@physipro.local": { name: "Multipass", role: "editor" },
  "fabrys@physipro.local": { name: "Fabrys", role: "editor" },
  "visiteur@physipro.local": { name: "Visiteur", role: "viewer" }
};

// Variables globales
let firebaseInitialized = false;
let currentUser = null;
let firebaseAuth = null;
let firebaseDb = null;
let _sessionValid = false;

// Initialiser Firebase
try {
  firebase.initializeApp(FIREBASE_CONFIG);
  firebaseDb = firebase.database();
  firebaseAuth = firebase.auth();
  firebaseInitialized = true;
  console.log("✅ Firebase initialisé");
} catch(e) {
  console.error("❌ Erreur Firebase:", e);
}

// ===== DONNÉES =====
const MENU_DATA = {
  regions: ["Québec", "Ontario", "Maritime"],
  delays: { "Québec": 90, "Ontario": 30, "Maritime": 45 },
  clients: ["MEDPLUS", "METRO HEALTH", "TLC medical", "Lucie Bruneau.", "CMR", "Ciss Laurentides bouclier"],
  intervenants: ["Anna", "Jenny Jackson", "Pam", "Maryse Bernard", "Anna Caufield", "Lee Ann Best", "Charles Larose"],
  representantes: ["Marie-Soleil", "Marie-Piers"],
  items: ["HP2", "HP2 Ultra", "EasyFit", "Coussin Brio", "Coquille 2Sizer", "Siège", "Dossier", "Siège + Dossier"],
  employees: {
    robot: ["Mario Jaques", "Sina", "Zakaria"],
    degauchage: ["Pierre", "Serge", "Nestor", "Mathieu", "Daniel"],
    atelier: ["Pierre", "Serge", "Nestor", "Mathieu", "Daniel", "Valérie", "Tommy", "Saul", "Checkna"],
    couture: ["Stéphanie", "Cassie", "Thérèse", "Louisette", "Suave", "Martine"],
    peinture: ["Manuel", "Cheickna", "Saul", "Pablo"]
  },
  locations: ["Étagère Val", "Étagère Dan", "Donné à Michelle", "Tablette A1", "Tablette A2", "Rack C1", "Magasin"],
  // Recettes pour chaque item (avec code matériau)
  recettes: {
    "HP2": [
      { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" }
    ],
    "HP2 Ultra": [
      { code: "VIS-22", materiau: "Feuille Viscose 22x24", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou 22x24", qty: 1, epaisseur: "½″" },
      { code: "COQ-2S", materiau: "Coquille 2Sizer", qty: 1, epaisseur: "" },
      { code: "VIS-T36", materiau: "Feuille Viscose T36 (cuvette)", qty: 1, epaisseur: "" }
    ],
    "EasyFit": [
      { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" }
    ],
    "Coussin Brio": [
      { code: "NEO-60", materiau: "Feuille Néocor VF60", qty: 1.5, epaisseur: "1″" },
      { code: "SUN-M", materiau: "Feuille Sunmate mou", qty: 0.5, epaisseur: "1″" },
      { code: "BIS-BR", materiau: "Biseau pour Brio", qty: 1, epaisseur: "" },
      { code: "BUT-AB", materiau: "Butée ABD Néocor", qty: 1, epaisseur: "" },
      { code: "NEO-40", materiau: "Feuille Néocor VF40", qty: 0.5, epaisseur: "½″" }
    ]
  }
};

// Variables globales pour les listes (utilisées dans la vue horizontale)
window.CLIENTS_LIST = MENU_DATA.clients;
window.INTERVENANTS_LIST = MENU_DATA.intervenants;

// Stockage des cartes
let cardsData = {};
let logEntries = [];

// ===== CALCUL DES JOURS OUVRABLES (EXCLUANT WEEKENDS ET JOURS FÉRIÉS QUÉBEC) =====
function getJoursFeriesQuebec(year) {
  const feries = [];
  // Jour de l'An
  feries.push(new Date(year, 0, 1));
  // Fête nationale du Québec
  feries.push(new Date(year, 5, 24));
  // Fête du Canada
  feries.push(new Date(year, 6, 1));
  // Noël
  feries.push(new Date(year, 11, 25));
  
  // Pâques et jours associés
  const paques = getPaquesDate(year);
  const vendrediSaint = new Date(paques);
  vendrediSaint.setDate(paques.getDate() - 2);
  feries.push(vendrediSaint);
  
  const lundiPaques = new Date(paques);
  lundiPaques.setDate(paques.getDate() + 1);
  feries.push(lundiPaques);
  
  // Fête du Travail (1er lundi de septembre)
  const feteTravail = new Date(year, 8, 1);
  while (feteTravail.getDay() !== 1) {
    feteTravail.setDate(feteTravail.getDate() + 1);
  }
  feries.push(feteTravail);
  
  // Action de grâce (2e lundi d'octobre)
  const actionGraces = new Date(year, 9, 1);
  let countMonday = 0;
  while (countMonday < 2) {
    if (actionGraces.getDay() === 1) countMonday++;
    if (countMonday < 2) actionGraces.setDate(actionGraces.getDate() + 1);
  }
  feries.push(actionGraces);
  
  return feries;
}

function getPaquesDate(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19 * a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const l = (32 + 2 * e + 2 * i - h - k) % 7;
  const m = Math.floor((a + 11 * h + 22 * l) / 451);
  const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
  const day = ((h + l - 7 * m + 114) % 31) + 1;
  return new Date(year, month, day);
}

function estJourFerie(date, joursFeries) {
  const dateStr = date.toDateString();
  return joursFeries.some(ferie => ferie.toDateString() === dateStr);
}

function estWeekend(date) {
  const day = date.getDay();
  return day === 0 || day === 6;
}

function calculerJoursOuvrables(dateDebut, dateFin) {
  let joursOuvrables = 0;
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  debut.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  const anneeDebut = debut.getFullYear();
  const anneeFin = fin.getFullYear();
  let joursFeries = [];
  
  for (let annee = anneeDebut; annee <= anneeFin; annee++) {
    joursFeries = joursFeries.concat(getJoursFeriesQuebec(annee));
  }
  
  const currentDate = new Date(debut);
  while (currentDate < fin) {
    currentDate.setDate(currentDate.getDate() + 1);
    if (!estWeekend(currentDate) && !estJourFerie(currentDate, joursFeries)) {
      joursOuvrables++;
    }
  }
  return joursOuvrables;
}

// ===== SYSTÈME DE LOGIN =====
const loginOverlay = document.getElementById('loginOverlay');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const userStatusEl = document.getElementById('userStatus');
const btnAuth = document.getElementById('btnAuth');

// Focus sur le champ mot de passe au chargement
setTimeout(() => loginPassword?.focus(), 100);

// Event listeners login
loginBtn?.addEventListener('click', attemptLogin);
loginPassword?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') attemptLogin();
});

// Tentative de connexion
async function attemptLogin() {
  const password = loginPassword.value.trim();
  
  if (!password) {
    loginError.textContent = "Veuillez entrer un mot de passe";
    return;
  }
  
  // Trouver l'email correspondant au mot de passe
  const email = PASSWORD_TO_EMAIL[password];
  
  if (!email) {
    loginError.textContent = "Mot de passe incorrect";
    loginPassword.value = "";
    loginPassword.focus();
    return;
  }
  
  // Afficher indicateur de chargement
  loginBtn.textContent = "Connexion...";
  loginBtn.disabled = true;
  loginError.textContent = "";
  
  try {
    // Connexion via Firebase Authentication
    await firebaseAuth.signInWithEmailAndPassword(email, password);
    console.log("✅ Connexion réussie pour " + email);
    
    // Récupérer les infos utilisateur
    const userInfo = USERS[email];
    
    if (userInfo) {
      loginUserSuccess(userInfo, email);
    } else {
      throw new Error("Utilisateur non trouvé");
    }
    
  } catch(error) {
    console.error("❌ Erreur connexion:", error);
    
    let errorMessage = "Erreur de connexion";
    switch(error.code) {
      case "auth/wrong-password":
      case "auth/invalid-credential":
        errorMessage = "Mot de passe incorrect";
        break;
      case "auth/user-not-found":
        errorMessage = "Utilisateur non trouvé";
        break;
      case "auth/too-many-requests":
        errorMessage = "Trop de tentatives. Réessayez plus tard.";
        break;
      case "auth/network-request-failed":
        errorMessage = "Erreur réseau. Vérifiez votre connexion.";
        break;
    }
    
    loginError.textContent = errorMessage;
    loginPassword.value = "";
    loginPassword.focus();
  }
  
  // Restaurer le bouton
  loginBtn.textContent = "Se connecter";
  loginBtn.disabled = false;
}

// Connexion réussie
function loginUserSuccess(userInfo, email) {
  currentUser = userInfo;
  _sessionValid = true;
  
  // Stocker le nom de l'utilisateur pour les notes
  window._sessionUserName = userInfo.name;
  
  // Masquer l'écran de login
  loginOverlay.classList.add('hidden');
  
  // Mettre à jour le badge utilisateur
  const statusDot = userStatusEl?.querySelector('.status-dot');
  const userName = userStatusEl?.querySelector('.user-name');
  
  if (statusDot) statusDot.classList.remove('offline');
  if (userName) userName.textContent = userInfo.name;
  if (btnAuth) {
    btnAuth.textContent = 'Déconnexion';
    btnAuth.classList.remove('login');
  }
  
  console.log("🔐 Session établie pour " + userInfo.name);
  
  // Charger les cartes depuis Firebase
  loadCardsFromFirebase();
}

// Déconnexion
async function logout() {
  try {
    await firebaseAuth.signOut();
    console.log("🔓 Déconnexion réussie");
  } catch(e) {
    console.error("Erreur déconnexion:", e);
  }
  
  _sessionValid = false;
  currentUser = null;
  location.reload();
}

// Bouton connexion/déconnexion
btnAuth?.addEventListener('click', () => {
  if (currentUser) {
    logout();
  } else {
    loginOverlay.classList.remove('hidden');
    loginPassword.focus();
  }
});

// ===== MODAL LOG =====
const logModal = document.getElementById('logModal');
const btnLog = document.getElementById('btnLog');
const closeLogModal = document.getElementById('closeLogModal');

btnLog.addEventListener('click', () => {
  renderLogEntries();
  logModal.classList.add('active');
});

closeLogModal.addEventListener('click', () => logModal.classList.remove('active'));

function addLogEntry(action, details) {
  // Utiliser le nom de l'utilisateur connecté
  let userName = 'Anonyme';
  if (currentUser?.email) {
    // Chercher le nom dans USER_CODES
    const userEmail = currentUser.email;
    for (const [code, data] of Object.entries(USER_CODES)) {
      if (data.email === userEmail) {
        userName = data.name;
        break;
      }
    }
  }
  
  const entry = {
    time: new Date().toLocaleString('fr-CA'),
    user: userName,
    action,
    details
  };
  logEntries.unshift(entry);
  if (logEntries.length > 100) logEntries.pop();
  
  // Note: Les logs restent locaux (pas de permission Firebase pour /logs)
}

function renderLogEntries() {
  const container = document.getElementById('logEntries');
  if (logEntries.length === 0) {
    container.innerHTML = '<div class="log-entry"><div class="log-time">Aucune entrée</div></div>';
    return;
  }
  
  container.innerHTML = logEntries.map(e => `
    <div class="log-entry">
      <div class="log-time">${e.time} - ${e.user}</div>
      <div><strong>${e.action}</strong>: ${e.details}</div>
    </div>
  `).join('');
}

// ===== MODAL AJOUTER MOULAGE =====
const addModal = document.getElementById('addModal');
const btnAddMoulage = document.getElementById('btnAddMoulage');
const closeAddModal = document.getElementById('closeAddModal');
const cancelAdd = document.getElementById('cancelAdd');
const confirmAdd = document.getElementById('confirmAdd');

btnAddMoulage.addEventListener('click', () => {
  if (!_sessionValid) {
    loginOverlay.classList.remove('hidden');
    loginPassword.focus();
    return;
  }
  addModal.classList.add('active');
  document.getElementById('addName').focus();
});

closeAddModal.addEventListener('click', () => addModal.classList.remove('active'));
cancelAdd.addEventListener('click', () => addModal.classList.remove('active'));

confirmAdd.addEventListener('click', () => {
  const name = document.getElementById('addName').value.trim() || 'Nom du moulage';
  const order = document.getElementById('addOrder').value.trim() || '000000';
  const region = document.getElementById('addRegion').value;
  
  createCard(name, order, region, 0);
  
  addModal.classList.remove('active');
  document.getElementById('addName').value = '';
  document.getElementById('addOrder').value = '';
  
  addLogEntry('Ajout', `Moulage "${name}" créé`);
  
  // Rafraîchir la table Robot si elle est active
  if (isRobotViewActive) {
    setTimeout(() => renderRobotTable(), 300);
  }
});

// ===== CRÉATION DE CARTE =====
function generateCardId() {
  return 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Raisons d'attente
const RAISONS_ATTENTE = [
  "En attente de pièces",
  "En attente d'approbation client",
  "En attente de réponse couture",
  "En attente de réponse atelier",
  "En attente de réponse robot",
  "En attente de posit",
  "En attente ROHO",
  "En attente de plaques d'aluminium",
  "En attente de fichiers de scans"
];

function createCard(name, order, region, columnIndex) {
  const cardId = generateCardId();
  const delay = MENU_DATA.delays[region] || 90;
  
  // Créer l'élément carte
  const card = document.createElement('div');
  card.className = 'mcard';
  card.dataset.cardId = cardId;
  
  // Classe région
  if (region === 'Québec') card.classList.add('region-qc');
  else if (region === 'Ontario') card.classList.add('region-on');
  else if (region === 'Maritime') card.classList.add('region-ma');
  
  // Marquer si colonne spéciale
  if (columnIndex === 7) card.classList.add('in-attente-column');
  if (columnIndex === 6) card.classList.add('in-expedition-column');
  
  const item = 'Siège';
  const isAttente = columnIndex === 7;
  const isExpedition = columnIndex === 6;
  let delayText = `Délai ${delay} j`;
  if (isAttente) delayText = '? Raison';
  else if (isExpedition) delayText = 'Expédié';
  
  card.innerHTML = `
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <input type="text" class="mcard-title" value="${name}" data-field="name">
        </div>
        <div class="mcard-order-line">
          <span class="mcard-region-pill">${region || '--'}</span>
          <input type="text" class="mcard-order" value="${order}" data-field="order" maxlength="6">
          <button class="mcard-toggle-btn" onclick="openFicheById('${cardId}')">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="mcard-delay-pill"><span>${delayText}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move">Déplacer</button>
      <button class="mcard-btn mcard-btn-delete">Supprimer</button>
    </div>
  `;
  
  // Stocker les données
  cardsData[cardId] = {
    name, order, region,
    columnIndex,
    item,
    raisonAttente: '',
    dateRecue: '',
    dateRobot: '',
    dateEssayage: '',
    client: '',
    intervenant: '',
    representant: '',
    notes: ''
  };
  
  // Ajouter à la colonne
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[columnIndex];
  if (targetCol) {
    targetCol.appendChild(card);
  }
  
  // Attacher les événements
  attachCardEvents(card);
  updateColumnCounts();
  
  // Sauvegarder dans Firebase
  saveCardToFirebase(cardId);
  
  return card;
}

function attachCardEvents(card) {
  const cardId = card.dataset.cardId;
  
  // Bouton toggle (ouvre fiche)
  card.querySelector('.mcard-toggle-btn')?.addEventListener('click', (e) => {
    e.stopPropagation();
    openFiche(card);
  });
  
  // Input titre - sync avec fiche
  const titleInput = card.querySelector('.mcard-title');
  titleInput?.addEventListener('focus', () => {
    titleInput.select(); // Sélectionner tout au clic
  });
  titleInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      titleInput.blur(); // Confirmer avec Enter
    }
  });
  titleInput?.addEventListener('blur', () => {
    if (cardsData[cardId]) {
      cardsData[cardId].name = titleInput.value || 'Nom du moulage';
      saveCardToFirebase(cardId);
    }
  });
  titleInput?.addEventListener('click', (e) => e.stopPropagation());
  
  // Input numéro commande - sync avec fiche
  const orderInput = card.querySelector('.mcard-order');
  orderInput?.addEventListener('focus', () => {
    orderInput.select(); // Sélectionner tout au clic
  });
  orderInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      orderInput.blur(); // Confirmer avec Enter
    }
  });
  // Permettre seulement les chiffres et limiter à 6 caractères
  orderInput?.addEventListener('input', () => {
    orderInput.value = orderInput.value.replace(/[^0-9]/g, '').slice(0, 6);
  });
  orderInput?.addEventListener('blur', () => {
    // Compléter avec des zéros si moins de 6 chiffres
    let value = orderInput.value.replace(/[^0-9]/g, '');
    value = value.padStart(6, '0').slice(0, 6);
    orderInput.value = value;
    if (cardsData[cardId]) {
      cardsData[cardId].order = value;
      saveCardToFirebase(cardId);
    }
  });
  orderInput?.addEventListener('click', (e) => e.stopPropagation());
  
  // Pastille Item - switch au clic
  const itemPill = card.querySelector('.mcard-item-pill');
  const items = ['Siège', 'Dossier', 'Siège + Dossier'];
  itemPill?.addEventListener('click', (e) => {
    e.stopPropagation();
    const currentItem = itemPill.textContent;
    const currentIndex = items.indexOf(currentItem);
    const nextIndex = (currentIndex + 1) % items.length;
    const newItem = items[nextIndex];
    itemPill.textContent = newItem;
    
    if (cardsData[cardId]) {
      cardsData[cardId].item = newItem;
      saveCardToFirebase(cardId);
    }
  });
  
  // Pastille délai - gère En attente ET Expédition
  const delayPill = card.querySelector('.mcard-delay-pill');
  delayPill?.addEventListener('click', (e) => {
    e.stopPropagation();
    
    // Si déjà expédié, ne rien faire
    if (cardsData[cardId]?.expedie) return;
    
    if (card.classList.contains('in-attente-column')) {
      // En attente: afficher menu raisons
      showRaisonAttenteMenu(card, delayPill);
    } else if (card.classList.contains('in-expedition-column')) {
      // Expédition: marquer comme expédié avec la date
      const today = new Date().toISOString().split('T')[0];
      const delaySpan = delayPill.querySelector('span');
      if (delaySpan) {
        delaySpan.textContent = `Expédié ${today}`;
      }
      delayPill.classList.add('expedie');
      
      if (cardsData[cardId]) {
        cardsData[cardId].expedie = true;
        cardsData[cardId].dateExpedition = today;
        saveCardToFirebase(cardId);
      }
      
      addLogEntry('Expédition', `Moulage "${cardsData[cardId]?.name}" expédié le ${today}`);
    }
  });
  
  // Bouton supprimer - avec confirmation
  card.querySelector('.mcard-btn-delete')?.addEventListener('click', (e) => {
    e.stopPropagation();
    showDeleteConfirm(card, cardId);
  });
  
  // Bouton déplacer
  card.querySelector('.mcard-btn-move')?.addEventListener('click', (e) => {
    e.stopPropagation();
    showMoveMenu(card);
  });
}

// Menu raison d'attente
function showRaisonAttenteMenu(card, pill) {
  const cardId = card.dataset.cardId;
  const currentRaison = cardsData[cardId]?.raisonAttente || '';
  
  const choice = prompt(
    `Choisir la raison:\n${RAISONS_ATTENTE.map((r, i) => `${i + 1}. ${r}`).join('\n')}\n\nEntrez le numéro (ou 0 pour effacer):`
  );
  
  if (choice !== null) {
    const index = parseInt(choice);
    const delaySpan = pill.querySelector('span');
    
    if (index === 0) {
      // Effacer la raison - arrêter le clignotement
      if (delaySpan) delaySpan.textContent = '? Raison';
      pill.classList.remove('attente-active');
      if (cardsData[cardId]) {
        cardsData[cardId].raisonAttente = '';
        cardsData[cardId].attenteActive = false;
        cardsData[cardId].dateAttente = '';
        saveCardToFirebase(cardId);
      }
    } else if (index >= 1 && index <= RAISONS_ATTENTE.length) {
      const raison = RAISONS_ATTENTE[index - 1];
      if (delaySpan) delaySpan.textContent = raison;
      // Activer le clignotement rouge
      pill.classList.add('attente-active');
      if (cardsData[cardId]) {
        cardsData[cardId].raisonAttente = raison;
        cardsData[cardId].attenteActive = true;
        // Enregistrer la date de mise en attente si pas déjà définie
        if (!cardsData[cardId].dateAttente) {
          cardsData[cardId].dateAttente = new Date().toLocaleDateString('fr-CA');
        }
        saveCardToFirebase(cardId);
      }
    }
  }
}

// ===== DÉPLACEMENT =====
const COL_NAMES = ['🤖 Robot', '📐 Dégauchage', '👔 Essayage', '🔧 Atelier', '🧵 Couture', '🎨 Peinture', '🚚 Expédition', '⏳ En attente'];
const COL_NAMES_SHORT = ['Robot', 'Dégauch.', 'Essayage', 'Atelier', 'Couture', 'Peinture', 'Expéd.', 'Attente'];
let cardToMove = null;

function showMoveMenu(card) {
  cardToMove = card;
  const currentCol = parseInt(card.closest('.col')?.dataset.col || 0);
  const moveColumns = document.getElementById('moveColumns');
  
  // Compter les cartes dans chaque colonne - SEULEMENT les colonnes du mainBoard
  const columns = document.querySelectorAll('#mainBoard .col');
  
  let html = '';
  columns.forEach((col, i) => {
    const cardsInCol = col.querySelectorAll('.mcard').length;
    const isCurrent = (i === currentCol);
    
    html += `
      <div class="move-column">
        <div class="move-column-header ${isCurrent ? 'current' : ''}">
          ${COL_NAMES_SHORT[i] || 'Col ' + (i+1)}
        </div>
        <div class="move-positions">
    `;
    
    // Positions disponibles: 1 à (nombre de cartes + 1)
    const maxPos = isCurrent ? cardsInCol : cardsInCol + 1;
    for (let pos = 1; pos <= maxPos; pos++) {
      if (isCurrent) {
        // Colonne actuelle - boutons désactivés
        html += `<div class="move-position-btn" style="opacity:0.4;cursor:default;">${pos}</div>`;
      } else {
        html += `<button class="move-position-btn" data-col="${i}" data-pos="${pos}">${pos}</button>`;
      }
    }
    
    // Si colonne vide et pas la colonne actuelle
    if (cardsInCol === 0 && !isCurrent) {
      html += `<button class="move-position-btn" data-col="${i}" data-pos="1">1</button>`;
    }
    
    html += `
        </div>
      </div>
    `;
  });
  
  moveColumns.innerHTML = html;
  
  // Ajouter les event listeners aux boutons de position
  moveColumns.querySelectorAll('.move-position-btn[data-col]').forEach(btn => {
    if (btn.tagName === 'BUTTON') {
      btn.addEventListener('click', () => {
        const targetCol = parseInt(btn.dataset.col);
        const targetPos = parseInt(btn.dataset.pos);
        moveCardToPosition(cardToMove, targetCol, targetPos);
        closeMoveMenu();
      });
    }
  });
  
  document.getElementById('moveOverlay').classList.remove('hidden');
}

function closeMoveMenu() {
  document.getElementById('moveOverlay').classList.add('hidden');
  cardToMove = null;
}

// Déplacer une carte vers une colonne à une position spécifique
function moveCardToPosition(card, targetColIndex, position) {
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[targetColIndex];
  const cardId = card.dataset.cardId;
  
  if (targetCol) {
    const cardsInTarget = targetCol.querySelectorAll('.mcard');
    
    // Position 1 = premier, position 2 = après la 1ère carte, etc.
    if (position <= 1 || cardsInTarget.length === 0) {
      // Insérer au début
      targetCol.insertBefore(card, cardsInTarget[0] || null);
    } else if (position > cardsInTarget.length) {
      // Insérer à la fin
      targetCol.appendChild(card);
    } else {
      // Insérer avant la carte à la position
      targetCol.insertBefore(card, cardsInTarget[position - 1]);
    }
    
    // Mettre à jour l'affichage de la pastille délai
    updateCardDelayPill(card, cardId, targetColIndex);
    
    if (cardsData[cardId]) {
      cardsData[cardId].columnIndex = targetColIndex;
      saveCardToFirebase(cardId);
    }
    
    updateColumnCounts();
    addLogEntry('Déplacement', `Moulage déplacé vers ${COL_NAMES_SHORT[targetColIndex]} position ${position}`);
  }
}

// Mise à jour de la pastille délai selon la colonne
function updateCardDelayPill(card, cardId, targetColIndex) {
  const delayPill = card.querySelector('.mcard-delay-pill');
  const delaySpan = delayPill?.querySelector('span');
  
  // Retirer les classes de colonne spéciale
  card.classList.remove('in-attente-column', 'in-expedition-column');
  delayPill?.classList.remove('attente-active');
  
  // Si DÉJÀ expédié, garder le statut permanent
  if (cardsData[cardId]?.expedie && cardsData[cardId]?.dateExpedition) {
    if (delaySpan) delaySpan.textContent = `Expédié ${cardsData[cardId].dateExpedition}`;
    delayPill?.classList.add('expedie');
  } else if (targetColIndex === 7) {
    // Vers En attente - enregistrer la date
    card.classList.add('in-attente-column');
    if (cardsData[cardId] && !cardsData[cardId].dateAttente) {
      cardsData[cardId].dateAttente = new Date().toLocaleDateString('fr-CA');
    }
    if (delaySpan) {
      const raison = cardsData[cardId]?.raisonAttente;
      delaySpan.textContent = raison || '? Raison';
      if (raison && cardsData[cardId]?.attenteActive) {
        delayPill?.classList.add('attente-active');
      }
    }
  } else if (targetColIndex === 6) {
    // Vers Expédition
    card.classList.add('in-expedition-column');
    if (delaySpan) {
      delaySpan.textContent = 'Expédier';
    }
  } else {
    // Autres colonnes
    if (delaySpan && cardsData[cardId]) {
      const delay = calculateRemainingDelay(cardsData[cardId]);
      delaySpan.textContent = `Délai ${delay} j`;
    }
  }
}

// Event listeners pour fermer le menu
document.getElementById('moveClose')?.addEventListener('click', closeMoveMenu);
document.getElementById('moveOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'moveOverlay') closeMoveMenu();
});

// ===== CONFIRMATION SUPPRESSION =====
let cardToDelete = null;
let cardIdToDelete = null;

function showDeleteConfirm(card, cardId) {
  cardToDelete = card;
  cardIdToDelete = cardId;
  const name = cardsData[cardId]?.name || 'ce moulage';
  document.getElementById('confirmMessage').textContent = `Voulez-vous vraiment supprimer "${name}"?`;
  document.getElementById('confirmOverlay').classList.remove('hidden');
}

function closeDeleteConfirm() {
  document.getElementById('confirmOverlay').classList.add('hidden');
  cardToDelete = null;
  cardIdToDelete = null;
}

function confirmDelete() {
  if (cardToDelete && cardIdToDelete) {
    const name = cardsData[cardIdToDelete]?.name || 'Inconnu';
    cardToDelete.remove();
    delete cardsData[cardIdToDelete];
    updateColumnCounts();
    deleteCardFromFirebase(cardIdToDelete);
    addLogEntry('Suppression', `Moulage "${name}" supprimé`);
  }
  closeDeleteConfirm();
}

// Event listeners pour confirmation
document.getElementById('confirmYes')?.addEventListener('click', confirmDelete);
document.getElementById('confirmNo')?.addEventListener('click', closeDeleteConfirm);
document.getElementById('confirmOverlay')?.addEventListener('click', (e) => {
  if (e.target.id === 'confirmOverlay') closeDeleteConfirm();
});

function moveCardToColumn(card, targetColIndex) {
  const columns = document.querySelectorAll('.col');
  const targetCol = columns[targetColIndex];
  const cardId = card.dataset.cardId;
  
  if (targetCol) {
    targetCol.appendChild(card);
    
    const delayPill = card.querySelector('.mcard-delay-pill');
    const delaySpan = delayPill?.querySelector('span');
    
    // Retirer les classes de colonne spéciale
    card.classList.remove('in-attente-column', 'in-expedition-column');
    delayPill?.classList.remove('attente-active');
    
    // Si DÉJÀ expédié, garder le statut permanent
    if (cardsData[cardId]?.expedie && cardsData[cardId]?.dateExpedition) {
      if (delaySpan) delaySpan.textContent = `Expédié ${cardsData[cardId].dateExpedition}`;
      delayPill?.classList.add('expedie');
    } else if (targetColIndex === 7) {
      // Vers En attente: afficher "? Raison" ou la raison existante
      card.classList.add('in-attente-column');
      if (delaySpan) {
        const raison = cardsData[cardId]?.raisonAttente;
        delaySpan.textContent = raison || '? Raison';
        if (raison && cardsData[cardId]?.attenteActive) {
          delayPill?.classList.add('attente-active');
        }
      }
    } else if (targetColIndex === 6) {
      // Vers Expédition: afficher "Expédier"
      card.classList.add('in-expedition-column');
      if (delaySpan) {
        delaySpan.textContent = 'Expédier';
      }
    } else {
      // Autres colonnes: afficher le délai
      if (delaySpan && cardsData[cardId]) {
        const delay = calculateRemainingDelay(cardsData[cardId]);
        delaySpan.textContent = `Délai ${delay} j`;
      }
    }
    
    if (cardsData[cardId]) {
      cardsData[cardId].columnIndex = targetColIndex;
      saveCardToFirebase(cardId);
    }
    
    updateColumnCounts();
    addLogEntry('Déplacement', `Moulage déplacé vers colonne ${targetColIndex}`);
  }
}

// ===== COMPTEURS COLONNES =====
function updateColumnCounts() {
  document.querySelectorAll('#mainBoard .col').forEach(col => {
    const count = col.querySelectorAll('.mcard').length;
    const countEl = col.querySelector('.col-count');
    if (countEl) countEl.textContent = count;
  });
}

// ===== RECHERCHE =====
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');

searchInput.addEventListener('input', () => {
  const term = searchInput.value.toLowerCase();
  
  // Recherche dans la page active
  if (currentPage === 'moulages') {
    document.querySelectorAll('#mainBoard .mcard').forEach(card => {
      const title = card.querySelector('.mcard-title')?.value?.toLowerCase() || '';
      const order = card.querySelector('.mcard-order')?.value?.toLowerCase() || '';
      const match = title.includes(term) || order.includes(term);
      card.style.display = match ? '' : 'none';
    });
  } else {
    document.querySelectorAll('#commandesBoard .mcard').forEach(card => {
      const title = card.querySelector('.mcard-title')?.value?.toLowerCase() || '';
      const order = card.querySelector('.mcard-order')?.value?.toLowerCase() || '';
      const match = title.includes(term) || order.includes(term);
      card.style.display = match ? '' : 'none';
    });
  }
});

searchClear.addEventListener('click', () => {
  searchInput.value = '';
  document.querySelectorAll('.mcard').forEach(card => card.style.display = '');
});

// ===== FIREBASE SYNC =====
function saveCardToFirebase(cardId) {
  if (!firebaseInitialized) return;
  
  const data = cardsData[cardId];
  if (data) {
    firebase.database().ref('cards/' + cardId).set(data);
  }
}

function deleteCardFromFirebase(cardId) {
  if (!firebaseInitialized) return;
  firebase.database().ref('cards/' + cardId).remove();
}

function loadCardsFromFirebase() {
  if (!firebaseInitialized) return;
  
  // Écoute en temps réel des changements
  firebase.database().ref('cards').on('value', snapshot => {
    const data = snapshot.val();
    
    // Supprimer les cartes MOULAGES qui n'existent plus dans Firebase (pas les commandes)
    document.querySelectorAll('#mainBoard .mcard[data-card-id]').forEach(card => {
      const cardId = card.dataset.cardId;
      if (!data || !data[cardId]) {
        card.remove();
        delete cardsData[cardId];
      }
    });
    
    if (data) {
      Object.keys(data).forEach(cardId => {
        const cardData = data[cardId];
        cardsData[cardId] = cardData;
        
        // Vérifier si la carte existe déjà
        let card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
        const isAttente = (cardData.columnIndex === 7);
        const isExpedition = (cardData.columnIndex === 6);
        
        if (card) {
          // Mettre à jour la carte existante
          const titleInput = card.querySelector('.mcard-title');
          const orderInput = card.querySelector('.mcard-order');
          if (titleInput) titleInput.value = cardData.name || 'Nom du moulage';
          if (orderInput) orderInput.value = cardData.order || '000000';
          
          // Mettre à jour la région et colonnes spéciales
          card.classList.remove('region-qc', 'region-on', 'region-ma', 'in-attente-column', 'in-expedition-column');
          if (cardData.region === 'Québec') card.classList.add('region-qc');
          else if (cardData.region === 'Ontario') card.classList.add('region-on');
          else if (cardData.region === 'Maritime') card.classList.add('region-ma');
          if (isAttente) card.classList.add('in-attente-column');
          if (isExpedition) card.classList.add('in-expedition-column');
          
          // Mettre à jour la pastille délai
          const delayPill = card.querySelector('.mcard-delay-pill');
          const delaySpan = delayPill?.querySelector('span');
          
          // Retirer les classes de pastille
          delayPill?.classList.remove('expedie', 'attente-active');
          
          if (delaySpan) {
            if (cardData.expedie && cardData.dateExpedition) {
              // Expédié permanent
              delaySpan.textContent = `Expédié ${cardData.dateExpedition}`;
              delayPill.classList.add('expedie');
            } else if (isAttente) {
              delaySpan.textContent = cardData.raisonAttente || '? Raison';
              // Activer clignotement si raison sélectionnée
              if (cardData.raisonAttente && cardData.attenteActive) {
                delayPill.classList.add('attente-active');
              }
            } else if (isExpedition) {
              delaySpan.textContent = 'Expédier';
            } else {
              const delay = calculateRemainingDelay(cardData);
              delaySpan.textContent = `Délai ${delay} j`;
            }
          }
          
          // Déplacer si nécessaire
          const columns = document.querySelectorAll('#mainBoard .col');
          const currentCol = card.closest('.col');
          const targetCol = columns[cardData.columnIndex || 0];
          if (currentCol !== targetCol && targetCol) {
            targetCol.appendChild(card);
          }
        } else {
          // Créer nouvelle carte
          card = document.createElement('div');
          card.className = 'mcard';
          card.dataset.cardId = cardId;
          
          if (cardData.region === 'Québec') card.classList.add('region-qc');
          else if (cardData.region === 'Ontario') card.classList.add('region-on');
          else if (cardData.region === 'Maritime') card.classList.add('region-ma');
          if (isAttente) card.classList.add('in-attente-column');
          
          const isExpedition = (cardData.columnIndex === 6);
          if (isExpedition) card.classList.add('in-expedition-column');
          
          const delay = calculateRemainingDelay(cardData);
          const item = cardData.item || 'Siège';
          
          // Déterminer le texte et les classes de la pastille délai
          let delayText = `Délai ${delay} j`;
          let delayClasses = 'mcard-delay-pill';
          
          if (cardData.expedie && cardData.dateExpedition) {
            // Expédié permanent
            delayText = `Expédié ${cardData.dateExpedition}`;
            delayClasses += ' expedie';
          } else if (isAttente) {
            delayText = cardData.raisonAttente || '? Raison';
            // Si raison sélectionnée, activer le clignotement
            if (cardData.raisonAttente && cardData.attenteActive) {
              delayClasses += ' attente-active';
            }
          } else if (isExpedition) {
            delayText = 'Expédié';
          }
          
          const regionText = cardData.region || '--';
          
          card.innerHTML = `
            <div class="mcard-header">
              <div class="mcard-info">
                <div class="mcard-title-line">
                  <input type="text" class="mcard-title" value="${cardData.name || 'Nom du moulage'}" data-field="name">
                </div>
                <div class="mcard-order-line">
                  <span class="mcard-region-pill">${regionText}</span>
                  <input type="text" class="mcard-order" value="${cardData.order || '000000'}" data-field="order" maxlength="6">
                  <button class="mcard-toggle-btn" onclick="openFicheById('${cardId}')">Fiche</button>
                </div>
              </div>
            </div>
            <div class="mcard-separator"></div>
            <div class="${delayClasses}"><span>${delayText}</span></div>
            <div class="mcard-footer-buttons">
              <button class="mcard-btn mcard-btn-move">Déplacer</button>
              <button class="mcard-btn mcard-btn-delete">Supprimer</button>
            </div>
          `;
          
          const columns = document.querySelectorAll('#mainBoard .col');
          const targetCol = columns[cardData.columnIndex || 0];
          if (targetCol) targetCol.appendChild(card);
          
          attachCardEvents(card);
        }
      });
      
      updateColumnCounts();
      console.log(`✅ ${Object.keys(data).length} cartes synchronisées`);
    } else {
      updateColumnCounts();
    }
  });
}

// Calculer le délai restant basé sur dateRobot, en jours ouvrables
function calculateRemainingDelay(cardData) {
  const baseDelay = MENU_DATA.delays[cardData.region] || 90;
  
  // Si expédié, retourner 0
  if (cardData.expedie) {
    return 0;
  }
  
  // Le délai commence à partir de dateRobot (date fabriquée au robot)
  if (cardData.dateRobot) {
    const dateRobot = new Date(cardData.dateRobot);
    const today = new Date();
    
    // Calculer les jours ouvrables écoulés (excluant weekends et fériés)
    const joursOuvrablesEcoules = calculerJoursOuvrables(dateRobot, today);
    
    const remaining = baseDelay - joursOuvrablesEcoules;
    return remaining > 0 ? remaining : 0;
  }
  
  return baseDelay;
}

// ===== FICHE MOULAGE =====
let currentExpandedCard = null;
let cardOverlay = null;

// Initialiser l'overlay
function initCardOverlay() {
  cardOverlay = document.getElementById('cardOverlay');
  if (cardOverlay) {
    cardOverlay.addEventListener('click', () => {
      if (currentExpandedCard) closeFiche();
    });
  }
}

// Appeler après le chargement du DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCardOverlay);
} else {
  initCardOverlay();
}

// Calculer le nombre de jours depuis la mise en attente
function calcJoursAttente(dateAttente) {
  if (!dateAttente) return 0;
  const dateDebut = new Date(dateAttente);
  const today = new Date();
  const diffTime = Math.abs(today - dateDebut);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

function openFiche(card) {
  if (!card) return;
  if (currentExpandedCard) closeFiche();
  
  // S'assurer que l'overlay existe
  if (!cardOverlay) {
    cardOverlay = document.getElementById('cardOverlay');
  }
  
  const cardId = card.dataset.cardId;
  
  // Générer la fiche si pas déjà fait
  if (!card.querySelector('.mcard-fiche')) {
    card.insertAdjacentHTML('beforeend', generateFicheHTML(card));
    attachFicheEvents(card);
  } else {
    // Mettre à jour la section En attente si elle existe déjà
    const attenteSection = card.querySelector('.fiche-attente-section');
    if (attenteSection) {
      const data = cardsData[cardId] || {};
      if (data.columnIndex === 7) {
        attenteSection.classList.add('visible');
        const badge = attenteSection.querySelector('.attente-badge-full');
        const days = attenteSection.querySelector('.attente-days-full');
        if (badge) badge.textContent = '⏳ EN ATTENTE: ' + (data.raisonAttente || 'Raison non spécifiée');
        if (days) days.textContent = 'En attente depuis ' + (data.dateAttente || '---') + ' (' + calcJoursAttente(data.dateAttente) + ' jours)';
      } else {
        attenteSection.classList.remove('visible');
      }
    }
  }
  
  card.classList.add('mcard-expanded');
  if (cardOverlay) cardOverlay.classList.add('active');
  currentExpandedCard = card;
  
  // Marquer les notes comme lues
  if (cardId) {
    markNoteAsRead(cardId);
  }
}

function closeFiche() {
  if (currentExpandedCard) {
    currentExpandedCard.classList.remove('mcard-expanded');
    // Fermer les popups
    currentExpandedCard.querySelector('.fiche-calendar-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.dept-dates-popup')?.classList.remove('active');
    currentExpandedCard.querySelector('.fiche-notes')?.classList.remove('expanded');
  }
  if (cardOverlay) cardOverlay.classList.remove('active');
  currentExpandedCard = null;
}

window.closeFicheCard = closeFiche;

// Ouvrir fiche par ID (pour onclick)
function openFicheById(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (card) {
    openFiche(card);
  }
}
window.openFicheById = openFicheById;

function generateFicheHTML(card) {
  const cardId = card.dataset.cardId;
  const data = cardsData[cardId] || {};
  
  // Pré-calculer les jours d'attente
  const joursAttente = calcJoursAttente(data.dateAttente);
  const isEnAttente = data.columnIndex === 7;
  
  const clientOptions = MENU_DATA.clients.map(c => 
    `<option value="${c}" ${data.client === c ? 'selected' : ''}>${c}</option>`
  ).join('');
  
  const intervenantOptions = MENU_DATA.intervenants.map(i => 
    `<option value="${i}" ${data.intervenant === i ? 'selected' : ''}>${i}</option>`
  ).join('');
  
  return `
    <div class="mcard-fiche" data-card-id="${cardId}">
      <div class="fiche-header">
        <div class="fiche-logo"><img src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Physipro"/></div>
        <div class="fiche-title">
          <h3>Fiche Moulage</h3>
          <div class="fiche-subtitle">Outil de gestion des moulages</div>
        </div>
        <div style="width:40px;"></div>
      </div>
      
      <div class="fiche-section">
        <h4>Informations générales</h4>
        <div class="fiche-grid-2">
          <div class="fiche-field">
            <div class="fiche-label">Client</div>
            <select class="fiche-select" data-fiche-field="client">
              <option value="">-- Sélectionner --</option>
              ${clientOptions}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Nom du moulage</div>
            <input type="text" class="fiche-input" data-fiche-field="name" value="${data.name || ''}" placeholder="Nom...">
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Date reçue</div>
            <div class="fiche-date-pill" data-fiche-field="dateRecue">${data.dateRecue || 'AAAA-MM-JJ'}</div>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date fabriquée au robot</div>
            <div class="fiche-date-pill" data-fiche-field="dateRobot">${data.dateRobot || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Numéro de commande</div>
            <input type="text" class="fiche-input" data-fiche-field="order" value="${data.order || ''}" placeholder="000000">
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Numéro PO</div>
            <input type="text" class="fiche-input" data-fiche-field="numeroPO" value="${data.numeroPO || ''}" placeholder="000000">
          </div>
        </div>
        <div class="fiche-grid-3" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Région</div>
            <select class="fiche-select" data-fiche-field="region">
              <option value="">-- Sélectionner --</option>
              <option value="Québec" ${data.region === 'Québec' ? 'selected' : ''}>Québec</option>
              <option value="Ontario" ${data.region === 'Ontario' ? 'selected' : ''}>Ontario</option>
              <option value="Maritime" ${data.region === 'Maritime' ? 'selected' : ''}>Maritime</option>
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Intervenant</div>
            <select class="fiche-select" data-fiche-field="intervenant">
              <option value="">-- Sélectionner --</option>
              ${intervenantOptions}
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Contenu</div>
            <select class="fiche-select" data-fiche-field="item">
              <option value="">-- Sélectionner --</option>
              <option value="Siège" ${data.item === 'Siège' ? 'selected' : ''}>Siège</option>
              <option value="Dossier" ${data.item === 'Dossier' ? 'selected' : ''}>Dossier</option>
              <option value="Siège + Dossier" ${data.item === 'Siège + Dossier' ? 'selected' : ''}>Siège + Dossier</option>
            </select>
          </div>
        </div>
        <div class="fiche-grid-2" style="margin-top:6px;">
          <div class="fiche-field">
            <div class="fiche-label">Représentante</div>
            <select class="fiche-select" data-fiche-field="representant">
              <option value="">-- Sélectionner --</option>
              <option value="Marie-Soleil" ${data.representant === 'Marie-Soleil' ? 'selected' : ''}>Marie-Soleil</option>
              <option value="Marie-Piers" ${data.representant === 'Marie-Piers' ? 'selected' : ''}>Marie-Piers</option>
            </select>
          </div>
          <div class="fiche-field">
            <div class="fiche-label">Date rendez-vous essayage</div>
            <div class="fiche-date-pill" data-fiche-field="dateEssayage">${data.dateEssayage || 'AAAA-MM-JJ'}</div>
          </div>
        </div>
      </div>
      
      <!-- Section En attente - VISIBLE SEULEMENT SI EN ATTENTE -->
      <div class="fiche-attente-section ${isEnAttente ? 'visible' : ''}" id="ficheAttenteSection_${cardId}">
        <div class="attente-badge-full">⏳ EN ATTENTE: ${data.raisonAttente || 'Raison non spécifiée'}</div>
        <div class="attente-days-full">En attente depuis ${data.dateAttente || '---'} (${joursAttente} jours)</div>
      </div>
      
      <!-- Section Durées - Design propre -->
      <div class="fiche-durations-section">
        <div class="dur-item dur-date">
          <div class="dur-item-label">Robot</div>
          <div class="dur-item-value clickable dept-date-link" data-dept-field="dateRobot">${data.dateRobot || 'AAAA-MM-JJ'}</div>
        </div>
        <div class="dur-item">
          <div class="dur-item-label">Dégauchage</div>
          <div class="dur-item-value">${data.daysDegauchage || '-'}j</div>
        </div>
        <div class="dur-item">
          <div class="dur-item-label">Essayage</div>
          <div class="dur-item-value">${data.daysEssayage || '-'}j</div>
        </div>
        <div class="dur-item">
          <div class="dur-item-label">Atelier</div>
          <div class="dur-item-value">${data.daysAtelier || '-'}j</div>
        </div>
        <div class="dur-item">
          <div class="dur-item-label">Couture</div>
          <div class="dur-item-value">${data.daysCouture || '-'}j</div>
        </div>
        <div class="dur-item">
          <div class="dur-item-label">Peinture</div>
          <div class="dur-item-value">${data.daysPeinture || '-'}j</div>
        </div>
        <div class="dur-item dur-date">
          <div class="dur-item-label">Expédition</div>
          <div class="dur-item-value clickable dept-date-link" data-dept-field="dateExpedition">${data.dateExpedition || 'AAAA-MM-JJ'}</div>
        </div>
        <div class="dur-item total">
          <div class="dur-item-label">Total</div>
          <div class="dur-item-value">${data.totalDays || '-'}j</div>
        </div>
      </div>
      
      <!-- Section Photos - Compacte -->
      <div class="fiche-photos-section">
        <div class="photos-row">
          <span class="photos-label" onclick="openPhotosMenu('${cardId}', event)">📷 Photos</span>
          <button class="photo-btn ${data.photoClient ? 'has-link' : ''}" onclick="openPhotoFromPill('${cardId}', 'client', event)">Client</button>
          <button class="photo-btn ${data.photoAtelier ? 'has-link' : ''}" onclick="openPhotoFromPill('${cardId}', 'atelier', event)">Atelier</button>
          <button class="photo-btn ${data.photoDevis ? 'has-link' : ''}" onclick="openPhotoFromPill('${cardId}', 'devis', event)">Vie + Modif</button>
        </div>
      </div>
      
      <!-- Popup Photos menu (quand on clique sur le titre Photos) -->
      <div class="photos-menu-popup" id="photosMenuPopup" style="display:none;">
        <div class="photos-menu-header">📷 Gérer les liens photos</div>
        <div class="photos-menu-field">
          <label>Photo Client:</label>
          <input type="url" id="photoLinkClient" value="${data.photoClient || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Photo Atelier:</label>
          <input type="url" id="photoLinkAtelier" value="${data.photoAtelier || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-field">
          <label>Photo Vie + Modif:</label>
          <input type="url" id="photoLinkDevis" value="${data.photoDevis || ''}" placeholder="https://..."/>
        </div>
        <div class="photos-menu-btns">
          <button onclick="saveAllPhotoLinks('${cardId}')">💾 Enregistrer</button>
          <button onclick="closePhotosMenu()">Fermer</button>
        </div>
      </div>
      
      <!-- Calendrier popup visuel -->
      <div class="fiche-calendar-popup">
        <div class="cal-header">
          <div class="cal-title">Sélectionner une date</div>
        </div>
        <div class="cal-nav">
          <button class="cal-prev">◀</button>
          <span class="cal-month-year">Décembre 2024</span>
          <button class="cal-next">▶</button>
        </div>
        <div class="cal-weekdays">
          <div class="cal-weekday">Dim</div>
          <div class="cal-weekday">Lun</div>
          <div class="cal-weekday">Mar</div>
          <div class="cal-weekday">Mer</div>
          <div class="cal-weekday">Jeu</div>
          <div class="cal-weekday">Ven</div>
          <div class="cal-weekday">Sam</div>
        </div>
        <div class="cal-days"></div>
        <div class="cal-buttons">
          <button class="btn-today">Aujourd'hui</button>
          <button class="btn-close-cal">Fermer</button>
        </div>
      </div>
      
      <!-- Popup dates département avec calendriers -->
      <div class="dept-dates-popup">
        <h4 class="dept-popup-title">Département</h4>
        <div class="dept-date-field">
          <label>Date d'entrée</label>
          <div class="dept-cal-container" data-type="entree"></div>
        </div>
        <div class="dept-date-field">
          <label>Date de sortie</label>
          <div class="dept-cal-container" data-type="sortie"></div>
        </div>
        <div class="dept-popup-buttons">
          <button class="btn-save">Sauvegarder</button>
          <button class="btn-cancel">Annuler</button>
        </div>
      </div>
      
      <!-- Bouton Fermer en bas -->
      <div class="fiche-footer-btns">
        <button class="fiche-close-btn-right" onclick="closeFicheCard()" style="flex:1;">Fermer</button>
      </div>
    </div>
    
    <!-- Page Notes à droite -->
    <div class="mcard-notes-page" data-card-id="${cardId}">
      <div class="notes-page-header">
        <span onclick="togglePhotosLinks('${cardId}')" style="cursor:pointer;">📝 Notes</span>
      </div>
      
      <!-- 6 boutons photos sur une ligne -->
      <div class="notes-photos-row">
        <button class="notes-photo-btn ${data.notePhoto1 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 1)">Photo 1</button>
        <button class="notes-photo-btn ${data.notePhoto2 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 2)">Photo 2</button>
        <button class="notes-photo-btn ${data.notePhoto3 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 3)">Photo 3</button>
        <button class="notes-photo-btn ${data.notePhoto4 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 4)">Photo 4</button>
        <button class="notes-photo-btn ${data.notePhoto5 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 5)">Photo 5</button>
        <button class="notes-photo-btn ${data.notePhoto6 ? 'has-link' : ''}" onclick="openNotePhoto('${cardId}', 6)">Photo 6</button>
      </div>
      
      <!-- Zone de liens photos (cachée par défaut) -->
      <div class="notes-photos-links" id="notesPhotosLinks_${cardId}" style="display:none;">
        <div class="photo-link-row">
          <label>Photo 1:</label>
          <input type="url" id="photoLink1_${cardId}" value="${data.notePhoto1 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 2:</label>
          <input type="url" id="photoLink2_${cardId}" value="${data.notePhoto2 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 3:</label>
          <input type="url" id="photoLink3_${cardId}" value="${data.notePhoto3 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 4:</label>
          <input type="url" id="photoLink4_${cardId}" value="${data.notePhoto4 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 5:</label>
          <input type="url" id="photoLink5_${cardId}" value="${data.notePhoto5 || ''}" placeholder="https://...">
        </div>
        <div class="photo-link-row">
          <label>Photo 6:</label>
          <input type="url" id="photoLink6_${cardId}" value="${data.notePhoto6 || ''}" placeholder="https://...">
        </div>
        <button class="save-photos-btn" onclick="savePhotosLinks('${cardId}')">Enregistrer</button>
      </div>
      
      <!-- Zone de texte avec notes signées -->
      <textarea class="notes-page-textarea" id="notesTextarea_${cardId}" 
        placeholder="Cliquez ici pour écrire..."
        onfocus="prepareNoteWithSignature('${cardId}')"
        onblur="saveMoulageNotes('${cardId}')">${data.notes || ''}</textarea>
    </div>
  `;
}

// Afficher/masquer la zone de liens photos
function togglePhotosLinks(cardId) {
  const linksDiv = document.getElementById('notesPhotosLinks_' + cardId);
  if (linksDiv) {
    linksDiv.style.display = linksDiv.style.display === 'none' ? 'block' : 'none';
  }
}

// Sauvegarder les liens photos
function savePhotosLinks(cardId) {
  for (let i = 1; i <= 6; i++) {
    const input = document.getElementById('photoLink' + i + '_' + cardId);
    if (input) {
      cardsData[cardId]['notePhoto' + i] = input.value.trim();
    }
  }
  saveCardToFirebase(cardId);
  
  // Mettre à jour les boutons
  for (let i = 1; i <= 6; i++) {
    const btn = document.querySelectorAll(`.mcard-notes-page[data-card-id="${cardId}"] .notes-photo-btn`)[i-1];
    if (btn) {
      if (cardsData[cardId]['notePhoto' + i]) {
        btn.classList.add('has-link');
      } else {
        btn.classList.remove('has-link');
      }
    }
  }
  
  // Masquer la zone de liens
  togglePhotosLinks(cardId);
}

// Ouvrir/gérer un lien photo dans les notes
function openNotePhoto(cardId, photoNum) {
  const fieldName = 'notePhoto' + photoNum;
  const currentUrl = cardsData[cardId]?.[fieldName] || '';
  
  if (currentUrl) {
    window.open(currentUrl, '_blank');
  } else {
    const newUrl = prompt('Entrer le lien pour Photo ' + photoNum + ':', '');
    if (newUrl && newUrl.trim()) {
      cardsData[cardId][fieldName] = newUrl.trim();
      saveCardToFirebase(cardId);
      
      // Mettre à jour le bouton
      const btns = document.querySelectorAll(`.mcard-notes-page[data-card-id="${cardId}"] .notes-photo-btn`);
      if (btns[photoNum - 1]) btns[photoNum - 1].classList.add('has-link');
    }
  }
}

// Préparer la note avec signature dans la zone de texte
function prepareNoteWithSignature(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
  
  const currentText = textarea.value;
  
  // Vérifier si le texte finit déjà par une signature avec EXACTEMENT la même heure
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('— ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    // Extraire l'heure de la dernière signature
    const match = lastSignatureLine.match(/— .+ \((\d{4}-\d{2}-\d{2}) à (\d{2}:\d{2})\) —/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      // Vérifier si c'est exactement la même date ET la même minute
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    // Ajouter la signature avec une ligne vide avant si besoin
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  // Placer le curseur à la fin (sur la nouvelle ligne)
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

// Sauvegarder les notes du moulage
function saveMoulageNotes(cardId) {
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (textarea && cardsData[cardId]) {
    cardsData[cardId].notes = textarea.value;
    saveCardToFirebase(cardId);
  }
}

// Fonctions notes commande avec signature
function prepareCmdNoteWithSignature(cmdId) {
  const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
  
  const currentText = textarea.value;
  
  // Vérifier si le texte finit déjà par une signature avec EXACTEMENT la même heure
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('— ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    const match = lastSignatureLine.match(/— .+ \((\d{4}-\d{2}-\d{2}) à (\d{2}:\d{2})\) —/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

// Fonction pour la zone de notes intégrée dans Magasin
function prepareCmdNoteSignature(cmdId) {
  prepareCmdNoteWithSignature(cmdId);
}

function saveCmdNotesInline(cmdId) {
  const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
  if (textarea && commandesData[cmdId]) {
    commandesData[cmdId].notes = textarea.value;
    saveCommandeToFirebase(cmdId);
  }
}

function toggleCmdNotesZone(cmdId) {
  const notesZone = document.getElementById('cmdNotesCollapsible_' + cmdId);
  const toggleBtn = document.getElementById('cmdNotesToggleBtn_' + cmdId);
  if (!notesZone) return;
  
  if (notesZone.style.display === 'none') {
    notesZone.style.display = 'flex';
    notesZone.style.flexDirection = 'column';
    toggleBtn.textContent = '📝 Fermer Notes';
    // Focus sur le textarea
    setTimeout(() => {
      const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
      if (textarea) {
        textarea.focus();
      }
    }, 100);
  } else {
    notesZone.style.display = 'none';
    toggleBtn.textContent = '📝 Notes';
  }
}

function saveCmdNotes(cmdId) {
  const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
  if (textarea && commandesData[cmdId]) {
    commandesData[cmdId].notes = textarea.value;
    saveCommandeToFirebase(cmdId);
    
    // Mettre à jour la preview
    const preview = document.querySelector('#cmdNotesCompact_' + cmdId + ' .cmd-notes-preview');
    if (preview) {
      preview.textContent = textarea.value ? textarea.value.substring(0, 50) + '...' : 'Cliquez pour ajouter une note...';
    }
  }
}

// Fonctions pour expand/collapse notes commande
function expandCmdNotes(cmdId) {
  const compact = document.getElementById('cmdNotesCompact_' + cmdId);
  const expanded = document.getElementById('cmdNotesExpanded_' + cmdId);
  if (compact) compact.style.display = 'none';
  if (expanded) {
    expanded.style.display = 'flex';
    const textarea = document.getElementById('cmdNotesTextarea_' + cmdId);
    if (textarea) {
      textarea.focus();
    }
  }
}

function collapseCmdNotes(cmdId) {
  const compact = document.getElementById('cmdNotesCompact_' + cmdId);
  const expanded = document.getElementById('cmdNotesExpanded_' + cmdId);
  if (compact) compact.style.display = 'flex';
  if (expanded) expanded.style.display = 'none';
  saveCmdNotes(cmdId);
}

let currentCalendarField = null;
let currentDeptName = null;
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();

const MOIS_FR = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

function renderCalendar(fiche, selectedDate) {
  const daysContainer = fiche.querySelector('.cal-days');
  const monthYearEl = fiche.querySelector('.cal-month-year');
  
  monthYearEl.textContent = `${MOIS_FR[calendarMonth]} ${calendarYear}`;
  
  // Premier jour du mois
  const firstDay = new Date(calendarYear, calendarMonth, 1);
  const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
  const startDay = firstDay.getDay(); // 0 = dimanche
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  let html = '';
  
  // Jours du mois précédent
  const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevMonthLastDay - i;
    html += `<button class="cal-day other-month" data-date="">${day}</button>`;
  }
  
  // Jours du mois courant
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let classes = 'cal-day';
    if (dateStr === todayStr) classes += ' today';
    if (dateStr === selectedDate) classes += ' selected';
    html += `<button class="${classes}" data-date="${dateStr}">${day}</button>`;
  }
  
  // Jours du mois suivant
  const totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
  const remainingCells = totalCells - (startDay + lastDay.getDate());
  for (let day = 1; day <= remainingCells; day++) {
    html += `<button class="cal-day other-month" data-date="">${day}</button>`;
  }
  
  daysContainer.innerHTML = html;
  
  // Événements sur les jours
  daysContainer.querySelectorAll('.cal-day:not(.other-month)').forEach(dayBtn => {
    dayBtn.addEventListener('click', () => {
      const date = dayBtn.dataset.date;
      if (date && currentCalendarField) {
        selectCalendarDate(fiche, date);
      }
    });
  });
}

function selectCalendarDate(fiche, date) {
  const cardId = fiche.dataset.cardId;
  
  if (currentCalendarField) {
    currentCalendarField.element.textContent = date;
    if (cardsData[cardId]) {
      cardsData[cardId][currentCalendarField.field] = date;
      
      // Si c'est dateRobot, mettre à jour aussi dans la section durées
      if (currentCalendarField.field === 'dateRobot') {
        const robotDateEl = fiche.querySelector('.dept-date-link[data-dept-field="dateRobot"]');
        if (robotDateEl) robotDateEl.textContent = date;
      }
      
      saveCardToFirebase(cardId);
    }
  }
  
  fiche.querySelector('.fiche-calendar-popup').classList.remove('active');
  currentCalendarField = null;
}

// Variables pour le popup département avec calendriers
let deptCalEntreeMonth, deptCalEntreeYear, deptCalSortieMonth, deptCalSortieYear;
let deptEntreeDate = '', deptSortieDate = '';

function renderDeptCalendar(container, month, year, selectedDate, type) {
  const MOIS = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay();
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  let html = `
    <div class="mini-cal-nav">
      <button class="mini-cal-btn" data-dir="prev" data-type="${type}">◀</button>
      <span class="mini-cal-title">${MOIS[month]} ${year}</span>
      <button class="mini-cal-btn" data-dir="next" data-type="${type}">▶</button>
    </div>
    <div class="mini-cal-weekdays">
      <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
    </div>
    <div class="mini-cal-days">
  `;
  
  // Jours du mois précédent
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  for (let i = startDay - 1; i >= 0; i--) {
    html += `<span class="mini-day other">${prevMonthLastDay - i}</span>`;
  }
  
  // Jours du mois courant
  for (let day = 1; day <= lastDay.getDate(); day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let classes = 'mini-day';
    if (dateStr === todayStr) classes += ' today';
    if (dateStr === selectedDate) classes += ' selected';
    html += `<span class="${classes}" data-date="${dateStr}" data-type="${type}">${day}</span>`;
  }
  
  html += '</div>';
  container.innerHTML = html;
}

function attachFicheEvents(card) {
  const fiche = card.querySelector('.mcard-fiche');
  const cardId = card.dataset.cardId;
  
  // ===== CALENDRIER VISUEL POUR PASTILLES DATE =====
  fiche.querySelectorAll('.fiche-date-pill').forEach(pill => {
    pill.addEventListener('click', (e) => {
      e.stopPropagation();
      const field = pill.dataset.ficheField;
      if (!field) return;
      
      currentCalendarField = { element: pill, field };
      const popup = fiche.querySelector('.fiche-calendar-popup');
      const titleEl = fiche.querySelector('.cal-title');
      
      const titles = {
        dateRecue: 'Date reçue',
        dateRobot: 'Date fabriquée au robot',
        dateEssayage: 'Date rendez-vous essayage',
        dateExpedition: 'Date d\'expédition'
      };
      
      titleEl.textContent = titles[field] || 'Sélectionner une date';
      
      const currentValue = cardsData[cardId]?.[field];
      if (currentValue && currentValue !== '-' && currentValue !== 'AAAA-MM-JJ') {
        const parts = currentValue.split('-');
        calendarYear = parseInt(parts[0]);
        calendarMonth = parseInt(parts[1]) - 1;
      } else {
        calendarYear = new Date().getFullYear();
        calendarMonth = new Date().getMonth();
      }
      
      renderCalendar(fiche, currentValue || '');
      popup.classList.add('active');
    });
  });
  
  // ===== DATES DANS LA SECTION DURÉES (Robot et Expédition) =====
  fiche.querySelectorAll('.dept-date-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.stopPropagation();
      const field = link.dataset.deptField;
      if (!field) return;
      
      currentCalendarField = { element: link, field };
      const popup = fiche.querySelector('.fiche-calendar-popup');
      const titleEl = fiche.querySelector('.cal-title');
      
      titleEl.textContent = field === 'dateRobot' ? 'Date Robot' : 'Date Expédition';
      
      const currentValue = cardsData[cardId]?.[field];
      if (currentValue && currentValue !== '-') {
        const parts = currentValue.split('-');
        calendarYear = parseInt(parts[0]);
        calendarMonth = parseInt(parts[1]) - 1;
      } else {
        calendarYear = new Date().getFullYear();
        calendarMonth = new Date().getMonth();
      }
      
      renderCalendar(fiche, currentValue || '');
      popup.classList.add('active');
    });
  });
  
  // Navigation calendrier principal
  fiche.querySelector('.cal-prev')?.addEventListener('click', () => {
    calendarMonth--;
    if (calendarMonth < 0) {
      calendarMonth = 11;
      calendarYear--;
    }
    renderCalendar(fiche, cardsData[cardId]?.[currentCalendarField?.field] || '');
  });
  
  fiche.querySelector('.cal-next')?.addEventListener('click', () => {
    calendarMonth++;
    if (calendarMonth > 11) {
      calendarMonth = 0;
      calendarYear++;
    }
    renderCalendar(fiche, cardsData[cardId]?.[currentCalendarField?.field] || '');
  });
  
  fiche.querySelector('.btn-today')?.addEventListener('click', () => {
    const today = new Date().toISOString().split('T')[0];
    selectCalendarDate(fiche, today);
  });
  
  fiche.querySelector('.btn-close-cal')?.addEventListener('click', () => {
    fiche.querySelector('.fiche-calendar-popup').classList.remove('active');
    currentCalendarField = null;
  });
  
  // ===== DÉPARTEMENT (Dégauchage, Essayage, Atelier, Couture, Peinture) =====
  fiche.querySelectorAll('.dept-row').forEach(row => {
    row.addEventListener('click', (e) => {
      const dept = row.dataset.dept;
      // Robot et Expédition sont gérés par dept-date-link
      if (dept === 'Robot' || dept === 'Expédition') return;
      
      e.stopPropagation();
      currentDeptName = dept;
      
      const popup = fiche.querySelector('.dept-dates-popup');
      const title = popup.querySelector('.dept-popup-title');
      title.textContent = dept;
      
      // Charger les dates existantes
      const deptKey = dept.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      deptEntreeDate = cardsData[cardId]?.[`entree_${deptKey}`] || '';
      deptSortieDate = cardsData[cardId]?.[`sortie_${deptKey}`] || '';
      
      // Initialiser les calendriers
      const now = new Date();
      deptCalEntreeMonth = deptEntreeDate ? parseInt(deptEntreeDate.split('-')[1]) - 1 : now.getMonth();
      deptCalEntreeYear = deptEntreeDate ? parseInt(deptEntreeDate.split('-')[0]) : now.getFullYear();
      deptCalSortieMonth = deptSortieDate ? parseInt(deptSortieDate.split('-')[1]) - 1 : now.getMonth();
      deptCalSortieYear = deptSortieDate ? parseInt(deptSortieDate.split('-')[0]) : now.getFullYear();
      
      const entreeContainer = popup.querySelector('.dept-cal-container[data-type="entree"]');
      const sortieContainer = popup.querySelector('.dept-cal-container[data-type="sortie"]');
      
      renderDeptCalendar(entreeContainer, deptCalEntreeMonth, deptCalEntreeYear, deptEntreeDate, 'entree');
      renderDeptCalendar(sortieContainer, deptCalSortieMonth, deptCalSortieYear, deptSortieDate, 'sortie');
      
      // Ajouter events pour les mini calendriers
      attachDeptCalEvents(popup, cardId);
      
      popup.classList.add('active');
    });
  });
  
  function attachDeptCalEvents(popup, cardId) {
    // Navigation des mini calendriers
    popup.querySelectorAll('.mini-cal-btn').forEach(btn => {
      btn.onclick = () => {
        const dir = btn.dataset.dir;
        const type = btn.dataset.type;
        
        if (type === 'entree') {
          if (dir === 'prev') { deptCalEntreeMonth--; if (deptCalEntreeMonth < 0) { deptCalEntreeMonth = 11; deptCalEntreeYear--; } }
          else { deptCalEntreeMonth++; if (deptCalEntreeMonth > 11) { deptCalEntreeMonth = 0; deptCalEntreeYear++; } }
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="entree"]'), deptCalEntreeMonth, deptCalEntreeYear, deptEntreeDate, 'entree');
        } else {
          if (dir === 'prev') { deptCalSortieMonth--; if (deptCalSortieMonth < 0) { deptCalSortieMonth = 11; deptCalSortieYear--; } }
          else { deptCalSortieMonth++; if (deptCalSortieMonth > 11) { deptCalSortieMonth = 0; deptCalSortieYear++; } }
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="sortie"]'), deptCalSortieMonth, deptCalSortieYear, deptSortieDate, 'sortie');
        }
        attachDeptCalEvents(popup, cardId);
      };
    });
    
    // Sélection des jours
    popup.querySelectorAll('.mini-day:not(.other)').forEach(day => {
      day.onclick = () => {
        const date = day.dataset.date;
        const type = day.dataset.type;
        
        if (type === 'entree') {
          deptEntreeDate = date;
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="entree"]'), deptCalEntreeMonth, deptCalEntreeYear, deptEntreeDate, 'entree');
        } else {
          deptSortieDate = date;
          renderDeptCalendar(popup.querySelector('.dept-cal-container[data-type="sortie"]'), deptCalSortieMonth, deptCalSortieYear, deptSortieDate, 'sortie');
        }
        attachDeptCalEvents(popup, cardId);
      };
    });
  }
  
  // Sauvegarder département
  fiche.querySelector('.btn-save')?.addEventListener('click', () => {
    if (currentDeptName && cardsData[cardId]) {
      const deptKey = currentDeptName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      cardsData[cardId][`entree_${deptKey}`] = deptEntreeDate;
      cardsData[cardId][`sortie_${deptKey}`] = deptSortieDate;
      
      // Calculer les jours
      if (deptEntreeDate && deptSortieDate) {
        const days = Math.round((new Date(deptSortieDate) - new Date(deptEntreeDate)) / (1000 * 60 * 60 * 24));
        cardsData[cardId][`days${currentDeptName.replace('é', 'e')}`] = days >= 0 ? days : 0;
        
        // Mettre à jour l'affichage
        const daysEl = fiche.querySelector(`.dept-days[data-dept="${currentDeptName}"]`);
        if (daysEl) daysEl.textContent = days >= 0 ? days : '-';
        
        // Recalculer le total
        recalculateTotal(fiche, cardId);
      }
      
      saveCardToFirebase(cardId);
    }
    
    fiche.querySelector('.dept-dates-popup').classList.remove('active');
    currentDeptName = null;
  });
  
  fiche.querySelector('.btn-cancel')?.addEventListener('click', () => {
    fiche.querySelector('.dept-dates-popup').classList.remove('active');
    currentDeptName = null;
  });
  
  function recalculateTotal(fiche, cardId) {
    const data = cardsData[cardId];
    let total = 0;
    ['Degauchage', 'Atelier', 'Couture', 'Peinture'].forEach(dept => {
      const days = data[`days${dept}`];
      if (days && !isNaN(days)) total += parseInt(days);
    });
    data.totalDays = total;
    const totalEl = fiche.querySelector('.dept-total-days');
    if (totalEl) totalEl.textContent = total || '-';
  }
  
  // ===== INPUTS ET SELECTS =====
  fiche.querySelectorAll('.fiche-input, .fiche-select').forEach(el => {
    el.addEventListener('change', () => {
      const field = el.dataset.ficheField;
      const value = el.value;
      
      if (cardsData[cardId]) {
        cardsData[cardId][field] = value;
        saveCardToFirebase(cardId);
        
        // Sync avec la carte
        if (field === 'name') {
          const titleInput = card.querySelector('.mcard-title');
          if (titleInput) titleInput.value = value || 'Nom du moulage';
        } else if (field === 'order') {
          const orderInput = card.querySelector('.mcard-order');
          if (orderInput) orderInput.value = value || '000000';
        } else if (field === 'item') {
          const itemPill = card.querySelector('.mcard-item-pill');
          if (itemPill) itemPill.textContent = value || 'Siège';
        }
      }
    });
  });
  
  // ===== NOTES AVEC SIGNATURE DANS LE TEXTAREA =====
  const notesDiv = fiche.querySelector('.fiche-notes');
  const notesText = fiche.querySelector('.fiche-notes-text');
  const notesCloseBtn = fiche.querySelector('.fiche-notes-close-bottom');
  
  let signatureAdded = false;
  
  function addSignatureToNotes() {
    if (signatureAdded) return;
    
    // Utiliser le nom de l'utilisateur connecté
    let userName = 'Anonyme';
    if (currentUser?.email) {
      for (const [code, data] of Object.entries(USER_CODES)) {
        if (data.email === currentUser.email) {
          userName = data.name;
          break;
        }
      }
    }
    
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    const signature = `\n\n— ${userName} (${dateStr} à ${timeStr}) —\n`;
    
    // Ajouter la signature à la fin du texte existant
    const currentText = notesText.value;
    notesText.value = currentText + signature;
    
    // Placer le curseur après la signature
    notesText.selectionStart = notesText.value.length;
    notesText.selectionEnd = notesText.value.length;
    
    signatureAdded = true;
  }
  
  function openNotes() {
    if (!notesDiv.classList.contains('expanded')) {
      notesDiv.classList.add('expanded');
      signatureAdded = false;
      notesText.focus();
    }
  }
  
  function closeNotes() {
    notesDiv.classList.remove('expanded');
    signatureAdded = false;
  }
  
  notesText.addEventListener('click', (e) => {
    e.stopPropagation();
    openNotes();
  });
  
  notesText.addEventListener('focus', () => {
    openNotes();
  });
  
  // Ajouter signature au premier caractère tapé
  notesText.addEventListener('keydown', (e) => {
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
      addSignatureToNotes();
    }
  });
  
  notesCloseBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (cardsData[cardId]) {
      cardsData[cardId].notes = notesText.value;
      saveCardToFirebase(cardId);
    }
    closeNotes();
  });
  
  notesText.addEventListener('blur', () => {
    if (cardsData[cardId] && notesText.value !== cardsData[cardId].notes) {
      cardsData[cardId].notes = notesText.value;
      saveCardToFirebase(cardId);
    }
  });
}

// ===== ZONE NOTES EXPANDABLE =====
function expandNotesZone(cardId, element) {
  const card = cardsData[cardId];
  if (!card) return;
  
  const notesZone = element.closest('.fiche-notes-zone');
  if (!notesZone) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  // Remplacer par la zone expandée
  notesZone.innerHTML = `
    <div class="fiche-notes-expanded">
      <div class="notes-header">
        <span>Notes</span>
        <button onclick="collapseNotesZone('${cardId}', this)">Fermer</button>
      </div>
      <div class="notes-body">
        <div class="notes-signature">— ${userName} (${dateStr} à ${timeStr}) —</div>
        <textarea id="notesTextarea_${cardId}" placeholder="Écrire votre note ici..."></textarea>
        ${card.notes ? `<div class="notes-history">${card.notes}</div>` : ''}
      </div>
    </div>
  `;
  
  // Focus sur le textarea
  setTimeout(() => {
    document.getElementById('notesTextarea_' + cardId)?.focus();
  }, 100);
}

function collapseNotesZone(cardId, element) {
  const card = cardsData[cardId];
  if (!card) return;
  
  const notesZone = element.closest('.fiche-notes-zone');
  if (!notesZone) return;
  
  // Récupérer le texte du textarea
  const textarea = document.getElementById('notesTextarea_' + cardId);
  const newText = textarea?.value?.trim();
  
  // Si du texte a été écrit, l'ajouter aux notes existantes
  if (newText) {
    const userName = getCurrentUserName();
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    
    const newNote = `<div class="note-entry"><div class="note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div><div class="note-text">${newText}</div></div>`;
    
    const existingNotes = card.notes || '';
    card.notes = newNote + existingNotes;
    
    saveCardToFirebase(cardId);
  }
  
  // Remettre la zone simple
  const hasNotes = card.notes && card.notes.length > 0;
  notesZone.innerHTML = `
    <div class="fiche-notes-simple" onclick="expandNotesZone('${cardId}', this)">
      <span class="notes-text-center ${hasNotes ? 'has-notes' : ''}">Notes</span>
    </div>
  `;
}

// ===== FONCTIONS PHOTOS =====
let currentPhotoCardId = null;
let currentPhotoType = null;

function openPhotoPopup(cardId, photoType, event) {
  if (event) event.stopPropagation();
  
  currentPhotoCardId = cardId;
  currentPhotoType = photoType;
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  const popup = card.querySelector('#photoPopup');
  if (!popup) return;
  
  const typeNames = { client: 'Client', atelier: 'Atelier', devis: 'Devis + Modif' };
  popup.querySelector('#photoPopupType').textContent = typeNames[photoType] || photoType;
  
  const fieldName = 'photo' + photoType.charAt(0).toUpperCase() + photoType.slice(1);
  const currentUrl = cardsData[cardId]?.[fieldName] || '';
  popup.querySelector('#photoPopupUrl').value = currentUrl;
  
  // Fermer le menu photos
  closePhotosMenu();
  
  popup.style.display = 'block';
  popup.querySelector('#photoPopupUrl').focus();
}

function closePhotoPopup() {
  const popup = document.querySelector('#photoPopup');
  if (popup) popup.style.display = 'none';
  currentPhotoCardId = null;
  currentPhotoType = null;
}

function savePhotoLink() {
  if (!currentPhotoCardId || !currentPhotoType) return;
  
  const popup = document.querySelector('#photoPopup');
  const url = popup?.querySelector('#photoPopupUrl')?.value || '';
  
  const fieldName = 'photo' + currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1);
  
  if (cardsData[currentPhotoCardId]) {
    cardsData[currentPhotoCardId][fieldName] = url;
    saveCardToFirebase(currentPhotoCardId);
  }
  
  closePhotoPopup();
}

function openPhotoLink() {
  if (!currentPhotoCardId || !currentPhotoType) return;
  
  const fieldName = 'photo' + currentPhotoType.charAt(0).toUpperCase() + currentPhotoType.slice(1);
  const url = cardsData[currentPhotoCardId]?.[fieldName];
  
  if (url) {
    window.open(url, '_blank');
  } else {
    alert('Aucun lien photo enregistré');
  }
}

// ===== MENU PHOTOS =====
function openPhotosMenu(cardId, event) {
  if (event) event.stopPropagation();
  
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  // Mettre à jour les valeurs des inputs
  const data = cardsData[cardId] || {};
  const popup = card.querySelector('#photosMenuPopup');
  if (popup) {
    const inputClient = popup.querySelector('#photoLinkClient');
    const inputAtelier = popup.querySelector('#photoLinkAtelier');
    const inputDevis = popup.querySelector('#photoLinkDevis');
    if (inputClient) inputClient.value = data.photoClient || '';
    if (inputAtelier) inputAtelier.value = data.photoAtelier || '';
    if (inputDevis) inputDevis.value = data.photoDevis || '';
    popup.style.display = 'block';
  }
}

function closePhotosMenu() {
  const popups = document.querySelectorAll('.photos-menu-popup');
  popups.forEach(p => p.style.display = 'none');
}

function saveAllPhotoLinks(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card || !cardsData[cardId]) return;
  
  const popup = card.querySelector('#photosMenuPopup');
  if (!popup) return;
  
  const photoClient = popup.querySelector('#photoLinkClient')?.value || '';
  const photoAtelier = popup.querySelector('#photoLinkAtelier')?.value || '';
  const photoDevis = popup.querySelector('#photoLinkDevis')?.value || '';
  
  cardsData[cardId].photoClient = photoClient;
  cardsData[cardId].photoAtelier = photoAtelier;
  cardsData[cardId].photoDevis = photoDevis;
  
  saveCardToFirebase(cardId);
  
  // Mettre à jour les pastilles
  const pillClient = card.querySelector('.photo-pill[onclick*="client"]');
  const pillAtelier = card.querySelector('.photo-pill[onclick*="atelier"]');
  const pillDevis = card.querySelector('.photo-pill[onclick*="devis"]');
  
  if (pillClient) pillClient.classList.toggle('has-link', !!photoClient);
  if (pillAtelier) pillAtelier.classList.toggle('has-link', !!photoAtelier);
  if (pillDevis) pillDevis.classList.toggle('has-link', !!photoDevis);
  
  closePhotosMenu();
}

// Ouvrir la photo dans un nouvel onglet quand on clique sur une pastille
function openPhotoFromPill(cardId, photoType, event) {
  if (event) event.stopPropagation();
  
  const fieldName = 'photo' + photoType.charAt(0).toUpperCase() + photoType.slice(1);
  const url = cardsData[cardId]?.[fieldName];
  
  if (url) {
    window.open(url, '_blank');
  } else {
    // Ouvrir le menu photos pour entrer le lien
    openPhotosMenu(cardId, event);
  }
}

// ===== OVERLAY NOTES MOULAGE =====
function toggleMoulageNotesOverlay(cardId) {
  const mcardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!mcardEl) return;
  
  const fiche = mcardEl.querySelector('.mcard-fiche');
  if (!fiche) return;
  
  const overlay = fiche.querySelector('.moulage-notes-overlay');
  
  if (overlay && overlay.style.display === 'flex') {
    // Fermer l'overlay
    closeMoulageNotesOverlay(cardId);
  } else {
    // Ouvrir l'overlay
    openMoulageNotesOverlay(cardId);
  }
}

function openMoulageNotesOverlay(cardId) {
  const card = cardsData[cardId];
  if (!card) return;
  
  // Trouver la fiche moulage
  const mcardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!mcardEl) return;
  
  const fiche = mcardEl.querySelector('.mcard-fiche');
  if (!fiche) return;
  
  // Vérifier si l'overlay existe déjà
  let overlay = fiche.querySelector('.moulage-notes-overlay');
  if (!overlay) {
    // Créer l'overlay
    overlay = document.createElement('div');
    overlay.className = 'moulage-notes-overlay';
    fiche.appendChild(overlay);
  }
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  overlay.innerHTML = `
    <div class="moulage-notes-content">
      <div class="moulage-notes-signature">— ${userName} (${dateStr} à ${timeStr}) —</div>
      <textarea class="moulage-notes-textarea" id="notesTextarea_${cardId}" placeholder="Écrire votre note ici...">${card.notes || ''}</textarea>
    </div>
  `;
  
  overlay.style.display = 'flex';
  
  // Focus sur le textarea et placer curseur à la fin
  setTimeout(() => {
    const textarea = document.getElementById('notesTextarea_' + cardId);
    if (textarea) {
      textarea.focus();
      textarea.selectionStart = textarea.value.length;
      textarea.selectionEnd = textarea.value.length;
    }
  }, 100);
}

function closeMoulageNotesOverlay(cardId) {
  // Trouver la fiche moulage
  const mcardEl = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!mcardEl) return;
  
  const fiche = mcardEl.querySelector('.mcard-fiche');
  if (!fiche) return;
  
  const overlay = fiche.querySelector('.moulage-notes-overlay');
  if (!overlay) return;
  
  // Récupérer le texte du textarea et sauvegarder
  const textarea = document.getElementById('notesTextarea_' + cardId);
  if (textarea && cardsData[cardId]) {
    cardsData[cardId].notes = textarea.value;
    saveCardToFirebase(cardId);
    
    // Mettre à jour le bouton notes
    const notesBtn = fiche.querySelector('.fiche-notes-btn');
    if (notesBtn) {
      if (textarea.value && textarea.value.length > 0) {
        notesBtn.classList.add('has-notes');
      } else {
        notesBtn.classList.remove('has-notes');
      }
    }
  }
  
  overlay.style.display = 'none';
}

function saveMoulageNote(cardId) {
  const newNoteText = document.getElementById('newNoteText')?.value?.trim();
  if (!newNoteText || !cardsData[cardId]) {
    closeMoulageNotesOverlay();
    return;
  }
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  const newNote = `<div class="note-entry"><div class="note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div><div class="note-text">${newNoteText}</div></div>`;
  
  // Ajouter la nouvelle note aux notes existantes
  const existingNotes = cardsData[cardId].notes || '';
  cardsData[cardId].notes = existingNotes + newNote;
  
  // Marquer comme non lu pour les autres
  markNoteAsUnread(cardId);
  
  saveCardToFirebase(cardId);
  closeMoulageNotesOverlay();
}

// ===== NOTES SIGNÉES =====
let currentUserName = 'Anonyme';

function getCurrentUserName() {
  // D'abord vérifier si on a un utilisateur Firebase connecté
  if (currentUser?.email) {
    for (const [code, data] of Object.entries(USER_CODES)) {
      if (data.email === currentUser.email) {
        return data.name;
      }
    }
  }
  // Sinon utiliser le nom de session
  if (window._sessionUserName) {
    return window._sessionUserName;
  }
  return 'Anonyme';
}

function addSignedNote(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  const notesList = card.querySelector('#ficheNotesList');
  if (!notesList) return;
  
  currentUserName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  // Créer l'entrée de note
  const noteEntry = document.createElement('div');
  noteEntry.className = 'note-entry';
  noteEntry.innerHTML = `
    <div class="note-signature">— ${currentUserName} (${dateStr} à ${timeStr}) —</div>
    <div class="note-text" contenteditable="true" placeholder="Écrire la note ici..."></div>
  `;
  
  notesList.appendChild(noteEntry);
  
  const textDiv = noteEntry.querySelector('.note-text');
  textDiv.focus();
  
  // Sauvegarder quand on quitte le champ
  textDiv.addEventListener('blur', () => {
    saveNotesFromList(cardId);
    markNoteAsUnread(cardId);
  });
}

function saveNotesFromList(cardId) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  const notesList = card.querySelector('#ficheNotesList');
  if (!notesList || !cardsData[cardId]) return;
  
  cardsData[cardId].notes = notesList.innerHTML;
  saveCardToFirebase(cardId);
}

function markNoteAsUnread(cardId) {
  if (!cardsData[cardId]) return;
  
  // Marquer comme non lu pour tous sauf l'auteur
  const allUsers = Object.values(USER_CODES).map(u => u.name);
  const currentUser = getCurrentUserName();
  
  if (!cardsData[cardId].notesUnread) {
    cardsData[cardId].notesUnread = {};
  }
  
  allUsers.forEach(user => {
    if (user !== currentUser) {
      cardsData[cardId].notesUnread[user] = true;
    }
  });
  
  saveCardToFirebase(cardId);
}

function markNoteAsRead(cardId) {
  if (!cardsData[cardId]) return;
  
  const currentUser = getCurrentUserName();
  
  if (cardsData[cardId].notesUnread) {
    cardsData[cardId].notesUnread[currentUser] = false;
    saveCardToFirebase(cardId);
  }
  
  // Enlever la classe clignotante
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  const notesTitle = card?.querySelector('.notes-title');
  if (notesTitle) {
    notesTitle.classList.remove('notes-unread');
  }
}

// ===== VUE HORIZONTALE ROBOT =====
let isRobotViewActive = false;

function toggleRobotView() {
  isRobotViewActive = !isRobotViewActive;
  
  const boardsContainer = document.getElementById('boardsContainer');
  const robotView = document.getElementById('robotHorizontalView');
  
  if (!boardsContainer || !robotView) {
    console.error("❌ Éléments non trouvés");
    return;
  }
  
  if (isRobotViewActive) {
    // Afficher la vue Robot
    boardsContainer.style.display = 'none';
    robotView.style.display = 'flex';
    renderRobotTable();
  } else {
    // Retour au Kanban - Les cartes sont déjà là, juste les réafficher
    boardsContainer.style.display = 'block';
    robotView.style.display = 'none';
    updateColumnCounts();
  }
}

// Ajouter un nouveau moulage depuis la vue horizontale
function addNewMoulageFromHorizontal() {
  // Ouvrir le même modal que le bouton Ajouter moulage
  const addModal = document.getElementById('addModal');
  if (addModal) {
    addModal.classList.add('active');
    document.getElementById('addName').focus();
  }
}

// Rendre le tableau Robot
function renderRobotTable() {
  const tbody = document.getElementById('robotTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  // Chercher les cartes de la colonne Robot
  let robotCards = Object.entries(cardsData).filter(([id, card]) => {
    const colIndex = card.columnIndex ?? card.column ?? -1;
    return colIndex === 0 || colIndex === '0' || colIndex === 'Robot';
  });
  
  // Si cardsData vide, chercher dans le DOM
  if (robotCards.length === 0) {
    const robotColumn = document.querySelector('.col[data-col="0"]');
    if (robotColumn) {
      const domCards = robotColumn.querySelectorAll('.mcard');
      domCards.forEach(card => {
        const cardId = card.dataset.cardId;
        if (cardId && cardsData[cardId]) {
          robotCards.push([cardId, cardsData[cardId]]);
        }
      });
    }
  }
  
  console.log(`📊 ${robotCards.length} cartes Robot trouvées`);
  
  if (robotCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:20px;">Aucune carte dans Robot</td></tr>';
    return;
  }
  
  // Options pour les menus déroulants (mêmes que la fiche)
  const clientsList = window.CLIENTS_LIST || MENU_DATA.clients || [];
  const intervenantsList = window.INTERVENANTS_LIST || MENU_DATA.intervenants || [];
  const representantesList = ['Marie-Soleil', 'Marie-Piers'];
  const itemsList = ['Siège', 'Dossier', 'Siège + Dossier'];
  const regionsList = ['Québec', 'Ontario', 'Maritime'];
  const rushList = ['Oui', 'Non'];
  
  robotCards.forEach(([cardId, card]) => {
    const tr = document.createElement('tr');
    tr.setAttribute('data-card-id', cardId);
    
    // 14 COLONNES - MAPPING AVEC LA FICHE
    tr.innerHTML = `
      <td class="editable" data-field="name" contenteditable="true">${card.name || ''}</td>
      <td class="table-select-cell" data-field="client">
        <select class="table-select" data-field="client">
          <option value="">--</option>
          ${clientsList.map(c => `<option value="${c}" ${card.client === c ? 'selected' : ''}>${c}</option>`).join('')}
        </select>
      </td>
      <td class="editable" data-field="order" contenteditable="true">${card.order || ''}</td>
      <td class="table-select-cell" data-field="intervenant">
        <select class="table-select" data-field="intervenant">
          <option value="">--</option>
          ${intervenantsList.map(i => `<option value="${i}" ${card.intervenant === i ? 'selected' : ''}>${i}</option>`).join('')}
        </select>
      </td>
      <td class="table-select-cell" data-field="region">
        <select class="table-select" data-field="region">
          <option value="">--</option>
          ${regionsList.map(r => `<option value="${r}" ${card.region === r ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
      </td>
      <td class="table-select-cell" data-field="item">
        <select class="table-select" data-field="item">
          <option value="">--</option>
          ${itemsList.map(i => `<option value="${i}" ${card.item === i ? 'selected' : ''}>${i}</option>`).join('')}
        </select>
      </td>
      <td class="date-cell" data-field="dateRecue" data-card-id="${cardId}" onclick="showTableCalendar('${cardId}', 'dateRecue', this)">${card.dateRecue || 'AAAA-MM-JJ'}</td>
      <td class="date-cell" data-field="dateLivraison" data-card-id="${cardId}" onclick="showTableCalendar('${cardId}', 'dateLivraison', this)">${card.dateLivraison || 'AAAA-MM-JJ'}</td>
      <td class="date-cell" data-field="dateEssayage" data-card-id="${cardId}" onclick="showTableCalendar('${cardId}', 'dateEssayage', this)">${card.dateEssayage || 'AAAA-MM-JJ'}</td>
      <td class="table-select-cell" data-field="representant">
        <select class="table-select" data-field="representant">
          <option value="">--</option>
          ${representantesList.map(r => `<option value="${r}" ${card.representant === r ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
      </td>
      <td class="table-select-cell" data-field="file">
        <select class="table-select" data-field="file">
          <option value="">--</option>
          <option value="Oui" ${card.file === 'Oui' ? 'selected' : ''}>Oui</option>
          <option value="Non" ${card.file === 'Non' ? 'selected' : ''}>Non</option>
        </select>
      </td>
      <td class="editable" data-field="angle" contenteditable="true">${card.angle || ''}</td>
      <td class="table-select-cell" data-field="rush">
        <select class="table-select" data-field="rush">
          <option value="">--</option>
          ${rushList.map(r => `<option value="${r}" ${card.rush === r ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
      </td>
      <td class="notes-cell" data-field="notes" data-card-id="${cardId}">
        <button class="notes-btn ${card.notes ? 'has-notes' : ''}" onclick="showNotesPopup('${cardId}', event)">Notes</button>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  // Ajouter les event listeners
  setupTableListeners();
  setupColumnResize();
}

// Setup des listeners pour la table (édition et menus)
function setupTableListeners() {
  // Cellules éditables (texte)
  const editableCells = document.querySelectorAll('#robotTableBody td.editable');
  editableCells.forEach(cell => {
    cell.addEventListener('blur', function() {
      const tr = this.closest('tr');
      const cardId = tr.getAttribute('data-card-id');
      const field = this.getAttribute('data-field');
      const newValue = this.textContent.trim();
      
      if (cardId && field && cardsData[cardId]) {
        cardsData[cardId][field] = newValue;
        saveCardToFirebase(cardId);
        
        // Feedback visuel
        this.style.background = '#d1fae5';
        setTimeout(() => { this.style.background = ''; }, 500);
        
        // Mettre à jour la carte Kanban
        updateCardFromTable(cardId, field, newValue);
        
      }
    });
    
    cell.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.blur();
      }
    });
  });
  
  // Menus déroulants
  const selects = document.querySelectorAll('#robotTableBody select.table-select');
  selects.forEach(select => {
    select.addEventListener('change', function() {
      const tr = this.closest('tr');
      const cardId = tr.getAttribute('data-card-id');
      const field = this.getAttribute('data-field');
      const newValue = this.value;
      
      if (cardId && field && cardsData[cardId]) {
        cardsData[cardId][field] = newValue;
        saveCardToFirebase(cardId);
        
        // Feedback visuel
        this.style.background = '#d1fae5';
        setTimeout(() => { this.style.background = ''; }, 500);
        
        // Mettre à jour la carte Kanban
        updateCardFromTable(cardId, field, newValue);
        
        // Si région change, mettre à jour la couleur de la carte
        if (field === 'region') {
          updateCardRegionColor(cardId, newValue);
        }
        
      }
    });
  });
}

// Afficher popup de notes
function showNotesPopup(cardId, event) {
  const card = cardsData[cardId];
  if (!card) return;
  
  // Fermer l'ancien popup s'il existe
  closeNotesPopup();
  
  const popup = document.createElement('div');
  popup.className = 'notes-popup-overlay';
  popup.onclick = function(e) { if (e.target === this) closeNotesPopup(); };
  
  popup.innerHTML = `
    <div class="notes-popup" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);max-width:90vw;width:400px;">
      <div class="notes-popup-header">
        <h4>📝 Notes - ${card.name || 'Sans nom'}</h4>
        <button class="notes-popup-close" onclick="closeNotesPopup()">Fermer</button>
      </div>
      <textarea class="notes-popup-text" id="notesPopupText" 
        onfocus="prepareTableNoteWithSignature('${cardId}')"
        style="width:100%;height:150px;box-sizing:border-box;line-height:1.3;">${card.notes || ''}</textarea>
      <div class="notes-popup-buttons">
        <button class="notes-popup-save" onclick="saveNotesPopup('${cardId}')">💾 Sauvegarder</button>
        <button class="notes-popup-cancel" onclick="closeNotesPopup()">Annuler</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Focus sur le textarea
  setTimeout(() => {
    document.getElementById('notesPopupText')?.focus();
  }, 100);
}

// Préparer la signature dans le popup notes vue horizontale
function prepareTableNoteWithSignature(cardId) {
  const textarea = document.getElementById('notesPopupText');
  if (!textarea) return;
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  const signature = `— ${userName} (${dateStr} à ${timeStr}) —`;
  
  const currentText = textarea.value;
  
  // Vérifier si le texte finit déjà par une signature avec EXACTEMENT la même heure
  const lines = currentText.split('\n');
  const lastSignatureLine = lines.filter(l => l.startsWith('— ')).pop();
  
  let hasExactSameSignature = false;
  if (lastSignatureLine) {
    const match = lastSignatureLine.match(/— .+ \((\d{4}-\d{2}-\d{2}) à (\d{2}:\d{2})\) —/);
    if (match) {
      const lastDate = match[1];
      const lastTime = match[2];
      hasExactSameSignature = (lastDate === dateStr && lastTime === timeStr);
    }
  }
  
  if (!hasExactSameSignature) {
    if (currentText.trim()) {
      textarea.value = currentText.trimEnd() + '\n\n' + signature + '\n';
    } else {
      textarea.value = signature + '\n';
    }
  }
  
  setTimeout(() => {
    textarea.selectionStart = textarea.value.length;
    textarea.selectionEnd = textarea.value.length;
    textarea.scrollTop = textarea.scrollHeight;
  }, 10);
}

// Fermer popup notes
function closeNotesPopup() {
  const popup = document.querySelector('.notes-popup-overlay');
  if (popup) popup.remove();
}

// Sauvegarder notes depuis popup
function saveNotesPopup(cardId) {
  const textarea = document.getElementById('notesPopupText');
  if (!textarea || !cardsData[cardId]) return;
  
  const newNotes = textarea.value;
  cardsData[cardId].notes = newNotes;
  saveCardToFirebase(cardId);
  
  // Mettre à jour le bouton dans la table
  const notesBtn = document.querySelector(`td.notes-cell[data-card-id="${cardId}"] .notes-btn`);
  if (notesBtn) {
    notesBtn.classList.toggle('has-notes', !!newNotes);
  }
  
  // Mettre à jour aussi dans la fiche moulage si elle est ouverte
  const ficheCard = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (ficheCard) {
    const ficheNotesArea = ficheCard.querySelector('.fiche-notes-textarea');
    if (ficheNotesArea) {
      ficheNotesArea.value = newNotes;
    }
  }
  
  closeNotesPopup();
}

// ===== CALENDRIER POUR LA TABLE =====
let tableCalCurrentCardId = null;
let tableCalCurrentField = null;
let tableCalCurrentCell = null;
let tableCalMonth = new Date().getMonth();
let tableCalYear = new Date().getFullYear();

const MOIS_NOMS = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                   'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

function showTableCalendar(cardId, field, cell) {
  tableCalCurrentCardId = cardId;
  tableCalCurrentField = field;
  tableCalCurrentCell = cell;
  
  // Initialiser avec la date actuelle par défaut
  tableCalMonth = new Date().getMonth();
  tableCalYear = new Date().getFullYear();
  
  // Parser la date actuelle si elle existe et est valide
  const currentValue = cell.textContent;
  if (currentValue && currentValue !== 'AAAA-MM-JJ' && currentValue !== '📅') {
    const parts = currentValue.split('-');
    if (parts.length === 3) {
      const year = parseInt(parts[0]);
      const month = parseInt(parts[1]) - 1;
      // Vérifier que les valeurs sont valides
      if (!isNaN(year) && !isNaN(month) && year > 2000 && month >= 0 && month <= 11) {
        tableCalYear = year;
        tableCalMonth = month;
      }
    }
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'table-calendar-overlay';
  overlay.id = 'tableCalendarOverlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeTableCalendar(); };
  
  const fieldNames = {
    'dateRecue': 'Date Reçue',
    'dateLivraison': 'Date Livraison',
    'dateEssayage': 'Date Essayage'
  };
  
  overlay.innerHTML = `
    <div class="table-calendar-popup">
      <div class="table-calendar-header">${fieldNames[field] || field}</div>
      <div class="table-cal-nav">
        <button onclick="tableCalPrev()">◀</button>
        <span class="table-cal-month" id="tableCalMonthYear">${MOIS_NOMS[tableCalMonth]} ${tableCalYear}</span>
        <button onclick="tableCalNext()">▶</button>
      </div>
      <div class="table-cal-weekdays">
        <div class="table-cal-weekday">Dim</div>
        <div class="table-cal-weekday">Lun</div>
        <div class="table-cal-weekday">Mar</div>
        <div class="table-cal-weekday">Mer</div>
        <div class="table-cal-weekday">Jeu</div>
        <div class="table-cal-weekday">Ven</div>
        <div class="table-cal-weekday">Sam</div>
      </div>
      <div class="table-cal-days" id="tableCalDays"></div>
      <div class="table-cal-buttons">
        <button class="table-cal-today" onclick="tableCalSelectToday()">Aujourd'hui</button>
        <button class="table-cal-clear" onclick="tableCalClear()">Effacer</button>
        <button class="table-cal-close" onclick="closeTableCalendar()">Fermer</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  renderTableCalDays();
}

function renderTableCalDays() {
  const container = document.getElementById('tableCalDays');
  if (!container) return;
  
  container.innerHTML = '';
  
  const firstDay = new Date(tableCalYear, tableCalMonth, 1).getDay();
  const daysInMonth = new Date(tableCalYear, tableCalMonth + 1, 0).getDate();
  const today = new Date();
  
  // Mettre à jour le titre
  const monthYearEl = document.getElementById('tableCalMonthYear');
  if (monthYearEl) {
    monthYearEl.textContent = `${MOIS_NOMS[tableCalMonth]} ${tableCalYear}`;
  }
  
  // Cases vides avant le 1er jour
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'table-cal-day empty';
    container.appendChild(empty);
  }
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'table-cal-day';
    dayEl.textContent = day;
    
    // Marquer aujourd'hui
    if (day === today.getDate() && tableCalMonth === today.getMonth() && tableCalYear === today.getFullYear()) {
      dayEl.classList.add('today');
    }
    
    dayEl.onclick = () => tableCalSelectDay(day);
    container.appendChild(dayEl);
  }
}

function tableCalPrev() {
  tableCalMonth--;
  if (tableCalMonth < 0) {
    tableCalMonth = 11;
    tableCalYear--;
  }
  renderTableCalDays();
}

function tableCalNext() {
  tableCalMonth++;
  if (tableCalMonth > 11) {
    tableCalMonth = 0;
    tableCalYear++;
  }
  renderTableCalDays();
}

function tableCalSelectDay(day) {
  const dateStr = `${tableCalYear}-${String(tableCalMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  applyTableCalDate(dateStr);
}

function tableCalSelectToday() {
  const today = new Date();
  const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
  applyTableCalDate(dateStr);
}

function tableCalClear() {
  applyTableCalDate('');
}

function applyTableCalDate(dateStr) {
  if (!tableCalCurrentCardId || !tableCalCurrentField) return;
  
  // Mettre à jour cardsData
  cardsData[tableCalCurrentCardId][tableCalCurrentField] = dateStr;
  saveCardToFirebase(tableCalCurrentCardId);
  
  // Mettre à jour la cellule de la table
  if (tableCalCurrentCell) {
    tableCalCurrentCell.textContent = dateStr || '📅';
  }
  
  // Synchroniser avec la fiche si dateEssayage (= dateRendezVousEssayage)
  if (tableCalCurrentField === 'dateEssayage') {
    // La fiche utilise dateEssayage aussi, donc c'est synchronisé
    console.log(`✅ Date essayage synchronisée: ${dateStr}`);
  }
  
  // Synchroniser dateRecue avec la fiche
  if (tableCalCurrentField === 'dateRecue') {
    console.log(`✅ Date reçue synchronisée: ${dateStr}`);
  }
  
  closeTableCalendar();
  console.log(`✅ ${tableCalCurrentField} mis à jour: ${dateStr}`);
}

function closeTableCalendar() {
  const overlay = document.getElementById('tableCalendarOverlay');
  if (overlay) overlay.remove();
  tableCalCurrentCardId = null;
  tableCalCurrentField = null;
  tableCalCurrentCell = null;
}

// ===== CALCUL DU DÉLAI EN JOURS OUVRABLES =====
// Jours fériés du Québec (2024-2025)
const JOURS_FERIES = [
  // 2024
  '2024-01-01', // Jour de l'An
  '2024-03-29', // Vendredi Saint
  '2024-05-20', // Journée nationale des patriotes
  '2024-06-24', // Fête nationale du Québec
  '2024-07-01', // Fête du Canada
  '2024-09-02', // Fête du Travail
  '2024-10-14', // Action de grâce
  '2024-12-25', // Noël
  '2024-12-26', // Lendemain de Noël
  // 2025
  '2025-01-01', // Jour de l'An
  '2025-04-18', // Vendredi Saint
  '2025-05-19', // Journée nationale des patriotes
  '2025-06-24', // Fête nationale du Québec
  '2025-07-01', // Fête du Canada
  '2025-09-01', // Fête du Travail
  '2025-10-13', // Action de grâce
  '2025-12-25', // Noël
  '2025-12-26', // Lendemain de Noël
  // 2026
  '2026-01-01', // Jour de l'An
  '2026-04-03', // Vendredi Saint
  '2026-05-18', // Journée nationale des patriotes
  '2026-06-24', // Fête nationale du Québec
  '2026-07-01', // Fête du Canada
  '2026-09-07', // Fête du Travail
  '2026-10-12', // Action de grâce
  '2026-12-25', // Noël
  '2026-12-26', // Lendemain de Noël
];

function isJourFerie(date) {
  const dateStr = date.toISOString().split('T')[0];
  return JOURS_FERIES.includes(dateStr);
}

function isJourOuvrable(date) {
  const jour = date.getDay();
  // 0 = dimanche, 6 = samedi
  if (jour === 0 || jour === 6) return false;
  if (isJourFerie(date)) return false;
  return true;
}

function calculerJoursOuvrables(dateDebut, dateFin) {
  if (!dateDebut || !dateFin) return null;
  
  const debut = new Date(dateDebut);
  const fin = new Date(dateFin);
  
  // Si la date de fin est passée, retourner un nombre négatif
  const aujourdHui = new Date();
  aujourdHui.setHours(0, 0, 0, 0);
  fin.setHours(0, 0, 0, 0);
  
  let jours = 0;
  const current = new Date(aujourdHui);
  
  if (fin < aujourdHui) {
    // Date passée - compter les jours négatifs
    while (current > fin) {
      current.setDate(current.getDate() - 1);
      if (isJourOuvrable(current)) {
        jours--;
      }
    }
  } else {
    // Date future - compter les jours positifs
    while (current < fin) {
      current.setDate(current.getDate() + 1);
      if (isJourOuvrable(current)) {
        jours++;
      }
    }
  }
  
  return jours;
}

function renderDelaiSection(cmd) {
  if (!cmd.dateLivraison || cmd.dateLivraison === 'AAAA-MM-JJ') {
    return `
      <div class="cmd-delai-header">
        <span class="cmd-delai-title">⏱ Délai de livraison</span>
      </div>
      <div style="text-align:center;color:#94a3b8;font-size:8px;padding:10px;">
        Entrez une date de livraison pour voir le délai
      </div>
    `;
  }
  
  const joursRestants = calculerJoursOuvrables(new Date(), cmd.dateLivraison);
  
  let badgeClass, badgeText, progressClass;
  let progressPercent = 100;
  
  if (joursRestants === null) {
    return '';
  } else if (joursRestants < 0) {
    badgeClass = 'passed';
    badgeText = 'DÉPASSÉ';
    progressClass = 'passed';
    progressPercent = 100;
  } else if (joursRestants <= 3) {
    badgeClass = 'urgent';
    badgeText = 'URGENT';
    progressClass = 'urgent';
    progressPercent = Math.min(100, (30 - joursRestants) / 30 * 100);
  } else if (joursRestants <= 7) {
    badgeClass = 'warning';
    badgeText = 'ATTENTION';
    progressClass = 'warning';
    progressPercent = Math.min(100, (30 - joursRestants) / 30 * 100);
  } else {
    badgeClass = 'ok';
    badgeText = 'EN COURS';
    progressClass = 'ok';
    progressPercent = Math.min(100, (30 - joursRestants) / 30 * 100);
  }
  
  const joursAbs = Math.abs(joursRestants);
  const joursLabel = joursRestants < 0 
    ? `${joursAbs} jour${joursAbs > 1 ? 's' : ''} de retard`
    : `${joursRestants} jour${joursRestants > 1 ? 's' : ''} restant${joursRestants > 1 ? 's' : ''}`;
  
  return `
    <div class="cmd-delai-header">
      <span class="cmd-delai-title">⏱ Délai de livraison</span>
      <span class="cmd-delai-badge ${badgeClass}">${badgeText}</span>
    </div>
    <div class="cmd-delai-days ${progressClass}">${joursRestants < 0 ? '-' : ''}${joursAbs}</div>
    <div class="cmd-delai-label">${joursLabel}</div>
    <div class="cmd-delai-progress">
      <div class="cmd-delai-progress-bar ${progressClass}" style="width:${progressPercent}%"></div>
    </div>
    <div class="cmd-delai-info">
      <span>Livraison: ${cmd.dateLivraison}</span>
      <span>Jours ouvrables seulement</span>
    </div>
  `;
}

// ===== CALENDRIER FICHE COMMANDE =====
let cmdCalCurrentField = null;

function openCmdDatePicker(field) {
  cmdCalCurrentField = field;
  
  // Parser la date actuelle si elle existe
  const elementId = field === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const currentEl = document.getElementById(elementId);
  const currentValue = currentEl?.textContent;
  
  if (currentValue && currentValue !== 'AAAA-MM-JJ') {
    const parts = currentValue.split('-');
    if (parts.length === 3) {
      tableCalYear = parseInt(parts[0]);
      tableCalMonth = parseInt(parts[1]) - 1;
    }
  } else {
    tableCalMonth = new Date().getMonth();
    tableCalYear = new Date().getFullYear();
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'table-calendar-overlay';
  overlay.id = 'cmdCalendarOverlay';
  overlay.onclick = (e) => { if (e.target === overlay) closeCmdCalendar(); };
  
  const fieldNames = {
    'dateRecue': 'Date Reçue',
    'dateLivraison': 'Date Livraison'
  };
  
  overlay.innerHTML = `
    <div class="table-calendar-popup">
      <div class="table-calendar-header">${fieldNames[field] || field}</div>
      <div class="table-cal-nav">
        <button onclick="cmdCalPrev()">◀</button>
        <span class="table-cal-month" id="cmdCalMonthYear">${MOIS_NOMS[tableCalMonth]} ${tableCalYear}</span>
        <button onclick="cmdCalNext()">▶</button>
      </div>
      <div class="table-cal-weekdays">
        <div class="table-cal-weekday">Dim</div>
        <div class="table-cal-weekday">Lun</div>
        <div class="table-cal-weekday">Mar</div>
        <div class="table-cal-weekday">Mer</div>
        <div class="table-cal-weekday">Jeu</div>
        <div class="table-cal-weekday">Ven</div>
        <div class="table-cal-weekday">Sam</div>
      </div>
      <div class="table-cal-days" id="cmdCalDays"></div>
      <div class="table-cal-buttons">
        <button class="table-cal-today" onclick="cmdCalSelectToday()">Aujourd'hui</button>
        <button class="table-cal-clear" onclick="cmdCalClear()">Effacer</button>
        <button class="table-cal-close" onclick="closeCmdCalendar()">Fermer</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  renderCmdCalDays();
}

function renderCmdCalDays() {
  const container = document.getElementById('cmdCalDays');
  if (!container) return;
  
  container.innerHTML = '';
  
  const firstDay = new Date(tableCalYear, tableCalMonth, 1).getDay();
  const daysInMonth = new Date(tableCalYear, tableCalMonth + 1, 0).getDate();
  const today = new Date();
  
  // Mettre à jour le titre
  const monthYearEl = document.getElementById('cmdCalMonthYear');
  if (monthYearEl) {
    monthYearEl.textContent = `${MOIS_NOMS[tableCalMonth]} ${tableCalYear}`;
  }
  
  // Cases vides avant le 1er jour
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'table-cal-day empty';
    container.appendChild(empty);
  }
  
  // Jours du mois
  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'table-cal-day';
    dayEl.textContent = day;
    
    // Marquer aujourd'hui
    if (day === today.getDate() && tableCalMonth === today.getMonth() && tableCalYear === today.getFullYear()) {
      dayEl.classList.add('today');
    }
    
    dayEl.onclick = () => cmdCalSelectDay(day);
    container.appendChild(dayEl);
  }
}

function cmdCalPrev() {
  tableCalMonth--;
  if (tableCalMonth < 0) {
    tableCalMonth = 11;
    tableCalYear--;
  }
  renderCmdCalDays();
}

function cmdCalNext() {
  tableCalMonth++;
  if (tableCalMonth > 11) {
    tableCalMonth = 0;
    tableCalYear++;
  }
  renderCmdCalDays();
}

function cmdCalSelectDay(day) {
  const month = String(tableCalMonth + 1).padStart(2, '0');
  const dayStr = String(day).padStart(2, '0');
  const dateStr = `${tableCalYear}-${month}-${dayStr}`;
  
  const elementId = cmdCalCurrentField === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const el = document.getElementById(elementId);
  if (el) el.textContent = dateStr;
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalCurrentField === 'dateLivraison' && currentCmdId) {
    updateDelaiDisplay(currentCmdId, dateStr);
  }
  
  closeCmdCalendar();
}

function cmdCalSelectToday() {
  const today = new Date();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const dateStr = `${today.getFullYear()}-${month}-${day}`;
  
  const elementId = cmdCalCurrentField === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const el = document.getElementById(elementId);
  if (el) el.textContent = dateStr;
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalCurrentField === 'dateLivraison' && currentCmdId) {
    updateDelaiDisplay(currentCmdId, dateStr);
  }
  
  closeCmdCalendar();
}

function cmdCalClear() {
  const elementId = cmdCalCurrentField === 'dateRecue' ? 'cmdDateRecue' : 'cmdDateLivraison';
  const el = document.getElementById(elementId);
  if (el) el.textContent = 'AAAA-MM-JJ';
  
  // Mettre à jour le délai si c'est la date de livraison
  if (cmdCalCurrentField === 'dateLivraison' && currentCmdId) {
    updateDelaiDisplay(currentCmdId, null);
  }
  
  closeCmdCalendar();
}

function updateDelaiDisplay(cmdId, dateLivraison) {
  const section = document.getElementById('cmdDelaiSection_' + cmdId);
  if (section) {
    const cmd = { dateLivraison: dateLivraison };
    section.innerHTML = renderDelaiSection(cmd);
  }
}

function closeCmdCalendar() {
  const overlay = document.getElementById('cmdCalendarOverlay');
  if (overlay) overlay.remove();
  cmdCalCurrentField = null;
}

// Mettre à jour la couleur de région d'une carte
function updateCardRegionColor(cardId, region) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  card.classList.remove('region-qc', 'region-on', 'region-ma');
  if (region === 'Québec') card.classList.add('region-qc');
  else if (region === 'Ontario') card.classList.add('region-on');
  else if (region === 'Maritime') card.classList.add('region-ma');
}

// Mettre à jour la carte dans le DOM Kanban depuis le tableau
function updateCardFromTable(cardId, field, value) {
  const card = document.querySelector(`.mcard[data-card-id="${cardId}"]`);
  if (!card) return;
  
  switch(field) {
    case 'name':
      const titleInput = card.querySelector('.mcard-title');
      if (titleInput) titleInput.value = value;
      break;
    case 'order':
      const orderInput = card.querySelector('.mcard-order');
      if (orderInput) orderInput.value = value;
      break;
    case 'client':
      const clientSpan = card.querySelector('.mcard-client');
      if (clientSpan) clientSpan.textContent = value || 'Client';
      break;
    case 'intervenant':
      const intervenantSpan = card.querySelector('.mcard-intervenant');
      if (intervenantSpan) intervenantSpan.textContent = value || 'Intervenant';
      break;
  }
}


// Setup du redimensionnement des colonnes
function setupColumnResize() {
  const handles = document.querySelectorAll('.resize-handle');
  handles.forEach(handle => {
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      const th = this.parentElement;
      const startX = e.pageX;
      const startWidth = th.offsetWidth;
      
      function onMouseMove(e) {
        const newWidth = startWidth + (e.pageX - startX);
        if (newWidth > 50) {
          th.style.width = newWidth + 'px';
          th.style.minWidth = newWidth + 'px';
        }
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  });
}

// ===== GESTION DES PAGES (MOULAGES / COMMANDES) =====
let currentPage = 'moulages';
let commandesData = {};

function switchPage(page) {
  currentPage = page;
  
  const boardsContainer = document.getElementById('boardsContainer');
  const commandesPage = document.getElementById('commandesPage');
  const robotView = document.getElementById('robotHorizontalView');
  const btnLogoMoulages = document.getElementById('btnLogoMoulages');
  const btnLogoCommandes = document.getElementById('btnLogoCommandes');
  const btnAddMoulage = document.getElementById('btnAddMoulage');
  const btnAddCommande = document.getElementById('btnAddCommande');
  const pageTitle = document.getElementById('pageTitle');
  const searchInput = document.getElementById('searchInput');
  
  if (page === 'moulages') {
    // Afficher la page moulages
    boardsContainer.style.display = 'block';
    boardsContainer.classList.remove('hidden');
    commandesPage.classList.add('hidden');
    commandesPage.style.display = 'none';
    robotView.style.display = 'none';
    isRobotViewActive = false;
    
    btnLogoMoulages.classList.add('active');
    btnLogoCommandes.classList.remove('active');
    btnAddMoulage.classList.remove('hidden');
    btnAddCommande.classList.add('hidden');
    pageTitle.textContent = 'Outil de gestion des moulages';
    searchInput.placeholder = 'Rechercher un moulage...';
    
    // Forcer le rendu des cartes existantes
    updateColumnCounts();
    console.log('📦 Page Moulages activée');
  } else {
    // Afficher la page commandes
    boardsContainer.style.display = 'none';
    boardsContainer.classList.add('hidden');
    commandesPage.classList.remove('hidden');
    commandesPage.style.display = 'block';
    robotView.style.display = 'none';
    isRobotViewActive = false;
    
    btnLogoMoulages.classList.remove('active');
    btnLogoCommandes.classList.add('active');
    btnAddMoulage.classList.add('hidden');
    btnAddCommande.classList.remove('hidden');
    pageTitle.textContent = 'Outil de gestion des commandes';
    searchInput.placeholder = 'Rechercher une commande...';
    
    // Rafraîchir le board commandes
    renderCommandesBoard();
    console.log('📋 Page Commandes activée');
  }
}

// ===== GESTION DES COMMANDES =====
function renderCommandesBoard() {
  const columns = document.querySelectorAll('#commandesBoard .col');
  columns.forEach(col => {
    // Garder le header, vider le reste
    const header = col.querySelector('.colheader');
    col.innerHTML = '';
    col.appendChild(header);
  });
  
  // Rendre les cartes commandes
  Object.entries(commandesData).forEach(([cmdId, cmd]) => {
    const colIndex = cmd.columnIndex ?? 0;
    const col = document.querySelector(`#commandesBoard .col[data-col-cmd="${colIndex}"]`);
    if (col) {
      const cardEl = createCommandeCard(cmdId, cmd);
      col.appendChild(cardEl);
    }
  });
  
  updateCommandesCounts();
}

function createCommandeCard(cmdId, data) {
  const region = data.region || 'Québec';
  let regionClass = 'region-qc';
  if (region === 'Ontario') regionClass = 'region-on';
  else if (region === 'Maritime') regionClass = 'region-ma';
  
  // Classe client
  let clientClass = '';
  if (data.client === 'Vermeiren') clientClass = 'client-vermeiren';
  else if (data.client === 'HME') clientClass = 'client-hme';
  else if (data.client === 'France') clientClass = 'client-france';
  
  const card = document.createElement('div');
  card.className = `mcard ${regionClass} ${clientClass}`.trim();
  card.setAttribute('data-cmd-id', cmdId);
  
  // Calculer délai pour commandes (jours OUVRABLES restants jusqu'à dateLivraison)
  let delayText = 'Délai --';
  let isRetard = false;
  
  if (data.dateLivraison) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const livraison = new Date(data.dateLivraison);
    livraison.setHours(0, 0, 0, 0);
    
    if (livraison < today) {
      // En retard - calculer les jours ouvrables de retard
      const joursRetard = calculerJoursOuvrables(livraison, today);
      delayText = `Retard ${joursRetard} j`;
      isRetard = true;
    } else if (livraison.getTime() === today.getTime()) {
      delayText = 'Délai 0 j';
    } else {
      // Calculer les jours ouvrables restants
      const joursRestants = calculerJoursOuvrables(today, livraison);
      delayText = `Délai ${joursRestants} j`;
    }
  }
  
  card.innerHTML = `
    <div class="mcard-header">
      <div class="mcard-info">
        <div class="mcard-title-line">
          <div class="mcard-client-select" data-cmd-id="${cmdId}" onclick="showClientMenu('${cmdId}', event)">${data.client || 'Client'}</div>
        </div>
        <div class="mcard-order-line">
          <input type="text" class="mcard-order" value="${data.order || '000000'}" data-field="order" maxlength="6">
          <button class="mcard-toggle-btn" onclick="openCommandeFiche('${cmdId}')">Fiche</button>
        </div>
      </div>
    </div>
    <div class="mcard-separator"></div>
    <div class="mcard-delay-pill ${isRetard ? 'retard' : ''}"><span>${delayText}</span></div>
    <div class="mcard-footer-buttons">
      <button class="mcard-btn mcard-btn-move" onclick="showCommandeMoveMenu('${cmdId}')">Déplacer</button>
      <button class="mcard-btn mcard-btn-delete" onclick="confirmDeleteCommande('${cmdId}')">Supprimer</button>
    </div>
  `;
  
  // Event listeners pour édition inline
  const orderInput = card.querySelector('.mcard-order');
  
  orderInput.addEventListener('blur', () => {
    commandesData[cmdId].order = orderInput.value;
    saveCommandeToFirebase(cmdId);
  });
  
  return card;
}

function updateCommandesCounts() {
  const columns = document.querySelectorAll('#commandesBoard .col');
  columns.forEach(col => {
    const count = col.querySelectorAll('.mcard').length;
    const countEl = col.querySelector('.col-count-cmd');
    if (countEl) countEl.textContent = count;
  });
}

function addNewCommande() {
  const cmdId = 'cmd_' + Date.now();
  const newCmd = {
    client: 'Nouveau client',
    order: '000000',
    item: 'Article',
    region: 'Québec',
    columnIndex: 0,
    dateCreated: new Date().toISOString(),
    notes: ''
  };
  
  commandesData[cmdId] = newCmd;
  saveCommandeToFirebase(cmdId);
  renderCommandesBoard();
  console.log(`✅ Nouvelle commande ajoutée: ${cmdId}`);
}

function showCommandeMoveMenu(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const currentCol = cmd.columnIndex ?? 0;
  const columnNames = ['🏭 Magasin', '🔧 Production', '🔍 Inspection', '🚚 Expédié', '📋 BO'];
  
  // Compter les cartes par colonne
  const countsByCol = [0, 0, 0, 0, 0, 0];
  Object.values(commandesData).forEach(c => {
    const colIdx = c.columnIndex ?? 0;
    if (colIdx >= 0 && colIdx < 6) countsByCol[colIdx]++;
  });
  
  const overlay = document.createElement('div');
  overlay.className = 'move-overlay';
  overlay.id = 'cmdMoveOverlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  
  // Générer les colonnes avec positions
  let columnsHtml = columnNames.map((name, idx) => {
    const count = countsByCol[idx];
    const isCurrent = idx === currentCol;
    const positions = [];
    
    // Générer les positions disponibles (1 = en haut)
    for (let pos = 1; pos <= count + 1; pos++) {
      if (isCurrent && pos === count + 1) continue; // Pas de nouvelle position dans la colonne actuelle
      const isCurrentPos = isCurrent && pos === (Object.values(commandesData).filter(c => (c.columnIndex ?? 0) === idx).findIndex(c => c === cmd) + 1);
      positions.push(`<button class="move-pos-btn ${isCurrentPos ? 'current' : ''}" onclick="moveCommandeToPos('${cmdId}', ${idx}, ${pos - 1})" ${isCurrentPos ? 'disabled' : ''}>${pos}</button>`);
    }
    
    return `
      <div class="move-col ${isCurrent ? 'current-col' : ''}">
        <div class="move-col-header">${name}</div>
        <div class="move-col-count">${count} carte${count > 1 ? 's' : ''}</div>
        <div class="move-col-positions">${positions.join('')}</div>
      </div>
    `;
  }).join('');
  
  overlay.innerHTML = `
    <div class="move-panel">
      <div class="move-title">Déplacer "${cmd.client || 'Commande'}" vers...</div>
      <div class="move-columns-grid">${columnsHtml}</div>
      <div class="move-actions">
        <button class="move-delete-btn" onclick="confirmDeleteCommande('${cmdId}')">🗑️ Supprimer</button>
        <button class="move-cancel-btn" onclick="document.getElementById('cmdMoveOverlay').remove()">Annuler</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
}

function moveCommandeToPos(cmdId, colIndex, position) {
  if (!commandesData[cmdId]) return;
  
  commandesData[cmdId].columnIndex = colIndex;
  commandesData[cmdId].position = position;
  saveCommandeToFirebase(cmdId);
  
  document.getElementById('cmdMoveOverlay')?.remove();
  renderCommandesBoard();
  console.log(`✅ Commande ${cmdId} déplacée vers colonne ${colIndex}, position ${position}`);
}

function confirmDeleteCommande(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  document.getElementById('cmdMoveOverlay')?.remove();
  
  const overlay = document.createElement('div');
  overlay.className = 'move-overlay';
  overlay.id = 'cmdDeleteOverlay';
  
  overlay.innerHTML = `
    <div class="move-menu">
      <div class="move-menu-title">⚠️ Supprimer cette commande?</div>
      <div style="text-align:center;padding:10px;font-size:14px;color:#fbbf24;">${cmd.client || 'Sans nom'}</div>
      <div class="move-menu-actions">
        <button class="move-delete-btn" onclick="deleteCommande('${cmdId}')">🗑️ Oui, supprimer</button>
        <button class="move-cancel-btn" onclick="document.getElementById('cmdDeleteOverlay').remove()">Non, annuler</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
}

function deleteCommande(cmdId) {
  if (!commandesData[cmdId]) return;
  
  delete commandesData[cmdId];
  
  // Supprimer de Firebase
  if (firebaseDb) {
    firebaseDb.ref('commandes/' + cmdId).remove();
  }
  
  document.getElementById('cmdDeleteOverlay')?.remove();
  renderCommandesBoard();
  console.log(`🗑️ Commande ${cmdId} supprimée`);
}

// Menu client sur carte commande
const CMD_CLIENTS = ['Vermeiren', 'HME', 'France'];

function showClientMenu(cmdId, event) {
  event.stopPropagation();
  
  // Fermer menu existant
  closeClientMenu();
  
  const menu = document.createElement('div');
  menu.className = 'client-menu-popup';
  menu.id = 'clientMenuPopup';
  menu.style.left = event.clientX + 'px';
  menu.style.top = event.clientY + 'px';
  
  menu.innerHTML = CMD_CLIENTS.map(client => 
    `<div class="client-menu-item" onclick="selectClient('${cmdId}', '${client}')">${client}</div>`
  ).join('');
  
  document.body.appendChild(menu);
  
  // Fermer au clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeClientMenu, { once: true });
  }, 10);
}

function closeClientMenu() {
  const menu = document.getElementById('clientMenuPopup');
  if (menu) menu.remove();
}

function selectClient(cmdId, client) {
  commandesData[cmdId].client = client;
  saveCommandeToFirebase(cmdId);
  renderCommandesBoard();
  closeClientMenu();
}

function updateCmdClientFromFiche(cmdId, client) {
  commandesData[cmdId].client = client;
  // Mettre à jour la carte si visible
  const cardEl = document.querySelector(`.mcard[data-cmd-id="${cmdId}"] .mcard-client-select`);
  if (cardEl) cardEl.textContent = client || 'Client';
}

function openCommandeFiche(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  // Initialiser items si pas présent
  if (!cmd.items) cmd.items = [];
  
  const overlay = document.getElementById('cmdFicheOverlay');
  const content = document.getElementById('cmdFicheContent');
  
  content.innerHTML = `
    <div class="cmd-fiche-container-split">
      <!-- WRAPPER GAUCHE (1/3) -->
      <div class="cmd-left-wrapper">
        <!-- Onglets en haut comme des dossiers -->
        <div class="cmd-tabs-container">
          <div class="cmd-tab tab-info" id="tabInfo_${cmdId}" onclick="switchCmdTab('${cmdId}', 'info')">📋 Information</div>
          <div class="cmd-tab tab-magasin active" id="tabMagasin_${cmdId}" onclick="switchCmdTab('${cmdId}', 'magasin')">📦 Magasin</div>
        </div>
        
        <!-- Fiche gauche -->
        <div class="cmd-fiche-page-third">
          <!-- CONTENU ONGLET INFORMATION -->
          <div class="cmd-tab-content" id="tabContentInfo_${cmdId}">
            <div class="cmd-fiche-header">
              <div class="cmd-fiche-logo">
                <img src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Physipro"/>
              </div>
              <div class="cmd-fiche-title">
                <h3>Fiche Commande</h3>
                <div class="subtitle">Information</div>
              </div>
              <div style="width:24px;"></div>
            </div>
            
            <div class="cmd-info-body">
              <div class="cmd-info-field">
                <label>Client</label>
                <select id="cmdClient" onchange="updateCmdClientFromFiche('${cmdId}', this.value)">
                  <option value="">-- Sélectionner --</option>
                  <option value="Vermeiren" ${cmd.client === 'Vermeiren' ? 'selected' : ''}>Vermeiren</option>
                  <option value="HME" ${cmd.client === 'HME' ? 'selected' : ''}>HME</option>
                  <option value="France" ${cmd.client === 'France' ? 'selected' : ''}>France</option>
                </select>
              </div>
              <div class="cmd-info-row">
                <div class="cmd-info-field half">
                  <label>N° Commande</label>
                  <input type="text" id="cmdNumero" value="${cmd.order || ''}" placeholder="000000" onchange="updateCmdField('${cmdId}', 'order', this.value)">
                </div>
                <div class="cmd-info-field half">
                  <label>N° PO</label>
                  <input type="text" id="cmdNumeroPO" value="${cmd.numeroPO || ''}" placeholder="000000" onchange="updateCmdField('${cmdId}', 'numeroPO', this.value)">
                </div>
              </div>
              <div class="cmd-info-row">
                <div class="cmd-info-field half">
                  <label>Date reçue</label>
                  <div class="cmd-fiche-date-pill" id="cmdDateRecue" onclick="openCmdDatePicker('dateRecue')">${cmd.dateRecue || 'AAAA-MM-JJ'}</div>
                </div>
                <div class="cmd-info-field half">
                  <label>Date livraison</label>
                  <div class="cmd-fiche-date-pill" id="cmdDateLivraison" onclick="openCmdDatePicker('dateLivraison')">${cmd.dateLivraison || 'AAAA-MM-JJ'}</div>
                </div>
              </div>
              
              <!-- DÉLAI - Affichage professionnel -->
              <div class="cmd-delai-section" id="cmdDelaiSection_${cmdId}">
                ${renderDelaiSection(cmd)}
              </div>
            </div>
            
            <!-- Footer Info -->
            <div class="cmd-fiche-footer-btns" style="padding: 3px; margin-top: auto;">
              <button onclick="saveCmdFicheAndClose('${cmdId}')" class="cmd-close-btn" style="font-size: 7px; padding: 3px 8px;">Fermer</button>
            </div>
          </div>
          
          <!-- CONTENU ONGLET MAGASIN -->
          <div class="cmd-tab-content active" id="tabContentMagasin_${cmdId}">
            <div class="cmd-fiche-header">
              <div class="cmd-fiche-logo">
                <img src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Physipro"/>
              </div>
              <div class="cmd-fiche-title">
                <h3>Fiche Commande</h3>
                <div class="subtitle">Magasin</div>
              </div>
              <div style="width:24px;"></div>
            </div>
            
            <div class="cmd-fiche-body" style="padding: 4px 6px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
              <!-- Zone matériaux avec scroll -->
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                <h4 style="font-size: 8px; margin: 0;">Matériaux</h4>
                <div style="display: flex; gap: 4px;">
                  <button class="cmd-recettes-btn" onclick="openRecettesPopup()" style="font-size: 7px; padding: 3px 8px; background: linear-gradient(to bottom, #3f6eb8, #1d3560); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">⚙ Recettes</button>
                  <button onclick="printMateriaux('${cmdId}')" style="font-size: 7px; padding: 3px 8px; background: linear-gradient(to bottom, #3b82f6, #2563eb); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 600;">🖨 Imprimer</button>
                </div>
              </div>
              <div class="cmd-materiaux-recettes-scroll" id="cmdMateriauxRecettes" style="flex: 1; overflow-y: auto; overflow-x: hidden; margin-bottom: 2px;">
                <div class="cmd-materiaux-container" id="cmdMateriauxContainer">
                  <!-- Les colonnes seront générées dynamiquement par item -->
                </div>
              </div>
              
              <!-- Total Matériaux -->
              <div class="cmd-materiaux-total-section" id="cmdMateriauxTotal" style="margin-bottom: 4px;">
                <!-- Généré par updateMateriauxSection -->
              </div>
              
              <!-- Zone Notes REPLIABLE -->
              <div class="cmd-notes-collapsible" id="cmdNotesCollapsible_${cmdId}" style="display: none; flex: 0 0 50%; border-top: 1px solid #cbd5e1; padding-top: 4px;">
                <div style="font-size: 7px; font-weight: 600; color: #1d3560; margin-bottom: 2px;">📝 Notes</div>
                <textarea class="cmd-notes-textarea-full" id="cmdNotesTextarea_${cmdId}" 
                  placeholder="Cliquez pour ajouter une note..."
                  onfocus="prepareCmdNoteSignature('${cmdId}')"
                  onblur="saveCmdNotesInline('${cmdId}')"
                  style="flex: 1; width: 100%; height: calc(100% - 20px); border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; font-size: 9px; resize: none; font-family: inherit;">${cmd.notes || ''}</textarea>
              </div>
            </div>
            
            <!-- Footer Magasin - Notes + Fermer -->
            <div class="cmd-fiche-footer-btns" style="display: flex; gap: 4px; padding: 4px 6px; border-top: 1px solid #e5e7eb;">
              <button onclick="toggleCmdNotesZone('${cmdId}')" id="cmdNotesToggleBtn_${cmdId}" style="flex: 1; font-size: 8px; padding: 6px 8px; background: linear-gradient(to bottom, #3f6eb8, #1d3560); color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center; font-weight: 600;">📝 Notes</button>
              <button onclick="saveCmdFicheAndClose('${cmdId}')" class="cmd-close-btn" style="font-size: 7px; padding: 4px 12px;">Fermer</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- WRAPPER DROITE (2/3) -->
      <div class="cmd-right-wrapper">
        <!-- Espace pour aligner avec les onglets -->
        <div class="cmd-tabs-spacer"></div>
        
        <!-- Fiche droite -->
        <div class="cmd-fiche-page-twothirds">
          <div class="cmd-fiche-header">
            <div class="cmd-fiche-logo">
              <img src="https://i.postimg.cc/wx7n6yX5/logo-physipro.png" alt="Physipro"/>
            </div>
            <div class="cmd-fiche-title">
              <h3>Fiche Commande</h3>
              <div class="subtitle">Items</div>
            </div>
            <button onclick="closeCmdFiche()" style="width:24px;height:24px;background:linear-gradient(to bottom,#ff4444,#cc0000);border:none;border-radius:4px;color:white;cursor:pointer;font-size:12px;">✕</button>
          </div>
          
          <div class="cmd-fiche-body" style="flex: 1; overflow: hidden;">
            <div class="cmd-fiche-section">
              <div class="cmd-department-single" id="deptAtelier">
                <div class="cmd-items-list" id="atelierItemsList">
                  ${renderDeptItems(cmd.items, cmdId, 'atelier')}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  overlay.classList.add('active');
  currentCmdId = cmdId;
  
  // Mettre à jour les matériaux automatiquement
  setTimeout(() => updateMateriauxSection(cmdId), 100);
}

// Fonction pour basculer entre les onglets
function switchCmdTab(cmdId, tab) {
  // Désactiver tous les onglets
  document.getElementById('tabInfo_' + cmdId).classList.remove('active');
  document.getElementById('tabMagasin_' + cmdId).classList.remove('active');
  document.getElementById('tabContentInfo_' + cmdId).classList.remove('active');
  document.getElementById('tabContentMagasin_' + cmdId).classList.remove('active');
  
  // Activer l'onglet sélectionné
  if (tab === 'info') {
    document.getElementById('tabInfo_' + cmdId).classList.add('active');
    document.getElementById('tabContentInfo_' + cmdId).classList.add('active');
  } else {
    document.getElementById('tabMagasin_' + cmdId).classList.add('active');
    document.getElementById('tabContentMagasin_' + cmdId).classList.add('active');
  }
}

let currentCmdId = null;

function renderDeptItems(items, cmdId, dept) {
  // Tableau avec espacement uniforme via CSS border-spacing
  // ATELIER: 6 cols (+, Item, Qté, Total, Status, Notes)
  // COUTURE: 6 cols (Item, Qté, Total, Status, Emp, Notes)
  // INSPECTION: 7 cols (Item, Qté, Total, Status, Expéd, Notes, X)
  let html = `
    <table class="cmd-items-table">
      <colgroup>
        <!-- ATELIER -->
        <col style="width: 14px;">
        <col style="width: 54px;">
        <col style="width: 26px;">
        <col style="width: 34px;">
        <col style="width: 44px;">
        <col style="width: 32px;">
        <!-- COUTURE -->
        <col style="width: 54px;">
        <col style="width: 26px;">
        <col style="width: 34px;">
        <col style="width: 44px;">
        <col style="width: 40px;">
        <col style="width: 32px;">
        <!-- INSPECTION -->
        <col style="width: 54px;">
        <col style="width: 26px;">
        <col style="width: 34px;">
        <col style="width: 44px;">
        <col style="width: 100px;">
        <col style="width: 32px;">
        <col style="width: 10px;">
      </colgroup>
      <thead>
        <tr>
          <th class="section-header atelier" colspan="6">Atelier</th>
          <th class="section-header couture" colspan="6">Couture</th>
          <th class="section-header" colspan="7">Inspection</th>
        </tr>
        <tr>
          <!-- ATELIER -->
          <th class="col-header col-plus"></th>
          <th class="col-header col-item"><button class="cmd-table-add-item-green" onclick="addCmdItemDept('${cmdId}')">+ Item</button></th>
          <th class="col-header col-qty">Qté</th>
          <th class="col-header col-total">Total</th>
          <th class="col-header col-status">Status</th>
          <th class="col-header col-notes border-right-solid">Notes</th>
          <!-- COUTURE -->
          <th class="col-header col-item">Item</th>
          <th class="col-header col-qty">Qté</th>
          <th class="col-header col-total">Total</th>
          <th class="col-header col-status">Status</th>
          <th class="col-header col-emp">Emp.</th>
          <th class="col-header col-notes border-right-solid">Notes</th>
          <!-- INSPECTION -->
          <th class="col-header col-item">Item</th>
          <th class="col-header col-qty">Qté</th>
          <th class="col-header col-total">Total</th>
          <th class="col-header col-status">Status</th>
          <th class="col-header col-exped">Expédition</th>
          <th class="col-header col-notes">Notes</th>
          <th class="col-header col-x"></th>
        </tr>
      </thead>
      <tbody>
  `;
  
  if (!items || items.length === 0) {
    html += `<tr><td colspan="19" style="text-align:center;color:#9ca3af;padding:10px;font-size:8px;">Aucun item - Cliquez sur "+ Item" pour ajouter</td></tr>`;
  } else {
    items.forEach((item, itemIdx) => {
      const grandeurs = item.grandeurs || [];
      
      // Calculer quantité totale
      let totalQty = 0;
      grandeurs.forEach(g => {
        totalQty += parseInt(g.qty) || 0;
      });
      
      // Ligne de l'item
      html += `
        <tr class="item-row">
          <!-- ATELIER -->
          <td class="col-plus"><button class="cmd-table-add-grandeur" onclick="addCmdGrandeurDept('${cmdId}', ${itemIdx})">+</button></td>
          <td class="col-item"><button class="cmd-table-item-pill" onclick="openCmdItemMenu('${cmdId}', ${itemIdx}, event)">${item.name || 'Item'}</button></td>
          <td class="col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="col-total"></td>
          <td class="col-status"></td>
          <td class="col-notes border-right-solid"></td>
          <!-- COUTURE -->
          <td class="col-item"><span class="cmd-table-item-name">${item.name || 'Item'}</span></td>
          <td class="col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="col-total"></td>
          <td class="col-status"></td>
          <td class="col-emp"></td>
          <td class="col-notes border-right-solid"></td>
          <!-- INSPECTION -->
          <td class="col-item"><span class="cmd-table-item-name">${item.name || 'Item'}</span></td>
          <td class="col-qty"><span class="cmd-table-item-qty">${totalQty}</span></td>
          <td class="col-total"></td>
          <td class="col-status"></td>
          <td class="col-exped"></td>
          <td class="col-notes"></td>
          <td class="col-x"><span class="cmd-table-delete-text" onclick="deleteCmdItemDept('${cmdId}', ${itemIdx})">−</span></td>
        </tr>
      `;
      
      // Lignes des grandeurs
      grandeurs.forEach((g, gIdx) => {
        const qtyTotal = g.qty || 0;
        
        // Données Atelier - Status: À faire, Partiel, Complet
        const atelierData = g.atelier || { status: 'todo', note: '', qtyFait: 0 };
        const atelierStatusClass = atelierData.status === 'done' ? 'done' : (atelierData.status === 'partial' ? 'partial' : 'todo');
        const atelierStatusText = atelierData.status === 'done' ? 'Complet' : (atelierData.status === 'partial' ? 'Partiel' : 'À faire');
        const atelierQtyFait = atelierData.qtyFait || 0;
        const atelierHasNote = atelierData.note && atelierData.note.trim() !== '';
        const atelierNoteClass = atelierHasNote ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        
        // Données Couture - Status: À faire, Partiel, Complet
        const coutureData = g.couture || { status: 'todo', note: '', qtyFait: 0, employe: '' };
        const coutureStatusClass = coutureData.status === 'done' ? 'done' : (coutureData.status === 'partial' ? 'partial' : 'todo');
        const coutureStatusText = coutureData.status === 'done' ? 'Complet' : (coutureData.status === 'partial' ? 'Partiel' : 'À faire');
        const coutureQtyFait = coutureData.qtyFait || 0;
        const coutureHasNote = coutureData.note && coutureData.note.trim() !== '';
        const coutureNoteClass = coutureHasNote ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        const coutureEmpText = coutureData.employe || 'Employé';
        
        // Données Inspection - Status: À faire, Partiel, Emboîté + Pastille Expédition
        const inspData = g.inspection || { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
        const inspStatusClass = inspData.status === 'done' ? 'done' : (inspData.status === 'partial' ? 'partial' : 'todo');
        const inspStatusText = inspData.status === 'done' ? 'Emboîté' : (inspData.status === 'partial' ? 'Partiel' : 'À faire');
        const inspQtyFait = inspData.qtyFait || 0;
        const inspHasNote = inspData.note && inspData.note.trim() !== '';
        const inspNoteClass = inspHasNote ? 'cmd-table-notes has-note' : 'cmd-table-notes';
        const inspExped = inspData.exped || 'attente';
        const inspExpedClass = inspExped === 'pret' ? 'pret' : 'attente';
        const inspExpedText = inspExped === 'pret' ? 'Prêt pour expédition' : 'En attente';
        
        html += `
          <tr class="grandeur-row">
            <!-- ATELIER -->
            <td class="col-plus"></td>
            <td class="col-item"><button class="cmd-table-grandeur-pill" onclick="openCmdGrandeurMenu('${cmdId}', ${itemIdx}, ${gIdx}, event)">${g.name || 'Grandeur'}</button></td>
            <td class="col-qty"><input type="number" class="cmd-table-qty-input" value="${qtyTotal}" min="0" onchange="updateCmdGrandeurQty('${cmdId}', ${itemIdx}, ${gIdx}, this.value)"></td>
            <td class="col-total"><div class="cmd-table-fait-container"><input type="number" class="cmd-table-fait-input-top" value="${atelierQtyFait}" min="0" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'atelier', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="col-status"><button class="cmd-table-status ${atelierStatusClass}">${atelierStatusText}</button></td>
            <td class="col-notes border-right-solid"><button class="${atelierNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'atelier', event)">Notes</button></td>
            <!-- COUTURE -->
            <td class="col-item"><span class="cmd-table-grandeur-readonly">${g.name || 'Grandeur'}</span></td>
            <td class="col-qty"><span class="cmd-table-qty-readonly">${qtyTotal}</span></td>
            <td class="col-total"><div class="cmd-table-fait-container"><input type="number" class="cmd-table-fait-input-top" value="${coutureQtyFait}" min="0" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="col-status"><button class="cmd-table-status ${coutureStatusClass}">${coutureStatusText}</button></td>
            <td class="col-emp"><button class="cmd-table-emp" onclick="openCmdEmployePopup('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', event)">${coutureEmpText}</button></td>
            <td class="col-notes border-right-solid"><button class="${coutureNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'couture', event)">Notes</button></td>
            <!-- INSPECTION -->
            <td class="col-item"><span class="cmd-table-grandeur-readonly">${g.name || 'Grandeur'}</span></td>
            <td class="col-qty"><span class="cmd-table-qty-readonly">${qtyTotal}</span></td>
            <td class="col-total"><div class="cmd-table-fait-container"><input type="number" class="cmd-table-fait-input-top" value="${inspQtyFait}" min="0" onchange="updateCmdQtyFait('${cmdId}', ${itemIdx}, ${gIdx}, 'inspection', this.value)"><span class="cmd-table-fait-separator">/</span><span class="cmd-table-fait-total">${qtyTotal}</span></div></td>
            <td class="col-status"><button class="cmd-table-status ${inspStatusClass}">${inspStatusText}</button></td>
            <td class="col-exped"><button class="cmd-table-exped ${inspExpedClass}" onclick="toggleInspExped('${cmdId}', ${itemIdx}, ${gIdx})">${inspExpedText}</button></td>
            <td class="col-notes"><button class="${inspNoteClass}" onclick="openCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, 'inspection', event)">Notes</button></td>
            <td class="col-x"><span class="cmd-table-delete-text" onclick="deleteCmdGrandeurDept('${cmdId}', ${itemIdx}, ${gIdx})">−</span></td>
          </tr>
        `;
      });
    });
  }
  
  html += `
      </tbody>
    </table>
  `;
  
  return html;
}

// Listes des valeurs pour Item et Grandeur
const CMD_ITEM_VALUES = ["Premium", "Ultra", "PZ Siliko", "Physiair", "Easy-fit", "HP2", "Cinch", "Resolve", "Brio", "Appuis Thoraciques"];
const CMD_GRANDEUR_VALUES = ["10 x 10", "12 x 12", "12 x 14", "14 x 14", "14 x 16", "16 x 16", "16 x 18", "18 x 16", "18 x 18", "18 x 20", "20 x 20", "20 x 18", "20 x 16", "20 x 22", "22 x 18", "22 x 20"];

// Menu État pour Inspection (grosse pastille)
function openInspectionEtatMenu(cmdId, itemIdx, gIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 2) + 'px';
  
  menu.innerHTML = `
    <div class="cmd-select-title">État</div>
    <button class="cmd-select-option" onclick="setInspectionEtat('${cmdId}', ${itemIdx}, ${gIdx}, 'Inspecté')">✓ Inspecté</button>
    <button class="cmd-select-option" onclick="setInspectionEtat('${cmdId}', ${itemIdx}, ${gIdx}, 'Expédié')">📦 Expédié</button>
    <button class="cmd-select-option" onclick="setInspectionEtat('${cmdId}', ${itemIdx}, ${gIdx}, '')">— Aucun</button>
  `;
  
  document.body.appendChild(menu);
  setTimeout(() => {
    document.addEventListener('click', closeCmdSelectMenu, { once: true });
  }, 10);
}

// Définir l'état pour Inspection
function setInspectionEtat(cmdId, itemIdx, gIdx, etat) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g.inspection) g.inspection = { status: 'todo', etat: '', note: '', qtyFait: 0 };
  g.inspection.etat = etat;
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

// Fermer le menu de sélection
function closeCmdSelectMenu() {
  const existing = document.querySelector('.cmd-select-menu');
  if (existing) existing.remove();
}

// Ouvrir le menu Item
function openCmdItemMenu(cmdId, itemIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 2) + 'px';
  
  menu.innerHTML = `
    <div class="cmd-select-title">Item commande</div>
    ${CMD_ITEM_VALUES.map(val => `
      <button class="cmd-select-option" onclick="selectCmdItem('${cmdId}', ${itemIdx}, '${val}')">${val}</button>
    `).join('')}
  `;
  
  document.body.appendChild(menu);
  
  // Fermer si clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeCmdSelectMenu, { once: true });
  }, 10);
}

// Sélectionner un Item
function selectCmdItem(cmdId, itemIdx, value) {
  commandesData[cmdId].items[itemIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

// Ouvrir le menu Grandeur
// Fonction utilitaire pour positionner les menus au centre et éviter les bords
function positionMenuSmart(menu, rect) {
  const menuWidth = 150; // Largeur estimée du menu
  const menuHeight = 200; // Hauteur estimée du menu
  const padding = 10;
  
  // Position horizontale: centrer par rapport à l'écran
  let left = (window.innerWidth - menuWidth) / 2;
  
  // Position verticale: centrer par rapport à l'écran
  let top = (window.innerHeight - menuHeight) / 2;
  
  // S'assurer qu'on ne dépasse pas les bords
  if (left < padding) left = padding;
  if (left + menuWidth > window.innerWidth - padding) left = window.innerWidth - menuWidth - padding;
  if (top < padding) top = padding;
  if (top + menuHeight > window.innerHeight - padding) top = window.innerHeight - menuHeight - padding;
  
  menu.style.left = left + 'px';
  menu.style.top = top + 'px';
}

function openCmdGrandeurMenu(cmdId, itemIdx, gIdx, event) {
  event.stopPropagation();
  closeCmdSelectMenu();
  
  const rect = event.target.getBoundingClientRect();
  const menu = document.createElement('div');
  menu.className = 'cmd-select-menu';
  
  menu.innerHTML = `
    <div class="cmd-select-title">Grandeur</div>
    ${CMD_GRANDEUR_VALUES.map(val => `
      <button class="cmd-select-option" onclick="selectCmdGrandeur('${cmdId}', ${itemIdx}, ${gIdx}, '${val}')">${val}</button>
    `).join('')}
  `;
  
  document.body.appendChild(menu);
  
  // Positionner au centre de l'écran
  positionMenuSmart(menu, rect);
  
  // Fermer si clic ailleurs
  setTimeout(() => {
    document.addEventListener('click', closeCmdSelectMenu, { once: true });
  }, 10);
}

// Sélectionner une Grandeur
function selectCmdGrandeur(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
  closeCmdSelectMenu();
}

function deleteCmdGrandeurDept(cmdId, itemIdx, gIdx) {
  commandesData[cmdId].items[itemIdx].grandeurs.splice(gIdx, 1);
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

// Mettre à jour Qté fait (format X/Y, on garde seulement X)
function updateCmdQtyFait(cmdId, itemIdx, gIdx, dept, value) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', note: '', qtyFait: 0 };
  
  // On prend juste le chiffre entré
  const qtyFait = parseInt(value) || 0;
  const qtyTotal = parseInt(g.qty) || 0;
  
  // Ne pas dépasser le total
  g[dept].qtyFait = Math.min(qtyFait, qtyTotal);
  
  // Mettre à jour le status automatiquement
  if (g[dept].qtyFait === 0) {
    g[dept].status = 'todo';
  } else if (g[dept].qtyFait >= qtyTotal) {
    g[dept].status = 'done';
  } else {
    g[dept].status = 'partial';
  }
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

// Ouvrir un prompt pour entrer la quantité faite
function openFaitInput(cmdId, itemIdx, gIdx, dept, qtyTotal) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  const currentQty = g[dept] ? (g[dept].qtyFait || 0) : 0;
  
  const input = prompt(`Quantité faite (sur ${qtyTotal}):`, currentQty);
  if (input !== null) {
    updateCmdQtyFait(cmdId, itemIdx, gIdx, dept, input);
  }
}

// Toggle expédition Inspection: En attente <-> Prêt pour expédition
function toggleInspExped(cmdId, itemIdx, gIdx) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g.inspection) g.inspection = { status: 'todo', note: '', qtyFait: 0, exped: 'attente' };
  
  g.inspection.exped = g.inspection.exped === 'pret' ? 'attente' : 'pret';
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

// Popup pour la nouvelle pastille (à définir plus tard)
function addCmdItemDept(cmdId) {
  if (!commandesData[cmdId].items) commandesData[cmdId].items = [];
  commandesData[cmdId].items.push({ 
    name: '', 
    grandeurs: [] 
  });
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function deleteCmdItemDept(cmdId, itemIdx) {
  commandesData[cmdId].items.splice(itemIdx, 1);
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdItemNameDept(cmdId, itemIdx, value) {
  commandesData[cmdId].items[itemIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function addCmdGrandeurDept(cmdId, itemIdx) {
  if (!commandesData[cmdId].items[itemIdx].grandeurs) {
    commandesData[cmdId].items[itemIdx].grandeurs = [];
  }
  commandesData[cmdId].items[itemIdx].grandeurs.push({ 
    name: '', 
    qty: 0,
    atelier: { status: 'todo', location: '', note: '' },
    couture: { status: 'todo', location: '', note: '' }
  });
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdGrandeurNameDept(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].name = value;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function updateCmdGrandeurQty(cmdId, itemIdx, gIdx, value) {
  commandesData[cmdId].items[itemIdx].grandeurs[gIdx].qty = parseInt(value) || 0;
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function toggleCmdGrandeurStatus(cmdId, itemIdx, gIdx, dept) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  
  // Toggle: todo <-> done (À faire <-> Complété)
  g[dept].status = g[dept].status === 'done' ? 'todo' : 'done';
  
  refreshCmdDeptTables(cmdId);
  saveCommandeToFirebase(cmdId);
}

function openCmdLocationPopup(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  
  const popup = document.createElement('div');
  popup.className = 'cmd-mini-note-popup';
  popup.id = 'cmdMiniNotePopup';
  popup.style.left = (event.clientX - 100) + 'px';
  popup.style.top = (event.clientY + 10) + 'px';
  
  // Créer les options du menu
  const locations = MENU_DATA.locations || [];
  const optionsHtml = locations.map((loc, idx) => 
    `<div class="menu-option location-option" data-loc-idx="${idx}" onclick="selectCmdLocation('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}', '${loc.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:9px;cursor:pointer;border-bottom:1px solid #e5e7eb;">${loc}</div>`
  ).join('');
  
  popup.innerHTML = `
    <div style="font-size:10px;font-weight:600;margin-bottom:4px;">Localisation</div>
    <div id="locationOptionsList" style="max-height:150px;overflow-y:auto;border:1px solid #d1d5db;border-radius:4px;background:#fff;">
      ${optionsHtml}
    </div>
    <input type="text" id="cmdLocationInput" value="${g[dept].location || ''}" placeholder="Ou saisir..." style="width:100%;padding:4px;font-size:9px;border:1px solid #d1d5db;border-radius:4px;box-sizing:border-box;margin-top:4px;">
    <div class="menu-popup-actions">
      <button class="menu-popup-add-btn" onclick="addNewLocation()">+ Ajouter</button>
      <button class="menu-popup-delete-btn" onclick="toggleDeleteLocationMode()">Supprimer</button>
    </div>
    <div class="mini-note-btns">
      <button class="save-btn" onclick="saveCmdLocation('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}')">OK</button>
      <button class="close-btn" onclick="closeCmdGrandeurNote()">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(popup);
}

let deleteLocationMode = false;

function toggleDeleteLocationMode() {
  deleteLocationMode = !deleteLocationMode;
  const options = document.querySelectorAll('.location-option');
  const deleteBtn = document.querySelector('.menu-popup-delete-btn');
  
  if (deleteLocationMode) {
    deleteBtn.textContent = '❌ Cliquez sur une location';
    deleteBtn.style.background = '#ef4444';
    options.forEach(opt => {
      opt.style.background = '#fee2e2';
      opt.onclick = function() {
        const idx = parseInt(this.dataset.locIdx);
        if (confirm('Supprimer "' + MENU_DATA.locations[idx] + '" ?')) {
          MENU_DATA.locations.splice(idx, 1);
          closeCmdGrandeurNote();
        }
      };
    });
  } else {
    deleteBtn.textContent = 'Supprimer';
    deleteBtn.style.background = '';
    closeCmdGrandeurNote();
  }
}

function selectCmdLocation(cmdId, itemIdx, gIdx, dept, location) {
  // Sauvegarder directement et fermer le menu
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  g[dept].location = location;
  saveCommandeToFirebase(cmdId);
  refreshCmdDeptTables(cmdId);
  closeCmdGrandeurNote();
}

function addNewLocation() {
  const input = document.getElementById('cmdLocationInput');
  if (input && input.value.trim()) {
    const newLoc = input.value.trim();
    if (!MENU_DATA.locations.includes(newLoc)) {
      MENU_DATA.locations.push(newLoc);
    }
  }
}

function saveCmdLocation(cmdId, itemIdx, gIdx, dept) {
  const input = document.getElementById('cmdLocationInput');
  if (input) {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
    g[dept].location = input.value;
    saveCommandeToFirebase(cmdId);
  }
  closeCmdGrandeurNote();
}

// Liste des employés par département
const EMPLOYES_ATELIER = ['Mario', 'Sina', 'Cassie'];
const EMPLOYES_COUTURE = ['Michelle', 'Francine', 'Stéphanie', 'Valérie'];

function openCmdEmployePopup(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '', employe: '' };
  
  const employesList = dept === 'atelier' ? EMPLOYES_ATELIER : EMPLOYES_COUTURE;
  
  const popup = document.createElement('div');
  popup.className = 'menu-popup';
  popup.id = 'cmdMiniNotePopup';
  
  const optionsHtml = employesList.map(emp => 
    `<div class="menu-option" onclick="selectCmdEmploye('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}', '${emp}')" style="padding:4px 8px;font-size:9px;cursor:pointer;border-bottom:1px solid #e5e7eb;">${emp}</div>`
  ).join('');
  
  popup.innerHTML = `
    <div style="font-size:10px;font-weight:600;margin-bottom:4px;">Employé</div>
    ${optionsHtml}
    <div class="menu-popup-btns" style="margin-top:4px;">
      <button class="close-btn" onclick="closeCmdGrandeurNote()" style="padding:4px 8px;font-size:9px;">Fermer</button>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Centrer à l'écran
  popup.style.left = ((window.innerWidth - 120) / 2) + 'px';
  popup.style.top = ((window.innerHeight - 150) / 2) + 'px';
}

function selectCmdEmploye(cmdId, itemIdx, gIdx, dept, employe) {
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '', employe: '' };
  g[dept].employe = employe;
  saveCommandeToFirebase(cmdId);
  closeCmdGrandeurNote();
  refreshCmdDeptTables(cmdId);
}

function openCmdGrandeurNoteDept(cmdId, itemIdx, gIdx, dept, event) {
  closeCmdGrandeurNote();
  
  const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
  if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
  
  const popup = document.createElement('div');
  popup.className = 'cmd-mini-note-popup';
  popup.id = 'cmdMiniNotePopup';
  
  popup.innerHTML = `
    <textarea id="cmdMiniNoteText">${g[dept].note || ''}</textarea>
    <div class="mini-note-btns">
      <button class="save-btn" onclick="saveCmdGrandeurNoteDept('${cmdId}', ${itemIdx}, ${gIdx}, '${dept}')">OK</button>
      <button class="close-btn" onclick="closeCmdGrandeurNote()">✕</button>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Centrer à l'écran
  popup.style.left = ((window.innerWidth - 200) / 2) + 'px';
  popup.style.top = ((window.innerHeight - 100) / 2) + 'px';
}

function saveCmdGrandeurNoteDept(cmdId, itemIdx, gIdx, dept) {
  const textarea = document.getElementById('cmdMiniNoteText');
  if (textarea) {
    const g = commandesData[cmdId].items[itemIdx].grandeurs[gIdx];
    if (!g[dept]) g[dept] = { status: 'todo', location: '', note: '' };
    g[dept].note = textarea.value;
    saveCommandeToFirebase(cmdId);
  }
  closeCmdGrandeurNote();
}

function refreshCmdDeptTables(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  const atelierList = document.getElementById('atelierItemsList');
  const coutureList = document.getElementById('coutureItemsList');
  const inspectionList = document.getElementById('inspectionItemsList');
  
  if (atelierList) atelierList.innerHTML = renderDeptItems(cmd.items, cmdId, 'atelier');
  if (coutureList) coutureList.innerHTML = renderDeptItems(cmd.items, cmdId, 'couture');
  if (inspectionList) inspectionList.innerHTML = renderDeptItems(cmd.items, cmdId, 'inspection');
  
  // Mettre à jour la section matériaux
  updateMateriauxSection(cmdId);
}

function closeCmdGrandeurNote() {
  const popup = document.getElementById('cmdMiniNotePopup');
  if (popup) popup.remove();
}

function toggleCmdNotes() {
  const content = document.getElementById('cmdNotesContent');
  const toggle = document.getElementById('cmdNotesToggle');
  if (content.classList.contains('expanded')) {
    content.classList.remove('expanded');
    toggle.textContent = '▼';
  } else {
    content.classList.add('expanded');
    toggle.textContent = '▲';
  }
}

function saveCmdFicheAndClose(cmdId) {
  // Récupérer les valeurs
  const dateRecueEl = document.getElementById('cmdDateRecue');
  const dateRecue = dateRecueEl?.textContent !== 'AAAA-MM-JJ' ? dateRecueEl?.textContent : '';
  const dateLivraisonEl = document.getElementById('cmdDateLivraison');
  const dateLivraison = dateLivraisonEl?.textContent !== 'AAAA-MM-JJ' ? dateLivraisonEl?.textContent : '';
  const numero = document.getElementById('cmdNumero')?.value || '';
  const numeroPO = document.getElementById('cmdNumeroPO')?.value || '';
  const client = document.getElementById('cmdClient')?.value || '';
  // Notes sont maintenant gérées via le popup, on garde la valeur existante
  
  // Mettre à jour les données
  commandesData[cmdId].dateRecue = dateRecue;
  commandesData[cmdId].dateLivraison = dateLivraison;
  commandesData[cmdId].order = numero;
  commandesData[cmdId].numeroPO = numeroPO;
  commandesData[cmdId].client = client;
  
  // Sauvegarder dans Firebase
  saveCommandeToFirebase(cmdId);
  
  // Mettre à jour la carte dans le board
  renderCommandesBoard();
  
  closeCmdFiche();
  console.log(`✅ Fiche commande ${cmdId} sauvegardée`);
}

function saveCmdFiche(cmdId) {
  saveCmdFicheAndClose(cmdId);
}

function closeCmdFiche() {
  const overlay = document.getElementById('cmdFicheOverlay');
  overlay.classList.remove('active');
  closeCmdGrandeurNote();
}

// Mise à jour d'un champ commande
function updateCmdField(cmdId, field, value) {
  if (commandesData[cmdId]) {
    commandesData[cmdId][field] = value;
    saveCommandeToFirebase(cmdId);
    renderCommandesBoard();
  }
}

function loadCommandesFromFirebase() {
  console.log('🔄 Chargement des commandes...');
  
  if (!firebaseDb) {
    console.log('⚠️ Firebase non disponible, création locale');
    if (Object.keys(commandesData).length === 0) {
      createDefaultCommandes();
    }
    renderCommandesBoard();
    return;
  }
  
  // Chargement initial avec once()
  firebaseDb.ref('commandes').once('value')
    .then((snapshot) => {
      const data = snapshot.val();
      console.log('📥 Données Firebase reçues:', data ? Object.keys(data).length : 0, 'commandes');
      
      if (data && Object.keys(data).length > 0) {
        commandesData = data;
      } else {
        console.log('📝 Aucune commande, création des cartes par défaut');
        createDefaultCommandes();
      }
      
      // Toujours rendre après chargement
      renderCommandesBoard();
      
      // Écouter les changements en temps réel
      setupCommandesRealtimeSync();
    })
    .catch((error) => {
      console.error('❌ Erreur chargement commandes:', error);
      // En cas d'erreur, créer localement
      if (Object.keys(commandesData).length === 0) {
        createDefaultCommandes();
      }
      renderCommandesBoard();
    });
}

function setupCommandesRealtimeSync() {
  if (!firebaseDb) return;
  
  firebaseDb.ref('commandes').on('value', (snap) => {
    const newData = snap.val();
    if (newData) {
      commandesData = newData;
      if (currentPage === 'commandes') {
        renderCommandesBoard();
      }
      console.log('🔄 Sync temps réel:', Object.keys(commandesData).length, 'commandes');
    }
  }, (error) => {
    console.error('❌ Erreur sync temps réel:', error);
  });
}

function createDefaultCommandes() {
  console.log('📝 Création de 5 cartes par défaut...');
  const timestamp = Date.now();
  
  // Créer une carte dans les 5 premières colonnes (pas BO)
  for (let idx = 0; idx < 5; idx++) {
    const cmdId = 'cmd_' + timestamp + '_' + idx;
    commandesData[cmdId] = {
      client: '',
      order: '000000',
      numeroPO: '',
      region: 'Québec',
      columnIndex: idx,
      dateCreated: new Date().toISOString(),
      items: [],
      notes: ''
    };
    
    // Sauvegarder immédiatement dans Firebase
    if (firebaseDb) {
      firebaseDb.ref('commandes/' + cmdId).set(commandesData[cmdId])
        .then(() => console.log(`✅ Carte ${idx} sauvegardée`))
        .catch(err => console.error(`❌ Erreur sauvegarde carte ${idx}:`, err));
    }
  }
  console.log('✅ 5 cartes par défaut créées');
}

// Sauvegarde avec retry et backup local
function saveCommandeToFirebase(cmdId, retryCount = 0) {
  if (!commandesData[cmdId]) return;
  
  // Vérifier si l'utilisateur est connecté
  if (!currentUser) {
    console.log('⚠️ Utilisateur non connecté, sauvegarde locale seulement');
    // Backup local dans localStorage
    try {
      const backupKey = 'physipro_cmd_backup_' + cmdId;
      localStorage.setItem(backupKey, JSON.stringify(commandesData[cmdId]));
    } catch (e) {
      console.warn('⚠️ Backup local impossible:', e);
    }
    return;
  }
  
  // Backup local dans localStorage
  try {
    const backupKey = 'physipro_cmd_backup_' + cmdId;
    localStorage.setItem(backupKey, JSON.stringify(commandesData[cmdId]));
  } catch (e) {
    console.warn('⚠️ Backup local impossible:', e);
  }
  
  if (!firebaseDb) {
    console.log('⚠️ Firebase non disponible, sauvegarde locale seulement');
    return;
  }
  
  firebaseDb.ref('commandes/' + cmdId).set(commandesData[cmdId])
    .then(() => {
      console.log(`✅ Commande ${cmdId} sauvegardée`);
      // Nettoyer le backup après succès
      try {
        localStorage.removeItem('physipro_cmd_backup_' + cmdId);
      } catch (e) {}
    })
    .catch((error) => {
      console.error(`❌ Erreur sauvegarde ${cmdId}:`, error);
      
      // Retry jusqu'à 3 fois seulement si pas permission_denied
      if (error.message && error.message.includes('PERMISSION_DENIED')) {
        console.log('⚠️ Permission refusée - vérifiez les règles Firebase');
        return;
      }
      
      if (retryCount < 3) {
        console.log(`🔄 Retry ${retryCount + 1}/3 dans 2 secondes...`);
        setTimeout(() => {
          saveCommandeToFirebase(cmdId, retryCount + 1);
        }, 2000);
      } else {
        console.error(`❌ Échec après 3 tentatives pour ${cmdId}`);
        // Garder le backup local pour récupération ultérieure
      }
    });
}

// Récupérer les backups locaux au démarrage
function recoverLocalBackups() {
  try {
    const keys = Object.keys(localStorage).filter(k => k.startsWith('physipro_cmd_backup_'));
    if (keys.length > 0) {
      console.log(`🔄 Récupération de ${keys.length} backups locaux...`);
      keys.forEach(key => {
        const cmdId = key.replace('physipro_cmd_backup_', '');
        const data = JSON.parse(localStorage.getItem(key));
        if (data && !commandesData[cmdId]) {
          commandesData[cmdId] = data;
          saveCommandeToFirebase(cmdId);
        }
      });
    }
  } catch (e) {
    console.warn('⚠️ Récupération backups impossible:', e);
  }
}

// ===== INITIALISATION =====
document.addEventListener('DOMContentLoaded', () => {
  console.log('🚀 PhysiPro Moulage v11.0 - Production');
  
  // Récupérer les backups locaux
  recoverLocalBackups();
  
  // Event listener pour bouton Ajouter commande
  const btnAddCommande = document.getElementById('btnAddCommande');
  if (btnAddCommande) {
    btnAddCommande.addEventListener('click', addNewCommande);
  }
  
  // Charger les commandes depuis Firebase après connexion
  if (firebaseAuth) {
    firebaseAuth.onAuthStateChanged((user) => {
      if (user) {
        loadCommandesFromFirebase();
      } else {
        // Même sans utilisateur, créer cartes par défaut localement
        if (Object.keys(commandesData).length === 0) {
          createDefaultCommandes();
        }
        renderCommandesBoard();
      }
    });
  } else {
    // Si pas de Firebase auth, créer cartes par défaut
    if (Object.keys(commandesData).length === 0) {
      createDefaultCommandes();
    }
    renderCommandesBoard();
  }
  
  // Fermer modals avec Escape (sauf login si pas connecté)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      logModal.classList.remove('active');
      addModal.classList.remove('active');
      if (currentExpandedCard) closeFiche();
      // Retour au Kanban si vue Robot active
      if (isRobotViewActive) toggleRobotView();
      // Fermer calendrier table
      closeTableCalendar();
      // Fermer popup notes
      closeNotesPopup();
      // Fermer popup recettes
      closeRecettesPopup();
    }
  });
});

// ========================================
// SYSTÈME DE RECETTES ET MATÉRIAUX
// ========================================

// Recettes personnalisées (sauvegardées dans Firebase)
let customRecettes = {};

// Charger les recettes personnalisées depuis Firebase
function loadCustomRecettes() {
  if (!firebaseInitialized) return;
  firebaseDb.ref('recettes').on('value', (snap) => {
    customRecettes = snap.val() || {};
    console.log('Recettes chargées:', customRecettes);
  });
}

// Sauvegarder une recette personnalisée
function saveCustomRecette(itemName, materiaux) {
  if (!firebaseInitialized) return;
  firebaseDb.ref('recettes/' + itemName.replace(/[.#$/[\]]/g, '_')).set(materiaux);
}

// Supprimer une recette personnalisée
function deleteCustomRecette(itemName) {
  if (!firebaseInitialized) return;
  firebaseDb.ref('recettes/' + itemName.replace(/[.#$/[\]]/g, '_')).remove();
}

// Obtenir la recette pour un item
function getRecetteForItem(itemName) {
  if (!itemName) return [];
  
  // D'abord vérifier les recettes personnalisées (exact match)
  const customKey = itemName.replace(/[.#$/[\]]/g, '_');
  if (customRecettes[customKey]) {
    return customRecettes[customKey];
  }
  
  // Vérifier les recettes par défaut (exact match)
  if (MENU_DATA.recettes[itemName]) {
    return MENU_DATA.recettes[itemName];
  }
  
  // Recherche partielle dans les recettes par défaut
  const itemNameLower = itemName.toLowerCase();
  for (const [key, value] of Object.entries(MENU_DATA.recettes)) {
    if (key.toLowerCase().includes(itemNameLower) || itemNameLower.includes(key.toLowerCase())) {
      return value;
    }
  }
  
  // Recherche partielle dans les recettes personnalisées
  for (const [key, value] of Object.entries(customRecettes)) {
    const keyClean = key.replace(/_/g, ' ').toLowerCase();
    if (keyClean.includes(itemNameLower) || itemNameLower.includes(keyClean)) {
      return value;
    }
  }
  
  return [];
}

// Mettre à jour la section Matériaux nécessaires
function updateMateriauxSection(cmdId) {
  const container = document.getElementById('cmdMateriauxContainer');
  const totalContainer = document.getElementById('cmdMateriauxTotal');
  if (!container) return;
  
  const cmd = commandesData[cmdId];
  if (!cmd || !cmd.items || cmd.items.length === 0) {
    container.innerHTML = '<div style="color:#9ca3af;font-size:8px;text-align:center;padding:10px;grid-column:1/-1;">Aucun item ajouté dans Atelier</div>';
    if (totalContainer) totalContainer.innerHTML = '';
    return;
  }
  
  // Collecter tous les matériaux pour le total
  const totalMateriaux = {};
  
  // Préparer les colonnes par paires (gauche/droite)
  const columns = [];
  
  // Pour chaque item dans la commande
  cmd.items.forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    
    // Calculer la quantité totale (somme de toutes les grandeurs)
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    // Créer les lignes pour cet item
    const lines = [];
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const matQty = parseFloat(mat.qty) || 1;
        const qtyNeeded = matQty * (totalQty || 1);
        const qtyDisplay = qtyNeeded % 1 === 0 ? qtyNeeded : qtyNeeded.toFixed(1);
        const epaisseur = mat.epaisseur || '';
        const code = mat.code || '';
        const matName = mat.materiau || 'Matériau';
        const fullName = epaisseur ? `${matName} ${epaisseur}` : matName;
        
        lines.push({ code, fullName, qtyDisplay });
        
        // Ajouter au total
        const key = code || fullName;
        if (!totalMateriaux[key]) {
          totalMateriaux[key] = { code, name: fullName, qty: 0 };
        }
        totalMateriaux[key].qty += qtyNeeded;
      });
    }
    
    columns.push({
      name: itemName,
      qty: totalQty,
      lines: lines,
      hasRecette: recette && recette.length > 0
    });
  });
  
  // Générer le HTML des colonnes (recettes seulement)
  let html = '';
  
  for (let i = 0; i < columns.length; i += 2) {
    const left = columns[i];
    const right = columns[i + 1];
    
    // Créer une rangée avec 2 colonnes
    html += '<div style="display:contents;">';
    
    // Colonne gauche
    html += `<div class="cmd-materiaux-column">
      <div class="cmd-materiaux-header">${left.name} (×${left.qty || 0})</div>
      <div class="cmd-materiaux-list">`;
    
    if (left.hasRecette) {
      left.lines.forEach(line => {
        html += `<div class="cmd-materiaux-item">
          <span class="cmd-materiaux-code">${line.code}</span>
          <span class="cmd-materiaux-name">${line.fullName}</span>
          <span class="cmd-materiaux-qty">${line.qtyDisplay}</span>
        </div>`;
      });
    } else {
      html += '<div style="color:#f59e0b;font-size:8px;font-style:italic;text-align:center;padding:4px;">⚠ Pas de recette</div>';
    }
    
    html += '</div></div>';
    
    // Colonne droite (si existe)
    if (right) {
      html += `<div class="cmd-materiaux-column">
        <div class="cmd-materiaux-header">${right.name} (×${right.qty || 0})</div>
        <div class="cmd-materiaux-list">`;
      
      if (right.hasRecette) {
        right.lines.forEach(line => {
          html += `<div class="cmd-materiaux-item">
            <span class="cmd-materiaux-code">${line.code}</span>
            <span class="cmd-materiaux-name">${line.fullName}</span>
            <span class="cmd-materiaux-qty">${line.qtyDisplay}</span>
          </div>`;
        });
      } else {
        html += '<div style="color:#f59e0b;font-size:8px;font-style:italic;text-align:center;padding:4px;">⚠ Pas de recette</div>';
      }
      
      html += '</div></div>';
    }
    
    html += '</div>';
  }
  
  container.innerHTML = html;
  
  // Générer le HTML du Total Matériaux (section séparée)
  if (totalContainer) {
    const totalKeys = Object.keys(totalMateriaux);
    if (totalKeys.length > 0) {
      let totalHtml = `
        <div class="cmd-materiaux-total">
          <div class="cmd-materiaux-total-header">📦 TOTAL MATÉRIAUX</div>
          <div class="cmd-materiaux-total-list">
      `;
      
      totalKeys.forEach(key => {
        const mat = totalMateriaux[key];
        const qtyDisplay = mat.qty % 1 === 0 ? mat.qty : mat.qty.toFixed(1);
        totalHtml += `
          <div class="cmd-materiaux-total-item">
            <span class="code">${mat.code || ''}</span>
            <span class="name">${mat.name}</span>
            <span class="qty">${qtyDisplay}</span>
          </div>
        `;
      });
      
      totalHtml += '</div></div>';
      totalContainer.innerHTML = totalHtml;
    } else {
      totalContainer.innerHTML = '';
    }
  }
}

// Ouvrir le popup de gestion des recettes
function openRecettesPopup() {
  // Créer le popup s'il n'existe pas
  let popup = document.getElementById('recettesPopup');
  if (!popup) {
    popup = document.createElement('div');
    popup.className = 'recettes-popup';
    popup.id = 'recettesPopup';
    document.body.appendChild(popup);
  }
  
  // Construire le contenu
  let recettesHtml = '';
  
  // Recettes par défaut + personnalisées
  const allRecettes = { ...MENU_DATA.recettes, ...customRecettes };
  
  Object.entries(allRecettes).forEach(([itemName, materiaux]) => {
    const isCustom = customRecettes[itemName] !== undefined;
    recettesHtml += buildRecetteCardEditable(itemName, materiaux, isCustom);
  });
  
  popup.innerHTML = `
    <div class="recettes-popup-header">
      <h3>⚙ Gestion des Recettes</h3>
    </div>
    <div class="recettes-popup-body">
      ${recettesHtml}
      
      <div class="add-recette-form">
        <h4>+ Ajouter une nouvelle recette</h4>
        <input type="text" id="newRecetteItem" placeholder="Nom de l'item (ex: Coussin Spécial)">
        <div style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:8px;">
          <span style="font-size:10px;font-weight:600;">Code</span>
          <span style="font-size:10px;font-weight:600;">Matériaux</span>
          <span style="font-size:10px;font-weight:600;">Épaisseur</span>
          <span style="font-size:10px;font-weight:600;">Qté</span>
          <span></span>
        </div>
        <div id="newRecetteMateriaux">
          <div class="new-materiau-row" style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:4px;">
            <input type="text" placeholder="VIS-22" style="padding:4px;font-size:10px;">
            <input type="text" placeholder="Feuille Viscose 22x24" style="padding:4px;font-size:10px;">
            <input type="text" placeholder="1 pouce" style="padding:4px;font-size:10px;">
            <input type="number" placeholder="1" value="1" min="0" step="0.5" style="padding:4px;font-size:10px;">
            <button onclick="this.parentElement.remove()" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;">✕</button>
          </div>
        </div>
        <button onclick="addNewMateriauRow()" style="font-size:10px;padding:4px 8px;margin-bottom:8px;background:#3b82f6;color:white;border:none;border-radius:3px;cursor:pointer;">+ Ajouter matériau</button>
        <br>
        <button onclick="saveNewRecette()" style="padding:6px 12px;font-size:11px;background:#22c55e;color:white;border:none;border-radius:4px;cursor:pointer;">Sauvegarder la recette</button>
      </div>
    </div>
    <div class="recettes-popup-footer">
      <button class="recettes-btn-save" onclick="closeRecettesPopup()">Enregistrer</button>
      <button class="recettes-btn-close" onclick="closeRecettesPopup()">Fermer</button>
    </div>
  `;
  
  popup.classList.add('show');
}

function buildRecetteCardEditable(itemName, materiaux, isCustom) {
  let materiauxRows = '';
  
  materiaux.forEach((mat, idx) => {
    materiauxRows += `
      <div class="recette-materiau-row" style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:2px;align-items:center;">
        <input type="text" value="${mat.code || ''}" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'code', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <input type="text" value="${mat.materiau}" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'materiau', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <input type="text" value="${mat.epaisseur || ''}" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'epaisseur', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <input type="number" value="${mat.qty}" min="0" step="0.5" onchange="updateRecetteMateriau('${itemName}', ${idx}, 'qty', this.value)" style="padding:3px;font-size:10px;border:1px solid #d1d5db;border-radius:3px;">
        <button onclick="removeRecetteMateriau('${itemName}', ${idx})" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;font-size:10px;">✕</button>
      </div>
    `;
  });
  
  return `
    <div class="recette-card">
      <div class="recette-card-header">
        <div class="recette-card-title">
          <input type="text" value="${itemName}" 
                 onchange="renameRecette('${itemName}', this.value)" 
                 style="font-size:12px;font-weight:700;border:1px solid #e2e8f0;border-radius:4px;padding:4px 8px;width:150px;background:#f8fafc;"
                 title="Cliquer pour modifier le nom">
          ${isCustom ? '<span style="color:#8b5cf6;font-size:10px;margin-left:5px;">(personnalisée)</span>' : ''}
        </div>
        <div class="recette-card-actions">
          <button class="recette-edit-btn" onclick="addMateriauToRecette('${itemName}')" style="background:#22c55e;">+ Mat.</button>
          ${isCustom ? `<button class="recette-delete-btn" onclick="deleteRecette('${itemName}')">Suppr.</button>` : ''}
        </div>
      </div>
      <div style="display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:4px;padding:4px 0;border-bottom:1px solid #e5e7eb;">
        <span style="font-size:9px;font-weight:600;">Code</span>
        <span style="font-size:9px;font-weight:600;">Matériaux</span>
        <span style="font-size:9px;font-weight:600;">Épaisseur</span>
        <span style="font-size:9px;font-weight:600;">Qté</span>
        <span></span>
      </div>
      <div class="recette-materiaux-list">
        ${materiauxRows}
      </div>
    </div>
  `;
}

function addNewMateriauRow() {
  const container = document.getElementById('newRecetteMateriaux');
  const row = document.createElement('div');
  row.className = 'new-materiau-row';
  row.style.cssText = 'display:grid;grid-template-columns:50px 1fr 70px 50px 30px;gap:4px;margin-bottom:4px;';
  row.innerHTML = `
    <input type="text" placeholder="Code" style="padding:4px;font-size:10px;">
    <input type="text" placeholder="Matériau" style="padding:4px;font-size:10px;">
    <input type="text" placeholder="Épaisseur" style="padding:4px;font-size:10px;">
    <input type="number" placeholder="1" value="1" min="0" step="0.5" style="padding:4px;font-size:10px;">
    <button onclick="this.parentElement.remove()" style="background:#ef4444;color:white;border:none;border-radius:3px;cursor:pointer;">✕</button>
  `;
  container.appendChild(row);
}

function saveNewRecette() {
  const itemName = document.getElementById('newRecetteItem').value.trim();
  if (!itemName) {
    alert('Veuillez entrer un nom d\'item');
    return;
  }
  
  const rows = document.querySelectorAll('#newRecetteMateriaux .new-materiau-row');
  const materiaux = [];
  
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs[1].value.trim()) {
      materiaux.push({
        code: inputs[0].value.trim(),
        materiau: inputs[1].value.trim(),
        epaisseur: inputs[2].value.trim(),
        qty: parseFloat(inputs[3].value) || 1
      });
    }
  });
  
  if (materiaux.length === 0) {
    alert('Veuillez ajouter au moins un matériau');
    return;
  }
  
  saveCustomRecette(itemName, materiaux);
  setTimeout(() => openRecettesPopup(), 500);
}

function updateRecetteMateriau(itemName, idx, field, value) {
  // Récupérer la recette actuelle
  let recette = customRecettes[itemName] || MENU_DATA.recettes[itemName];
  if (!recette) return;
  
  // Copier pour modifier
  recette = JSON.parse(JSON.stringify(recette));
  
  if (field === 'qty') {
    recette[idx].qty = parseFloat(value) || 0;
  } else {
    recette[idx][field] = value;
  }
  
  // Sauvegarder comme recette personnalisée
  saveCustomRecette(itemName, recette);
}

function removeRecetteMateriau(itemName, idx) {
  let recette = customRecettes[itemName] || MENU_DATA.recettes[itemName];
  if (!recette) return;
  
  recette = JSON.parse(JSON.stringify(recette));
  recette.splice(idx, 1);
  
  if (recette.length === 0) {
    deleteCustomRecette(itemName);
  } else {
    saveCustomRecette(itemName, recette);
  }
  
  setTimeout(() => openRecettesPopup(), 300);
}

function addMateriauToRecette(itemName) {
  let recette = customRecettes[itemName] || MENU_DATA.recettes[itemName];
  if (!recette) recette = [];
  
  recette = JSON.parse(JSON.stringify(recette));
  recette.push({ code: '', materiau: 'Nouveau matériau', epaisseur: '', qty: 1 });
  
  saveCustomRecette(itemName, recette);
  setTimeout(() => openRecettesPopup(), 300);
}

// Renommer une recette
function renameRecette(oldName, newName) {
  newName = newName.trim();
  if (!newName || newName === oldName) return;
  
  // Vérifier si le nouveau nom existe déjà
  if (MENU_DATA.recettes[newName] || customRecettes[newName]) {
    alert('Une recette avec ce nom existe déjà!');
    setTimeout(() => openRecettesPopup(), 100);
    return;
  }
  
  // Récupérer la recette actuelle
  let recette = customRecettes[oldName] || MENU_DATA.recettes[oldName];
  if (!recette) return;
  
  recette = JSON.parse(JSON.stringify(recette));
  
  // Supprimer l'ancienne
  if (customRecettes[oldName]) {
    delete customRecettes[oldName];
  }
  
  // Sauvegarder avec le nouveau nom
  customRecettes[newName] = recette;
  saveRecettesToFirebase();
  
  // Mettre à jour aussi MENU_DATA si c'était une recette par défaut
  if (MENU_DATA.recettes[oldName] && !customRecettes[oldName]) {
    // On ne peut pas supprimer de MENU_DATA, mais on peut l'override
    customRecettes[newName] = recette;
  }
  
  setTimeout(() => openRecettesPopup(), 300);
}

function closeRecettesPopup() {
  const popup = document.getElementById('recettesPopup');
  if (popup) popup.classList.remove('show');
  
  // Mettre à jour les matériaux si une fiche est ouverte
  if (currentCmdId) {
    updateMateriauxSection(currentCmdId);
  }
}

// Fonction d'impression des matériaux
function printMateriaux(cmdId) {
  const cmd = commandesData[cmdId];
  if (!cmd) return;
  
  // Construire le HTML d'impression
  let printHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Matériaux - ${cmd.order || 'Commande'}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 15px; font-size: 11px; }
        .header { border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 12px; }
        .header h1 { font-size: 16px; margin: 0 0 5px 0; }
        .info-row { display: flex; gap: 20px; font-size: 10px; margin-bottom: 3px; }
        .info-item { display: flex; gap: 5px; }
        .info-label { font-weight: bold; }
        .materiaux-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .item-card { border: 1px solid #333; border-radius: 4px; padding: 8px; }
        .item-header { background: #333; color: white; padding: 5px 8px; margin: -8px -8px 8px -8px; border-radius: 3px 3px 0 0; font-weight: bold; font-size: 12px; }
        .mat-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .mat-table th { text-align: left; border-bottom: 1px solid #333; padding: 3px 5px; font-size: 9px; }
        .mat-table td { padding: 3px 5px; border-bottom: 1px dotted #ccc; }
        .mat-table .qty { text-align: right; font-weight: bold; font-size: 12px; }
        @media print { body { padding: 10px; } }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>PHYSIPRO - Liste Matériaux</h1>
        <div class="info-row">
          <div class="info-item"><span class="info-label">Client:</span> ${cmd.client || '-'}</div>
          <div class="info-item"><span class="info-label">N° Commande:</span> ${cmd.order || '-'}</div>
          <div class="info-item"><span class="info-label">N° PO:</span> ${cmd.numeroPO || '-'}</div>
        </div>
        <div class="info-row">
          <div class="info-item"><span class="info-label">Date reçue:</span> ${cmd.dateRecue || '-'}</div>
          <div class="info-item"><span class="info-label">Date livraison:</span> ${cmd.dateLivraison || '-'}</div>
        </div>
      </div>
      
      <div class="materiaux-grid">
  `;
  
  // Pour chaque item
  (cmd.items || []).forEach(item => {
    const itemName = item.name || 'Item';
    const recette = getRecetteForItem(itemName);
    const totalQty = (item.grandeurs || []).reduce((sum, g) => sum + (parseInt(g.qty) || 0), 0);
    
    printHtml += `
      <div class="item-card">
        <div class="item-header">${itemName} (×${totalQty || 0})</div>
        <table class="mat-table">
          <tr><th>Code</th><th>Matériaux</th><th>Épaisseur</th><th style="text-align:right;">Qté</th></tr>
    `;
    
    if (recette && recette.length > 0) {
      recette.forEach(mat => {
        const matQty = parseFloat(mat.qty) || 1;
        const qtyNeeded = matQty * (totalQty || 1);
        const qtyDisplay = qtyNeeded % 1 === 0 ? qtyNeeded : qtyNeeded.toFixed(1);
        printHtml += `
          <tr>
            <td>${mat.code || '-'}</td>
            <td>${mat.materiau || '-'}</td>
            <td>${mat.epaisseur || '-'}</td>
            <td class="qty">${qtyDisplay}</td>
          </tr>
        `;
      });
    } else {
      printHtml += `<tr><td colspan="4" style="text-align:center;color:#999;">Pas de recette définie</td></tr>`;
    }
    
    printHtml += `</table></div>`;
  });
  
  printHtml += `
      </div>
      <div style="margin-top: 20px; font-size: 9px; color: #666; border-top: 1px solid #ccc; padding-top: 8px;">
        Imprimé le ${new Date().toLocaleDateString('fr-CA')} à ${new Date().toLocaleTimeString('fr-CA')}
      </div>
    </body>
    </html>
  `;
  
  // Ouvrir fenêtre d'impression
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printHtml);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 250);
}

function deleteRecette(itemName) {
  if (confirm(`Supprimer la recette pour "${itemName}" ?`)) {
    deleteCustomRecette(itemName);
    setTimeout(() => openRecettesPopup(), 500);
  }
}

// Popup Notes pour la fiche commande
let currentNotesCommandeId = null;

function openCmdNotesPopup(cmdId) {
  currentNotesCommandeId = cmdId;
  const cmd = commandesData[cmdId];
  
  // Fermer l'ancien popup
  closeCmdNotesPopup();
  
  const userName = getCurrentUserName();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-CA');
  const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
  
  let popup = document.getElementById('cmdNotesPopup');
  if (!popup) {
    popup = document.createElement('div');
    popup.className = 'cmd-notes-popup-overlay';
    popup.id = 'cmdNotesPopup';
    popup.onclick = function(e) { if (e.target === this) closeCmdNotesPopup(); };
    document.body.appendChild(popup);
  }
  
  popup.innerHTML = `
    <div class="cmd-notes-popup-content">
      <div class="cmd-notes-popup-header">
        <h3>📝 Notes - ${cmd.client || 'Commande'}</h3>
        <button onclick="closeCmdNotesPopup()">Fermer</button>
      </div>
      <div class="cmd-notes-popup-body">
        <div class="cmd-existing-notes">${cmd.notes || '<span style="color:#9ca3af;font-style:italic;">Aucune note</span>'}</div>
        <div class="cmd-new-note-section">
          <div class="cmd-note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div>
          <textarea id="cmdNotesPopupText" placeholder="Ajouter une nouvelle note..."></textarea>
        </div>
      </div>
      <div class="cmd-notes-popup-footer">
        <button class="btn-save" onclick="saveCmdNotesPopup()">💾 Sauvegarder</button>
        <button class="btn-close" onclick="closeCmdNotesPopup()">Fermer</button>
      </div>
    </div>
  `;
  
  popup.style.display = 'flex';
  
  // Focus sur le textarea
  setTimeout(() => {
    document.getElementById('cmdNotesPopupText')?.focus();
  }, 100);
}

function closeCmdNotesPopup() {
  const popup = document.getElementById('cmdNotesPopup');
  if (popup) popup.style.display = 'none';
  currentNotesCommandeId = null;
}

function saveCmdNotesPopup() {
  if (!currentNotesCommandeId) return;
  
  const textarea = document.getElementById('cmdNotesPopupText');
  const newNoteText = textarea?.value?.trim();
  
  if (newNoteText) {
    const userName = getCurrentUserName();
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-CA');
    const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
    
    const newNote = `<div class="note-entry"><div class="note-signature">— ${userName} (${dateStr} à ${timeStr}) —</div><div class="note-text">${newNoteText}</div></div>`;
    
    const existingNotes = commandesData[currentNotesCommandeId].notes || '';
    commandesData[currentNotesCommandeId].notes = existingNotes + newNote;
    saveCommandeToFirebase(currentNotesCommandeId);
    
    // Mettre à jour l'aperçu
    const preview = document.getElementById('cmdNotesPreview');
    if (preview) {
      const notes = textarea.value;
      preview.textContent = notes ? notes.substring(0, 50) + (notes.length > 50 ? '...' : '') : 'Cliquez pour ajouter des notes...';
    }
  }
  
  closeCmdNotesPopup();
}

// Charger les recettes au démarrage
setTimeout(loadCustomRecettes, 2000);
</script>
</body>
</html>
